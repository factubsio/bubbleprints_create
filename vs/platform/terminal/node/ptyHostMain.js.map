{"version":3,"sources":["node_modules/minimist/index.js","./file:/home/worcem/vscode/src/vs/base/common/lazy.ts","./file:/home/worcem/vscode/src/vs/base/common/errors.ts","./file:/home/worcem/vscode/src/vs/base/common/arraysFind.ts","./file:/home/worcem/vscode/src/vs/base/common/arrays.ts","./file:/home/worcem/vscode/src/vs/base/common/collections.ts","./file:/home/worcem/vscode/src/vs/base/common/map.ts","./file:/home/worcem/vscode/src/vs/base/common/functional.ts","./file:/home/worcem/vscode/src/vs/base/common/assert.ts","./file:/home/worcem/vscode/src/vs/base/common/types.ts","./file:/home/worcem/vscode/src/vs/base/common/iterator.ts","./file:/home/worcem/vscode/src/vs/base/common/lifecycle.ts","./file:/home/worcem/vscode/src/vs/base/common/buffer.ts","./file:/home/worcem/vscode/src/vs/nls.ts","./file:/home/worcem/vscode/src/vs/base/common/platform.ts","./file:/home/worcem/vscode/src/vs/base/common/process.ts","./file:/home/worcem/vscode/src/vs/base/common/path.ts","./file:/home/worcem/vscode/src/vs/base/common/uri.ts","./file:/home/worcem/vscode/src/vs/base/common/uriIpc.ts","./file:/home/worcem/vscode/src/vs/base/common/linkedList.ts","./file:/home/worcem/vscode/src/vs/base/common/stopwatch.ts","./file:/home/worcem/vscode/src/vs/base/common/event.ts","./file:/home/worcem/vscode/src/vs/base/common/cancellation.ts","./file:/home/worcem/vscode/src/vs/base/common/cache.ts","./file:/home/worcem/vscode/src/vs/base/common/strings.ts","./file:/home/worcem/vscode/src/vs/base/common/extpath.ts","./file:/home/worcem/vscode/src/vs/base/common/network.ts","./file:/home/worcem/vscode/src/vs/base/common/resources.ts","./file:/home/worcem/vscode/src/vs/base/common/symbols.ts","./file:/home/worcem/vscode/src/vs/base/common/async.ts","./file:/home/worcem/vscode/src/vs/base/common/decorators.ts","./file:/home/worcem/vscode/src/vs/base/common/marshalling.ts","./file:/home/worcem/vscode/src/vs/base/parts/ipc/common/ipc.ts","./file:/home/worcem/vscode/src/vs/base/parts/ipc/node/ipc.cp.ts","./file:/home/worcem/vscode/src/vs/base/common/objects.ts","./file:/home/worcem/vscode/src/vs/base/node/processes.ts","./file:/home/worcem/vscode/src/vs/base/common/processes.ts","./file:/home/worcem/vscode/src/vs/base/node/pfs.ts","./file:/home/worcem/vscode/src/vs/base/common/normalization.ts","./file:/home/worcem/vscode/src/vs/base/parts/sandbox/node/electronTypes.ts","./file:/home/worcem/vscode/src/vs/base/parts/ipc/node/ipc.mp.ts","vs/platform/environment/node/argv.ts","./file:/home/worcem/vscode/src/vs/platform/environment/node/environmentService.ts","vs/base/common/date.ts","./file:/home/worcem/vscode/src/vs/platform/environment/common/environmentService.ts","./file:/home/worcem/vscode/src/vs/platform/environment/node/userDataPath.ts","vs/base/common/errorMessage.ts","./file:/home/worcem/vscode/src/vs/base/common/hash.ts","vs/platform/contextkey/common/scanner.ts","./file:/home/worcem/vscode/src/vs/platform/instantiation/common/instantiation.ts","vs/platform/contextkey/common/contextkey.ts","vs/platform/log/common/log.ts","./file:/home/worcem/vscode/src/vs/platform/log/common/logIpc.ts","./file:/home/worcem/vscode/src/vs/platform/log/common/logService.ts","./file:/home/worcem/vscode/src/vs/base/common/uuid.ts","./file:/home/worcem/vscode/src/vs/base/common/ternarySearchTree.ts","vs/platform/files/common/files.ts","./file:/home/worcem/vscode/src/vs/platform/log/node/spdlogLog.ts","./file:/home/worcem/vscode/src/vs/platform/log/node/loggerService.ts","./file:/home/worcem/vscode/src/vs/platform/product/common/product.ts","./file:/home/worcem/vscode/src/vs/platform/registry/common/platform.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/terminal.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/heartbeatService.ts","vs/platform/terminal/node/ptyService.ts","./file:/home/worcem/vscode/src/vs/base/node/shell.ts","./file:/home/worcem/vscode/src/vs/base/node/powershell.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/requestStore.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/terminalDataBuffering.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/terminalEnvironment.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/terminalEnvironment.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/environmentVariable.ts","vs/platform/terminal/common/environmentVariable.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/environmentVariableShared.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/environmentVariableCollection.ts","vs/platform/terminal/node/terminalProcess.ts","./file:/home/worcem/vscode/src/vs/platform/product/common/productService.ts","./file:/home/worcem/vscode/src/vs/base/node/ps.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/childProcessMonitor.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/windowsShellHelper.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/terminalCapabilityStore.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/commandDetection/terminalCommand.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/commandDetection/promptInputModel.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/commandDetectionCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/cwdDetectionCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/partialCommandDetectionCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/bufferMarkCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/shellEnvDetectionCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/capabilities/promptTypeDetectionCapability.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/xterm/shellIntegrationAddon.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/common/terminalStrings.ts","./file:/home/worcem/vscode/src/vs/base/common/performance.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/terminalContrib/autoReplies/terminalAutoResponder.ts","./file:/home/worcem/vscode/src/vs/platform/terminal/node/terminalContrib/autoReplies/autoRepliesContribController.ts","vs/platform/terminal/node/ptyHostMain.ts"],"sourcesContent":["'use strict';\n\nfunction hasKey(obj, keys) {\n\tvar o = obj;\n\tkeys.slice(0, -1).forEach(function (key) {\n\t\to = o[key] || {};\n\t});\n\n\tvar key = keys[keys.length - 1];\n\treturn key in o;\n}\n\nfunction isNumber(x) {\n\tif (typeof x === 'number') { return true; }\n\tif ((/^0x[0-9a-f]+$/i).test(x)) { return true; }\n\treturn (/^[-+]?(?:\\d+(?:\\.\\d*)?|\\.\\d+)(e[-+]?\\d+)?$/).test(x);\n}\n\nfunction isConstructorOrProto(obj, key) {\n\treturn (key === 'constructor' && typeof obj[key] === 'function') || key === '__proto__';\n}\n\nmodule.exports = function (args, opts) {\n\tif (!opts) { opts = {}; }\n\n\tvar flags = {\n\t\tbools: {},\n\t\tstrings: {},\n\t\tunknownFn: null,\n\t};\n\n\tif (typeof opts.unknown === 'function') {\n\t\tflags.unknownFn = opts.unknown;\n\t}\n\n\tif (typeof opts.boolean === 'boolean' && opts.boolean) {\n\t\tflags.allBools = true;\n\t} else {\n\t\t[].concat(opts.boolean).filter(Boolean).forEach(function (key) {\n\t\t\tflags.bools[key] = true;\n\t\t});\n\t}\n\n\tvar aliases = {};\n\n\tfunction aliasIsBoolean(key) {\n\t\treturn aliases[key].some(function (x) {\n\t\t\treturn flags.bools[x];\n\t\t});\n\t}\n\n\tObject.keys(opts.alias || {}).forEach(function (key) {\n\t\taliases[key] = [].concat(opts.alias[key]);\n\t\taliases[key].forEach(function (x) {\n\t\t\taliases[x] = [key].concat(aliases[key].filter(function (y) {\n\t\t\t\treturn x !== y;\n\t\t\t}));\n\t\t});\n\t});\n\n\t[].concat(opts.string).filter(Boolean).forEach(function (key) {\n\t\tflags.strings[key] = true;\n\t\tif (aliases[key]) {\n\t\t\t[].concat(aliases[key]).forEach(function (k) {\n\t\t\t\tflags.strings[k] = true;\n\t\t\t});\n\t\t}\n\t});\n\n\tvar defaults = opts.default || {};\n\n\tvar argv = { _: [] };\n\n\tfunction argDefined(key, arg) {\n\t\treturn (flags.allBools && (/^--[^=]+$/).test(arg))\n\t\t\t|| flags.strings[key]\n\t\t\t|| flags.bools[key]\n\t\t\t|| aliases[key];\n\t}\n\n\tfunction setKey(obj, keys, value) {\n\t\tvar o = obj;\n\t\tfor (var i = 0; i < keys.length - 1; i++) {\n\t\t\tvar key = keys[i];\n\t\t\tif (isConstructorOrProto(o, key)) { return; }\n\t\t\tif (o[key] === undefined) { o[key] = {}; }\n\t\t\tif (\n\t\t\t\to[key] === Object.prototype\n\t\t\t\t|| o[key] === Number.prototype\n\t\t\t\t|| o[key] === String.prototype\n\t\t\t) {\n\t\t\t\to[key] = {};\n\t\t\t}\n\t\t\tif (o[key] === Array.prototype) { o[key] = []; }\n\t\t\to = o[key];\n\t\t}\n\n\t\tvar lastKey = keys[keys.length - 1];\n\t\tif (isConstructorOrProto(o, lastKey)) { return; }\n\t\tif (\n\t\t\to === Object.prototype\n\t\t\t|| o === Number.prototype\n\t\t\t|| o === String.prototype\n\t\t) {\n\t\t\to = {};\n\t\t}\n\t\tif (o === Array.prototype) { o = []; }\n\t\tif (o[lastKey] === undefined || flags.bools[lastKey] || typeof o[lastKey] === 'boolean') {\n\t\t\to[lastKey] = value;\n\t\t} else if (Array.isArray(o[lastKey])) {\n\t\t\to[lastKey].push(value);\n\t\t} else {\n\t\t\to[lastKey] = [o[lastKey], value];\n\t\t}\n\t}\n\n\tfunction setArg(key, val, arg) {\n\t\tif (arg && flags.unknownFn && !argDefined(key, arg)) {\n\t\t\tif (flags.unknownFn(arg) === false) { return; }\n\t\t}\n\n\t\tvar value = !flags.strings[key] && isNumber(val)\n\t\t\t? Number(val)\n\t\t\t: val;\n\t\tsetKey(argv, key.split('.'), value);\n\n\t\t(aliases[key] || []).forEach(function (x) {\n\t\t\tsetKey(argv, x.split('.'), value);\n\t\t});\n\t}\n\n\tObject.keys(flags.bools).forEach(function (key) {\n\t\tsetArg(key, defaults[key] === undefined ? false : defaults[key]);\n\t});\n\n\tvar notFlags = [];\n\n\tif (args.indexOf('--') !== -1) {\n\t\tnotFlags = args.slice(args.indexOf('--') + 1);\n\t\targs = args.slice(0, args.indexOf('--'));\n\t}\n\n\tfor (var i = 0; i < args.length; i++) {\n\t\tvar arg = args[i];\n\t\tvar key;\n\t\tvar next;\n\n\t\tif ((/^--.+=/).test(arg)) {\n\t\t\t// Using [\\s\\S] instead of . because js doesn't support the\n\t\t\t// 'dotall' regex modifier. See:\n\t\t\t// http://stackoverflow.com/a/1068308/13216\n\t\t\tvar m = arg.match(/^--([^=]+)=([\\s\\S]*)$/);\n\t\t\tkey = m[1];\n\t\t\tvar value = m[2];\n\t\t\tif (flags.bools[key]) {\n\t\t\t\tvalue = value !== 'false';\n\t\t\t}\n\t\t\tsetArg(key, value, arg);\n\t\t} else if ((/^--no-.+/).test(arg)) {\n\t\t\tkey = arg.match(/^--no-(.+)/)[1];\n\t\t\tsetArg(key, false, arg);\n\t\t} else if ((/^--.+/).test(arg)) {\n\t\t\tkey = arg.match(/^--(.+)/)[1];\n\t\t\tnext = args[i + 1];\n\t\t\tif (\n\t\t\t\tnext !== undefined\n\t\t\t\t&& !(/^(-|--)[^-]/).test(next)\n\t\t\t\t&& !flags.bools[key]\n\t\t\t\t&& !flags.allBools\n\t\t\t\t&& (aliases[key] ? !aliasIsBoolean(key) : true)\n\t\t\t) {\n\t\t\t\tsetArg(key, next, arg);\n\t\t\t\ti += 1;\n\t\t\t} else if ((/^(true|false)$/).test(next)) {\n\t\t\t\tsetArg(key, next === 'true', arg);\n\t\t\t\ti += 1;\n\t\t\t} else {\n\t\t\t\tsetArg(key, flags.strings[key] ? '' : true, arg);\n\t\t\t}\n\t\t} else if ((/^-[^-]+/).test(arg)) {\n\t\t\tvar letters = arg.slice(1, -1).split('');\n\n\t\t\tvar broken = false;\n\t\t\tfor (var j = 0; j < letters.length; j++) {\n\t\t\t\tnext = arg.slice(j + 2);\n\n\t\t\t\tif (next === '-') {\n\t\t\t\t\tsetArg(letters[j], next, arg);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif ((/[A-Za-z]/).test(letters[j]) && next[0] === '=') {\n\t\t\t\t\tsetArg(letters[j], next.slice(1), arg);\n\t\t\t\t\tbroken = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (\n\t\t\t\t\t(/[A-Za-z]/).test(letters[j])\n\t\t\t\t\t&& (/-?\\d+(\\.\\d*)?(e-?\\d+)?$/).test(next)\n\t\t\t\t) {\n\t\t\t\t\tsetArg(letters[j], next, arg);\n\t\t\t\t\tbroken = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tif (letters[j + 1] && letters[j + 1].match(/\\W/)) {\n\t\t\t\t\tsetArg(letters[j], arg.slice(j + 2), arg);\n\t\t\t\t\tbroken = true;\n\t\t\t\t\tbreak;\n\t\t\t\t} else {\n\t\t\t\t\tsetArg(letters[j], flags.strings[letters[j]] ? '' : true, arg);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tkey = arg.slice(-1)[0];\n\t\t\tif (!broken && key !== '-') {\n\t\t\t\tif (\n\t\t\t\t\targs[i + 1]\n\t\t\t\t\t&& !(/^(-|--)[^-]/).test(args[i + 1])\n\t\t\t\t\t&& !flags.bools[key]\n\t\t\t\t\t&& (aliases[key] ? !aliasIsBoolean(key) : true)\n\t\t\t\t) {\n\t\t\t\t\tsetArg(key, args[i + 1], arg);\n\t\t\t\t\ti += 1;\n\t\t\t\t} else if (args[i + 1] && (/^(true|false)$/).test(args[i + 1])) {\n\t\t\t\t\tsetArg(key, args[i + 1] === 'true', arg);\n\t\t\t\t\ti += 1;\n\t\t\t\t} else {\n\t\t\t\t\tsetArg(key, flags.strings[key] ? '' : true, arg);\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tif (!flags.unknownFn || flags.unknownFn(arg) !== false) {\n\t\t\t\targv._.push(flags.strings._ || !isNumber(arg) ? arg : Number(arg));\n\t\t\t}\n\t\t\tif (opts.stopEarly) {\n\t\t\t\targv._.push.apply(argv._, args.slice(i + 1));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tObject.keys(defaults).forEach(function (k) {\n\t\tif (!hasKey(argv, k.split('.'))) {\n\t\t\tsetKey(argv, k.split('.'), defaults[k]);\n\n\t\t\t(aliases[k] || []).forEach(function (x) {\n\t\t\t\tsetKey(argv, x.split('.'), defaults[k]);\n\t\t\t});\n\t\t}\n\t});\n\n\tif (opts['--']) {\n\t\targv['--'] = notFlags.slice();\n\t} else {\n\t\tnotFlags.forEach(function (k) {\n\t\t\targv._.push(k);\n\t\t});\n\t}\n\n\treturn argv;\n};\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nenum LazyValueState {\n\tUninitialized,\n\tRunning,\n\tCompleted,\n}\n\nexport class Lazy<T> {\n\n\tprivate _state = LazyValueState.Uninitialized;\n\tprivate _value?: T;\n\tprivate _error: Error | undefined;\n\n\tconstructor(\n\t\tprivate readonly executor: () => T,\n\t) { }\n\n\t/**\n\t * True if the lazy value has been resolved.\n\t */\n\tget hasValue(): boolean { return this._state === LazyValueState.Completed; }\n\n\t/**\n\t * Get the wrapped value.\n\t *\n\t * This will force evaluation of the lazy value if it has not been resolved yet. Lazy values are only\n\t * resolved once. `getValue` will re-throw exceptions that are hit while resolving the value\n\t */\n\tget value(): T {\n\t\tif (this._state === LazyValueState.Uninitialized) {\n\t\t\tthis._state = LazyValueState.Running;\n\t\t\ttry {\n\t\t\t\tthis._value = this.executor();\n\t\t\t} catch (err) {\n\t\t\t\tthis._error = err;\n\t\t\t} finally {\n\t\t\t\tthis._state = LazyValueState.Completed;\n\t\t\t}\n\t\t} else if (this._state === LazyValueState.Running) {\n\t\t\tthrow new Error('Cannot read the value of a lazy that is being initialized');\n\t\t}\n\n\t\tif (this._error) {\n\t\t\tthrow this._error;\n\t\t}\n\t\treturn this._value!;\n\t}\n\n\t/**\n\t * Get the wrapped value without forcing evaluation.\n\t */\n\tget rawValue(): T | undefined { return this._value; }\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport interface ErrorListenerCallback {\n\t(error: any): void;\n}\n\nexport interface ErrorListenerUnbind {\n\t(): void;\n}\n\n// Avoid circular dependency on EventEmitter by implementing a subset of the interface.\nexport class ErrorHandler {\n\tprivate unexpectedErrorHandler: (e: any) => void;\n\tprivate listeners: ErrorListenerCallback[];\n\n\tconstructor() {\n\n\t\tthis.listeners = [];\n\n\t\tthis.unexpectedErrorHandler = function (e: any) {\n\t\t\tsetTimeout(() => {\n\t\t\t\tif (e.stack) {\n\t\t\t\t\tif (ErrorNoTelemetry.isErrorNoTelemetry(e)) {\n\t\t\t\t\t\tthrow new ErrorNoTelemetry(e.message + '\\n\\n' + e.stack);\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow new Error(e.message + '\\n\\n' + e.stack);\n\t\t\t\t}\n\n\t\t\t\tthrow e;\n\t\t\t}, 0);\n\t\t};\n\t}\n\n\taddListener(listener: ErrorListenerCallback): ErrorListenerUnbind {\n\t\tthis.listeners.push(listener);\n\n\t\treturn () => {\n\t\t\tthis._removeListener(listener);\n\t\t};\n\t}\n\n\tprivate emit(e: any): void {\n\t\tthis.listeners.forEach((listener) => {\n\t\t\tlistener(e);\n\t\t});\n\t}\n\n\tprivate _removeListener(listener: ErrorListenerCallback): void {\n\t\tthis.listeners.splice(this.listeners.indexOf(listener), 1);\n\t}\n\n\tsetUnexpectedErrorHandler(newUnexpectedErrorHandler: (e: any) => void): void {\n\t\tthis.unexpectedErrorHandler = newUnexpectedErrorHandler;\n\t}\n\n\tgetUnexpectedErrorHandler(): (e: any) => void {\n\t\treturn this.unexpectedErrorHandler;\n\t}\n\n\tonUnexpectedError(e: any): void {\n\t\tthis.unexpectedErrorHandler(e);\n\t\tthis.emit(e);\n\t}\n\n\t// For external errors, we don't want the listeners to be called\n\tonUnexpectedExternalError(e: any): void {\n\t\tthis.unexpectedErrorHandler(e);\n\t}\n}\n\nexport const errorHandler = new ErrorHandler();\n\n/** @skipMangle */\nexport function setUnexpectedErrorHandler(newUnexpectedErrorHandler: (e: any) => void): void {\n\terrorHandler.setUnexpectedErrorHandler(newUnexpectedErrorHandler);\n}\n\n/**\n * Returns if the error is a SIGPIPE error. SIGPIPE errors should generally be\n * logged at most once, to avoid a loop.\n *\n * @see https://github.com/microsoft/vscode-remote-release/issues/6481\n */\nexport function isSigPipeError(e: unknown): e is Error {\n\tif (!e || typeof e !== 'object') {\n\t\treturn false;\n\t}\n\n\tconst cast = e as Record<string, string | undefined>;\n\treturn cast.code === 'EPIPE' && cast.syscall?.toUpperCase() === 'WRITE';\n}\n\n/**\n * This function should only be called with errors that indicate a bug in the product.\n * E.g. buggy extensions/invalid user-input/network issues should not be able to trigger this code path.\n * If they are, this indicates there is also a bug in the product.\n*/\nexport function onBugIndicatingError(e: any): undefined {\n\terrorHandler.onUnexpectedError(e);\n\treturn undefined;\n}\n\nexport function onUnexpectedError(e: any): undefined {\n\t// ignore errors from cancelled promises\n\tif (!isCancellationError(e)) {\n\t\terrorHandler.onUnexpectedError(e);\n\t}\n\treturn undefined;\n}\n\nexport function onUnexpectedExternalError(e: any): undefined {\n\t// ignore errors from cancelled promises\n\tif (!isCancellationError(e)) {\n\t\terrorHandler.onUnexpectedExternalError(e);\n\t}\n\treturn undefined;\n}\n\nexport interface SerializedError {\n\treadonly $isError: true;\n\treadonly name: string;\n\treadonly message: string;\n\treadonly stack: string;\n\treadonly noTelemetry: boolean;\n\treadonly code?: string;\n\treadonly cause?: SerializedError;\n}\n\ntype ErrorWithCode = Error & {\n\tcode: string | undefined;\n};\n\nexport function transformErrorForSerialization(error: Error): SerializedError;\nexport function transformErrorForSerialization(error: any): any;\nexport function transformErrorForSerialization(error: any): any {\n\tif (error instanceof Error) {\n\t\tconst { name, message, cause } = error;\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tconst stack: string = (<any>error).stacktrace || (<any>error).stack;\n\t\treturn {\n\t\t\t$isError: true,\n\t\t\tname,\n\t\t\tmessage,\n\t\t\tstack,\n\t\t\tnoTelemetry: ErrorNoTelemetry.isErrorNoTelemetry(error),\n\t\t\tcause: cause ? transformErrorForSerialization(cause) : undefined,\n\t\t\tcode: (<ErrorWithCode>error).code\n\t\t};\n\t}\n\n\t// return as is\n\treturn error;\n}\n\nexport function transformErrorFromSerialization(data: SerializedError): Error {\n\tlet error: Error;\n\tif (data.noTelemetry) {\n\t\terror = new ErrorNoTelemetry();\n\t} else {\n\t\terror = new Error();\n\t\terror.name = data.name;\n\t}\n\terror.message = data.message;\n\terror.stack = data.stack;\n\tif (data.code) {\n\t\t(<ErrorWithCode>error).code = data.code;\n\t}\n\tif (data.cause) {\n\t\terror.cause = transformErrorFromSerialization(data.cause);\n\t}\n\treturn error;\n}\n\n// see https://github.com/v8/v8/wiki/Stack%20Trace%20API#basic-stack-traces\nexport interface V8CallSite {\n\tgetThis(): unknown;\n\tgetTypeName(): string | null;\n\tgetFunction(): Function | undefined;\n\tgetFunctionName(): string | null;\n\tgetMethodName(): string | null;\n\tgetFileName(): string | null;\n\tgetLineNumber(): number | null;\n\tgetColumnNumber(): number | null;\n\tgetEvalOrigin(): string | undefined;\n\tisToplevel(): boolean;\n\tisEval(): boolean;\n\tisNative(): boolean;\n\tisConstructor(): boolean;\n\ttoString(): string;\n}\n\nexport const canceledName = 'Canceled';\n\n/**\n * Checks if the given error is a promise in canceled state\n */\nexport function isCancellationError(error: any): boolean {\n\tif (error instanceof CancellationError) {\n\t\treturn true;\n\t}\n\treturn error instanceof Error && error.name === canceledName && error.message === canceledName;\n}\n\n// !!!IMPORTANT!!!\n// Do NOT change this class because it is also used as an API-type.\nexport class CancellationError extends Error {\n\tconstructor() {\n\t\tsuper(canceledName);\n\t\tthis.name = this.message;\n\t}\n}\n\nexport class PendingMigrationError extends Error {\n\n\tprivate static readonly _name = 'PendingMigrationError';\n\n\tstatic is(error: unknown): error is PendingMigrationError {\n\t\treturn error instanceof PendingMigrationError || (error instanceof Error && error.name === PendingMigrationError._name);\n\t}\n\n\tconstructor(message: string) {\n\t\tsuper(message);\n\t\tthis.name = PendingMigrationError._name;\n\t}\n}\n\n/**\n * @deprecated use {@link CancellationError `new CancellationError()`} instead\n */\nexport function canceled(): Error {\n\tconst error = new Error(canceledName);\n\terror.name = error.message;\n\treturn error;\n}\n\nexport function illegalArgument(name?: string): Error {\n\tif (name) {\n\t\treturn new Error(`Illegal argument: ${name}`);\n\t} else {\n\t\treturn new Error('Illegal argument');\n\t}\n}\n\nexport function illegalState(name?: string): Error {\n\tif (name) {\n\t\treturn new Error(`Illegal state: ${name}`);\n\t} else {\n\t\treturn new Error('Illegal state');\n\t}\n}\n\nexport class ReadonlyError extends TypeError {\n\tconstructor(name?: string) {\n\t\tsuper(name ? `${name} is read-only and cannot be changed` : 'Cannot change read-only property');\n\t}\n}\n\nexport function getErrorMessage(err: any): string {\n\tif (!err) {\n\t\treturn 'Error';\n\t}\n\n\tif (err.message) {\n\t\treturn err.message;\n\t}\n\n\tif (err.stack) {\n\t\treturn err.stack.split('\\n')[0];\n\t}\n\n\treturn String(err);\n}\n\nexport class NotImplementedError extends Error {\n\tconstructor(message?: string) {\n\t\tsuper('NotImplemented');\n\t\tif (message) {\n\t\t\tthis.message = message;\n\t\t}\n\t}\n}\n\nexport class NotSupportedError extends Error {\n\tconstructor(message?: string) {\n\t\tsuper('NotSupported');\n\t\tif (message) {\n\t\t\tthis.message = message;\n\t\t}\n\t}\n}\n\nexport class ExpectedError extends Error {\n\treadonly isExpected = true;\n}\n\n/**\n * Error that when thrown won't be logged in telemetry as an unhandled error.\n */\nexport class ErrorNoTelemetry extends Error {\n\toverride readonly name: string;\n\n\tconstructor(msg?: string) {\n\t\tsuper(msg);\n\t\tthis.name = 'CodeExpectedError';\n\t}\n\n\tpublic static fromError(err: Error): ErrorNoTelemetry {\n\t\tif (err instanceof ErrorNoTelemetry) {\n\t\t\treturn err;\n\t\t}\n\n\t\tconst result = new ErrorNoTelemetry();\n\t\tresult.message = err.message;\n\t\tresult.stack = err.stack;\n\t\treturn result;\n\t}\n\n\tpublic static isErrorNoTelemetry(err: Error): err is ErrorNoTelemetry {\n\t\treturn err.name === 'CodeExpectedError';\n\t}\n}\n\n/**\n * This error indicates a bug.\n * Do not throw this for invalid user input.\n * Only catch this error to recover gracefully from bugs.\n */\nexport class BugIndicatingError extends Error {\n\tconstructor(message?: string) {\n\t\tsuper(message || 'An unexpected bug occurred.');\n\t\tObject.setPrototypeOf(this, BugIndicatingError.prototype);\n\n\t\t// Because we know for sure only buggy code throws this,\n\t\t// we definitely want to break here and fix the bug.\n\t\t// debugger;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Comparator } from './arrays.js';\n\nexport function findLast<T, R extends T>(array: readonly T[], predicate: (item: T, index: number) => item is R, fromIndex?: number): R | undefined;\nexport function findLast<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex?: number): T | undefined;\nexport function findLast<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex = array.length - 1): T | undefined {\n\tconst idx = findLastIdx(array, predicate, fromIndex);\n\tif (idx === -1) {\n\t\treturn undefined;\n\t}\n\treturn array[idx];\n}\n\nexport function findLastIdx<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex = array.length - 1): number {\n\tfor (let i = fromIndex; i >= 0; i--) {\n\t\tconst element = array[i];\n\n\t\tif (predicate(element, i)) {\n\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn -1;\n}\n\nexport function findFirst<T, R extends T>(array: readonly T[], predicate: (item: T, index: number) => item is R, fromIndex?: number): R | undefined;\nexport function findFirst<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex?: number): T | undefined;\nexport function findFirst<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex = 0): T | undefined {\n\tconst idx = findFirstIdx(array, predicate, fromIndex);\n\tif (idx === -1) {\n\t\treturn undefined;\n\t}\n\treturn array[idx];\n}\n\nexport function findFirstIdx<T>(array: readonly T[], predicate: (item: T, index: number) => unknown, fromIndex = 0): number {\n\tfor (let i = fromIndex; i < array.length; i++) {\n\t\tconst element = array[i];\n\n\t\tif (predicate(element, i)) {\n\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn -1;\n}\n\n/**\n * Finds the last item where predicate is true using binary search.\n * `predicate` must be monotonous, i.e. `arr.map(predicate)` must be like `[true, ..., true, false, ..., false]`!\n *\n * @returns `undefined` if no item matches, otherwise the last item that matches the predicate.\n */\nexport function findLastMonotonous<T>(array: readonly T[], predicate: (item: T) => boolean): T | undefined {\n\tconst idx = findLastIdxMonotonous(array, predicate);\n\treturn idx === -1 ? undefined : array[idx];\n}\n\n/**\n * Finds the last item where predicate is true using binary search.\n * `predicate` must be monotonous, i.e. `arr.map(predicate)` must be like `[true, ..., true, false, ..., false]`!\n *\n * @returns `startIdx - 1` if predicate is false for all items, otherwise the index of the last item that matches the predicate.\n */\nexport function findLastIdxMonotonous<T>(array: readonly T[], predicate: (item: T) => boolean, startIdx = 0, endIdxEx = array.length): number {\n\tlet i = startIdx;\n\tlet j = endIdxEx;\n\twhile (i < j) {\n\t\tconst k = Math.floor((i + j) / 2);\n\t\tif (predicate(array[k])) {\n\t\t\ti = k + 1;\n\t\t} else {\n\t\t\tj = k;\n\t\t}\n\t}\n\treturn i - 1;\n}\n\n/**\n * Finds the first item where predicate is true using binary search.\n * `predicate` must be monotonous, i.e. `arr.map(predicate)` must be like `[false, ..., false, true, ..., true]`!\n *\n * @returns `undefined` if no item matches, otherwise the first item that matches the predicate.\n */\nexport function findFirstMonotonous<T>(array: readonly T[], predicate: (item: T) => boolean): T | undefined {\n\tconst idx = findFirstIdxMonotonousOrArrLen(array, predicate);\n\treturn idx === array.length ? undefined : array[idx];\n}\n\n/**\n * Finds the first item where predicate is true using binary search.\n * `predicate` must be monotonous, i.e. `arr.map(predicate)` must be like `[false, ..., false, true, ..., true]`!\n *\n * @returns `endIdxEx` if predicate is false for all items, otherwise the index of the first item that matches the predicate.\n */\nexport function findFirstIdxMonotonousOrArrLen<T>(array: readonly T[], predicate: (item: T) => boolean, startIdx = 0, endIdxEx = array.length): number {\n\tlet i = startIdx;\n\tlet j = endIdxEx;\n\twhile (i < j) {\n\t\tconst k = Math.floor((i + j) / 2);\n\t\tif (predicate(array[k])) {\n\t\t\tj = k;\n\t\t} else {\n\t\t\ti = k + 1;\n\t\t}\n\t}\n\treturn i;\n}\n\nexport function findFirstIdxMonotonous<T>(array: readonly T[], predicate: (item: T) => boolean, startIdx = 0, endIdxEx = array.length): number {\n\tconst idx = findFirstIdxMonotonousOrArrLen(array, predicate, startIdx, endIdxEx);\n\treturn idx === array.length ? -1 : idx;\n}\n\n/**\n * Use this when\n * * You have a sorted array\n * * You query this array with a monotonous predicate to find the last item that has a certain property.\n * * You query this array multiple times with monotonous predicates that get weaker and weaker.\n */\nexport class MonotonousArray<T> {\n\tpublic static assertInvariants = false;\n\n\tprivate _findLastMonotonousLastIdx = 0;\n\tprivate _prevFindLastPredicate: ((item: T) => boolean) | undefined;\n\n\tconstructor(private readonly _array: readonly T[]) {\n\t}\n\n\t/**\n\t * The predicate must be monotonous, i.e. `arr.map(predicate)` must be like `[true, ..., true, false, ..., false]`!\n\t * For subsequent calls, current predicate must be weaker than (or equal to) the previous predicate, i.e. more entries must be `true`.\n\t */\n\tfindLastMonotonous(predicate: (item: T) => boolean): T | undefined {\n\t\tif (MonotonousArray.assertInvariants) {\n\t\t\tif (this._prevFindLastPredicate) {\n\t\t\t\tfor (const item of this._array) {\n\t\t\t\t\tif (this._prevFindLastPredicate(item) && !predicate(item)) {\n\t\t\t\t\t\tthrow new Error('MonotonousArray: current predicate must be weaker than (or equal to) the previous predicate.');\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._prevFindLastPredicate = predicate;\n\t\t}\n\n\t\tconst idx = findLastIdxMonotonous(this._array, predicate, this._findLastMonotonousLastIdx);\n\t\tthis._findLastMonotonousLastIdx = idx + 1;\n\t\treturn idx === -1 ? undefined : this._array[idx];\n\t}\n}\n\n/**\n * Returns the first item that is equal to or greater than every other item.\n*/\nexport function findFirstMax<T>(array: readonly T[], comparator: Comparator<T>): T | undefined {\n\tif (array.length === 0) {\n\t\treturn undefined;\n\t}\n\n\tlet max = array[0];\n\tfor (let i = 1; i < array.length; i++) {\n\t\tconst item = array[i];\n\t\tif (comparator(item, max) > 0) {\n\t\t\tmax = item;\n\t\t}\n\t}\n\treturn max;\n}\n\n/**\n * Returns the last item that is equal to or greater than every other item.\n*/\nexport function findLastMax<T>(array: readonly T[], comparator: Comparator<T>): T | undefined {\n\tif (array.length === 0) {\n\t\treturn undefined;\n\t}\n\n\tlet max = array[0];\n\tfor (let i = 1; i < array.length; i++) {\n\t\tconst item = array[i];\n\t\tif (comparator(item, max) >= 0) {\n\t\t\tmax = item;\n\t\t}\n\t}\n\treturn max;\n}\n\n/**\n * Returns the first item that is equal to or less than every other item.\n*/\nexport function findFirstMin<T>(array: readonly T[], comparator: Comparator<T>): T | undefined {\n\treturn findFirstMax(array, (a, b) => -comparator(a, b));\n}\n\nexport function findMaxIdx<T>(array: readonly T[], comparator: Comparator<T>): number {\n\tif (array.length === 0) {\n\t\treturn -1;\n\t}\n\n\tlet maxIdx = 0;\n\tfor (let i = 1; i < array.length; i++) {\n\t\tconst item = array[i];\n\t\tif (comparator(item, array[maxIdx]) > 0) {\n\t\t\tmaxIdx = i;\n\t\t}\n\t}\n\treturn maxIdx;\n}\n\n/**\n * Returns the first mapped value of the array which is not undefined.\n */\nexport function mapFindFirst<T, R>(items: Iterable<T>, mapFn: (value: T) => R | undefined): R | undefined {\n\tfor (const value of items) {\n\t\tconst mapped = mapFn(value);\n\t\tif (mapped !== undefined) {\n\t\t\treturn mapped;\n\t\t}\n\t}\n\n\treturn undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { findFirstIdxMonotonousOrArrLen } from './arraysFind.js';\nimport { CancellationToken } from './cancellation.js';\nimport { CancellationError } from './errors.js';\nimport { ISplice } from './sequence.js';\n\n/**\n * Returns the last entry and the initial N-1 entries of the array, as a tuple of [rest, last].\n *\n * The array must have at least one element.\n *\n * @param arr The input array\n * @returns A tuple of [rest, last] where rest is all but the last element and last is the last element\n * @throws Error if the array is empty\n */\nexport function tail<T>(arr: T[]): [T[], T] {\n\tif (arr.length === 0) {\n\t\tthrow new Error('Invalid tail call');\n\t}\n\n\treturn [arr.slice(0, arr.length - 1), arr[arr.length - 1]];\n}\n\nexport function equals<T>(one: ReadonlyArray<T> | undefined, other: ReadonlyArray<T> | undefined, itemEquals: (a: T, b: T) => boolean = (a, b) => a === b): boolean {\n\tif (one === other) {\n\t\treturn true;\n\t}\n\n\tif (!one || !other) {\n\t\treturn false;\n\t}\n\n\tif (one.length !== other.length) {\n\t\treturn false;\n\t}\n\n\tfor (let i = 0, len = one.length; i < len; i++) {\n\t\tif (!itemEquals(one[i], other[i])) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n/**\n * Remove the element at `index` by replacing it with the last element. This is faster than `splice`\n * but changes the order of the array\n */\nexport function removeFastWithoutKeepingOrder<T>(array: T[], index: number) {\n\tconst last = array.length - 1;\n\tif (index < last) {\n\t\tarray[index] = array[last];\n\t}\n\tarray.pop();\n}\n\n/**\n * Performs a binary search algorithm over a sorted array.\n *\n * @param array The array being searched.\n * @param key The value we search for.\n * @param comparator A function that takes two array elements and returns zero\n *   if they are equal, a negative number if the first element precedes the\n *   second one in the sorting order, or a positive number if the second element\n *   precedes the first one.\n * @return See {@link binarySearch2}\n */\nexport function binarySearch<T>(array: ReadonlyArray<T>, key: T, comparator: (op1: T, op2: T) => number): number {\n\treturn binarySearch2(array.length, i => comparator(array[i], key));\n}\n\n/**\n * Performs a binary search algorithm over a sorted collection. Useful for cases\n * when we need to perform a binary search over something that isn't actually an\n * array, and converting data to an array would defeat the use of binary search\n * in the first place.\n *\n * @param length The collection length.\n * @param compareToKey A function that takes an index of an element in the\n *   collection and returns zero if the value at this index is equal to the\n *   search key, a negative number if the value precedes the search key in the\n *   sorting order, or a positive number if the search key precedes the value.\n * @return A non-negative index of an element, if found. If not found, the\n *   result is -(n+1) (or ~n, using bitwise notation), where n is the index\n *   where the key should be inserted to maintain the sorting order.\n */\nexport function binarySearch2(length: number, compareToKey: (index: number) => number): number {\n\tlet low = 0,\n\t\thigh = length - 1;\n\n\twhile (low <= high) {\n\t\tconst mid = ((low + high) / 2) | 0;\n\t\tconst comp = compareToKey(mid);\n\t\tif (comp < 0) {\n\t\t\tlow = mid + 1;\n\t\t} else if (comp > 0) {\n\t\t\thigh = mid - 1;\n\t\t} else {\n\t\t\treturn mid;\n\t\t}\n\t}\n\treturn -(low + 1);\n}\n\ntype Compare<T> = (a: T, b: T) => number;\n\n/**\n * Finds the nth smallest element in the array using quickselect algorithm.\n * The data does not need to be sorted.\n *\n * @param nth The zero-based index of the element to find (0 = smallest, 1 = second smallest, etc.)\n * @param data The unsorted array\n * @param compare A comparator function that defines the sort order\n * @returns The nth smallest element\n * @throws TypeError if nth is >= data.length\n */\nexport function quickSelect<T>(nth: number, data: T[], compare: Compare<T>): T {\n\n\tnth = nth | 0;\n\n\tif (nth >= data.length) {\n\t\tthrow new TypeError('invalid index');\n\t}\n\n\tconst pivotValue = data[Math.floor(data.length * Math.random())];\n\tconst lower: T[] = [];\n\tconst higher: T[] = [];\n\tconst pivots: T[] = [];\n\n\tfor (const value of data) {\n\t\tconst val = compare(value, pivotValue);\n\t\tif (val < 0) {\n\t\t\tlower.push(value);\n\t\t} else if (val > 0) {\n\t\t\thigher.push(value);\n\t\t} else {\n\t\t\tpivots.push(value);\n\t\t}\n\t}\n\n\tif (nth < lower.length) {\n\t\treturn quickSelect(nth, lower, compare);\n\t} else if (nth < lower.length + pivots.length) {\n\t\treturn pivots[0];\n\t} else {\n\t\treturn quickSelect(nth - (lower.length + pivots.length), higher, compare);\n\t}\n}\n\nexport function groupBy<T>(data: ReadonlyArray<T>, compare: (a: T, b: T) => number): T[][] {\n\tconst result: T[][] = [];\n\tlet currentGroup: T[] | undefined = undefined;\n\tfor (const element of data.slice(0).sort(compare)) {\n\t\tif (!currentGroup || compare(currentGroup[0], element) !== 0) {\n\t\t\tcurrentGroup = [element];\n\t\t\tresult.push(currentGroup);\n\t\t} else {\n\t\t\tcurrentGroup.push(element);\n\t\t}\n\t}\n\treturn result;\n}\n\n/**\n * Splits the given items into a list of (non-empty) groups.\n * `shouldBeGrouped` is used to decide if two consecutive items should be in the same group.\n * The order of the items is preserved.\n */\nexport function* groupAdjacentBy<T>(items: Iterable<T>, shouldBeGrouped: (item1: T, item2: T) => boolean): Iterable<T[]> {\n\tlet currentGroup: T[] | undefined;\n\tlet last: T | undefined;\n\tfor (const item of items) {\n\t\tif (last !== undefined && shouldBeGrouped(last, item)) {\n\t\t\tcurrentGroup!.push(item);\n\t\t} else {\n\t\t\tif (currentGroup) {\n\t\t\t\tyield currentGroup;\n\t\t\t}\n\t\t\tcurrentGroup = [item];\n\t\t}\n\t\tlast = item;\n\t}\n\tif (currentGroup) {\n\t\tyield currentGroup;\n\t}\n}\n\nexport function forEachAdjacent<T>(arr: T[], f: (item1: T | undefined, item2: T | undefined) => void): void {\n\tfor (let i = 0; i <= arr.length; i++) {\n\t\tf(i === 0 ? undefined : arr[i - 1], i === arr.length ? undefined : arr[i]);\n\t}\n}\n\nexport function forEachWithNeighbors<T>(arr: T[], f: (before: T | undefined, element: T, after: T | undefined) => void): void {\n\tfor (let i = 0; i < arr.length; i++) {\n\t\tf(i === 0 ? undefined : arr[i - 1], arr[i], i + 1 === arr.length ? undefined : arr[i + 1]);\n\t}\n}\n\nexport function concatArrays<T extends any[]>(...arrays: T): T[number][number][] {\n\treturn [].concat(...arrays);\n}\n\ninterface IMutableSplice<T> extends ISplice<T> {\n\treadonly toInsert: T[];\n\tdeleteCount: number;\n}\n\n/**\n * Diffs two *sorted* arrays and computes the splices which apply the diff.\n */\nexport function sortedDiff<T>(before: ReadonlyArray<T>, after: ReadonlyArray<T>, compare: (a: T, b: T) => number): ISplice<T>[] {\n\tconst result: IMutableSplice<T>[] = [];\n\n\tfunction pushSplice(start: number, deleteCount: number, toInsert: T[]): void {\n\t\tif (deleteCount === 0 && toInsert.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst latest = result[result.length - 1];\n\n\t\tif (latest && latest.start + latest.deleteCount === start) {\n\t\t\tlatest.deleteCount += deleteCount;\n\t\t\tlatest.toInsert.push(...toInsert);\n\t\t} else {\n\t\t\tresult.push({ start, deleteCount, toInsert });\n\t\t}\n\t}\n\n\tlet beforeIdx = 0;\n\tlet afterIdx = 0;\n\n\twhile (true) {\n\t\tif (beforeIdx === before.length) {\n\t\t\tpushSplice(beforeIdx, 0, after.slice(afterIdx));\n\t\t\tbreak;\n\t\t}\n\t\tif (afterIdx === after.length) {\n\t\t\tpushSplice(beforeIdx, before.length - beforeIdx, []);\n\t\t\tbreak;\n\t\t}\n\n\t\tconst beforeElement = before[beforeIdx];\n\t\tconst afterElement = after[afterIdx];\n\t\tconst n = compare(beforeElement, afterElement);\n\t\tif (n === 0) {\n\t\t\t// equal\n\t\t\tbeforeIdx += 1;\n\t\t\tafterIdx += 1;\n\t\t} else if (n < 0) {\n\t\t\t// beforeElement is smaller -> before element removed\n\t\t\tpushSplice(beforeIdx, 1, []);\n\t\t\tbeforeIdx += 1;\n\t\t} else if (n > 0) {\n\t\t\t// beforeElement is greater -> after element added\n\t\t\tpushSplice(beforeIdx, 0, [afterElement]);\n\t\t\tafterIdx += 1;\n\t\t}\n\t}\n\n\treturn result;\n}\n\n/**\n * Takes two *sorted* arrays and computes their delta (removed, added elements).\n * Finishes in `Math.min(before.length, after.length)` steps.\n */\nexport function delta<T>(before: ReadonlyArray<T>, after: ReadonlyArray<T>, compare: (a: T, b: T) => number): { removed: T[]; added: T[] } {\n\tconst splices = sortedDiff(before, after, compare);\n\tconst removed: T[] = [];\n\tconst added: T[] = [];\n\n\tfor (const splice of splices) {\n\t\tremoved.push(...before.slice(splice.start, splice.start + splice.deleteCount));\n\t\tadded.push(...splice.toInsert);\n\t}\n\n\treturn { removed, added };\n}\n\n/**\n * Returns the top N elements from the array.\n *\n * Faster than sorting the entire array when the array is a lot larger than N.\n *\n * @param array The unsorted array.\n * @param compare A sort function for the elements.\n * @param n The number of elements to return.\n * @return The first n elements from array when sorted with compare.\n */\nexport function top<T>(array: ReadonlyArray<T>, compare: (a: T, b: T) => number, n: number): T[] {\n\tif (n === 0) {\n\t\treturn [];\n\t}\n\tconst result = array.slice(0, n).sort(compare);\n\ttopStep(array, compare, result, n, array.length);\n\treturn result;\n}\n\n/**\n * Asynchronous variant of `top()` allowing for splitting up work in batches between which the event loop can run.\n *\n * Returns the top N elements from the array.\n *\n * Faster than sorting the entire array when the array is a lot larger than N.\n *\n * @param array The unsorted array.\n * @param compare A sort function for the elements.\n * @param n The number of elements to return.\n * @param batch The number of elements to examine before yielding to the event loop.\n * @return The first n elements from array when sorted with compare.\n */\nexport function topAsync<T>(array: T[], compare: (a: T, b: T) => number, n: number, batch: number, token?: CancellationToken): Promise<T[]> {\n\tif (n === 0) {\n\t\treturn Promise.resolve([]);\n\t}\n\n\treturn new Promise((resolve, reject) => {\n\t\t(async () => {\n\t\t\tconst o = array.length;\n\t\t\tconst result = array.slice(0, n).sort(compare);\n\t\t\tfor (let i = n, m = Math.min(n + batch, o); i < o; i = m, m = Math.min(m + batch, o)) {\n\t\t\t\tif (i > n) {\n\t\t\t\t\tawait new Promise(resolve => setTimeout(resolve)); // any other delay function would starve I/O\n\t\t\t\t}\n\t\t\t\tif (token && token.isCancellationRequested) {\n\t\t\t\t\tthrow new CancellationError();\n\t\t\t\t}\n\t\t\t\ttopStep(array, compare, result, i, m);\n\t\t\t}\n\t\t\treturn result;\n\t\t})()\n\t\t\t.then(resolve, reject);\n\t});\n}\n\nfunction topStep<T>(array: ReadonlyArray<T>, compare: (a: T, b: T) => number, result: T[], i: number, m: number): void {\n\tfor (const n = result.length; i < m; i++) {\n\t\tconst element = array[i];\n\t\tif (compare(element, result[n - 1]) < 0) {\n\t\t\tresult.pop();\n\t\t\tconst j = findFirstIdxMonotonousOrArrLen(result, e => compare(element, e) < 0);\n\t\t\tresult.splice(j, 0, element);\n\t\t}\n\t}\n}\n\n/**\n * @returns New array with all falsy values removed. The original array IS NOT modified.\n */\nexport function coalesce<T>(array: ReadonlyArray<T | undefined | null>): T[] {\n\treturn array.filter((e): e is T => !!e);\n}\n\n/**\n * Remove all falsy values from `array`. The original array IS modified.\n */\nexport function coalesceInPlace<T>(array: Array<T | undefined | null>): asserts array is Array<T> {\n\tlet to = 0;\n\tfor (let i = 0; i < array.length; i++) {\n\t\tif (!!array[i]) {\n\t\t\tarray[to] = array[i];\n\t\t\tto += 1;\n\t\t}\n\t}\n\tarray.length = to;\n}\n\n/**\n * @deprecated Use `Array.copyWithin` instead\n */\nexport function move(array: unknown[], from: number, to: number): void {\n\tarray.splice(to, 0, array.splice(from, 1)[0]);\n}\n\n/**\n * @returns false if the provided object is an array and not empty.\n */\nexport function isFalsyOrEmpty(obj: unknown): boolean {\n\treturn !Array.isArray(obj) || obj.length === 0;\n}\n\n/**\n * @returns True if the provided object is an array and has at least one element.\n */\nexport function isNonEmptyArray<T>(obj: T[] | undefined | null): obj is T[];\nexport function isNonEmptyArray<T>(obj: readonly T[] | undefined | null): obj is readonly T[];\nexport function isNonEmptyArray<T>(obj: T[] | readonly T[] | undefined | null): obj is T[] | readonly T[] {\n\treturn Array.isArray(obj) && obj.length > 0;\n}\n\n/**\n * Removes duplicates from the given array. The optional keyFn allows to specify\n * how elements are checked for equality by returning an alternate value for each.\n */\nexport function distinct<T>(array: ReadonlyArray<T>, keyFn: (value: T) => unknown = value => value): T[] {\n\tconst seen = new Set<any>();\n\n\treturn array.filter(element => {\n\t\tconst key = keyFn(element);\n\t\tif (seen.has(key)) {\n\t\t\treturn false;\n\t\t}\n\t\tseen.add(key);\n\t\treturn true;\n\t});\n}\n\nexport function uniqueFilter<T, R>(keyFn: (t: T) => R): (t: T) => boolean {\n\tconst seen = new Set<R>();\n\n\treturn element => {\n\t\tconst key = keyFn(element);\n\n\t\tif (seen.has(key)) {\n\t\t\treturn false;\n\t\t}\n\n\t\tseen.add(key);\n\t\treturn true;\n\t};\n}\n\nexport function commonPrefixLength<T>(one: ReadonlyArray<T>, other: ReadonlyArray<T>, equals: (a: T, b: T) => boolean = (a, b) => a === b): number {\n\tlet result = 0;\n\n\tfor (let i = 0, len = Math.min(one.length, other.length); i < len && equals(one[i], other[i]); i++) {\n\t\tresult++;\n\t}\n\n\treturn result;\n}\n\nexport function range(to: number): number[];\nexport function range(from: number, to: number): number[];\nexport function range(arg: number, to?: number): number[] {\n\tlet from = typeof to === 'number' ? arg : 0;\n\n\tif (typeof to === 'number') {\n\t\tfrom = arg;\n\t} else {\n\t\tfrom = 0;\n\t\tto = arg;\n\t}\n\n\tconst result: number[] = [];\n\n\tif (from <= to) {\n\t\tfor (let i = from; i < to; i++) {\n\t\t\tresult.push(i);\n\t\t}\n\t} else {\n\t\tfor (let i = from; i > to; i--) {\n\t\t\tresult.push(i);\n\t\t}\n\t}\n\n\treturn result;\n}\n\nexport function index<T>(array: ReadonlyArray<T>, indexer: (t: T) => string): { [key: string]: T };\nexport function index<T, R>(array: ReadonlyArray<T>, indexer: (t: T) => string, mapper: (t: T) => R): { [key: string]: R };\nexport function index<T, R>(array: ReadonlyArray<T>, indexer: (t: T) => string, mapper?: (t: T) => R): { [key: string]: R } {\n\treturn array.reduce((r, t) => {\n\t\tr[indexer(t)] = mapper ? mapper(t) : t;\n\t\treturn r;\n\t}, Object.create(null));\n}\n\n/**\n * Inserts an element into an array. Returns a function which, when\n * called, will remove that element from the array.\n *\n * @deprecated In almost all cases, use a `Set<T>` instead.\n */\nexport function insert<T>(array: T[], element: T): () => void {\n\tarray.push(element);\n\n\treturn () => remove(array, element);\n}\n\n/**\n * Removes an element from an array if it can be found.\n *\n * @deprecated In almost all cases, use a `Set<T>` instead.\n */\nexport function remove<T>(array: T[], element: T): T | undefined {\n\tconst index = array.indexOf(element);\n\tif (index > -1) {\n\t\tarray.splice(index, 1);\n\n\t\treturn element;\n\t}\n\n\treturn undefined;\n}\n\n/**\n * Insert `insertArr` inside `target` at `insertIndex`.\n * Please don't touch unless you understand https://jsperf.com/inserting-an-array-within-an-array\n */\nexport function arrayInsert<T>(target: T[], insertIndex: number, insertArr: T[]): T[] {\n\tconst before = target.slice(0, insertIndex);\n\tconst after = target.slice(insertIndex);\n\treturn before.concat(insertArr, after);\n}\n\n/**\n * Uses Fisher-Yates shuffle to shuffle the given array\n */\nexport function shuffle<T>(array: T[], _seed?: number): void {\n\tlet rand: () => number;\n\n\tif (typeof _seed === 'number') {\n\t\tlet seed = _seed;\n\t\t// Seeded random number generator in JS. Modified from:\n\t\t// https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript\n\t\trand = () => {\n\t\t\tconst x = Math.sin(seed++) * 179426549; // throw away most significant digits and reduce any potential bias\n\t\t\treturn x - Math.floor(x);\n\t\t};\n\t} else {\n\t\trand = Math.random;\n\t}\n\n\tfor (let i = array.length - 1; i > 0; i -= 1) {\n\t\tconst j = Math.floor(rand() * (i + 1));\n\t\tconst temp = array[i];\n\t\tarray[i] = array[j];\n\t\tarray[j] = temp;\n\t}\n}\n\n/**\n * Pushes an element to the start of the array, if found.\n */\nexport function pushToStart<T>(arr: T[], value: T): void {\n\tconst index = arr.indexOf(value);\n\n\tif (index > -1) {\n\t\tarr.splice(index, 1);\n\t\tarr.unshift(value);\n\t}\n}\n\n/**\n * Pushes an element to the end of the array, if found.\n */\nexport function pushToEnd<T>(arr: T[], value: T): void {\n\tconst index = arr.indexOf(value);\n\n\tif (index > -1) {\n\t\tarr.splice(index, 1);\n\t\tarr.push(value);\n\t}\n}\n\nexport function pushMany<T>(arr: T[], items: ReadonlyArray<T>): void {\n\tfor (const item of items) {\n\t\tarr.push(item);\n\t}\n}\n\nexport function mapArrayOrNot<T, U>(items: T | T[], fn: (_: T) => U): U | U[] {\n\treturn Array.isArray(items) ?\n\t\titems.map(fn) :\n\t\tfn(items);\n}\n\nexport function mapFilter<T, U>(array: ReadonlyArray<T>, fn: (t: T) => U | undefined): U[] {\n\tconst result: U[] = [];\n\tfor (const item of array) {\n\t\tconst mapped = fn(item);\n\t\tif (mapped !== undefined) {\n\t\t\tresult.push(mapped);\n\t\t}\n\t}\n\treturn result;\n}\n\nexport function withoutDuplicates<T>(array: ReadonlyArray<T>): T[] {\n\tconst s = new Set(array);\n\treturn Array.from(s);\n}\n\nexport function asArray<T>(x: T | T[]): T[];\nexport function asArray<T>(x: T | readonly T[]): readonly T[];\nexport function asArray<T>(x: T | T[]): T[] {\n\treturn Array.isArray(x) ? x : [x];\n}\n\nexport function getRandomElement<T>(arr: T[]): T | undefined {\n\treturn arr[Math.floor(Math.random() * arr.length)];\n}\n\n/**\n * Insert the new items in the array.\n * @param array The original array.\n * @param start The zero-based location in the array from which to start inserting elements.\n * @param newItems The items to be inserted\n */\nexport function insertInto<T>(array: T[], start: number, newItems: T[]): void {\n\tconst startIdx = getActualStartIndex(array, start);\n\tconst originalLength = array.length;\n\tconst newItemsLength = newItems.length;\n\tarray.length = originalLength + newItemsLength;\n\t// Move the items after the start index, start from the end so that we don't overwrite any value.\n\tfor (let i = originalLength - 1; i >= startIdx; i--) {\n\t\tarray[i + newItemsLength] = array[i];\n\t}\n\n\tfor (let i = 0; i < newItemsLength; i++) {\n\t\tarray[i + startIdx] = newItems[i];\n\t}\n}\n\n/**\n * Removes elements from an array and inserts new elements in their place, returning the deleted elements. Alternative to the native Array.splice method, it\n * can only support limited number of items due to the maximum call stack size limit.\n * @param array The original array.\n * @param start The zero-based location in the array from which to start removing elements.\n * @param deleteCount The number of elements to remove.\n * @returns An array containing the elements that were deleted.\n */\nexport function splice<T>(array: T[], start: number, deleteCount: number, newItems: T[]): T[] {\n\tconst index = getActualStartIndex(array, start);\n\tlet result = array.splice(index, deleteCount);\n\tif (result === undefined) {\n\t\t// see https://bugs.webkit.org/show_bug.cgi?id=261140\n\t\tresult = [];\n\t}\n\tinsertInto(array, index, newItems);\n\treturn result;\n}\n\n/**\n * Determine the actual start index (same logic as the native splice() or slice())\n * If greater than the length of the array, start will be set to the length of the array. In this case, no element will be deleted but the method will behave as an adding function, adding as many element as item[n*] provided.\n * If negative, it will begin that many elements from the end of the array. (In this case, the origin -1, meaning -n is the index of the nth last element, and is therefore equivalent to the index of array.length - n.) If array.length + start is less than 0, it will begin from index 0.\n * @param array The target array.\n * @param start The operation index.\n */\nfunction getActualStartIndex<T>(array: T[], start: number): number {\n\treturn start < 0 ? Math.max(start + array.length, 0) : Math.min(start, array.length);\n}\n\n\n\n/**\n * When comparing two values,\n * a negative number indicates that the first value is less than the second,\n * a positive number indicates that the first value is greater than the second,\n * and zero indicates that neither is the case.\n*/\nexport type CompareResult = number;\n\nexport namespace CompareResult {\n\texport function isLessThan(result: CompareResult): boolean {\n\t\treturn result < 0;\n\t}\n\n\texport function isLessThanOrEqual(result: CompareResult): boolean {\n\t\treturn result <= 0;\n\t}\n\n\texport function isGreaterThan(result: CompareResult): boolean {\n\t\treturn result > 0;\n\t}\n\n\texport function isNeitherLessOrGreaterThan(result: CompareResult): boolean {\n\t\treturn result === 0;\n\t}\n\n\texport const greaterThan = 1;\n\texport const lessThan = -1;\n\texport const neitherLessOrGreaterThan = 0;\n}\n\n/**\n * A comparator `c` defines a total order `<=` on `T` as following:\n * `c(a, b) <= 0` iff `a` <= `b`.\n * We also have `c(a, b) == 0` iff `c(b, a) == 0`.\n*/\nexport type Comparator<T> = (a: T, b: T) => CompareResult;\n\nexport function compareBy<TItem, TCompareBy>(selector: (item: TItem) => TCompareBy, comparator: Comparator<TCompareBy>): Comparator<TItem> {\n\treturn (a, b) => comparator(selector(a), selector(b));\n}\n\nexport function tieBreakComparators<TItem>(...comparators: Comparator<TItem>[]): Comparator<TItem> {\n\treturn (item1, item2) => {\n\t\tfor (const comparator of comparators) {\n\t\t\tconst result = comparator(item1, item2);\n\t\t\tif (!CompareResult.isNeitherLessOrGreaterThan(result)) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t}\n\t\treturn CompareResult.neitherLessOrGreaterThan;\n\t};\n}\n\n/**\n * The natural order on numbers.\n*/\nexport const numberComparator: Comparator<number> = (a, b) => a - b;\n\nexport const booleanComparator: Comparator<boolean> = (a, b) => numberComparator(a ? 1 : 0, b ? 1 : 0);\n\nexport function reverseOrder<TItem>(comparator: Comparator<TItem>): Comparator<TItem> {\n\treturn (a, b) => -comparator(a, b);\n}\n\n/**\n * Returns a new comparator that treats `undefined` as the smallest value.\n * All other values are compared using the given comparator.\n*/\nexport function compareUndefinedSmallest<T>(comparator: Comparator<T>): Comparator<T | undefined> {\n\treturn (a, b) => {\n\t\tif (a === undefined) {\n\t\t\treturn b === undefined ? CompareResult.neitherLessOrGreaterThan : CompareResult.lessThan;\n\t\t} else if (b === undefined) {\n\t\t\treturn CompareResult.greaterThan;\n\t\t}\n\n\t\treturn comparator(a, b);\n\t};\n}\n\nexport class ArrayQueue<T> {\n\tprivate readonly items: readonly T[];\n\tprivate firstIdx = 0;\n\tprivate lastIdx: number;\n\n\t/**\n\t * Constructs a queue that is backed by the given array. Runtime is O(1).\n\t*/\n\tconstructor(items: readonly T[]) {\n\t\tthis.items = items;\n\t\tthis.lastIdx = this.items.length - 1;\n\t}\n\n\tget length(): number {\n\t\treturn this.lastIdx - this.firstIdx + 1;\n\t}\n\n\t/**\n\t * Consumes elements from the beginning of the queue as long as the predicate returns true.\n\t * If no elements were consumed, `null` is returned. Has a runtime of O(result.length).\n\t*/\n\ttakeWhile(predicate: (value: T) => boolean): T[] | null {\n\t\t// P(k) := k <= this.lastIdx && predicate(this.items[k])\n\t\t// Find s := min { k | k >= this.firstIdx && !P(k) } and return this.data[this.firstIdx...s)\n\n\t\tlet startIdx = this.firstIdx;\n\t\twhile (startIdx < this.items.length && predicate(this.items[startIdx])) {\n\t\t\tstartIdx++;\n\t\t}\n\t\tconst result = startIdx === this.firstIdx ? null : this.items.slice(this.firstIdx, startIdx);\n\t\tthis.firstIdx = startIdx;\n\t\treturn result;\n\t}\n\n\t/**\n\t * Consumes elements from the end of the queue as long as the predicate returns true.\n\t * If no elements were consumed, `null` is returned.\n\t * The result has the same order as the underlying array!\n\t*/\n\ttakeFromEndWhile(predicate: (value: T) => boolean): T[] | null {\n\t\t// P(k) := this.firstIdx >= k && predicate(this.items[k])\n\t\t// Find s := max { k | k <= this.lastIdx && !P(k) } and return this.data(s...this.lastIdx]\n\n\t\tlet endIdx = this.lastIdx;\n\t\twhile (endIdx >= 0 && predicate(this.items[endIdx])) {\n\t\t\tendIdx--;\n\t\t}\n\t\tconst result = endIdx === this.lastIdx ? null : this.items.slice(endIdx + 1, this.lastIdx + 1);\n\t\tthis.lastIdx = endIdx;\n\t\treturn result;\n\t}\n\n\tpeek(): T | undefined {\n\t\tif (this.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.items[this.firstIdx];\n\t}\n\n\tpeekLast(): T | undefined {\n\t\tif (this.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this.items[this.lastIdx];\n\t}\n\n\tdequeue(): T | undefined {\n\t\tconst result = this.items[this.firstIdx];\n\t\tthis.firstIdx++;\n\t\treturn result;\n\t}\n\n\tremoveLast(): T | undefined {\n\t\tconst result = this.items[this.lastIdx];\n\t\tthis.lastIdx--;\n\t\treturn result;\n\t}\n\n\ttakeCount(count: number): T[] {\n\t\tconst result = this.items.slice(this.firstIdx, this.firstIdx + count);\n\t\tthis.firstIdx += count;\n\t\treturn result;\n\t}\n}\n\n/**\n * This class is faster than an iterator and array for lazy computed data.\n*/\nexport class CallbackIterable<T> {\n\tpublic static readonly empty = new CallbackIterable<never>(_callback => { });\n\n\tconstructor(\n\t\t/**\n\t\t * Calls the callback for every item.\n\t\t * Stops when the callback returns false.\n\t\t*/\n\t\tpublic readonly iterate: (callback: (item: T) => boolean) => void\n\t) {\n\t}\n\n\tforEach(handler: (item: T) => void) {\n\t\tthis.iterate(item => { handler(item); return true; });\n\t}\n\n\ttoArray(): T[] {\n\t\tconst result: T[] = [];\n\t\tthis.iterate(item => { result.push(item); return true; });\n\t\treturn result;\n\t}\n\n\tfilter(predicate: (item: T) => boolean): CallbackIterable<T> {\n\t\treturn new CallbackIterable(cb => this.iterate(item => predicate(item) ? cb(item) : true));\n\t}\n\n\tmap<TResult>(mapFn: (item: T) => TResult): CallbackIterable<TResult> {\n\t\treturn new CallbackIterable<TResult>(cb => this.iterate(item => cb(mapFn(item))));\n\t}\n\n\tsome(predicate: (item: T) => boolean): boolean {\n\t\tlet result = false;\n\t\tthis.iterate(item => { result = predicate(item); return !result; });\n\t\treturn result;\n\t}\n\n\tfindFirst(predicate: (item: T) => boolean): T | undefined {\n\t\tlet result: T | undefined;\n\t\tthis.iterate(item => {\n\t\t\tif (predicate(item)) {\n\t\t\t\tresult = item;\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\t\treturn result;\n\t}\n\n\tfindLast(predicate: (item: T) => boolean): T | undefined {\n\t\tlet result: T | undefined;\n\t\tthis.iterate(item => {\n\t\t\tif (predicate(item)) {\n\t\t\t\tresult = item;\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\t\treturn result;\n\t}\n\n\tfindLastMaxBy(comparator: Comparator<T>): T | undefined {\n\t\tlet result: T | undefined;\n\t\tlet first = true;\n\t\tthis.iterate(item => {\n\t\t\tif (first || CompareResult.isGreaterThan(comparator(item, result!))) {\n\t\t\t\tfirst = false;\n\t\t\t\tresult = item;\n\t\t\t}\n\t\t\treturn true;\n\t\t});\n\t\treturn result;\n\t}\n}\n\n/**\n * Represents a re-arrangement of items in an array.\n */\nexport class Permutation {\n\tconstructor(private readonly _indexMap: readonly number[]) { }\n\n\t/**\n\t * Returns a permutation that sorts the given array according to the given compare function.\n\t */\n\tpublic static createSortPermutation<T>(arr: readonly T[], compareFn: (a: T, b: T) => number): Permutation {\n\t\tconst sortIndices = Array.from(arr.keys()).sort((index1, index2) => compareFn(arr[index1], arr[index2]));\n\t\treturn new Permutation(sortIndices);\n\t}\n\n\t/**\n\t * Returns a new array with the elements of the given array re-arranged according to this permutation.\n\t */\n\tapply<T>(arr: readonly T[]): T[] {\n\t\treturn arr.map((_, index) => arr[this._indexMap[index]]);\n\t}\n\n\t/**\n\t * Returns a new permutation that undoes the re-arrangement of this permutation.\n\t*/\n\tinverse(): Permutation {\n\t\tconst inverseIndexMap = this._indexMap.slice();\n\t\tfor (let i = 0; i < this._indexMap.length; i++) {\n\t\t\tinverseIndexMap[this._indexMap[i]] = i;\n\t\t}\n\t\treturn new Permutation(inverseIndexMap);\n\t}\n}\n\n/**\n * Asynchronous variant of `Array.find()`, returning the first element in\n * the array for which the predicate returns true.\n *\n * This implementation does not bail early and waits for all promises to\n * resolve before returning.\n */\nexport async function findAsync<T>(array: readonly T[], predicate: (element: T, index: number) => Promise<boolean>): Promise<T | undefined> {\n\tconst results = await Promise.all(array.map(\n\t\tasync (element, index) => ({ element, ok: await predicate(element, index) })\n\t));\n\n\treturn results.find(r => r.ok)?.element;\n}\n\nexport function sum(array: readonly number[]): number {\n\treturn array.reduce((acc, value) => acc + value, 0);\n}\n\nexport function sumBy<T>(array: readonly T[], selector: (value: T) => number): number {\n\treturn array.reduce((acc, value) => acc + selector(value), 0);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n/**\n * An interface for a JavaScript object that\n * acts a dictionary. The keys are strings.\n */\nexport type IStringDictionary<V> = Record<string, V>;\n\n/**\n * An interface for a JavaScript object that\n * acts a dictionary. The keys are numbers.\n */\nexport type INumberDictionary<V> = Record<number, V>;\n\n/**\n * Groups the collection into a dictionary based on the provided\n * group function.\n */\nexport function groupBy<K extends string | number | symbol, V>(data: readonly V[], groupFn: (element: V) => K): Partial<Record<K, V[]>> {\n\tconst result: Partial<Record<K, V[]>> = Object.create(null);\n\tfor (const element of data) {\n\t\tconst key = groupFn(element);\n\t\tlet target = result[key];\n\t\tif (!target) {\n\t\t\ttarget = result[key] = [];\n\t\t}\n\t\ttarget.push(element);\n\t}\n\treturn result;\n}\n\nexport function groupByMap<K, V>(data: V[], groupFn: (element: V) => K): Map<K, V[]> {\n\tconst result = new Map<K, V[]>();\n\tfor (const element of data) {\n\t\tconst key = groupFn(element);\n\t\tlet target = result.get(key);\n\t\tif (!target) {\n\t\t\ttarget = [];\n\t\t\tresult.set(key, target);\n\t\t}\n\t\ttarget.push(element);\n\t}\n\treturn result;\n}\n\nexport function diffSets<T>(before: ReadonlySet<T>, after: ReadonlySet<T>): { removed: T[]; added: T[] } {\n\tconst removed: T[] = [];\n\tconst added: T[] = [];\n\tfor (const element of before) {\n\t\tif (!after.has(element)) {\n\t\t\tremoved.push(element);\n\t\t}\n\t}\n\tfor (const element of after) {\n\t\tif (!before.has(element)) {\n\t\t\tadded.push(element);\n\t\t}\n\t}\n\treturn { removed, added };\n}\n\nexport function diffMaps<K, V>(before: Map<K, V>, after: Map<K, V>): { removed: V[]; added: V[] } {\n\tconst removed: V[] = [];\n\tconst added: V[] = [];\n\tfor (const [index, value] of before) {\n\t\tif (!after.has(index)) {\n\t\t\tremoved.push(value);\n\t\t}\n\t}\n\tfor (const [index, value] of after) {\n\t\tif (!before.has(index)) {\n\t\t\tadded.push(value);\n\t\t}\n\t}\n\treturn { removed, added };\n}\n\n/**\n * Computes the intersection of two sets.\n *\n * @param setA - The first set.\n * @param setB - The second iterable.\n * @returns A new set containing the elements that are in both `setA` and `setB`.\n */\nexport function intersection<T>(setA: Set<T>, setB: Iterable<T>): Set<T> {\n\tconst result = new Set<T>();\n\tfor (const elem of setB) {\n\t\tif (setA.has(elem)) {\n\t\t\tresult.add(elem);\n\t\t}\n\t}\n\treturn result;\n}\n\nexport class SetWithKey<T> implements Set<T> {\n\tprivate _map = new Map<unknown, T>();\n\n\tconstructor(values: T[], private toKey: (t: T) => unknown) {\n\t\tfor (const value of values) {\n\t\t\tthis.add(value);\n\t\t}\n\t}\n\n\tget size(): number {\n\t\treturn this._map.size;\n\t}\n\n\tadd(value: T): this {\n\t\tconst key = this.toKey(value);\n\t\tthis._map.set(key, value);\n\t\treturn this;\n\t}\n\n\tdelete(value: T): boolean {\n\t\treturn this._map.delete(this.toKey(value));\n\t}\n\n\thas(value: T): boolean {\n\t\treturn this._map.has(this.toKey(value));\n\t}\n\n\t*entries(): IterableIterator<[T, T]> {\n\t\tfor (const entry of this._map.values()) {\n\t\t\tyield [entry, entry];\n\t\t}\n\t}\n\n\tkeys(): IterableIterator<T> {\n\t\treturn this.values();\n\t}\n\n\t*values(): IterableIterator<T> {\n\t\tfor (const entry of this._map.values()) {\n\t\t\tyield entry;\n\t\t}\n\t}\n\n\tclear(): void {\n\t\tthis._map.clear();\n\t}\n\n\tforEach(callbackfn: (value: T, value2: T, set: Set<T>) => void, thisArg?: unknown): void {\n\t\tthis._map.forEach(entry => callbackfn.call(thisArg, entry, entry, this));\n\t}\n\n\t[Symbol.iterator](): IterableIterator<T> {\n\t\treturn this.values();\n\t}\n\n\t[Symbol.toStringTag]: string = 'SetWithKey';\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from './uri.js';\n\nexport function getOrSet<K, V>(map: Map<K, V>, key: K, value: V): V {\n\tlet result = map.get(key);\n\tif (result === undefined) {\n\t\tresult = value;\n\t\tmap.set(key, result);\n\t}\n\n\treturn result;\n}\n\nexport function mapToString<K, V>(map: Map<K, V>): string {\n\tconst entries: string[] = [];\n\tmap.forEach((value, key) => {\n\t\tentries.push(`${key} => ${value}`);\n\t});\n\n\treturn `Map(${map.size}) {${entries.join(', ')}}`;\n}\n\nexport function setToString<K>(set: Set<K>): string {\n\tconst entries: K[] = [];\n\tset.forEach(value => {\n\t\tentries.push(value);\n\t});\n\n\treturn `Set(${set.size}) {${entries.join(', ')}}`;\n}\n\ninterface ResourceMapKeyFn {\n\t(resource: URI): string;\n}\n\nclass ResourceMapEntry<T> {\n\tconstructor(readonly uri: URI, readonly value: T) { }\n}\n\nfunction isEntries<T>(arg: ResourceMap<T> | ResourceMapKeyFn | readonly (readonly [URI, T])[] | undefined): arg is readonly (readonly [URI, T])[] {\n\treturn Array.isArray(arg);\n}\n\nexport class ResourceMap<T> implements Map<URI, T> {\n\n\tprivate static readonly defaultToKey = (resource: URI) => resource.toString();\n\n\treadonly [Symbol.toStringTag] = 'ResourceMap';\n\n\tprivate readonly map: Map<string, ResourceMapEntry<T>>;\n\tprivate readonly toKey: ResourceMapKeyFn;\n\n\t/**\n\t *\n\t * @param toKey Custom uri identity function, e.g use an existing `IExtUri#getComparison`-util\n\t */\n\tconstructor(toKey?: ResourceMapKeyFn);\n\n\t/**\n\t *\n\t * @param other Another resource which this maps is created from\n\t * @param toKey Custom uri identity function, e.g use an existing `IExtUri#getComparison`-util\n\t */\n\tconstructor(other?: ResourceMap<T>, toKey?: ResourceMapKeyFn);\n\n\t/**\n\t *\n\t * @param other Another resource which this maps is created from\n\t * @param toKey Custom uri identity function, e.g use an existing `IExtUri#getComparison`-util\n\t */\n\tconstructor(entries?: readonly (readonly [URI, T])[], toKey?: ResourceMapKeyFn);\n\n\tconstructor(arg?: ResourceMap<T> | ResourceMapKeyFn | readonly (readonly [URI, T])[], toKey?: ResourceMapKeyFn) {\n\t\tif (arg instanceof ResourceMap) {\n\t\t\tthis.map = new Map(arg.map);\n\t\t\tthis.toKey = toKey ?? ResourceMap.defaultToKey;\n\t\t} else if (isEntries(arg)) {\n\t\t\tthis.map = new Map();\n\t\t\tthis.toKey = toKey ?? ResourceMap.defaultToKey;\n\n\t\t\tfor (const [resource, value] of arg) {\n\t\t\t\tthis.set(resource, value);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.map = new Map();\n\t\t\tthis.toKey = arg ?? ResourceMap.defaultToKey;\n\t\t}\n\t}\n\n\tset(resource: URI, value: T): this {\n\t\tthis.map.set(this.toKey(resource), new ResourceMapEntry(resource, value));\n\t\treturn this;\n\t}\n\n\tget(resource: URI): T | undefined {\n\t\treturn this.map.get(this.toKey(resource))?.value;\n\t}\n\n\thas(resource: URI): boolean {\n\t\treturn this.map.has(this.toKey(resource));\n\t}\n\n\tget size(): number {\n\t\treturn this.map.size;\n\t}\n\n\tclear(): void {\n\t\tthis.map.clear();\n\t}\n\n\tdelete(resource: URI): boolean {\n\t\treturn this.map.delete(this.toKey(resource));\n\t}\n\n\tforEach(clb: (value: T, key: URI, map: Map<URI, T>) => void, thisArg?: object): void {\n\t\tif (typeof thisArg !== 'undefined') {\n\t\t\tclb = clb.bind(thisArg);\n\t\t}\n\t\tfor (const [_, entry] of this.map) {\n\t\t\tclb(entry.value, entry.uri, this);\n\t\t}\n\t}\n\n\t*values(): IterableIterator<T> {\n\t\tfor (const entry of this.map.values()) {\n\t\t\tyield entry.value;\n\t\t}\n\t}\n\n\t*keys(): IterableIterator<URI> {\n\t\tfor (const entry of this.map.values()) {\n\t\t\tyield entry.uri;\n\t\t}\n\t}\n\n\t*entries(): IterableIterator<[URI, T]> {\n\t\tfor (const entry of this.map.values()) {\n\t\t\tyield [entry.uri, entry.value];\n\t\t}\n\t}\n\n\t*[Symbol.iterator](): IterableIterator<[URI, T]> {\n\t\tfor (const [, entry] of this.map) {\n\t\t\tyield [entry.uri, entry.value];\n\t\t}\n\t}\n}\n\nexport class ResourceSet implements Set<URI> {\n\n\treadonly [Symbol.toStringTag]: string = 'ResourceSet';\n\n\tprivate readonly _map: ResourceMap<URI>;\n\n\tconstructor(toKey?: ResourceMapKeyFn);\n\tconstructor(entries: readonly URI[], toKey?: ResourceMapKeyFn);\n\tconstructor(entriesOrKey?: readonly URI[] | ResourceMapKeyFn, toKey?: ResourceMapKeyFn) {\n\t\tif (!entriesOrKey || typeof entriesOrKey === 'function') {\n\t\t\tthis._map = new ResourceMap(entriesOrKey);\n\t\t} else {\n\t\t\tthis._map = new ResourceMap(toKey);\n\t\t\tentriesOrKey.forEach(this.add, this);\n\t\t}\n\t}\n\n\n\tget size(): number {\n\t\treturn this._map.size;\n\t}\n\n\tadd(value: URI): this {\n\t\tthis._map.set(value, value);\n\t\treturn this;\n\t}\n\n\tclear(): void {\n\t\tthis._map.clear();\n\t}\n\n\tdelete(value: URI): boolean {\n\t\treturn this._map.delete(value);\n\t}\n\n\tforEach(callbackfn: (value: URI, value2: URI, set: Set<URI>) => void, thisArg?: unknown): void {\n\t\tthis._map.forEach((_value, key) => callbackfn.call(thisArg, key, key, this));\n\t}\n\n\thas(value: URI): boolean {\n\t\treturn this._map.has(value);\n\t}\n\n\tentries(): IterableIterator<[URI, URI]> {\n\t\treturn this._map.entries();\n\t}\n\n\tkeys(): IterableIterator<URI> {\n\t\treturn this._map.keys();\n\t}\n\n\tvalues(): IterableIterator<URI> {\n\t\treturn this._map.keys();\n\t}\n\n\t[Symbol.iterator](): IterableIterator<URI> {\n\t\treturn this.keys();\n\t}\n}\n\n\ninterface Item<K, V> {\n\tprevious: Item<K, V> | undefined;\n\tnext: Item<K, V> | undefined;\n\tkey: K;\n\tvalue: V;\n}\n\nexport const enum Touch {\n\tNone = 0,\n\tAsOld = 1,\n\tAsNew = 2\n}\n\nexport class LinkedMap<K, V> implements Map<K, V> {\n\n\treadonly [Symbol.toStringTag] = 'LinkedMap';\n\n\tprivate _map: Map<K, Item<K, V>>;\n\tprivate _head: Item<K, V> | undefined;\n\tprivate _tail: Item<K, V> | undefined;\n\tprivate _size: number;\n\n\tprivate _state: number;\n\n\tconstructor() {\n\t\tthis._map = new Map<K, Item<K, V>>();\n\t\tthis._head = undefined;\n\t\tthis._tail = undefined;\n\t\tthis._size = 0;\n\t\tthis._state = 0;\n\t}\n\n\tclear(): void {\n\t\tthis._map.clear();\n\t\tthis._head = undefined;\n\t\tthis._tail = undefined;\n\t\tthis._size = 0;\n\t\tthis._state++;\n\t}\n\n\tisEmpty(): boolean {\n\t\treturn !this._head && !this._tail;\n\t}\n\n\tget size(): number {\n\t\treturn this._size;\n\t}\n\n\tget first(): V | undefined {\n\t\treturn this._head?.value;\n\t}\n\n\tget last(): V | undefined {\n\t\treturn this._tail?.value;\n\t}\n\n\thas(key: K): boolean {\n\t\treturn this._map.has(key);\n\t}\n\n\tget(key: K, touch: Touch = Touch.None): V | undefined {\n\t\tconst item = this._map.get(key);\n\t\tif (!item) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (touch !== Touch.None) {\n\t\t\tthis.touch(item, touch);\n\t\t}\n\t\treturn item.value;\n\t}\n\n\tset(key: K, value: V, touch: Touch = Touch.None): this {\n\t\tlet item = this._map.get(key);\n\t\tif (item) {\n\t\t\titem.value = value;\n\t\t\tif (touch !== Touch.None) {\n\t\t\t\tthis.touch(item, touch);\n\t\t\t}\n\t\t} else {\n\t\t\titem = { key, value, next: undefined, previous: undefined };\n\t\t\tswitch (touch) {\n\t\t\t\tcase Touch.None:\n\t\t\t\t\tthis.addItemLast(item);\n\t\t\t\t\tbreak;\n\t\t\t\tcase Touch.AsOld:\n\t\t\t\t\tthis.addItemFirst(item);\n\t\t\t\t\tbreak;\n\t\t\t\tcase Touch.AsNew:\n\t\t\t\t\tthis.addItemLast(item);\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\tthis.addItemLast(item);\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tthis._map.set(key, item);\n\t\t\tthis._size++;\n\t\t}\n\t\treturn this;\n\t}\n\n\tdelete(key: K): boolean {\n\t\treturn !!this.remove(key);\n\t}\n\n\tremove(key: K): V | undefined {\n\t\tconst item = this._map.get(key);\n\t\tif (!item) {\n\t\t\treturn undefined;\n\t\t}\n\t\tthis._map.delete(key);\n\t\tthis.removeItem(item);\n\t\tthis._size--;\n\t\treturn item.value;\n\t}\n\n\tshift(): V | undefined {\n\t\tif (!this._head && !this._tail) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (!this._head || !this._tail) {\n\t\t\tthrow new Error('Invalid list');\n\t\t}\n\t\tconst item = this._head;\n\t\tthis._map.delete(item.key);\n\t\tthis.removeItem(item);\n\t\tthis._size--;\n\t\treturn item.value;\n\t}\n\n\tforEach(callbackfn: (value: V, key: K, map: LinkedMap<K, V>) => void, thisArg?: unknown): void {\n\t\tconst state = this._state;\n\t\tlet current = this._head;\n\t\twhile (current) {\n\t\t\tif (thisArg) {\n\t\t\t\tcallbackfn.bind(thisArg)(current.value, current.key, this);\n\t\t\t} else {\n\t\t\t\tcallbackfn(current.value, current.key, this);\n\t\t\t}\n\t\t\tif (this._state !== state) {\n\t\t\t\tthrow new Error(`LinkedMap got modified during iteration.`);\n\t\t\t}\n\t\t\tcurrent = current.next;\n\t\t}\n\t}\n\n\tkeys(): IterableIterator<K> {\n\t\tconst map = this;\n\t\tconst state = this._state;\n\t\tlet current = this._head;\n\t\tconst iterator: IterableIterator<K> = {\n\t\t\t[Symbol.iterator]() {\n\t\t\t\treturn iterator;\n\t\t\t},\n\t\t\tnext(): IteratorResult<K> {\n\t\t\t\tif (map._state !== state) {\n\t\t\t\t\tthrow new Error(`LinkedMap got modified during iteration.`);\n\t\t\t\t}\n\t\t\t\tif (current) {\n\t\t\t\t\tconst result = { value: current.key, done: false };\n\t\t\t\t\tcurrent = current.next;\n\t\t\t\t\treturn result;\n\t\t\t\t} else {\n\t\t\t\t\treturn { value: undefined, done: true };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\treturn iterator;\n\t}\n\n\tvalues(): IterableIterator<V> {\n\t\tconst map = this;\n\t\tconst state = this._state;\n\t\tlet current = this._head;\n\t\tconst iterator: IterableIterator<V> = {\n\t\t\t[Symbol.iterator]() {\n\t\t\t\treturn iterator;\n\t\t\t},\n\t\t\tnext(): IteratorResult<V> {\n\t\t\t\tif (map._state !== state) {\n\t\t\t\t\tthrow new Error(`LinkedMap got modified during iteration.`);\n\t\t\t\t}\n\t\t\t\tif (current) {\n\t\t\t\t\tconst result = { value: current.value, done: false };\n\t\t\t\t\tcurrent = current.next;\n\t\t\t\t\treturn result;\n\t\t\t\t} else {\n\t\t\t\t\treturn { value: undefined, done: true };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\treturn iterator;\n\t}\n\n\tentries(): IterableIterator<[K, V]> {\n\t\tconst map = this;\n\t\tconst state = this._state;\n\t\tlet current = this._head;\n\t\tconst iterator: IterableIterator<[K, V]> = {\n\t\t\t[Symbol.iterator]() {\n\t\t\t\treturn iterator;\n\t\t\t},\n\t\t\tnext(): IteratorResult<[K, V]> {\n\t\t\t\tif (map._state !== state) {\n\t\t\t\t\tthrow new Error(`LinkedMap got modified during iteration.`);\n\t\t\t\t}\n\t\t\t\tif (current) {\n\t\t\t\t\tconst result: IteratorResult<[K, V]> = { value: [current.key, current.value], done: false };\n\t\t\t\t\tcurrent = current.next;\n\t\t\t\t\treturn result;\n\t\t\t\t} else {\n\t\t\t\t\treturn { value: undefined, done: true };\n\t\t\t\t}\n\t\t\t}\n\t\t};\n\t\treturn iterator;\n\t}\n\n\t[Symbol.iterator](): IterableIterator<[K, V]> {\n\t\treturn this.entries();\n\t}\n\n\tprotected trimOld(newSize: number) {\n\t\tif (newSize >= this.size) {\n\t\t\treturn;\n\t\t}\n\t\tif (newSize === 0) {\n\t\t\tthis.clear();\n\t\t\treturn;\n\t\t}\n\t\tlet current = this._head;\n\t\tlet currentSize = this.size;\n\t\twhile (current && currentSize > newSize) {\n\t\t\tthis._map.delete(current.key);\n\t\t\tcurrent = current.next;\n\t\t\tcurrentSize--;\n\t\t}\n\t\tthis._head = current;\n\t\tthis._size = currentSize;\n\t\tif (current) {\n\t\t\tcurrent.previous = undefined;\n\t\t}\n\t\tthis._state++;\n\t}\n\n\tprotected trimNew(newSize: number) {\n\t\tif (newSize >= this.size) {\n\t\t\treturn;\n\t\t}\n\t\tif (newSize === 0) {\n\t\t\tthis.clear();\n\t\t\treturn;\n\t\t}\n\t\tlet current = this._tail;\n\t\tlet currentSize = this.size;\n\t\twhile (current && currentSize > newSize) {\n\t\t\tthis._map.delete(current.key);\n\t\t\tcurrent = current.previous;\n\t\t\tcurrentSize--;\n\t\t}\n\t\tthis._tail = current;\n\t\tthis._size = currentSize;\n\t\tif (current) {\n\t\t\tcurrent.next = undefined;\n\t\t}\n\t\tthis._state++;\n\t}\n\n\tprivate addItemFirst(item: Item<K, V>): void {\n\t\t// First time Insert\n\t\tif (!this._head && !this._tail) {\n\t\t\tthis._tail = item;\n\t\t} else if (!this._head) {\n\t\t\tthrow new Error('Invalid list');\n\t\t} else {\n\t\t\titem.next = this._head;\n\t\t\tthis._head.previous = item;\n\t\t}\n\t\tthis._head = item;\n\t\tthis._state++;\n\t}\n\n\tprivate addItemLast(item: Item<K, V>): void {\n\t\t// First time Insert\n\t\tif (!this._head && !this._tail) {\n\t\t\tthis._head = item;\n\t\t} else if (!this._tail) {\n\t\t\tthrow new Error('Invalid list');\n\t\t} else {\n\t\t\titem.previous = this._tail;\n\t\t\tthis._tail.next = item;\n\t\t}\n\t\tthis._tail = item;\n\t\tthis._state++;\n\t}\n\n\tprivate removeItem(item: Item<K, V>): void {\n\t\tif (item === this._head && item === this._tail) {\n\t\t\tthis._head = undefined;\n\t\t\tthis._tail = undefined;\n\t\t}\n\t\telse if (item === this._head) {\n\t\t\t// This can only happen if size === 1 which is handled\n\t\t\t// by the case above.\n\t\t\tif (!item.next) {\n\t\t\t\tthrow new Error('Invalid list');\n\t\t\t}\n\t\t\titem.next.previous = undefined;\n\t\t\tthis._head = item.next;\n\t\t}\n\t\telse if (item === this._tail) {\n\t\t\t// This can only happen if size === 1 which is handled\n\t\t\t// by the case above.\n\t\t\tif (!item.previous) {\n\t\t\t\tthrow new Error('Invalid list');\n\t\t\t}\n\t\t\titem.previous.next = undefined;\n\t\t\tthis._tail = item.previous;\n\t\t}\n\t\telse {\n\t\t\tconst next = item.next;\n\t\t\tconst previous = item.previous;\n\t\t\tif (!next || !previous) {\n\t\t\t\tthrow new Error('Invalid list');\n\t\t\t}\n\t\t\tnext.previous = previous;\n\t\t\tprevious.next = next;\n\t\t}\n\t\titem.next = undefined;\n\t\titem.previous = undefined;\n\t\tthis._state++;\n\t}\n\n\tprivate touch(item: Item<K, V>, touch: Touch): void {\n\t\tif (!this._head || !this._tail) {\n\t\t\tthrow new Error('Invalid list');\n\t\t}\n\t\tif ((touch !== Touch.AsOld && touch !== Touch.AsNew)) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (touch === Touch.AsOld) {\n\t\t\tif (item === this._head) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst next = item.next;\n\t\t\tconst previous = item.previous;\n\n\t\t\t// Unlink the item\n\t\t\tif (item === this._tail) {\n\t\t\t\t// previous must be defined since item was not head but is tail\n\t\t\t\t// So there are more than on item in the map\n\t\t\t\tprevious!.next = undefined;\n\t\t\t\tthis._tail = previous;\n\t\t\t}\n\t\t\telse {\n\t\t\t\t// Both next and previous are not undefined since item was neither head nor tail.\n\t\t\t\tnext!.previous = previous;\n\t\t\t\tprevious!.next = next;\n\t\t\t}\n\n\t\t\t// Insert the node at head\n\t\t\titem.previous = undefined;\n\t\t\titem.next = this._head;\n\t\t\tthis._head.previous = item;\n\t\t\tthis._head = item;\n\t\t\tthis._state++;\n\t\t} else if (touch === Touch.AsNew) {\n\t\t\tif (item === this._tail) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst next = item.next;\n\t\t\tconst previous = item.previous;\n\n\t\t\t// Unlink the item.\n\t\t\tif (item === this._head) {\n\t\t\t\t// next must be defined since item was not tail but is head\n\t\t\t\t// So there are more than on item in the map\n\t\t\t\tnext!.previous = undefined;\n\t\t\t\tthis._head = next;\n\t\t\t} else {\n\t\t\t\t// Both next and previous are not undefined since item was neither head nor tail.\n\t\t\t\tnext!.previous = previous;\n\t\t\t\tprevious!.next = next;\n\t\t\t}\n\t\t\titem.next = undefined;\n\t\t\titem.previous = this._tail;\n\t\t\tthis._tail.next = item;\n\t\t\tthis._tail = item;\n\t\t\tthis._state++;\n\t\t}\n\t}\n\n\ttoJSON(): [K, V][] {\n\t\tconst data: [K, V][] = [];\n\n\t\tthis.forEach((value, key) => {\n\t\t\tdata.push([key, value]);\n\t\t});\n\n\t\treturn data;\n\t}\n\n\tfromJSON(data: [K, V][]): void {\n\t\tthis.clear();\n\n\t\tfor (const [key, value] of data) {\n\t\t\tthis.set(key, value);\n\t\t}\n\t}\n}\n\nabstract class Cache<K, V> extends LinkedMap<K, V> {\n\n\tprotected _limit: number;\n\tprotected _ratio: number;\n\n\tconstructor(limit: number, ratio: number = 1) {\n\t\tsuper();\n\t\tthis._limit = limit;\n\t\tthis._ratio = Math.min(Math.max(0, ratio), 1);\n\t}\n\n\tget limit(): number {\n\t\treturn this._limit;\n\t}\n\n\tset limit(limit: number) {\n\t\tthis._limit = limit;\n\t\tthis.checkTrim();\n\t}\n\n\tget ratio(): number {\n\t\treturn this._ratio;\n\t}\n\n\tset ratio(ratio: number) {\n\t\tthis._ratio = Math.min(Math.max(0, ratio), 1);\n\t\tthis.checkTrim();\n\t}\n\n\toverride get(key: K, touch: Touch = Touch.AsNew): V | undefined {\n\t\treturn super.get(key, touch);\n\t}\n\n\tpeek(key: K): V | undefined {\n\t\treturn super.get(key, Touch.None);\n\t}\n\n\toverride set(key: K, value: V): this {\n\t\tsuper.set(key, value, Touch.AsNew);\n\t\treturn this;\n\t}\n\n\tprotected checkTrim() {\n\t\tif (this.size > this._limit) {\n\t\t\tthis.trim(Math.round(this._limit * this._ratio));\n\t\t}\n\t}\n\n\tprotected abstract trim(newSize: number): void;\n}\n\nexport class LRUCache<K, V> extends Cache<K, V> {\n\n\tconstructor(limit: number, ratio: number = 1) {\n\t\tsuper(limit, ratio);\n\t}\n\n\tprotected override trim(newSize: number) {\n\t\tthis.trimOld(newSize);\n\t}\n\n\toverride set(key: K, value: V): this {\n\t\tsuper.set(key, value);\n\t\tthis.checkTrim();\n\t\treturn this;\n\t}\n}\n\nexport class MRUCache<K, V> extends Cache<K, V> {\n\n\tconstructor(limit: number, ratio: number = 1) {\n\t\tsuper(limit, ratio);\n\t}\n\n\tprotected override trim(newSize: number) {\n\t\tthis.trimNew(newSize);\n\t}\n\n\toverride set(key: K, value: V): this {\n\t\tif (this._limit <= this.size && !this.has(key)) {\n\t\t\tthis.trim(Math.round(this._limit * this._ratio) - 1);\n\t\t}\n\n\t\tsuper.set(key, value);\n\t\treturn this;\n\t}\n}\n\nexport class CounterSet<T> {\n\n\tprivate map = new Map<T, number>();\n\n\tadd(value: T): CounterSet<T> {\n\t\tthis.map.set(value, (this.map.get(value) || 0) + 1);\n\t\treturn this;\n\t}\n\n\tdelete(value: T): boolean {\n\t\tlet counter = this.map.get(value) || 0;\n\n\t\tif (counter === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tcounter--;\n\n\t\tif (counter === 0) {\n\t\t\tthis.map.delete(value);\n\t\t} else {\n\t\t\tthis.map.set(value, counter);\n\t\t}\n\n\t\treturn true;\n\t}\n\n\thas(value: T): boolean {\n\t\treturn this.map.has(value);\n\t}\n}\n\n/**\n * A map that allows access both by keys and values.\n * **NOTE**: values need to be unique.\n */\nexport class BidirectionalMap<K, V> {\n\n\tprivate readonly _m1 = new Map<K, V>();\n\tprivate readonly _m2 = new Map<V, K>();\n\n\tconstructor(entries?: readonly (readonly [K, V])[]) {\n\t\tif (entries) {\n\t\t\tfor (const [key, value] of entries) {\n\t\t\t\tthis.set(key, value);\n\t\t\t}\n\t\t}\n\t}\n\n\tclear(): void {\n\t\tthis._m1.clear();\n\t\tthis._m2.clear();\n\t}\n\n\tset(key: K, value: V): void {\n\t\tthis._m1.set(key, value);\n\t\tthis._m2.set(value, key);\n\t}\n\n\tget(key: K): V | undefined {\n\t\treturn this._m1.get(key);\n\t}\n\n\tgetKey(value: V): K | undefined {\n\t\treturn this._m2.get(value);\n\t}\n\n\tdelete(key: K): boolean {\n\t\tconst value = this._m1.get(key);\n\t\tif (value === undefined) {\n\t\t\treturn false;\n\t\t}\n\t\tthis._m1.delete(key);\n\t\tthis._m2.delete(value);\n\t\treturn true;\n\t}\n\n\tforEach(callbackfn: (value: V, key: K, map: BidirectionalMap<K, V>) => void, thisArg?: unknown): void {\n\t\tthis._m1.forEach((value, key) => {\n\t\t\tcallbackfn.call(thisArg, value, key, this);\n\t\t});\n\t}\n\n\tkeys(): IterableIterator<K> {\n\t\treturn this._m1.keys();\n\t}\n\n\tvalues(): IterableIterator<V> {\n\t\treturn this._m1.values();\n\t}\n}\n\nexport class SetMap<K, V> {\n\n\tprivate map = new Map<K, Set<V>>();\n\n\tadd(key: K, value: V): void {\n\t\tlet values = this.map.get(key);\n\n\t\tif (!values) {\n\t\t\tvalues = new Set<V>();\n\t\t\tthis.map.set(key, values);\n\t\t}\n\n\t\tvalues.add(value);\n\t}\n\n\tdelete(key: K, value: V): void {\n\t\tconst values = this.map.get(key);\n\n\t\tif (!values) {\n\t\t\treturn;\n\t\t}\n\n\t\tvalues.delete(value);\n\n\t\tif (values.size === 0) {\n\t\t\tthis.map.delete(key);\n\t\t}\n\t}\n\n\tforEach(key: K, fn: (value: V) => void): void {\n\t\tconst values = this.map.get(key);\n\n\t\tif (!values) {\n\t\t\treturn;\n\t\t}\n\n\t\tvalues.forEach(fn);\n\t}\n\n\tget(key: K): ReadonlySet<V> {\n\t\tconst values = this.map.get(key);\n\t\tif (!values) {\n\t\t\treturn new Set<V>();\n\t\t}\n\t\treturn values;\n\t}\n}\n\nexport function mapsStrictEqualIgnoreOrder(a: Map<unknown, unknown>, b: Map<unknown, unknown>): boolean {\n\tif (a === b) {\n\t\treturn true;\n\t}\n\n\tif (a.size !== b.size) {\n\t\treturn false;\n\t}\n\n\tfor (const [key, value] of a) {\n\t\tif (!b.has(key) || b.get(key) !== value) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tfor (const [key] of b) {\n\t\tif (!a.has(key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n/**\n * A map that is addressable with an arbitrary number of keys. This is useful in high performance\n * scenarios where creating a composite key whenever the data is accessed is too expensive. For\n * example for a very hot function, constructing a string like `first-second-third` for every call\n * will cause a significant hit to performance.\n */\nexport class NKeyMap<TValue, TKeys extends (string | boolean | number)[]> {\n\tprivate _data: Map<any, any> = new Map();\n\n\t/**\n\t * Sets a value on the map. Note that unlike a standard `Map`, the first argument is the value.\n\t * This is because the spread operator is used for the keys and must be last..\n\t * @param value The value to set.\n\t * @param keys The keys for the value.\n\t */\n\tpublic set(value: TValue, ...keys: [...TKeys]): void {\n\t\tlet currentMap = this._data;\n\t\tfor (let i = 0; i < keys.length - 1; i++) {\n\t\t\tlet nextMap = currentMap.get(keys[i]);\n\t\t\tif (nextMap === undefined) {\n\t\t\t\tnextMap = new Map();\n\t\t\t\tcurrentMap.set(keys[i], nextMap);\n\t\t\t}\n\t\t\tcurrentMap = nextMap;\n\t\t}\n\t\tcurrentMap.set(keys[keys.length - 1], value);\n\t}\n\n\tpublic get(...keys: [...TKeys]): TValue | undefined {\n\t\tlet currentMap = this._data;\n\t\tfor (let i = 0; i < keys.length - 1; i++) {\n\t\t\tconst nextMap = currentMap.get(keys[i]);\n\t\t\tif (nextMap === undefined) {\n\t\t\t\treturn undefined;\n\t\t\t}\n\t\t\tcurrentMap = nextMap;\n\t\t}\n\t\treturn currentMap.get(keys[keys.length - 1]);\n\t}\n\n\tpublic clear(): void {\n\t\tthis._data.clear();\n\t}\n\n\tpublic *values(): IterableIterator<TValue> {\n\t\tfunction* iterate(map: Map<any, any>): IterableIterator<TValue> {\n\t\t\tfor (const value of map.values()) {\n\t\t\t\tif (value instanceof Map) {\n\t\t\t\t\tyield* iterate(value);\n\t\t\t\t} else {\n\t\t\t\t\tyield value;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tyield* iterate(this._data);\n\t}\n\n\t/**\n\t * Get a textual representation of the map for debugging purposes.\n\t */\n\tpublic toString(): string {\n\t\tconst printMap = (map: Map<any, any>, depth: number): string => {\n\t\t\tlet result = '';\n\t\t\tfor (const [key, value] of map) {\n\t\t\t\tresult += `${'  '.repeat(depth)}${key}: `;\n\t\t\t\tif (value instanceof Map) {\n\t\t\t\t\tresult += '\\n' + printMap(value, depth + 1);\n\t\t\t\t} else {\n\t\t\t\t\tresult += `${value}\\n`;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\t\t};\n\n\t\treturn printMap(this._data, 0);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n/**\n * Given a function, returns a function that is only calling that function once.\n */\nexport function createSingleCallFunction<T extends Function>(this: unknown, fn: T, fnDidRunCallback?: () => void): T {\n\tconst _this = this;\n\tlet didCall = false;\n\tlet result: unknown;\n\n\treturn function () {\n\t\tif (didCall) {\n\t\t\treturn result;\n\t\t}\n\n\t\tdidCall = true;\n\t\tif (fnDidRunCallback) {\n\t\t\ttry {\n\t\t\t\tresult = fn.apply(_this, arguments);\n\t\t\t} finally {\n\t\t\t\tfnDidRunCallback();\n\t\t\t}\n\t\t} else {\n\t\t\tresult = fn.apply(_this, arguments);\n\t\t}\n\n\t\treturn result;\n\t} as unknown as T;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { BugIndicatingError, onUnexpectedError } from './errors.js';\n\n/**\n * Throws an error with the provided message if the provided value does not evaluate to a true Javascript value.\n *\n * @deprecated Use `assert(...)` instead.\n * This method is usually used like this:\n * ```ts\n * import * as assert from 'vs/base/common/assert';\n * assert.ok(...);\n * ```\n *\n * However, `assert` in that example is a user chosen name.\n * There is no tooling for generating such an import statement.\n * Thus, the `assert(...)` function should be used instead.\n */\nexport function ok(value?: unknown, message?: string) {\n\tif (!value) {\n\t\tthrow new Error(message ? `Assertion failed (${message})` : 'Assertion Failed');\n\t}\n}\n\nexport function assertNever(value: never, message = 'Unreachable'): never {\n\tthrow new Error(message);\n}\n\nexport function softAssertNever(value: never): void {\n\t// no-op\n}\n\n/**\n * Asserts that a condition is `truthy`.\n *\n * @throws provided {@linkcode messageOrError} if the {@linkcode condition} is `falsy`.\n *\n * @param condition The condition to assert.\n * @param messageOrError An error message or error object to throw if condition is `falsy`.\n */\nexport function assert(\n\tcondition: boolean,\n\tmessageOrError: string | Error = 'unexpected state',\n): asserts condition {\n\tif (!condition) {\n\t\t// if error instance is provided, use it, otherwise create a new one\n\t\tconst errorToThrow = typeof messageOrError === 'string'\n\t\t\t? new BugIndicatingError(`Assertion Failed: ${messageOrError}`)\n\t\t\t: messageOrError;\n\n\t\tthrow errorToThrow;\n\t}\n}\n\n/**\n * Like assert, but doesn't throw.\n */\nexport function softAssert(condition: boolean, message = 'Soft Assertion Failed'): void {\n\tif (!condition) {\n\t\tonUnexpectedError(new BugIndicatingError(message));\n\t}\n}\n\n/**\n * condition must be side-effect free!\n */\nexport function assertFn(condition: () => boolean): void {\n\tif (!condition()) {\n\t\t// eslint-disable-next-line no-debugger\n\t\tdebugger;\n\t\t// Reevaluate `condition` again to make debugging easier\n\t\tcondition();\n\t\tonUnexpectedError(new BugIndicatingError('Assertion Failed'));\n\t}\n}\n\nexport function checkAdjacentItems<T>(items: readonly T[], predicate: (item1: T, item2: T) => boolean): boolean {\n\tlet i = 0;\n\twhile (i < items.length - 1) {\n\t\tconst a = items[i];\n\t\tconst b = items[i + 1];\n\t\tif (!predicate(a, b)) {\n\t\t\treturn false;\n\t\t}\n\t\ti++;\n\t}\n\treturn true;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { assert } from './assert.js';\n\n/**\n * @returns whether the provided parameter is a JavaScript String or not.\n */\nexport function isString(str: unknown): str is string {\n\treturn (typeof str === 'string');\n}\n\n/**\n * @returns whether the provided parameter is a JavaScript Array and each element in the array is a string.\n */\nexport function isStringArray(value: unknown): value is string[] {\n\treturn isArrayOf(value, isString);\n}\n\n/**\n * @returns whether the provided parameter is a JavaScript Array and each element in the array satisfies the provided type guard.\n */\nexport function isArrayOf<T>(value: unknown, check: (item: unknown) => item is T): value is T[] {\n\treturn Array.isArray(value) && value.every(check);\n}\n\n/**\n * @returns whether the provided parameter is of type `object` but **not**\n *\t`null`, an `array`, a `regexp`, nor a `date`.\n */\nexport function isObject(obj: unknown): obj is Object {\n\t// The method can't do a type cast since there are type (like strings) which\n\t// are subclasses of any put not positvely matched by the function. Hence type\n\t// narrowing results in wrong results.\n\treturn typeof obj === 'object'\n\t\t&& obj !== null\n\t\t&& !Array.isArray(obj)\n\t\t&& !(obj instanceof RegExp)\n\t\t&& !(obj instanceof Date);\n}\n\n/**\n * @returns whether the provided parameter is of type `Buffer` or Uint8Array dervived type\n */\nexport function isTypedArray(obj: unknown): obj is Object {\n\tconst TypedArray = Object.getPrototypeOf(Uint8Array);\n\treturn typeof obj === 'object'\n\t\t&& obj instanceof TypedArray;\n}\n\n/**\n * In **contrast** to just checking `typeof` this will return `false` for `NaN`.\n * @returns whether the provided parameter is a JavaScript Number or not.\n */\nexport function isNumber(obj: unknown): obj is number {\n\treturn (typeof obj === 'number' && !isNaN(obj));\n}\n\n/**\n * @returns whether the provided parameter is an Iterable, casting to the given generic\n */\nexport function isIterable<T>(obj: unknown): obj is Iterable<T> {\n\t// eslint-disable-next-line local/code-no-any-casts\n\treturn !!obj && typeof (obj as any)[Symbol.iterator] === 'function';\n}\n\n/**\n * @returns whether the provided parameter is an Iterable, casting to the given generic\n */\nexport function isAsyncIterable<T>(obj: unknown): obj is AsyncIterable<T> {\n\t// eslint-disable-next-line local/code-no-any-casts\n\treturn !!obj && typeof (obj as any)[Symbol.asyncIterator] === 'function';\n}\n\n/**\n * @returns whether the provided parameter is a JavaScript Boolean or not.\n */\nexport function isBoolean(obj: unknown): obj is boolean {\n\treturn (obj === true || obj === false);\n}\n\n/**\n * @returns whether the provided parameter is undefined.\n */\nexport function isUndefined(obj: unknown): obj is undefined {\n\treturn (typeof obj === 'undefined');\n}\n\n/**\n * @returns whether the provided parameter is defined.\n */\nexport function isDefined<T>(arg: T | null | undefined): arg is T {\n\treturn !isUndefinedOrNull(arg);\n}\n\n/**\n * @returns whether the provided parameter is undefined or null.\n */\nexport function isUndefinedOrNull(obj: unknown): obj is undefined | null {\n\treturn (isUndefined(obj) || obj === null);\n}\n\n\nexport function assertType(condition: unknown, type?: string): asserts condition {\n\tif (!condition) {\n\t\tthrow new Error(type ? `Unexpected type, expected '${type}'` : 'Unexpected type');\n\t}\n}\n\n/**\n * Asserts that the argument passed in is neither undefined nor null.\n *\n * @see {@link assertDefined} for a similar utility that leverages TS assertion functions to narrow down the type of `arg` to be non-nullable.\n */\nexport function assertReturnsDefined<T>(arg: T | null | undefined): NonNullable<T> {\n\tassert(\n\t\targ !== null && arg !== undefined,\n\t\t'Argument is `undefined` or `null`.',\n\t);\n\n\treturn arg;\n}\n\n/**\n * Asserts that a provided `value` is `defined` - not `null` or `undefined`,\n * throwing an error with the provided error or error message, while also\n * narrowing down the type of the `value` to be `NonNullable` using TS\n * assertion functions.\n *\n * @throws if the provided `value` is `null` or `undefined`.\n *\n * ## Examples\n *\n * ```typescript\n * // an assert with an error message\n * assertDefined('some value', 'String constant is not defined o_O.');\n *\n * // `throws!` the provided error\n * assertDefined(null, new Error('Should throw this error.'));\n *\n * // narrows down the type of `someValue` to be non-nullable\n * const someValue: string | undefined | null = blackbox();\n * assertDefined(someValue, 'Some value must be defined.');\n * console.log(someValue.length); // now type of `someValue` is `string`\n * ```\n *\n * @see {@link assertReturnsDefined} for a similar utility but without assertion.\n * @see {@link https://www.typescriptlang.org/docs/handbook/release-notes/typescript-3-7.html#assertion-functions typescript-3-7.html#assertion-functions}\n */\nexport function assertDefined<T>(value: T, error: string | NonNullable<Error>): asserts value is NonNullable<T> {\n\tif (value === null || value === undefined) {\n\t\tconst errorToThrow = typeof error === 'string' ? new Error(error) : error;\n\n\t\tthrow errorToThrow;\n\t}\n}\n\n/**\n * Asserts that each argument passed in is neither undefined nor null.\n */\nexport function assertReturnsAllDefined<T1, T2>(t1: T1 | null | undefined, t2: T2 | null | undefined): [T1, T2];\nexport function assertReturnsAllDefined<T1, T2, T3>(t1: T1 | null | undefined, t2: T2 | null | undefined, t3: T3 | null | undefined): [T1, T2, T3];\nexport function assertReturnsAllDefined<T1, T2, T3, T4>(t1: T1 | null | undefined, t2: T2 | null | undefined, t3: T3 | null | undefined, t4: T4 | null | undefined): [T1, T2, T3, T4];\nexport function assertReturnsAllDefined(...args: (unknown | null | undefined)[]): unknown[] {\n\tconst result = [];\n\n\tfor (let i = 0; i < args.length; i++) {\n\t\tconst arg = args[i];\n\n\t\tif (isUndefinedOrNull(arg)) {\n\t\t\tthrow new Error(`Assertion Failed: argument at index ${i} is undefined or null`);\n\t\t}\n\n\t\tresult.push(arg);\n\t}\n\n\treturn result;\n}\n\n/**\n * Checks if the provided value is one of the vales in the provided list.\n *\n * ## Examples\n *\n * ```typescript\n * // note! item type is a `subset of string`\n * type TItem = ':' | '.' | '/';\n *\n * // note! item is type of `string` here\n * const item: string = ':';\n * // list of the items to check against\n * const list: TItem[] = [':', '.'];\n *\n * // ok\n * assert(\n *   isOneOf(item, list),\n *   'Must succeed.',\n * );\n *\n * // `item` is of `TItem` type now\n * ```\n */\nexport const isOneOf = <TType, TSubtype extends TType>(\n\tvalue: TType,\n\tvalidValues: readonly TSubtype[],\n): value is TSubtype => {\n\t// note! it is OK to type cast here, because we rely on the includes\n\t//       utility to check if the value is present in the provided list\n\treturn validValues.includes(<TSubtype>value);\n};\n\n/**\n * Compile-time type check of a variable.\n */\nexport function typeCheck<T = never>(_thing: NoInfer<T>): void { }\n\nconst hasOwnProperty = Object.prototype.hasOwnProperty;\n\n/**\n * @returns whether the provided parameter is an empty JavaScript Object or not.\n */\nexport function isEmptyObject(obj: unknown): obj is object {\n\tif (!isObject(obj)) {\n\t\treturn false;\n\t}\n\n\tfor (const key in obj) {\n\t\tif (hasOwnProperty.call(obj, key)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\n\n/**\n * @returns whether the provided parameter is a JavaScript Function or not.\n */\nexport function isFunction(obj: unknown): obj is Function {\n\treturn (typeof obj === 'function');\n}\n\n/**\n * @returns whether the provided parameters is are JavaScript Function or not.\n */\nexport function areFunctions(...objects: unknown[]): boolean {\n\treturn objects.length > 0 && objects.every(isFunction);\n}\n\nexport type TypeConstraint = string | Function;\n\nexport function validateConstraints(args: unknown[], constraints: Array<TypeConstraint | undefined>): void {\n\tconst len = Math.min(args.length, constraints.length);\n\tfor (let i = 0; i < len; i++) {\n\t\tvalidateConstraint(args[i], constraints[i]);\n\t}\n}\n\nexport function validateConstraint(arg: unknown, constraint: TypeConstraint | undefined): void {\n\n\tif (isString(constraint)) {\n\t\tif (typeof arg !== constraint) {\n\t\t\tthrow new Error(`argument does not match constraint: typeof ${constraint}`);\n\t\t}\n\t} else if (isFunction(constraint)) {\n\t\ttry {\n\t\t\tif (arg instanceof constraint) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\tif (!isUndefinedOrNull(arg) && (arg as any).constructor === constraint) {\n\t\t\treturn;\n\t\t}\n\t\tif (constraint.length === 1 && constraint.call(undefined, arg) === true) {\n\t\t\treturn;\n\t\t}\n\t\tthrow new Error(`argument does not match one of these constraints: arg instanceof constraint, arg.constructor === constraint, nor constraint(arg) === true`);\n\t}\n}\n\n/**\n * Helper type assertion that safely upcasts a type to a supertype.\n *\n * This can be used to make sure the argument correctly conforms to the subtype while still being able to pass it\n * to contexts that expects the supertype.\n */\nexport function upcast<Base, Sub extends Base = Base>(x: Sub): Base {\n\treturn x;\n}\n\ntype AddFirstParameterToFunction<T, TargetFunctionsReturnType, FirstParameter> = T extends (...args: any[]) => TargetFunctionsReturnType ?\n\t// Function: add param to function\n\t(firstArg: FirstParameter, ...args: Parameters<T>) => ReturnType<T> :\n\n\t// Else: just leave as is\n\tT;\n\n/**\n * Allows to add a first parameter to functions of a type.\n */\nexport type AddFirstParameterToFunctions<Target, TargetFunctionsReturnType, FirstParameter> = {\n\t// For every property\n\t[K in keyof Target]: AddFirstParameterToFunction<Target[K], TargetFunctionsReturnType, FirstParameter>;\n};\n\n/**\n * Given an object with all optional properties, requires at least one to be defined.\n * i.e. AtLeastOne<MyObject>;\n */\nexport type AtLeastOne<T, U = { [K in keyof T]: Pick<T, K> }> = Partial<T> & U[keyof U];\n\n/**\n * Only picks the non-optional properties of a type.\n */\nexport type OmitOptional<T> = { [K in keyof T as T[K] extends Required<T>[K] ? K : never]: T[K] };\n\n/**\n * A type that removed readonly-less from all properties of `T`\n */\nexport type Mutable<T> = {\n\t-readonly [P in keyof T]: T[P]\n};\n\n/**\n * A type that adds readonly to all properties of T, recursively.\n */\nexport type DeepImmutable<T> = T extends (infer U)[]\n\t? ReadonlyArray<DeepImmutable<U>>\n\t: T extends ReadonlyArray<infer U>\n\t? ReadonlyArray<DeepImmutable<U>>\n\t: T extends Map<infer K, infer V>\n\t? ReadonlyMap<K, DeepImmutable<V>>\n\t: T extends Set<infer U>\n\t? ReadonlySet<DeepImmutable<U>>\n\t: T extends object\n\t? {\n\t\treadonly [K in keyof T]: DeepImmutable<T[K]>;\n\t}\n\t: T;\n\n/**\n * A single object or an array of the objects.\n */\nexport type SingleOrMany<T> = T | T[];\n\n/**\n * Given a `type X = { foo?: string }` checking that an object `satisfies X`\n * will ensure each property was explicitly defined, ensuring no properties\n * are omitted or forgotten.\n */\nexport type WithDefinedProps<T> = { [K in keyof Required<T>]: T[K] };\n\n\n/**\n * A type that recursively makes all properties of `T` required\n */\nexport type DeepRequiredNonNullable<T> = {\n\t[P in keyof T]-?: T[P] extends object ? DeepRequiredNonNullable<T[P]> : Required<NonNullable<T[P]>>;\n};\n\n\n/**\n * Represents a type that is a partial version of a given type `T`, where all properties are optional and can be deeply nested.\n */\nexport type DeepPartial<T> = {\n\t[P in keyof T]?: T[P] extends object ? DeepPartial<T[P]> : Partial<T[P]>;\n};\n\n/**\n * Represents a type that is a partial version of a given type `T`, except a subset.\n */\nexport type PartialExcept<T, K extends keyof T> = Partial<Omit<T, K>> & Pick<T, K>;\n\n\ntype KeysOfUnionType<T> = T extends T ? keyof T : never;\ntype FilterType<T, TTest> = T extends TTest ? T : never;\ntype MakeOptionalAndTrue<T extends object> = { [K in keyof T]?: true };\n\n/**\n * Type guard that checks if an object has specific keys and narrows the type accordingly.\n *\n * @param x - The object to check\n * @param key - An object with boolean values indicating which keys to check for\n * @returns true if all specified keys exist in the object, false otherwise\n *\n * @example\n * ```typescript\n * type A = { a: string };\n * type B = { b: number };\n * const obj: A | B = getObject();\n *\n * if (hasKey(obj, { a: true })) {\n *   // obj is now narrowed to type A\n *   console.log(obj.a);\n * }\n * ```\n */\nexport function hasKey<T extends object, TKeys extends MakeOptionalAndTrue<T>>(x: T, key: TKeys): x is FilterType<T, { [K in KeysOfUnionType<T> & keyof TKeys]: unknown }> {\n\tfor (const k in key) {\n\t\tif (!(k in x)) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { isIterable } from './types.js';\n\nexport namespace Iterable {\n\n\texport function is<T = unknown>(thing: unknown): thing is Iterable<T> {\n\t\treturn !!thing && typeof thing === 'object' && typeof (thing as Iterable<T>)[Symbol.iterator] === 'function';\n\t}\n\n\tconst _empty: Iterable<never> = Object.freeze([]);\n\texport function empty<T = never>(): readonly never[] {\n\t\treturn _empty as readonly never[];\n\t}\n\n\texport function* single<T>(element: T): Iterable<T> {\n\t\tyield element;\n\t}\n\n\texport function wrap<T>(iterableOrElement: Iterable<T> | T): Iterable<T> {\n\t\tif (is(iterableOrElement)) {\n\t\t\treturn iterableOrElement;\n\t\t} else {\n\t\t\treturn single(iterableOrElement);\n\t\t}\n\t}\n\n\texport function from<T>(iterable: Iterable<T> | undefined | null): Iterable<T> {\n\t\treturn iterable ?? (_empty as Iterable<T>);\n\t}\n\n\texport function* reverse<T>(array: ReadonlyArray<T>): Iterable<T> {\n\t\tfor (let i = array.length - 1; i >= 0; i--) {\n\t\t\tyield array[i];\n\t\t}\n\t}\n\n\texport function isEmpty<T>(iterable: Iterable<T> | undefined | null): boolean {\n\t\treturn !iterable || iterable[Symbol.iterator]().next().done === true;\n\t}\n\n\texport function first<T>(iterable: Iterable<T>): T | undefined {\n\t\treturn iterable[Symbol.iterator]().next().value;\n\t}\n\n\texport function some<T>(iterable: Iterable<T>, predicate: (t: T, i: number) => unknown): boolean {\n\t\tlet i = 0;\n\t\tfor (const element of iterable) {\n\t\t\tif (predicate(element, i++)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\texport function every<T>(iterable: Iterable<T>, predicate: (t: T, i: number) => unknown): boolean {\n\t\tlet i = 0;\n\t\tfor (const element of iterable) {\n\t\t\tif (!predicate(element, i++)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\texport function find<T, R extends T>(iterable: Iterable<T>, predicate: (t: T) => t is R): R | undefined;\n\texport function find<T>(iterable: Iterable<T>, predicate: (t: T) => boolean): T | undefined;\n\texport function find<T>(iterable: Iterable<T>, predicate: (t: T) => boolean): T | undefined {\n\t\tfor (const element of iterable) {\n\t\t\tif (predicate(element)) {\n\t\t\t\treturn element;\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\texport function filter<T, R extends T>(iterable: Iterable<T>, predicate: (t: T) => t is R): Iterable<R>;\n\texport function filter<T>(iterable: Iterable<T>, predicate: (t: T) => boolean): Iterable<T>;\n\texport function* filter<T>(iterable: Iterable<T>, predicate: (t: T) => boolean): Iterable<T> {\n\t\tfor (const element of iterable) {\n\t\t\tif (predicate(element)) {\n\t\t\t\tyield element;\n\t\t\t}\n\t\t}\n\t}\n\n\texport function* map<T, R>(iterable: Iterable<T>, fn: (t: T, index: number) => R): Iterable<R> {\n\t\tlet index = 0;\n\t\tfor (const element of iterable) {\n\t\t\tyield fn(element, index++);\n\t\t}\n\t}\n\n\texport function* flatMap<T, R>(iterable: Iterable<T>, fn: (t: T, index: number) => Iterable<R>): Iterable<R> {\n\t\tlet index = 0;\n\t\tfor (const element of iterable) {\n\t\t\tyield* fn(element, index++);\n\t\t}\n\t}\n\n\texport function* concat<T>(...iterables: (Iterable<T> | T)[]): Iterable<T> {\n\t\tfor (const item of iterables) {\n\t\t\tif (isIterable(item)) {\n\t\t\t\tyield* item;\n\t\t\t} else {\n\t\t\t\tyield item;\n\t\t\t}\n\t\t}\n\t}\n\n\texport function reduce<T, R>(iterable: Iterable<T>, reducer: (previousValue: R, currentValue: T) => R, initialValue: R): R {\n\t\tlet value = initialValue;\n\t\tfor (const element of iterable) {\n\t\t\tvalue = reducer(value, element);\n\t\t}\n\t\treturn value;\n\t}\n\n\texport function length<T>(iterable: Iterable<T>): number {\n\t\tlet count = 0;\n\t\tfor (const _ of iterable) {\n\t\t\tcount++;\n\t\t}\n\t\treturn count;\n\t}\n\n\t/**\n\t * Returns an iterable slice of the array, with the same semantics as `array.slice()`.\n\t */\n\texport function* slice<T>(arr: ReadonlyArray<T>, from: number, to = arr.length): Iterable<T> {\n\t\tif (from < -arr.length) {\n\t\t\tfrom = 0;\n\t\t}\n\t\tif (from < 0) {\n\t\t\tfrom += arr.length;\n\t\t}\n\n\t\tif (to < 0) {\n\t\t\tto += arr.length;\n\t\t} else if (to > arr.length) {\n\t\t\tto = arr.length;\n\t\t}\n\n\t\tfor (; from < to; from++) {\n\t\t\tyield arr[from];\n\t\t}\n\t}\n\n\t/**\n\t * Consumes `atMost` elements from iterable and returns the consumed elements,\n\t * and an iterable for the rest of the elements.\n\t */\n\texport function consume<T>(iterable: Iterable<T>, atMost: number = Number.POSITIVE_INFINITY): [T[], Iterable<T>] {\n\t\tconst consumed: T[] = [];\n\n\t\tif (atMost === 0) {\n\t\t\treturn [consumed, iterable];\n\t\t}\n\n\t\tconst iterator = iterable[Symbol.iterator]();\n\n\t\tfor (let i = 0; i < atMost; i++) {\n\t\t\tconst next = iterator.next();\n\n\t\t\tif (next.done) {\n\t\t\t\treturn [consumed, Iterable.empty()];\n\t\t\t}\n\n\t\t\tconsumed.push(next.value);\n\t\t}\n\n\t\treturn [consumed, { [Symbol.iterator]() { return iterator; } }];\n\t}\n\n\texport async function asyncToArray<T>(iterable: AsyncIterable<T>): Promise<T[]> {\n\t\tconst result: T[] = [];\n\t\tfor await (const item of iterable) {\n\t\t\tresult.push(item);\n\t\t}\n\t\treturn result;\n\t}\n\n\texport async function asyncToArrayFlat<T>(iterable: AsyncIterable<T[]>): Promise<T[]> {\n\t\tlet result: T[] = [];\n\t\tfor await (const item of iterable) {\n\t\t\tresult = result.concat(item);\n\t\t}\n\t\treturn result;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { compareBy, numberComparator } from './arrays.js';\nimport { groupBy } from './collections.js';\nimport { SetMap, ResourceMap } from './map.js';\nimport { URI } from './uri.js';\nimport { createSingleCallFunction } from './functional.js';\nimport { Iterable } from './iterator.js';\nimport { BugIndicatingError, onUnexpectedError } from './errors.js';\n\n// #region Disposable Tracking\n\n/**\n * Enables logging of potentially leaked disposables.\n *\n * A disposable is considered leaked if it is not disposed or not registered as the child of\n * another disposable. This tracking is very simple an only works for classes that either\n * extend Disposable or use a DisposableStore. This means there are a lot of false positives.\n */\nconst TRACK_DISPOSABLES = false;\nlet disposableTracker: IDisposableTracker | null = null;\n\nexport interface IDisposableTracker {\n\t/**\n\t * Is called on construction of a disposable.\n\t*/\n\ttrackDisposable(disposable: IDisposable): void;\n\n\t/**\n\t * Is called when a disposable is registered as child of another disposable (e.g. {@link DisposableStore}).\n\t * If parent is `null`, the disposable is removed from its former parent.\n\t*/\n\tsetParent(child: IDisposable, parent: IDisposable | null): void;\n\n\t/**\n\t * Is called after a disposable is disposed.\n\t*/\n\tmarkAsDisposed(disposable: IDisposable): void;\n\n\t/**\n\t * Indicates that the given object is a singleton which does not need to be disposed.\n\t*/\n\tmarkAsSingleton(disposable: IDisposable): void;\n}\n\nexport class GCBasedDisposableTracker implements IDisposableTracker {\n\n\tprivate readonly _registry = new FinalizationRegistry<string>(heldValue => {\n\t\tconsole.warn(`[LEAKED DISPOSABLE] ${heldValue}`);\n\t});\n\n\ttrackDisposable(disposable: IDisposable): void {\n\t\tconst stack = new Error('CREATED via:').stack!;\n\t\tthis._registry.register(disposable, stack, disposable);\n\t}\n\n\tsetParent(child: IDisposable, parent: IDisposable | null): void {\n\t\tif (parent) {\n\t\t\tthis._registry.unregister(child);\n\t\t} else {\n\t\t\tthis.trackDisposable(child);\n\t\t}\n\t}\n\n\tmarkAsDisposed(disposable: IDisposable): void {\n\t\tthis._registry.unregister(disposable);\n\t}\n\n\tmarkAsSingleton(disposable: IDisposable): void {\n\t\tthis._registry.unregister(disposable);\n\t}\n}\n\nexport interface DisposableInfo {\n\tvalue: IDisposable;\n\tsource: string | null;\n\tparent: IDisposable | null;\n\tisSingleton: boolean;\n\tidx: number;\n}\n\nexport class DisposableTracker implements IDisposableTracker {\n\tprivate static idx = 0;\n\n\tprivate readonly livingDisposables = new Map<IDisposable, DisposableInfo>();\n\n\tprivate getDisposableData(d: IDisposable): DisposableInfo {\n\t\tlet val = this.livingDisposables.get(d);\n\t\tif (!val) {\n\t\t\tval = { parent: null, source: null, isSingleton: false, value: d, idx: DisposableTracker.idx++ };\n\t\t\tthis.livingDisposables.set(d, val);\n\t\t}\n\t\treturn val;\n\t}\n\n\ttrackDisposable(d: IDisposable): void {\n\t\tconst data = this.getDisposableData(d);\n\t\tif (!data.source) {\n\t\t\tdata.source =\n\t\t\t\tnew Error().stack!;\n\t\t}\n\t}\n\n\tsetParent(child: IDisposable, parent: IDisposable | null): void {\n\t\tconst data = this.getDisposableData(child);\n\t\tdata.parent = parent;\n\t}\n\n\tmarkAsDisposed(x: IDisposable): void {\n\t\tthis.livingDisposables.delete(x);\n\t}\n\n\tmarkAsSingleton(disposable: IDisposable): void {\n\t\tthis.getDisposableData(disposable).isSingleton = true;\n\t}\n\n\tprivate getRootParent(data: DisposableInfo, cache: Map<DisposableInfo, DisposableInfo>): DisposableInfo {\n\t\tconst cacheValue = cache.get(data);\n\t\tif (cacheValue) {\n\t\t\treturn cacheValue;\n\t\t}\n\n\t\tconst result = data.parent ? this.getRootParent(this.getDisposableData(data.parent), cache) : data;\n\t\tcache.set(data, result);\n\t\treturn result;\n\t}\n\n\tgetTrackedDisposables(): IDisposable[] {\n\t\tconst rootParentCache = new Map<DisposableInfo, DisposableInfo>();\n\n\t\tconst leaking = [...this.livingDisposables.entries()]\n\t\t\t.filter(([, v]) => v.source !== null && !this.getRootParent(v, rootParentCache).isSingleton)\n\t\t\t.flatMap(([k]) => k);\n\n\t\treturn leaking;\n\t}\n\n\tcomputeLeakingDisposables(maxReported = 10, preComputedLeaks?: DisposableInfo[]): { leaks: DisposableInfo[]; details: string } | undefined {\n\t\tlet uncoveredLeakingObjs: DisposableInfo[] | undefined;\n\t\tif (preComputedLeaks) {\n\t\t\tuncoveredLeakingObjs = preComputedLeaks;\n\t\t} else {\n\t\t\tconst rootParentCache = new Map<DisposableInfo, DisposableInfo>();\n\n\t\t\tconst leakingObjects = [...this.livingDisposables.values()]\n\t\t\t\t.filter((info) => info.source !== null && !this.getRootParent(info, rootParentCache).isSingleton);\n\n\t\t\tif (leakingObjects.length === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst leakingObjsSet = new Set(leakingObjects.map(o => o.value));\n\n\t\t\t// Remove all objects that are a child of other leaking objects. Assumes there are no cycles.\n\t\t\tuncoveredLeakingObjs = leakingObjects.filter(l => {\n\t\t\t\treturn !(l.parent && leakingObjsSet.has(l.parent));\n\t\t\t});\n\n\t\t\tif (uncoveredLeakingObjs.length === 0) {\n\t\t\t\tthrow new Error('There are cyclic diposable chains!');\n\t\t\t}\n\t\t}\n\n\t\tif (!uncoveredLeakingObjs) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tfunction getStackTracePath(leaking: DisposableInfo): string[] {\n\t\t\tfunction removePrefix(array: string[], linesToRemove: (string | RegExp)[]) {\n\t\t\t\twhile (array.length > 0 && linesToRemove.some(regexp => typeof regexp === 'string' ? regexp === array[0] : array[0].match(regexp))) {\n\t\t\t\t\tarray.shift();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst lines = leaking.source!.split('\\n').map(p => p.trim().replace('at ', '')).filter(l => l !== '');\n\t\t\tremovePrefix(lines, ['Error', /^trackDisposable \\(.*\\)$/, /^DisposableTracker.trackDisposable \\(.*\\)$/]);\n\t\t\treturn lines.reverse();\n\t\t}\n\n\t\tconst stackTraceStarts = new SetMap<string, DisposableInfo>();\n\t\tfor (const leaking of uncoveredLeakingObjs) {\n\t\t\tconst stackTracePath = getStackTracePath(leaking);\n\t\t\tfor (let i = 0; i <= stackTracePath.length; i++) {\n\t\t\t\tstackTraceStarts.add(stackTracePath.slice(0, i).join('\\n'), leaking);\n\t\t\t}\n\t\t}\n\n\t\t// Put earlier leaks first\n\t\tuncoveredLeakingObjs.sort(compareBy(l => l.idx, numberComparator));\n\n\t\tlet message = '';\n\n\t\tlet i = 0;\n\t\tfor (const leaking of uncoveredLeakingObjs.slice(0, maxReported)) {\n\t\t\ti++;\n\t\t\tconst stackTracePath = getStackTracePath(leaking);\n\t\t\tconst stackTraceFormattedLines = [];\n\n\t\t\tfor (let i = 0; i < stackTracePath.length; i++) {\n\t\t\t\tlet line = stackTracePath[i];\n\t\t\t\tconst starts = stackTraceStarts.get(stackTracePath.slice(0, i + 1).join('\\n'));\n\t\t\t\tline = `(shared with ${starts.size}/${uncoveredLeakingObjs.length} leaks) at ${line}`;\n\n\t\t\t\tconst prevStarts = stackTraceStarts.get(stackTracePath.slice(0, i).join('\\n'));\n\t\t\t\tconst continuations = groupBy([...prevStarts].map(d => getStackTracePath(d)[i]), v => v);\n\t\t\t\tdelete continuations[stackTracePath[i]];\n\t\t\t\tfor (const [cont, set] of Object.entries(continuations)) {\n\t\t\t\t\tif (set) {\n\t\t\t\t\t\tstackTraceFormattedLines.unshift(`    - stacktraces of ${set.length} other leaks continue with ${cont}`);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tstackTraceFormattedLines.unshift(line);\n\t\t\t}\n\n\t\t\tmessage += `\\n\\n\\n==================== Leaking disposable ${i}/${uncoveredLeakingObjs.length}: ${leaking.value.constructor.name} ====================\\n${stackTraceFormattedLines.join('\\n')}\\n============================================================\\n\\n`;\n\t\t}\n\n\t\tif (uncoveredLeakingObjs.length > maxReported) {\n\t\t\tmessage += `\\n\\n\\n... and ${uncoveredLeakingObjs.length - maxReported} more leaking disposables\\n\\n`;\n\t\t}\n\n\t\treturn { leaks: uncoveredLeakingObjs, details: message };\n\t}\n}\n\nexport function setDisposableTracker(tracker: IDisposableTracker | null): void {\n\tdisposableTracker = tracker;\n}\n\nif (TRACK_DISPOSABLES) {\n\tconst __is_disposable_tracked__ = '__is_disposable_tracked__';\n\tsetDisposableTracker(new class implements IDisposableTracker {\n\t\ttrackDisposable(x: IDisposable): void {\n\t\t\tconst stack = new Error('Potentially leaked disposable').stack!;\n\t\t\tsetTimeout(() => {\n\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\tif (!(x as any)[__is_disposable_tracked__]) {\n\t\t\t\t\tconsole.log(stack);\n\t\t\t\t}\n\t\t\t}, 3000);\n\t\t}\n\n\t\tsetParent(child: IDisposable, parent: IDisposable | null): void {\n\t\t\tif (child && child !== Disposable.None) {\n\t\t\t\ttry {\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\t(child as any)[__is_disposable_tracked__] = true;\n\t\t\t\t} catch {\n\t\t\t\t\t// noop\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tmarkAsDisposed(disposable: IDisposable): void {\n\t\t\tif (disposable && disposable !== Disposable.None) {\n\t\t\t\ttry {\n\t\t\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\t\t\t(disposable as any)[__is_disposable_tracked__] = true;\n\t\t\t\t} catch {\n\t\t\t\t\t// noop\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tmarkAsSingleton(disposable: IDisposable): void { }\n\t});\n}\n\nexport function trackDisposable<T extends IDisposable>(x: T): T {\n\tdisposableTracker?.trackDisposable(x);\n\treturn x;\n}\n\nexport function markAsDisposed(disposable: IDisposable): void {\n\tdisposableTracker?.markAsDisposed(disposable);\n}\n\nfunction setParentOfDisposable(child: IDisposable, parent: IDisposable | null): void {\n\tdisposableTracker?.setParent(child, parent);\n}\n\nfunction setParentOfDisposables(children: IDisposable[], parent: IDisposable | null): void {\n\tif (!disposableTracker) {\n\t\treturn;\n\t}\n\tfor (const child of children) {\n\t\tdisposableTracker.setParent(child, parent);\n\t}\n}\n\n/**\n * Indicates that the given object is a singleton which does not need to be disposed.\n*/\nexport function markAsSingleton<T extends IDisposable>(singleton: T): T {\n\tdisposableTracker?.markAsSingleton(singleton);\n\treturn singleton;\n}\n\n// #endregion\n\n/**\n * An object that performs a cleanup operation when `.dispose()` is called.\n *\n * Some examples of how disposables are used:\n *\n * - An event listener that removes itself when `.dispose()` is called.\n * - A resource such as a file system watcher that cleans up the resource when `.dispose()` is called.\n * - The return value from registering a provider. When `.dispose()` is called, the provider is unregistered.\n */\nexport interface IDisposable {\n\tdispose(): void;\n}\n\n/**\n * Check if `thing` is {@link IDisposable disposable}.\n */\nexport function isDisposable<E>(thing: E): thing is E & IDisposable {\n\t// eslint-disable-next-line local/code-no-any-casts\n\treturn typeof thing === 'object' && thing !== null && typeof (<IDisposable><any>thing).dispose === 'function' && (<IDisposable><any>thing).dispose.length === 0;\n}\n\n/**\n * Disposes of the value(s) passed in.\n */\nexport function dispose<T extends IDisposable>(disposable: T): T;\nexport function dispose<T extends IDisposable>(disposable: T | undefined): T | undefined;\nexport function dispose<T extends IDisposable, A extends Iterable<T> = Iterable<T>>(disposables: A): A;\nexport function dispose<T extends IDisposable>(disposables: Array<T>): Array<T>;\nexport function dispose<T extends IDisposable>(disposables: ReadonlyArray<T>): ReadonlyArray<T>;\nexport function dispose<T extends IDisposable>(arg: T | Iterable<T> | undefined): any {\n\tif (Iterable.is(arg)) {\n\t\tconst errors: any[] = [];\n\n\t\tfor (const d of arg) {\n\t\t\tif (d) {\n\t\t\t\ttry {\n\t\t\t\t\td.dispose();\n\t\t\t\t} catch (e) {\n\t\t\t\t\terrors.push(e);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (errors.length === 1) {\n\t\t\tthrow errors[0];\n\t\t} else if (errors.length > 1) {\n\t\t\tthrow new AggregateError(errors, 'Encountered errors while disposing of store');\n\t\t}\n\n\t\treturn Array.isArray(arg) ? [] : arg;\n\t} else if (arg) {\n\t\targ.dispose();\n\t\treturn arg;\n\t}\n}\n\nexport function disposeIfDisposable<T extends IDisposable | object>(disposables: Array<T>): Array<T> {\n\tfor (const d of disposables) {\n\t\tif (isDisposable(d)) {\n\t\t\td.dispose();\n\t\t}\n\t}\n\treturn [];\n}\n\n/**\n * Combine multiple disposable values into a single {@link IDisposable}.\n */\nexport function combinedDisposable(...disposables: IDisposable[]): IDisposable {\n\tconst parent = toDisposable(() => dispose(disposables));\n\tsetParentOfDisposables(disposables, parent);\n\treturn parent;\n}\n\nclass FunctionDisposable implements IDisposable {\n\tprivate _isDisposed: boolean;\n\tprivate readonly _fn: () => void;\n\n\tconstructor(fn: () => void) {\n\t\tthis._isDisposed = false;\n\t\tthis._fn = fn;\n\t\ttrackDisposable(this);\n\t}\n\n\tdispose() {\n\t\tif (this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tif (!this._fn) {\n\t\t\tthrow new Error(`Unbound disposable context: Need to use an arrow function to preserve the value of this`);\n\t\t}\n\t\tthis._isDisposed = true;\n\t\tmarkAsDisposed(this);\n\t\tthis._fn();\n\t}\n}\n\n/**\n * Turn a function that implements dispose into an {@link IDisposable}.\n *\n * @param fn Clean up function, guaranteed to be called only **once**.\n */\nexport function toDisposable(fn: () => void): IDisposable {\n\treturn new FunctionDisposable(fn);\n}\n\n/**\n * Manages a collection of disposable values.\n *\n * This is the preferred way to manage multiple disposables. A `DisposableStore` is safer to work with than an\n * `IDisposable[]` as it considers edge cases, such as registering the same value multiple times or adding an item to a\n * store that has already been disposed of.\n */\nexport class DisposableStore implements IDisposable {\n\n\tstatic DISABLE_DISPOSED_WARNING = false;\n\n\tprivate readonly _toDispose = new Set<IDisposable>();\n\tprivate _isDisposed = false;\n\n\tconstructor() {\n\t\ttrackDisposable(this);\n\t}\n\n\t/**\n\t * Dispose of all registered disposables and mark this object as disposed.\n\t *\n\t * Any future disposables added to this object will be disposed of on `add`.\n\t */\n\tpublic dispose(): void {\n\t\tif (this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\n\t\tmarkAsDisposed(this);\n\t\tthis._isDisposed = true;\n\t\tthis.clear();\n\t}\n\n\t/**\n\t * @return `true` if this object has been disposed of.\n\t */\n\tpublic get isDisposed(): boolean {\n\t\treturn this._isDisposed;\n\t}\n\n\t/**\n\t * Dispose of all registered disposables but do not mark this object as disposed.\n\t */\n\tpublic clear(): void {\n\t\tif (this._toDispose.size === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tdispose(this._toDispose);\n\t\t} finally {\n\t\t\tthis._toDispose.clear();\n\t\t}\n\t}\n\n\t/**\n\t * Add a new {@link IDisposable disposable} to the collection.\n\t */\n\tpublic add<T extends IDisposable>(o: T): T {\n\t\tif (!o || o === Disposable.None) {\n\t\t\treturn o;\n\t\t}\n\t\tif ((o as unknown as DisposableStore) === this) {\n\t\t\tthrow new Error('Cannot register a disposable on itself!');\n\t\t}\n\n\t\tsetParentOfDisposable(o, this);\n\t\tif (this._isDisposed) {\n\t\t\tif (!DisposableStore.DISABLE_DISPOSED_WARNING) {\n\t\t\t\tconsole.warn(new Error('Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!').stack);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._toDispose.add(o);\n\t\t}\n\n\t\treturn o;\n\t}\n\n\t/**\n\t * Deletes a disposable from store and disposes of it. This will not throw or warn and proceed to dispose the\n\t * disposable even when the disposable is not part in the store.\n\t */\n\tpublic delete<T extends IDisposable>(o: T): void {\n\t\tif (!o) {\n\t\t\treturn;\n\t\t}\n\t\tif ((o as unknown as DisposableStore) === this) {\n\t\t\tthrow new Error('Cannot dispose a disposable on itself!');\n\t\t}\n\t\tthis._toDispose.delete(o);\n\t\to.dispose();\n\t}\n\n\t/**\n\t * Deletes the value from the store, but does not dispose it.\n\t */\n\tpublic deleteAndLeak<T extends IDisposable>(o: T): void {\n\t\tif (!o) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._toDispose.delete(o)) {\n\t\t\tsetParentOfDisposable(o, null);\n\t\t}\n\t}\n\n\tpublic assertNotDisposed(): void {\n\t\tif (this._isDisposed) {\n\t\t\tonUnexpectedError(new BugIndicatingError('Object disposed'));\n\t\t}\n\t}\n}\n\n/**\n * Abstract base class for a {@link IDisposable disposable} object.\n *\n * Subclasses can {@linkcode _register} disposables that will be automatically cleaned up when this object is disposed of.\n */\nexport abstract class Disposable implements IDisposable {\n\n\t/**\n\t * A disposable that does nothing when it is disposed of.\n\t *\n\t * TODO: This should not be a static property.\n\t */\n\tstatic readonly None = Object.freeze<IDisposable>({ dispose() { } });\n\n\tprotected readonly _store = new DisposableStore();\n\n\tconstructor() {\n\t\ttrackDisposable(this);\n\t\tsetParentOfDisposable(this._store, this);\n\t}\n\n\tpublic dispose(): void {\n\t\tmarkAsDisposed(this);\n\n\t\tthis._store.dispose();\n\t}\n\n\t/**\n\t * Adds `o` to the collection of disposables managed by this object.\n\t */\n\tprotected _register<T extends IDisposable>(o: T): T {\n\t\tif ((o as unknown as Disposable) === this) {\n\t\t\tthrow new Error('Cannot register a disposable on itself!');\n\t\t}\n\t\treturn this._store.add(o);\n\t}\n}\n\n/**\n * Manages the lifecycle of a disposable value that may be changed.\n *\n * This ensures that when the disposable value is changed, the previously held disposable is disposed of. You can\n * also register a `MutableDisposable` on a `Disposable` to ensure it is automatically cleaned up.\n */\nexport class MutableDisposable<T extends IDisposable> implements IDisposable {\n\tprivate _value?: T;\n\tprivate _isDisposed = false;\n\n\tconstructor() {\n\t\ttrackDisposable(this);\n\t}\n\n\t/**\n\t * Get the currently held disposable value, or `undefined` if this MutableDisposable has been disposed\n\t */\n\tget value(): T | undefined {\n\t\treturn this._isDisposed ? undefined : this._value;\n\t}\n\n\t/**\n\t * Set a new disposable value.\n\t *\n\t * Behaviour:\n\t * - If the MutableDisposable has been disposed, the setter is a no-op.\n\t * - If the new value is strictly equal to the current value, the setter is a no-op.\n\t * - Otherwise the previous value (if any) is disposed and the new value is stored.\n\t *\n\t * Related helpers:\n\t * - clear() resets the value to `undefined` (and disposes the previous value).\n\t * - clearAndLeak() returns the old value without disposing it and removes its parent.\n\t */\n\tset value(value: T | undefined) {\n\t\tif (this._isDisposed || value === this._value) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._value?.dispose();\n\t\tif (value) {\n\t\t\tsetParentOfDisposable(value, this);\n\t\t}\n\t\tthis._value = value;\n\t}\n\n\t/**\n\t * Resets the stored value and disposed of the previously stored value.\n\t */\n\tclear(): void {\n\t\tthis.value = undefined;\n\t}\n\n\tdispose(): void {\n\t\tthis._isDisposed = true;\n\t\tmarkAsDisposed(this);\n\t\tthis._value?.dispose();\n\t\tthis._value = undefined;\n\t}\n\n\t/**\n\t * Clears the value, but does not dispose it.\n\t * The old value is returned.\n\t*/\n\tclearAndLeak(): T | undefined {\n\t\tconst oldValue = this._value;\n\t\tthis._value = undefined;\n\t\tif (oldValue) {\n\t\t\tsetParentOfDisposable(oldValue, null);\n\t\t}\n\t\treturn oldValue;\n\t}\n}\n\n/**\n * Manages the lifecycle of a disposable value that may be changed like {@link MutableDisposable}, but the value must\n * exist and cannot be undefined.\n */\nexport class MandatoryMutableDisposable<T extends IDisposable> implements IDisposable {\n\tprivate readonly _disposable = new MutableDisposable<T>();\n\tprivate _isDisposed = false;\n\n\tconstructor(initialValue: T) {\n\t\tthis._disposable.value = initialValue;\n\t}\n\n\tget value(): T {\n\t\treturn this._disposable.value!;\n\t}\n\n\tset value(value: T) {\n\t\tif (this._isDisposed || value === this._disposable.value) {\n\t\t\treturn;\n\t\t}\n\t\tthis._disposable.value = value;\n\t}\n\n\tdispose() {\n\t\tthis._isDisposed = true;\n\t\tthis._disposable.dispose();\n\t}\n}\n\nexport class RefCountedDisposable {\n\n\tprivate _counter: number = 1;\n\n\tconstructor(\n\t\tprivate readonly _disposable: IDisposable,\n\t) { }\n\n\tacquire() {\n\t\tthis._counter++;\n\t\treturn this;\n\t}\n\n\trelease() {\n\t\tif (--this._counter === 0) {\n\t\t\tthis._disposable.dispose();\n\t\t}\n\t\treturn this;\n\t}\n}\n\nexport interface IReference<T> extends IDisposable {\n\treadonly object: T;\n}\n\nexport abstract class ReferenceCollection<T> {\n\n\tprivate readonly references: Map<string, { readonly object: T; counter: number }> = new Map();\n\n\tacquire(key: string, ...args: unknown[]): IReference<T> {\n\t\tlet reference = this.references.get(key);\n\n\t\tif (!reference) {\n\t\t\treference = { counter: 0, object: this.createReferencedObject(key, ...args) };\n\t\t\tthis.references.set(key, reference);\n\t\t}\n\n\t\tconst { object } = reference;\n\t\tconst dispose = createSingleCallFunction(() => {\n\t\t\tif (--reference.counter === 0) {\n\t\t\t\tthis.destroyReferencedObject(key, reference.object);\n\t\t\t\tthis.references.delete(key);\n\t\t\t}\n\t\t});\n\n\t\treference.counter++;\n\n\t\treturn { object, dispose };\n\t}\n\n\tprotected abstract createReferencedObject(key: string, ...args: unknown[]): T;\n\tprotected abstract destroyReferencedObject(key: string, object: T): void;\n}\n\n/**\n * Unwraps a reference collection of promised values. Makes sure\n * references are disposed whenever promises get rejected.\n */\nexport class AsyncReferenceCollection<T> {\n\n\tconstructor(private referenceCollection: ReferenceCollection<Promise<T>>) { }\n\n\tasync acquire(key: string, ...args: any[]): Promise<IReference<T>> {\n\t\tconst ref = this.referenceCollection.acquire(key, ...args);\n\n\t\ttry {\n\t\t\tconst object = await ref.object;\n\n\t\t\treturn {\n\t\t\t\tobject,\n\t\t\t\tdispose: () => ref.dispose()\n\t\t\t};\n\t\t} catch (error) {\n\t\t\tref.dispose();\n\t\t\tthrow error;\n\t\t}\n\t}\n}\n\nexport class ImmortalReference<T> implements IReference<T> {\n\tconstructor(public object: T) { }\n\tdispose(): void { /* noop */ }\n}\n\nexport function disposeOnReturn(fn: (store: DisposableStore) => void): void {\n\tconst store = new DisposableStore();\n\ttry {\n\t\tfn(store);\n\t} finally {\n\t\tstore.dispose();\n\t}\n}\n\n/**\n * A map the manages the lifecycle of the values that it stores.\n */\nexport class DisposableMap<K, V extends IDisposable = IDisposable> implements IDisposable {\n\n\tprivate readonly _store: Map<K, V>;\n\tprivate _isDisposed = false;\n\n\tconstructor(store: Map<K, V> = new Map<K, V>()) {\n\t\tthis._store = store;\n\t\ttrackDisposable(this);\n\t}\n\n\t/**\n\t * Disposes of all stored values and mark this object as disposed.\n\t *\n\t * Trying to use this object after it has been disposed of is an error.\n\t */\n\tdispose(): void {\n\t\tmarkAsDisposed(this);\n\t\tthis._isDisposed = true;\n\t\tthis.clearAndDisposeAll();\n\t}\n\n\t/**\n\t * Disposes of all stored values and clear the map, but DO NOT mark this object as disposed.\n\t */\n\tclearAndDisposeAll(): void {\n\t\tif (!this._store.size) {\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tdispose(this._store.values());\n\t\t} finally {\n\t\t\tthis._store.clear();\n\t\t}\n\t}\n\n\thas(key: K): boolean {\n\t\treturn this._store.has(key);\n\t}\n\n\tget size(): number {\n\t\treturn this._store.size;\n\t}\n\n\tget(key: K): V | undefined {\n\t\treturn this._store.get(key);\n\t}\n\n\tset(key: K, value: V, skipDisposeOnOverwrite = false): void {\n\t\tif (this._isDisposed) {\n\t\t\tconsole.warn(new Error('Trying to add a disposable to a DisposableMap that has already been disposed of. The added object will be leaked!').stack);\n\t\t}\n\n\t\tif (!skipDisposeOnOverwrite) {\n\t\t\tthis._store.get(key)?.dispose();\n\t\t}\n\n\t\tthis._store.set(key, value);\n\t\tsetParentOfDisposable(value, this);\n\t}\n\n\t/**\n\t * Delete the value stored for `key` from this map and also dispose of it.\n\t */\n\tdeleteAndDispose(key: K): void {\n\t\tthis._store.get(key)?.dispose();\n\t\tthis._store.delete(key);\n\t}\n\n\t/**\n\t * Delete the value stored for `key` from this map but return it. The caller is\n\t * responsible for disposing of the value.\n\t */\n\tdeleteAndLeak(key: K): V | undefined {\n\t\tconst value = this._store.get(key);\n\t\tif (value) {\n\t\t\tsetParentOfDisposable(value, null);\n\t\t}\n\t\tthis._store.delete(key);\n\t\treturn value;\n\t}\n\n\tkeys(): IterableIterator<K> {\n\t\treturn this._store.keys();\n\t}\n\n\tvalues(): IterableIterator<V> {\n\t\treturn this._store.values();\n\t}\n\n\t[Symbol.iterator](): IterableIterator<[K, V]> {\n\t\treturn this._store[Symbol.iterator]();\n\t}\n}\n\n/**\n * Call `then` on a Promise, unless the returned disposable is disposed.\n */\nexport function thenIfNotDisposed<T>(promise: Promise<T>, then: (result: T) => void): IDisposable {\n\tlet disposed = false;\n\tpromise.then(result => {\n\t\tif (disposed) {\n\t\t\treturn;\n\t\t}\n\t\tthen(result);\n\t});\n\treturn toDisposable(() => {\n\t\tdisposed = true;\n\t});\n}\n\n/**\n * Call `then` on a promise that resolves to a {@link IDisposable}, then either register the\n * disposable or register it to the {@link DisposableStore}, depending on whether the store is\n * disposed or not.\n */\nexport function thenRegisterOrDispose<T extends IDisposable>(promise: Promise<T>, store: DisposableStore): Promise<T> {\n\treturn promise.then(disposable => {\n\t\tif (store.isDisposed) {\n\t\t\tdisposable.dispose();\n\t\t} else {\n\t\t\tstore.add(disposable);\n\t\t}\n\t\treturn disposable;\n\t});\n}\n\nexport class DisposableResourceMap<V extends IDisposable = IDisposable> extends DisposableMap<URI, V> {\n\tconstructor() {\n\t\tsuper(new ResourceMap());\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Lazy } from './lazy.js';\nimport * as streams from './stream.js';\n\ninterface NodeBuffer {\n\tallocUnsafe(size: number): Uint8Array;\n\tisBuffer(obj: unknown): obj is NodeBuffer;\n\tfrom(arrayBuffer: ArrayBufferLike, byteOffset?: number, length?: number): Uint8Array;\n\tfrom(data: string): Uint8Array;\n}\n\ndeclare const Buffer: NodeBuffer;\n\nconst hasBuffer = (typeof Buffer !== 'undefined');\nconst indexOfTable = new Lazy(() => new Uint8Array(256));\n\nlet textEncoder: { encode: (input: string) => Uint8Array } | null;\nlet textDecoder: { decode: (input: Uint8Array) => string } | null;\n\nexport class VSBuffer {\n\n\t/**\n\t * When running in a nodejs context, the backing store for the returned `VSBuffer` instance\n\t * might use a nodejs Buffer allocated from node's Buffer pool, which is not transferrable.\n\t */\n\tstatic alloc(byteLength: number): VSBuffer {\n\t\tif (hasBuffer) {\n\t\t\treturn new VSBuffer(Buffer.allocUnsafe(byteLength));\n\t\t} else {\n\t\t\treturn new VSBuffer(new Uint8Array(byteLength));\n\t\t}\n\t}\n\n\t/**\n\t * When running in a nodejs context, if `actual` is not a nodejs Buffer, the backing store for\n\t * the returned `VSBuffer` instance might use a nodejs Buffer allocated from node's Buffer pool,\n\t * which is not transferrable.\n\t */\n\tstatic wrap(actual: Uint8Array): VSBuffer {\n\t\tif (hasBuffer && !(Buffer.isBuffer(actual))) {\n\t\t\t// https://nodejs.org/dist/latest-v10.x/docs/api/buffer.html#buffer_class_method_buffer_from_arraybuffer_byteoffset_length\n\t\t\t// Create a zero-copy Buffer wrapper around the ArrayBuffer pointed to by the Uint8Array\n\t\t\tactual = Buffer.from(actual.buffer, actual.byteOffset, actual.byteLength);\n\t\t}\n\t\treturn new VSBuffer(actual);\n\t}\n\n\t/**\n\t * When running in a nodejs context, the backing store for the returned `VSBuffer` instance\n\t * might use a nodejs Buffer allocated from node's Buffer pool, which is not transferrable.\n\t */\n\tstatic fromString(source: string, options?: { dontUseNodeBuffer?: boolean }): VSBuffer {\n\t\tconst dontUseNodeBuffer = options?.dontUseNodeBuffer || false;\n\t\tif (!dontUseNodeBuffer && hasBuffer) {\n\t\t\treturn new VSBuffer(Buffer.from(source));\n\t\t} else {\n\t\t\tif (!textEncoder) {\n\t\t\t\ttextEncoder = new TextEncoder();\n\t\t\t}\n\t\t\treturn new VSBuffer(textEncoder.encode(source));\n\t\t}\n\t}\n\n\t/**\n\t * When running in a nodejs context, the backing store for the returned `VSBuffer` instance\n\t * might use a nodejs Buffer allocated from node's Buffer pool, which is not transferrable.\n\t */\n\tstatic fromByteArray(source: number[]): VSBuffer {\n\t\tconst result = VSBuffer.alloc(source.length);\n\t\tfor (let i = 0, len = source.length; i < len; i++) {\n\t\t\tresult.buffer[i] = source[i];\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * When running in a nodejs context, the backing store for the returned `VSBuffer` instance\n\t * might use a nodejs Buffer allocated from node's Buffer pool, which is not transferrable.\n\t */\n\tstatic concat(buffers: VSBuffer[], totalLength?: number): VSBuffer {\n\t\tif (typeof totalLength === 'undefined') {\n\t\t\ttotalLength = 0;\n\t\t\tfor (let i = 0, len = buffers.length; i < len; i++) {\n\t\t\t\ttotalLength += buffers[i].byteLength;\n\t\t\t}\n\t\t}\n\n\t\tconst ret = VSBuffer.alloc(totalLength);\n\t\tlet offset = 0;\n\t\tfor (let i = 0, len = buffers.length; i < len; i++) {\n\t\t\tconst element = buffers[i];\n\t\t\tret.set(element, offset);\n\t\t\toffset += element.byteLength;\n\t\t}\n\n\t\treturn ret;\n\t}\n\n\tstatic isNativeBuffer(buffer: unknown): boolean {\n\t\treturn hasBuffer && Buffer.isBuffer(buffer);\n\t}\n\n\treadonly buffer: Uint8Array;\n\treadonly byteLength: number;\n\n\tprivate constructor(buffer: Uint8Array) {\n\t\tthis.buffer = buffer;\n\t\tthis.byteLength = this.buffer.byteLength;\n\t}\n\n\t/**\n\t * When running in a nodejs context, the backing store for the returned `VSBuffer` instance\n\t * might use a nodejs Buffer allocated from node's Buffer pool, which is not transferrable.\n\t */\n\tclone(): VSBuffer {\n\t\tconst result = VSBuffer.alloc(this.byteLength);\n\t\tresult.set(this);\n\t\treturn result;\n\t}\n\n\ttoString(): string {\n\t\tif (hasBuffer) {\n\t\t\treturn this.buffer.toString();\n\t\t} else {\n\t\t\tif (!textDecoder) {\n\t\t\t\ttextDecoder = new TextDecoder(undefined, { ignoreBOM: true });\n\t\t\t}\n\t\t\treturn textDecoder.decode(this.buffer);\n\t\t}\n\t}\n\n\tslice(start?: number, end?: number): VSBuffer {\n\t\t// IMPORTANT: use subarray instead of slice because TypedArray#slice\n\t\t// creates shallow copy and NodeBuffer#slice doesn't. The use of subarray\n\t\t// ensures the same, performance, behaviour.\n\t\treturn new VSBuffer(this.buffer.subarray(start, end));\n\t}\n\n\tset(array: VSBuffer, offset?: number): void;\n\tset(array: Uint8Array, offset?: number): void;\n\tset(array: ArrayBuffer, offset?: number): void;\n\tset(array: ArrayBufferView, offset?: number): void;\n\tset(array: VSBuffer | Uint8Array | ArrayBuffer | ArrayBufferView, offset?: number): void;\n\tset(array: VSBuffer | Uint8Array | ArrayBuffer | ArrayBufferView, offset?: number): void {\n\t\tif (array instanceof VSBuffer) {\n\t\t\tthis.buffer.set(array.buffer, offset);\n\t\t} else if (array instanceof Uint8Array) {\n\t\t\tthis.buffer.set(array, offset);\n\t\t} else if (array instanceof ArrayBuffer) {\n\t\t\tthis.buffer.set(new Uint8Array(array), offset);\n\t\t} else if (ArrayBuffer.isView(array)) {\n\t\t\tthis.buffer.set(new Uint8Array(array.buffer, array.byteOffset, array.byteLength), offset);\n\t\t} else {\n\t\t\tthrow new Error(`Unknown argument 'array'`);\n\t\t}\n\t}\n\n\treadUInt32BE(offset: number): number {\n\t\treturn readUInt32BE(this.buffer, offset);\n\t}\n\n\twriteUInt32BE(value: number, offset: number): void {\n\t\twriteUInt32BE(this.buffer, value, offset);\n\t}\n\n\treadUInt32LE(offset: number): number {\n\t\treturn readUInt32LE(this.buffer, offset);\n\t}\n\n\twriteUInt32LE(value: number, offset: number): void {\n\t\twriteUInt32LE(this.buffer, value, offset);\n\t}\n\n\treadUInt8(offset: number): number {\n\t\treturn readUInt8(this.buffer, offset);\n\t}\n\n\twriteUInt8(value: number, offset: number): void {\n\t\twriteUInt8(this.buffer, value, offset);\n\t}\n\n\tindexOf(subarray: VSBuffer | Uint8Array, offset = 0) {\n\t\treturn binaryIndexOf(this.buffer, subarray instanceof VSBuffer ? subarray.buffer : subarray, offset);\n\t}\n\n\tequals(other: VSBuffer): boolean {\n\t\tif (this === other) {\n\t\t\treturn true;\n\t\t}\n\n\t\tif (this.byteLength !== other.byteLength) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.buffer.every((value, index) => value === other.buffer[index]);\n\t}\n}\n\n/**\n * Like String.indexOf, but works on Uint8Arrays.\n * Uses the boyer-moore-horspool algorithm to be reasonably speedy.\n */\nexport function binaryIndexOf(haystack: Uint8Array, needle: Uint8Array, offset = 0): number {\n\tconst needleLen = needle.byteLength;\n\tconst haystackLen = haystack.byteLength;\n\n\tif (needleLen === 0) {\n\t\treturn 0;\n\t}\n\n\tif (needleLen === 1) {\n\t\treturn haystack.indexOf(needle[0]);\n\t}\n\n\tif (needleLen > haystackLen - offset) {\n\t\treturn -1;\n\t}\n\n\t// find index of the subarray using boyer-moore-horspool algorithm\n\tconst table = indexOfTable.value;\n\ttable.fill(needle.length);\n\tfor (let i = 0; i < needle.length; i++) {\n\t\ttable[needle[i]] = needle.length - i - 1;\n\t}\n\n\tlet i = offset + needle.length - 1;\n\tlet j = i;\n\tlet result = -1;\n\twhile (i < haystackLen) {\n\t\tif (haystack[i] === needle[j]) {\n\t\t\tif (j === 0) {\n\t\t\t\tresult = i;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\ti--;\n\t\t\tj--;\n\t\t} else {\n\t\t\ti += Math.max(needle.length - j, table[haystack[i]]);\n\t\t\tj = needle.length - 1;\n\t\t}\n\t}\n\n\treturn result;\n}\n\nexport function readUInt16LE(source: Uint8Array, offset: number): number {\n\treturn (\n\t\t((source[offset + 0] << 0) >>> 0) |\n\t\t((source[offset + 1] << 8) >>> 0)\n\t);\n}\n\nexport function writeUInt16LE(destination: Uint8Array, value: number, offset: number): void {\n\tdestination[offset + 0] = (value & 0b11111111);\n\tvalue = value >>> 8;\n\tdestination[offset + 1] = (value & 0b11111111);\n}\n\nexport function readUInt32BE(source: Uint8Array, offset: number): number {\n\treturn (\n\t\tsource[offset] * 2 ** 24\n\t\t+ source[offset + 1] * 2 ** 16\n\t\t+ source[offset + 2] * 2 ** 8\n\t\t+ source[offset + 3]\n\t);\n}\n\nexport function writeUInt32BE(destination: Uint8Array, value: number, offset: number): void {\n\tdestination[offset + 3] = value;\n\tvalue = value >>> 8;\n\tdestination[offset + 2] = value;\n\tvalue = value >>> 8;\n\tdestination[offset + 1] = value;\n\tvalue = value >>> 8;\n\tdestination[offset] = value;\n}\n\nexport function readUInt32LE(source: Uint8Array, offset: number): number {\n\treturn (\n\t\t((source[offset + 0] << 0) >>> 0) |\n\t\t((source[offset + 1] << 8) >>> 0) |\n\t\t((source[offset + 2] << 16) >>> 0) |\n\t\t((source[offset + 3] << 24) >>> 0)\n\t);\n}\n\nexport function writeUInt32LE(destination: Uint8Array, value: number, offset: number): void {\n\tdestination[offset + 0] = (value & 0b11111111);\n\tvalue = value >>> 8;\n\tdestination[offset + 1] = (value & 0b11111111);\n\tvalue = value >>> 8;\n\tdestination[offset + 2] = (value & 0b11111111);\n\tvalue = value >>> 8;\n\tdestination[offset + 3] = (value & 0b11111111);\n}\n\nexport function readUInt8(source: Uint8Array, offset: number): number {\n\treturn source[offset];\n}\n\nexport function writeUInt8(destination: Uint8Array, value: number, offset: number): void {\n\tdestination[offset] = value;\n}\n\nexport interface VSBufferReadable extends streams.Readable<VSBuffer> { }\n\nexport interface VSBufferReadableStream extends streams.ReadableStream<VSBuffer> { }\n\nexport interface VSBufferWriteableStream extends streams.WriteableStream<VSBuffer> { }\n\nexport interface VSBufferReadableBufferedStream extends streams.ReadableBufferedStream<VSBuffer> { }\n\nexport function readableToBuffer(readable: VSBufferReadable): VSBuffer {\n\treturn streams.consumeReadable<VSBuffer>(readable, chunks => VSBuffer.concat(chunks));\n}\n\nexport function bufferToReadable(buffer: VSBuffer): VSBufferReadable {\n\treturn streams.toReadable<VSBuffer>(buffer);\n}\n\nexport function streamToBuffer(stream: streams.ReadableStream<VSBuffer>): Promise<VSBuffer> {\n\treturn streams.consumeStream<VSBuffer>(stream, chunks => VSBuffer.concat(chunks));\n}\n\nexport async function bufferedStreamToBuffer(bufferedStream: streams.ReadableBufferedStream<VSBuffer>): Promise<VSBuffer> {\n\tif (bufferedStream.ended) {\n\t\treturn VSBuffer.concat(bufferedStream.buffer);\n\t}\n\n\treturn VSBuffer.concat([\n\n\t\t// Include already read chunks...\n\t\t...bufferedStream.buffer,\n\n\t\t// ...and all additional chunks\n\t\tawait streamToBuffer(bufferedStream.stream)\n\t]);\n}\n\nexport function bufferToStream(buffer: VSBuffer): streams.ReadableStream<VSBuffer> {\n\treturn streams.toStream<VSBuffer>(buffer, chunks => VSBuffer.concat(chunks));\n}\n\nexport function streamToBufferReadableStream(stream: streams.ReadableStreamEvents<Uint8Array | string>): streams.ReadableStream<VSBuffer> {\n\treturn streams.transform<Uint8Array | string, VSBuffer>(stream, { data: data => typeof data === 'string' ? VSBuffer.fromString(data) : VSBuffer.wrap(data) }, chunks => VSBuffer.concat(chunks));\n}\n\nexport function newWriteableBufferStream(options?: streams.WriteableStreamOptions): streams.WriteableStream<VSBuffer> {\n\treturn streams.newWriteableStream<VSBuffer>(chunks => VSBuffer.concat(chunks), options);\n}\n\nexport function prefixedBufferReadable(prefix: VSBuffer, readable: VSBufferReadable): VSBufferReadable {\n\treturn streams.prefixedReadable(prefix, readable, chunks => VSBuffer.concat(chunks));\n}\n\nexport function prefixedBufferStream(prefix: VSBuffer, stream: VSBufferReadableStream): VSBufferReadableStream {\n\treturn streams.prefixedStream(prefix, stream, chunks => VSBuffer.concat(chunks));\n}\n\n/** Decodes base64 to a uint8 array. URL-encoded and unpadded base64 is allowed. */\nexport function decodeBase64(encoded: string) {\n\tlet building = 0;\n\tlet remainder = 0;\n\tlet bufi = 0;\n\n\t// The simpler way to do this is `Uint8Array.from(atob(str), c => c.charCodeAt(0))`,\n\t// but that's about 10-20x slower than this function in current Chromium versions.\n\n\tconst buffer = new Uint8Array(Math.floor(encoded.length / 4 * 3));\n\tconst append = (value: number) => {\n\t\tswitch (remainder) {\n\t\t\tcase 3:\n\t\t\t\tbuffer[bufi++] = building | value;\n\t\t\t\tremainder = 0;\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\tbuffer[bufi++] = building | (value >>> 2);\n\t\t\t\tbuilding = value << 6;\n\t\t\t\tremainder = 3;\n\t\t\t\tbreak;\n\t\t\tcase 1:\n\t\t\t\tbuffer[bufi++] = building | (value >>> 4);\n\t\t\t\tbuilding = value << 4;\n\t\t\t\tremainder = 2;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbuilding = value << 2;\n\t\t\t\tremainder = 1;\n\t\t}\n\t};\n\n\tfor (let i = 0; i < encoded.length; i++) {\n\t\tconst code = encoded.charCodeAt(i);\n\t\t// See https://datatracker.ietf.org/doc/html/rfc4648#section-4\n\t\t// This branchy code is about 3x faster than an indexOf on a base64 char string.\n\t\tif (code >= 65 && code <= 90) {\n\t\t\tappend(code - 65); // A-Z starts ranges from char code 65 to 90\n\t\t} else if (code >= 97 && code <= 122) {\n\t\t\tappend(code - 97 + 26); // a-z starts ranges from char code 97 to 122, starting at byte 26\n\t\t} else if (code >= 48 && code <= 57) {\n\t\t\tappend(code - 48 + 52); // 0-9 starts ranges from char code 48 to 58, starting at byte 52\n\t\t} else if (code === 43 || code === 45) {\n\t\t\tappend(62); // \"+\" or \"-\" for URLS\n\t\t} else if (code === 47 || code === 95) {\n\t\t\tappend(63); // \"/\" or \"_\" for URLS\n\t\t} else if (code === 61) {\n\t\t\tbreak; // \"=\"\n\t\t} else {\n\t\t\tthrow new SyntaxError(`Unexpected base64 character ${encoded[i]}`);\n\t\t}\n\t}\n\n\tconst unpadded = bufi;\n\twhile (remainder > 0) {\n\t\tappend(0);\n\t}\n\n\t// slice is needed to account for overestimation due to padding\n\treturn VSBuffer.wrap(buffer).slice(0, unpadded);\n}\n\nconst base64Alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/';\nconst base64UrlSafeAlphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_';\n\n/** Encodes a buffer to a base64 string. */\nexport function encodeBase64({ buffer }: VSBuffer, padded = true, urlSafe = false) {\n\tconst dictionary = urlSafe ? base64UrlSafeAlphabet : base64Alphabet;\n\tlet output = '';\n\n\tconst remainder = buffer.byteLength % 3;\n\n\tlet i = 0;\n\tfor (; i < buffer.byteLength - remainder; i += 3) {\n\t\tconst a = buffer[i + 0];\n\t\tconst b = buffer[i + 1];\n\t\tconst c = buffer[i + 2];\n\n\t\toutput += dictionary[a >>> 2];\n\t\toutput += dictionary[(a << 4 | b >>> 4) & 0b111111];\n\t\toutput += dictionary[(b << 2 | c >>> 6) & 0b111111];\n\t\toutput += dictionary[c & 0b111111];\n\t}\n\n\tif (remainder === 1) {\n\t\tconst a = buffer[i + 0];\n\t\toutput += dictionary[a >>> 2];\n\t\toutput += dictionary[(a << 4) & 0b111111];\n\t\tif (padded) { output += '=='; }\n\t} else if (remainder === 2) {\n\t\tconst a = buffer[i + 0];\n\t\tconst b = buffer[i + 1];\n\t\toutput += dictionary[a >>> 2];\n\t\toutput += dictionary[(a << 4 | b >>> 4) & 0b111111];\n\t\toutput += dictionary[(b << 2) & 0b111111];\n\t\tif (padded) { output += '='; }\n\t}\n\n\treturn output;\n}\n\nconst hexChars = '0123456789abcdef';\nexport function encodeHex({ buffer }: VSBuffer): string {\n\tlet result = '';\n\tfor (let i = 0; i < buffer.length; i++) {\n\t\tconst byte = buffer[i];\n\t\tresult += hexChars[byte >>> 4];\n\t\tresult += hexChars[byte & 0x0f];\n\t}\n\treturn result;\n}\n\nexport function decodeHex(hex: string): VSBuffer {\n\tif (hex.length % 2 !== 0) {\n\t\tthrow new SyntaxError('Hex string must have an even length');\n\t}\n\tconst out = new Uint8Array(hex.length >> 1);\n\tfor (let i = 0; i < hex.length;) {\n\t\tout[i >> 1] = (decodeHexChar(hex, i++) << 4) | decodeHexChar(hex, i++);\n\t}\n\treturn VSBuffer.wrap(out);\n}\n\nfunction decodeHexChar(str: string, position: number) {\n\tconst s = str.charCodeAt(position);\n\tif (s >= 48 && s <= 57) { // '0'-'9'\n\t\treturn s - 48;\n\t} else if (s >= 97 && s <= 102) { // 'a'-'f'\n\t\treturn s - 87;\n\t} else if (s >= 65 && s <= 70) { // 'A'-'F'\n\t\treturn s - 55;\n\t} else {\n\t\tthrow new SyntaxError(`Invalid hex character at position ${position}`);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport function getNLSMessages(): string[] {\n\treturn globalThis._VSCODE_NLS_MESSAGES;\n}\n\nexport function getNLSLanguage(): string | undefined {\n\treturn globalThis._VSCODE_NLS_LANGUAGE;\n}\n\ndeclare const document: { location?: { hash?: string } } | undefined;\nconst isPseudo = getNLSLanguage() === 'pseudo' || (typeof document !== 'undefined' && document.location && typeof document.location.hash === 'string' && document.location.hash.indexOf('pseudo=true') >= 0);\n\nexport interface ILocalizeInfo {\n\tkey: string;\n\tcomment: string[];\n}\n\nexport interface ILocalizedString {\n\toriginal: string;\n\tvalue: string;\n}\n\nfunction _format(message: string, args: (string | number | boolean | undefined | null)[]): string {\n\tlet result: string;\n\n\tif (args.length === 0) {\n\t\tresult = message;\n\t} else {\n\t\tresult = message.replace(/\\{(\\d+)\\}/g, (match, rest) => {\n\t\t\tconst index = rest[0];\n\t\t\tconst arg = args[index];\n\t\t\tlet result = match;\n\t\t\tif (typeof arg === 'string') {\n\t\t\t\tresult = arg;\n\t\t\t} else if (typeof arg === 'number' || typeof arg === 'boolean' || arg === void 0 || arg === null) {\n\t\t\t\tresult = String(arg);\n\t\t\t}\n\t\t\treturn result;\n\t\t});\n\t}\n\n\tif (isPseudo) {\n\t\t// FF3B and FF3D is the Unicode zenkaku representation for [ and ]\n\t\tresult = '\\uFF3B' + result.replace(/[aouei]/g, '$&$&') + '\\uFF3D';\n\t}\n\n\treturn result;\n}\n\n/**\n * Marks a string to be localized. Returns the localized string.\n *\n * @param info The {@linkcode ILocalizeInfo} which describes the id and comments associated with the localized string.\n * @param message The string to localize\n * @param args The arguments to the string\n *\n * @note `message` can contain `{n}` notation where it is replaced by the nth value in `...args`\n * @example `localize({ key: 'sayHello', comment: ['Welcomes user'] }, 'hello {0}', name)`\n *\n * @returns string The localized string.\n */\nexport function localize(info: ILocalizeInfo, message: string, ...args: (string | number | boolean | undefined | null)[]): string;\n\n/**\n * Marks a string to be localized. Returns the localized string.\n *\n * @param key The key to use for localizing the string\n * @param message The string to localize\n * @param args The arguments to the string\n *\n * @note `message` can contain `{n}` notation where it is replaced by the nth value in `...args`\n * @example For example, `localize('sayHello', 'hello {0}', name)`\n *\n * @returns string The localized string.\n */\nexport function localize(key: string, message: string, ...args: (string | number | boolean | undefined | null)[]): string;\n\n/**\n * @skipMangle\n */\nexport function localize(data: ILocalizeInfo | string /* | number when built */, message: string /* | null when built */, ...args: (string | number | boolean | undefined | null)[]): string {\n\tif (typeof data === 'number') {\n\t\treturn _format(lookupMessage(data, message), args);\n\t}\n\treturn _format(message, args);\n}\n\n/**\n * Only used when built: Looks up the message in the global NLS table.\n * This table is being made available as a global through bootstrapping\n * depending on the target context.\n */\nfunction lookupMessage(index: number, fallback: string | null): string {\n\tconst message = getNLSMessages()?.[index];\n\tif (typeof message !== 'string') {\n\t\tif (typeof fallback === 'string') {\n\t\t\treturn fallback;\n\t\t}\n\t\tthrow new Error(`!!! NLS MISSING: ${index} !!!`);\n\t}\n\treturn message;\n}\n\n/**\n * Marks a string to be localized. Returns an {@linkcode ILocalizedString}\n * which contains the localized string and the original string.\n *\n * @param info The {@linkcode ILocalizeInfo} which describes the id and comments associated with the localized string.\n * @param message The string to localize\n * @param args The arguments to the string\n *\n * @note `message` can contain `{n}` notation where it is replaced by the nth value in `...args`\n * @example `localize2({ key: 'sayHello', comment: ['Welcomes user'] }, 'hello {0}', name)`\n *\n * @returns ILocalizedString which contains the localized string and the original string.\n */\nexport function localize2(info: ILocalizeInfo, message: string, ...args: (string | number | boolean | undefined | null)[]): ILocalizedString;\n\n/**\n * Marks a string to be localized. Returns an {@linkcode ILocalizedString}\n * which contains the localized string and the original string.\n *\n * @param key The key to use for localizing the string\n * @param message The string to localize\n * @param args The arguments to the string\n *\n * @note `message` can contain `{n}` notation where it is replaced by the nth value in `...args`\n * @example `localize('sayHello', 'hello {0}', name)`\n *\n * @returns ILocalizedString which contains the localized string and the original string.\n */\nexport function localize2(key: string, message: string, ...args: (string | number | boolean | undefined | null)[]): ILocalizedString;\n\n/**\n * @skipMangle\n */\nexport function localize2(data: ILocalizeInfo | string /* | number when built */, originalMessage: string, ...args: (string | number | boolean | undefined | null)[]): ILocalizedString {\n\tlet message: string;\n\tif (typeof data === 'number') {\n\t\tmessage = lookupMessage(data, originalMessage);\n\t} else {\n\t\tmessage = originalMessage;\n\t}\n\n\tconst value = _format(message, args);\n\n\treturn {\n\t\tvalue,\n\t\toriginal: originalMessage === message ? value : _format(originalMessage, args)\n\t};\n}\n\nexport interface INLSLanguagePackConfiguration {\n\n\t/**\n\t * The path to the translations config file that contains pointers to\n\t * all message bundles for `main` and extensions.\n\t */\n\treadonly translationsConfigFile: string;\n\n\t/**\n\t * The path to the file containing the translations for this language\n\t * pack as flat string array.\n\t */\n\treadonly messagesFile: string;\n\n\t/**\n\t * The path to the file that can be used to signal a corrupt language\n\t * pack, for example when reading the `messagesFile` fails. This will\n\t * instruct the application to re-create the cache on next startup.\n\t */\n\treadonly corruptMarkerFile: string;\n}\n\nexport interface INLSConfiguration {\n\n\t/**\n\t * Locale as defined in `argv.json` or `app.getLocale()`.\n\t */\n\treadonly userLocale: string;\n\n\t/**\n\t * Locale as defined by the OS (e.g. `app.getPreferredSystemLanguages()`).\n\t */\n\treadonly osLocale: string;\n\n\t/**\n\t * The actual language of the UI that ends up being used considering `userLocale`\n\t * and `osLocale`.\n\t */\n\treadonly resolvedLanguage: string;\n\n\t/**\n\t * Defined if a language pack is used that is not the\n\t * default english language pack. This requires a language\n\t * pack to be installed as extension.\n\t */\n\treadonly languagePack?: INLSLanguagePackConfiguration;\n\n\t/**\n\t * The path to the file containing the default english messages\n\t * as flat string array. The file is only present in built\n\t * versions of the application.\n\t */\n\treadonly defaultMessagesFile: string;\n\n\t/**\n\t * Below properties are deprecated and only there to continue support\n\t * for `vscode-nls` module that depends on them.\n\t * Refs https://github.com/microsoft/vscode-nls/blob/main/src/node/main.ts#L36-L46\n\t */\n\t/** @deprecated */\n\treadonly locale: string;\n\t/** @deprecated */\n\treadonly availableLanguages: Record<string, string>;\n\t/** @deprecated */\n\treadonly _languagePackSupport?: boolean;\n\t/** @deprecated */\n\treadonly _languagePackId?: string;\n\t/** @deprecated */\n\treadonly _translationsConfigFile?: string;\n\t/** @deprecated */\n\treadonly _cacheRoot?: string;\n\t/** @deprecated */\n\treadonly _resolvedLanguagePackCoreLocation?: string;\n\t/** @deprecated */\n\treadonly _corruptedFile?: string;\n}\n\nexport interface ILanguagePack {\n\treadonly hash: string;\n\treadonly label: string | undefined;\n\treadonly extensions: {\n\t\treadonly extensionIdentifier: { readonly id: string; readonly uuid?: string };\n\t\treadonly version: string;\n\t}[];\n\treadonly translations: Record<string, string | undefined>;\n}\n\nexport type ILanguagePacks = Record<string, ILanguagePack | undefined>;\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from '../../nls.js';\n\nexport const LANGUAGE_DEFAULT = 'en';\n\nlet _isWindows = false;\nlet _isMacintosh = false;\nlet _isLinux = false;\nlet _isLinuxSnap = false;\nlet _isNative = false;\nlet _isWeb = false;\nlet _isElectron = false;\nlet _isIOS = false;\nlet _isCI = false;\nlet _isMobile = false;\nlet _locale: string | undefined = undefined;\nlet _language: string = LANGUAGE_DEFAULT;\nlet _platformLocale: string = LANGUAGE_DEFAULT;\nlet _translationsConfigFile: string | undefined = undefined;\nlet _userAgent: string | undefined = undefined;\n\nexport interface IProcessEnvironment {\n\t[key: string]: string | undefined;\n}\n\n/**\n * This interface is intentionally not identical to node.js\n * process because it also works in sandboxed environments\n * where the process object is implemented differently. We\n * define the properties here that we need for `platform`\n * to work and nothing else.\n */\nexport interface INodeProcess {\n\tplatform: string;\n\tarch: string;\n\tenv: IProcessEnvironment;\n\tversions?: {\n\t\tnode?: string;\n\t\telectron?: string;\n\t\tchrome?: string;\n\t};\n\ttype?: string;\n\tcwd: () => string;\n}\n\ndeclare const process: INodeProcess;\n\nconst $globalThis: any = globalThis;\n\nlet nodeProcess: INodeProcess | undefined = undefined;\nif (typeof $globalThis.vscode !== 'undefined' && typeof $globalThis.vscode.process !== 'undefined') {\n\t// Native environment (sandboxed)\n\tnodeProcess = $globalThis.vscode.process;\n} else if (typeof process !== 'undefined' && typeof process?.versions?.node === 'string') {\n\t// Native environment (non-sandboxed)\n\tnodeProcess = process;\n}\n\nconst isElectronProcess = typeof nodeProcess?.versions?.electron === 'string';\nconst isElectronRenderer = isElectronProcess && nodeProcess?.type === 'renderer';\n\ninterface INavigator {\n\tuserAgent: string;\n\tmaxTouchPoints?: number;\n\tlanguage: string;\n}\ndeclare const navigator: INavigator;\n\n// Native environment\nif (typeof nodeProcess === 'object') {\n\t_isWindows = (nodeProcess.platform === 'win32');\n\t_isMacintosh = (nodeProcess.platform === 'darwin');\n\t_isLinux = (nodeProcess.platform === 'linux');\n\t_isLinuxSnap = _isLinux && !!nodeProcess.env['SNAP'] && !!nodeProcess.env['SNAP_REVISION'];\n\t_isElectron = isElectronProcess;\n\t_isCI = !!nodeProcess.env['CI'] || !!nodeProcess.env['BUILD_ARTIFACTSTAGINGDIRECTORY'] || !!nodeProcess.env['GITHUB_WORKSPACE'];\n\t_locale = LANGUAGE_DEFAULT;\n\t_language = LANGUAGE_DEFAULT;\n\tconst rawNlsConfig = nodeProcess.env['VSCODE_NLS_CONFIG'];\n\tif (rawNlsConfig) {\n\t\ttry {\n\t\t\tconst nlsConfig: nls.INLSConfiguration = JSON.parse(rawNlsConfig);\n\t\t\t_locale = nlsConfig.userLocale;\n\t\t\t_platformLocale = nlsConfig.osLocale;\n\t\t\t_language = nlsConfig.resolvedLanguage || LANGUAGE_DEFAULT;\n\t\t\t_translationsConfigFile = nlsConfig.languagePack?.translationsConfigFile;\n\t\t} catch (e) {\n\t\t}\n\t}\n\t_isNative = true;\n}\n\n// Web environment\nelse if (typeof navigator === 'object' && !isElectronRenderer) {\n\t_userAgent = navigator.userAgent;\n\t_isWindows = _userAgent.indexOf('Windows') >= 0;\n\t_isMacintosh = _userAgent.indexOf('Macintosh') >= 0;\n\t_isIOS = (_userAgent.indexOf('Macintosh') >= 0 || _userAgent.indexOf('iPad') >= 0 || _userAgent.indexOf('iPhone') >= 0) && !!navigator.maxTouchPoints && navigator.maxTouchPoints > 0;\n\t_isLinux = _userAgent.indexOf('Linux') >= 0;\n\t_isMobile = _userAgent?.indexOf('Mobi') >= 0;\n\t_isWeb = true;\n\t_language = nls.getNLSLanguage() || LANGUAGE_DEFAULT;\n\t_locale = navigator.language.toLowerCase();\n\t_platformLocale = _locale;\n}\n\n// Unknown environment\nelse {\n\tconsole.error('Unable to resolve platform.');\n}\n\nexport const enum Platform {\n\tWeb,\n\tMac,\n\tLinux,\n\tWindows\n}\nexport type PlatformName = 'Web' | 'Windows' | 'Mac' | 'Linux';\n\nexport function PlatformToString(platform: Platform): PlatformName {\n\tswitch (platform) {\n\t\tcase Platform.Web: return 'Web';\n\t\tcase Platform.Mac: return 'Mac';\n\t\tcase Platform.Linux: return 'Linux';\n\t\tcase Platform.Windows: return 'Windows';\n\t}\n}\n\nlet _platform: Platform = Platform.Web;\nif (_isMacintosh) {\n\t_platform = Platform.Mac;\n} else if (_isWindows) {\n\t_platform = Platform.Windows;\n} else if (_isLinux) {\n\t_platform = Platform.Linux;\n}\n\nexport const isWindows = _isWindows;\nexport const isMacintosh = _isMacintosh;\nexport const isLinux = _isLinux;\nexport const isLinuxSnap = _isLinuxSnap;\nexport const isNative = _isNative;\nexport const isElectron = _isElectron;\nexport const isWeb = _isWeb;\nexport const isWebWorker = (_isWeb && typeof $globalThis.importScripts === 'function');\nexport const webWorkerOrigin = isWebWorker ? $globalThis.origin : undefined;\nexport const isIOS = _isIOS;\nexport const isMobile = _isMobile;\n/**\n * Whether we run inside a CI environment, such as\n * GH actions or Azure Pipelines.\n */\nexport const isCI = _isCI;\nexport const platform = _platform;\nexport const userAgent = _userAgent;\n\n/**\n * The language used for the user interface. The format of\n * the string is all lower case (e.g. zh-tw for Traditional\n * Chinese or de for German)\n */\nexport const language = _language;\n\nexport namespace Language {\n\n\texport function value(): string {\n\t\treturn language;\n\t}\n\n\texport function isDefaultVariant(): boolean {\n\t\tif (language.length === 2) {\n\t\t\treturn language === 'en';\n\t\t} else if (language.length >= 3) {\n\t\t\treturn language[0] === 'e' && language[1] === 'n' && language[2] === '-';\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\texport function isDefault(): boolean {\n\t\treturn language === 'en';\n\t}\n}\n\n/**\n * Desktop: The OS locale or the locale specified by --locale or `argv.json`.\n * Web: matches `platformLocale`.\n *\n * The UI is not necessarily shown in the provided locale.\n */\nexport const locale = _locale;\n\n/**\n * This will always be set to the OS/browser's locale regardless of\n * what was specified otherwise. The format of the string is all\n * lower case (e.g. zh-tw for Traditional Chinese). The UI is not\n * necessarily shown in the provided locale.\n */\nexport const platformLocale = _platformLocale;\n\n/**\n * The translations that are available through language packs.\n */\nexport const translationsConfigFile = _translationsConfigFile;\n\nexport const setTimeout0IsFaster = (typeof $globalThis.postMessage === 'function' && !$globalThis.importScripts);\n\n/**\n * See https://html.spec.whatwg.org/multipage/timers-and-user-prompts.html#:~:text=than%204%2C%20then-,set%20timeout%20to%204,-.\n *\n * Works similarly to `setTimeout(0)` but doesn't suffer from the 4ms artificial delay\n * that browsers set when the nesting level is > 5.\n */\nexport const setTimeout0 = (() => {\n\tif (setTimeout0IsFaster) {\n\t\tinterface IQueueElement {\n\t\t\tid: number;\n\t\t\tcallback: () => void;\n\t\t}\n\t\tconst pending: IQueueElement[] = [];\n\n\t\t$globalThis.addEventListener('message', (e: any) => {\n\t\t\tif (e.data && e.data.vscodeScheduleAsyncWork) {\n\t\t\t\tfor (let i = 0, len = pending.length; i < len; i++) {\n\t\t\t\t\tconst candidate = pending[i];\n\t\t\t\t\tif (candidate.id === e.data.vscodeScheduleAsyncWork) {\n\t\t\t\t\t\tpending.splice(i, 1);\n\t\t\t\t\t\tcandidate.callback();\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t\tlet lastId = 0;\n\t\treturn (callback: () => void) => {\n\t\t\tconst myId = ++lastId;\n\t\t\tpending.push({\n\t\t\t\tid: myId,\n\t\t\t\tcallback: callback\n\t\t\t});\n\t\t\t$globalThis.postMessage({ vscodeScheduleAsyncWork: myId }, '*');\n\t\t};\n\t}\n\treturn (callback: () => void) => setTimeout(callback);\n})();\n\nexport const enum OperatingSystem {\n\tWindows = 1,\n\tMacintosh = 2,\n\tLinux = 3\n}\nexport const OS = (_isMacintosh || _isIOS ? OperatingSystem.Macintosh : (_isWindows ? OperatingSystem.Windows : OperatingSystem.Linux));\n\nlet _isLittleEndian = true;\nlet _isLittleEndianComputed = false;\nexport function isLittleEndian(): boolean {\n\tif (!_isLittleEndianComputed) {\n\t\t_isLittleEndianComputed = true;\n\t\tconst test = new Uint8Array(2);\n\t\ttest[0] = 1;\n\t\ttest[1] = 2;\n\t\tconst view = new Uint16Array(test.buffer);\n\t\t_isLittleEndian = (view[0] === (2 << 8) + 1);\n\t}\n\treturn _isLittleEndian;\n}\n\nexport const isChrome = !!(userAgent && userAgent.indexOf('Chrome') >= 0);\nexport const isFirefox = !!(userAgent && userAgent.indexOf('Firefox') >= 0);\nexport const isSafari = !!(!isChrome && (userAgent && userAgent.indexOf('Safari') >= 0));\nexport const isEdge = !!(userAgent && userAgent.indexOf('Edg/') >= 0);\nexport const isAndroid = !!(userAgent && userAgent.indexOf('Android') >= 0);\n\nexport function isTahoeOrNewer(osVersion: string): boolean {\n\treturn parseFloat(osVersion) >= 25;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { INodeProcess, isMacintosh, isWindows } from './platform.js';\n\nlet safeProcess: Omit<INodeProcess, 'arch'> & { arch: string | undefined };\ndeclare const process: INodeProcess;\n\n// Native sandbox environment\nconst vscodeGlobal = (globalThis as { vscode?: { process?: INodeProcess } }).vscode;\nif (typeof vscodeGlobal !== 'undefined' && typeof vscodeGlobal.process !== 'undefined') {\n\tconst sandboxProcess: INodeProcess = vscodeGlobal.process;\n\tsafeProcess = {\n\t\tget platform() { return sandboxProcess.platform; },\n\t\tget arch() { return sandboxProcess.arch; },\n\t\tget env() { return sandboxProcess.env; },\n\t\tcwd() { return sandboxProcess.cwd(); }\n\t};\n}\n\n// Native node.js environment\nelse if (typeof process !== 'undefined' && typeof process?.versions?.node === 'string') {\n\tsafeProcess = {\n\t\tget platform() { return process.platform; },\n\t\tget arch() { return process.arch; },\n\t\tget env() { return process.env; },\n\t\tcwd() { return process.env['VSCODE_CWD'] || process.cwd(); }\n\t};\n}\n\n// Web environment\nelse {\n\tsafeProcess = {\n\n\t\t// Supported\n\t\tget platform() { return isWindows ? 'win32' : isMacintosh ? 'darwin' : 'linux'; },\n\t\tget arch() { return undefined; /* arch is undefined in web */ },\n\n\t\t// Unsupported\n\t\tget env() { return {}; },\n\t\tcwd() { return '/'; }\n\t};\n}\n\n/**\n * Provides safe access to the `cwd` property in node.js, sandboxed or web\n * environments.\n *\n * Note: in web, this property is hardcoded to be `/`.\n *\n * @skipMangle\n */\nexport const cwd = safeProcess.cwd;\n\n/**\n * Provides safe access to the `env` property in node.js, sandboxed or web\n * environments.\n *\n * Note: in web, this property is hardcoded to be `{}`.\n */\nexport const env = safeProcess.env;\n\n/**\n * Provides safe access to the `platform` property in node.js, sandboxed or web\n * environments.\n */\nexport const platform = safeProcess.platform;\n\n/**\n * Provides safe access to the `arch` method in node.js, sandboxed or web\n * environments.\n * Note: `arch` is `undefined` in web\n */\nexport const arch = safeProcess.arch;\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n// NOTE: VSCode's copy of nodejs path library to be usable in common (non-node) namespace\n// Copied from: https://github.com/nodejs/node/commits/v22.15.0/lib/path.js\n// Excluding: the change that adds primordials\n// (https://github.com/nodejs/node/commit/187a862d221dec42fa9a5c4214e7034d9092792f and others)\n// Excluding: the change that adds glob matching\n// (https://github.com/nodejs/node/commit/57b8b8e18e5e2007114c63b71bf0baedc01936a6)\n\n/**\n * Copyright Joyent, Inc. and other Node contributors.\n *\n * Permission is hereby granted, free of charge, to any person obtaining a\n * copy of this software and associated documentation files (the\n * \"Software\"), to deal in the Software without restriction, including\n * without limitation the rights to use, copy, modify, merge, publish,\n * distribute, sublicense, and/or sell copies of the Software, and to permit\n * persons to whom the Software is furnished to do so, subject to the\n * following conditions:\n *\n * The above copyright notice and this permission notice shall be included\n * in all copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n * MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n * NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n * DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n * OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n * USE OR OTHER DEALINGS IN THE SOFTWARE.\n */\n\nimport * as process from './process.js';\n\nconst CHAR_UPPERCASE_A = 65;/* A */\nconst CHAR_LOWERCASE_A = 97; /* a */\nconst CHAR_UPPERCASE_Z = 90; /* Z */\nconst CHAR_LOWERCASE_Z = 122; /* z */\nconst CHAR_DOT = 46; /* . */\nconst CHAR_FORWARD_SLASH = 47; /* / */\nconst CHAR_BACKWARD_SLASH = 92; /* \\ */\nconst CHAR_COLON = 58; /* : */\nconst CHAR_QUESTION_MARK = 63; /* ? */\n\nclass ErrorInvalidArgType extends Error {\n\tcode: 'ERR_INVALID_ARG_TYPE';\n\tconstructor(name: string, expected: string, actual: unknown) {\n\t\t// determiner: 'must be' or 'must not be'\n\t\tlet determiner;\n\t\tif (typeof expected === 'string' && expected.indexOf('not ') === 0) {\n\t\t\tdeterminer = 'must not be';\n\t\t\texpected = expected.replace(/^not /, '');\n\t\t} else {\n\t\t\tdeterminer = 'must be';\n\t\t}\n\n\t\tconst type = name.indexOf('.') !== -1 ? 'property' : 'argument';\n\t\tlet msg = `The \"${name}\" ${type} ${determiner} of type ${expected}`;\n\n\t\tmsg += `. Received type ${typeof actual}`;\n\t\tsuper(msg);\n\n\t\tthis.code = 'ERR_INVALID_ARG_TYPE';\n\t}\n}\n\nfunction validateObject(pathObject: object, name: string) {\n\tif (pathObject === null || typeof pathObject !== 'object') {\n\t\tthrow new ErrorInvalidArgType(name, 'Object', pathObject);\n\t}\n}\n\nfunction validateString(value: string, name: string) {\n\tif (typeof value !== 'string') {\n\t\tthrow new ErrorInvalidArgType(name, 'string', value);\n\t}\n}\n\nconst platformIsWin32 = (process.platform === 'win32');\n\nfunction isPathSeparator(code: number | undefined) {\n\treturn code === CHAR_FORWARD_SLASH || code === CHAR_BACKWARD_SLASH;\n}\n\nfunction isPosixPathSeparator(code: number | undefined) {\n\treturn code === CHAR_FORWARD_SLASH;\n}\n\nfunction isWindowsDeviceRoot(code: number) {\n\treturn (code >= CHAR_UPPERCASE_A && code <= CHAR_UPPERCASE_Z) ||\n\t\t(code >= CHAR_LOWERCASE_A && code <= CHAR_LOWERCASE_Z);\n}\n\n// Resolves . and .. elements in a path with directory names\nfunction normalizeString(path: string, allowAboveRoot: boolean, separator: string, isPathSeparator: (code?: number) => boolean) {\n\tlet res = '';\n\tlet lastSegmentLength = 0;\n\tlet lastSlash = -1;\n\tlet dots = 0;\n\tlet code = 0;\n\tfor (let i = 0; i <= path.length; ++i) {\n\t\tif (i < path.length) {\n\t\t\tcode = path.charCodeAt(i);\n\t\t}\n\t\telse if (isPathSeparator(code)) {\n\t\t\tbreak;\n\t\t}\n\t\telse {\n\t\t\tcode = CHAR_FORWARD_SLASH;\n\t\t}\n\n\t\tif (isPathSeparator(code)) {\n\t\t\tif (lastSlash === i - 1 || dots === 1) {\n\t\t\t\t// NOOP\n\t\t\t} else if (dots === 2) {\n\t\t\t\tif (res.length < 2 || lastSegmentLength !== 2 ||\n\t\t\t\t\tres.charCodeAt(res.length - 1) !== CHAR_DOT ||\n\t\t\t\t\tres.charCodeAt(res.length - 2) !== CHAR_DOT) {\n\t\t\t\t\tif (res.length > 2) {\n\t\t\t\t\t\tconst lastSlashIndex = res.lastIndexOf(separator);\n\t\t\t\t\t\tif (lastSlashIndex === -1) {\n\t\t\t\t\t\t\tres = '';\n\t\t\t\t\t\t\tlastSegmentLength = 0;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tres = res.slice(0, lastSlashIndex);\n\t\t\t\t\t\t\tlastSegmentLength = res.length - 1 - res.lastIndexOf(separator);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tlastSlash = i;\n\t\t\t\t\t\tdots = 0;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t} else if (res.length !== 0) {\n\t\t\t\t\t\tres = '';\n\t\t\t\t\t\tlastSegmentLength = 0;\n\t\t\t\t\t\tlastSlash = i;\n\t\t\t\t\t\tdots = 0;\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (allowAboveRoot) {\n\t\t\t\t\tres += res.length > 0 ? `${separator}..` : '..';\n\t\t\t\t\tlastSegmentLength = 2;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tif (res.length > 0) {\n\t\t\t\t\tres += `${separator}${path.slice(lastSlash + 1, i)}`;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tres = path.slice(lastSlash + 1, i);\n\t\t\t\t}\n\t\t\t\tlastSegmentLength = i - lastSlash - 1;\n\t\t\t}\n\t\t\tlastSlash = i;\n\t\t\tdots = 0;\n\t\t} else if (code === CHAR_DOT && dots !== -1) {\n\t\t\t++dots;\n\t\t} else {\n\t\t\tdots = -1;\n\t\t}\n\t}\n\treturn res;\n}\n\nfunction formatExt(ext: string): string {\n\treturn ext ? `${ext[0] === '.' ? '' : '.'}${ext}` : '';\n}\n\nfunction _format(sep: string, pathObject: ParsedPath) {\n\tvalidateObject(pathObject, 'pathObject');\n\tconst dir = pathObject.dir || pathObject.root;\n\tconst base = pathObject.base ||\n\t\t`${pathObject.name || ''}${formatExt(pathObject.ext)}`;\n\tif (!dir) {\n\t\treturn base;\n\t}\n\treturn dir === pathObject.root ? `${dir}${base}` : `${dir}${sep}${base}`;\n}\n\nexport interface ParsedPath {\n\troot: string;\n\tdir: string;\n\tbase: string;\n\text: string;\n\tname: string;\n}\n\nexport interface IPath {\n\tnormalize(path: string): string;\n\tisAbsolute(path: string): boolean;\n\tjoin(...paths: string[]): string;\n\tresolve(...pathSegments: string[]): string;\n\trelative(from: string, to: string): string;\n\tdirname(path: string): string;\n\tbasename(path: string, suffix?: string): string;\n\textname(path: string): string;\n\tformat(pathObject: ParsedPath): string;\n\tparse(path: string): ParsedPath;\n\ttoNamespacedPath(path: string): string;\n\tsep: '\\\\' | '/';\n\tdelimiter: string;\n\twin32: IPath | null;\n\tposix: IPath | null;\n}\n\nexport const win32: IPath = {\n\t// path.resolve([from ...], to)\n\tresolve(...pathSegments: string[]): string {\n\t\tlet resolvedDevice = '';\n\t\tlet resolvedTail = '';\n\t\tlet resolvedAbsolute = false;\n\n\t\tfor (let i = pathSegments.length - 1; i >= -1; i--) {\n\t\t\tlet path;\n\t\t\tif (i >= 0) {\n\t\t\t\tpath = pathSegments[i];\n\t\t\t\tvalidateString(path, `paths[${i}]`);\n\n\t\t\t\t// Skip empty entries\n\t\t\t\tif (path.length === 0) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t} else if (resolvedDevice.length === 0) {\n\t\t\t\tpath = process.cwd();\n\t\t\t} else {\n\t\t\t\t// Windows has the concept of drive-specific current working\n\t\t\t\t// directories. If we've resolved a drive letter but not yet an\n\t\t\t\t// absolute path, get cwd for that drive, or the process cwd if\n\t\t\t\t// the drive cwd is not available. We're sure the device is not\n\t\t\t\t// a UNC path at this points, because UNC paths are always absolute.\n\t\t\t\tpath = process.env[`=${resolvedDevice}`] || process.cwd();\n\n\t\t\t\t// Verify that a cwd was found and that it actually points\n\t\t\t\t// to our drive. If not, default to the drive's root.\n\t\t\t\tif (path === undefined ||\n\t\t\t\t\t(path.slice(0, 2).toLowerCase() !== resolvedDevice.toLowerCase() &&\n\t\t\t\t\t\tpath.charCodeAt(2) === CHAR_BACKWARD_SLASH)) {\n\t\t\t\t\tpath = `${resolvedDevice}\\\\`;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst len = path.length;\n\t\t\tlet rootEnd = 0;\n\t\t\tlet device = '';\n\t\t\tlet isAbsolute = false;\n\t\t\tconst code = path.charCodeAt(0);\n\n\t\t\t// Try to match a root\n\t\t\tif (len === 1) {\n\t\t\t\tif (isPathSeparator(code)) {\n\t\t\t\t\t// `path` contains just a path separator\n\t\t\t\t\trootEnd = 1;\n\t\t\t\t\tisAbsolute = true;\n\t\t\t\t}\n\t\t\t} else if (isPathSeparator(code)) {\n\t\t\t\t// Possible UNC root\n\n\t\t\t\t// If we started with a separator, we know we at least have an\n\t\t\t\t// absolute path of some kind (UNC or otherwise)\n\t\t\t\tisAbsolute = true;\n\n\t\t\t\tif (isPathSeparator(path.charCodeAt(1))) {\n\t\t\t\t\t// Matched double path separator at beginning\n\t\t\t\t\tlet j = 2;\n\t\t\t\t\tlet last = j;\n\t\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\tj++;\n\t\t\t\t\t}\n\t\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t\tconst firstPart = path.slice(last, j);\n\t\t\t\t\t\t// Matched!\n\t\t\t\t\t\tlast = j;\n\t\t\t\t\t\t// Match 1 or more path separators\n\t\t\t\t\t\twhile (j < len && isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\t\tj++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t\t\t// Matched!\n\t\t\t\t\t\t\tlast = j;\n\t\t\t\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\t\t\tj++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\tif (j === len || j !== last) {\n\t\t\t\t\t\t\t\t// We matched a UNC root\n\t\t\t\t\t\t\t\tdevice = `\\\\\\\\${firstPart}\\\\${path.slice(last, j)}`;\n\t\t\t\t\t\t\t\trootEnd = j;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\trootEnd = 1;\n\t\t\t\t}\n\t\t\t} else if (isWindowsDeviceRoot(code) &&\n\t\t\t\tpath.charCodeAt(1) === CHAR_COLON) {\n\t\t\t\t// Possible device root\n\t\t\t\tdevice = path.slice(0, 2);\n\t\t\t\trootEnd = 2;\n\t\t\t\tif (len > 2 && isPathSeparator(path.charCodeAt(2))) {\n\t\t\t\t\t// Treat separator following drive name as an absolute path\n\t\t\t\t\t// indicator\n\t\t\t\t\tisAbsolute = true;\n\t\t\t\t\trootEnd = 3;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (device.length > 0) {\n\t\t\t\tif (resolvedDevice.length > 0) {\n\t\t\t\t\tif (device.toLowerCase() !== resolvedDevice.toLowerCase()) {\n\t\t\t\t\t\t// This path points to another device so it is not applicable\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tresolvedDevice = device;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (resolvedAbsolute) {\n\t\t\t\tif (resolvedDevice.length > 0) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tresolvedTail = `${path.slice(rootEnd)}\\\\${resolvedTail}`;\n\t\t\t\tresolvedAbsolute = isAbsolute;\n\t\t\t\tif (isAbsolute && resolvedDevice.length > 0) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// At this point the path should be resolved to a full absolute path,\n\t\t// but handle relative paths to be safe (might happen when process.cwd()\n\t\t// fails)\n\n\t\t// Normalize the tail path\n\t\tresolvedTail = normalizeString(resolvedTail, !resolvedAbsolute, '\\\\',\n\t\t\tisPathSeparator);\n\n\t\treturn resolvedAbsolute ?\n\t\t\t`${resolvedDevice}\\\\${resolvedTail}` :\n\t\t\t`${resolvedDevice}${resolvedTail}` || '.';\n\t},\n\n\tnormalize(path: string): string {\n\t\tvalidateString(path, 'path');\n\t\tconst len = path.length;\n\t\tif (len === 0) {\n\t\t\treturn '.';\n\t\t}\n\t\tlet rootEnd = 0;\n\t\tlet device;\n\t\tlet isAbsolute = false;\n\t\tconst code = path.charCodeAt(0);\n\n\t\t// Try to match a root\n\t\tif (len === 1) {\n\t\t\t// `path` contains just a single char, exit early to avoid\n\t\t\t// unnecessary work\n\t\t\treturn isPosixPathSeparator(code) ? '\\\\' : path;\n\t\t}\n\t\tif (isPathSeparator(code)) {\n\t\t\t// Possible UNC root\n\n\t\t\t// If we started with a separator, we know we at least have an absolute\n\t\t\t// path of some kind (UNC or otherwise)\n\t\t\tisAbsolute = true;\n\n\t\t\tif (isPathSeparator(path.charCodeAt(1))) {\n\t\t\t\t// Matched double path separator at beginning\n\t\t\t\tlet j = 2;\n\t\t\t\tlet last = j;\n\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\tj++;\n\t\t\t\t}\n\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\tconst firstPart = path.slice(last, j);\n\t\t\t\t\t// Matched!\n\t\t\t\t\tlast = j;\n\t\t\t\t\t// Match 1 or more path separators\n\t\t\t\t\twhile (j < len && isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\tj++;\n\t\t\t\t\t}\n\t\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t\t// Matched!\n\t\t\t\t\t\tlast = j;\n\t\t\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\t\tj++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j === len) {\n\t\t\t\t\t\t\t// We matched a UNC root only\n\t\t\t\t\t\t\t// Return the normalized version of the UNC root since there\n\t\t\t\t\t\t\t// is nothing left to process\n\t\t\t\t\t\t\treturn `\\\\\\\\${firstPart}\\\\${path.slice(last)}\\\\`;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j !== last) {\n\t\t\t\t\t\t\t// We matched a UNC root with leftovers\n\t\t\t\t\t\t\tdevice = `\\\\\\\\${firstPart}\\\\${path.slice(last, j)}`;\n\t\t\t\t\t\t\trootEnd = j;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trootEnd = 1;\n\t\t\t}\n\t\t} else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {\n\t\t\t// Possible device root\n\t\t\tdevice = path.slice(0, 2);\n\t\t\trootEnd = 2;\n\t\t\tif (len > 2 && isPathSeparator(path.charCodeAt(2))) {\n\t\t\t\t// Treat separator following drive name as an absolute path\n\t\t\t\t// indicator\n\t\t\t\tisAbsolute = true;\n\t\t\t\trootEnd = 3;\n\t\t\t}\n\t\t}\n\n\t\tlet tail = rootEnd < len ?\n\t\t\tnormalizeString(path.slice(rootEnd), !isAbsolute, '\\\\', isPathSeparator) :\n\t\t\t'';\n\t\tif (tail.length === 0 && !isAbsolute) {\n\t\t\ttail = '.';\n\t\t}\n\t\tif (tail.length > 0 && isPathSeparator(path.charCodeAt(len - 1))) {\n\t\t\ttail += '\\\\';\n\t\t}\n\t\tif (!isAbsolute && device === undefined && path.includes(':')) {\n\t\t\t// If the original path was not absolute and if we have not been able to\n\t\t\t// resolve it relative to a particular device, we need to ensure that the\n\t\t\t// `tail` has not become something that Windows might interpret as an\n\t\t\t// absolute path. See CVE-2024-36139.\n\t\t\tif (tail.length >= 2 &&\n\t\t\t\tisWindowsDeviceRoot(tail.charCodeAt(0)) &&\n\t\t\t\ttail.charCodeAt(1) === CHAR_COLON) {\n\t\t\t\treturn `.\\\\${tail}`;\n\t\t\t}\n\t\t\tlet index = path.indexOf(':');\n\t\t\tdo {\n\t\t\t\tif (index === len - 1 || isPathSeparator(path.charCodeAt(index + 1))) {\n\t\t\t\t\treturn `.\\\\${tail}`;\n\t\t\t\t}\n\t\t\t} while ((index = path.indexOf(':', index + 1)) !== -1);\n\t\t}\n\t\tif (device === undefined) {\n\t\t\treturn isAbsolute ? `\\\\${tail}` : tail;\n\t\t}\n\t\treturn isAbsolute ? `${device}\\\\${tail}` : `${device}${tail}`;\n\t},\n\n\tisAbsolute(path: string): boolean {\n\t\tvalidateString(path, 'path');\n\t\tconst len = path.length;\n\t\tif (len === 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst code = path.charCodeAt(0);\n\t\treturn isPathSeparator(code) ||\n\t\t\t// Possible device root\n\t\t\t(len > 2 &&\n\t\t\t\tisWindowsDeviceRoot(code) &&\n\t\t\t\tpath.charCodeAt(1) === CHAR_COLON &&\n\t\t\t\tisPathSeparator(path.charCodeAt(2)));\n\t},\n\n\tjoin(...paths: string[]): string {\n\t\tif (paths.length === 0) {\n\t\t\treturn '.';\n\t\t}\n\n\t\tlet joined;\n\t\tlet firstPart: string | undefined;\n\t\tfor (let i = 0; i < paths.length; ++i) {\n\t\t\tconst arg = paths[i];\n\t\t\tvalidateString(arg, 'path');\n\t\t\tif (arg.length > 0) {\n\t\t\t\tif (joined === undefined) {\n\t\t\t\t\tjoined = firstPart = arg;\n\t\t\t\t}\n\t\t\t\telse {\n\t\t\t\t\tjoined += `\\\\${arg}`;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (joined === undefined) {\n\t\t\treturn '.';\n\t\t}\n\n\t\t// Make sure that the joined path doesn't start with two slashes, because\n\t\t// normalize() will mistake it for a UNC path then.\n\t\t//\n\t\t// This step is skipped when it is very clear that the user actually\n\t\t// intended to point at a UNC path. This is assumed when the first\n\t\t// non-empty string arguments starts with exactly two slashes followed by\n\t\t// at least one more non-slash character.\n\t\t//\n\t\t// Note that for normalize() to treat a path as a UNC path it needs to\n\t\t// have at least 2 components, so we don't filter for that here.\n\t\t// This means that the user can use join to construct UNC paths from\n\t\t// a server name and a share name; for example:\n\t\t//   path.join('//server', 'share') -> '\\\\\\\\server\\\\share\\\\')\n\t\tlet needsReplace = true;\n\t\tlet slashCount = 0;\n\t\tif (typeof firstPart === 'string' && isPathSeparator(firstPart.charCodeAt(0))) {\n\t\t\t++slashCount;\n\t\t\tconst firstLen = firstPart.length;\n\t\t\tif (firstLen > 1 && isPathSeparator(firstPart.charCodeAt(1))) {\n\t\t\t\t++slashCount;\n\t\t\t\tif (firstLen > 2) {\n\t\t\t\t\tif (isPathSeparator(firstPart.charCodeAt(2))) {\n\t\t\t\t\t\t++slashCount;\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// We matched a UNC path in the first part\n\t\t\t\t\t\tneedsReplace = false;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (needsReplace) {\n\t\t\t// Find any more consecutive slashes we need to replace\n\t\t\twhile (slashCount < joined.length &&\n\t\t\t\tisPathSeparator(joined.charCodeAt(slashCount))) {\n\t\t\t\tslashCount++;\n\t\t\t}\n\n\t\t\t// Replace the slashes if needed\n\t\t\tif (slashCount >= 2) {\n\t\t\t\tjoined = `\\\\${joined.slice(slashCount)}`;\n\t\t\t}\n\t\t}\n\n\t\treturn win32.normalize(joined);\n\t},\n\n\n\t// It will solve the relative path from `from` to `to`, for instance:\n\t//  from = 'C:\\\\orandea\\\\test\\\\aaa'\n\t//  to = 'C:\\\\orandea\\\\impl\\\\bbb'\n\t// The output of the function should be: '..\\\\..\\\\impl\\\\bbb'\n\trelative(from: string, to: string): string {\n\t\tvalidateString(from, 'from');\n\t\tvalidateString(to, 'to');\n\n\t\tif (from === to) {\n\t\t\treturn '';\n\t\t}\n\n\t\tconst fromOrig = win32.resolve(from);\n\t\tconst toOrig = win32.resolve(to);\n\n\t\tif (fromOrig === toOrig) {\n\t\t\treturn '';\n\t\t}\n\n\t\tfrom = fromOrig.toLowerCase();\n\t\tto = toOrig.toLowerCase();\n\n\t\tif (from === to) {\n\t\t\treturn '';\n\t\t}\n\n\t\tif (fromOrig.length !== from.length || toOrig.length !== to.length) {\n\t\t\tconst fromSplit = fromOrig.split('\\\\');\n\t\t\tconst toSplit = toOrig.split('\\\\');\n\t\t\tif (fromSplit[fromSplit.length - 1] === '') {\n\t\t\t\tfromSplit.pop();\n\t\t\t}\n\t\t\tif (toSplit[toSplit.length - 1] === '') {\n\t\t\t\ttoSplit.pop();\n\t\t\t}\n\n\t\t\tconst fromLen = fromSplit.length;\n\t\t\tconst toLen = toSplit.length;\n\t\t\tconst length = fromLen < toLen ? fromLen : toLen;\n\n\t\t\tlet i;\n\t\t\tfor (i = 0; i < length; i++) {\n\t\t\t\tif (fromSplit[i].toLowerCase() !== toSplit[i].toLowerCase()) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (i === 0) {\n\t\t\t\treturn toOrig;\n\t\t\t} else if (i === length) {\n\t\t\t\tif (toLen > length) {\n\t\t\t\t\treturn toSplit.slice(i).join('\\\\');\n\t\t\t\t}\n\t\t\t\tif (fromLen > length) {\n\t\t\t\t\treturn '..\\\\'.repeat(fromLen - 1 - i) + '..';\n\t\t\t\t}\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\treturn '..\\\\'.repeat(fromLen - i) + toSplit.slice(i).join('\\\\');\n\t\t}\n\n\t\t// Trim any leading backslashes\n\t\tlet fromStart = 0;\n\t\twhile (fromStart < from.length &&\n\t\t\tfrom.charCodeAt(fromStart) === CHAR_BACKWARD_SLASH) {\n\t\t\tfromStart++;\n\t\t}\n\t\t// Trim trailing backslashes (applicable to UNC paths only)\n\t\tlet fromEnd = from.length;\n\t\twhile (fromEnd - 1 > fromStart &&\n\t\t\tfrom.charCodeAt(fromEnd - 1) === CHAR_BACKWARD_SLASH) {\n\t\t\tfromEnd--;\n\t\t}\n\t\tconst fromLen = fromEnd - fromStart;\n\n\t\t// Trim any leading backslashes\n\t\tlet toStart = 0;\n\t\twhile (toStart < to.length &&\n\t\t\tto.charCodeAt(toStart) === CHAR_BACKWARD_SLASH) {\n\t\t\ttoStart++;\n\t\t}\n\t\t// Trim trailing backslashes (applicable to UNC paths only)\n\t\tlet toEnd = to.length;\n\t\twhile (toEnd - 1 > toStart &&\n\t\t\tto.charCodeAt(toEnd - 1) === CHAR_BACKWARD_SLASH) {\n\t\t\ttoEnd--;\n\t\t}\n\t\tconst toLen = toEnd - toStart;\n\n\t\t// Compare paths to find the longest common path from root\n\t\tconst length = fromLen < toLen ? fromLen : toLen;\n\t\tlet lastCommonSep = -1;\n\t\tlet i = 0;\n\t\tfor (; i < length; i++) {\n\t\t\tconst fromCode = from.charCodeAt(fromStart + i);\n\t\t\tif (fromCode !== to.charCodeAt(toStart + i)) {\n\t\t\t\tbreak;\n\t\t\t} else if (fromCode === CHAR_BACKWARD_SLASH) {\n\t\t\t\tlastCommonSep = i;\n\t\t\t}\n\t\t}\n\n\t\t// We found a mismatch before the first common path separator was seen, so\n\t\t// return the original `to`.\n\t\tif (i !== length) {\n\t\t\tif (lastCommonSep === -1) {\n\t\t\t\treturn toOrig;\n\t\t\t}\n\t\t} else {\n\t\t\tif (toLen > length) {\n\t\t\t\tif (to.charCodeAt(toStart + i) === CHAR_BACKWARD_SLASH) {\n\t\t\t\t\t// We get here if `from` is the exact base path for `to`.\n\t\t\t\t\t// For example: from='C:\\\\foo\\\\bar'; to='C:\\\\foo\\\\bar\\\\baz'\n\t\t\t\t\treturn toOrig.slice(toStart + i + 1);\n\t\t\t\t}\n\t\t\t\tif (i === 2) {\n\t\t\t\t\t// We get here if `from` is the device root.\n\t\t\t\t\t// For example: from='C:\\\\'; to='C:\\\\foo'\n\t\t\t\t\treturn toOrig.slice(toStart + i);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (fromLen > length) {\n\t\t\t\tif (from.charCodeAt(fromStart + i) === CHAR_BACKWARD_SLASH) {\n\t\t\t\t\t// We get here if `to` is the exact base path for `from`.\n\t\t\t\t\t// For example: from='C:\\\\foo\\\\bar'; to='C:\\\\foo'\n\t\t\t\t\tlastCommonSep = i;\n\t\t\t\t} else if (i === 2) {\n\t\t\t\t\t// We get here if `to` is the device root.\n\t\t\t\t\t// For example: from='C:\\\\foo\\\\bar'; to='C:\\\\'\n\t\t\t\t\tlastCommonSep = 3;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (lastCommonSep === -1) {\n\t\t\t\tlastCommonSep = 0;\n\t\t\t}\n\t\t}\n\n\t\tlet out = '';\n\t\t// Generate the relative path based on the path difference between `to` and\n\t\t// `from`\n\t\tfor (i = fromStart + lastCommonSep + 1; i <= fromEnd; ++i) {\n\t\t\tif (i === fromEnd || from.charCodeAt(i) === CHAR_BACKWARD_SLASH) {\n\t\t\t\tout += out.length === 0 ? '..' : '\\\\..';\n\t\t\t}\n\t\t}\n\n\t\ttoStart += lastCommonSep;\n\n\t\t// Lastly, append the rest of the destination (`to`) path that comes after\n\t\t// the common path parts\n\t\tif (out.length > 0) {\n\t\t\treturn `${out}${toOrig.slice(toStart, toEnd)}`;\n\t\t}\n\n\t\tif (toOrig.charCodeAt(toStart) === CHAR_BACKWARD_SLASH) {\n\t\t\t++toStart;\n\t\t}\n\n\t\treturn toOrig.slice(toStart, toEnd);\n\t},\n\n\ttoNamespacedPath(path: string): string {\n\t\t// Note: this will *probably* throw somewhere.\n\t\tif (typeof path !== 'string' || path.length === 0) {\n\t\t\treturn path;\n\t\t}\n\n\t\tconst resolvedPath = win32.resolve(path);\n\n\t\tif (resolvedPath.length <= 2) {\n\t\t\treturn path;\n\t\t}\n\n\t\tif (resolvedPath.charCodeAt(0) === CHAR_BACKWARD_SLASH) {\n\t\t\t// Possible UNC root\n\t\t\tif (resolvedPath.charCodeAt(1) === CHAR_BACKWARD_SLASH) {\n\t\t\t\tconst code = resolvedPath.charCodeAt(2);\n\t\t\t\tif (code !== CHAR_QUESTION_MARK && code !== CHAR_DOT) {\n\t\t\t\t\t// Matched non-long UNC root, convert the path to a long UNC path\n\t\t\t\t\treturn `\\\\\\\\?\\\\UNC\\\\${resolvedPath.slice(2)}`;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (isWindowsDeviceRoot(resolvedPath.charCodeAt(0)) &&\n\t\t\tresolvedPath.charCodeAt(1) === CHAR_COLON &&\n\t\t\tresolvedPath.charCodeAt(2) === CHAR_BACKWARD_SLASH) {\n\t\t\t// Matched device root, convert the path to a long UNC path\n\t\t\treturn `\\\\\\\\?\\\\${resolvedPath}`;\n\t\t}\n\n\t\treturn resolvedPath;\n\t},\n\n\tdirname(path: string): string {\n\t\tvalidateString(path, 'path');\n\t\tconst len = path.length;\n\t\tif (len === 0) {\n\t\t\treturn '.';\n\t\t}\n\t\tlet rootEnd = -1;\n\t\tlet offset = 0;\n\t\tconst code = path.charCodeAt(0);\n\n\t\tif (len === 1) {\n\t\t\t// `path` contains just a path separator, exit early to avoid\n\t\t\t// unnecessary work or a dot.\n\t\t\treturn isPathSeparator(code) ? path : '.';\n\t\t}\n\n\t\t// Try to match a root\n\t\tif (isPathSeparator(code)) {\n\t\t\t// Possible UNC root\n\n\t\t\trootEnd = offset = 1;\n\n\t\t\tif (isPathSeparator(path.charCodeAt(1))) {\n\t\t\t\t// Matched double path separator at beginning\n\t\t\t\tlet j = 2;\n\t\t\t\tlet last = j;\n\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\tj++;\n\t\t\t\t}\n\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t// Matched!\n\t\t\t\t\tlast = j;\n\t\t\t\t\t// Match 1 or more path separators\n\t\t\t\t\twhile (j < len && isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\tj++;\n\t\t\t\t\t}\n\t\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t\t// Matched!\n\t\t\t\t\t\tlast = j;\n\t\t\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\t\tj++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j === len) {\n\t\t\t\t\t\t\t// We matched a UNC root only\n\t\t\t\t\t\t\treturn path;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j !== last) {\n\t\t\t\t\t\t\t// We matched a UNC root with leftovers\n\n\t\t\t\t\t\t\t// Offset by 1 to include the separator after the UNC root to\n\t\t\t\t\t\t\t// treat it as a \"normal root\" on top of a (UNC) root\n\t\t\t\t\t\t\trootEnd = offset = j + 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Possible device root\n\t\t} else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {\n\t\t\trootEnd = len > 2 && isPathSeparator(path.charCodeAt(2)) ? 3 : 2;\n\t\t\toffset = rootEnd;\n\t\t}\n\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tfor (let i = len - 1; i >= offset; --i) {\n\t\t\tif (isPathSeparator(path.charCodeAt(i))) {\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tend = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// We saw the first non-path separator\n\t\t\t\tmatchedSlash = false;\n\t\t\t}\n\t\t}\n\n\t\tif (end === -1) {\n\t\t\tif (rootEnd === -1) {\n\t\t\t\treturn '.';\n\t\t\t}\n\n\t\t\tend = rootEnd;\n\t\t}\n\t\treturn path.slice(0, end);\n\t},\n\n\tbasename(path: string, suffix?: string): string {\n\t\tif (suffix !== undefined) {\n\t\t\tvalidateString(suffix, 'suffix');\n\t\t}\n\t\tvalidateString(path, 'path');\n\t\tlet start = 0;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tlet i;\n\n\t\t// Check for a drive letter prefix so as not to mistake the following\n\t\t// path separator as an extra separator at the end of the path that can be\n\t\t// disregarded\n\t\tif (path.length >= 2 &&\n\t\t\tisWindowsDeviceRoot(path.charCodeAt(0)) &&\n\t\t\tpath.charCodeAt(1) === CHAR_COLON) {\n\t\t\tstart = 2;\n\t\t}\n\n\t\tif (suffix !== undefined && suffix.length > 0 && suffix.length <= path.length) {\n\t\t\tif (suffix === path) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\tlet extIdx = suffix.length - 1;\n\t\t\tlet firstNonSlashEnd = -1;\n\t\t\tfor (i = path.length - 1; i >= start; --i) {\n\t\t\t\tconst code = path.charCodeAt(i);\n\t\t\t\tif (isPathSeparator(code)) {\n\t\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\t\tstart = i + 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (firstNonSlashEnd === -1) {\n\t\t\t\t\t\t// We saw the first non-path separator, remember this index in case\n\t\t\t\t\t\t// we need it if the extension ends up not matching\n\t\t\t\t\t\tmatchedSlash = false;\n\t\t\t\t\t\tfirstNonSlashEnd = i + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif (extIdx >= 0) {\n\t\t\t\t\t\t// Try to match the explicit extension\n\t\t\t\t\t\tif (code === suffix.charCodeAt(extIdx)) {\n\t\t\t\t\t\t\tif (--extIdx === -1) {\n\t\t\t\t\t\t\t\t// We matched the extension, so mark this as the end of our path\n\t\t\t\t\t\t\t\t// component\n\t\t\t\t\t\t\t\tend = i;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Extension does not match, so our result is the entire path\n\t\t\t\t\t\t\t// component\n\t\t\t\t\t\t\textIdx = -1;\n\t\t\t\t\t\t\tend = firstNonSlashEnd;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (start === end) {\n\t\t\t\tend = firstNonSlashEnd;\n\t\t\t} else if (end === -1) {\n\t\t\t\tend = path.length;\n\t\t\t}\n\t\t\treturn path.slice(start, end);\n\t\t}\n\t\tfor (i = path.length - 1; i >= start; --i) {\n\t\t\tif (isPathSeparator(path.charCodeAt(i))) {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else if (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// path component\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t}\n\n\t\tif (end === -1) {\n\t\t\treturn '';\n\t\t}\n\t\treturn path.slice(start, end);\n\t},\n\n\textname(path: string): string {\n\t\tvalidateString(path, 'path');\n\t\tlet start = 0;\n\t\tlet startDot = -1;\n\t\tlet startPart = 0;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\t// Track the state of characters (if any) we see before our first dot and\n\t\t// after any path separator we find\n\t\tlet preDotState = 0;\n\n\t\t// Check for a drive letter prefix so as not to mistake the following\n\t\t// path separator as an extra separator at the end of the path that can be\n\t\t// disregarded\n\n\t\tif (path.length >= 2 &&\n\t\t\tpath.charCodeAt(1) === CHAR_COLON &&\n\t\t\tisWindowsDeviceRoot(path.charCodeAt(0))) {\n\t\t\tstart = startPart = 2;\n\t\t}\n\n\t\tfor (let i = path.length - 1; i >= start; --i) {\n\t\t\tconst code = path.charCodeAt(i);\n\t\t\tif (isPathSeparator(code)) {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstartPart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// extension\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t\tif (code === CHAR_DOT) {\n\t\t\t\t// If this is our first dot, mark it as the start of our extension\n\t\t\t\tif (startDot === -1) {\n\t\t\t\t\tstartDot = i;\n\t\t\t\t}\n\t\t\t\telse if (preDotState !== 1) {\n\t\t\t\t\tpreDotState = 1;\n\t\t\t\t}\n\t\t\t} else if (startDot !== -1) {\n\t\t\t\t// We saw a non-dot and non-path separator before our dot, so we should\n\t\t\t\t// have a good chance at having a non-empty extension\n\t\t\t\tpreDotState = -1;\n\t\t\t}\n\t\t}\n\n\t\tif (startDot === -1 ||\n\t\t\tend === -1 ||\n\t\t\t// We saw a non-dot character immediately before the dot\n\t\t\tpreDotState === 0 ||\n\t\t\t// The (right-most) trimmed path component is exactly '..'\n\t\t\t(preDotState === 1 &&\n\t\t\t\tstartDot === end - 1 &&\n\t\t\t\tstartDot === startPart + 1)) {\n\t\t\treturn '';\n\t\t}\n\t\treturn path.slice(startDot, end);\n\t},\n\n\tformat: _format.bind(null, '\\\\'),\n\n\tparse(path) {\n\t\tvalidateString(path, 'path');\n\n\t\tconst ret = { root: '', dir: '', base: '', ext: '', name: '' };\n\t\tif (path.length === 0) {\n\t\t\treturn ret;\n\t\t}\n\n\t\tconst len = path.length;\n\t\tlet rootEnd = 0;\n\t\tlet code = path.charCodeAt(0);\n\n\t\tif (len === 1) {\n\t\t\tif (isPathSeparator(code)) {\n\t\t\t\t// `path` contains just a path separator, exit early to avoid\n\t\t\t\t// unnecessary work\n\t\t\t\tret.root = ret.dir = path;\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\tret.base = ret.name = path;\n\t\t\treturn ret;\n\t\t}\n\t\t// Try to match a root\n\t\tif (isPathSeparator(code)) {\n\t\t\t// Possible UNC root\n\n\t\t\trootEnd = 1;\n\t\t\tif (isPathSeparator(path.charCodeAt(1))) {\n\t\t\t\t// Matched double path separator at beginning\n\t\t\t\tlet j = 2;\n\t\t\t\tlet last = j;\n\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\tj++;\n\t\t\t\t}\n\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t// Matched!\n\t\t\t\t\tlast = j;\n\t\t\t\t\t// Match 1 or more path separators\n\t\t\t\t\twhile (j < len && isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\tj++;\n\t\t\t\t\t}\n\t\t\t\t\tif (j < len && j !== last) {\n\t\t\t\t\t\t// Matched!\n\t\t\t\t\t\tlast = j;\n\t\t\t\t\t\t// Match 1 or more non-path separators\n\t\t\t\t\t\twhile (j < len && !isPathSeparator(path.charCodeAt(j))) {\n\t\t\t\t\t\t\tj++;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tif (j === len) {\n\t\t\t\t\t\t\t// We matched a UNC root only\n\t\t\t\t\t\t\trootEnd = j;\n\t\t\t\t\t\t} else if (j !== last) {\n\t\t\t\t\t\t\t// We matched a UNC root with leftovers\n\t\t\t\t\t\t\trootEnd = j + 1;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (isWindowsDeviceRoot(code) && path.charCodeAt(1) === CHAR_COLON) {\n\t\t\t// Possible device root\n\t\t\tif (len <= 2) {\n\t\t\t\t// `path` contains just a drive root, exit early to avoid\n\t\t\t\t// unnecessary work\n\t\t\t\tret.root = ret.dir = path;\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\trootEnd = 2;\n\t\t\tif (isPathSeparator(path.charCodeAt(2))) {\n\t\t\t\tif (len === 3) {\n\t\t\t\t\t// `path` contains just a drive root, exit early to avoid\n\t\t\t\t\t// unnecessary work\n\t\t\t\t\tret.root = ret.dir = path;\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t\trootEnd = 3;\n\t\t\t}\n\t\t}\n\t\tif (rootEnd > 0) {\n\t\t\tret.root = path.slice(0, rootEnd);\n\t\t}\n\n\t\tlet startDot = -1;\n\t\tlet startPart = rootEnd;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tlet i = path.length - 1;\n\n\t\t// Track the state of characters (if any) we see before our first dot and\n\t\t// after any path separator we find\n\t\tlet preDotState = 0;\n\n\t\t// Get non-dir info\n\t\tfor (; i >= rootEnd; --i) {\n\t\t\tcode = path.charCodeAt(i);\n\t\t\tif (isPathSeparator(code)) {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstartPart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// extension\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t\tif (code === CHAR_DOT) {\n\t\t\t\t// If this is our first dot, mark it as the start of our extension\n\t\t\t\tif (startDot === -1) {\n\t\t\t\t\tstartDot = i;\n\t\t\t\t} else if (preDotState !== 1) {\n\t\t\t\t\tpreDotState = 1;\n\t\t\t\t}\n\t\t\t} else if (startDot !== -1) {\n\t\t\t\t// We saw a non-dot and non-path separator before our dot, so we should\n\t\t\t\t// have a good chance at having a non-empty extension\n\t\t\t\tpreDotState = -1;\n\t\t\t}\n\t\t}\n\n\t\tif (end !== -1) {\n\t\t\tif (startDot === -1 ||\n\t\t\t\t// We saw a non-dot character immediately before the dot\n\t\t\t\tpreDotState === 0 ||\n\t\t\t\t// The (right-most) trimmed path component is exactly '..'\n\t\t\t\t(preDotState === 1 &&\n\t\t\t\t\tstartDot === end - 1 &&\n\t\t\t\t\tstartDot === startPart + 1)) {\n\t\t\t\tret.base = ret.name = path.slice(startPart, end);\n\t\t\t} else {\n\t\t\t\tret.name = path.slice(startPart, startDot);\n\t\t\t\tret.base = path.slice(startPart, end);\n\t\t\t\tret.ext = path.slice(startDot, end);\n\t\t\t}\n\t\t}\n\n\t\t// If the directory is the root, use the entire root as the `dir` including\n\t\t// the trailing slash if any (`C:\\abc` -> `C:\\`). Otherwise, strip out the\n\t\t// trailing slash (`C:\\abc\\def` -> `C:\\abc`).\n\t\tif (startPart > 0 && startPart !== rootEnd) {\n\t\t\tret.dir = path.slice(0, startPart - 1);\n\t\t} else {\n\t\t\tret.dir = ret.root;\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tsep: '\\\\',\n\tdelimiter: ';',\n\twin32: null,\n\tposix: null\n};\n\nconst posixCwd = (() => {\n\tif (platformIsWin32) {\n\t\t// Converts Windows' backslash path separators to POSIX forward slashes\n\t\t// and truncates any drive indicator\n\t\tconst regexp = /\\\\/g;\n\t\treturn () => {\n\t\t\tconst cwd = process.cwd().replace(regexp, '/');\n\t\t\treturn cwd.slice(cwd.indexOf('/'));\n\t\t};\n\t}\n\n\t// We're already on POSIX, no need for any transformations\n\treturn () => process.cwd();\n})();\n\nexport const posix: IPath = {\n\t// path.resolve([from ...], to)\n\tresolve(...pathSegments: string[]): string {\n\t\tlet resolvedPath = '';\n\t\tlet resolvedAbsolute = false;\n\n\t\tfor (let i = pathSegments.length - 1; i >= 0 && !resolvedAbsolute; i--) {\n\t\t\tconst path = pathSegments[i];\n\t\t\tvalidateString(path, `paths[${i}]`);\n\n\t\t\t// Skip empty entries\n\t\t\tif (path.length === 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tresolvedPath = `${path}/${resolvedPath}`;\n\t\t\tresolvedAbsolute = path.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t\t}\n\n\t\tif (!resolvedAbsolute) {\n\t\t\tconst cwd = posixCwd();\n\t\t\tresolvedPath = `${cwd}/${resolvedPath}`;\n\t\t\tresolvedAbsolute =\n\t\t\t\tcwd.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t\t}\n\n\t\t// At this point the path should be resolved to a full absolute path, but\n\t\t// handle relative paths to be safe (might happen when process.cwd() fails)\n\n\t\t// Normalize the path\n\t\tresolvedPath = normalizeString(resolvedPath, !resolvedAbsolute, '/',\n\t\t\tisPosixPathSeparator);\n\n\t\tif (resolvedAbsolute) {\n\t\t\treturn `/${resolvedPath}`;\n\t\t}\n\t\treturn resolvedPath.length > 0 ? resolvedPath : '.';\n\t},\n\n\tnormalize(path: string): string {\n\t\tvalidateString(path, 'path');\n\n\t\tif (path.length === 0) {\n\t\t\treturn '.';\n\t\t}\n\n\t\tconst isAbsolute = path.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t\tconst trailingSeparator =\n\t\t\tpath.charCodeAt(path.length - 1) === CHAR_FORWARD_SLASH;\n\n\t\t// Normalize the path\n\t\tpath = normalizeString(path, !isAbsolute, '/', isPosixPathSeparator);\n\n\t\tif (path.length === 0) {\n\t\t\tif (isAbsolute) {\n\t\t\t\treturn '/';\n\t\t\t}\n\t\t\treturn trailingSeparator ? './' : '.';\n\t\t}\n\t\tif (trailingSeparator) {\n\t\t\tpath += '/';\n\t\t}\n\n\t\treturn isAbsolute ? `/${path}` : path;\n\t},\n\n\tisAbsolute(path: string): boolean {\n\t\tvalidateString(path, 'path');\n\t\treturn path.length > 0 && path.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t},\n\n\tjoin(...paths: string[]): string {\n\t\tif (paths.length === 0) {\n\t\t\treturn '.';\n\t\t}\n\n\t\tconst path = [];\n\t\tfor (let i = 0; i < paths.length; ++i) {\n\t\t\tconst arg = paths[i];\n\t\t\tvalidateString(arg, 'path');\n\t\t\tif (arg.length > 0) {\n\t\t\t\tpath.push(arg);\n\t\t\t}\n\t\t}\n\n\t\tif (path.length === 0) {\n\t\t\treturn '.';\n\t\t}\n\n\t\treturn posix.normalize(path.join('/'));\n\t},\n\n\trelative(from: string, to: string): string {\n\t\tvalidateString(from, 'from');\n\t\tvalidateString(to, 'to');\n\n\t\tif (from === to) {\n\t\t\treturn '';\n\t\t}\n\n\t\t// Trim leading forward slashes.\n\t\tfrom = posix.resolve(from);\n\t\tto = posix.resolve(to);\n\n\t\tif (from === to) {\n\t\t\treturn '';\n\t\t}\n\n\t\tconst fromStart = 1;\n\t\tconst fromEnd = from.length;\n\t\tconst fromLen = fromEnd - fromStart;\n\t\tconst toStart = 1;\n\t\tconst toLen = to.length - toStart;\n\n\t\t// Compare paths to find the longest common path from root\n\t\tconst length = (fromLen < toLen ? fromLen : toLen);\n\t\tlet lastCommonSep = -1;\n\t\tlet i = 0;\n\t\tfor (; i < length; i++) {\n\t\t\tconst fromCode = from.charCodeAt(fromStart + i);\n\t\t\tif (fromCode !== to.charCodeAt(toStart + i)) {\n\t\t\t\tbreak;\n\t\t\t} else if (fromCode === CHAR_FORWARD_SLASH) {\n\t\t\t\tlastCommonSep = i;\n\t\t\t}\n\t\t}\n\t\tif (i === length) {\n\t\t\tif (toLen > length) {\n\t\t\t\tif (to.charCodeAt(toStart + i) === CHAR_FORWARD_SLASH) {\n\t\t\t\t\t// We get here if `from` is the exact base path for `to`.\n\t\t\t\t\t// For example: from='/foo/bar'; to='/foo/bar/baz'\n\t\t\t\t\treturn to.slice(toStart + i + 1);\n\t\t\t\t}\n\t\t\t\tif (i === 0) {\n\t\t\t\t\t// We get here if `from` is the root\n\t\t\t\t\t// For example: from='/'; to='/foo'\n\t\t\t\t\treturn to.slice(toStart + i);\n\t\t\t\t}\n\t\t\t} else if (fromLen > length) {\n\t\t\t\tif (from.charCodeAt(fromStart + i) === CHAR_FORWARD_SLASH) {\n\t\t\t\t\t// We get here if `to` is the exact base path for `from`.\n\t\t\t\t\t// For example: from='/foo/bar/baz'; to='/foo/bar'\n\t\t\t\t\tlastCommonSep = i;\n\t\t\t\t} else if (i === 0) {\n\t\t\t\t\t// We get here if `to` is the root.\n\t\t\t\t\t// For example: from='/foo/bar'; to='/'\n\t\t\t\t\tlastCommonSep = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tlet out = '';\n\t\t// Generate the relative path based on the path difference between `to`\n\t\t// and `from`.\n\t\tfor (i = fromStart + lastCommonSep + 1; i <= fromEnd; ++i) {\n\t\t\tif (i === fromEnd || from.charCodeAt(i) === CHAR_FORWARD_SLASH) {\n\t\t\t\tout += out.length === 0 ? '..' : '/..';\n\t\t\t}\n\t\t}\n\n\t\t// Lastly, append the rest of the destination (`to`) path that comes after\n\t\t// the common path parts.\n\t\treturn `${out}${to.slice(toStart + lastCommonSep)}`;\n\t},\n\n\ttoNamespacedPath(path: string): string {\n\t\t// Non-op on posix systems\n\t\treturn path;\n\t},\n\n\tdirname(path: string): string {\n\t\tvalidateString(path, 'path');\n\t\tif (path.length === 0) {\n\t\t\treturn '.';\n\t\t}\n\t\tconst hasRoot = path.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tfor (let i = path.length - 1; i >= 1; --i) {\n\t\t\tif (path.charCodeAt(i) === CHAR_FORWARD_SLASH) {\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tend = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// We saw the first non-path separator\n\t\t\t\tmatchedSlash = false;\n\t\t\t}\n\t\t}\n\n\t\tif (end === -1) {\n\t\t\treturn hasRoot ? '/' : '.';\n\t\t}\n\t\tif (hasRoot && end === 1) {\n\t\t\treturn '//';\n\t\t}\n\t\treturn path.slice(0, end);\n\t},\n\n\tbasename(path: string, suffix?: string): string {\n\t\tif (suffix !== undefined) {\n\t\t\tvalidateString(suffix, 'suffix');\n\t\t}\n\t\tvalidateString(path, 'path');\n\n\t\tlet start = 0;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tlet i;\n\n\t\tif (suffix !== undefined && suffix.length > 0 && suffix.length <= path.length) {\n\t\t\tif (suffix === path) {\n\t\t\t\treturn '';\n\t\t\t}\n\t\t\tlet extIdx = suffix.length - 1;\n\t\t\tlet firstNonSlashEnd = -1;\n\t\t\tfor (i = path.length - 1; i >= 0; --i) {\n\t\t\t\tconst code = path.charCodeAt(i);\n\t\t\t\tif (code === CHAR_FORWARD_SLASH) {\n\t\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\t\tstart = i + 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (firstNonSlashEnd === -1) {\n\t\t\t\t\t\t// We saw the first non-path separator, remember this index in case\n\t\t\t\t\t\t// we need it if the extension ends up not matching\n\t\t\t\t\t\tmatchedSlash = false;\n\t\t\t\t\t\tfirstNonSlashEnd = i + 1;\n\t\t\t\t\t}\n\t\t\t\t\tif (extIdx >= 0) {\n\t\t\t\t\t\t// Try to match the explicit extension\n\t\t\t\t\t\tif (code === suffix.charCodeAt(extIdx)) {\n\t\t\t\t\t\t\tif (--extIdx === -1) {\n\t\t\t\t\t\t\t\t// We matched the extension, so mark this as the end of our path\n\t\t\t\t\t\t\t\t// component\n\t\t\t\t\t\t\t\tend = i;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// Extension does not match, so our result is the entire path\n\t\t\t\t\t\t\t// component\n\t\t\t\t\t\t\textIdx = -1;\n\t\t\t\t\t\t\tend = firstNonSlashEnd;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (start === end) {\n\t\t\t\tend = firstNonSlashEnd;\n\t\t\t} else if (end === -1) {\n\t\t\t\tend = path.length;\n\t\t\t}\n\t\t\treturn path.slice(start, end);\n\t\t}\n\t\tfor (i = path.length - 1; i >= 0; --i) {\n\t\t\tif (path.charCodeAt(i) === CHAR_FORWARD_SLASH) {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else if (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// path component\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t}\n\n\t\tif (end === -1) {\n\t\t\treturn '';\n\t\t}\n\t\treturn path.slice(start, end);\n\t},\n\n\textname(path: string): string {\n\t\tvalidateString(path, 'path');\n\t\tlet startDot = -1;\n\t\tlet startPart = 0;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\t// Track the state of characters (if any) we see before our first dot and\n\t\t// after any path separator we find\n\t\tlet preDotState = 0;\n\t\tfor (let i = path.length - 1; i >= 0; --i) {\n\t\t\tconst char = path[i];\n\t\t\tif (char === '/') {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstartPart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// extension\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t\tif (char === '.') {\n\t\t\t\t// If this is our first dot, mark it as the start of our extension\n\t\t\t\tif (startDot === -1) {\n\t\t\t\t\tstartDot = i;\n\t\t\t\t}\n\t\t\t\telse if (preDotState !== 1) {\n\t\t\t\t\tpreDotState = 1;\n\t\t\t\t}\n\t\t\t} else if (startDot !== -1) {\n\t\t\t\t// We saw a non-dot and non-path separator before our dot, so we should\n\t\t\t\t// have a good chance at having a non-empty extension\n\t\t\t\tpreDotState = -1;\n\t\t\t}\n\t\t}\n\n\t\tif (startDot === -1 ||\n\t\t\tend === -1 ||\n\t\t\t// We saw a non-dot character immediately before the dot\n\t\t\tpreDotState === 0 ||\n\t\t\t// The (right-most) trimmed path component is exactly '..'\n\t\t\t(preDotState === 1 &&\n\t\t\t\tstartDot === end - 1 &&\n\t\t\t\tstartDot === startPart + 1)) {\n\t\t\treturn '';\n\t\t}\n\t\treturn path.slice(startDot, end);\n\t},\n\n\tformat: _format.bind(null, '/'),\n\n\tparse(path: string): ParsedPath {\n\t\tvalidateString(path, 'path');\n\n\t\tconst ret = { root: '', dir: '', base: '', ext: '', name: '' };\n\t\tif (path.length === 0) {\n\t\t\treturn ret;\n\t\t}\n\t\tconst isAbsolute = path.charCodeAt(0) === CHAR_FORWARD_SLASH;\n\t\tlet start;\n\t\tif (isAbsolute) {\n\t\t\tret.root = '/';\n\t\t\tstart = 1;\n\t\t} else {\n\t\t\tstart = 0;\n\t\t}\n\t\tlet startDot = -1;\n\t\tlet startPart = 0;\n\t\tlet end = -1;\n\t\tlet matchedSlash = true;\n\t\tlet i = path.length - 1;\n\n\t\t// Track the state of characters (if any) we see before our first dot and\n\t\t// after any path separator we find\n\t\tlet preDotState = 0;\n\n\t\t// Get non-dir info\n\t\tfor (; i >= start; --i) {\n\t\t\tconst code = path.charCodeAt(i);\n\t\t\tif (code === CHAR_FORWARD_SLASH) {\n\t\t\t\t// If we reached a path separator that was not part of a set of path\n\t\t\t\t// separators at the end of the string, stop now\n\t\t\t\tif (!matchedSlash) {\n\t\t\t\t\tstartPart = i + 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tif (end === -1) {\n\t\t\t\t// We saw the first non-path separator, mark this as the end of our\n\t\t\t\t// extension\n\t\t\t\tmatchedSlash = false;\n\t\t\t\tend = i + 1;\n\t\t\t}\n\t\t\tif (code === CHAR_DOT) {\n\t\t\t\t// If this is our first dot, mark it as the start of our extension\n\t\t\t\tif (startDot === -1) {\n\t\t\t\t\tstartDot = i;\n\t\t\t\t} else if (preDotState !== 1) {\n\t\t\t\t\tpreDotState = 1;\n\t\t\t\t}\n\t\t\t} else if (startDot !== -1) {\n\t\t\t\t// We saw a non-dot and non-path separator before our dot, so we should\n\t\t\t\t// have a good chance at having a non-empty extension\n\t\t\t\tpreDotState = -1;\n\t\t\t}\n\t\t}\n\n\t\tif (end !== -1) {\n\t\t\tconst start = startPart === 0 && isAbsolute ? 1 : startPart;\n\t\t\tif (startDot === -1 ||\n\t\t\t\t// We saw a non-dot character immediately before the dot\n\t\t\t\tpreDotState === 0 ||\n\t\t\t\t// The (right-most) trimmed path component is exactly '..'\n\t\t\t\t(preDotState === 1 &&\n\t\t\t\t\tstartDot === end - 1 &&\n\t\t\t\t\tstartDot === startPart + 1)) {\n\t\t\t\tret.base = ret.name = path.slice(start, end);\n\t\t\t} else {\n\t\t\t\tret.name = path.slice(start, startDot);\n\t\t\t\tret.base = path.slice(start, end);\n\t\t\t\tret.ext = path.slice(startDot, end);\n\t\t\t}\n\t\t}\n\n\t\tif (startPart > 0) {\n\t\t\tret.dir = path.slice(0, startPart - 1);\n\t\t} else if (isAbsolute) {\n\t\t\tret.dir = '/';\n\t\t}\n\n\t\treturn ret;\n\t},\n\n\tsep: '/',\n\tdelimiter: ':',\n\twin32: null,\n\tposix: null\n};\n\nposix.win32 = win32.win32 = win32;\nposix.posix = win32.posix = posix;\n\nexport const normalize = (platformIsWin32 ? win32.normalize : posix.normalize);\nexport const isAbsolute = (platformIsWin32 ? win32.isAbsolute : posix.isAbsolute);\nexport const join = (platformIsWin32 ? win32.join : posix.join);\nexport const resolve = (platformIsWin32 ? win32.resolve : posix.resolve);\nexport const relative = (platformIsWin32 ? win32.relative : posix.relative);\nexport const dirname = (platformIsWin32 ? win32.dirname : posix.dirname);\nexport const basename = (platformIsWin32 ? win32.basename : posix.basename);\nexport const extname = (platformIsWin32 ? win32.extname : posix.extname);\nexport const format = (platformIsWin32 ? win32.format : posix.format);\nexport const parse = (platformIsWin32 ? win32.parse : posix.parse);\nexport const toNamespacedPath = (platformIsWin32 ? win32.toNamespacedPath : posix.toNamespacedPath);\nexport const sep = (platformIsWin32 ? win32.sep : posix.sep);\nexport const delimiter = (platformIsWin32 ? win32.delimiter : posix.delimiter);\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CharCode } from './charCode.js';\nimport { MarshalledId } from './marshallingIds.js';\nimport * as paths from './path.js';\nimport { isWindows } from './platform.js';\n\nconst _schemePattern = /^\\w[\\w\\d+.-]*$/;\nconst _singleSlashStart = /^\\//;\nconst _doubleSlashStart = /^\\/\\//;\n\nfunction _validateUri(ret: URI, _strict?: boolean): void {\n\n\t// scheme, must be set\n\tif (!ret.scheme && _strict) {\n\t\tthrow new Error(`[UriError]: Scheme is missing: {scheme: \"\", authority: \"${ret.authority}\", path: \"${ret.path}\", query: \"${ret.query}\", fragment: \"${ret.fragment}\"}`);\n\t}\n\n\t// scheme, https://tools.ietf.org/html/rfc3986#section-3.1\n\t// ALPHA *( ALPHA / DIGIT / \"+\" / \"-\" / \".\" )\n\tif (ret.scheme && !_schemePattern.test(ret.scheme)) {\n\t\tthrow new Error('[UriError]: Scheme contains illegal characters.');\n\t}\n\n\t// path, http://tools.ietf.org/html/rfc3986#section-3.3\n\t// If a URI contains an authority component, then the path component\n\t// must either be empty or begin with a slash (\"/\") character.  If a URI\n\t// does not contain an authority component, then the path cannot begin\n\t// with two slash characters (\"//\").\n\tif (ret.path) {\n\t\tif (ret.authority) {\n\t\t\tif (!_singleSlashStart.test(ret.path)) {\n\t\t\t\tthrow new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash (\"/\") character');\n\t\t\t}\n\t\t} else {\n\t\t\tif (_doubleSlashStart.test(ret.path)) {\n\t\t\t\tthrow new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters (\"//\")');\n\t\t\t}\n\t\t}\n\t}\n}\n\n// for a while we allowed uris *without* schemes and this is the migration\n// for them, e.g. an uri without scheme and without strict-mode warns and falls\n// back to the file-scheme. that should cause the least carnage and still be a\n// clear warning\nfunction _schemeFix(scheme: string, _strict: boolean): string {\n\tif (!scheme && !_strict) {\n\t\treturn 'file';\n\t}\n\treturn scheme;\n}\n\n// implements a bit of https://tools.ietf.org/html/rfc3986#section-5\nfunction _referenceResolution(scheme: string, path: string): string {\n\n\t// the slash-character is our 'default base' as we don't\n\t// support constructing URIs relative to other URIs. This\n\t// also means that we alter and potentially break paths.\n\t// see https://tools.ietf.org/html/rfc3986#section-5.1.4\n\tswitch (scheme) {\n\t\tcase 'https':\n\t\tcase 'http':\n\t\tcase 'file':\n\t\t\tif (!path) {\n\t\t\t\tpath = _slash;\n\t\t\t} else if (path[0] !== _slash) {\n\t\t\t\tpath = _slash + path;\n\t\t\t}\n\t\t\tbreak;\n\t}\n\treturn path;\n}\n\nconst _empty = '';\nconst _slash = '/';\nconst _regexp = /^(([^:/?#]+?):)?(\\/\\/([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?/;\n\n/**\n * Uniform Resource Identifier (URI) http://tools.ietf.org/html/rfc3986.\n * This class is a simple parser which creates the basic component parts\n * (http://tools.ietf.org/html/rfc3986#section-3) with minimal validation\n * and encoding.\n *\n * ```txt\n *       foo://example.com:8042/over/there?name=ferret#nose\n *       \\_/   \\______________/\\_________/ \\_________/ \\__/\n *        |           |            |            |        |\n *     scheme     authority       path        query   fragment\n *        |   _____________________|__\n *       / \\ /                        \\\n *       urn:example:animal:ferret:nose\n * ```\n */\nexport class URI implements UriComponents {\n\n\tstatic isUri(thing: unknown): thing is URI {\n\t\tif (thing instanceof URI) {\n\t\t\treturn true;\n\t\t}\n\t\tif (!thing || typeof thing !== 'object') {\n\t\t\treturn false;\n\t\t}\n\t\treturn typeof (<URI>thing).authority === 'string'\n\t\t\t&& typeof (<URI>thing).fragment === 'string'\n\t\t\t&& typeof (<URI>thing).path === 'string'\n\t\t\t&& typeof (<URI>thing).query === 'string'\n\t\t\t&& typeof (<URI>thing).scheme === 'string'\n\t\t\t&& typeof (<URI>thing).fsPath === 'string'\n\t\t\t&& typeof (<URI>thing).with === 'function'\n\t\t\t&& typeof (<URI>thing).toString === 'function';\n\t}\n\n\t/**\n\t * scheme is the 'http' part of 'http://www.example.com/some/path?query#fragment'.\n\t * The part before the first colon.\n\t */\n\treadonly scheme: string;\n\n\t/**\n\t * authority is the 'www.example.com' part of 'http://www.example.com/some/path?query#fragment'.\n\t * The part between the first double slashes and the next slash.\n\t */\n\treadonly authority: string;\n\n\t/**\n\t * path is the '/some/path' part of 'http://www.example.com/some/path?query#fragment'.\n\t */\n\treadonly path: string;\n\n\t/**\n\t * query is the 'query' part of 'http://www.example.com/some/path?query#fragment'.\n\t */\n\treadonly query: string;\n\n\t/**\n\t * fragment is the 'fragment' part of 'http://www.example.com/some/path?query#fragment'.\n\t */\n\treadonly fragment: string;\n\n\t/**\n\t * @internal\n\t */\n\tprotected constructor(scheme: string, authority?: string, path?: string, query?: string, fragment?: string, _strict?: boolean);\n\n\t/**\n\t * @internal\n\t */\n\tprotected constructor(components: UriComponents);\n\n\t/**\n\t * @internal\n\t */\n\tprotected constructor(schemeOrData: string | UriComponents, authority?: string, path?: string, query?: string, fragment?: string, _strict: boolean = false) {\n\n\t\tif (typeof schemeOrData === 'object') {\n\t\t\tthis.scheme = schemeOrData.scheme || _empty;\n\t\t\tthis.authority = schemeOrData.authority || _empty;\n\t\t\tthis.path = schemeOrData.path || _empty;\n\t\t\tthis.query = schemeOrData.query || _empty;\n\t\t\tthis.fragment = schemeOrData.fragment || _empty;\n\t\t\t// no validation because it's this URI\n\t\t\t// that creates uri components.\n\t\t\t// _validateUri(this);\n\t\t} else {\n\t\t\tthis.scheme = _schemeFix(schemeOrData, _strict);\n\t\t\tthis.authority = authority || _empty;\n\t\t\tthis.path = _referenceResolution(this.scheme, path || _empty);\n\t\t\tthis.query = query || _empty;\n\t\t\tthis.fragment = fragment || _empty;\n\n\t\t\t_validateUri(this, _strict);\n\t\t}\n\t}\n\n\t// ---- filesystem path -----------------------\n\n\t/**\n\t * Returns a string representing the corresponding file system path of this URI.\n\t * Will handle UNC paths, normalizes windows drive letters to lower-case, and uses the\n\t * platform specific path separator.\n\t *\n\t * * Will *not* validate the path for invalid characters and semantics.\n\t * * Will *not* look at the scheme of this URI.\n\t * * The result shall *not* be used for display purposes but for accessing a file on disk.\n\t *\n\t *\n\t * The *difference* to `URI#path` is the use of the platform specific separator and the handling\n\t * of UNC paths. See the below sample of a file-uri with an authority (UNC path).\n\t *\n\t * ```ts\n\t\tconst u = URI.parse('file://server/c$/folder/file.txt')\n\t\tu.authority === 'server'\n\t\tu.path === '/shares/c$/file.txt'\n\t\tu.fsPath === '\\\\server\\c$\\folder\\file.txt'\n\t```\n\t *\n\t * Using `URI#path` to read a file (using fs-apis) would not be enough because parts of the path,\n\t * namely the server name, would be missing. Therefore `URI#fsPath` exists - it's sugar to ease working\n\t * with URIs that represent files on disk (`file` scheme).\n\t */\n\tget fsPath(): string {\n\t\t// if (this.scheme !== 'file') {\n\t\t// \tconsole.warn(`[UriError] calling fsPath with scheme ${this.scheme}`);\n\t\t// }\n\t\treturn uriToFsPath(this, false);\n\t}\n\n\t// ---- modify to new -------------------------\n\n\twith(change: { scheme?: string; authority?: string | null; path?: string | null; query?: string | null; fragment?: string | null }): URI {\n\n\t\tif (!change) {\n\t\t\treturn this;\n\t\t}\n\n\t\tlet { scheme, authority, path, query, fragment } = change;\n\t\tif (scheme === undefined) {\n\t\t\tscheme = this.scheme;\n\t\t} else if (scheme === null) {\n\t\t\tscheme = _empty;\n\t\t}\n\t\tif (authority === undefined) {\n\t\t\tauthority = this.authority;\n\t\t} else if (authority === null) {\n\t\t\tauthority = _empty;\n\t\t}\n\t\tif (path === undefined) {\n\t\t\tpath = this.path;\n\t\t} else if (path === null) {\n\t\t\tpath = _empty;\n\t\t}\n\t\tif (query === undefined) {\n\t\t\tquery = this.query;\n\t\t} else if (query === null) {\n\t\t\tquery = _empty;\n\t\t}\n\t\tif (fragment === undefined) {\n\t\t\tfragment = this.fragment;\n\t\t} else if (fragment === null) {\n\t\t\tfragment = _empty;\n\t\t}\n\n\t\tif (scheme === this.scheme\n\t\t\t&& authority === this.authority\n\t\t\t&& path === this.path\n\t\t\t&& query === this.query\n\t\t\t&& fragment === this.fragment) {\n\n\t\t\treturn this;\n\t\t}\n\n\t\treturn new Uri(scheme, authority, path, query, fragment);\n\t}\n\n\t// ---- parse & validate ------------------------\n\n\t/**\n\t * Creates a new URI from a string, e.g. `http://www.example.com/some/path`,\n\t * `file:///usr/home`, or `scheme:with/path`.\n\t *\n\t * @param value A string which represents an URI (see `URI#toString`).\n\t */\n\tstatic parse(value: string, _strict: boolean = false): URI {\n\t\tconst match = _regexp.exec(value);\n\t\tif (!match) {\n\t\t\treturn new Uri(_empty, _empty, _empty, _empty, _empty);\n\t\t}\n\t\treturn new Uri(\n\t\t\tmatch[2] || _empty,\n\t\t\tpercentDecode(match[4] || _empty),\n\t\t\tpercentDecode(match[5] || _empty),\n\t\t\tpercentDecode(match[7] || _empty),\n\t\t\tpercentDecode(match[9] || _empty),\n\t\t\t_strict\n\t\t);\n\t}\n\n\t/**\n\t * Creates a new URI from a file system path, e.g. `c:\\my\\files`,\n\t * `/usr/home`, or `\\\\server\\share\\some\\path`.\n\t *\n\t * The *difference* between `URI#parse` and `URI#file` is that the latter treats the argument\n\t * as path, not as stringified-uri. E.g. `URI.file(path)` is **not the same as**\n\t * `URI.parse('file://' + path)` because the path might contain characters that are\n\t * interpreted (# and ?). See the following sample:\n\t * ```ts\n\tconst good = URI.file('/coding/c#/project1');\n\tgood.scheme === 'file';\n\tgood.path === '/coding/c#/project1';\n\tgood.fragment === '';\n\tconst bad = URI.parse('file://' + '/coding/c#/project1');\n\tbad.scheme === 'file';\n\tbad.path === '/coding/c'; // path is now broken\n\tbad.fragment === '/project1';\n\t```\n\t *\n\t * @param path A file system path (see `URI#fsPath`)\n\t */\n\tstatic file(path: string): URI {\n\n\t\tlet authority = _empty;\n\n\t\t// normalize to fwd-slashes on windows,\n\t\t// on other systems bwd-slashes are valid\n\t\t// filename character, eg /f\\oo/ba\\r.txt\n\t\tif (isWindows) {\n\t\t\tpath = path.replace(/\\\\/g, _slash);\n\t\t}\n\n\t\t// check for authority as used in UNC shares\n\t\t// or use the path as given\n\t\tif (path[0] === _slash && path[1] === _slash) {\n\t\t\tconst idx = path.indexOf(_slash, 2);\n\t\t\tif (idx === -1) {\n\t\t\t\tauthority = path.substring(2);\n\t\t\t\tpath = _slash;\n\t\t\t} else {\n\t\t\t\tauthority = path.substring(2, idx);\n\t\t\t\tpath = path.substring(idx) || _slash;\n\t\t\t}\n\t\t}\n\n\t\treturn new Uri('file', authority, path, _empty, _empty);\n\t}\n\n\t/**\n\t * Creates new URI from uri components.\n\t *\n\t * Unless `strict` is `true` the scheme is defaults to be `file`. This function performs\n\t * validation and should be used for untrusted uri components retrieved from storage,\n\t * user input, command arguments etc\n\t */\n\tstatic from(components: UriComponents, strict?: boolean): URI {\n\t\tconst result = new Uri(\n\t\t\tcomponents.scheme,\n\t\t\tcomponents.authority,\n\t\t\tcomponents.path,\n\t\t\tcomponents.query,\n\t\t\tcomponents.fragment,\n\t\t\tstrict\n\t\t);\n\t\treturn result;\n\t}\n\n\t/**\n\t * Join a URI path with path fragments and normalizes the resulting path.\n\t *\n\t * @param uri The input URI.\n\t * @param pathFragment The path fragment to add to the URI path.\n\t * @returns The resulting URI.\n\t */\n\tstatic joinPath(uri: URI, ...pathFragment: string[]): URI {\n\t\tif (!uri.path) {\n\t\t\tthrow new Error(`[UriError]: cannot call joinPath on URI without path`);\n\t\t}\n\t\tlet newPath: string;\n\t\tif (isWindows && uri.scheme === 'file') {\n\t\t\tnewPath = URI.file(paths.win32.join(uriToFsPath(uri, true), ...pathFragment)).path;\n\t\t} else {\n\t\t\tnewPath = paths.posix.join(uri.path, ...pathFragment);\n\t\t}\n\t\treturn uri.with({ path: newPath });\n\t}\n\n\t// ---- printing/externalize ---------------------------\n\n\t/**\n\t * Creates a string representation for this URI. It's guaranteed that calling\n\t * `URI.parse` with the result of this function creates an URI which is equal\n\t * to this URI.\n\t *\n\t * * The result shall *not* be used for display purposes but for externalization or transport.\n\t * * The result will be encoded using the percentage encoding and encoding happens mostly\n\t * ignore the scheme-specific encoding rules.\n\t *\n\t * @param skipEncoding Do not encode the result, default is `false`\n\t */\n\ttoString(skipEncoding: boolean = false): string {\n\t\treturn _asFormatted(this, skipEncoding);\n\t}\n\n\ttoJSON(): UriComponents {\n\t\treturn this;\n\t}\n\n\t/**\n\t * A helper function to revive URIs.\n\t *\n\t * **Note** that this function should only be used when receiving URI#toJSON generated data\n\t * and that it doesn't do any validation. Use {@link URI.from} when received \"untrusted\"\n\t * uri components such as command arguments or data from storage.\n\t *\n\t * @param data The URI components or URI to revive.\n\t * @returns The revived URI or undefined or null.\n\t */\n\tstatic revive(data: UriComponents | URI): URI;\n\tstatic revive(data: UriComponents | URI | undefined): URI | undefined;\n\tstatic revive(data: UriComponents | URI | null): URI | null;\n\tstatic revive(data: UriComponents | URI | undefined | null): URI | undefined | null;\n\tstatic revive(data: UriComponents | URI | undefined | null): URI | undefined | null {\n\t\tif (!data) {\n\t\t\treturn data;\n\t\t} else if (data instanceof URI) {\n\t\t\treturn data;\n\t\t} else {\n\t\t\tconst result = new Uri(data);\n\t\t\tresult._formatted = (<UriState>data).external ?? null;\n\t\t\tresult._fsPath = (<UriState>data)._sep === _pathSepMarker ? (<UriState>data).fsPath ?? null : null;\n\t\t\treturn result;\n\t\t}\n\t}\n\n\t[Symbol.for('debug.description')]() {\n\t\treturn `URI(${this.toString()})`;\n\t}\n}\n\nexport interface UriComponents {\n\tscheme: string;\n\tauthority?: string;\n\tpath?: string;\n\tquery?: string;\n\tfragment?: string;\n}\n\nexport function isUriComponents(thing: unknown): thing is UriComponents {\n\tif (!thing || typeof thing !== 'object') {\n\t\treturn false;\n\t}\n\treturn typeof (<UriComponents>thing).scheme === 'string'\n\t\t&& (typeof (<UriComponents>thing).authority === 'string' || typeof (<UriComponents>thing).authority === 'undefined')\n\t\t&& (typeof (<UriComponents>thing).path === 'string' || typeof (<UriComponents>thing).path === 'undefined')\n\t\t&& (typeof (<UriComponents>thing).query === 'string' || typeof (<UriComponents>thing).query === 'undefined')\n\t\t&& (typeof (<UriComponents>thing).fragment === 'string' || typeof (<UriComponents>thing).fragment === 'undefined');\n}\n\ninterface UriState extends UriComponents {\n\t$mid: MarshalledId.Uri;\n\texternal?: string;\n\tfsPath?: string;\n\t_sep?: 1;\n}\n\nconst _pathSepMarker = isWindows ? 1 : undefined;\n\n// This class exists so that URI is compatible with vscode.Uri (API).\nclass Uri extends URI {\n\n\t_formatted: string | null = null;\n\t_fsPath: string | null = null;\n\n\toverride get fsPath(): string {\n\t\tif (!this._fsPath) {\n\t\t\tthis._fsPath = uriToFsPath(this, false);\n\t\t}\n\t\treturn this._fsPath;\n\t}\n\n\toverride toString(skipEncoding: boolean = false): string {\n\t\tif (!skipEncoding) {\n\t\t\tif (!this._formatted) {\n\t\t\t\tthis._formatted = _asFormatted(this, false);\n\t\t\t}\n\t\t\treturn this._formatted;\n\t\t} else {\n\t\t\t// we don't cache that\n\t\t\treturn _asFormatted(this, true);\n\t\t}\n\t}\n\n\toverride toJSON(): UriComponents {\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\tconst res = <UriState>{\n\t\t\t$mid: MarshalledId.Uri\n\t\t};\n\t\t// cached state\n\t\tif (this._fsPath) {\n\t\t\tres.fsPath = this._fsPath;\n\t\t\tres._sep = _pathSepMarker;\n\t\t}\n\t\tif (this._formatted) {\n\t\t\tres.external = this._formatted;\n\t\t}\n\t\t//--- uri components\n\t\tif (this.path) {\n\t\t\tres.path = this.path;\n\t\t}\n\t\t// TODO\n\t\t// this isn't correct and can violate the UriComponents contract but\n\t\t// this is part of the vscode.Uri API and we shouldn't change how that\n\t\t// works anymore\n\t\tif (this.scheme) {\n\t\t\tres.scheme = this.scheme;\n\t\t}\n\t\tif (this.authority) {\n\t\t\tres.authority = this.authority;\n\t\t}\n\t\tif (this.query) {\n\t\t\tres.query = this.query;\n\t\t}\n\t\tif (this.fragment) {\n\t\t\tres.fragment = this.fragment;\n\t\t}\n\t\treturn res;\n\t}\n}\n\n// reserved characters: https://tools.ietf.org/html/rfc3986#section-2.2\nconst encodeTable: { [ch: number]: string } = {\n\t[CharCode.Colon]: '%3A', // gen-delims\n\t[CharCode.Slash]: '%2F',\n\t[CharCode.QuestionMark]: '%3F',\n\t[CharCode.Hash]: '%23',\n\t[CharCode.OpenSquareBracket]: '%5B',\n\t[CharCode.CloseSquareBracket]: '%5D',\n\t[CharCode.AtSign]: '%40',\n\n\t[CharCode.ExclamationMark]: '%21', // sub-delims\n\t[CharCode.DollarSign]: '%24',\n\t[CharCode.Ampersand]: '%26',\n\t[CharCode.SingleQuote]: '%27',\n\t[CharCode.OpenParen]: '%28',\n\t[CharCode.CloseParen]: '%29',\n\t[CharCode.Asterisk]: '%2A',\n\t[CharCode.Plus]: '%2B',\n\t[CharCode.Comma]: '%2C',\n\t[CharCode.Semicolon]: '%3B',\n\t[CharCode.Equals]: '%3D',\n\n\t[CharCode.Space]: '%20',\n};\n\nfunction encodeURIComponentFast(uriComponent: string, isPath: boolean, isAuthority: boolean): string {\n\tlet res: string | undefined = undefined;\n\tlet nativeEncodePos = -1;\n\n\tfor (let pos = 0; pos < uriComponent.length; pos++) {\n\t\tconst code = uriComponent.charCodeAt(pos);\n\n\t\t// unreserved characters: https://tools.ietf.org/html/rfc3986#section-2.3\n\t\tif (\n\t\t\t(code >= CharCode.a && code <= CharCode.z)\n\t\t\t|| (code >= CharCode.A && code <= CharCode.Z)\n\t\t\t|| (code >= CharCode.Digit0 && code <= CharCode.Digit9)\n\t\t\t|| code === CharCode.Dash\n\t\t\t|| code === CharCode.Period\n\t\t\t|| code === CharCode.Underline\n\t\t\t|| code === CharCode.Tilde\n\t\t\t|| (isPath && code === CharCode.Slash)\n\t\t\t|| (isAuthority && code === CharCode.OpenSquareBracket)\n\t\t\t|| (isAuthority && code === CharCode.CloseSquareBracket)\n\t\t\t|| (isAuthority && code === CharCode.Colon)\n\t\t) {\n\t\t\t// check if we are delaying native encode\n\t\t\tif (nativeEncodePos !== -1) {\n\t\t\t\tres += encodeURIComponent(uriComponent.substring(nativeEncodePos, pos));\n\t\t\t\tnativeEncodePos = -1;\n\t\t\t}\n\t\t\t// check if we write into a new string (by default we try to return the param)\n\t\t\tif (res !== undefined) {\n\t\t\t\tres += uriComponent.charAt(pos);\n\t\t\t}\n\n\t\t} else {\n\t\t\t// encoding needed, we need to allocate a new string\n\t\t\tif (res === undefined) {\n\t\t\t\tres = uriComponent.substr(0, pos);\n\t\t\t}\n\n\t\t\t// check with default table first\n\t\t\tconst escaped = encodeTable[code];\n\t\t\tif (escaped !== undefined) {\n\n\t\t\t\t// check if we are delaying native encode\n\t\t\t\tif (nativeEncodePos !== -1) {\n\t\t\t\t\tres += encodeURIComponent(uriComponent.substring(nativeEncodePos, pos));\n\t\t\t\t\tnativeEncodePos = -1;\n\t\t\t\t}\n\n\t\t\t\t// append escaped variant to result\n\t\t\t\tres += escaped;\n\n\t\t\t} else if (nativeEncodePos === -1) {\n\t\t\t\t// use native encode only when needed\n\t\t\t\tnativeEncodePos = pos;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (nativeEncodePos !== -1) {\n\t\tres += encodeURIComponent(uriComponent.substring(nativeEncodePos));\n\t}\n\n\treturn res !== undefined ? res : uriComponent;\n}\n\nfunction encodeURIComponentMinimal(path: string): string {\n\tlet res: string | undefined = undefined;\n\tfor (let pos = 0; pos < path.length; pos++) {\n\t\tconst code = path.charCodeAt(pos);\n\t\tif (code === CharCode.Hash || code === CharCode.QuestionMark) {\n\t\t\tif (res === undefined) {\n\t\t\t\tres = path.substr(0, pos);\n\t\t\t}\n\t\t\tres += encodeTable[code];\n\t\t} else {\n\t\t\tif (res !== undefined) {\n\t\t\t\tres += path[pos];\n\t\t\t}\n\t\t}\n\t}\n\treturn res !== undefined ? res : path;\n}\n\n/**\n * Compute `fsPath` for the given uri\n */\nexport function uriToFsPath(uri: URI, keepDriveLetterCasing: boolean): string {\n\n\tlet value: string;\n\tif (uri.authority && uri.path.length > 1 && uri.scheme === 'file') {\n\t\t// unc path: file://shares/c$/far/boo\n\t\tvalue = `//${uri.authority}${uri.path}`;\n\t} else if (\n\t\turi.path.charCodeAt(0) === CharCode.Slash\n\t\t&& (uri.path.charCodeAt(1) >= CharCode.A && uri.path.charCodeAt(1) <= CharCode.Z || uri.path.charCodeAt(1) >= CharCode.a && uri.path.charCodeAt(1) <= CharCode.z)\n\t\t&& uri.path.charCodeAt(2) === CharCode.Colon\n\t) {\n\t\tif (!keepDriveLetterCasing) {\n\t\t\t// windows drive letter: file:///c:/far/boo\n\t\t\tvalue = uri.path[1].toLowerCase() + uri.path.substr(2);\n\t\t} else {\n\t\t\tvalue = uri.path.substr(1);\n\t\t}\n\t} else {\n\t\t// other path\n\t\tvalue = uri.path;\n\t}\n\tif (isWindows) {\n\t\tvalue = value.replace(/\\//g, '\\\\');\n\t}\n\treturn value;\n}\n\n/**\n * Create the external version of a uri\n */\nfunction _asFormatted(uri: URI, skipEncoding: boolean): string {\n\n\tconst encoder = !skipEncoding\n\t\t? encodeURIComponentFast\n\t\t: encodeURIComponentMinimal;\n\n\tlet res = '';\n\tlet { scheme, authority, path, query, fragment } = uri;\n\tif (scheme) {\n\t\tres += scheme;\n\t\tres += ':';\n\t}\n\tif (authority || scheme === 'file') {\n\t\tres += _slash;\n\t\tres += _slash;\n\t}\n\tif (authority) {\n\t\tlet idx = authority.indexOf('@');\n\t\tif (idx !== -1) {\n\t\t\t// <user>@<auth>\n\t\t\tconst userinfo = authority.substr(0, idx);\n\t\t\tauthority = authority.substr(idx + 1);\n\t\t\tidx = userinfo.lastIndexOf(':');\n\t\t\tif (idx === -1) {\n\t\t\t\tres += encoder(userinfo, false, false);\n\t\t\t} else {\n\t\t\t\t// <user>:<pass>@<auth>\n\t\t\t\tres += encoder(userinfo.substr(0, idx), false, false);\n\t\t\t\tres += ':';\n\t\t\t\tres += encoder(userinfo.substr(idx + 1), false, true);\n\t\t\t}\n\t\t\tres += '@';\n\t\t}\n\t\tauthority = authority.toLowerCase();\n\t\tidx = authority.lastIndexOf(':');\n\t\tif (idx === -1) {\n\t\t\tres += encoder(authority, false, true);\n\t\t} else {\n\t\t\t// <auth>:<port>\n\t\t\tres += encoder(authority.substr(0, idx), false, true);\n\t\t\tres += authority.substr(idx);\n\t\t}\n\t}\n\tif (path) {\n\t\t// lower-case windows drive letters in /C:/fff or C:/fff\n\t\tif (path.length >= 3 && path.charCodeAt(0) === CharCode.Slash && path.charCodeAt(2) === CharCode.Colon) {\n\t\t\tconst code = path.charCodeAt(1);\n\t\t\tif (code >= CharCode.A && code <= CharCode.Z) {\n\t\t\t\tpath = `/${String.fromCharCode(code + 32)}:${path.substr(3)}`; // \"/c:\".length === 3\n\t\t\t}\n\t\t} else if (path.length >= 2 && path.charCodeAt(1) === CharCode.Colon) {\n\t\t\tconst code = path.charCodeAt(0);\n\t\t\tif (code >= CharCode.A && code <= CharCode.Z) {\n\t\t\t\tpath = `${String.fromCharCode(code + 32)}:${path.substr(2)}`; // \"/c:\".length === 3\n\t\t\t}\n\t\t}\n\t\t// encode the rest of the path\n\t\tres += encoder(path, true, false);\n\t}\n\tif (query) {\n\t\tres += '?';\n\t\tres += encoder(query, false, false);\n\t}\n\tif (fragment) {\n\t\tres += '#';\n\t\tres += !skipEncoding ? encodeURIComponentFast(fragment, false, false) : fragment;\n\t}\n\treturn res;\n}\n\n// --- decode\n\nfunction decodeURIComponentGraceful(str: string): string {\n\ttry {\n\t\treturn decodeURIComponent(str);\n\t} catch {\n\t\tif (str.length > 3) {\n\t\t\treturn str.substr(0, 3) + decodeURIComponentGraceful(str.substr(3));\n\t\t} else {\n\t\t\treturn str;\n\t\t}\n\t}\n}\n\nconst _rEncodedAsHex = /(%[0-9A-Za-z][0-9A-Za-z])+/g;\n\nfunction percentDecode(str: string): string {\n\tif (!str.match(_rEncodedAsHex)) {\n\t\treturn str;\n\t}\n\treturn str.replace(_rEncodedAsHex, (match) => decodeURIComponentGraceful(match));\n}\n\n/**\n * Mapped-type that replaces all occurrences of URI with UriComponents\n */\nexport type UriDto<T> = { [K in keyof T]: T[K] extends URI\n\t? UriComponents\n\t: UriDto<T[K]> };\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from './buffer.js';\nimport { MarshalledObject } from './marshalling.js';\nimport { MarshalledId } from './marshallingIds.js';\nimport { URI, UriComponents } from './uri.js';\n\nexport interface IURITransformer {\n\ttransformIncoming(uri: UriComponents): UriComponents;\n\ttransformOutgoing(uri: UriComponents): UriComponents;\n\ttransformOutgoingURI(uri: URI): URI;\n\ttransformOutgoingScheme(scheme: string): string;\n}\n\nexport interface UriParts {\n\tscheme: string;\n\tauthority?: string;\n\tpath?: string;\n\tquery?: string;\n\tfragment?: string;\n}\n\nexport interface IRawURITransformer {\n\ttransformIncoming(uri: UriParts): UriParts;\n\ttransformOutgoing(uri: UriParts): UriParts;\n\ttransformOutgoingScheme(scheme: string): string;\n}\n\nfunction toJSON(uri: URI): UriComponents {\n\treturn uri.toJSON();\n}\n\nexport class URITransformer implements IURITransformer {\n\n\tprivate readonly _uriTransformer: IRawURITransformer;\n\n\tconstructor(uriTransformer: IRawURITransformer) {\n\t\tthis._uriTransformer = uriTransformer;\n\t}\n\n\tpublic transformIncoming(uri: UriComponents): UriComponents {\n\t\tconst result = this._uriTransformer.transformIncoming(uri);\n\t\treturn (result === uri ? uri : toJSON(URI.from(result)));\n\t}\n\n\tpublic transformOutgoing(uri: UriComponents): UriComponents {\n\t\tconst result = this._uriTransformer.transformOutgoing(uri);\n\t\treturn (result === uri ? uri : toJSON(URI.from(result)));\n\t}\n\n\tpublic transformOutgoingURI(uri: URI): URI {\n\t\tconst result = this._uriTransformer.transformOutgoing(uri);\n\t\treturn (result === uri ? uri : URI.from(result));\n\t}\n\n\tpublic transformOutgoingScheme(scheme: string): string {\n\t\treturn this._uriTransformer.transformOutgoingScheme(scheme);\n\t}\n}\n\nexport const DefaultURITransformer: IURITransformer = new class {\n\ttransformIncoming(uri: UriComponents) {\n\t\treturn uri;\n\t}\n\n\ttransformOutgoing(uri: UriComponents): UriComponents {\n\t\treturn uri;\n\t}\n\n\ttransformOutgoingURI(uri: URI): URI {\n\t\treturn uri;\n\t}\n\n\ttransformOutgoingScheme(scheme: string): string {\n\t\treturn scheme;\n\t}\n};\n\nfunction _transformOutgoingURIs(obj: any, transformer: IURITransformer, depth: number): any {\n\n\tif (!obj || depth > 200) {\n\t\treturn null;\n\t}\n\n\tif (typeof obj === 'object') {\n\t\tif (obj instanceof URI) {\n\t\t\treturn transformer.transformOutgoing(obj);\n\t\t}\n\n\t\t// walk object (or array)\n\t\tfor (const key in obj) {\n\t\t\tif (Object.hasOwnProperty.call(obj, key)) {\n\t\t\t\tconst r = _transformOutgoingURIs(obj[key], transformer, depth + 1);\n\t\t\t\tif (r !== null) {\n\t\t\t\t\tobj[key] = r;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn null;\n}\n\nexport function transformOutgoingURIs<T>(obj: T, transformer: IURITransformer): T {\n\tconst result = _transformOutgoingURIs(obj, transformer, 0);\n\tif (result === null) {\n\t\t// no change\n\t\treturn obj;\n\t}\n\treturn result;\n}\n\n\nfunction _transformIncomingURIs(obj: any, transformer: IURITransformer, revive: boolean, depth: number): any {\n\n\tif (!obj || depth > 200) {\n\t\treturn null;\n\t}\n\n\tif (typeof obj === 'object') {\n\n\t\tif ((<MarshalledObject>obj).$mid === MarshalledId.Uri) {\n\t\t\treturn revive ? URI.revive(transformer.transformIncoming(obj)) : transformer.transformIncoming(obj);\n\t\t}\n\n\t\tif (obj instanceof VSBuffer) {\n\t\t\treturn null;\n\t\t}\n\n\t\t// walk object (or array)\n\t\tfor (const key in obj) {\n\t\t\tif (Object.hasOwnProperty.call(obj, key)) {\n\t\t\t\tconst r = _transformIncomingURIs(obj[key], transformer, revive, depth + 1);\n\t\t\t\tif (r !== null) {\n\t\t\t\t\tobj[key] = r;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn null;\n}\n\nexport function transformIncomingURIs<T>(obj: T, transformer: IURITransformer): T {\n\tconst result = _transformIncomingURIs(obj, transformer, false, 0);\n\tif (result === null) {\n\t\t// no change\n\t\treturn obj;\n\t}\n\treturn result;\n}\n\nexport function transformAndReviveIncomingURIs<T>(obj: T, transformer: IURITransformer): T {\n\tconst result = _transformIncomingURIs(obj, transformer, true, 0);\n\tif (result === null) {\n\t\t// no change\n\t\treturn obj;\n\t}\n\treturn result;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nclass Node<E> {\n\n\tstatic readonly Undefined = new Node<unknown>(undefined);\n\n\telement: E;\n\tnext: Node<E> | typeof Node.Undefined;\n\tprev: Node<E> | typeof Node.Undefined;\n\n\tconstructor(element: E) {\n\t\tthis.element = element;\n\t\tthis.next = Node.Undefined;\n\t\tthis.prev = Node.Undefined;\n\t}\n}\n\nexport class LinkedList<E> {\n\n\tprivate _first: Node<E> | typeof Node.Undefined = Node.Undefined;\n\tprivate _last: Node<E> | typeof Node.Undefined = Node.Undefined;\n\tprivate _size: number = 0;\n\n\tget size(): number {\n\t\treturn this._size;\n\t}\n\n\tisEmpty(): boolean {\n\t\treturn this._first === Node.Undefined;\n\t}\n\n\tclear(): void {\n\t\tlet node = this._first;\n\t\twhile (node !== Node.Undefined) {\n\t\t\tconst next = node.next;\n\t\t\tnode.prev = Node.Undefined;\n\t\t\tnode.next = Node.Undefined;\n\t\t\tnode = next;\n\t\t}\n\n\t\tthis._first = Node.Undefined;\n\t\tthis._last = Node.Undefined;\n\t\tthis._size = 0;\n\t}\n\n\tunshift(element: E): () => void {\n\t\treturn this._insert(element, false);\n\t}\n\n\tpush(element: E): () => void {\n\t\treturn this._insert(element, true);\n\t}\n\n\tprivate _insert(element: E, atTheEnd: boolean): () => void {\n\t\tconst newNode = new Node(element);\n\t\tif (this._first === Node.Undefined) {\n\t\t\tthis._first = newNode;\n\t\t\tthis._last = newNode;\n\n\t\t} else if (atTheEnd) {\n\t\t\t// push\n\t\t\tconst oldLast = this._last;\n\t\t\tthis._last = newNode;\n\t\t\tnewNode.prev = oldLast;\n\t\t\toldLast.next = newNode;\n\n\t\t} else {\n\t\t\t// unshift\n\t\t\tconst oldFirst = this._first;\n\t\t\tthis._first = newNode;\n\t\t\tnewNode.next = oldFirst;\n\t\t\toldFirst.prev = newNode;\n\t\t}\n\t\tthis._size += 1;\n\n\t\tlet didRemove = false;\n\t\treturn () => {\n\t\t\tif (!didRemove) {\n\t\t\t\tdidRemove = true;\n\t\t\t\tthis._remove(newNode);\n\t\t\t}\n\t\t};\n\t}\n\n\tshift(): E | undefined {\n\t\tif (this._first === Node.Undefined) {\n\t\t\treturn undefined;\n\t\t} else {\n\t\t\tconst res = this._first.element;\n\t\t\tthis._remove(this._first);\n\t\t\treturn res as E;\n\t\t}\n\t}\n\n\tpop(): E | undefined {\n\t\tif (this._last === Node.Undefined) {\n\t\t\treturn undefined;\n\t\t} else {\n\t\t\tconst res = this._last.element;\n\t\t\tthis._remove(this._last);\n\t\t\treturn res as E;\n\t\t}\n\t}\n\n\tpeek(): E | undefined {\n\t\tif (this._last === Node.Undefined) {\n\t\t\treturn undefined;\n\t\t} else {\n\t\t\tconst res = this._last.element;\n\t\t\treturn res as E;\n\t\t}\n\t}\n\n\tprivate _remove(node: Node<E> | typeof Node.Undefined): void {\n\t\tif (node.prev !== Node.Undefined && node.next !== Node.Undefined) {\n\t\t\t// middle\n\t\t\tconst anchor = node.prev;\n\t\t\tanchor.next = node.next;\n\t\t\tnode.next.prev = anchor;\n\n\t\t} else if (node.prev === Node.Undefined && node.next === Node.Undefined) {\n\t\t\t// only node\n\t\t\tthis._first = Node.Undefined;\n\t\t\tthis._last = Node.Undefined;\n\n\t\t} else if (node.next === Node.Undefined) {\n\t\t\t// last\n\t\t\tthis._last = this._last.prev!;\n\t\t\tthis._last.next = Node.Undefined;\n\n\t\t} else if (node.prev === Node.Undefined) {\n\t\t\t// first\n\t\t\tthis._first = this._first.next!;\n\t\t\tthis._first.prev = Node.Undefined;\n\t\t}\n\n\t\t// done\n\t\tthis._size -= 1;\n\t}\n\n\t*[Symbol.iterator](): Iterator<E> {\n\t\tlet node = this._first;\n\t\twhile (node !== Node.Undefined) {\n\t\t\tyield node.element as E;\n\t\t\tnode = node.next;\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\ndeclare const globalThis: { performance: { now(): number } };\nconst performanceNow = globalThis.performance.now.bind(globalThis.performance);\n\nexport class StopWatch {\n\n\tprivate _startTime: number;\n\tprivate _stopTime: number;\n\n\tprivate readonly _now: () => number;\n\n\tpublic static create(highResolution?: boolean): StopWatch {\n\t\treturn new StopWatch(highResolution);\n\t}\n\n\tconstructor(highResolution?: boolean) {\n\t\tthis._now = highResolution === false ? Date.now : performanceNow;\n\t\tthis._startTime = this._now();\n\t\tthis._stopTime = -1;\n\t}\n\n\tpublic stop(): void {\n\t\tthis._stopTime = this._now();\n\t}\n\n\tpublic reset(): void {\n\t\tthis._startTime = this._now();\n\t\tthis._stopTime = -1;\n\t}\n\n\tpublic elapsed(): number {\n\t\tif (this._stopTime !== -1) {\n\t\t\treturn this._stopTime - this._startTime;\n\t\t}\n\t\treturn this._now() - this._startTime;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancelablePromise } from './async.js';\nimport { CancellationToken } from './cancellation.js';\nimport { diffSets } from './collections.js';\nimport { onUnexpectedError } from './errors.js';\nimport { createSingleCallFunction } from './functional.js';\nimport { combinedDisposable, Disposable, DisposableMap, DisposableStore, IDisposable, toDisposable } from './lifecycle.js';\nimport { LinkedList } from './linkedList.js';\nimport { IObservable, IObservableWithChange, IObserver } from './observable.js';\nimport { StopWatch } from './stopwatch.js';\nimport { MicrotaskDelay } from './symbols.js';\n\n\n// -----------------------------------------------------------------------------------------------------------------------\n// Uncomment the next line to print warnings whenever an emitter with listeners is disposed. That is a sign of code smell.\n// -----------------------------------------------------------------------------------------------------------------------\nconst _enableDisposeWithListenerWarning = false\n\t// || Boolean(\"TRUE\") // causes a linter warning so that it cannot be pushed\n\t;\n\n\n// -----------------------------------------------------------------------------------------------------------------------\n// Uncomment the next line to print warnings whenever a snapshotted event is used repeatedly without cleanup.\n// See https://github.com/microsoft/vscode/issues/142851\n// -----------------------------------------------------------------------------------------------------------------------\nconst _enableSnapshotPotentialLeakWarning = false\n\t// || Boolean(\"TRUE\") // causes a linter warning so that it cannot be pushed\n\t;\n\n/**\n * An event with zero or one parameters that can be subscribed to. The event is a function itself.\n */\nexport interface Event<T> {\n\t(listener: (e: T) => unknown, thisArgs?: any, disposables?: IDisposable[] | DisposableStore): IDisposable;\n}\n\nexport namespace Event {\n\texport const None: Event<any> = () => Disposable.None;\n\n\tfunction _addLeakageTraceLogic(options: EmitterOptions) {\n\t\tif (_enableSnapshotPotentialLeakWarning) {\n\t\t\tconst { onDidAddListener: origListenerDidAdd } = options;\n\t\t\tconst stack = Stacktrace.create();\n\t\t\tlet count = 0;\n\t\t\toptions.onDidAddListener = () => {\n\t\t\t\tif (++count === 2) {\n\t\t\t\t\tconsole.warn('snapshotted emitter LIKELY used public and SHOULD HAVE BEEN created with DisposableStore. snapshotted here');\n\t\t\t\t\tstack.print();\n\t\t\t\t}\n\t\t\t\torigListenerDidAdd?.();\n\t\t\t};\n\t\t}\n\t}\n\n\t/**\n\t * Given an event, returns another event which debounces calls and defers the listeners to a later task via a shared\n\t * `setTimeout`. The event is converted into a signal (`Event<void>`) to avoid additional object creation as a\n\t * result of merging events and to try prevent race conditions that could arise when using related deferred and\n\t * non-deferred events.\n\t *\n\t * This is useful for deferring non-critical work (eg. general UI updates) to ensure it does not block critical work\n\t * (eg. latency of keypress to text rendered).\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param flushOnListenerRemove Whether to fire all debounced events when a listener is removed. If this is not\n\t * specified, some events could go missing. Use this if it's important that all events are processed, even if the\n\t * listener gets disposed before the debounced event fires.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function defer(event: Event<unknown>, flushOnListenerRemove?: boolean, disposable?: DisposableStore): Event<void> {\n\t\treturn debounce<unknown, void>(event, () => void 0, 0, undefined, flushOnListenerRemove ?? true, undefined, disposable);\n\t}\n\n\t/**\n\t * Given an event, returns another event which only fires once.\n\t *\n\t * @param event The event source for the new event.\n\t */\n\texport function once<T>(event: Event<T>): Event<T> {\n\t\treturn (listener, thisArgs = null, disposables?) => {\n\t\t\t// we need this, in case the event fires during the listener call\n\t\t\tlet didFire = false;\n\t\t\tlet result: IDisposable | undefined = undefined;\n\t\t\tresult = event(e => {\n\t\t\t\tif (didFire) {\n\t\t\t\t\treturn;\n\t\t\t\t} else if (result) {\n\t\t\t\t\tresult.dispose();\n\t\t\t\t} else {\n\t\t\t\t\tdidFire = true;\n\t\t\t\t}\n\n\t\t\t\treturn listener.call(thisArgs, e);\n\t\t\t}, null, disposables);\n\n\t\t\tif (didFire) {\n\t\t\t\tresult.dispose();\n\t\t\t}\n\n\t\t\treturn result;\n\t\t};\n\t}\n\n\t/**\n\t * Given an event, returns another event which only fires once, and only when the condition is met.\n\t *\n\t * @param event The event source for the new event.\n\t */\n\texport function onceIf<T>(event: Event<T>, condition: (e: T) => boolean): Event<T> {\n\t\treturn Event.once(Event.filter(event, condition));\n\t}\n\n\t/**\n\t * Maps an event of one type into an event of another type using a mapping function, similar to how\n\t * `Array.prototype.map` works.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param map The mapping function.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function map<I, O>(event: Event<I>, map: (i: I) => O, disposable?: DisposableStore): Event<O> {\n\t\treturn snapshot((listener, thisArgs = null, disposables?) => event(i => listener.call(thisArgs, map(i)), null, disposables), disposable);\n\t}\n\n\t/**\n\t * Wraps an event in another event that performs some function on the event object before firing.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param each The function to perform on the event object.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function forEach<I>(event: Event<I>, each: (i: I) => void, disposable?: DisposableStore): Event<I> {\n\t\treturn snapshot((listener, thisArgs = null, disposables?) => event(i => { each(i); listener.call(thisArgs, i); }, null, disposables), disposable);\n\t}\n\n\t/**\n\t * Wraps an event in another event that fires only when some condition is met.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param filter The filter function that defines the condition. The event will fire for the object if this function\n\t * returns true.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function filter<T, U>(event: Event<T | U>, filter: (e: T | U) => e is T, disposable?: DisposableStore): Event<T>;\n\texport function filter<T>(event: Event<T>, filter: (e: T) => boolean, disposable?: DisposableStore): Event<T>;\n\texport function filter<T, R>(event: Event<T | R>, filter: (e: T | R) => e is R, disposable?: DisposableStore): Event<R>;\n\texport function filter<T>(event: Event<T>, filter: (e: T) => boolean, disposable?: DisposableStore): Event<T> {\n\t\treturn snapshot((listener, thisArgs = null, disposables?) => event(e => filter(e) && listener.call(thisArgs, e), null, disposables), disposable);\n\t}\n\n\t/**\n\t * Given an event, returns the same event but typed as `Event<void>`.\n\t */\n\texport function signal<T>(event: Event<T>): Event<void> {\n\t\treturn event as Event<any> as Event<void>;\n\t}\n\n\t/**\n\t * Given a collection of events, returns a single event which emits whenever any of the provided events emit.\n\t */\n\texport function any<T>(...events: Event<T>[]): Event<T>;\n\texport function any(...events: Event<any>[]): Event<void>;\n\texport function any<T>(...events: Event<T>[]): Event<T> {\n\t\treturn (listener, thisArgs = null, disposables?) => {\n\t\t\tconst disposable = combinedDisposable(...events.map(event => event(e => listener.call(thisArgs, e))));\n\t\t\treturn addAndReturnDisposable(disposable, disposables);\n\t\t};\n\t}\n\n\t/**\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t */\n\texport function reduce<I, O>(event: Event<I>, merge: (last: O | undefined, event: I) => O, initial?: O, disposable?: DisposableStore): Event<O> {\n\t\tlet output: O | undefined = initial;\n\n\t\treturn map<I, O>(event, e => {\n\t\t\toutput = merge(output, e);\n\t\t\treturn output;\n\t\t}, disposable);\n\t}\n\n\tfunction snapshot<T>(event: Event<T>, disposable: DisposableStore | undefined): Event<T> {\n\t\tlet listener: IDisposable | undefined;\n\n\t\tconst options: EmitterOptions | undefined = {\n\t\t\tonWillAddFirstListener() {\n\t\t\t\tlistener = event(emitter.fire, emitter);\n\t\t\t},\n\t\t\tonDidRemoveLastListener() {\n\t\t\t\tlistener?.dispose();\n\t\t\t}\n\t\t};\n\n\t\tif (!disposable) {\n\t\t\t_addLeakageTraceLogic(options);\n\t\t}\n\n\t\tconst emitter = new Emitter<T>(options);\n\n\t\tdisposable?.add(emitter);\n\n\t\treturn emitter.event;\n\t}\n\n\t/**\n\t * Adds the IDisposable to the store if it's set, and returns it. Useful to\n\t * Event function implementation.\n\t */\n\tfunction addAndReturnDisposable<T extends IDisposable>(d: T, store: DisposableStore | IDisposable[] | undefined): T {\n\t\tif (store instanceof Array) {\n\t\t\tstore.push(d);\n\t\t} else if (store) {\n\t\t\tstore.add(d);\n\t\t}\n\t\treturn d;\n\t}\n\n\t/**\n\t * Given an event, creates a new emitter that event that will debounce events based on {@link delay} and give an\n\t * array event object of all events that fired.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The original event to debounce.\n\t * @param merge A function that reduces all events into a single event.\n\t * @param delay The number of milliseconds to debounce.\n\t * @param leading Whether to fire a leading event without debouncing.\n\t * @param flushOnListenerRemove Whether to fire all debounced events when a listener is removed. If this is not\n\t * specified, some events could go missing. Use this if it's important that all events are processed, even if the\n\t * listener gets disposed before the debounced event fires.\n\t * @param leakWarningThreshold See {@link EmitterOptions.leakWarningThreshold}.\n\t * @param disposable A disposable store to register the debounce emitter to.\n\t */\n\texport function debounce<T>(event: Event<T>, merge: (last: T | undefined, event: T) => T, delay?: number | typeof MicrotaskDelay, leading?: boolean, flushOnListenerRemove?: boolean, leakWarningThreshold?: number, disposable?: DisposableStore): Event<T>;\n\texport function debounce<I, O>(event: Event<I>, merge: (last: O | undefined, event: I) => O, delay?: number | typeof MicrotaskDelay, leading?: boolean, flushOnListenerRemove?: boolean, leakWarningThreshold?: number, disposable?: DisposableStore): Event<O>;\n\texport function debounce<I, O>(event: Event<I>, merge: (last: O | undefined, event: I) => O, delay: number | typeof MicrotaskDelay = 100, leading = false, flushOnListenerRemove = false, leakWarningThreshold?: number, disposable?: DisposableStore): Event<O> {\n\t\tlet subscription: IDisposable;\n\t\tlet output: O | undefined = undefined;\n\t\tlet handle: Timeout | undefined | null = undefined;\n\t\tlet numDebouncedCalls = 0;\n\t\tlet doFire: (() => void) | undefined;\n\n\t\tconst options: EmitterOptions | undefined = {\n\t\t\tleakWarningThreshold,\n\t\t\tonWillAddFirstListener() {\n\t\t\t\tsubscription = event(cur => {\n\t\t\t\t\tnumDebouncedCalls++;\n\t\t\t\t\toutput = merge(output, cur);\n\n\t\t\t\t\tif (leading && !handle) {\n\t\t\t\t\t\temitter.fire(output);\n\t\t\t\t\t\toutput = undefined;\n\t\t\t\t\t}\n\n\t\t\t\t\tdoFire = () => {\n\t\t\t\t\t\tconst _output = output;\n\t\t\t\t\t\toutput = undefined;\n\t\t\t\t\t\thandle = undefined;\n\t\t\t\t\t\tif (!leading || numDebouncedCalls > 1) {\n\t\t\t\t\t\t\temitter.fire(_output!);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tnumDebouncedCalls = 0;\n\t\t\t\t\t};\n\n\t\t\t\t\tif (typeof delay === 'number') {\n\t\t\t\t\t\tif (handle) {\n\t\t\t\t\t\t\tclearTimeout(handle);\n\t\t\t\t\t\t}\n\t\t\t\t\t\thandle = setTimeout(doFire, delay);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (handle === undefined) {\n\t\t\t\t\t\t\thandle = null;\n\t\t\t\t\t\t\tqueueMicrotask(doFire);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t},\n\t\t\tonWillRemoveListener() {\n\t\t\t\tif (flushOnListenerRemove && numDebouncedCalls > 0) {\n\t\t\t\t\tdoFire?.();\n\t\t\t\t}\n\t\t\t},\n\t\t\tonDidRemoveLastListener() {\n\t\t\t\tdoFire = undefined;\n\t\t\t\tsubscription.dispose();\n\t\t\t}\n\t\t};\n\n\t\tif (!disposable) {\n\t\t\t_addLeakageTraceLogic(options);\n\t\t}\n\n\t\tconst emitter = new Emitter<O>(options);\n\n\t\tdisposable?.add(emitter);\n\n\t\treturn emitter.event;\n\t}\n\n\t/**\n\t * Debounces an event, firing after some delay (default=0) with an array of all event original objects.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param delay The number of milliseconds to debounce.\n\t * @param flushOnListenerRemove Whether to fire all debounced events when a listener is removed. If this is not\n\t * specified, some events could go missing. Use this if it's important that all events are processed, even if the\n\t * listener gets disposed before the debounced event fires.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function accumulate<T>(event: Event<T>, delay: number | typeof MicrotaskDelay = 0, flushOnListenerRemove?: boolean, disposable?: DisposableStore): Event<T[]> {\n\t\treturn Event.debounce<T, T[]>(event, (last, e) => {\n\t\t\tif (!last) {\n\t\t\t\treturn [e];\n\t\t\t}\n\t\t\tlast.push(e);\n\t\t\treturn last;\n\t\t}, delay, undefined, flushOnListenerRemove ?? true, undefined, disposable);\n\t}\n\n\t/**\n\t * Filters an event such that some condition is _not_ met more than once in a row, effectively ensuring duplicate\n\t * event objects from different sources do not fire the same event object.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param equals The equality condition.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t *\n\t * @example\n\t * ```\n\t * // Fire only one time when a single window is opened or focused\n\t * Event.latch(Event.any(onDidOpenWindow, onDidFocusWindow))\n\t * ```\n\t */\n\texport function latch<T>(event: Event<T>, equals: (a: T, b: T) => boolean = (a, b) => a === b, disposable?: DisposableStore): Event<T> {\n\t\tlet firstCall = true;\n\t\tlet cache: T;\n\n\t\treturn filter(event, value => {\n\t\t\tconst shouldEmit = firstCall || !equals(value, cache);\n\t\t\tfirstCall = false;\n\t\t\tcache = value;\n\t\t\treturn shouldEmit;\n\t\t}, disposable);\n\t}\n\n\t/**\n\t * Splits an event whose parameter is a union type into 2 separate events for each type in the union.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @example\n\t * ```\n\t * const event = new EventEmitter<number | undefined>().event;\n\t * const [numberEvent, undefinedEvent] = Event.split(event, isUndefined);\n\t * ```\n\t *\n\t * @param event The event source for the new event.\n\t * @param isT A function that determines what event is of the first type.\n\t * @param disposable A disposable store to add the new EventEmitter to.\n\t */\n\texport function split<T, U>(event: Event<T | U>, isT: (e: T | U) => e is T, disposable?: DisposableStore): [Event<T>, Event<U>] {\n\t\treturn [\n\t\t\tEvent.filter(event, isT, disposable),\n\t\t\tEvent.filter(event, e => !isT(e), disposable) as Event<U>,\n\t\t];\n\t}\n\n\t/**\n\t * Buffers an event until it has a listener attached.\n\t *\n\t * *NOTE* that this function returns an `Event` and it MUST be called with a `DisposableStore` whenever the returned\n\t * event is accessible to \"third parties\", e.g the event is a public property. Otherwise a leaked listener on the\n\t * returned event causes this utility to leak a listener on the original event.\n\t *\n\t * @param event The event source for the new event.\n\t * @param flushAfterTimeout Determines whether to flush the buffer after a timeout immediately or after a\n\t * `setTimeout` when the first event listener is added.\n\t * @param _buffer Internal: A source event array used for tests.\n\t *\n\t * @example\n\t * ```\n\t * // Start accumulating events, when the first listener is attached, flush\n\t * // the event after a timeout such that multiple listeners attached before\n\t * // the timeout would receive the event\n\t * this.onInstallExtension = Event.buffer(service.onInstallExtension, true);\n\t * ```\n\t */\n\texport function buffer<T>(event: Event<T>, flushAfterTimeout = false, _buffer: T[] = [], disposable?: DisposableStore): Event<T> {\n\t\tlet buffer: T[] | null = _buffer.slice();\n\n\t\tlet listener: IDisposable | null = event(e => {\n\t\t\tif (buffer) {\n\t\t\t\tbuffer.push(e);\n\t\t\t} else {\n\t\t\t\temitter.fire(e);\n\t\t\t}\n\t\t});\n\n\t\tif (disposable) {\n\t\t\tdisposable.add(listener);\n\t\t}\n\n\t\tconst flush = () => {\n\t\t\tbuffer?.forEach(e => emitter.fire(e));\n\t\t\tbuffer = null;\n\t\t};\n\n\t\tconst emitter = new Emitter<T>({\n\t\t\tonWillAddFirstListener() {\n\t\t\t\tif (!listener) {\n\t\t\t\t\tlistener = event(e => emitter.fire(e));\n\t\t\t\t\tif (disposable) {\n\t\t\t\t\t\tdisposable.add(listener);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tonDidAddFirstListener() {\n\t\t\t\tif (buffer) {\n\t\t\t\t\tif (flushAfterTimeout) {\n\t\t\t\t\t\tsetTimeout(flush);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tflush();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t},\n\n\t\t\tonDidRemoveLastListener() {\n\t\t\t\tif (listener) {\n\t\t\t\t\tlistener.dispose();\n\t\t\t\t}\n\t\t\t\tlistener = null;\n\t\t\t}\n\t\t});\n\n\t\tif (disposable) {\n\t\t\tdisposable.add(emitter);\n\t\t}\n\n\t\treturn emitter.event;\n\t}\n\t/**\n\t * Wraps the event in an {@link IChainableEvent}, allowing a more functional programming style.\n\t *\n\t * @example\n\t * ```\n\t * // Normal\n\t * const onEnterPressNormal = Event.filter(\n\t *   Event.map(onKeyPress.event, e => new StandardKeyboardEvent(e)),\n\t *   e.keyCode === KeyCode.Enter\n\t * ).event;\n\t *\n\t * // Using chain\n\t * const onEnterPressChain = Event.chain(onKeyPress.event, $ => $\n\t *   .map(e => new StandardKeyboardEvent(e))\n\t *   .filter(e => e.keyCode === KeyCode.Enter)\n\t * );\n\t * ```\n\t */\n\texport function chain<T, R>(event: Event<T>, sythensize: ($: IChainableSythensis<T>) => IChainableSythensis<R>): Event<R> {\n\t\tconst fn: Event<R> = (listener, thisArgs, disposables) => {\n\t\t\tconst cs = sythensize(new ChainableSynthesis()) as ChainableSynthesis;\n\t\t\treturn event(function (value) {\n\t\t\t\tconst result = cs.evaluate(value);\n\t\t\t\tif (result !== HaltChainable) {\n\t\t\t\t\tlistener.call(thisArgs, result);\n\t\t\t\t}\n\t\t\t}, undefined, disposables);\n\t\t};\n\n\t\treturn fn;\n\t}\n\n\tconst HaltChainable = Symbol('HaltChainable');\n\n\tclass ChainableSynthesis implements IChainableSythensis<any> {\n\t\tprivate readonly steps: ((input: any) => unknown)[] = [];\n\n\t\tmap<O>(fn: (i: any) => O): this {\n\t\t\tthis.steps.push(fn);\n\t\t\treturn this;\n\t\t}\n\n\t\tforEach(fn: (i: any) => void): this {\n\t\t\tthis.steps.push(v => {\n\t\t\t\tfn(v);\n\t\t\t\treturn v;\n\t\t\t});\n\t\t\treturn this;\n\t\t}\n\n\t\tfilter(fn: (e: any) => boolean): this {\n\t\t\tthis.steps.push(v => fn(v) ? v : HaltChainable);\n\t\t\treturn this;\n\t\t}\n\n\t\treduce<R>(merge: (last: R | undefined, event: any) => R, initial?: R | undefined): this {\n\t\t\tlet last = initial;\n\t\t\tthis.steps.push(v => {\n\t\t\t\tlast = merge(last, v);\n\t\t\t\treturn last;\n\t\t\t});\n\t\t\treturn this;\n\t\t}\n\n\t\tlatch(equals: (a: any, b: any) => boolean = (a, b) => a === b): ChainableSynthesis {\n\t\t\tlet firstCall = true;\n\t\t\tlet cache: any;\n\t\t\tthis.steps.push(value => {\n\t\t\t\tconst shouldEmit = firstCall || !equals(value, cache);\n\t\t\t\tfirstCall = false;\n\t\t\t\tcache = value;\n\t\t\t\treturn shouldEmit ? value : HaltChainable;\n\t\t\t});\n\n\t\t\treturn this;\n\t\t}\n\n\t\tpublic evaluate(value: any) {\n\t\t\tfor (const step of this.steps) {\n\t\t\t\tvalue = step(value);\n\t\t\t\tif (value === HaltChainable) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn value;\n\t\t}\n\t}\n\n\texport interface IChainableSythensis<T> {\n\t\tmap<O>(fn: (i: T) => O): IChainableSythensis<O>;\n\t\tforEach(fn: (i: T) => void): IChainableSythensis<T>;\n\t\tfilter<R extends T>(fn: (e: T) => e is R): IChainableSythensis<R>;\n\t\tfilter(fn: (e: T) => boolean): IChainableSythensis<T>;\n\t\treduce<R>(merge: (last: R, event: T) => R, initial: R): IChainableSythensis<R>;\n\t\treduce<R>(merge: (last: R | undefined, event: T) => R): IChainableSythensis<R>;\n\t\tlatch(equals?: (a: T, b: T) => boolean): IChainableSythensis<T>;\n\t}\n\n\texport interface NodeEventEmitter {\n\t\ton(event: string | symbol, listener: Function): unknown;\n\t\tremoveListener(event: string | symbol, listener: Function): unknown;\n\t}\n\n\t/**\n\t * Creates an {@link Event} from a node event emitter.\n\t */\n\texport function fromNodeEventEmitter<T>(emitter: NodeEventEmitter, eventName: string, map: (...args: any[]) => T = id => id): Event<T> {\n\t\tconst fn = (...args: any[]) => result.fire(map(...args));\n\t\tconst onFirstListenerAdd = () => emitter.on(eventName, fn);\n\t\tconst onLastListenerRemove = () => emitter.removeListener(eventName, fn);\n\t\tconst result = new Emitter<T>({ onWillAddFirstListener: onFirstListenerAdd, onDidRemoveLastListener: onLastListenerRemove });\n\n\t\treturn result.event;\n\t}\n\n\texport interface DOMEventEmitter {\n\t\taddEventListener(event: string | symbol, listener: Function): void;\n\t\tremoveEventListener(event: string | symbol, listener: Function): void;\n\t}\n\n\t/**\n\t * Creates an {@link Event} from a DOM event emitter.\n\t */\n\texport function fromDOMEventEmitter<T>(emitter: DOMEventEmitter, eventName: string, map: (...args: any[]) => T = id => id): Event<T> {\n\t\tconst fn = (...args: any[]) => result.fire(map(...args));\n\t\tconst onFirstListenerAdd = () => emitter.addEventListener(eventName, fn);\n\t\tconst onLastListenerRemove = () => emitter.removeEventListener(eventName, fn);\n\t\tconst result = new Emitter<T>({ onWillAddFirstListener: onFirstListenerAdd, onDidRemoveLastListener: onLastListenerRemove });\n\n\t\treturn result.event;\n\t}\n\n\t/**\n\t * Creates a promise out of an event, using the {@link Event.once} helper.\n\t */\n\texport function toPromise<T>(event: Event<T>, disposables?: IDisposable[] | DisposableStore): CancelablePromise<T> {\n\t\tlet cancelRef: () => void;\n\t\tlet listener: IDisposable;\n\t\tconst promise = new Promise((resolve) => {\n\t\t\tlistener = once(event)(resolve);\n\t\t\taddToDisposables(listener, disposables);\n\n\t\t\t// not resolved, matching the behavior of a normal disposal\n\t\t\tcancelRef = () => {\n\t\t\t\tdisposeAndRemove(listener, disposables);\n\t\t\t};\n\t\t}) as CancelablePromise<T>;\n\t\tpromise.cancel = cancelRef!;\n\n\t\tif (disposables) {\n\t\t\tpromise.finally(() => disposeAndRemove(listener, disposables));\n\t\t}\n\n\t\treturn promise;\n\t}\n\n\t/**\n\t * A convenience function for forwarding an event to another emitter which\n\t * improves readability.\n\t *\n\t * This is similar to {@link Relay} but allows instantiating and forwarding\n\t * on a single line and also allows for multiple source events.\n\t * @param from The event to forward.\n\t * @param to The emitter to forward the event to.\n\t * @example\n\t * Event.forward(event, emitter);\n\t * // equivalent to\n\t * event(e => emitter.fire(e));\n\t * // equivalent to\n\t * event(emitter.fire, emitter);\n\t */\n\texport function forward<T>(from: Event<T>, to: Emitter<T>): IDisposable {\n\t\treturn from(e => to.fire(e));\n\t}\n\n\t/**\n\t * Adds a listener to an event and calls the listener immediately with undefined as the event object.\n\t *\n\t * @example\n\t * ```\n\t * // Initialize the UI and update it when dataChangeEvent fires\n\t * runAndSubscribe(dataChangeEvent, () => this._updateUI());\n\t * ```\n\t */\n\texport function runAndSubscribe<T>(event: Event<T>, handler: (e: T) => unknown, initial: T): IDisposable;\n\texport function runAndSubscribe<T>(event: Event<T>, handler: (e: T | undefined) => unknown): IDisposable;\n\texport function runAndSubscribe<T>(event: Event<T>, handler: (e: T | undefined) => unknown, initial?: T): IDisposable {\n\t\thandler(initial);\n\t\treturn event(e => handler(e));\n\t}\n\n\tclass EmitterObserver<T> implements IObserver {\n\n\t\treadonly emitter: Emitter<T>;\n\n\t\tprivate _counter = 0;\n\t\tprivate _hasChanged = false;\n\n\t\tconstructor(readonly _observable: IObservable<T>, store: DisposableStore | undefined) {\n\t\t\tconst options: EmitterOptions = {\n\t\t\t\tonWillAddFirstListener: () => {\n\t\t\t\t\t_observable.addObserver(this);\n\n\t\t\t\t\t// Communicate to the observable that we received its current value and would like to be notified about future changes.\n\t\t\t\t\tthis._observable.reportChanges();\n\t\t\t\t},\n\t\t\t\tonDidRemoveLastListener: () => {\n\t\t\t\t\t_observable.removeObserver(this);\n\t\t\t\t}\n\t\t\t};\n\t\t\tif (!store) {\n\t\t\t\t_addLeakageTraceLogic(options);\n\t\t\t}\n\t\t\tthis.emitter = new Emitter<T>(options);\n\t\t\tif (store) {\n\t\t\t\tstore.add(this.emitter);\n\t\t\t}\n\t\t}\n\n\t\tbeginUpdate<T>(_observable: IObservable<T>): void {\n\t\t\t// assert(_observable === this.obs);\n\t\t\tthis._counter++;\n\t\t}\n\n\t\thandlePossibleChange<T>(_observable: IObservable<T>): void {\n\t\t\t// assert(_observable === this.obs);\n\t\t}\n\n\t\thandleChange<T, TChange>(_observable: IObservableWithChange<T, TChange>, _change: TChange): void {\n\t\t\t// assert(_observable === this.obs);\n\t\t\tthis._hasChanged = true;\n\t\t}\n\n\t\tendUpdate<T>(_observable: IObservable<T>): void {\n\t\t\t// assert(_observable === this.obs);\n\t\t\tthis._counter--;\n\t\t\tif (this._counter === 0) {\n\t\t\t\tthis._observable.reportChanges();\n\t\t\t\tif (this._hasChanged) {\n\t\t\t\t\tthis._hasChanged = false;\n\t\t\t\t\tthis.emitter.fire(this._observable.get());\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t/**\n\t * Creates an event emitter that is fired when the observable changes.\n\t * Each listeners subscribes to the emitter.\n\t */\n\texport function fromObservable<T>(obs: IObservable<T>, store?: DisposableStore): Event<T> {\n\t\tconst observer = new EmitterObserver(obs, store);\n\t\treturn observer.emitter.event;\n\t}\n\n\t/**\n\t * Each listener is attached to the observable directly.\n\t */\n\texport function fromObservableLight(observable: IObservable<unknown>): Event<void> {\n\t\treturn (listener, thisArgs, disposables) => {\n\t\t\tlet count = 0;\n\t\t\tlet didChange = false;\n\t\t\tconst observer: IObserver = {\n\t\t\t\tbeginUpdate() {\n\t\t\t\t\tcount++;\n\t\t\t\t},\n\t\t\t\tendUpdate() {\n\t\t\t\t\tcount--;\n\t\t\t\t\tif (count === 0) {\n\t\t\t\t\t\tobservable.reportChanges();\n\t\t\t\t\t\tif (didChange) {\n\t\t\t\t\t\t\tdidChange = false;\n\t\t\t\t\t\t\tlistener.call(thisArgs);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\thandlePossibleChange() {\n\t\t\t\t\t// noop\n\t\t\t\t},\n\t\t\t\thandleChange() {\n\t\t\t\t\tdidChange = true;\n\t\t\t\t}\n\t\t\t};\n\t\t\tobservable.addObserver(observer);\n\t\t\tobservable.reportChanges();\n\t\t\tconst disposable = {\n\t\t\t\tdispose() {\n\t\t\t\t\tobservable.removeObserver(observer);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\taddToDisposables(disposable, disposables);\n\n\t\t\treturn disposable;\n\t\t};\n\t}\n}\n\nexport interface EmitterOptions {\n\t/**\n\t * Optional function that's called *before* the very first listener is added\n\t */\n\tonWillAddFirstListener?: Function;\n\t/**\n\t * Optional function that's called *after* the very first listener is added\n\t */\n\tonDidAddFirstListener?: Function;\n\t/**\n\t * Optional function that's called after a listener is added\n\t */\n\tonDidAddListener?: Function;\n\t/**\n\t * Optional function that's called *after* remove the very last listener\n\t */\n\tonDidRemoveLastListener?: Function;\n\t/**\n\t * Optional function that's called *before* a listener is removed\n\t */\n\tonWillRemoveListener?: Function;\n\t/**\n\t * Optional function that's called when a listener throws an error. Defaults to\n\t * {@link onUnexpectedError}\n\t */\n\tonListenerError?: (e: any) => void;\n\t/**\n\t * Number of listeners that are allowed before assuming a leak. Default to\n\t * a globally configured value\n\t *\n\t * @see setGlobalLeakWarningThreshold\n\t */\n\tleakWarningThreshold?: number;\n\t/**\n\t * Pass in a delivery queue, which is useful for ensuring\n\t * in order event delivery across multiple emitters.\n\t */\n\tdeliveryQueue?: EventDeliveryQueue;\n\n\t/** ONLY enable this during development */\n\t_profName?: string;\n}\n\n\nexport class EventProfiling {\n\n\tstatic readonly all = new Set<EventProfiling>();\n\n\tprivate static _idPool = 0;\n\n\treadonly name: string;\n\tpublic listenerCount: number = 0;\n\tpublic invocationCount = 0;\n\tpublic elapsedOverall = 0;\n\tpublic durations: number[] = [];\n\n\tprivate _stopWatch?: StopWatch;\n\n\tconstructor(name: string) {\n\t\tthis.name = `${name}_${EventProfiling._idPool++}`;\n\t\tEventProfiling.all.add(this);\n\t}\n\n\tstart(listenerCount: number): void {\n\t\tthis._stopWatch = new StopWatch();\n\t\tthis.listenerCount = listenerCount;\n\t}\n\n\tstop(): void {\n\t\tif (this._stopWatch) {\n\t\t\tconst elapsed = this._stopWatch.elapsed();\n\t\t\tthis.durations.push(elapsed);\n\t\t\tthis.elapsedOverall += elapsed;\n\t\t\tthis.invocationCount += 1;\n\t\t\tthis._stopWatch = undefined;\n\t\t}\n\t}\n}\n\nlet _globalLeakWarningThreshold = -1;\nexport function setGlobalLeakWarningThreshold(n: number): IDisposable {\n\tconst oldValue = _globalLeakWarningThreshold;\n\t_globalLeakWarningThreshold = n;\n\treturn {\n\t\tdispose() {\n\t\t\t_globalLeakWarningThreshold = oldValue;\n\t\t}\n\t};\n}\n\nclass LeakageMonitor {\n\n\tprivate static _idPool = 1;\n\n\tprivate _stacks: Map<string, number> | undefined;\n\tprivate _warnCountdown: number = 0;\n\n\tconstructor(\n\t\tprivate readonly _errorHandler: (err: Error) => void,\n\t\treadonly threshold: number,\n\t\treadonly name: string = (LeakageMonitor._idPool++).toString(16).padStart(3, '0')\n\t) { }\n\n\tdispose(): void {\n\t\tthis._stacks?.clear();\n\t}\n\n\tcheck(stack: Stacktrace, listenerCount: number): undefined | (() => void) {\n\n\t\tconst threshold = this.threshold;\n\t\tif (threshold <= 0 || listenerCount < threshold) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (!this._stacks) {\n\t\t\tthis._stacks = new Map();\n\t\t}\n\t\tconst count = (this._stacks.get(stack.value) || 0);\n\t\tthis._stacks.set(stack.value, count + 1);\n\t\tthis._warnCountdown -= 1;\n\n\t\tif (this._warnCountdown <= 0) {\n\t\t\t// only warn on first exceed and then every time the limit\n\t\t\t// is exceeded by 50% again\n\t\t\tthis._warnCountdown = threshold * 0.5;\n\n\t\t\tconst [topStack, topCount] = this.getMostFrequentStack()!;\n\t\t\tconst message = `[${this.name}] potential listener LEAK detected, having ${listenerCount} listeners already. MOST frequent listener (${topCount}):`;\n\t\t\tconsole.warn(message);\n\t\t\tconsole.warn(topStack);\n\n\t\t\tconst error = new ListenerLeakError(message, topStack);\n\t\t\tthis._errorHandler(error);\n\t\t}\n\n\t\treturn () => {\n\t\t\tconst count = (this._stacks!.get(stack.value) || 0);\n\t\t\tthis._stacks!.set(stack.value, count - 1);\n\t\t};\n\t}\n\n\tgetMostFrequentStack(): [string, number] | undefined {\n\t\tif (!this._stacks) {\n\t\t\treturn undefined;\n\t\t}\n\t\tlet topStack: [string, number] | undefined;\n\t\tlet topCount: number = 0;\n\t\tfor (const [stack, count] of this._stacks) {\n\t\t\tif (!topStack || topCount < count) {\n\t\t\t\ttopStack = [stack, count];\n\t\t\t\ttopCount = count;\n\t\t\t}\n\t\t}\n\t\treturn topStack;\n\t}\n}\n\nclass Stacktrace {\n\n\tstatic create() {\n\t\tconst err = new Error();\n\t\treturn new Stacktrace(err.stack ?? '');\n\t}\n\n\tprivate constructor(readonly value: string) { }\n\n\tprint() {\n\t\tconsole.warn(this.value.split('\\n').slice(2).join('\\n'));\n\t}\n}\n\n// error that is logged when going over the configured listener threshold\nexport class ListenerLeakError extends Error {\n\tconstructor(message: string, stack: string) {\n\t\tsuper(message);\n\t\tthis.name = 'ListenerLeakError';\n\t\tthis.stack = stack;\n\t}\n}\n\n// SEVERE error that is logged when having gone way over the configured listener\n// threshold so that the emitter refuses to accept more listeners\nexport class ListenerRefusalError extends Error {\n\tconstructor(message: string, stack: string) {\n\t\tsuper(message);\n\t\tthis.name = 'ListenerRefusalError';\n\t\tthis.stack = stack;\n\t}\n}\n\nlet id = 0;\nclass UniqueContainer<T> {\n\tstack?: Stacktrace;\n\tpublic id = id++;\n\tconstructor(public readonly value: T) { }\n}\nconst compactionThreshold = 2;\n\ntype ListenerContainer<T> = UniqueContainer<(data: T) => void>;\ntype ListenerOrListeners<T> = (ListenerContainer<T> | undefined)[] | ListenerContainer<T>;\n\nconst forEachListener = <T>(listeners: ListenerOrListeners<T>, fn: (c: ListenerContainer<T>) => void) => {\n\tif (listeners instanceof UniqueContainer) {\n\t\tfn(listeners);\n\t} else {\n\t\tfor (let i = 0; i < listeners.length; i++) {\n\t\t\tconst l = listeners[i];\n\t\t\tif (l) {\n\t\t\t\tfn(l);\n\t\t\t}\n\t\t}\n\t}\n};\n\n/**\n * The Emitter can be used to expose an Event to the public\n * to fire it from the insides.\n * Sample:\n\tclass Document {\n\n\t\tprivate readonly _onDidChange = new Emitter<(value:string)=>any>();\n\n\t\tpublic onDidChange = this._onDidChange.event;\n\n\t\t// getter-style\n\t\t// get onDidChange(): Event<(value:string)=>any> {\n\t\t// \treturn this._onDidChange.event;\n\t\t// }\n\n\t\tprivate _doIt() {\n\t\t\t//...\n\t\t\tthis._onDidChange.fire(value);\n\t\t}\n\t}\n */\nexport class Emitter<T> {\n\n\tprivate readonly _options?: EmitterOptions;\n\tprivate readonly _leakageMon?: LeakageMonitor;\n\tprivate readonly _perfMon?: EventProfiling;\n\tprivate _disposed?: true;\n\tprivate _event?: Event<T>;\n\n\t/**\n\t * A listener, or list of listeners. A single listener is the most common\n\t * for event emitters (#185789), so we optimize that special case to avoid\n\t * wrapping it in an array (just like Node.js itself.)\n\t *\n\t * A list of listeners never 'downgrades' back to a plain function if\n\t * listeners are removed, for two reasons:\n\t *\n\t *  1. That's complicated (especially with the deliveryQueue)\n\t *  2. A listener with >1 listener is likely to have >1 listener again at\n\t *     some point, and swapping between arrays and functions may[citation needed]\n\t *     introduce unnecessary work and garbage.\n\t *\n\t * The array listeners can be 'sparse', to avoid reallocating the array\n\t * whenever any listener is added or removed. If more than `1 / compactionThreshold`\n\t * of the array is empty, only then is it resized.\n\t */\n\tprotected _listeners?: ListenerOrListeners<T>;\n\n\t/**\n\t * Always to be defined if _listeners is an array. It's no longer a true\n\t * queue, but holds the dispatching 'state'. If `fire()` is called on an\n\t * emitter, any work left in the _deliveryQueue is finished first.\n\t */\n\tprivate _deliveryQueue?: EventDeliveryQueuePrivate;\n\tprotected _size = 0;\n\n\tconstructor(options?: EmitterOptions) {\n\t\tthis._options = options;\n\t\tthis._leakageMon = (_globalLeakWarningThreshold > 0 || this._options?.leakWarningThreshold)\n\t\t\t? new LeakageMonitor(options?.onListenerError ?? onUnexpectedError, this._options?.leakWarningThreshold ?? _globalLeakWarningThreshold) :\n\t\t\tundefined;\n\t\tthis._perfMon = this._options?._profName ? new EventProfiling(this._options._profName) : undefined;\n\t\tthis._deliveryQueue = this._options?.deliveryQueue as EventDeliveryQueuePrivate | undefined;\n\t}\n\n\tdispose() {\n\t\tif (!this._disposed) {\n\t\t\tthis._disposed = true;\n\n\t\t\t// It is bad to have listeners at the time of disposing an emitter, it is worst to have listeners keep the emitter\n\t\t\t// alive via the reference that's embedded in their disposables. Therefore we loop over all remaining listeners and\n\t\t\t// unset their subscriptions/disposables. Looping and blaming remaining listeners is done on next tick because the\n\t\t\t// the following programming pattern is very popular:\n\t\t\t//\n\t\t\t// const someModel = this._disposables.add(new ModelObject()); // (1) create and register model\n\t\t\t// this._disposables.add(someModel.onDidChange(() => { ... }); // (2) subscribe and register model-event listener\n\t\t\t// ...later...\n\t\t\t// this._disposables.dispose(); disposes (1) then (2): don't warn after (1) but after the \"overall dispose\" is done\n\n\t\t\tif (this._deliveryQueue?.current === this) {\n\t\t\t\tthis._deliveryQueue.reset();\n\t\t\t}\n\t\t\tif (this._listeners) {\n\t\t\t\tif (_enableDisposeWithListenerWarning) {\n\t\t\t\t\tconst listeners = this._listeners;\n\t\t\t\t\tqueueMicrotask(() => {\n\t\t\t\t\t\tforEachListener(listeners, l => l.stack?.print());\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\tthis._listeners = undefined;\n\t\t\t\tthis._size = 0;\n\t\t\t}\n\t\t\tthis._options?.onDidRemoveLastListener?.();\n\t\t\tthis._leakageMon?.dispose();\n\t\t}\n\t}\n\n\t/**\n\t * For the public to allow to subscribe\n\t * to events from this Emitter\n\t */\n\tget event(): Event<T> {\n\t\tthis._event ??= (callback: (e: T) => unknown, thisArgs?: any, disposables?: IDisposable[] | DisposableStore) => {\n\t\t\tif (this._leakageMon && this._size > this._leakageMon.threshold ** 2) {\n\t\t\t\tconst message = `[${this._leakageMon.name}] REFUSES to accept new listeners because it exceeded its threshold by far (${this._size} vs ${this._leakageMon.threshold})`;\n\t\t\t\tconsole.warn(message);\n\n\t\t\t\tconst tuple = this._leakageMon.getMostFrequentStack() ?? ['UNKNOWN stack', -1];\n\t\t\t\tconst error = new ListenerRefusalError(`${message}. HINT: Stack shows most frequent listener (${tuple[1]}-times)`, tuple[0]);\n\t\t\t\tconst errorHandler = this._options?.onListenerError || onUnexpectedError;\n\t\t\t\terrorHandler(error);\n\n\t\t\t\treturn Disposable.None;\n\t\t\t}\n\n\t\t\tif (this._disposed) {\n\t\t\t\t// todo: should we warn if a listener is added to a disposed emitter? This happens often\n\t\t\t\treturn Disposable.None;\n\t\t\t}\n\n\t\t\tif (thisArgs) {\n\t\t\t\tcallback = callback.bind(thisArgs);\n\t\t\t}\n\n\t\t\tconst contained = new UniqueContainer(callback);\n\n\t\t\tlet removeMonitor: Function | undefined;\n\t\t\tlet stack: Stacktrace | undefined;\n\t\t\tif (this._leakageMon && this._size >= Math.ceil(this._leakageMon.threshold * 0.2)) {\n\t\t\t\t// check and record this emitter for potential leakage\n\t\t\t\tcontained.stack = Stacktrace.create();\n\t\t\t\tremoveMonitor = this._leakageMon.check(contained.stack, this._size + 1);\n\t\t\t}\n\n\t\t\tif (_enableDisposeWithListenerWarning) {\n\t\t\t\tcontained.stack = stack ?? Stacktrace.create();\n\t\t\t}\n\n\t\t\tif (!this._listeners) {\n\t\t\t\tthis._options?.onWillAddFirstListener?.(this);\n\t\t\t\tthis._listeners = contained;\n\t\t\t\tthis._options?.onDidAddFirstListener?.(this);\n\t\t\t} else if (this._listeners instanceof UniqueContainer) {\n\t\t\t\tthis._deliveryQueue ??= new EventDeliveryQueuePrivate();\n\t\t\t\tthis._listeners = [this._listeners, contained];\n\t\t\t} else {\n\t\t\t\tthis._listeners.push(contained);\n\t\t\t}\n\t\t\tthis._options?.onDidAddListener?.(this);\n\n\t\t\tthis._size++;\n\n\n\t\t\tconst result = toDisposable(() => {\n\t\t\t\tremoveMonitor?.();\n\t\t\t\tthis._removeListener(contained);\n\t\t\t});\n\t\t\taddToDisposables(result, disposables);\n\n\t\t\treturn result;\n\t\t};\n\n\t\treturn this._event;\n\t}\n\n\tprivate _removeListener(listener: ListenerContainer<T>) {\n\t\tthis._options?.onWillRemoveListener?.(this);\n\n\t\tif (!this._listeners) {\n\t\t\treturn; // expected if a listener gets disposed\n\t\t}\n\n\t\tif (this._size === 1) {\n\t\t\tthis._listeners = undefined;\n\t\t\tthis._options?.onDidRemoveLastListener?.(this);\n\t\t\tthis._size = 0;\n\t\t\treturn;\n\t\t}\n\n\t\t// size > 1 which requires that listeners be a list:\n\t\tconst listeners = this._listeners as (ListenerContainer<T> | undefined)[];\n\n\t\tconst index = listeners.indexOf(listener);\n\t\tif (index === -1) {\n\t\t\tconsole.log('disposed?', this._disposed);\n\t\t\tconsole.log('size?', this._size);\n\t\t\tconsole.log('arr?', JSON.stringify(this._listeners));\n\t\t\tthrow new Error('Attempted to dispose unknown listener');\n\t\t}\n\n\t\tthis._size--;\n\t\tlisteners[index] = undefined;\n\n\t\tconst adjustDeliveryQueue = this._deliveryQueue!.current === this;\n\t\tif (this._size * compactionThreshold <= listeners.length) {\n\t\t\tlet n = 0;\n\t\t\tfor (let i = 0; i < listeners.length; i++) {\n\t\t\t\tif (listeners[i]) {\n\t\t\t\t\tlisteners[n++] = listeners[i];\n\t\t\t\t} else if (adjustDeliveryQueue && n < this._deliveryQueue!.end) {\n\t\t\t\t\tthis._deliveryQueue!.end--;\n\t\t\t\t\tif (n < this._deliveryQueue!.i) {\n\t\t\t\t\t\tthis._deliveryQueue!.i--;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tlisteners.length = n;\n\t\t}\n\t}\n\n\tprivate _deliver(listener: undefined | UniqueContainer<(value: T) => void>, value: T) {\n\t\tif (!listener) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst errorHandler = this._options?.onListenerError || onUnexpectedError;\n\t\tif (!errorHandler) {\n\t\t\tlistener.value(value);\n\t\t\treturn;\n\t\t}\n\n\t\ttry {\n\t\t\tlistener.value(value);\n\t\t} catch (e) {\n\t\t\terrorHandler(e);\n\t\t}\n\t}\n\n\t/** Delivers items in the queue. Assumes the queue is ready to go. */\n\tprivate _deliverQueue(dq: EventDeliveryQueuePrivate) {\n\t\tconst listeners = dq.current!._listeners! as (ListenerContainer<T> | undefined)[];\n\t\twhile (dq.i < dq.end) {\n\t\t\t// important: dq.i is incremented before calling deliver() because it might reenter deliverQueue()\n\t\t\tthis._deliver(listeners[dq.i++], dq.value as T);\n\t\t}\n\t\tdq.reset();\n\t}\n\n\t/**\n\t * To be kept private to fire an event to\n\t * subscribers\n\t */\n\tfire(event: T): void {\n\t\tif (this._deliveryQueue?.current) {\n\t\t\tthis._deliverQueue(this._deliveryQueue);\n\t\t\tthis._perfMon?.stop(); // last fire() will have starting perfmon, stop it before starting the next dispatch\n\t\t}\n\n\t\tthis._perfMon?.start(this._size);\n\n\t\tif (!this._listeners) {\n\t\t\t// no-op\n\t\t} else if (this._listeners instanceof UniqueContainer) {\n\t\t\tthis._deliver(this._listeners, event);\n\t\t} else {\n\t\t\tconst dq = this._deliveryQueue!;\n\t\t\tdq.enqueue(this, event, this._listeners.length);\n\t\t\tthis._deliverQueue(dq);\n\t\t}\n\n\t\tthis._perfMon?.stop();\n\t}\n\n\thasListeners(): boolean {\n\t\treturn this._size > 0;\n\t}\n}\n\nexport interface EventDeliveryQueue {\n\t_isEventDeliveryQueue: true;\n}\n\nexport const createEventDeliveryQueue = (): EventDeliveryQueue => new EventDeliveryQueuePrivate();\n\nclass EventDeliveryQueuePrivate implements EventDeliveryQueue {\n\tdeclare _isEventDeliveryQueue: true;\n\n\t/**\n\t * Index in current's listener list.\n\t */\n\tpublic i = -1;\n\n\t/**\n\t * The last index in the listener's list to deliver.\n\t */\n\tpublic end = 0;\n\n\t/**\n\t * Emitter currently being dispatched on. Emitter._listeners is always an array.\n\t */\n\tpublic current?: Emitter<any>;\n\t/**\n\t * Currently emitting value. Defined whenever `current` is.\n\t */\n\tpublic value?: unknown;\n\n\tpublic enqueue<T>(emitter: Emitter<T>, value: T, end: number) {\n\t\tthis.i = 0;\n\t\tthis.end = end;\n\t\tthis.current = emitter;\n\t\tthis.value = value;\n\t}\n\n\tpublic reset() {\n\t\tthis.i = this.end; // force any current emission loop to stop, mainly for during dispose\n\t\tthis.current = undefined;\n\t\tthis.value = undefined;\n\t}\n}\n\nexport interface IWaitUntil {\n\ttoken: CancellationToken;\n\twaitUntil(thenable: Promise<unknown>): void;\n}\n\nexport type IWaitUntilData<T> = Omit<Omit<T, 'waitUntil'>, 'token'>;\n\nexport class AsyncEmitter<T extends IWaitUntil> extends Emitter<T> {\n\n\tprivate _asyncDeliveryQueue?: LinkedList<[(ev: T) => void, IWaitUntilData<T>]>;\n\n\tasync fireAsync(data: IWaitUntilData<T>, token: CancellationToken, promiseJoin?: (p: Promise<unknown>, listener: Function) => Promise<unknown>): Promise<void> {\n\t\tif (!this._listeners) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this._asyncDeliveryQueue) {\n\t\t\tthis._asyncDeliveryQueue = new LinkedList();\n\t\t}\n\n\t\tforEachListener(this._listeners, listener => this._asyncDeliveryQueue!.push([listener.value, data]));\n\n\t\twhile (this._asyncDeliveryQueue.size > 0 && !token.isCancellationRequested) {\n\n\t\t\tconst [listener, data] = this._asyncDeliveryQueue.shift()!;\n\t\t\tconst thenables: Promise<unknown>[] = [];\n\n\t\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\t\tconst event = <T>{\n\t\t\t\t...data,\n\t\t\t\ttoken,\n\t\t\t\twaitUntil: (p: Promise<unknown>): void => {\n\t\t\t\t\tif (Object.isFrozen(thenables)) {\n\t\t\t\t\t\tthrow new Error('waitUntil can NOT be called asynchronous');\n\t\t\t\t\t}\n\t\t\t\t\tif (promiseJoin) {\n\t\t\t\t\t\tp = promiseJoin(p, listener);\n\t\t\t\t\t}\n\t\t\t\t\tthenables.push(p);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\ttry {\n\t\t\t\tlistener(event);\n\t\t\t} catch (e) {\n\t\t\t\tonUnexpectedError(e);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// freeze thenables-collection to enforce sync-calls to\n\t\t\t// wait until and then wait for all thenables to resolve\n\t\t\tObject.freeze(thenables);\n\n\t\t\tawait Promise.allSettled(thenables).then(values => {\n\t\t\t\tfor (const value of values) {\n\t\t\t\t\tif (value.status === 'rejected') {\n\t\t\t\t\t\tonUnexpectedError(value.reason);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n}\n\n\nexport class PauseableEmitter<T> extends Emitter<T> {\n\n\tprivate _isPaused = 0;\n\tprotected _eventQueue = new LinkedList<T>();\n\tprivate _mergeFn?: (input: T[]) => T;\n\n\tpublic get isPaused(): boolean {\n\t\treturn this._isPaused !== 0;\n\t}\n\n\tconstructor(options?: EmitterOptions & { merge?: (input: T[]) => T }) {\n\t\tsuper(options);\n\t\tthis._mergeFn = options?.merge;\n\t}\n\n\tpause(): void {\n\t\tthis._isPaused++;\n\t}\n\n\tresume(): void {\n\t\tif (this._isPaused !== 0 && --this._isPaused === 0) {\n\t\t\tif (this._mergeFn) {\n\t\t\t\t// use the merge function to create a single composite\n\t\t\t\t// event. make a copy in case firing pauses this emitter\n\t\t\t\tif (this._eventQueue.size > 0) {\n\t\t\t\t\tconst events = Array.from(this._eventQueue);\n\t\t\t\t\tthis._eventQueue.clear();\n\t\t\t\t\tsuper.fire(this._mergeFn(events));\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\t// no merging, fire each event individually and test\n\t\t\t\t// that this emitter isn't paused halfway through\n\t\t\t\twhile (!this._isPaused && this._eventQueue.size !== 0) {\n\t\t\t\t\tsuper.fire(this._eventQueue.shift()!);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\toverride fire(event: T): void {\n\t\tif (this._size) {\n\t\t\tif (this._isPaused !== 0) {\n\t\t\t\tthis._eventQueue.push(event);\n\t\t\t} else {\n\t\t\t\tsuper.fire(event);\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class DebounceEmitter<T> extends PauseableEmitter<T> {\n\n\tprivate readonly _delay: number;\n\tprivate _handle: Timeout | undefined;\n\n\tconstructor(options: EmitterOptions & { merge: (input: T[]) => T; delay?: number }) {\n\t\tsuper(options);\n\t\tthis._delay = options.delay ?? 100;\n\t}\n\n\toverride fire(event: T): void {\n\t\tif (!this._handle) {\n\t\t\tthis.pause();\n\t\t\tthis._handle = setTimeout(() => {\n\t\t\t\tthis._handle = undefined;\n\t\t\t\tthis.resume();\n\t\t\t}, this._delay);\n\t\t}\n\t\tsuper.fire(event);\n\t}\n}\n\n/**\n * An emitter which queue all events and then process them at the\n * end of the event loop.\n */\nexport class MicrotaskEmitter<T> extends Emitter<T> {\n\tprivate _queuedEvents: T[] = [];\n\tprivate _mergeFn?: (input: T[]) => T;\n\n\tconstructor(options?: EmitterOptions & { merge?: (input: T[]) => T }) {\n\t\tsuper(options);\n\t\tthis._mergeFn = options?.merge;\n\t}\n\toverride fire(event: T): void {\n\n\t\tif (!this.hasListeners()) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._queuedEvents.push(event);\n\t\tif (this._queuedEvents.length === 1) {\n\t\t\tqueueMicrotask(() => {\n\t\t\t\tif (this._mergeFn) {\n\t\t\t\t\tsuper.fire(this._mergeFn(this._queuedEvents));\n\t\t\t\t} else {\n\t\t\t\t\tthis._queuedEvents.forEach(e => super.fire(e));\n\t\t\t\t}\n\t\t\t\tthis._queuedEvents = [];\n\t\t\t});\n\t\t}\n\t}\n}\n\n/**\n * An event emitter that multiplexes many events into a single event.\n *\n * @example Listen to the `onData` event of all `Thing`s, dynamically adding and removing `Thing`s\n * to the multiplexer as needed.\n *\n * ```typescript\n * const anythingDataMultiplexer = new EventMultiplexer<{ data: string }>();\n *\n * const thingListeners = DisposableMap<Thing, IDisposable>();\n *\n * thingService.onDidAddThing(thing => {\n *   thingListeners.set(thing, anythingDataMultiplexer.add(thing.onData);\n * });\n * thingService.onDidRemoveThing(thing => {\n *   thingListeners.deleteAndDispose(thing);\n * });\n *\n * anythingDataMultiplexer.event(e => {\n *   console.log('Something fired data ' + e.data)\n * });\n * ```\n */\nexport class EventMultiplexer<T> implements IDisposable {\n\n\tprivate readonly emitter: Emitter<T>;\n\tprivate hasListeners = false;\n\tprivate events: { event: Event<T>; listener: IDisposable | null }[] = [];\n\n\tconstructor() {\n\t\tthis.emitter = new Emitter<T>({\n\t\t\tonWillAddFirstListener: () => this.onFirstListenerAdd(),\n\t\t\tonDidRemoveLastListener: () => this.onLastListenerRemove()\n\t\t});\n\t}\n\n\tget event(): Event<T> {\n\t\treturn this.emitter.event;\n\t}\n\n\tadd(event: Event<T>): IDisposable {\n\t\tconst e = { event: event, listener: null };\n\t\tthis.events.push(e);\n\n\t\tif (this.hasListeners) {\n\t\t\tthis.hook(e);\n\t\t}\n\n\t\tconst dispose = () => {\n\t\t\tif (this.hasListeners) {\n\t\t\t\tthis.unhook(e);\n\t\t\t}\n\n\t\t\tconst idx = this.events.indexOf(e);\n\t\t\tthis.events.splice(idx, 1);\n\t\t};\n\n\t\treturn toDisposable(createSingleCallFunction(dispose));\n\t}\n\n\tprivate onFirstListenerAdd(): void {\n\t\tthis.hasListeners = true;\n\t\tthis.events.forEach(e => this.hook(e));\n\t}\n\n\tprivate onLastListenerRemove(): void {\n\t\tthis.hasListeners = false;\n\t\tthis.events.forEach(e => this.unhook(e));\n\t}\n\n\tprivate hook(e: { event: Event<T>; listener: IDisposable | null }): void {\n\t\te.listener = e.event(r => this.emitter.fire(r));\n\t}\n\n\tprivate unhook(e: { event: Event<T>; listener: IDisposable | null }): void {\n\t\te.listener?.dispose();\n\t\te.listener = null;\n\t}\n\n\tdispose(): void {\n\t\tthis.emitter.dispose();\n\n\t\tfor (const e of this.events) {\n\t\t\te.listener?.dispose();\n\t\t}\n\t\tthis.events = [];\n\t}\n}\n\nexport interface IDynamicListEventMultiplexer<TEventType> extends IDisposable {\n\treadonly event: Event<TEventType>;\n}\nexport class DynamicListEventMultiplexer<TItem, TEventType> implements IDynamicListEventMultiplexer<TEventType> {\n\tprivate readonly _store = new DisposableStore();\n\n\treadonly event: Event<TEventType>;\n\n\tconstructor(\n\t\titems: TItem[],\n\t\tonAddItem: Event<TItem>,\n\t\tonRemoveItem: Event<TItem>,\n\t\tgetEvent: (item: TItem) => Event<TEventType>\n\t) {\n\t\tconst multiplexer = this._store.add(new EventMultiplexer<TEventType>());\n\t\tconst itemListeners = this._store.add(new DisposableMap<TItem, IDisposable>());\n\n\t\tfunction addItem(instance: TItem) {\n\t\t\titemListeners.set(instance, multiplexer.add(getEvent(instance)));\n\t\t}\n\n\t\t// Existing items\n\t\tfor (const instance of items) {\n\t\t\taddItem(instance);\n\t\t}\n\n\t\t// Added items\n\t\tthis._store.add(onAddItem(instance => {\n\t\t\taddItem(instance);\n\t\t}));\n\n\t\t// Removed items\n\t\tthis._store.add(onRemoveItem(instance => {\n\t\t\titemListeners.deleteAndDispose(instance);\n\t\t}));\n\n\t\tthis.event = multiplexer.event;\n\t}\n\n\tdispose() {\n\t\tthis._store.dispose();\n\t}\n}\n\n/**\n * The EventBufferer is useful in situations in which you want\n * to delay firing your events during some code.\n * You can wrap that code and be sure that the event will not\n * be fired during that wrap.\n *\n * ```\n * const emitter: Emitter;\n * const delayer = new EventDelayer();\n * const delayedEvent = delayer.wrapEvent(emitter.event);\n *\n * delayedEvent(console.log);\n *\n * delayer.bufferEvents(() => {\n *   emitter.fire(); // event will not be fired yet\n * });\n *\n * // event will only be fired at this point\n * ```\n */\nexport class EventBufferer {\n\n\tprivate data: { buffers: Function[] }[] = [];\n\n\twrapEvent<T>(event: Event<T>): Event<T>;\n\twrapEvent<T>(event: Event<T>, reduce: (last: T | undefined, event: T) => T): Event<T>;\n\twrapEvent<T, O>(event: Event<T>, reduce: (last: O | undefined, event: T) => O, initial: O): Event<O>;\n\twrapEvent<T, O>(event: Event<T>, reduce?: (last: T | O | undefined, event: T) => T | O, initial?: O): Event<O | T> {\n\t\treturn (listener, thisArgs?, disposables?) => {\n\t\t\treturn event(i => {\n\t\t\t\tconst data = this.data[this.data.length - 1];\n\n\t\t\t\t// Non-reduce scenario\n\t\t\t\tif (!reduce) {\n\t\t\t\t\t// Buffering case\n\t\t\t\t\tif (data) {\n\t\t\t\t\t\tdata.buffers.push(() => listener.call(thisArgs, i));\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// Not buffering case\n\t\t\t\t\t\tlistener.call(thisArgs, i);\n\t\t\t\t\t}\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Reduce scenario\n\t\t\t\tconst reduceData = data as typeof data & {\n\t\t\t\t\t/**\n\t\t\t\t\t * The accumulated items that will be reduced.\n\t\t\t\t\t */\n\t\t\t\t\titems?: T[];\n\t\t\t\t\t/**\n\t\t\t\t\t * The reduced result cached to be shared with other listeners.\n\t\t\t\t\t */\n\t\t\t\t\treducedResult?: T | O;\n\t\t\t\t};\n\n\t\t\t\t// Not buffering case\n\t\t\t\tif (!reduceData) {\n\t\t\t\t\t// TODO: Is there a way to cache this reduce call for all listeners?\n\t\t\t\t\tlistener.call(thisArgs, reduce(initial, i));\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Buffering case\n\t\t\t\treduceData.items ??= [];\n\t\t\t\treduceData.items.push(i);\n\t\t\t\tif (reduceData.buffers.length === 0) {\n\t\t\t\t\t// Include a single buffered function that will reduce all events when we're done buffering events\n\t\t\t\t\tdata.buffers.push(() => {\n\t\t\t\t\t\t// cache the reduced result so that the value can be shared across all listeners\n\t\t\t\t\t\treduceData.reducedResult ??= initial\n\t\t\t\t\t\t\t? reduceData.items!.reduce(reduce as (last: O | undefined, event: T) => O, initial)\n\t\t\t\t\t\t\t: reduceData.items!.reduce(reduce as (last: T | undefined, event: T) => T);\n\t\t\t\t\t\tlistener.call(thisArgs, reduceData.reducedResult);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}, undefined, disposables);\n\t\t};\n\t}\n\n\tbufferEvents<R = void>(fn: () => R): R {\n\t\tconst data = { buffers: new Array<Function>() };\n\t\tthis.data.push(data);\n\t\tconst r = fn();\n\t\tthis.data.pop();\n\t\tdata.buffers.forEach(flush => flush());\n\t\treturn r;\n\t}\n}\n\n/**\n * A Relay is an event forwarder which functions as a replugabble event pipe.\n * Once created, you can connect an input event to it and it will simply forward\n * events from that input event through its own `event` property. The `input`\n * can be changed at any point in time.\n */\nexport class Relay<T> implements IDisposable {\n\n\tprivate listening = false;\n\tprivate inputEvent: Event<T> = Event.None;\n\tprivate inputEventListener: IDisposable = Disposable.None;\n\n\tprivate readonly emitter = new Emitter<T>({\n\t\tonDidAddFirstListener: () => {\n\t\t\tthis.listening = true;\n\t\t\tthis.inputEventListener = this.inputEvent(this.emitter.fire, this.emitter);\n\t\t},\n\t\tonDidRemoveLastListener: () => {\n\t\t\tthis.listening = false;\n\t\t\tthis.inputEventListener.dispose();\n\t\t}\n\t});\n\n\treadonly event: Event<T> = this.emitter.event;\n\n\tset input(event: Event<T>) {\n\t\tthis.inputEvent = event;\n\n\t\tif (this.listening) {\n\t\t\tthis.inputEventListener.dispose();\n\t\t\tthis.inputEventListener = event(this.emitter.fire, this.emitter);\n\t\t}\n\t}\n\n\tdispose() {\n\t\tthis.inputEventListener.dispose();\n\t\tthis.emitter.dispose();\n\t}\n}\n\nexport interface IValueWithChangeEvent<T> {\n\treadonly onDidChange: Event<void>;\n\tget value(): T;\n}\n\nexport class ValueWithChangeEvent<T> implements IValueWithChangeEvent<T> {\n\tpublic static const<T>(value: T): IValueWithChangeEvent<T> {\n\t\treturn new ConstValueWithChangeEvent(value);\n\t}\n\n\tprivate readonly _onDidChange = new Emitter<void>();\n\treadonly onDidChange: Event<void> = this._onDidChange.event;\n\n\tconstructor(private _value: T) { }\n\n\tget value(): T {\n\t\treturn this._value;\n\t}\n\n\tset value(value: T) {\n\t\tif (value !== this._value) {\n\t\t\tthis._value = value;\n\t\t\tthis._onDidChange.fire(undefined);\n\t\t}\n\t}\n}\n\nclass ConstValueWithChangeEvent<T> implements IValueWithChangeEvent<T> {\n\tpublic readonly onDidChange: Event<void> = Event.None;\n\n\tconstructor(readonly value: T) { }\n}\n\n/**\n * @param handleItem Is called for each item in the set (but only the first time the item is seen in the set).\n * \tThe returned disposable is disposed if the item is no longer in the set.\n */\nexport function trackSetChanges<T>(getData: () => ReadonlySet<T>, onDidChangeData: Event<unknown>, handleItem: (d: T) => IDisposable): IDisposable {\n\tconst map = new DisposableMap<T, IDisposable>();\n\tlet oldData = new Set(getData());\n\tfor (const d of oldData) {\n\t\tmap.set(d, handleItem(d));\n\t}\n\n\tconst store = new DisposableStore();\n\tstore.add(onDidChangeData(() => {\n\t\tconst newData = getData();\n\t\tconst diff = diffSets(oldData, newData);\n\t\tfor (const r of diff.removed) {\n\t\t\tmap.deleteAndDispose(r);\n\t\t}\n\t\tfor (const a of diff.added) {\n\t\t\tmap.set(a, handleItem(a));\n\t\t}\n\t\toldData = new Set(newData);\n\t}));\n\tstore.add(map);\n\treturn store;\n}\n\n\nfunction addToDisposables(result: IDisposable, disposables: DisposableStore | IDisposable[] | undefined) {\n\tif (disposables instanceof DisposableStore) {\n\t\tdisposables.add(result);\n\t} else if (Array.isArray(disposables)) {\n\t\tdisposables.push(result);\n\t}\n}\n\nfunction disposeAndRemove(result: IDisposable, disposables: DisposableStore | IDisposable[] | undefined) {\n\tif (disposables instanceof DisposableStore) {\n\t\tdisposables.delete(result);\n\t} else if (Array.isArray(disposables)) {\n\t\tconst index = disposables.indexOf(result);\n\t\tif (index !== -1) {\n\t\t\tdisposables.splice(index, 1);\n\t\t}\n\t}\n\tresult.dispose();\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from './event.js';\nimport { DisposableStore, IDisposable } from './lifecycle.js';\n\nexport interface CancellationToken {\n\n\t/**\n\t * A flag signalling is cancellation has been requested.\n\t */\n\treadonly isCancellationRequested: boolean;\n\n\t/**\n\t * An event which fires when cancellation is requested. This event\n\t * only ever fires `once` as cancellation can only happen once. Listeners\n\t * that are registered after cancellation will be called (next event loop run),\n\t * but also only once.\n\t *\n\t * @event\n\t */\n\treadonly onCancellationRequested: (listener: (e: void) => unknown, thisArgs?: unknown, disposables?: IDisposable[]) => IDisposable;\n}\n\nconst shortcutEvent: Event<void> = Object.freeze(function (callback, context?): IDisposable {\n\tconst handle = setTimeout(callback.bind(context), 0);\n\treturn { dispose() { clearTimeout(handle); } };\n});\n\nexport namespace CancellationToken {\n\n\texport function isCancellationToken(thing: unknown): thing is CancellationToken {\n\t\tif (thing === CancellationToken.None || thing === CancellationToken.Cancelled) {\n\t\t\treturn true;\n\t\t}\n\t\tif (thing instanceof MutableToken) {\n\t\t\treturn true;\n\t\t}\n\t\tif (!thing || typeof thing !== 'object') {\n\t\t\treturn false;\n\t\t}\n\t\treturn typeof (thing as CancellationToken).isCancellationRequested === 'boolean'\n\t\t\t&& typeof (thing as CancellationToken).onCancellationRequested === 'function';\n\t}\n\n\n\texport const None = Object.freeze<CancellationToken>({\n\t\tisCancellationRequested: false,\n\t\tonCancellationRequested: Event.None\n\t});\n\n\texport const Cancelled = Object.freeze<CancellationToken>({\n\t\tisCancellationRequested: true,\n\t\tonCancellationRequested: shortcutEvent\n\t});\n}\n\nclass MutableToken implements CancellationToken {\n\n\tprivate _isCancelled: boolean = false;\n\tprivate _emitter: Emitter<void> | null = null;\n\n\tpublic cancel() {\n\t\tif (!this._isCancelled) {\n\t\t\tthis._isCancelled = true;\n\t\t\tif (this._emitter) {\n\t\t\t\tthis._emitter.fire(undefined);\n\t\t\t\tthis.dispose();\n\t\t\t}\n\t\t}\n\t}\n\n\tget isCancellationRequested(): boolean {\n\t\treturn this._isCancelled;\n\t}\n\n\tget onCancellationRequested(): Event<void> {\n\t\tif (this._isCancelled) {\n\t\t\treturn shortcutEvent;\n\t\t}\n\t\tif (!this._emitter) {\n\t\t\tthis._emitter = new Emitter<void>();\n\t\t}\n\t\treturn this._emitter.event;\n\t}\n\n\tpublic dispose(): void {\n\t\tif (this._emitter) {\n\t\t\tthis._emitter.dispose();\n\t\t\tthis._emitter = null;\n\t\t}\n\t}\n}\n\nexport class CancellationTokenSource {\n\n\tprivate _token?: CancellationToken = undefined;\n\tprivate _parentListener?: IDisposable = undefined;\n\n\tconstructor(parent?: CancellationToken) {\n\t\tthis._parentListener = parent && parent.onCancellationRequested(this.cancel, this);\n\t}\n\n\tget token(): CancellationToken {\n\t\tif (!this._token) {\n\t\t\t// be lazy and create the token only when\n\t\t\t// actually needed\n\t\t\tthis._token = new MutableToken();\n\t\t}\n\t\treturn this._token;\n\t}\n\n\tcancel(): void {\n\t\tif (!this._token) {\n\t\t\t// save an object by returning the default\n\t\t\t// cancelled token when cancellation happens\n\t\t\t// before someone asks for the token\n\t\t\tthis._token = CancellationToken.Cancelled;\n\n\t\t} else if (this._token instanceof MutableToken) {\n\t\t\t// actually cancel\n\t\t\tthis._token.cancel();\n\t\t}\n\t}\n\n\tdispose(cancel: boolean = false): void {\n\t\tif (cancel) {\n\t\t\tthis.cancel();\n\t\t}\n\t\tthis._parentListener?.dispose();\n\t\tif (!this._token) {\n\t\t\t// ensure to initialize with an empty token if we had none\n\t\t\tthis._token = CancellationToken.None;\n\n\t\t} else if (this._token instanceof MutableToken) {\n\t\t\t// actually dispose\n\t\t\tthis._token.dispose();\n\t\t}\n\t}\n}\n\nexport function cancelOnDispose(store: DisposableStore): CancellationToken {\n\tconst source = new CancellationTokenSource();\n\tstore.add({ dispose() { source.cancel(); } });\n\treturn source.token;\n}\n\n/**\n * A pool that aggregates multiple cancellation tokens. The pool's own token\n * (accessible via `pool.token`) is cancelled only after every token added\n * to the pool has been cancelled. Adding tokens after the pool token has\n * been cancelled has no effect.\n */\nexport class CancellationTokenPool {\n\n\tprivate readonly _source = new CancellationTokenSource();\n\tprivate readonly _listeners = new DisposableStore();\n\n\tprivate _total: number = 0;\n\tprivate _cancelled: number = 0;\n\tprivate _isDone: boolean = false;\n\n\tget token(): CancellationToken {\n\t\treturn this._source.token;\n\t}\n\n\t/**\n\t * Add a token to the pool. If the token is already cancelled it is counted\n\t * immediately. Tokens added after the pool token has been cancelled are ignored.\n\t */\n\tadd(token: CancellationToken): void {\n\t\tif (this._isDone) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._total++;\n\n\t\tif (token.isCancellationRequested) {\n\t\t\tthis._cancelled++;\n\t\t\tthis._check();\n\t\t\treturn;\n\t\t}\n\n\t\tconst d = token.onCancellationRequested(() => {\n\t\t\td.dispose();\n\t\t\tthis._cancelled++;\n\t\t\tthis._check();\n\t\t});\n\t\tthis._listeners.add(d);\n\t}\n\n\tprivate _check(): void {\n\t\tif (!this._isDone && this._total > 0 && this._total === this._cancelled) {\n\t\t\tthis._isDone = true;\n\t\t\tthis._listeners.dispose();\n\t\t\tthis._source.cancel();\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis._listeners.dispose();\n\t\tthis._source.dispose();\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken, CancellationTokenSource } from './cancellation.js';\nimport { IDisposable } from './lifecycle.js';\n\nexport interface CacheResult<T> extends IDisposable {\n\tpromise: Promise<T>;\n}\n\nexport class Cache<T> {\n\n\tprivate result: CacheResult<T> | null = null;\n\tconstructor(private task: (ct: CancellationToken) => Promise<T>) { }\n\n\tget(): CacheResult<T> {\n\t\tif (this.result) {\n\t\t\treturn this.result;\n\t\t}\n\n\t\tconst cts = new CancellationTokenSource();\n\t\tconst promise = this.task(cts.token);\n\n\t\tthis.result = {\n\t\t\tpromise,\n\t\t\tdispose: () => {\n\t\t\t\tthis.result = null;\n\t\t\t\tcts.cancel();\n\t\t\t\tcts.dispose();\n\t\t\t}\n\t\t};\n\n\t\treturn this.result;\n\t}\n}\n\nexport function identity<T>(t: T): T {\n\treturn t;\n}\n\ninterface ICacheOptions<TArg> {\n\t/**\n\t * The cache key is used to identify the cache entry.\n\t * Strict equality is used to compare cache keys.\n\t*/\n\tgetCacheKey: (arg: TArg) => unknown;\n}\n\n/**\n * Uses a LRU cache to make a given parametrized function cached.\n * Caches just the last key/value.\n*/\nexport class LRUCachedFunction<TArg, TComputed> {\n\tprivate lastCache: TComputed | undefined = undefined;\n\tprivate lastArgKey: unknown | undefined = undefined;\n\n\tprivate readonly _fn: (arg: TArg) => TComputed;\n\tprivate readonly _computeKey: (arg: TArg) => unknown;\n\n\tconstructor(fn: (arg: TArg) => TComputed);\n\tconstructor(options: ICacheOptions<TArg>, fn: (arg: TArg) => TComputed);\n\tconstructor(arg1: ICacheOptions<TArg> | ((arg: TArg) => TComputed), arg2?: (arg: TArg) => TComputed) {\n\t\tif (typeof arg1 === 'function') {\n\t\t\tthis._fn = arg1;\n\t\t\tthis._computeKey = identity;\n\t\t} else {\n\t\t\tthis._fn = arg2!;\n\t\t\tthis._computeKey = arg1.getCacheKey;\n\t\t}\n\t}\n\n\tpublic get(arg: TArg): TComputed {\n\t\tconst key = this._computeKey(arg);\n\t\tif (this.lastArgKey !== key) {\n\t\t\tthis.lastArgKey = key;\n\t\t\tthis.lastCache = this._fn(arg);\n\t\t}\n\t\treturn this.lastCache!;\n\t}\n}\n\n/**\n * Uses an unbounded cache to memoize the results of the given function.\n*/\nexport class CachedFunction<TArg, TComputed> {\n\tprivate readonly _map = new Map<TArg, TComputed>();\n\tprivate readonly _map2 = new Map<unknown, TComputed>();\n\tpublic get cachedValues(): ReadonlyMap<TArg, TComputed> {\n\t\treturn this._map;\n\t}\n\n\tprivate readonly _fn: (arg: TArg) => TComputed;\n\tprivate readonly _computeKey: (arg: TArg) => unknown;\n\n\tconstructor(fn: (arg: TArg) => TComputed);\n\tconstructor(options: ICacheOptions<TArg>, fn: (arg: TArg) => TComputed);\n\tconstructor(arg1: ICacheOptions<TArg> | ((arg: TArg) => TComputed), arg2?: (arg: TArg) => TComputed) {\n\t\tif (typeof arg1 === 'function') {\n\t\t\tthis._fn = arg1;\n\t\t\tthis._computeKey = identity;\n\t\t} else {\n\t\t\tthis._fn = arg2!;\n\t\t\tthis._computeKey = arg1.getCacheKey;\n\t\t}\n\t}\n\n\tpublic get(arg: TArg): TComputed {\n\t\tconst key = this._computeKey(arg);\n\t\tif (this._map2.has(key)) {\n\t\t\treturn this._map2.get(key)!;\n\t\t}\n\n\t\tconst value = this._fn(arg);\n\t\tthis._map.set(arg, value);\n\t\tthis._map2.set(key, value);\n\t\treturn value;\n\t}\n}\n\n/**\n * Uses an unbounded cache to memoize the results of the given function.\n*/\nexport class WeakCachedFunction<TArg, TComputed> {\n\tprivate readonly _map = new WeakMap<WeakKey, TComputed>();\n\n\tprivate readonly _fn: (arg: TArg) => TComputed;\n\tprivate readonly _computeKey: (arg: TArg) => unknown;\n\n\tconstructor(fn: (arg: TArg) => TComputed);\n\tconstructor(options: ICacheOptions<TArg>, fn: (arg: TArg) => TComputed);\n\tconstructor(arg1: ICacheOptions<TArg> | ((arg: TArg) => TComputed), arg2?: (arg: TArg) => TComputed) {\n\t\tif (typeof arg1 === 'function') {\n\t\t\tthis._fn = arg1;\n\t\t\tthis._computeKey = identity;\n\t\t} else {\n\t\t\tthis._fn = arg2!;\n\t\t\tthis._computeKey = arg1.getCacheKey;\n\t\t}\n\t}\n\n\tpublic get(arg: TArg): TComputed {\n\t\tconst key = this._computeKey(arg) as WeakKey;\n\t\tif (this._map.has(key)) {\n\t\t\treturn this._map.get(key)!;\n\t\t}\n\n\t\tconst value = this._fn(arg);\n\t\tthis._map.set(key, value);\n\t\treturn value;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { LRUCachedFunction } from './cache.js';\nimport { CharCode } from './charCode.js';\nimport { Lazy } from './lazy.js';\nimport { Constants } from './uint.js';\n\nexport function isFalsyOrWhitespace(str: string | undefined): boolean {\n\tif (!str || typeof str !== 'string') {\n\t\treturn true;\n\t}\n\treturn str.trim().length === 0;\n}\n\nconst _formatRegexp = /{(\\d+)}/g;\n\n/**\n * Helper to produce a string with a variable number of arguments. Insert variable segments\n * into the string using the {n} notation where N is the index of the argument following the string.\n * @param value string to which formatting is applied\n * @param args replacements for {n}-entries\n */\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport function format(value: string, ...args: any[]): string {\n\tif (args.length === 0) {\n\t\treturn value;\n\t}\n\treturn value.replace(_formatRegexp, function (match, group) {\n\t\tconst idx = parseInt(group, 10);\n\t\treturn isNaN(idx) || idx < 0 || idx >= args.length ?\n\t\t\tmatch :\n\t\t\targs[idx];\n\t});\n}\n\nconst _format2Regexp = /{([^}]+)}/g;\n\n/**\n * Helper to create a string from a template and a string record.\n * Similar to `format` but with objects instead of positional arguments.\n */\nexport function format2(template: string, values: Record<string, unknown>): string {\n\tif (Object.keys(values).length === 0) {\n\t\treturn template;\n\t}\n\treturn template.replace(_format2Regexp, (match, group) => (values[group] ?? match) as string);\n}\n\n/**\n * Encodes the given value so that it can be used as literal value in html attributes.\n *\n * In other words, computes `$val`, such that `attr` in `<div attr=\"$val\" />` has the runtime value `value`.\n * This prevents XSS injection.\n */\nexport function htmlAttributeEncodeValue(value: string): string {\n\treturn value.replace(/[<>\"'&]/g, ch => {\n\t\tswitch (ch) {\n\t\t\tcase '<': return '&lt;';\n\t\t\tcase '>': return '&gt;';\n\t\t\tcase '\"': return '&quot;';\n\t\t\tcase '\\'': return '&apos;';\n\t\t\tcase '&': return '&amp;';\n\t\t}\n\t\treturn ch;\n\t});\n}\n\n/**\n * Converts HTML characters inside the string to use entities instead. Makes the string safe from\n * being used e.g. in HTMLElement.innerHTML.\n */\nexport function escape(html: string): string {\n\treturn html.replace(/[<>&]/g, function (match) {\n\t\tswitch (match) {\n\t\t\tcase '<': return '&lt;';\n\t\t\tcase '>': return '&gt;';\n\t\t\tcase '&': return '&amp;';\n\t\t\tdefault: return match;\n\t\t}\n\t});\n}\n\n/**\n * Escapes regular expression characters in a given string\n */\nexport function escapeRegExpCharacters(value: string): string {\n\treturn value.replace(/[\\\\\\{\\}\\*\\+\\?\\|\\^\\$\\.\\[\\]\\(\\)]/g, '\\\\$&');\n}\n\n/**\n * Counts how often `substr` occurs inside `value`.\n */\nexport function count(value: string, substr: string): number {\n\tlet result = 0;\n\tlet index = value.indexOf(substr);\n\twhile (index !== -1) {\n\t\tresult++;\n\t\tindex = value.indexOf(substr, index + substr.length);\n\t}\n\treturn result;\n}\n\nexport function truncate(value: string, maxLength: number, suffix = Ellipsis): string {\n\tif (value.length <= maxLength) {\n\t\treturn value;\n\t}\n\n\treturn `${value.substr(0, maxLength)}${suffix}`;\n}\n\nexport function truncateMiddle(value: string, maxLength: number, suffix = Ellipsis): string {\n\tif (value.length <= maxLength) {\n\t\treturn value;\n\t}\n\n\tconst prefixLength = Math.ceil(maxLength / 2) - suffix.length / 2;\n\tconst suffixLength = Math.floor(maxLength / 2) - suffix.length / 2;\n\n\treturn `${value.substr(0, prefixLength)}${suffix}${value.substr(value.length - suffixLength)}`;\n}\n\n/**\n * Removes all occurrences of needle from the beginning and end of haystack.\n * @param haystack string to trim\n * @param needle the thing to trim (default is a blank)\n */\nexport function trim(haystack: string, needle: string = ' '): string {\n\tconst trimmed = ltrim(haystack, needle);\n\treturn rtrim(trimmed, needle);\n}\n\n/**\n * Removes all occurrences of needle from the beginning of haystack.\n * @param haystack string to trim\n * @param needle the thing to trim\n */\nexport function ltrim(haystack: string, needle: string): string {\n\tif (!haystack || !needle) {\n\t\treturn haystack;\n\t}\n\n\tconst needleLen = needle.length;\n\tlet offset = 0;\n\tif (needleLen === 1) {\n\t\tconst ch = needle.charCodeAt(0);\n\t\twhile (offset < haystack.length && haystack.charCodeAt(offset) === ch) {\n\t\t\toffset++;\n\t\t}\n\t} else {\n\t\twhile (haystack.startsWith(needle, offset)) {\n\t\t\toffset += needleLen;\n\t\t}\n\t}\n\treturn haystack.substring(offset);\n}\n\n/**\n * Removes all occurrences of needle from the end of haystack.\n * @param haystack string to trim\n * @param needle the thing to trim\n */\nexport function rtrim(haystack: string, needle: string): string {\n\tif (!haystack || !needle) {\n\t\treturn haystack;\n\t}\n\n\tconst needleLen = needle.length,\n\t\thaystackLen = haystack.length;\n\n\tif (needleLen === 1) {\n\t\tlet end = haystackLen;\n\t\tconst ch = needle.charCodeAt(0);\n\t\twhile (end > 0 && haystack.charCodeAt(end - 1) === ch) {\n\t\t\tend--;\n\t\t}\n\t\treturn haystack.substring(0, end);\n\t}\n\n\tlet offset = haystackLen;\n\twhile (offset > 0 && haystack.endsWith(needle, offset)) {\n\t\toffset -= needleLen;\n\t}\n\n\treturn haystack.substring(0, offset);\n}\n\nexport function convertSimple2RegExpPattern(pattern: string): string {\n\treturn pattern.replace(/[\\-\\\\\\{\\}\\+\\?\\|\\^\\$\\.\\,\\[\\]\\(\\)\\#\\s]/g, '\\\\$&').replace(/[\\*]/g, '.*');\n}\n\nexport interface RegExpOptions {\n\tmatchCase?: boolean;\n\twholeWord?: boolean;\n\tmultiline?: boolean;\n\tglobal?: boolean;\n\tunicode?: boolean;\n}\n\nexport function createRegExp(searchString: string, isRegex: boolean, options: RegExpOptions = {}): RegExp {\n\tif (!searchString) {\n\t\tthrow new Error('Cannot create regex from empty string');\n\t}\n\tif (!isRegex) {\n\t\tsearchString = escapeRegExpCharacters(searchString);\n\t}\n\tif (options.wholeWord) {\n\t\tif (!/\\B/.test(searchString.charAt(0))) {\n\t\t\tsearchString = '\\\\b' + searchString;\n\t\t}\n\t\tif (!/\\B/.test(searchString.charAt(searchString.length - 1))) {\n\t\t\tsearchString = searchString + '\\\\b';\n\t\t}\n\t}\n\tlet modifiers = '';\n\tif (options.global) {\n\t\tmodifiers += 'g';\n\t}\n\tif (!options.matchCase) {\n\t\tmodifiers += 'i';\n\t}\n\tif (options.multiline) {\n\t\tmodifiers += 'm';\n\t}\n\tif (options.unicode) {\n\t\tmodifiers += 'u';\n\t}\n\n\treturn new RegExp(searchString, modifiers);\n}\n\nexport function regExpLeadsToEndlessLoop(regexp: RegExp): boolean {\n\t// Exit early if it's one of these special cases which are meant to match\n\t// against an empty string\n\tif (regexp.source === '^' || regexp.source === '^$' || regexp.source === '$' || regexp.source === '^\\\\s*$') {\n\t\treturn false;\n\t}\n\n\t// We check against an empty string. If the regular expression doesn't advance\n\t// (e.g. ends in an endless loop) it will match an empty string.\n\tconst match = regexp.exec('');\n\treturn !!(match && regexp.lastIndex === 0);\n}\n\nexport function joinStrings(items: (string | undefined | null | false)[], separator: string): string {\n\treturn items.filter(item => item !== undefined && item !== null && item !== false).join(separator);\n}\n\nexport function splitLines(str: string): string[] {\n\treturn str.split(/\\r\\n|\\r|\\n/);\n}\n\nexport function splitLinesIncludeSeparators(str: string): string[] {\n\tconst linesWithSeparators: string[] = [];\n\tconst splitLinesAndSeparators = str.split(/(\\r\\n|\\r|\\n)/);\n\tfor (let i = 0; i < Math.ceil(splitLinesAndSeparators.length / 2); i++) {\n\t\tlinesWithSeparators.push(splitLinesAndSeparators[2 * i] + (splitLinesAndSeparators[2 * i + 1] ?? ''));\n\t}\n\treturn linesWithSeparators;\n}\n\nexport function indexOfPattern(str: string, re: RegExp) {\n\tconst match = re.exec(str);\n\tif (match) {\n\t\treturn match.index;\n\t}\n\treturn -1;\n}\n\n/**\n * Returns first index of the string that is not whitespace.\n * If string is empty or contains only whitespaces, returns -1\n */\nexport function firstNonWhitespaceIndex(str: string): number {\n\tfor (let i = 0, len = str.length; i < len; i++) {\n\t\tconst chCode = str.charCodeAt(i);\n\t\tif (chCode !== CharCode.Space && chCode !== CharCode.Tab) {\n\t\t\treturn i;\n\t\t}\n\t}\n\treturn -1;\n}\n\n/**\n * Returns the leading whitespace of the string.\n * If the string contains only whitespaces, returns entire string\n */\nexport function getLeadingWhitespace(str: string, start: number = 0, end: number = str.length): string {\n\tfor (let i = start; i < end; i++) {\n\t\tconst chCode = str.charCodeAt(i);\n\t\tif (chCode !== CharCode.Space && chCode !== CharCode.Tab) {\n\t\t\treturn str.substring(start, i);\n\t\t}\n\t}\n\treturn str.substring(start, end);\n}\n\n/**\n * Returns last index of the string that is not whitespace.\n * If string is empty or contains only whitespaces, returns -1\n */\nexport function lastNonWhitespaceIndex(str: string, startIndex: number = str.length - 1): number {\n\tfor (let i = startIndex; i >= 0; i--) {\n\t\tconst chCode = str.charCodeAt(i);\n\t\tif (chCode !== CharCode.Space && chCode !== CharCode.Tab) {\n\t\t\treturn i;\n\t\t}\n\t}\n\treturn -1;\n}\n\nexport function getIndentationLength(str: string): number {\n\tconst idx = firstNonWhitespaceIndex(str);\n\tif (idx === -1) { return str.length; }\n\treturn idx;\n}\n\n/**\n * Function that works identically to String.prototype.replace, except, the\n * replace function is allowed to be async and return a Promise.\n */\nexport function replaceAsync(str: string, search: RegExp, replacer: (match: string, ...args: unknown[]) => Promise<string>): Promise<string> {\n\tconst parts: (string | Promise<string>)[] = [];\n\n\tlet last = 0;\n\tfor (const match of str.matchAll(search)) {\n\t\tparts.push(str.slice(last, match.index));\n\t\tif (match.index === undefined) {\n\t\t\tthrow new Error('match.index should be defined');\n\t\t}\n\n\t\tlast = match.index + match[0].length;\n\t\tparts.push(replacer(match[0], ...match.slice(1), match.index, str, match.groups));\n\t}\n\n\tparts.push(str.slice(last));\n\n\treturn Promise.all(parts).then(p => p.join(''));\n}\n\nexport function compare(a: string, b: string): number {\n\tif (a < b) {\n\t\treturn -1;\n\t} else if (a > b) {\n\t\treturn 1;\n\t} else {\n\t\treturn 0;\n\t}\n}\n\nexport function compareSubstring(a: string, b: string, aStart: number = 0, aEnd: number = a.length, bStart: number = 0, bEnd: number = b.length): number {\n\tfor (; aStart < aEnd && bStart < bEnd; aStart++, bStart++) {\n\t\tconst codeA = a.charCodeAt(aStart);\n\t\tconst codeB = b.charCodeAt(bStart);\n\t\tif (codeA < codeB) {\n\t\t\treturn -1;\n\t\t} else if (codeA > codeB) {\n\t\t\treturn 1;\n\t\t}\n\t}\n\tconst aLen = aEnd - aStart;\n\tconst bLen = bEnd - bStart;\n\tif (aLen < bLen) {\n\t\treturn -1;\n\t} else if (aLen > bLen) {\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nexport function compareIgnoreCase(a: string, b: string): number {\n\treturn compareSubstringIgnoreCase(a, b, 0, a.length, 0, b.length);\n}\n\nexport function compareSubstringIgnoreCase(a: string, b: string, aStart: number = 0, aEnd: number = a.length, bStart: number = 0, bEnd: number = b.length): number {\n\n\tfor (; aStart < aEnd && bStart < bEnd; aStart++, bStart++) {\n\n\t\tlet codeA = a.charCodeAt(aStart);\n\t\tlet codeB = b.charCodeAt(bStart);\n\n\t\tif (codeA === codeB) {\n\t\t\t// equal\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (codeA >= 128 || codeB >= 128) {\n\t\t\t// not ASCII letters -> fallback to lower-casing strings\n\t\t\treturn compareSubstring(a.toLowerCase(), b.toLowerCase(), aStart, aEnd, bStart, bEnd);\n\t\t}\n\n\t\t// mapper lower-case ascii letter onto upper-case varinats\n\t\t// [97-122] (lower ascii) --> [65-90] (upper ascii)\n\t\tif (isLowerAsciiLetter(codeA)) {\n\t\t\tcodeA -= 32;\n\t\t}\n\t\tif (isLowerAsciiLetter(codeB)) {\n\t\t\tcodeB -= 32;\n\t\t}\n\n\t\t// compare both code points\n\t\tconst diff = codeA - codeB;\n\t\tif (diff === 0) {\n\t\t\tcontinue;\n\t\t}\n\n\t\treturn diff;\n\t}\n\n\tconst aLen = aEnd - aStart;\n\tconst bLen = bEnd - bStart;\n\n\tif (aLen < bLen) {\n\t\treturn -1;\n\t} else if (aLen > bLen) {\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nexport function isAsciiDigit(code: number): boolean {\n\treturn code >= CharCode.Digit0 && code <= CharCode.Digit9;\n}\n\nexport function isLowerAsciiLetter(code: number): boolean {\n\treturn code >= CharCode.a && code <= CharCode.z;\n}\n\nexport function isUpperAsciiLetter(code: number): boolean {\n\treturn code >= CharCode.A && code <= CharCode.Z;\n}\n\nexport function equalsIgnoreCase(a: string, b: string): boolean {\n\treturn a.length === b.length && compareSubstringIgnoreCase(a, b) === 0;\n}\n\nexport function equals(a: string | undefined, b: string | undefined, ignoreCase?: boolean): boolean {\n\treturn a === b || (!!ignoreCase && a !== undefined && b !== undefined && equalsIgnoreCase(a, b));\n}\n\nexport function startsWithIgnoreCase(str: string, candidate: string): boolean {\n\tconst len = candidate.length;\n\treturn len <= str.length && compareSubstringIgnoreCase(str, candidate, 0, len) === 0;\n}\n\nexport function endsWithIgnoreCase(str: string, candidate: string): boolean {\n\tconst len = str.length;\n\tconst start = len - candidate.length;\n\treturn start >= 0 && compareSubstringIgnoreCase(str, candidate, start, len) === 0;\n}\n\n/**\n * @returns the length of the common prefix of the two strings.\n */\nexport function commonPrefixLength(a: string, b: string): number {\n\n\tconst len = Math.min(a.length, b.length);\n\tlet i: number;\n\n\tfor (i = 0; i < len; i++) {\n\t\tif (a.charCodeAt(i) !== b.charCodeAt(i)) {\n\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn len;\n}\n\n/**\n * @returns the length of the common suffix of the two strings.\n */\nexport function commonSuffixLength(a: string, b: string): number {\n\n\tconst len = Math.min(a.length, b.length);\n\tlet i: number;\n\n\tconst aLastIndex = a.length - 1;\n\tconst bLastIndex = b.length - 1;\n\n\tfor (i = 0; i < len; i++) {\n\t\tif (a.charCodeAt(aLastIndex - i) !== b.charCodeAt(bLastIndex - i)) {\n\t\t\treturn i;\n\t\t}\n\t}\n\n\treturn len;\n}\n\n/**\n * See http://en.wikipedia.org/wiki/Surrogate_pair\n */\nexport function isHighSurrogate(charCode: number): boolean {\n\treturn (0xD800 <= charCode && charCode <= 0xDBFF);\n}\n\n/**\n * See http://en.wikipedia.org/wiki/Surrogate_pair\n */\nexport function isLowSurrogate(charCode: number): boolean {\n\treturn (0xDC00 <= charCode && charCode <= 0xDFFF);\n}\n\n/**\n * See http://en.wikipedia.org/wiki/Surrogate_pair\n */\nexport function computeCodePoint(highSurrogate: number, lowSurrogate: number): number {\n\treturn ((highSurrogate - 0xD800) << 10) + (lowSurrogate - 0xDC00) + 0x10000;\n}\n\n/**\n * get the code point that begins at offset `offset`\n */\nexport function getNextCodePoint(str: string, len: number, offset: number): number {\n\tconst charCode = str.charCodeAt(offset);\n\tif (isHighSurrogate(charCode) && offset + 1 < len) {\n\t\tconst nextCharCode = str.charCodeAt(offset + 1);\n\t\tif (isLowSurrogate(nextCharCode)) {\n\t\t\treturn computeCodePoint(charCode, nextCharCode);\n\t\t}\n\t}\n\treturn charCode;\n}\n\n/**\n * get the code point that ends right before offset `offset`\n */\nfunction getPrevCodePoint(str: string, offset: number): number {\n\tconst charCode = str.charCodeAt(offset - 1);\n\tif (isLowSurrogate(charCode) && offset > 1) {\n\t\tconst prevCharCode = str.charCodeAt(offset - 2);\n\t\tif (isHighSurrogate(prevCharCode)) {\n\t\t\treturn computeCodePoint(prevCharCode, charCode);\n\t\t}\n\t}\n\treturn charCode;\n}\n\nexport class CodePointIterator {\n\n\tprivate readonly _str: string;\n\tprivate readonly _len: number;\n\tprivate _offset: number;\n\n\tpublic get offset(): number {\n\t\treturn this._offset;\n\t}\n\n\tconstructor(str: string, offset: number = 0) {\n\t\tthis._str = str;\n\t\tthis._len = str.length;\n\t\tthis._offset = offset;\n\t}\n\n\tpublic setOffset(offset: number): void {\n\t\tthis._offset = offset;\n\t}\n\n\tpublic prevCodePoint(): number {\n\t\tconst codePoint = getPrevCodePoint(this._str, this._offset);\n\t\tthis._offset -= (codePoint >= Constants.UNICODE_SUPPLEMENTARY_PLANE_BEGIN ? 2 : 1);\n\t\treturn codePoint;\n\t}\n\n\tpublic nextCodePoint(): number {\n\t\tconst codePoint = getNextCodePoint(this._str, this._len, this._offset);\n\t\tthis._offset += (codePoint >= Constants.UNICODE_SUPPLEMENTARY_PLANE_BEGIN ? 2 : 1);\n\t\treturn codePoint;\n\t}\n\n\tpublic eol(): boolean {\n\t\treturn (this._offset >= this._len);\n\t}\n}\n\nexport class GraphemeIterator {\n\n\tprivate readonly _iterator: CodePointIterator;\n\n\tpublic get offset(): number {\n\t\treturn this._iterator.offset;\n\t}\n\n\tconstructor(str: string, offset: number = 0) {\n\t\tthis._iterator = new CodePointIterator(str, offset);\n\t}\n\n\tpublic nextGraphemeLength(): number {\n\t\tconst graphemeBreakTree = GraphemeBreakTree.getInstance();\n\t\tconst iterator = this._iterator;\n\t\tconst initialOffset = iterator.offset;\n\n\t\tlet graphemeBreakType = graphemeBreakTree.getGraphemeBreakType(iterator.nextCodePoint());\n\t\twhile (!iterator.eol()) {\n\t\t\tconst offset = iterator.offset;\n\t\t\tconst nextGraphemeBreakType = graphemeBreakTree.getGraphemeBreakType(iterator.nextCodePoint());\n\t\t\tif (breakBetweenGraphemeBreakType(graphemeBreakType, nextGraphemeBreakType)) {\n\t\t\t\t// move iterator back\n\t\t\t\titerator.setOffset(offset);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tgraphemeBreakType = nextGraphemeBreakType;\n\t\t}\n\t\treturn (iterator.offset - initialOffset);\n\t}\n\n\tpublic prevGraphemeLength(): number {\n\t\tconst graphemeBreakTree = GraphemeBreakTree.getInstance();\n\t\tconst iterator = this._iterator;\n\t\tconst initialOffset = iterator.offset;\n\n\t\tlet graphemeBreakType = graphemeBreakTree.getGraphemeBreakType(iterator.prevCodePoint());\n\t\twhile (iterator.offset > 0) {\n\t\t\tconst offset = iterator.offset;\n\t\t\tconst prevGraphemeBreakType = graphemeBreakTree.getGraphemeBreakType(iterator.prevCodePoint());\n\t\t\tif (breakBetweenGraphemeBreakType(prevGraphemeBreakType, graphemeBreakType)) {\n\t\t\t\t// move iterator back\n\t\t\t\titerator.setOffset(offset);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tgraphemeBreakType = prevGraphemeBreakType;\n\t\t}\n\t\treturn (initialOffset - iterator.offset);\n\t}\n\n\tpublic eol(): boolean {\n\t\treturn this._iterator.eol();\n\t}\n}\n\nexport function nextCharLength(str: string, initialOffset: number): number {\n\tconst iterator = new GraphemeIterator(str, initialOffset);\n\treturn iterator.nextGraphemeLength();\n}\n\nexport function prevCharLength(str: string, initialOffset: number): number {\n\tconst iterator = new GraphemeIterator(str, initialOffset);\n\treturn iterator.prevGraphemeLength();\n}\n\nexport function getCharContainingOffset(str: string, offset: number): [number, number] {\n\tif (offset > 0 && isLowSurrogate(str.charCodeAt(offset))) {\n\t\toffset--;\n\t}\n\tconst endOffset = offset + nextCharLength(str, offset);\n\tconst startOffset = endOffset - prevCharLength(str, endOffset);\n\treturn [startOffset, endOffset];\n}\n\nexport function charCount(str: string): number {\n\tconst iterator = new GraphemeIterator(str);\n\tlet length = 0;\n\twhile (!iterator.eol()) {\n\t\tlength++;\n\t\titerator.nextGraphemeLength();\n\t}\n\treturn length;\n}\n\nlet CONTAINS_RTL: RegExp | undefined = undefined;\n\nfunction makeContainsRtl() {\n\t// Generated using https://github.com/alexdima/unicode-utils/blob/main/rtl-test.js\n\treturn /(?:[\\u05BE\\u05C0\\u05C3\\u05C6\\u05D0-\\u05F4\\u0608\\u060B\\u060D\\u061B-\\u064A\\u066D-\\u066F\\u0671-\\u06D5\\u06E5\\u06E6\\u06EE\\u06EF\\u06FA-\\u0710\\u0712-\\u072F\\u074D-\\u07A5\\u07B1-\\u07EA\\u07F4\\u07F5\\u07FA\\u07FE-\\u0815\\u081A\\u0824\\u0828\\u0830-\\u0858\\u085E-\\u088E\\u08A0-\\u08C9\\u200F\\uFB1D\\uFB1F-\\uFB28\\uFB2A-\\uFD3D\\uFD50-\\uFDC7\\uFDF0-\\uFDFC\\uFE70-\\uFEFC]|\\uD802[\\uDC00-\\uDD1B\\uDD20-\\uDE00\\uDE10-\\uDE35\\uDE40-\\uDEE4\\uDEEB-\\uDF35\\uDF40-\\uDFFF]|\\uD803[\\uDC00-\\uDD23\\uDE80-\\uDEA9\\uDEAD-\\uDF45\\uDF51-\\uDF81\\uDF86-\\uDFF6]|\\uD83A[\\uDC00-\\uDCCF\\uDD00-\\uDD43\\uDD4B-\\uDFFF]|\\uD83B[\\uDC00-\\uDEBB])/;\n}\n\n/**\n * Returns true if `str` contains any Unicode character that is classified as \"R\" or \"AL\".\n */\nexport function containsRTL(str: string): boolean {\n\tif (!CONTAINS_RTL) {\n\t\tCONTAINS_RTL = makeContainsRtl();\n\t}\n\n\treturn CONTAINS_RTL.test(str);\n}\n\nconst IS_BASIC_ASCII = /^[\\t\\n\\r\\x20-\\x7E]*$/;\n/**\n * Returns true if `str` contains only basic ASCII characters in the range 32 - 126 (including 32 and 126) or \\n, \\r, \\t\n */\nexport function isBasicASCII(str: string): boolean {\n\treturn IS_BASIC_ASCII.test(str);\n}\n\nexport const UNUSUAL_LINE_TERMINATORS = /[\\u2028\\u2029]/; // LINE SEPARATOR (LS) or PARAGRAPH SEPARATOR (PS)\n/**\n * Returns true if `str` contains unusual line terminators, like LS or PS\n */\nexport function containsUnusualLineTerminators(str: string): boolean {\n\treturn UNUSUAL_LINE_TERMINATORS.test(str);\n}\n\nexport function isFullWidthCharacter(charCode: number): boolean {\n\t// Do a cheap trick to better support wrapping of wide characters, treat them as 2 columns\n\t// http://jrgraphix.net/research/unicode_blocks.php\n\t//          2E80 - 2EFF   CJK Radicals Supplement\n\t//          2F00 - 2FDF   Kangxi Radicals\n\t//          2FF0 - 2FFF   Ideographic Description Characters\n\t//          3000 - 303F   CJK Symbols and Punctuation\n\t//          3040 - 309F   Hiragana\n\t//          30A0 - 30FF   Katakana\n\t//          3100 - 312F   Bopomofo\n\t//          3130 - 318F   Hangul Compatibility Jamo\n\t//          3190 - 319F   Kanbun\n\t//          31A0 - 31BF   Bopomofo Extended\n\t//          31F0 - 31FF   Katakana Phonetic Extensions\n\t//          3200 - 32FF   Enclosed CJK Letters and Months\n\t//          3300 - 33FF   CJK Compatibility\n\t//          3400 - 4DBF   CJK Unified Ideographs Extension A\n\t//          4DC0 - 4DFF   Yijing Hexagram Symbols\n\t//          4E00 - 9FFF   CJK Unified Ideographs\n\t//          A000 - A48F   Yi Syllables\n\t//          A490 - A4CF   Yi Radicals\n\t//          AC00 - D7AF   Hangul Syllables\n\t// [IGNORE] D800 - DB7F   High Surrogates\n\t// [IGNORE] DB80 - DBFF   High Private Use Surrogates\n\t// [IGNORE] DC00 - DFFF   Low Surrogates\n\t// [IGNORE] E000 - F8FF   Private Use Area\n\t//          F900 - FAFF   CJK Compatibility Ideographs\n\t// [IGNORE] FB00 - FB4F   Alphabetic Presentation Forms\n\t// [IGNORE] FB50 - FDFF   Arabic Presentation Forms-A\n\t// [IGNORE] FE00 - FE0F   Variation Selectors\n\t// [IGNORE] FE20 - FE2F   Combining Half Marks\n\t// [IGNORE] FE30 - FE4F   CJK Compatibility Forms\n\t// [IGNORE] FE50 - FE6F   Small Form Variants\n\t// [IGNORE] FE70 - FEFF   Arabic Presentation Forms-B\n\t//          FF00 - FFEF   Halfwidth and Fullwidth Forms\n\t//               [https://en.wikipedia.org/wiki/Halfwidth_and_fullwidth_forms]\n\t//               of which FF01 - FF5E fullwidth ASCII of 21 to 7E\n\t//               and FFE0 - FFE6 fullwidth symbol variants\n\t// [IGNORE]    and FF65 - FFDC halfwidth of Katakana and Hangul\n\t// [IGNORE] FFF0 - FFFF   Specials\n\treturn (\n\t\t(charCode >= 0x2E80 && charCode <= 0xD7AF)\n\t\t|| (charCode >= 0xF900 && charCode <= 0xFAFF)\n\t\t|| (charCode >= 0xFF01 && charCode <= 0xFF5E)\n\t\t|| (charCode >= 0xFFE0 && charCode <= 0xFFE6)\n\t);\n}\n\n/**\n * A fast function (therefore imprecise) to check if code points are emojis.\n * Generated using https://github.com/alexdima/unicode-utils/blob/main/emoji-test.js\n */\nexport function isEmojiImprecise(x: number): boolean {\n\treturn (\n\t\t(x >= 0x1F1E6 && x <= 0x1F1FF) || (x === 8986) || (x === 8987) || (x === 9200)\n\t\t|| (x === 9203) || (x >= 9728 && x <= 10175) || (x === 11088) || (x === 11093)\n\t\t|| (x >= 127744 && x <= 128591) || (x >= 128640 && x <= 128764)\n\t\t|| (x >= 128992 && x <= 129008) || (x >= 129280 && x <= 129535)\n\t\t|| (x >= 129648 && x <= 129782)\n\t);\n}\n\n/**\n * Given a string and a max length returns a shorted version. Shorting\n * happens at favorable positions - such as whitespace or punctuation characters.\n * The return value can be longer than the given value of `n`. Leading whitespace is always trimmed.\n */\nexport function lcut(text: string, n: number, prefix = ''): string {\n\tconst trimmed = text.trimStart();\n\n\tif (trimmed.length < n) {\n\t\treturn trimmed;\n\t}\n\n\tconst re = /\\b/g;\n\tlet i = 0;\n\twhile (re.test(trimmed)) {\n\t\tif (trimmed.length - re.lastIndex < n) {\n\t\t\tbreak;\n\t\t}\n\n\t\ti = re.lastIndex;\n\t\tre.lastIndex += 1;\n\t}\n\n\tif (i === 0) {\n\t\treturn trimmed;\n\t}\n\n\treturn prefix + trimmed.substring(i).trimStart();\n}\n\n// Defacto standard: https://invisible-island.net/xterm/ctlseqs/ctlseqs.html\nconst CSI_SEQUENCE = /(?:\\x1b\\[|\\x9b)[=?>!]?[\\d;:]*[\"$#'* ]?[a-zA-Z@^`{}|~]/;\nconst OSC_SEQUENCE = /(?:\\x1b\\]|\\x9d).*?(?:\\x1b\\\\|\\x07|\\x9c)/;\nconst ESC_SEQUENCE = /\\x1b(?:[ #%\\(\\)\\*\\+\\-\\.\\/]?[a-zA-Z0-9\\|}~@])/;\nconst CONTROL_SEQUENCES = new RegExp('(?:' + [\n\tCSI_SEQUENCE.source,\n\tOSC_SEQUENCE.source,\n\tESC_SEQUENCE.source,\n].join('|') + ')', 'g');\n\n/** Iterates over parts of a string with CSI sequences */\nexport function* forAnsiStringParts(str: string) {\n\tlet last = 0;\n\tfor (const match of str.matchAll(CONTROL_SEQUENCES)) {\n\t\tif (last !== match.index) {\n\t\t\tyield { isCode: false, str: str.substring(last, match.index) };\n\t\t}\n\n\t\tyield { isCode: true, str: match[0] };\n\t\tlast = match.index + match[0].length;\n\t}\n\n\tif (last !== str.length) {\n\t\tyield { isCode: false, str: str.substring(last) };\n\t}\n}\n\n/**\n * Strips ANSI escape sequences from a string.\n * @param str The dastringa stringo strip the ANSI escape sequences from.\n *\n * @example\n * removeAnsiEscapeCodes('\\u001b[31mHello, World!\\u001b[0m');\n * // 'Hello, World!'\n */\nexport function removeAnsiEscapeCodes(str: string): string {\n\tif (str) {\n\t\tstr = str.replace(CONTROL_SEQUENCES, '');\n\t}\n\n\treturn str;\n}\n\nconst PROMPT_NON_PRINTABLE = /\\\\\\[.*?\\\\\\]/g;\n\n/**\n * Strips ANSI escape sequences from a UNIX-style prompt string (eg. `$PS1`).\n * @param str The string to strip the ANSI escape sequences from.\n *\n * @example\n * removeAnsiEscapeCodesFromPrompt('\\n\\\\[\\u001b[01;34m\\\\]\\\\w\\\\[\\u001b[00m\\\\]\\n\\\\[\\u001b[1;32m\\\\]> \\\\[\\u001b[0m\\\\]');\n * // '\\n\\\\w\\n> '\n */\nexport function removeAnsiEscapeCodesFromPrompt(str: string): string {\n\treturn removeAnsiEscapeCodes(str).replace(PROMPT_NON_PRINTABLE, '');\n}\n\n\n// -- UTF-8 BOM\n\nexport const UTF8_BOM_CHARACTER = String.fromCharCode(CharCode.UTF8_BOM);\n\nexport function startsWithUTF8BOM(str: string): boolean {\n\treturn !!(str && str.length > 0 && str.charCodeAt(0) === CharCode.UTF8_BOM);\n}\n\nexport function stripUTF8BOM(str: string): string {\n\treturn startsWithUTF8BOM(str) ? str.substr(1) : str;\n}\n\n/**\n * Checks if the characters of the provided query string are included in the\n * target string. The characters do not have to be contiguous within the string.\n */\nexport function fuzzyContains(target: string, query: string): boolean {\n\tif (!target || !query) {\n\t\treturn false; // return early if target or query are undefined\n\t}\n\n\tif (target.length < query.length) {\n\t\treturn false; // impossible for query to be contained in target\n\t}\n\n\tconst queryLen = query.length;\n\tconst targetLower = target.toLowerCase();\n\n\tlet index = 0;\n\tlet lastIndexOf = -1;\n\twhile (index < queryLen) {\n\t\tconst indexOf = targetLower.indexOf(query[index], lastIndexOf + 1);\n\t\tif (indexOf < 0) {\n\t\t\treturn false;\n\t\t}\n\n\t\tlastIndexOf = indexOf;\n\n\t\tindex++;\n\t}\n\n\treturn true;\n}\n\nexport function containsUppercaseCharacter(target: string, ignoreEscapedChars = false): boolean {\n\tif (!target) {\n\t\treturn false;\n\t}\n\n\tif (ignoreEscapedChars) {\n\t\ttarget = target.replace(/\\\\./g, '');\n\t}\n\n\treturn target.toLowerCase() !== target;\n}\n\nexport function uppercaseFirstLetter(str: string): string {\n\treturn str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nexport function getNLines(str: string, n = 1): string {\n\tif (n === 0) {\n\t\treturn '';\n\t}\n\n\tlet idx = -1;\n\tdo {\n\t\tidx = str.indexOf('\\n', idx + 1);\n\t\tn--;\n\t} while (n > 0 && idx >= 0);\n\n\tif (idx === -1) {\n\t\treturn str;\n\t}\n\n\tif (str[idx - 1] === '\\r') {\n\t\tidx--;\n\t}\n\n\treturn str.substr(0, idx);\n}\n\n/**\n * Produces 'a'-'z', followed by 'A'-'Z'... followed by 'a'-'z', etc.\n */\nexport function singleLetterHash(n: number): string {\n\tconst LETTERS_CNT = (CharCode.Z - CharCode.A + 1);\n\n\tn = n % (2 * LETTERS_CNT);\n\n\tif (n < LETTERS_CNT) {\n\t\treturn String.fromCharCode(CharCode.a + n);\n\t}\n\n\treturn String.fromCharCode(CharCode.A + n - LETTERS_CNT);\n}\n\n//#region Unicode Grapheme Break\n\nexport function getGraphemeBreakType(codePoint: number): GraphemeBreakType {\n\tconst graphemeBreakTree = GraphemeBreakTree.getInstance();\n\treturn graphemeBreakTree.getGraphemeBreakType(codePoint);\n}\n\nfunction breakBetweenGraphemeBreakType(breakTypeA: GraphemeBreakType, breakTypeB: GraphemeBreakType): boolean {\n\t// http://www.unicode.org/reports/tr29/#Grapheme_Cluster_Boundary_Rules\n\n\t// !!! Let's make the common case a bit faster\n\tif (breakTypeA === GraphemeBreakType.Other) {\n\t\t// see https://www.unicode.org/Public/13.0.0/ucd/auxiliary/GraphemeBreakTest-13.0.0d10.html#table\n\t\treturn (breakTypeB !== GraphemeBreakType.Extend && breakTypeB !== GraphemeBreakType.SpacingMark);\n\t}\n\n\t// Do not break between a CR and LF. Otherwise, break before and after controls.\n\t// GB3                                        CR  LF\n\t// GB4                       (Control | CR | LF) \n\t// GB5                                            (Control | CR | LF)\n\tif (breakTypeA === GraphemeBreakType.CR) {\n\t\tif (breakTypeB === GraphemeBreakType.LF) {\n\t\t\treturn false; // GB3\n\t\t}\n\t}\n\tif (breakTypeA === GraphemeBreakType.Control || breakTypeA === GraphemeBreakType.CR || breakTypeA === GraphemeBreakType.LF) {\n\t\treturn true; // GB4\n\t}\n\tif (breakTypeB === GraphemeBreakType.Control || breakTypeB === GraphemeBreakType.CR || breakTypeB === GraphemeBreakType.LF) {\n\t\treturn true; // GB5\n\t}\n\n\t// Do not break Hangul syllable sequences.\n\t// GB6                                         L  (L | V | LV | LVT)\n\t// GB7                                  (LV | V)  (V | T)\n\t// GB8                                 (LVT | T)  T\n\tif (breakTypeA === GraphemeBreakType.L) {\n\t\tif (breakTypeB === GraphemeBreakType.L || breakTypeB === GraphemeBreakType.V || breakTypeB === GraphemeBreakType.LV || breakTypeB === GraphemeBreakType.LVT) {\n\t\t\treturn false; // GB6\n\t\t}\n\t}\n\tif (breakTypeA === GraphemeBreakType.LV || breakTypeA === GraphemeBreakType.V) {\n\t\tif (breakTypeB === GraphemeBreakType.V || breakTypeB === GraphemeBreakType.T) {\n\t\t\treturn false; // GB7\n\t\t}\n\t}\n\tif (breakTypeA === GraphemeBreakType.LVT || breakTypeA === GraphemeBreakType.T) {\n\t\tif (breakTypeB === GraphemeBreakType.T) {\n\t\t\treturn false; // GB8\n\t\t}\n\t}\n\n\t// Do not break before extending characters or ZWJ.\n\t// GB9                                            (Extend | ZWJ)\n\tif (breakTypeB === GraphemeBreakType.Extend || breakTypeB === GraphemeBreakType.ZWJ) {\n\t\treturn false; // GB9\n\t}\n\n\t// The GB9a and GB9b rules only apply to extended grapheme clusters:\n\t// Do not break before SpacingMarks, or after Prepend characters.\n\t// GB9a                                           SpacingMark\n\t// GB9b                                  Prepend \n\tif (breakTypeB === GraphemeBreakType.SpacingMark) {\n\t\treturn false; // GB9a\n\t}\n\tif (breakTypeA === GraphemeBreakType.Prepend) {\n\t\treturn false; // GB9b\n\t}\n\n\t// Do not break within emoji modifier sequences or emoji zwj sequences.\n\t// GB11    \\p{Extended_Pictographic} Extend* ZWJ  \\p{Extended_Pictographic}\n\tif (breakTypeA === GraphemeBreakType.ZWJ && breakTypeB === GraphemeBreakType.Extended_Pictographic) {\n\t\t// Note: we are not implementing the rule entirely here to avoid introducing states\n\t\treturn false; // GB11\n\t}\n\n\t// GB12                          sot (RI RI)* RI  RI\n\t// GB13                        [^RI] (RI RI)* RI  RI\n\tif (breakTypeA === GraphemeBreakType.Regional_Indicator && breakTypeB === GraphemeBreakType.Regional_Indicator) {\n\t\t// Note: we are not implementing the rule entirely here to avoid introducing states\n\t\treturn false; // GB12 & GB13\n\t}\n\n\t// GB999                                     Any  Any\n\treturn true;\n}\n\nexport const enum GraphemeBreakType {\n\tOther = 0,\n\tPrepend = 1,\n\tCR = 2,\n\tLF = 3,\n\tControl = 4,\n\tExtend = 5,\n\tRegional_Indicator = 6,\n\tSpacingMark = 7,\n\tL = 8,\n\tV = 9,\n\tT = 10,\n\tLV = 11,\n\tLVT = 12,\n\tZWJ = 13,\n\tExtended_Pictographic = 14\n}\n\nclass GraphemeBreakTree {\n\n\tprivate static _INSTANCE: GraphemeBreakTree | null = null;\n\tpublic static getInstance(): GraphemeBreakTree {\n\t\tif (!GraphemeBreakTree._INSTANCE) {\n\t\t\tGraphemeBreakTree._INSTANCE = new GraphemeBreakTree();\n\t\t}\n\t\treturn GraphemeBreakTree._INSTANCE;\n\t}\n\n\tprivate readonly _data: number[];\n\n\tconstructor() {\n\t\tthis._data = getGraphemeBreakRawData();\n\t}\n\n\tpublic getGraphemeBreakType(codePoint: number): GraphemeBreakType {\n\t\t// !!! Let's make 7bit ASCII a bit faster: 0..31\n\t\tif (codePoint < 32) {\n\t\t\tif (codePoint === CharCode.LineFeed) {\n\t\t\t\treturn GraphemeBreakType.LF;\n\t\t\t}\n\t\t\tif (codePoint === CharCode.CarriageReturn) {\n\t\t\t\treturn GraphemeBreakType.CR;\n\t\t\t}\n\t\t\treturn GraphemeBreakType.Control;\n\t\t}\n\t\t// !!! Let's make 7bit ASCII a bit faster: 32..126\n\t\tif (codePoint < 127) {\n\t\t\treturn GraphemeBreakType.Other;\n\t\t}\n\n\t\tconst data = this._data;\n\t\tconst nodeCount = data.length / 3;\n\t\tlet nodeIndex = 1;\n\t\twhile (nodeIndex <= nodeCount) {\n\t\t\tif (codePoint < data[3 * nodeIndex]) {\n\t\t\t\t// go left\n\t\t\t\tnodeIndex = 2 * nodeIndex;\n\t\t\t} else if (codePoint > data[3 * nodeIndex + 1]) {\n\t\t\t\t// go right\n\t\t\t\tnodeIndex = 2 * nodeIndex + 1;\n\t\t\t} else {\n\t\t\t\t// hit\n\t\t\t\treturn data[3 * nodeIndex + 2];\n\t\t\t}\n\t\t}\n\n\t\treturn GraphemeBreakType.Other;\n\t}\n}\n\nfunction getGraphemeBreakRawData(): number[] {\n\t// generated using https://github.com/alexdima/unicode-utils/blob/main/grapheme-break.js\n\treturn JSON.parse('[0,0,0,51229,51255,12,44061,44087,12,127462,127487,6,7083,7085,5,47645,47671,12,54813,54839,12,128678,128678,14,3270,3270,5,9919,9923,14,45853,45879,12,49437,49463,12,53021,53047,12,71216,71218,7,128398,128399,14,129360,129374,14,2519,2519,5,4448,4519,9,9742,9742,14,12336,12336,14,44957,44983,12,46749,46775,12,48541,48567,12,50333,50359,12,52125,52151,12,53917,53943,12,69888,69890,5,73018,73018,5,127990,127990,14,128558,128559,14,128759,128760,14,129653,129655,14,2027,2035,5,2891,2892,7,3761,3761,5,6683,6683,5,8293,8293,4,9825,9826,14,9999,9999,14,43452,43453,5,44509,44535,12,45405,45431,12,46301,46327,12,47197,47223,12,48093,48119,12,48989,49015,12,49885,49911,12,50781,50807,12,51677,51703,12,52573,52599,12,53469,53495,12,54365,54391,12,65279,65279,4,70471,70472,7,72145,72147,7,119173,119179,5,127799,127818,14,128240,128244,14,128512,128512,14,128652,128652,14,128721,128722,14,129292,129292,14,129445,129450,14,129734,129743,14,1476,1477,5,2366,2368,7,2750,2752,7,3076,3076,5,3415,3415,5,4141,4144,5,6109,6109,5,6964,6964,5,7394,7400,5,9197,9198,14,9770,9770,14,9877,9877,14,9968,9969,14,10084,10084,14,43052,43052,5,43713,43713,5,44285,44311,12,44733,44759,12,45181,45207,12,45629,45655,12,46077,46103,12,46525,46551,12,46973,46999,12,47421,47447,12,47869,47895,12,48317,48343,12,48765,48791,12,49213,49239,12,49661,49687,12,50109,50135,12,50557,50583,12,51005,51031,12,51453,51479,12,51901,51927,12,52349,52375,12,52797,52823,12,53245,53271,12,53693,53719,12,54141,54167,12,54589,54615,12,55037,55063,12,69506,69509,5,70191,70193,5,70841,70841,7,71463,71467,5,72330,72342,5,94031,94031,5,123628,123631,5,127763,127765,14,127941,127941,14,128043,128062,14,128302,128317,14,128465,128467,14,128539,128539,14,128640,128640,14,128662,128662,14,128703,128703,14,128745,128745,14,129004,129007,14,129329,129330,14,129402,129402,14,129483,129483,14,129686,129704,14,130048,131069,14,173,173,4,1757,1757,1,2200,2207,5,2434,2435,7,2631,2632,5,2817,2817,5,3008,3008,5,3201,3201,5,3387,3388,5,3542,3542,5,3902,3903,7,4190,4192,5,6002,6003,5,6439,6440,5,6765,6770,7,7019,7027,5,7154,7155,7,8205,8205,13,8505,8505,14,9654,9654,14,9757,9757,14,9792,9792,14,9852,9853,14,9890,9894,14,9937,9937,14,9981,9981,14,10035,10036,14,11035,11036,14,42654,42655,5,43346,43347,7,43587,43587,5,44006,44007,7,44173,44199,12,44397,44423,12,44621,44647,12,44845,44871,12,45069,45095,12,45293,45319,12,45517,45543,12,45741,45767,12,45965,45991,12,46189,46215,12,46413,46439,12,46637,46663,12,46861,46887,12,47085,47111,12,47309,47335,12,47533,47559,12,47757,47783,12,47981,48007,12,48205,48231,12,48429,48455,12,48653,48679,12,48877,48903,12,49101,49127,12,49325,49351,12,49549,49575,12,49773,49799,12,49997,50023,12,50221,50247,12,50445,50471,12,50669,50695,12,50893,50919,12,51117,51143,12,51341,51367,12,51565,51591,12,51789,51815,12,52013,52039,12,52237,52263,12,52461,52487,12,52685,52711,12,52909,52935,12,53133,53159,12,53357,53383,12,53581,53607,12,53805,53831,12,54029,54055,12,54253,54279,12,54477,54503,12,54701,54727,12,54925,54951,12,55149,55175,12,68101,68102,5,69762,69762,7,70067,70069,7,70371,70378,5,70720,70721,7,71087,71087,5,71341,71341,5,71995,71996,5,72249,72249,7,72850,72871,5,73109,73109,5,118576,118598,5,121505,121519,5,127245,127247,14,127568,127569,14,127777,127777,14,127872,127891,14,127956,127967,14,128015,128016,14,128110,128172,14,128259,128259,14,128367,128368,14,128424,128424,14,128488,128488,14,128530,128532,14,128550,128551,14,128566,128566,14,128647,128647,14,128656,128656,14,128667,128673,14,128691,128693,14,128715,128715,14,128728,128732,14,128752,128752,14,128765,128767,14,129096,129103,14,129311,129311,14,129344,129349,14,129394,129394,14,129413,129425,14,129466,129471,14,129511,129535,14,129664,129666,14,129719,129722,14,129760,129767,14,917536,917631,5,13,13,2,1160,1161,5,1564,1564,4,1807,1807,1,2085,2087,5,2307,2307,7,2382,2383,7,2497,2500,5,2563,2563,7,2677,2677,5,2763,2764,7,2879,2879,5,2914,2915,5,3021,3021,5,3142,3144,5,3263,3263,5,3285,3286,5,3398,3400,7,3530,3530,5,3633,3633,5,3864,3865,5,3974,3975,5,4155,4156,7,4229,4230,5,5909,5909,7,6078,6085,7,6277,6278,5,6451,6456,7,6744,6750,5,6846,6846,5,6972,6972,5,7074,7077,5,7146,7148,7,7222,7223,5,7416,7417,5,8234,8238,4,8417,8417,5,9000,9000,14,9203,9203,14,9730,9731,14,9748,9749,14,9762,9763,14,9776,9783,14,9800,9811,14,9831,9831,14,9872,9873,14,9882,9882,14,9900,9903,14,9929,9933,14,9941,9960,14,9974,9974,14,9989,9989,14,10006,10006,14,10062,10062,14,10160,10160,14,11647,11647,5,12953,12953,14,43019,43019,5,43232,43249,5,43443,43443,5,43567,43568,7,43696,43696,5,43765,43765,7,44013,44013,5,44117,44143,12,44229,44255,12,44341,44367,12,44453,44479,12,44565,44591,12,44677,44703,12,44789,44815,12,44901,44927,12,45013,45039,12,45125,45151,12,45237,45263,12,45349,45375,12,45461,45487,12,45573,45599,12,45685,45711,12,45797,45823,12,45909,45935,12,46021,46047,12,46133,46159,12,46245,46271,12,46357,46383,12,46469,46495,12,46581,46607,12,46693,46719,12,46805,46831,12,46917,46943,12,47029,47055,12,47141,47167,12,47253,47279,12,47365,47391,12,47477,47503,12,47589,47615,12,47701,47727,12,47813,47839,12,47925,47951,12,48037,48063,12,48149,48175,12,48261,48287,12,48373,48399,12,48485,48511,12,48597,48623,12,48709,48735,12,48821,48847,12,48933,48959,12,49045,49071,12,49157,49183,12,49269,49295,12,49381,49407,12,49493,49519,12,49605,49631,12,49717,49743,12,49829,49855,12,49941,49967,12,50053,50079,12,50165,50191,12,50277,50303,12,50389,50415,12,50501,50527,12,50613,50639,12,50725,50751,12,50837,50863,12,50949,50975,12,51061,51087,12,51173,51199,12,51285,51311,12,51397,51423,12,51509,51535,12,51621,51647,12,51733,51759,12,51845,51871,12,51957,51983,12,52069,52095,12,52181,52207,12,52293,52319,12,52405,52431,12,52517,52543,12,52629,52655,12,52741,52767,12,52853,52879,12,52965,52991,12,53077,53103,12,53189,53215,12,53301,53327,12,53413,53439,12,53525,53551,12,53637,53663,12,53749,53775,12,53861,53887,12,53973,53999,12,54085,54111,12,54197,54223,12,54309,54335,12,54421,54447,12,54533,54559,12,54645,54671,12,54757,54783,12,54869,54895,12,54981,55007,12,55093,55119,12,55243,55291,10,66045,66045,5,68325,68326,5,69688,69702,5,69817,69818,5,69957,69958,7,70089,70092,5,70198,70199,5,70462,70462,5,70502,70508,5,70750,70750,5,70846,70846,7,71100,71101,5,71230,71230,7,71351,71351,5,71737,71738,5,72000,72000,7,72160,72160,5,72273,72278,5,72752,72758,5,72882,72883,5,73031,73031,5,73461,73462,7,94192,94193,7,119149,119149,7,121403,121452,5,122915,122916,5,126980,126980,14,127358,127359,14,127535,127535,14,127759,127759,14,127771,127771,14,127792,127793,14,127825,127867,14,127897,127899,14,127945,127945,14,127985,127986,14,128000,128007,14,128021,128021,14,128066,128100,14,128184,128235,14,128249,128252,14,128266,128276,14,128335,128335,14,128379,128390,14,128407,128419,14,128444,128444,14,128481,128481,14,128499,128499,14,128526,128526,14,128536,128536,14,128543,128543,14,128556,128556,14,128564,128564,14,128577,128580,14,128643,128645,14,128649,128649,14,128654,128654,14,128660,128660,14,128664,128664,14,128675,128675,14,128686,128689,14,128695,128696,14,128705,128709,14,128717,128719,14,128725,128725,14,128736,128741,14,128747,128748,14,128755,128755,14,128762,128762,14,128981,128991,14,129009,129023,14,129160,129167,14,129296,129304,14,129320,129327,14,129340,129342,14,129356,129356,14,129388,129392,14,129399,129400,14,129404,129407,14,129432,129442,14,129454,129455,14,129473,129474,14,129485,129487,14,129648,129651,14,129659,129660,14,129671,129679,14,129709,129711,14,129728,129730,14,129751,129753,14,129776,129782,14,917505,917505,4,917760,917999,5,10,10,3,127,159,4,768,879,5,1471,1471,5,1536,1541,1,1648,1648,5,1767,1768,5,1840,1866,5,2070,2073,5,2137,2139,5,2274,2274,1,2363,2363,7,2377,2380,7,2402,2403,5,2494,2494,5,2507,2508,7,2558,2558,5,2622,2624,7,2641,2641,5,2691,2691,7,2759,2760,5,2786,2787,5,2876,2876,5,2881,2884,5,2901,2902,5,3006,3006,5,3014,3016,7,3072,3072,5,3134,3136,5,3157,3158,5,3260,3260,5,3266,3266,5,3274,3275,7,3328,3329,5,3391,3392,7,3405,3405,5,3457,3457,5,3536,3537,7,3551,3551,5,3636,3642,5,3764,3772,5,3895,3895,5,3967,3967,7,3993,4028,5,4146,4151,5,4182,4183,7,4226,4226,5,4253,4253,5,4957,4959,5,5940,5940,7,6070,6070,7,6087,6088,7,6158,6158,4,6432,6434,5,6448,6449,7,6679,6680,5,6742,6742,5,6754,6754,5,6783,6783,5,6912,6915,5,6966,6970,5,6978,6978,5,7042,7042,7,7080,7081,5,7143,7143,7,7150,7150,7,7212,7219,5,7380,7392,5,7412,7412,5,8203,8203,4,8232,8232,4,8265,8265,14,8400,8412,5,8421,8432,5,8617,8618,14,9167,9167,14,9200,9200,14,9410,9410,14,9723,9726,14,9733,9733,14,9745,9745,14,9752,9752,14,9760,9760,14,9766,9766,14,9774,9774,14,9786,9786,14,9794,9794,14,9823,9823,14,9828,9828,14,9833,9850,14,9855,9855,14,9875,9875,14,9880,9880,14,9885,9887,14,9896,9897,14,9906,9916,14,9926,9927,14,9935,9935,14,9939,9939,14,9962,9962,14,9972,9972,14,9978,9978,14,9986,9986,14,9997,9997,14,10002,10002,14,10017,10017,14,10055,10055,14,10071,10071,14,10133,10135,14,10548,10549,14,11093,11093,14,12330,12333,5,12441,12442,5,42608,42610,5,43010,43010,5,43045,43046,5,43188,43203,7,43302,43309,5,43392,43394,5,43446,43449,5,43493,43493,5,43571,43572,7,43597,43597,7,43703,43704,5,43756,43757,5,44003,44004,7,44009,44010,7,44033,44059,12,44089,44115,12,44145,44171,12,44201,44227,12,44257,44283,12,44313,44339,12,44369,44395,12,44425,44451,12,44481,44507,12,44537,44563,12,44593,44619,12,44649,44675,12,44705,44731,12,44761,44787,12,44817,44843,12,44873,44899,12,44929,44955,12,44985,45011,12,45041,45067,12,45097,45123,12,45153,45179,12,45209,45235,12,45265,45291,12,45321,45347,12,45377,45403,12,45433,45459,12,45489,45515,12,45545,45571,12,45601,45627,12,45657,45683,12,45713,45739,12,45769,45795,12,45825,45851,12,45881,45907,12,45937,45963,12,45993,46019,12,46049,46075,12,46105,46131,12,46161,46187,12,46217,46243,12,46273,46299,12,46329,46355,12,46385,46411,12,46441,46467,12,46497,46523,12,46553,46579,12,46609,46635,12,46665,46691,12,46721,46747,12,46777,46803,12,46833,46859,12,46889,46915,12,46945,46971,12,47001,47027,12,47057,47083,12,47113,47139,12,47169,47195,12,47225,47251,12,47281,47307,12,47337,47363,12,47393,47419,12,47449,47475,12,47505,47531,12,47561,47587,12,47617,47643,12,47673,47699,12,47729,47755,12,47785,47811,12,47841,47867,12,47897,47923,12,47953,47979,12,48009,48035,12,48065,48091,12,48121,48147,12,48177,48203,12,48233,48259,12,48289,48315,12,48345,48371,12,48401,48427,12,48457,48483,12,48513,48539,12,48569,48595,12,48625,48651,12,48681,48707,12,48737,48763,12,48793,48819,12,48849,48875,12,48905,48931,12,48961,48987,12,49017,49043,12,49073,49099,12,49129,49155,12,49185,49211,12,49241,49267,12,49297,49323,12,49353,49379,12,49409,49435,12,49465,49491,12,49521,49547,12,49577,49603,12,49633,49659,12,49689,49715,12,49745,49771,12,49801,49827,12,49857,49883,12,49913,49939,12,49969,49995,12,50025,50051,12,50081,50107,12,50137,50163,12,50193,50219,12,50249,50275,12,50305,50331,12,50361,50387,12,50417,50443,12,50473,50499,12,50529,50555,12,50585,50611,12,50641,50667,12,50697,50723,12,50753,50779,12,50809,50835,12,50865,50891,12,50921,50947,12,50977,51003,12,51033,51059,12,51089,51115,12,51145,51171,12,51201,51227,12,51257,51283,12,51313,51339,12,51369,51395,12,51425,51451,12,51481,51507,12,51537,51563,12,51593,51619,12,51649,51675,12,51705,51731,12,51761,51787,12,51817,51843,12,51873,51899,12,51929,51955,12,51985,52011,12,52041,52067,12,52097,52123,12,52153,52179,12,52209,52235,12,52265,52291,12,52321,52347,12,52377,52403,12,52433,52459,12,52489,52515,12,52545,52571,12,52601,52627,12,52657,52683,12,52713,52739,12,52769,52795,12,52825,52851,12,52881,52907,12,52937,52963,12,52993,53019,12,53049,53075,12,53105,53131,12,53161,53187,12,53217,53243,12,53273,53299,12,53329,53355,12,53385,53411,12,53441,53467,12,53497,53523,12,53553,53579,12,53609,53635,12,53665,53691,12,53721,53747,12,53777,53803,12,53833,53859,12,53889,53915,12,53945,53971,12,54001,54027,12,54057,54083,12,54113,54139,12,54169,54195,12,54225,54251,12,54281,54307,12,54337,54363,12,54393,54419,12,54449,54475,12,54505,54531,12,54561,54587,12,54617,54643,12,54673,54699,12,54729,54755,12,54785,54811,12,54841,54867,12,54897,54923,12,54953,54979,12,55009,55035,12,55065,55091,12,55121,55147,12,55177,55203,12,65024,65039,5,65520,65528,4,66422,66426,5,68152,68154,5,69291,69292,5,69633,69633,5,69747,69748,5,69811,69814,5,69826,69826,5,69932,69932,7,70016,70017,5,70079,70080,7,70095,70095,5,70196,70196,5,70367,70367,5,70402,70403,7,70464,70464,5,70487,70487,5,70709,70711,7,70725,70725,7,70833,70834,7,70843,70844,7,70849,70849,7,71090,71093,5,71103,71104,5,71227,71228,7,71339,71339,5,71344,71349,5,71458,71461,5,71727,71735,5,71985,71989,7,71998,71998,5,72002,72002,7,72154,72155,5,72193,72202,5,72251,72254,5,72281,72283,5,72344,72345,5,72766,72766,7,72874,72880,5,72885,72886,5,73023,73029,5,73104,73105,5,73111,73111,5,92912,92916,5,94095,94098,5,113824,113827,4,119142,119142,7,119155,119162,4,119362,119364,5,121476,121476,5,122888,122904,5,123184,123190,5,125252,125258,5,127183,127183,14,127340,127343,14,127377,127386,14,127491,127503,14,127548,127551,14,127744,127756,14,127761,127761,14,127769,127769,14,127773,127774,14,127780,127788,14,127796,127797,14,127820,127823,14,127869,127869,14,127894,127895,14,127902,127903,14,127943,127943,14,127947,127950,14,127972,127972,14,127988,127988,14,127992,127994,14,128009,128011,14,128019,128019,14,128023,128041,14,128064,128064,14,128102,128107,14,128174,128181,14,128238,128238,14,128246,128247,14,128254,128254,14,128264,128264,14,128278,128299,14,128329,128330,14,128348,128359,14,128371,128377,14,128392,128393,14,128401,128404,14,128421,128421,14,128433,128434,14,128450,128452,14,128476,128478,14,128483,128483,14,128495,128495,14,128506,128506,14,128519,128520,14,128528,128528,14,128534,128534,14,128538,128538,14,128540,128542,14,128544,128549,14,128552,128555,14,128557,128557,14,128560,128563,14,128565,128565,14,128567,128576,14,128581,128591,14,128641,128642,14,128646,128646,14,128648,128648,14,128650,128651,14,128653,128653,14,128655,128655,14,128657,128659,14,128661,128661,14,128663,128663,14,128665,128666,14,128674,128674,14,128676,128677,14,128679,128685,14,128690,128690,14,128694,128694,14,128697,128702,14,128704,128704,14,128710,128714,14,128716,128716,14,128720,128720,14,128723,128724,14,128726,128727,14,128733,128735,14,128742,128744,14,128746,128746,14,128749,128751,14,128753,128754,14,128756,128758,14,128761,128761,14,128763,128764,14,128884,128895,14,128992,129003,14,129008,129008,14,129036,129039,14,129114,129119,14,129198,129279,14,129293,129295,14,129305,129310,14,129312,129319,14,129328,129328,14,129331,129338,14,129343,129343,14,129351,129355,14,129357,129359,14,129375,129387,14,129393,129393,14,129395,129398,14,129401,129401,14,129403,129403,14,129408,129412,14,129426,129431,14,129443,129444,14,129451,129453,14,129456,129465,14,129472,129472,14,129475,129482,14,129484,129484,14,129488,129510,14,129536,129647,14,129652,129652,14,129656,129658,14,129661,129663,14,129667,129670,14,129680,129685,14,129705,129708,14,129712,129718,14,129723,129727,14,129731,129733,14,129744,129750,14,129754,129759,14,129768,129775,14,129783,129791,14,917504,917504,4,917506,917535,4,917632,917759,4,918000,921599,4,0,9,4,11,12,4,14,31,4,169,169,14,174,174,14,1155,1159,5,1425,1469,5,1473,1474,5,1479,1479,5,1552,1562,5,1611,1631,5,1750,1756,5,1759,1764,5,1770,1773,5,1809,1809,5,1958,1968,5,2045,2045,5,2075,2083,5,2089,2093,5,2192,2193,1,2250,2273,5,2275,2306,5,2362,2362,5,2364,2364,5,2369,2376,5,2381,2381,5,2385,2391,5,2433,2433,5,2492,2492,5,2495,2496,7,2503,2504,7,2509,2509,5,2530,2531,5,2561,2562,5,2620,2620,5,2625,2626,5,2635,2637,5,2672,2673,5,2689,2690,5,2748,2748,5,2753,2757,5,2761,2761,7,2765,2765,5,2810,2815,5,2818,2819,7,2878,2878,5,2880,2880,7,2887,2888,7,2893,2893,5,2903,2903,5,2946,2946,5,3007,3007,7,3009,3010,7,3018,3020,7,3031,3031,5,3073,3075,7,3132,3132,5,3137,3140,7,3146,3149,5,3170,3171,5,3202,3203,7,3262,3262,7,3264,3265,7,3267,3268,7,3271,3272,7,3276,3277,5,3298,3299,5,3330,3331,7,3390,3390,5,3393,3396,5,3402,3404,7,3406,3406,1,3426,3427,5,3458,3459,7,3535,3535,5,3538,3540,5,3544,3550,7,3570,3571,7,3635,3635,7,3655,3662,5,3763,3763,7,3784,3789,5,3893,3893,5,3897,3897,5,3953,3966,5,3968,3972,5,3981,3991,5,4038,4038,5,4145,4145,7,4153,4154,5,4157,4158,5,4184,4185,5,4209,4212,5,4228,4228,7,4237,4237,5,4352,4447,8,4520,4607,10,5906,5908,5,5938,5939,5,5970,5971,5,6068,6069,5,6071,6077,5,6086,6086,5,6089,6099,5,6155,6157,5,6159,6159,5,6313,6313,5,6435,6438,7,6441,6443,7,6450,6450,5,6457,6459,5,6681,6682,7,6741,6741,7,6743,6743,7,6752,6752,5,6757,6764,5,6771,6780,5,6832,6845,5,6847,6862,5,6916,6916,7,6965,6965,5,6971,6971,7,6973,6977,7,6979,6980,7,7040,7041,5,7073,7073,7,7078,7079,7,7082,7082,7,7142,7142,5,7144,7145,5,7149,7149,5,7151,7153,5,7204,7211,7,7220,7221,7,7376,7378,5,7393,7393,7,7405,7405,5,7415,7415,7,7616,7679,5,8204,8204,5,8206,8207,4,8233,8233,4,8252,8252,14,8288,8292,4,8294,8303,4,8413,8416,5,8418,8420,5,8482,8482,14,8596,8601,14,8986,8987,14,9096,9096,14,9193,9196,14,9199,9199,14,9201,9202,14,9208,9210,14,9642,9643,14,9664,9664,14,9728,9729,14,9732,9732,14,9735,9741,14,9743,9744,14,9746,9746,14,9750,9751,14,9753,9756,14,9758,9759,14,9761,9761,14,9764,9765,14,9767,9769,14,9771,9773,14,9775,9775,14,9784,9785,14,9787,9791,14,9793,9793,14,9795,9799,14,9812,9822,14,9824,9824,14,9827,9827,14,9829,9830,14,9832,9832,14,9851,9851,14,9854,9854,14,9856,9861,14,9874,9874,14,9876,9876,14,9878,9879,14,9881,9881,14,9883,9884,14,9888,9889,14,9895,9895,14,9898,9899,14,9904,9905,14,9917,9918,14,9924,9925,14,9928,9928,14,9934,9934,14,9936,9936,14,9938,9938,14,9940,9940,14,9961,9961,14,9963,9967,14,9970,9971,14,9973,9973,14,9975,9977,14,9979,9980,14,9982,9985,14,9987,9988,14,9992,9996,14,9998,9998,14,10000,10001,14,10004,10004,14,10013,10013,14,10024,10024,14,10052,10052,14,10060,10060,14,10067,10069,14,10083,10083,14,10085,10087,14,10145,10145,14,10175,10175,14,11013,11015,14,11088,11088,14,11503,11505,5,11744,11775,5,12334,12335,5,12349,12349,14,12951,12951,14,42607,42607,5,42612,42621,5,42736,42737,5,43014,43014,5,43043,43044,7,43047,43047,7,43136,43137,7,43204,43205,5,43263,43263,5,43335,43345,5,43360,43388,8,43395,43395,7,43444,43445,7,43450,43451,7,43454,43456,7,43561,43566,5,43569,43570,5,43573,43574,5,43596,43596,5,43644,43644,5,43698,43700,5,43710,43711,5,43755,43755,7,43758,43759,7,43766,43766,5,44005,44005,5,44008,44008,5,44012,44012,7,44032,44032,11,44060,44060,11,44088,44088,11,44116,44116,11,44144,44144,11,44172,44172,11,44200,44200,11,44228,44228,11,44256,44256,11,44284,44284,11,44312,44312,11,44340,44340,11,44368,44368,11,44396,44396,11,44424,44424,11,44452,44452,11,44480,44480,11,44508,44508,11,44536,44536,11,44564,44564,11,44592,44592,11,44620,44620,11,44648,44648,11,44676,44676,11,44704,44704,11,44732,44732,11,44760,44760,11,44788,44788,11,44816,44816,11,44844,44844,11,44872,44872,11,44900,44900,11,44928,44928,11,44956,44956,11,44984,44984,11,45012,45012,11,45040,45040,11,45068,45068,11,45096,45096,11,45124,45124,11,45152,45152,11,45180,45180,11,45208,45208,11,45236,45236,11,45264,45264,11,45292,45292,11,45320,45320,11,45348,45348,11,45376,45376,11,45404,45404,11,45432,45432,11,45460,45460,11,45488,45488,11,45516,45516,11,45544,45544,11,45572,45572,11,45600,45600,11,45628,45628,11,45656,45656,11,45684,45684,11,45712,45712,11,45740,45740,11,45768,45768,11,45796,45796,11,45824,45824,11,45852,45852,11,45880,45880,11,45908,45908,11,45936,45936,11,45964,45964,11,45992,45992,11,46020,46020,11,46048,46048,11,46076,46076,11,46104,46104,11,46132,46132,11,46160,46160,11,46188,46188,11,46216,46216,11,46244,46244,11,46272,46272,11,46300,46300,11,46328,46328,11,46356,46356,11,46384,46384,11,46412,46412,11,46440,46440,11,46468,46468,11,46496,46496,11,46524,46524,11,46552,46552,11,46580,46580,11,46608,46608,11,46636,46636,11,46664,46664,11,46692,46692,11,46720,46720,11,46748,46748,11,46776,46776,11,46804,46804,11,46832,46832,11,46860,46860,11,46888,46888,11,46916,46916,11,46944,46944,11,46972,46972,11,47000,47000,11,47028,47028,11,47056,47056,11,47084,47084,11,47112,47112,11,47140,47140,11,47168,47168,11,47196,47196,11,47224,47224,11,47252,47252,11,47280,47280,11,47308,47308,11,47336,47336,11,47364,47364,11,47392,47392,11,47420,47420,11,47448,47448,11,47476,47476,11,47504,47504,11,47532,47532,11,47560,47560,11,47588,47588,11,47616,47616,11,47644,47644,11,47672,47672,11,47700,47700,11,47728,47728,11,47756,47756,11,47784,47784,11,47812,47812,11,47840,47840,11,47868,47868,11,47896,47896,11,47924,47924,11,47952,47952,11,47980,47980,11,48008,48008,11,48036,48036,11,48064,48064,11,48092,48092,11,48120,48120,11,48148,48148,11,48176,48176,11,48204,48204,11,48232,48232,11,48260,48260,11,48288,48288,11,48316,48316,11,48344,48344,11,48372,48372,11,48400,48400,11,48428,48428,11,48456,48456,11,48484,48484,11,48512,48512,11,48540,48540,11,48568,48568,11,48596,48596,11,48624,48624,11,48652,48652,11,48680,48680,11,48708,48708,11,48736,48736,11,48764,48764,11,48792,48792,11,48820,48820,11,48848,48848,11,48876,48876,11,48904,48904,11,48932,48932,11,48960,48960,11,48988,48988,11,49016,49016,11,49044,49044,11,49072,49072,11,49100,49100,11,49128,49128,11,49156,49156,11,49184,49184,11,49212,49212,11,49240,49240,11,49268,49268,11,49296,49296,11,49324,49324,11,49352,49352,11,49380,49380,11,49408,49408,11,49436,49436,11,49464,49464,11,49492,49492,11,49520,49520,11,49548,49548,11,49576,49576,11,49604,49604,11,49632,49632,11,49660,49660,11,49688,49688,11,49716,49716,11,49744,49744,11,49772,49772,11,49800,49800,11,49828,49828,11,49856,49856,11,49884,49884,11,49912,49912,11,49940,49940,11,49968,49968,11,49996,49996,11,50024,50024,11,50052,50052,11,50080,50080,11,50108,50108,11,50136,50136,11,50164,50164,11,50192,50192,11,50220,50220,11,50248,50248,11,50276,50276,11,50304,50304,11,50332,50332,11,50360,50360,11,50388,50388,11,50416,50416,11,50444,50444,11,50472,50472,11,50500,50500,11,50528,50528,11,50556,50556,11,50584,50584,11,50612,50612,11,50640,50640,11,50668,50668,11,50696,50696,11,50724,50724,11,50752,50752,11,50780,50780,11,50808,50808,11,50836,50836,11,50864,50864,11,50892,50892,11,50920,50920,11,50948,50948,11,50976,50976,11,51004,51004,11,51032,51032,11,51060,51060,11,51088,51088,11,51116,51116,11,51144,51144,11,51172,51172,11,51200,51200,11,51228,51228,11,51256,51256,11,51284,51284,11,51312,51312,11,51340,51340,11,51368,51368,11,51396,51396,11,51424,51424,11,51452,51452,11,51480,51480,11,51508,51508,11,51536,51536,11,51564,51564,11,51592,51592,11,51620,51620,11,51648,51648,11,51676,51676,11,51704,51704,11,51732,51732,11,51760,51760,11,51788,51788,11,51816,51816,11,51844,51844,11,51872,51872,11,51900,51900,11,51928,51928,11,51956,51956,11,51984,51984,11,52012,52012,11,52040,52040,11,52068,52068,11,52096,52096,11,52124,52124,11,52152,52152,11,52180,52180,11,52208,52208,11,52236,52236,11,52264,52264,11,52292,52292,11,52320,52320,11,52348,52348,11,52376,52376,11,52404,52404,11,52432,52432,11,52460,52460,11,52488,52488,11,52516,52516,11,52544,52544,11,52572,52572,11,52600,52600,11,52628,52628,11,52656,52656,11,52684,52684,11,52712,52712,11,52740,52740,11,52768,52768,11,52796,52796,11,52824,52824,11,52852,52852,11,52880,52880,11,52908,52908,11,52936,52936,11,52964,52964,11,52992,52992,11,53020,53020,11,53048,53048,11,53076,53076,11,53104,53104,11,53132,53132,11,53160,53160,11,53188,53188,11,53216,53216,11,53244,53244,11,53272,53272,11,53300,53300,11,53328,53328,11,53356,53356,11,53384,53384,11,53412,53412,11,53440,53440,11,53468,53468,11,53496,53496,11,53524,53524,11,53552,53552,11,53580,53580,11,53608,53608,11,53636,53636,11,53664,53664,11,53692,53692,11,53720,53720,11,53748,53748,11,53776,53776,11,53804,53804,11,53832,53832,11,53860,53860,11,53888,53888,11,53916,53916,11,53944,53944,11,53972,53972,11,54000,54000,11,54028,54028,11,54056,54056,11,54084,54084,11,54112,54112,11,54140,54140,11,54168,54168,11,54196,54196,11,54224,54224,11,54252,54252,11,54280,54280,11,54308,54308,11,54336,54336,11,54364,54364,11,54392,54392,11,54420,54420,11,54448,54448,11,54476,54476,11,54504,54504,11,54532,54532,11,54560,54560,11,54588,54588,11,54616,54616,11,54644,54644,11,54672,54672,11,54700,54700,11,54728,54728,11,54756,54756,11,54784,54784,11,54812,54812,11,54840,54840,11,54868,54868,11,54896,54896,11,54924,54924,11,54952,54952,11,54980,54980,11,55008,55008,11,55036,55036,11,55064,55064,11,55092,55092,11,55120,55120,11,55148,55148,11,55176,55176,11,55216,55238,9,64286,64286,5,65056,65071,5,65438,65439,5,65529,65531,4,66272,66272,5,68097,68099,5,68108,68111,5,68159,68159,5,68900,68903,5,69446,69456,5,69632,69632,7,69634,69634,7,69744,69744,5,69759,69761,5,69808,69810,7,69815,69816,7,69821,69821,1,69837,69837,1,69927,69931,5,69933,69940,5,70003,70003,5,70018,70018,7,70070,70078,5,70082,70083,1,70094,70094,7,70188,70190,7,70194,70195,7,70197,70197,7,70206,70206,5,70368,70370,7,70400,70401,5,70459,70460,5,70463,70463,7,70465,70468,7,70475,70477,7,70498,70499,7,70512,70516,5,70712,70719,5,70722,70724,5,70726,70726,5,70832,70832,5,70835,70840,5,70842,70842,5,70845,70845,5,70847,70848,5,70850,70851,5,71088,71089,7,71096,71099,7,71102,71102,7,71132,71133,5,71219,71226,5,71229,71229,5,71231,71232,5,71340,71340,7,71342,71343,7,71350,71350,7,71453,71455,5,71462,71462,7,71724,71726,7,71736,71736,7,71984,71984,5,71991,71992,7,71997,71997,7,71999,71999,1,72001,72001,1,72003,72003,5,72148,72151,5,72156,72159,7,72164,72164,7,72243,72248,5,72250,72250,1,72263,72263,5,72279,72280,7,72324,72329,1,72343,72343,7,72751,72751,7,72760,72765,5,72767,72767,5,72873,72873,7,72881,72881,7,72884,72884,7,73009,73014,5,73020,73021,5,73030,73030,1,73098,73102,7,73107,73108,7,73110,73110,7,73459,73460,5,78896,78904,4,92976,92982,5,94033,94087,7,94180,94180,5,113821,113822,5,118528,118573,5,119141,119141,5,119143,119145,5,119150,119154,5,119163,119170,5,119210,119213,5,121344,121398,5,121461,121461,5,121499,121503,5,122880,122886,5,122907,122913,5,122918,122922,5,123566,123566,5,125136,125142,5,126976,126979,14,126981,127182,14,127184,127231,14,127279,127279,14,127344,127345,14,127374,127374,14,127405,127461,14,127489,127490,14,127514,127514,14,127538,127546,14,127561,127567,14,127570,127743,14,127757,127758,14,127760,127760,14,127762,127762,14,127766,127768,14,127770,127770,14,127772,127772,14,127775,127776,14,127778,127779,14,127789,127791,14,127794,127795,14,127798,127798,14,127819,127819,14,127824,127824,14,127868,127868,14,127870,127871,14,127892,127893,14,127896,127896,14,127900,127901,14,127904,127940,14,127942,127942,14,127944,127944,14,127946,127946,14,127951,127955,14,127968,127971,14,127973,127984,14,127987,127987,14,127989,127989,14,127991,127991,14,127995,127999,5,128008,128008,14,128012,128014,14,128017,128018,14,128020,128020,14,128022,128022,14,128042,128042,14,128063,128063,14,128065,128065,14,128101,128101,14,128108,128109,14,128173,128173,14,128182,128183,14,128236,128237,14,128239,128239,14,128245,128245,14,128248,128248,14,128253,128253,14,128255,128258,14,128260,128263,14,128265,128265,14,128277,128277,14,128300,128301,14,128326,128328,14,128331,128334,14,128336,128347,14,128360,128366,14,128369,128370,14,128378,128378,14,128391,128391,14,128394,128397,14,128400,128400,14,128405,128406,14,128420,128420,14,128422,128423,14,128425,128432,14,128435,128443,14,128445,128449,14,128453,128464,14,128468,128475,14,128479,128480,14,128482,128482,14,128484,128487,14,128489,128494,14,128496,128498,14,128500,128505,14,128507,128511,14,128513,128518,14,128521,128525,14,128527,128527,14,128529,128529,14,128533,128533,14,128535,128535,14,128537,128537,14]');\n}\n\n//#endregion\n\n/**\n * Computes the offset after performing a left delete on the given string,\n * while considering unicode grapheme/emoji rules.\n*/\nexport function getLeftDeleteOffset(offset: number, str: string): number {\n\tif (offset === 0) {\n\t\treturn 0;\n\t}\n\n\t// Try to delete emoji part.\n\tconst emojiOffset = getOffsetBeforeLastEmojiComponent(offset, str);\n\tif (emojiOffset !== undefined) {\n\t\treturn emojiOffset;\n\t}\n\n\t// Otherwise, just skip a single code point.\n\tconst iterator = new CodePointIterator(str, offset);\n\titerator.prevCodePoint();\n\treturn iterator.offset;\n}\n\nfunction getOffsetBeforeLastEmojiComponent(initialOffset: number, str: string): number | undefined {\n\t// See https://www.unicode.org/reports/tr51/tr51-14.html#EBNF_and_Regex for the\n\t// structure of emojis.\n\tconst iterator = new CodePointIterator(str, initialOffset);\n\tlet codePoint = iterator.prevCodePoint();\n\n\t// Skip modifiers\n\twhile ((isEmojiModifier(codePoint) || codePoint === CodePoint.emojiVariantSelector || codePoint === CodePoint.enclosingKeyCap)) {\n\t\tif (iterator.offset === 0) {\n\t\t\t// Cannot skip modifier, no preceding emoji base.\n\t\t\treturn undefined;\n\t\t}\n\t\tcodePoint = iterator.prevCodePoint();\n\t}\n\n\t// Expect base emoji\n\tif (!isEmojiImprecise(codePoint)) {\n\t\t// Unexpected code point, not a valid emoji.\n\t\treturn undefined;\n\t}\n\n\tlet resultOffset = iterator.offset;\n\n\tif (resultOffset > 0) {\n\t\t// Skip optional ZWJ code points that combine multiple emojis.\n\t\t// In theory, we should check if that ZWJ actually combines multiple emojis\n\t\t// to prevent deleting ZWJs in situations we didn't account for.\n\t\tconst optionalZwjCodePoint = iterator.prevCodePoint();\n\t\tif (optionalZwjCodePoint === CodePoint.zwj) {\n\t\t\tresultOffset = iterator.offset;\n\t\t}\n\t}\n\n\treturn resultOffset;\n}\n\nfunction isEmojiModifier(codePoint: number): boolean {\n\treturn 0x1F3FB <= codePoint && codePoint <= 0x1F3FF;\n}\n\nconst enum CodePoint {\n\tzwj = 0x200D,\n\n\t/**\n\t * Variation Selector-16 (VS16)\n\t*/\n\temojiVariantSelector = 0xFE0F,\n\n\t/**\n\t * Combining Enclosing Keycap\n\t */\n\tenclosingKeyCap = 0x20E3,\n\n\tspace = 0x0020,\n}\n\nexport const noBreakWhitespace = '\\xa0';\n\nexport class AmbiguousCharacters {\n\tprivate static readonly ambiguousCharacterData = new Lazy<\n\t\tRecord<\n\t\t\tstring | '_common' | '_default',\n\t\t\t/* code point -> ascii code point */ number[]\n\t\t>\n\t>(() => {\n\t\t// Generated using https://github.com/hediet/vscode-unicode-data\n\t\t// Stored as key1, value1, key2, value2, ...\n\t\treturn JSON.parse(\n\t\t\t'{\\\"_common\\\":[8232,32,8233,32,5760,32,8192,32,8193,32,8194,32,8195,32,8196,32,8197,32,8198,32,8200,32,8201,32,8202,32,8287,32,8199,32,8239,32,2042,95,65101,95,65102,95,65103,95,8208,45,8209,45,8210,45,65112,45,1748,45,8259,45,727,45,8722,45,10134,45,11450,45,1549,44,1643,44,184,44,42233,44,894,59,2307,58,2691,58,1417,58,1795,58,1796,58,5868,58,65072,58,6147,58,6153,58,8282,58,1475,58,760,58,42889,58,8758,58,720,58,42237,58,451,33,11601,33,660,63,577,63,2429,63,5038,63,42731,63,119149,46,8228,46,1793,46,1794,46,42510,46,68176,46,1632,46,1776,46,42232,46,1373,96,65287,96,8219,96,1523,96,8242,96,1370,96,8175,96,65344,96,900,96,8189,96,8125,96,8127,96,8190,96,697,96,884,96,712,96,714,96,715,96,756,96,699,96,701,96,700,96,702,96,42892,96,1497,96,2036,96,2037,96,5194,96,5836,96,94033,96,94034,96,65339,91,10088,40,10098,40,12308,40,64830,40,65341,93,10089,41,10099,41,12309,41,64831,41,10100,123,119060,123,10101,125,65342,94,8270,42,1645,42,8727,42,66335,42,5941,47,8257,47,8725,47,8260,47,9585,47,10187,47,10744,47,119354,47,12755,47,12339,47,11462,47,20031,47,12035,47,65340,92,65128,92,8726,92,10189,92,10741,92,10745,92,119311,92,119355,92,12756,92,20022,92,12034,92,42872,38,708,94,710,94,5869,43,10133,43,66203,43,8249,60,10094,60,706,60,119350,60,5176,60,5810,60,5120,61,11840,61,12448,61,42239,61,8250,62,10095,62,707,62,119351,62,5171,62,94015,62,8275,126,732,126,8128,126,8764,126,65372,124,65293,45,118002,50,120784,50,120794,50,120804,50,120814,50,120824,50,130034,50,42842,50,423,50,1000,50,42564,50,5311,50,42735,50,119302,51,118003,51,120785,51,120795,51,120805,51,120815,51,120825,51,130035,51,42923,51,540,51,439,51,42858,51,11468,51,1248,51,94011,51,71882,51,118004,52,120786,52,120796,52,120806,52,120816,52,120826,52,130036,52,5070,52,71855,52,118005,53,120787,53,120797,53,120807,53,120817,53,120827,53,130037,53,444,53,71867,53,118006,54,120788,54,120798,54,120808,54,120818,54,120828,54,130038,54,11474,54,5102,54,71893,54,119314,55,118007,55,120789,55,120799,55,120809,55,120819,55,120829,55,130039,55,66770,55,71878,55,2819,56,2538,56,2666,56,125131,56,118008,56,120790,56,120800,56,120810,56,120820,56,120830,56,130040,56,547,56,546,56,66330,56,2663,57,2920,57,2541,57,3437,57,118009,57,120791,57,120801,57,120811,57,120821,57,120831,57,130041,57,42862,57,11466,57,71884,57,71852,57,71894,57,9082,97,65345,97,119834,97,119886,97,119938,97,119990,97,120042,97,120094,97,120146,97,120198,97,120250,97,120302,97,120354,97,120406,97,120458,97,593,97,945,97,120514,97,120572,97,120630,97,120688,97,120746,97,65313,65,117974,65,119808,65,119860,65,119912,65,119964,65,120016,65,120068,65,120120,65,120172,65,120224,65,120276,65,120328,65,120380,65,120432,65,913,65,120488,65,120546,65,120604,65,120662,65,120720,65,5034,65,5573,65,42222,65,94016,65,66208,65,119835,98,119887,98,119939,98,119991,98,120043,98,120095,98,120147,98,120199,98,120251,98,120303,98,120355,98,120407,98,120459,98,388,98,5071,98,5234,98,5551,98,65314,66,8492,66,117975,66,119809,66,119861,66,119913,66,120017,66,120069,66,120121,66,120173,66,120225,66,120277,66,120329,66,120381,66,120433,66,42932,66,914,66,120489,66,120547,66,120605,66,120663,66,120721,66,5108,66,5623,66,42192,66,66178,66,66209,66,66305,66,65347,99,8573,99,119836,99,119888,99,119940,99,119992,99,120044,99,120096,99,120148,99,120200,99,120252,99,120304,99,120356,99,120408,99,120460,99,7428,99,1010,99,11429,99,43951,99,66621,99,128844,67,71913,67,71922,67,65315,67,8557,67,8450,67,8493,67,117976,67,119810,67,119862,67,119914,67,119966,67,120018,67,120174,67,120226,67,120278,67,120330,67,120382,67,120434,67,1017,67,11428,67,5087,67,42202,67,66210,67,66306,67,66581,67,66844,67,8574,100,8518,100,119837,100,119889,100,119941,100,119993,100,120045,100,120097,100,120149,100,120201,100,120253,100,120305,100,120357,100,120409,100,120461,100,1281,100,5095,100,5231,100,42194,100,8558,68,8517,68,117977,68,119811,68,119863,68,119915,68,119967,68,120019,68,120071,68,120123,68,120175,68,120227,68,120279,68,120331,68,120383,68,120435,68,5024,68,5598,68,5610,68,42195,68,8494,101,65349,101,8495,101,8519,101,119838,101,119890,101,119942,101,120046,101,120098,101,120150,101,120202,101,120254,101,120306,101,120358,101,120410,101,120462,101,43826,101,1213,101,8959,69,65317,69,8496,69,117978,69,119812,69,119864,69,119916,69,120020,69,120072,69,120124,69,120176,69,120228,69,120280,69,120332,69,120384,69,120436,69,917,69,120492,69,120550,69,120608,69,120666,69,120724,69,11577,69,5036,69,42224,69,71846,69,71854,69,66182,69,119839,102,119891,102,119943,102,119995,102,120047,102,120099,102,120151,102,120203,102,120255,102,120307,102,120359,102,120411,102,120463,102,43829,102,42905,102,383,102,7837,102,1412,102,119315,70,8497,70,117979,70,119813,70,119865,70,119917,70,120021,70,120073,70,120125,70,120177,70,120229,70,120281,70,120333,70,120385,70,120437,70,42904,70,988,70,120778,70,5556,70,42205,70,71874,70,71842,70,66183,70,66213,70,66853,70,65351,103,8458,103,119840,103,119892,103,119944,103,120048,103,120100,103,120152,103,120204,103,120256,103,120308,103,120360,103,120412,103,120464,103,609,103,7555,103,397,103,1409,103,117980,71,119814,71,119866,71,119918,71,119970,71,120022,71,120074,71,120126,71,120178,71,120230,71,120282,71,120334,71,120386,71,120438,71,1292,71,5056,71,5107,71,42198,71,65352,104,8462,104,119841,104,119945,104,119997,104,120049,104,120101,104,120153,104,120205,104,120257,104,120309,104,120361,104,120413,104,120465,104,1211,104,1392,104,5058,104,65320,72,8459,72,8460,72,8461,72,117981,72,119815,72,119867,72,119919,72,120023,72,120179,72,120231,72,120283,72,120335,72,120387,72,120439,72,919,72,120494,72,120552,72,120610,72,120668,72,120726,72,11406,72,5051,72,5500,72,42215,72,66255,72,731,105,9075,105,65353,105,8560,105,8505,105,8520,105,119842,105,119894,105,119946,105,119998,105,120050,105,120102,105,120154,105,120206,105,120258,105,120310,105,120362,105,120414,105,120466,105,120484,105,618,105,617,105,953,105,8126,105,890,105,120522,105,120580,105,120638,105,120696,105,120754,105,1110,105,42567,105,1231,105,43893,105,5029,105,71875,105,65354,106,8521,106,119843,106,119895,106,119947,106,119999,106,120051,106,120103,106,120155,106,120207,106,120259,106,120311,106,120363,106,120415,106,120467,106,1011,106,1112,106,65322,74,117983,74,119817,74,119869,74,119921,74,119973,74,120025,74,120077,74,120129,74,120181,74,120233,74,120285,74,120337,74,120389,74,120441,74,42930,74,895,74,1032,74,5035,74,5261,74,42201,74,119844,107,119896,107,119948,107,120000,107,120052,107,120104,107,120156,107,120208,107,120260,107,120312,107,120364,107,120416,107,120468,107,8490,75,65323,75,117984,75,119818,75,119870,75,119922,75,119974,75,120026,75,120078,75,120130,75,120182,75,120234,75,120286,75,120338,75,120390,75,120442,75,922,75,120497,75,120555,75,120613,75,120671,75,120729,75,11412,75,5094,75,5845,75,42199,75,66840,75,1472,108,8739,73,9213,73,65512,73,1633,108,1777,73,66336,108,125127,108,118001,108,120783,73,120793,73,120803,73,120813,73,120823,73,130033,73,65321,73,8544,73,8464,73,8465,73,117982,108,119816,73,119868,73,119920,73,120024,73,120128,73,120180,73,120232,73,120284,73,120336,73,120388,73,120440,73,65356,108,8572,73,8467,108,119845,108,119897,108,119949,108,120001,108,120053,108,120105,73,120157,73,120209,73,120261,73,120313,73,120365,73,120417,73,120469,73,448,73,120496,73,120554,73,120612,73,120670,73,120728,73,11410,73,1030,73,1216,73,1493,108,1503,108,1575,108,126464,108,126592,108,65166,108,65165,108,1994,108,11599,73,5825,73,42226,73,93992,73,66186,124,66313,124,119338,76,8556,76,8466,76,117985,76,119819,76,119871,76,119923,76,120027,76,120079,76,120131,76,120183,76,120235,76,120287,76,120339,76,120391,76,120443,76,11472,76,5086,76,5290,76,42209,76,93974,76,71843,76,71858,76,66587,76,66854,76,65325,77,8559,77,8499,77,117986,77,119820,77,119872,77,119924,77,120028,77,120080,77,120132,77,120184,77,120236,77,120288,77,120340,77,120392,77,120444,77,924,77,120499,77,120557,77,120615,77,120673,77,120731,77,1018,77,11416,77,5047,77,5616,77,5846,77,42207,77,66224,77,66321,77,119847,110,119899,110,119951,110,120003,110,120055,110,120107,110,120159,110,120211,110,120263,110,120315,110,120367,110,120419,110,120471,110,1400,110,1404,110,65326,78,8469,78,117987,78,119821,78,119873,78,119925,78,119977,78,120029,78,120081,78,120185,78,120237,78,120289,78,120341,78,120393,78,120445,78,925,78,120500,78,120558,78,120616,78,120674,78,120732,78,11418,78,42208,78,66835,78,3074,111,3202,111,3330,111,3458,111,2406,111,2662,111,2790,111,3046,111,3174,111,3302,111,3430,111,3664,111,3792,111,4160,111,1637,111,1781,111,65359,111,8500,111,119848,111,119900,111,119952,111,120056,111,120108,111,120160,111,120212,111,120264,111,120316,111,120368,111,120420,111,120472,111,7439,111,7441,111,43837,111,959,111,120528,111,120586,111,120644,111,120702,111,120760,111,963,111,120532,111,120590,111,120648,111,120706,111,120764,111,11423,111,4351,111,1413,111,1505,111,1607,111,126500,111,126564,111,126596,111,65259,111,65260,111,65258,111,65257,111,1726,111,64428,111,64429,111,64427,111,64426,111,1729,111,64424,111,64425,111,64423,111,64422,111,1749,111,3360,111,4125,111,66794,111,71880,111,71895,111,66604,111,1984,79,2534,79,2918,79,12295,79,70864,79,71904,79,118000,79,120782,79,120792,79,120802,79,120812,79,120822,79,130032,79,65327,79,117988,79,119822,79,119874,79,119926,79,119978,79,120030,79,120082,79,120134,79,120186,79,120238,79,120290,79,120342,79,120394,79,120446,79,927,79,120502,79,120560,79,120618,79,120676,79,120734,79,11422,79,1365,79,11604,79,4816,79,2848,79,66754,79,42227,79,71861,79,66194,79,66219,79,66564,79,66838,79,9076,112,65360,112,119849,112,119901,112,119953,112,120005,112,120057,112,120109,112,120161,112,120213,112,120265,112,120317,112,120369,112,120421,112,120473,112,961,112,120530,112,120544,112,120588,112,120602,112,120646,112,120660,112,120704,112,120718,112,120762,112,120776,112,11427,112,65328,80,8473,80,117989,80,119823,80,119875,80,119927,80,119979,80,120031,80,120083,80,120187,80,120239,80,120291,80,120343,80,120395,80,120447,80,929,80,120504,80,120562,80,120620,80,120678,80,120736,80,11426,80,5090,80,5229,80,42193,80,66197,80,119850,113,119902,113,119954,113,120006,113,120058,113,120110,113,120162,113,120214,113,120266,113,120318,113,120370,113,120422,113,120474,113,1307,113,1379,113,1382,113,8474,81,117990,81,119824,81,119876,81,119928,81,119980,81,120032,81,120084,81,120188,81,120240,81,120292,81,120344,81,120396,81,120448,81,11605,81,119851,114,119903,114,119955,114,120007,114,120059,114,120111,114,120163,114,120215,114,120267,114,120319,114,120371,114,120423,114,120475,114,43847,114,43848,114,7462,114,11397,114,43905,114,119318,82,8475,82,8476,82,8477,82,117991,82,119825,82,119877,82,119929,82,120033,82,120189,82,120241,82,120293,82,120345,82,120397,82,120449,82,422,82,5025,82,5074,82,66740,82,5511,82,42211,82,94005,82,65363,115,119852,115,119904,115,119956,115,120008,115,120060,115,120112,115,120164,115,120216,115,120268,115,120320,115,120372,115,120424,115,120476,115,42801,115,445,115,1109,115,43946,115,71873,115,66632,115,65331,83,117992,83,119826,83,119878,83,119930,83,119982,83,120034,83,120086,83,120138,83,120190,83,120242,83,120294,83,120346,83,120398,83,120450,83,1029,83,1359,83,5077,83,5082,83,42210,83,94010,83,66198,83,66592,83,119853,116,119905,116,119957,116,120009,116,120061,116,120113,116,120165,116,120217,116,120269,116,120321,116,120373,116,120425,116,120477,116,8868,84,10201,84,128872,84,65332,84,117993,84,119827,84,119879,84,119931,84,119983,84,120035,84,120087,84,120139,84,120191,84,120243,84,120295,84,120347,84,120399,84,120451,84,932,84,120507,84,120565,84,120623,84,120681,84,120739,84,11430,84,5026,84,42196,84,93962,84,71868,84,66199,84,66225,84,66325,84,119854,117,119906,117,119958,117,120010,117,120062,117,120114,117,120166,117,120218,117,120270,117,120322,117,120374,117,120426,117,120478,117,42911,117,7452,117,43854,117,43858,117,651,117,965,117,120534,117,120592,117,120650,117,120708,117,120766,117,1405,117,66806,117,71896,117,8746,85,8899,85,117994,85,119828,85,119880,85,119932,85,119984,85,120036,85,120088,85,120140,85,120192,85,120244,85,120296,85,120348,85,120400,85,120452,85,1357,85,4608,85,66766,85,5196,85,42228,85,94018,85,71864,85,8744,118,8897,118,65366,118,8564,118,119855,118,119907,118,119959,118,120011,118,120063,118,120115,118,120167,118,120219,118,120271,118,120323,118,120375,118,120427,118,120479,118,7456,118,957,118,120526,118,120584,118,120642,118,120700,118,120758,118,1141,118,1496,118,71430,118,43945,118,71872,118,119309,86,1639,86,1783,86,8548,86,117995,86,119829,86,119881,86,119933,86,119985,86,120037,86,120089,86,120141,86,120193,86,120245,86,120297,86,120349,86,120401,86,120453,86,1140,86,11576,86,5081,86,5167,86,42719,86,42214,86,93960,86,71840,86,66845,86,623,119,119856,119,119908,119,119960,119,120012,119,120064,119,120116,119,120168,119,120220,119,120272,119,120324,119,120376,119,120428,119,120480,119,7457,119,1121,119,1309,119,1377,119,71434,119,71438,119,71439,119,43907,119,71910,87,71919,87,117996,87,119830,87,119882,87,119934,87,119986,87,120038,87,120090,87,120142,87,120194,87,120246,87,120298,87,120350,87,120402,87,120454,87,1308,87,5043,87,5076,87,42218,87,5742,120,10539,120,10540,120,10799,120,65368,120,8569,120,119857,120,119909,120,119961,120,120013,120,120065,120,120117,120,120169,120,120221,120,120273,120,120325,120,120377,120,120429,120,120481,120,5441,120,5501,120,5741,88,9587,88,66338,88,71916,88,65336,88,8553,88,117997,88,119831,88,119883,88,119935,88,119987,88,120039,88,120091,88,120143,88,120195,88,120247,88,120299,88,120351,88,120403,88,120455,88,42931,88,935,88,120510,88,120568,88,120626,88,120684,88,120742,88,11436,88,11613,88,5815,88,42219,88,66192,88,66228,88,66327,88,66855,88,611,121,7564,121,65369,121,119858,121,119910,121,119962,121,120014,121,120066,121,120118,121,120170,121,120222,121,120274,121,120326,121,120378,121,120430,121,120482,121,655,121,7935,121,43866,121,947,121,8509,121,120516,121,120574,121,120632,121,120690,121,120748,121,1199,121,4327,121,71900,121,65337,89,117998,89,119832,89,119884,89,119936,89,119988,89,120040,89,120092,89,120144,89,120196,89,120248,89,120300,89,120352,89,120404,89,120456,89,933,89,978,89,120508,89,120566,89,120624,89,120682,89,120740,89,11432,89,1198,89,5033,89,5053,89,42220,89,94019,89,71844,89,66226,89,119859,122,119911,122,119963,122,120015,122,120067,122,120119,122,120171,122,120223,122,120275,122,120327,122,120379,122,120431,122,120483,122,7458,122,43923,122,71876,122,71909,90,66293,90,65338,90,8484,90,8488,90,117999,90,119833,90,119885,90,119937,90,119989,90,120041,90,120197,90,120249,90,120301,90,120353,90,120405,90,120457,90,918,90,120493,90,120551,90,120609,90,120667,90,120725,90,5059,90,42204,90,71849,90,65282,34,65283,35,65284,36,65285,37,65286,38,65290,42,65291,43,65294,46,65295,47,65296,48,65298,50,65299,51,65300,52,65301,53,65302,54,65303,55,65304,56,65305,57,65308,60,65309,61,65310,62,65312,64,65316,68,65318,70,65319,71,65324,76,65329,81,65330,82,65333,85,65334,86,65335,87,65343,95,65346,98,65348,100,65350,102,65355,107,65357,109,65358,110,65361,113,65362,114,65364,116,65365,117,65367,119,65370,122,65371,123,65373,125,119846,109],\\\"_default\\\":[160,32,8211,45,65374,126,8218,44,65306,58,65281,33,8216,96,8217,96,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"cs\\\":[65374,126,8218,44,65306,58,65281,33,8216,96,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"de\\\":[65374,126,65306,58,65281,33,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"es\\\":[8211,45,65374,126,8218,44,65306,58,65281,33,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"fr\\\":[65374,126,8218,44,65306,58,65281,33,8216,96,8245,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"it\\\":[160,32,8211,45,65374,126,8218,44,65306,58,65281,33,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"ja\\\":[8211,45,8218,44,65281,33,8216,96,8245,96,180,96,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65292,44,65297,49,65307,59],\\\"ko\\\":[8211,45,65374,126,8218,44,65306,58,65281,33,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"pl\\\":[65374,126,65306,58,65281,33,8216,96,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"pt-BR\\\":[65374,126,8218,44,65306,58,65281,33,8216,96,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"qps-ploc\\\":[160,32,8211,45,65374,126,8218,44,65306,58,65281,33,8216,96,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"ru\\\":[65374,126,8218,44,65306,58,65281,33,8216,96,8245,96,180,96,12494,47,305,105,921,73,1009,112,215,120,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"tr\\\":[160,32,8211,45,65374,126,8218,44,65306,58,65281,33,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65288,40,65289,41,65292,44,65297,49,65307,59,65311,63],\\\"zh-hans\\\":[160,32,65374,126,8218,44,8245,96,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89,65297,49],\\\"zh-hant\\\":[8211,45,65374,126,8218,44,180,96,12494,47,1047,51,1073,54,1072,97,1040,65,1068,98,1042,66,1089,99,1057,67,1077,101,1045,69,1053,72,305,105,1050,75,921,73,1052,77,1086,111,1054,79,1009,112,1088,112,1056,80,1075,114,1058,84,215,120,1093,120,1061,88,1091,121,1059,89]}'\n\t\t);\n\t});\n\n\tprivate static readonly cache = new LRUCachedFunction<string, AmbiguousCharacters>((localesStr) => {\n\t\tconst locales = localesStr.split(',');\n\n\t\tfunction arrayToMap(arr: number[]): Map<number, number> {\n\t\t\tconst result = new Map<number, number>();\n\t\t\tfor (let i = 0; i < arr.length; i += 2) {\n\t\t\t\tresult.set(arr[i], arr[i + 1]);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tfunction mergeMaps(\n\t\t\tmap1: Map<number, number>,\n\t\t\tmap2: Map<number, number>\n\t\t): Map<number, number> {\n\t\t\tconst result = new Map<number, number>(map1);\n\t\t\tfor (const [key, value] of map2) {\n\t\t\t\tresult.set(key, value);\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tfunction intersectMaps(\n\t\t\tmap1: Map<number, number> | undefined,\n\t\t\tmap2: Map<number, number>\n\t\t) {\n\t\t\tif (!map1) {\n\t\t\t\treturn map2;\n\t\t\t}\n\t\t\tconst result = new Map<number, number>();\n\t\t\tfor (const [key, value] of map1) {\n\t\t\t\tif (map2.has(key)) {\n\t\t\t\t\tresult.set(key, value);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tconst data = this.ambiguousCharacterData.value;\n\n\t\tlet filteredLocales = locales.filter(\n\t\t\t(l) => !l.startsWith('_') && Object.hasOwn(data, l)\n\t\t);\n\t\tif (filteredLocales.length === 0) {\n\t\t\tfilteredLocales = ['_default'];\n\t\t}\n\n\t\tlet languageSpecificMap: Map<number, number> | undefined = undefined;\n\t\tfor (const locale of filteredLocales) {\n\t\t\tconst map = arrayToMap(data[locale]);\n\t\t\tlanguageSpecificMap = intersectMaps(languageSpecificMap, map);\n\t\t}\n\n\t\tconst commonMap = arrayToMap(data['_common']);\n\t\tconst map = mergeMaps(commonMap, languageSpecificMap!);\n\n\t\treturn new AmbiguousCharacters(map);\n\t});\n\n\tpublic static getInstance(locales: Iterable<string>): AmbiguousCharacters {\n\t\treturn AmbiguousCharacters.cache.get(Array.from(locales).join(','));\n\t}\n\n\tprivate static _locales = new Lazy<string[]>(() =>\n\t\tObject.keys(AmbiguousCharacters.ambiguousCharacterData.value).filter(\n\t\t\t(k) => !k.startsWith('_')\n\t\t)\n\t);\n\tpublic static getLocales(): string[] {\n\t\treturn AmbiguousCharacters._locales.value;\n\t}\n\n\tprivate constructor(\n\t\tprivate readonly confusableDictionary: Map<number, number>\n\t) { }\n\n\tpublic isAmbiguous(codePoint: number): boolean {\n\t\treturn this.confusableDictionary.has(codePoint);\n\t}\n\n\tpublic containsAmbiguousCharacter(str: string): boolean {\n\t\tfor (let i = 0; i < str.length; i++) {\n\t\t\tconst codePoint = str.codePointAt(i);\n\t\t\tif (typeof codePoint === 'number' && this.isAmbiguous(codePoint)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t/**\n\t * Returns the non basic ASCII code point that the given code point can be confused,\n\t * or undefined if such code point does note exist.\n\t */\n\tpublic getPrimaryConfusable(codePoint: number): number | undefined {\n\t\treturn this.confusableDictionary.get(codePoint);\n\t}\n\n\tpublic getConfusableCodePoints(): ReadonlySet<number> {\n\t\treturn new Set(this.confusableDictionary.keys());\n\t}\n}\n\nexport class InvisibleCharacters {\n\tprivate static getRawData(): Record<string | '_common', number[]> {\n\t\t// Generated using https://github.com/hediet/vscode-unicode-data\n\t\treturn JSON.parse('{\\\"_common\\\":[11,12,13,127,847,1564,4447,4448,6068,6069,6155,6156,6157,6158,7355,7356,8192,8193,8194,8195,8196,8197,8198,8199,8200,8201,8202,8204,8205,8206,8207,8234,8235,8236,8237,8238,8239,8287,8288,8289,8290,8291,8292,8293,8294,8295,8296,8297,8298,8299,8300,8301,8302,8303,10240,12644,65024,65025,65026,65027,65028,65029,65030,65031,65032,65033,65034,65035,65036,65037,65038,65039,65279,65440,65520,65521,65522,65523,65524,65525,65526,65527,65528,65532,78844,119155,119156,119157,119158,119159,119160,119161,119162,917504,917505,917506,917507,917508,917509,917510,917511,917512,917513,917514,917515,917516,917517,917518,917519,917520,917521,917522,917523,917524,917525,917526,917527,917528,917529,917530,917531,917532,917533,917534,917535,917536,917537,917538,917539,917540,917541,917542,917543,917544,917545,917546,917547,917548,917549,917550,917551,917552,917553,917554,917555,917556,917557,917558,917559,917560,917561,917562,917563,917564,917565,917566,917567,917568,917569,917570,917571,917572,917573,917574,917575,917576,917577,917578,917579,917580,917581,917582,917583,917584,917585,917586,917587,917588,917589,917590,917591,917592,917593,917594,917595,917596,917597,917598,917599,917600,917601,917602,917603,917604,917605,917606,917607,917608,917609,917610,917611,917612,917613,917614,917615,917616,917617,917618,917619,917620,917621,917622,917623,917624,917625,917626,917627,917628,917629,917630,917631,917760,917761,917762,917763,917764,917765,917766,917767,917768,917769,917770,917771,917772,917773,917774,917775,917776,917777,917778,917779,917780,917781,917782,917783,917784,917785,917786,917787,917788,917789,917790,917791,917792,917793,917794,917795,917796,917797,917798,917799,917800,917801,917802,917803,917804,917805,917806,917807,917808,917809,917810,917811,917812,917813,917814,917815,917816,917817,917818,917819,917820,917821,917822,917823,917824,917825,917826,917827,917828,917829,917830,917831,917832,917833,917834,917835,917836,917837,917838,917839,917840,917841,917842,917843,917844,917845,917846,917847,917848,917849,917850,917851,917852,917853,917854,917855,917856,917857,917858,917859,917860,917861,917862,917863,917864,917865,917866,917867,917868,917869,917870,917871,917872,917873,917874,917875,917876,917877,917878,917879,917880,917881,917882,917883,917884,917885,917886,917887,917888,917889,917890,917891,917892,917893,917894,917895,917896,917897,917898,917899,917900,917901,917902,917903,917904,917905,917906,917907,917908,917909,917910,917911,917912,917913,917914,917915,917916,917917,917918,917919,917920,917921,917922,917923,917924,917925,917926,917927,917928,917929,917930,917931,917932,917933,917934,917935,917936,917937,917938,917939,917940,917941,917942,917943,917944,917945,917946,917947,917948,917949,917950,917951,917952,917953,917954,917955,917956,917957,917958,917959,917960,917961,917962,917963,917964,917965,917966,917967,917968,917969,917970,917971,917972,917973,917974,917975,917976,917977,917978,917979,917980,917981,917982,917983,917984,917985,917986,917987,917988,917989,917990,917991,917992,917993,917994,917995,917996,917997,917998,917999],\\\"cs\\\":[173,8203,12288],\\\"de\\\":[173,8203,12288],\\\"es\\\":[8203,12288],\\\"fr\\\":[173,8203,12288],\\\"it\\\":[160,173,12288],\\\"ja\\\":[173],\\\"ko\\\":[173,12288],\\\"pl\\\":[173,8203,12288],\\\"pt-BR\\\":[173,8203,12288],\\\"qps-ploc\\\":[160,173,8203,12288],\\\"ru\\\":[173,12288],\\\"tr\\\":[160,173,8203,12288],\\\"zh-hans\\\":[160,173,8203,12288],\\\"zh-hant\\\":[173,12288]}');\n\t}\n\n\tprivate static _data: Set<number> | undefined = undefined;\n\n\tprivate static getData() {\n\t\tif (!this._data) {\n\t\t\tthis._data = new Set([...Object.values(InvisibleCharacters.getRawData())].flat());\n\t\t}\n\t\treturn this._data;\n\t}\n\n\tpublic static isInvisibleCharacter(codePoint: number): boolean {\n\t\treturn InvisibleCharacters.getData().has(codePoint);\n\t}\n\n\tpublic static containsInvisibleCharacter(str: string): boolean {\n\t\tfor (let i = 0; i < str.length; i++) {\n\t\t\tconst codePoint = str.codePointAt(i);\n\t\t\tif (typeof codePoint === 'number' && (InvisibleCharacters.isInvisibleCharacter(codePoint) || codePoint === CodePoint.space)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic static get codePoints(): ReadonlySet<number> {\n\t\treturn InvisibleCharacters.getData();\n\t}\n}\n\nexport const Ellipsis = '\\u2026';\n\n/**\n * Convert a Unicode string to a string in which each 16-bit unit occupies only one byte\n *\n * From https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/btoa\n */\nfunction toBinary(str: string): string {\n\tconst codeUnits = new Uint16Array(str.length);\n\tfor (let i = 0; i < codeUnits.length; i++) {\n\t\tcodeUnits[i] = str.charCodeAt(i);\n\t}\n\tlet binary = '';\n\tconst uint8array = new Uint8Array(codeUnits.buffer);\n\tfor (let i = 0; i < uint8array.length; i++) {\n\t\tbinary += String.fromCharCode(uint8array[i]);\n\t}\n\treturn binary;\n}\n\n/**\n * Version of the global `btoa` function that handles multi-byte characters instead\n * of throwing an exception.\n */\n\nexport function multibyteAwareBtoa(str: string): string {\n\treturn btoa(toBinary(str));\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CharCode } from './charCode.js';\nimport { isAbsolute, join, normalize, posix, sep } from './path.js';\nimport { isWindows } from './platform.js';\nimport { equalsIgnoreCase, rtrim, startsWithIgnoreCase } from './strings.js';\nimport { isNumber } from './types.js';\n\nexport function isPathSeparator(code: number) {\n\treturn code === CharCode.Slash || code === CharCode.Backslash;\n}\n\n/**\n * Takes a Windows OS path and changes backward slashes to forward slashes.\n * This should only be done for OS paths from Windows (or user provided paths potentially from Windows).\n * Using it on a Linux or MaxOS path might change it.\n */\nexport function toSlashes(osPath: string) {\n\treturn osPath.replace(/[\\\\/]/g, posix.sep);\n}\n\n/**\n * Takes a Windows OS path (using backward or forward slashes) and turns it into a posix path:\n * - turns backward slashes into forward slashes\n * - makes it absolute if it starts with a drive letter\n * This should only be done for OS paths from Windows (or user provided paths potentially from Windows).\n * Using it on a Linux or MaxOS path might change it.\n */\nexport function toPosixPath(osPath: string) {\n\tif (osPath.indexOf('/') === -1) {\n\t\tosPath = toSlashes(osPath);\n\t}\n\tif (/^[a-zA-Z]:(\\/|$)/.test(osPath)) { // starts with a drive letter\n\t\tosPath = '/' + osPath;\n\t}\n\treturn osPath;\n}\n\n/**\n * Computes the _root_ this path, like `getRoot('c:\\files') === c:\\`,\n * `getRoot('files:///files/path') === files:///`,\n * or `getRoot('\\\\server\\shares\\path') === \\\\server\\shares\\`\n */\nexport function getRoot(path: string, sep: string = posix.sep): string {\n\tif (!path) {\n\t\treturn '';\n\t}\n\n\tconst len = path.length;\n\tconst firstLetter = path.charCodeAt(0);\n\tif (isPathSeparator(firstLetter)) {\n\t\tif (isPathSeparator(path.charCodeAt(1))) {\n\t\t\t// UNC candidate \\\\localhost\\shares\\ddd\n\t\t\t//               ^^^^^^^^^^^^^^^^^^^\n\t\t\tif (!isPathSeparator(path.charCodeAt(2))) {\n\t\t\t\tlet pos = 3;\n\t\t\t\tconst start = pos;\n\t\t\t\tfor (; pos < len; pos++) {\n\t\t\t\t\tif (isPathSeparator(path.charCodeAt(pos))) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (start !== pos && !isPathSeparator(path.charCodeAt(pos + 1))) {\n\t\t\t\t\tpos += 1;\n\t\t\t\t\tfor (; pos < len; pos++) {\n\t\t\t\t\t\tif (isPathSeparator(path.charCodeAt(pos))) {\n\t\t\t\t\t\t\treturn path.slice(0, pos + 1) // consume this separator\n\t\t\t\t\t\t\t\t.replace(/[\\\\/]/g, sep);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// /user/far\n\t\t// ^\n\t\treturn sep;\n\n\t} else if (isWindowsDriveLetter(firstLetter)) {\n\t\t// check for windows drive letter c:\\ or c:\n\n\t\tif (path.charCodeAt(1) === CharCode.Colon) {\n\t\t\tif (isPathSeparator(path.charCodeAt(2))) {\n\t\t\t\t// C:\\fff\n\t\t\t\t// ^^^\n\t\t\t\treturn path.slice(0, 2) + sep;\n\t\t\t} else {\n\t\t\t\t// C:\n\t\t\t\t// ^^\n\t\t\t\treturn path.slice(0, 2);\n\t\t\t}\n\t\t}\n\t}\n\n\t// check for URI\n\t// scheme://authority/path\n\t// ^^^^^^^^^^^^^^^^^^^\n\tlet pos = path.indexOf('://');\n\tif (pos !== -1) {\n\t\tpos += 3; // 3 -> \"://\".length\n\t\tfor (; pos < len; pos++) {\n\t\t\tif (isPathSeparator(path.charCodeAt(pos))) {\n\t\t\t\treturn path.slice(0, pos + 1); // consume this separator\n\t\t\t}\n\t\t}\n\t}\n\n\treturn '';\n}\n\n/**\n * Check if the path follows this pattern: `\\\\hostname\\sharename`.\n *\n * @see https://msdn.microsoft.com/en-us/library/gg465305.aspx\n * @return A boolean indication if the path is a UNC path, on none-windows\n * always false.\n */\nexport function isUNC(path: string): boolean {\n\tif (!isWindows) {\n\t\t// UNC is a windows concept\n\t\treturn false;\n\t}\n\n\tif (!path || path.length < 5) {\n\t\t// at least \\\\a\\b\n\t\treturn false;\n\t}\n\n\tlet code = path.charCodeAt(0);\n\tif (code !== CharCode.Backslash) {\n\t\treturn false;\n\t}\n\n\tcode = path.charCodeAt(1);\n\n\tif (code !== CharCode.Backslash) {\n\t\treturn false;\n\t}\n\n\tlet pos = 2;\n\tconst start = pos;\n\tfor (; pos < path.length; pos++) {\n\t\tcode = path.charCodeAt(pos);\n\t\tif (code === CharCode.Backslash) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (start === pos) {\n\t\treturn false;\n\t}\n\n\tcode = path.charCodeAt(pos + 1);\n\n\tif (isNaN(code) || code === CharCode.Backslash) {\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n// Reference: https://en.wikipedia.org/wiki/Filename\nconst WINDOWS_INVALID_FILE_CHARS = /[\\\\/:\\*\\?\"<>\\|]/g;\nconst UNIX_INVALID_FILE_CHARS = /[/]/g;\nconst WINDOWS_FORBIDDEN_NAMES = /^(con|prn|aux|clock\\$|nul|lpt[0-9]|com[0-9])(\\.(.*?))?$/i;\nexport function isValidBasename(name: string | null | undefined, isWindowsOS: boolean = isWindows): boolean {\n\tconst invalidFileChars = isWindowsOS ? WINDOWS_INVALID_FILE_CHARS : UNIX_INVALID_FILE_CHARS;\n\n\tif (!name || name.length === 0 || /^\\s+$/.test(name)) {\n\t\treturn false; // require a name that is not just whitespace\n\t}\n\n\tinvalidFileChars.lastIndex = 0; // the holy grail of software development\n\tif (invalidFileChars.test(name)) {\n\t\treturn false; // check for certain invalid file characters\n\t}\n\n\tif (isWindowsOS && WINDOWS_FORBIDDEN_NAMES.test(name)) {\n\t\treturn false; // check for certain invalid file names\n\t}\n\n\tif (name === '.' || name === '..') {\n\t\treturn false; // check for reserved values\n\t}\n\n\tif (isWindowsOS && name[name.length - 1] === '.') {\n\t\treturn false; // Windows: file cannot end with a \".\"\n\t}\n\n\tif (isWindowsOS && name.length !== name.trim().length) {\n\t\treturn false; // Windows: file cannot end with a whitespace\n\t}\n\n\tif (name.length > 255) {\n\t\treturn false; // most file systems do not allow files > 255 length\n\t}\n\n\treturn true;\n}\n\n/**\n * @deprecated please use `IUriIdentityService.extUri.isEqual` instead. If you are\n * in a context without services, consider to pass down the `extUri` from the outside\n * or use `extUriBiasedIgnorePathCase` if you know what you are doing.\n */\nexport function isEqual(pathA: string, pathB: string, ignoreCase?: boolean): boolean {\n\tconst identityEquals = (pathA === pathB);\n\tif (!ignoreCase || identityEquals) {\n\t\treturn identityEquals;\n\t}\n\n\tif (!pathA || !pathB) {\n\t\treturn false;\n\t}\n\n\treturn equalsIgnoreCase(pathA, pathB);\n}\n\n/**\n * @deprecated please use `IUriIdentityService.extUri.isEqualOrParent` instead. If\n * you are in a context without services, consider to pass down the `extUri` from the\n * outside, or use `extUriBiasedIgnorePathCase` if you know what you are doing.\n */\nexport function isEqualOrParent(base: string, parentCandidate: string, ignoreCase?: boolean, separator = sep): boolean {\n\tif (base === parentCandidate) {\n\t\treturn true;\n\t}\n\n\tif (!base || !parentCandidate) {\n\t\treturn false;\n\t}\n\n\tif (parentCandidate.length > base.length) {\n\t\treturn false;\n\t}\n\n\tif (ignoreCase) {\n\t\tconst beginsWith = startsWithIgnoreCase(base, parentCandidate);\n\t\tif (!beginsWith) {\n\t\t\treturn false;\n\t\t}\n\n\t\tif (parentCandidate.length === base.length) {\n\t\t\treturn true; // same path, different casing\n\t\t}\n\n\t\tlet sepOffset = parentCandidate.length;\n\t\tif (parentCandidate.charAt(parentCandidate.length - 1) === separator) {\n\t\t\tsepOffset--; // adjust the expected sep offset in case our candidate already ends in separator character\n\t\t}\n\n\t\treturn base.charAt(sepOffset) === separator;\n\t}\n\n\tif (parentCandidate.charAt(parentCandidate.length - 1) !== separator) {\n\t\tparentCandidate += separator;\n\t}\n\n\treturn base.indexOf(parentCandidate) === 0;\n}\n\nexport function isWindowsDriveLetter(char0: number): boolean {\n\treturn char0 >= CharCode.A && char0 <= CharCode.Z || char0 >= CharCode.a && char0 <= CharCode.z;\n}\n\nexport function sanitizeFilePath(candidate: string, cwd: string): string {\n\n\t// Special case: allow to open a drive letter without trailing backslash\n\tif (isWindows && candidate.endsWith(':')) {\n\t\tcandidate += sep;\n\t}\n\n\t// Ensure absolute\n\tif (!isAbsolute(candidate)) {\n\t\tcandidate = join(cwd, candidate);\n\t}\n\n\t// Ensure normalized\n\tcandidate = normalize(candidate);\n\n\t// Ensure no trailing slash/backslash\n\treturn removeTrailingPathSeparator(candidate);\n}\n\nexport function removeTrailingPathSeparator(candidate: string): string {\n\tif (isWindows) {\n\t\tcandidate = rtrim(candidate, sep);\n\n\t\t// Special case: allow to open drive root ('C:\\')\n\t\tif (candidate.endsWith(':')) {\n\t\t\tcandidate += sep;\n\t\t}\n\n\t} else {\n\t\tcandidate = rtrim(candidate, sep);\n\n\t\t// Special case: allow to open root ('/')\n\t\tif (!candidate) {\n\t\t\tcandidate = sep;\n\t\t}\n\t}\n\n\treturn candidate;\n}\n\nexport function isRootOrDriveLetter(path: string): boolean {\n\tconst pathNormalized = normalize(path);\n\n\tif (isWindows) {\n\t\tif (path.length > 3) {\n\t\t\treturn false;\n\t\t}\n\n\t\treturn hasDriveLetter(pathNormalized) &&\n\t\t\t(path.length === 2 || pathNormalized.charCodeAt(2) === CharCode.Backslash);\n\t}\n\n\treturn pathNormalized === posix.sep;\n}\n\nexport function hasDriveLetter(path: string, isWindowsOS: boolean = isWindows): boolean {\n\tif (isWindowsOS) {\n\t\treturn isWindowsDriveLetter(path.charCodeAt(0)) && path.charCodeAt(1) === CharCode.Colon;\n\t}\n\n\treturn false;\n}\n\nexport function getDriveLetter(path: string, isWindowsOS: boolean = isWindows): string | undefined {\n\treturn hasDriveLetter(path, isWindowsOS) ? path[0] : undefined;\n}\n\nexport function indexOfPath(path: string, candidate: string, ignoreCase?: boolean): number {\n\tif (candidate.length > path.length) {\n\t\treturn -1;\n\t}\n\n\tif (path === candidate) {\n\t\treturn 0;\n\t}\n\n\tif (ignoreCase) {\n\t\tpath = path.toLowerCase();\n\t\tcandidate = candidate.toLowerCase();\n\t}\n\n\treturn path.indexOf(candidate);\n}\n\nexport interface IPathWithLineAndColumn {\n\tpath: string;\n\tline?: number;\n\tcolumn?: number;\n}\n\nexport function parseLineAndColumnAware(rawPath: string): IPathWithLineAndColumn {\n\tconst segments = rawPath.split(':'); // C:\\file.txt:<line>:<column>\n\n\tlet path: string | undefined;\n\tlet line: number | undefined;\n\tlet column: number | undefined;\n\n\tfor (const segment of segments) {\n\t\tconst segmentAsNumber = Number(segment);\n\t\tif (!isNumber(segmentAsNumber)) {\n\t\t\tpath = path ? [path, segment].join(':') : segment; // a colon can well be part of a path (e.g. C:\\...)\n\t\t} else if (line === undefined) {\n\t\t\tline = segmentAsNumber;\n\t\t} else if (column === undefined) {\n\t\t\tcolumn = segmentAsNumber;\n\t\t}\n\t}\n\n\tif (!path) {\n\t\tthrow new Error('Format for `--goto` should be: `FILE:LINE(:COLUMN)`');\n\t}\n\n\treturn {\n\t\tpath,\n\t\tline: line !== undefined ? line : undefined,\n\t\tcolumn: column !== undefined ? column : line !== undefined ? 1 : undefined // if we have a line, make sure column is also set\n\t};\n}\n\nconst pathChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';\nconst windowsSafePathFirstChars = 'BDEFGHIJKMOQRSTUVWXYZbdefghijkmoqrstuvwxyz0123456789';\n\nexport function randomPath(parent?: string, prefix?: string, randomLength = 8): string {\n\tlet suffix = '';\n\tfor (let i = 0; i < randomLength; i++) {\n\t\tlet pathCharsTouse: string;\n\t\tif (i === 0 && isWindows && !prefix && (randomLength === 3 || randomLength === 4)) {\n\n\t\t\t// Windows has certain reserved file names that cannot be used, such\n\t\t\t// as AUX, CON, PRN, etc. We want to avoid generating a random name\n\t\t\t// that matches that pattern, so we use a different set of characters\n\t\t\t// for the first character of the name that does not include any of\n\t\t\t// the reserved names first characters.\n\n\t\t\tpathCharsTouse = windowsSafePathFirstChars;\n\t\t} else {\n\t\t\tpathCharsTouse = pathChars;\n\t\t}\n\n\t\tsuffix += pathCharsTouse.charAt(Math.floor(Math.random() * pathCharsTouse.length));\n\t}\n\n\tlet randomFileName: string;\n\tif (prefix) {\n\t\trandomFileName = `${prefix}-${suffix}`;\n\t} else {\n\t\trandomFileName = suffix;\n\t}\n\n\tif (parent) {\n\t\treturn join(parent, randomFileName);\n\t}\n\n\treturn randomFileName;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as errors from './errors.js';\nimport * as platform from './platform.js';\nimport { equalsIgnoreCase, startsWithIgnoreCase } from './strings.js';\nimport { URI } from './uri.js';\nimport * as paths from './path.js';\n\nexport namespace Schemas {\n\n\t/**\n\t * A schema that is used for models that exist in memory\n\t * only and that have no correspondence on a server or such.\n\t */\n\texport const inMemory = 'inmemory';\n\n\t/**\n\t * A schema that is used for setting files\n\t */\n\texport const vscode = 'vscode';\n\n\t/**\n\t * A schema that is used for internal private files\n\t */\n\texport const internal = 'private';\n\n\t/**\n\t * A walk-through document.\n\t */\n\texport const walkThrough = 'walkThrough';\n\n\t/**\n\t * An embedded code snippet.\n\t */\n\texport const walkThroughSnippet = 'walkThroughSnippet';\n\n\texport const http = 'http';\n\n\texport const https = 'https';\n\n\texport const file = 'file';\n\n\texport const mailto = 'mailto';\n\n\texport const untitled = 'untitled';\n\n\texport const data = 'data';\n\n\texport const command = 'command';\n\n\texport const vscodeRemote = 'vscode-remote';\n\n\texport const vscodeRemoteResource = 'vscode-remote-resource';\n\n\texport const vscodeManagedRemoteResource = 'vscode-managed-remote-resource';\n\n\texport const vscodeUserData = 'vscode-userdata';\n\n\texport const vscodeCustomEditor = 'vscode-custom-editor';\n\n\texport const vscodeNotebookCell = 'vscode-notebook-cell';\n\texport const vscodeNotebookCellMetadata = 'vscode-notebook-cell-metadata';\n\texport const vscodeNotebookCellMetadataDiff = 'vscode-notebook-cell-metadata-diff';\n\texport const vscodeNotebookCellOutput = 'vscode-notebook-cell-output';\n\texport const vscodeNotebookCellOutputDiff = 'vscode-notebook-cell-output-diff';\n\texport const vscodeNotebookMetadata = 'vscode-notebook-metadata';\n\texport const vscodeInteractiveInput = 'vscode-interactive-input';\n\n\texport const vscodeSettings = 'vscode-settings';\n\n\texport const vscodeWorkspaceTrust = 'vscode-workspace-trust';\n\n\texport const vscodeTerminal = 'vscode-terminal';\n\n\t/** Scheme used for code blocks in chat. */\n\texport const vscodeChatCodeBlock = 'vscode-chat-code-block';\n\n\t/** Scheme used for LHS of code compare (aka diff) blocks in chat. */\n\texport const vscodeChatCodeCompareBlock = 'vscode-chat-code-compare-block';\n\n\t/** Scheme used for the chat input editor. */\n\texport const vscodeChatEditor = 'vscode-chat-editor';\n\n\t/** Scheme used for the chat input part */\n\texport const vscodeChatInput = 'chatSessionInput';\n\n\t/** Scheme used for local chat session content */\n\texport const vscodeLocalChatSession = 'vscode-chat-session';\n\n\t/**\n\t * Scheme used internally for webviews that aren't linked to a resource (i.e. not custom editors)\n\t */\n\texport const webviewPanel = 'webview-panel';\n\n\t/**\n\t * Scheme used for loading the wrapper html and script in webviews.\n\t */\n\texport const vscodeWebview = 'vscode-webview';\n\n\t/**\n\t * Scheme used for extension pages\n\t */\n\texport const extension = 'extension';\n\n\t/**\n\t * Scheme used as a replacement of `file` scheme to load\n\t * files with our custom protocol handler (desktop only).\n\t */\n\texport const vscodeFileResource = 'vscode-file';\n\n\t/**\n\t * Scheme used for temporary resources\n\t */\n\texport const tmp = 'tmp';\n\n\t/**\n\t * Scheme used vs live share\n\t */\n\texport const vsls = 'vsls';\n\n\t/**\n\t * Scheme used for the Source Control commit input's text document\n\t */\n\texport const vscodeSourceControl = 'vscode-scm';\n\n\t/**\n\t * Scheme used for input box for creating comments.\n\t */\n\texport const commentsInput = 'comment';\n\n\t/**\n\t * Scheme used for special rendering of settings in the release notes\n\t */\n\texport const codeSetting = 'code-setting';\n\n\t/**\n\t * Scheme used for output panel resources\n\t */\n\texport const outputChannel = 'output';\n\n\t/**\n\t * Scheme used for the accessible view\n\t */\n\texport const accessibleView = 'accessible-view';\n\n\t/**\n\t * Used for snapshots of chat edits\n\t */\n\texport const chatEditingSnapshotScheme = 'chat-editing-snapshot-text-model';\n\texport const chatEditingModel = 'chat-editing-text-model';\n\n\t/**\n\t * Used for rendering multidiffs in copilot agent sessions\n\t */\n\texport const copilotPr = 'copilot-pr';\n}\n\nexport function matchesScheme(target: URI | string, scheme: string): boolean {\n\tif (URI.isUri(target)) {\n\t\treturn equalsIgnoreCase(target.scheme, scheme);\n\t} else {\n\t\treturn startsWithIgnoreCase(target, scheme + ':');\n\t}\n}\n\nexport function matchesSomeScheme(target: URI | string, ...schemes: string[]): boolean {\n\treturn schemes.some(scheme => matchesScheme(target, scheme));\n}\n\nexport const connectionTokenCookieName = 'vscode-tkn';\nexport const connectionTokenQueryName = 'tkn';\n\nclass RemoteAuthoritiesImpl {\n\tprivate readonly _hosts: { [authority: string]: string | undefined } = Object.create(null);\n\tprivate readonly _ports: { [authority: string]: number | undefined } = Object.create(null);\n\tprivate readonly _connectionTokens: { [authority: string]: string | undefined } = Object.create(null);\n\tprivate _preferredWebSchema: 'http' | 'https' = 'http';\n\tprivate _delegate: ((uri: URI) => URI) | null = null;\n\tprivate _serverRootPath: string = '/';\n\n\tsetPreferredWebSchema(schema: 'http' | 'https') {\n\t\tthis._preferredWebSchema = schema;\n\t}\n\n\tsetDelegate(delegate: (uri: URI) => URI): void {\n\t\tthis._delegate = delegate;\n\t}\n\n\tsetServerRootPath(product: { quality?: string; commit?: string }, serverBasePath: string | undefined): void {\n\t\tthis._serverRootPath = paths.posix.join(serverBasePath ?? '/', getServerProductSegment(product));\n\t}\n\n\tgetServerRootPath(): string {\n\t\treturn this._serverRootPath;\n\t}\n\n\tprivate get _remoteResourcesPath(): string {\n\t\treturn paths.posix.join(this._serverRootPath, Schemas.vscodeRemoteResource);\n\t}\n\n\tset(authority: string, host: string, port: number): void {\n\t\tthis._hosts[authority] = host;\n\t\tthis._ports[authority] = port;\n\t}\n\n\tsetConnectionToken(authority: string, connectionToken: string): void {\n\t\tthis._connectionTokens[authority] = connectionToken;\n\t}\n\n\tgetPreferredWebSchema(): 'http' | 'https' {\n\t\treturn this._preferredWebSchema;\n\t}\n\n\trewrite(uri: URI): URI {\n\t\tif (this._delegate) {\n\t\t\ttry {\n\t\t\t\treturn this._delegate(uri);\n\t\t\t} catch (err) {\n\t\t\t\terrors.onUnexpectedError(err);\n\t\t\t\treturn uri;\n\t\t\t}\n\t\t}\n\t\tconst authority = uri.authority;\n\t\tlet host = this._hosts[authority];\n\t\tif (host && host.indexOf(':') !== -1 && host.indexOf('[') === -1) {\n\t\t\thost = `[${host}]`;\n\t\t}\n\t\tconst port = this._ports[authority];\n\t\tconst connectionToken = this._connectionTokens[authority];\n\t\tlet query = `path=${encodeURIComponent(uri.path)}`;\n\t\tif (typeof connectionToken === 'string') {\n\t\t\tquery += `&${connectionTokenQueryName}=${encodeURIComponent(connectionToken)}`;\n\t\t}\n\t\treturn URI.from({\n\t\t\tscheme: platform.isWeb ? this._preferredWebSchema : Schemas.vscodeRemoteResource,\n\t\t\tauthority: `${host}:${port}`,\n\t\t\tpath: this._remoteResourcesPath,\n\t\t\tquery\n\t\t});\n\t}\n}\n\nexport const RemoteAuthorities = new RemoteAuthoritiesImpl();\n\nexport function getServerProductSegment(product: { quality?: string; commit?: string }) {\n\treturn `${product.quality ?? 'oss'}-${product.commit ?? 'dev'}`;\n}\n\n/**\n * A string pointing to a path inside the app. It should not begin with ./ or ../\n */\nexport type AppResourcePath = (\n\t`a${string}` | `b${string}` | `c${string}` | `d${string}` | `e${string}` | `f${string}`\n\t| `g${string}` | `h${string}` | `i${string}` | `j${string}` | `k${string}` | `l${string}`\n\t| `m${string}` | `n${string}` | `o${string}` | `p${string}` | `q${string}` | `r${string}`\n\t| `s${string}` | `t${string}` | `u${string}` | `v${string}` | `w${string}` | `x${string}`\n\t| `y${string}` | `z${string}`\n);\n\nexport const builtinExtensionsPath: AppResourcePath = 'vs/../../extensions';\nexport const nodeModulesPath: AppResourcePath = 'vs/../../node_modules';\nexport const nodeModulesAsarPath: AppResourcePath = 'vs/../../node_modules.asar';\nexport const nodeModulesAsarUnpackedPath: AppResourcePath = 'vs/../../node_modules.asar.unpacked';\n\nexport const VSCODE_AUTHORITY = 'vscode-app';\n\nclass FileAccessImpl {\n\n\tprivate static readonly FALLBACK_AUTHORITY = VSCODE_AUTHORITY;\n\n\t/**\n\t * Returns a URI to use in contexts where the browser is responsible\n\t * for loading (e.g. fetch()) or when used within the DOM.\n\t *\n\t * **Note:** use `dom.ts#asCSSUrl` whenever the URL is to be used in CSS context.\n\t */\n\tasBrowserUri(resourcePath: AppResourcePath | ''): URI {\n\t\tconst uri = this.toUri(resourcePath);\n\t\treturn this.uriToBrowserUri(uri);\n\t}\n\n\t/**\n\t * Returns a URI to use in contexts where the browser is responsible\n\t * for loading (e.g. fetch()) or when used within the DOM.\n\t *\n\t * **Note:** use `dom.ts#asCSSUrl` whenever the URL is to be used in CSS context.\n\t */\n\turiToBrowserUri(uri: URI): URI {\n\t\t// Handle remote URIs via `RemoteAuthorities`\n\t\tif (uri.scheme === Schemas.vscodeRemote) {\n\t\t\treturn RemoteAuthorities.rewrite(uri);\n\t\t}\n\n\t\t// Convert to `vscode-file` resource..\n\t\tif (\n\t\t\t// ...only ever for `file` resources\n\t\t\turi.scheme === Schemas.file &&\n\t\t\t(\n\t\t\t\t// ...and we run in native environments\n\t\t\t\tplatform.isNative ||\n\t\t\t\t// ...or web worker extensions on desktop\n\t\t\t\t(platform.webWorkerOrigin === `${Schemas.vscodeFileResource}://${FileAccessImpl.FALLBACK_AUTHORITY}`)\n\t\t\t)\n\t\t) {\n\t\t\treturn uri.with({\n\t\t\t\tscheme: Schemas.vscodeFileResource,\n\t\t\t\t// We need to provide an authority here so that it can serve\n\t\t\t\t// as origin for network and loading matters in chromium.\n\t\t\t\t// If the URI is not coming with an authority already, we\n\t\t\t\t// add our own\n\t\t\t\tauthority: uri.authority || FileAccessImpl.FALLBACK_AUTHORITY,\n\t\t\t\tquery: null,\n\t\t\t\tfragment: null\n\t\t\t});\n\t\t}\n\n\t\treturn uri;\n\t}\n\n\t/**\n\t * Returns the `file` URI to use in contexts where node.js\n\t * is responsible for loading.\n\t */\n\tasFileUri(resourcePath: AppResourcePath | ''): URI {\n\t\tconst uri = this.toUri(resourcePath);\n\t\treturn this.uriToFileUri(uri);\n\t}\n\n\t/**\n\t * Returns the `file` URI to use in contexts where node.js\n\t * is responsible for loading.\n\t */\n\turiToFileUri(uri: URI): URI {\n\t\t// Only convert the URI if it is `vscode-file:` scheme\n\t\tif (uri.scheme === Schemas.vscodeFileResource) {\n\t\t\treturn uri.with({\n\t\t\t\tscheme: Schemas.file,\n\t\t\t\t// Only preserve the `authority` if it is different from\n\t\t\t\t// our fallback authority. This ensures we properly preserve\n\t\t\t\t// Windows UNC paths that come with their own authority.\n\t\t\t\tauthority: uri.authority !== FileAccessImpl.FALLBACK_AUTHORITY ? uri.authority : null,\n\t\t\t\tquery: null,\n\t\t\t\tfragment: null\n\t\t\t});\n\t\t}\n\n\t\treturn uri;\n\t}\n\n\tprivate toUri(uriOrModule: URI | string): URI {\n\t\tif (URI.isUri(uriOrModule)) {\n\t\t\treturn uriOrModule;\n\t\t}\n\n\t\tif (globalThis._VSCODE_FILE_ROOT) {\n\t\t\tconst rootUriOrPath = globalThis._VSCODE_FILE_ROOT;\n\n\t\t\t// File URL (with scheme)\n\t\t\tif (/^\\w[\\w\\d+.-]*:\\/\\//.test(rootUriOrPath)) {\n\t\t\t\treturn URI.joinPath(URI.parse(rootUriOrPath, true), uriOrModule);\n\t\t\t}\n\n\t\t\t// File Path (no scheme)\n\t\t\tconst modulePath = paths.join(rootUriOrPath, uriOrModule);\n\t\t\treturn URI.file(modulePath);\n\t\t}\n\n\t\tthrow new Error('Cannot determine URI for module id!');\n\t}\n}\n\nexport const FileAccess = new FileAccessImpl();\n\nexport const CacheControlheaders: Record<string, string> = Object.freeze({\n\t'Cache-Control': 'no-cache, no-store'\n});\n\nexport const DocumentPolicyheaders: Record<string, string> = Object.freeze({\n\t'Document-Policy': 'include-js-call-stacks-in-crash-reports'\n});\n\nexport namespace COI {\n\n\tconst coiHeaders = new Map<'3' | '2' | '1' | string, Record<string, string>>([\n\t\t['1', { 'Cross-Origin-Opener-Policy': 'same-origin' }],\n\t\t['2', { 'Cross-Origin-Embedder-Policy': 'require-corp' }],\n\t\t['3', { 'Cross-Origin-Opener-Policy': 'same-origin', 'Cross-Origin-Embedder-Policy': 'require-corp' }],\n\t]);\n\n\texport const CoopAndCoep = Object.freeze(coiHeaders.get('3'));\n\n\tconst coiSearchParamName = 'vscode-coi';\n\n\t/**\n\t * Extract desired headers from `vscode-coi` invocation\n\t */\n\texport function getHeadersFromQuery(url: string | URI | URL): Record<string, string> | undefined {\n\t\tlet params: URLSearchParams | undefined;\n\t\tif (typeof url === 'string') {\n\t\t\tparams = new URL(url).searchParams;\n\t\t} else if (url instanceof URL) {\n\t\t\tparams = url.searchParams;\n\t\t} else if (URI.isUri(url)) {\n\t\t\tparams = new URL(url.toString(true)).searchParams;\n\t\t}\n\t\tconst value = params?.get(coiSearchParamName);\n\t\tif (!value) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn coiHeaders.get(value);\n\t}\n\n\t/**\n\t * Add the `vscode-coi` query attribute based on wanting `COOP` and `COEP`. Will be a noop when `crossOriginIsolated`\n\t * isn't enabled the current context\n\t */\n\texport function addSearchParam(urlOrSearch: URLSearchParams | Record<string, string>, coop: boolean, coep: boolean): void {\n\t\tif (!(globalThis as typeof globalThis & { crossOriginIsolated?: boolean }).crossOriginIsolated) {\n\t\t\t// depends on the current context being COI\n\t\t\treturn;\n\t\t}\n\t\tconst value = coop && coep ? '3' : coep ? '2' : '1';\n\t\tif (urlOrSearch instanceof URLSearchParams) {\n\t\t\turlOrSearch.set(coiSearchParamName, value);\n\t\t} else {\n\t\t\turlOrSearch[coiSearchParamName] = value;\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CharCode } from './charCode.js';\nimport * as extpath from './extpath.js';\nimport { Schemas } from './network.js';\nimport * as paths from './path.js';\nimport { isLinux, isWindows } from './platform.js';\nimport { compare as strCompare, equalsIgnoreCase } from './strings.js';\nimport { URI, uriToFsPath } from './uri.js';\n\nexport function originalFSPath(uri: URI): string {\n\treturn uriToFsPath(uri, true);\n}\n\n//#region IExtUri\n\nexport interface IExtUri {\n\n\t// --- identity\n\n\t/**\n\t * Compares two uris.\n\t *\n\t * @param uri1 Uri\n\t * @param uri2 Uri\n\t * @param ignoreFragment Ignore the fragment (defaults to `false`)\n\t */\n\tcompare(uri1: URI, uri2: URI, ignoreFragment?: boolean): number;\n\n\t/**\n\t * Tests whether two uris are equal\n\t *\n\t * @param uri1 Uri\n\t * @param uri2 Uri\n\t * @param ignoreFragment Ignore the fragment (defaults to `false`)\n\t */\n\tisEqual(uri1: URI | undefined, uri2: URI | undefined, ignoreFragment?: boolean): boolean;\n\n\t/**\n\t * Tests whether a `candidate` URI is a parent or equal of a given `base` URI.\n\t *\n\t * @param base A uri which is \"longer\" or at least same length as `parentCandidate`\n\t * @param parentCandidate A uri which is \"shorter\" or up to same length as `base`\n\t * @param ignoreFragment Ignore the fragment (defaults to `false`)\n\t */\n\tisEqualOrParent(base: URI, parentCandidate: URI, ignoreFragment?: boolean): boolean;\n\n\t/**\n\t * Creates a key from a resource URI to be used to resource comparison and for resource maps.\n\t * @see {@link ResourceMap}\n\t * @param uri Uri\n\t * @param ignoreFragment Ignore the fragment (defaults to `false`)\n\t */\n\tgetComparisonKey(uri: URI, ignoreFragment?: boolean): string;\n\n\t/**\n\t * Whether the casing of the path-component of the uri should be ignored.\n\t */\n\tignorePathCasing(uri: URI): boolean;\n\n\t// --- path math\n\n\tbasenameOrAuthority(resource: URI): string;\n\n\t/**\n\t * Returns the basename of the path component of an uri.\n\t * @param resource\n\t */\n\tbasename(resource: URI): string;\n\n\t/**\n\t * Returns the extension of the path component of an uri.\n\t * @param resource\n\t */\n\textname(resource: URI): string;\n\t/**\n\t * Return a URI representing the directory of a URI path.\n\t *\n\t * @param resource The input URI.\n\t * @returns The URI representing the directory of the input URI.\n\t */\n\tdirname(resource: URI): URI;\n\t/**\n\t * Join a URI path with path fragments and normalizes the resulting path.\n\t *\n\t * @param resource The input URI.\n\t * @param pathFragment The path fragment to add to the URI path.\n\t * @returns The resulting URI.\n\t */\n\tjoinPath(resource: URI, ...pathFragment: string[]): URI;\n\t/**\n\t * Normalizes the path part of a URI: Resolves `.` and `..` elements with directory names.\n\t *\n\t * @param resource The URI to normalize the path.\n\t * @returns The URI with the normalized path.\n\t */\n\tnormalizePath(resource: URI): URI;\n\t/**\n\t *\n\t * @param from\n\t * @param to\n\t */\n\trelativePath(from: URI, to: URI): string | undefined;\n\t/**\n\t * Resolves an absolute or relative path against a base URI.\n\t * The path can be relative or absolute posix or a Windows path\n\t */\n\tresolvePath(base: URI, path: string): URI;\n\n\t// --- misc\n\n\t/**\n\t * Returns true if the URI path is absolute.\n\t */\n\tisAbsolutePath(resource: URI): boolean;\n\t/**\n\t * Tests whether the two authorities are the same\n\t */\n\tisEqualAuthority(a1: string, a2: string): boolean;\n\t/**\n\t * Returns true if the URI path has a trailing path separator\n\t */\n\thasTrailingPathSeparator(resource: URI, sep?: string): boolean;\n\t/**\n\t * Removes a trailing path separator, if there's one.\n\t * Important: Doesn't remove the first slash, it would make the URI invalid\n\t */\n\tremoveTrailingPathSeparator(resource: URI, sep?: string): URI;\n\t/**\n\t * Adds a trailing path separator to the URI if there isn't one already.\n\t * For example, c:\\ would be unchanged, but c:\\users would become c:\\users\\\n\t */\n\taddTrailingPathSeparator(resource: URI, sep?: string): URI;\n}\n\nexport class ExtUri implements IExtUri {\n\n\tconstructor(private _ignorePathCasing: (uri: URI) => boolean) { }\n\n\tcompare(uri1: URI, uri2: URI, ignoreFragment: boolean = false): number {\n\t\tif (uri1 === uri2) {\n\t\t\treturn 0;\n\t\t}\n\t\treturn strCompare(this.getComparisonKey(uri1, ignoreFragment), this.getComparisonKey(uri2, ignoreFragment));\n\t}\n\n\tisEqual(uri1: URI | undefined, uri2: URI | undefined, ignoreFragment: boolean = false): boolean {\n\t\tif (uri1 === uri2) {\n\t\t\treturn true;\n\t\t}\n\t\tif (!uri1 || !uri2) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.getComparisonKey(uri1, ignoreFragment) === this.getComparisonKey(uri2, ignoreFragment);\n\t}\n\n\tgetComparisonKey(uri: URI, ignoreFragment: boolean = false): string {\n\t\treturn uri.with({\n\t\t\tpath: this._ignorePathCasing(uri) ? uri.path.toLowerCase() : undefined,\n\t\t\tfragment: ignoreFragment ? null : undefined\n\t\t}).toString();\n\t}\n\n\tignorePathCasing(uri: URI): boolean {\n\t\treturn this._ignorePathCasing(uri);\n\t}\n\n\tisEqualOrParent(base: URI, parentCandidate: URI, ignoreFragment: boolean = false): boolean {\n\t\tif (base.scheme === parentCandidate.scheme) {\n\t\t\tif (base.scheme === Schemas.file) {\n\t\t\t\treturn extpath.isEqualOrParent(originalFSPath(base), originalFSPath(parentCandidate), this._ignorePathCasing(base)) && base.query === parentCandidate.query && (ignoreFragment || base.fragment === parentCandidate.fragment);\n\t\t\t}\n\t\t\tif (isEqualAuthority(base.authority, parentCandidate.authority)) {\n\t\t\t\treturn extpath.isEqualOrParent(base.path, parentCandidate.path, this._ignorePathCasing(base), '/') && base.query === parentCandidate.query && (ignoreFragment || base.fragment === parentCandidate.fragment);\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t// --- path math\n\n\tjoinPath(resource: URI, ...pathFragment: string[]): URI {\n\t\treturn URI.joinPath(resource, ...pathFragment);\n\t}\n\n\tbasenameOrAuthority(resource: URI): string {\n\t\treturn basename(resource) || resource.authority;\n\t}\n\n\tbasename(resource: URI): string {\n\t\treturn paths.posix.basename(resource.path);\n\t}\n\n\textname(resource: URI): string {\n\t\treturn paths.posix.extname(resource.path);\n\t}\n\n\tdirname(resource: URI): URI {\n\t\tif (resource.path.length === 0) {\n\t\t\treturn resource;\n\t\t}\n\t\tlet dirname;\n\t\tif (resource.scheme === Schemas.file) {\n\t\t\tdirname = URI.file(paths.dirname(originalFSPath(resource))).path;\n\t\t} else {\n\t\t\tdirname = paths.posix.dirname(resource.path);\n\t\t\tif (resource.authority && dirname.length && dirname.charCodeAt(0) !== CharCode.Slash) {\n\t\t\t\tconsole.error(`dirname(\"${resource.toString})) resulted in a relative path`);\n\t\t\t\tdirname = '/'; // If a URI contains an authority component, then the path component must either be empty or begin with a CharCode.Slash (\"/\") character\n\t\t\t}\n\t\t}\n\t\treturn resource.with({\n\t\t\tpath: dirname\n\t\t});\n\t}\n\n\tnormalizePath(resource: URI): URI {\n\t\tif (!resource.path.length) {\n\t\t\treturn resource;\n\t\t}\n\t\tlet normalizedPath: string;\n\t\tif (resource.scheme === Schemas.file) {\n\t\t\tnormalizedPath = URI.file(paths.normalize(originalFSPath(resource))).path;\n\t\t} else {\n\t\t\tnormalizedPath = paths.posix.normalize(resource.path);\n\t\t}\n\t\treturn resource.with({\n\t\t\tpath: normalizedPath\n\t\t});\n\t}\n\n\trelativePath(from: URI, to: URI): string | undefined {\n\t\tif (from.scheme !== to.scheme || !isEqualAuthority(from.authority, to.authority)) {\n\t\t\treturn undefined;\n\t\t}\n\t\tif (from.scheme === Schemas.file) {\n\t\t\tconst relativePath = paths.relative(originalFSPath(from), originalFSPath(to));\n\t\t\treturn isWindows ? extpath.toSlashes(relativePath) : relativePath;\n\t\t}\n\t\tlet fromPath = from.path || '/';\n\t\tconst toPath = to.path || '/';\n\t\tif (this._ignorePathCasing(from)) {\n\t\t\t// make casing of fromPath match toPath\n\t\t\tlet i = 0;\n\t\t\tfor (const len = Math.min(fromPath.length, toPath.length); i < len; i++) {\n\t\t\t\tif (fromPath.charCodeAt(i) !== toPath.charCodeAt(i)) {\n\t\t\t\t\tif (fromPath.charAt(i).toLowerCase() !== toPath.charAt(i).toLowerCase()) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tfromPath = toPath.substr(0, i) + fromPath.substr(i);\n\t\t}\n\t\treturn paths.posix.relative(fromPath, toPath);\n\t}\n\n\tresolvePath(base: URI, path: string): URI {\n\t\tif (base.scheme === Schemas.file) {\n\t\t\tconst newURI = URI.file(paths.resolve(originalFSPath(base), path));\n\t\t\treturn base.with({\n\t\t\t\tauthority: newURI.authority,\n\t\t\t\tpath: newURI.path\n\t\t\t});\n\t\t}\n\t\tpath = extpath.toPosixPath(path); // we allow path to be a windows path\n\t\treturn base.with({\n\t\t\tpath: paths.posix.resolve(base.path, path)\n\t\t});\n\t}\n\n\t// --- misc\n\n\tisAbsolutePath(resource: URI): boolean {\n\t\treturn !!resource.path && resource.path[0] === '/';\n\t}\n\n\tisEqualAuthority(a1: string | undefined, a2: string | undefined) {\n\t\treturn a1 === a2 || (a1 !== undefined && a2 !== undefined && equalsIgnoreCase(a1, a2));\n\t}\n\n\thasTrailingPathSeparator(resource: URI, sep: string = paths.sep): boolean {\n\t\tif (resource.scheme === Schemas.file) {\n\t\t\tconst fsp = originalFSPath(resource);\n\t\t\treturn fsp.length > extpath.getRoot(fsp).length && fsp[fsp.length - 1] === sep;\n\t\t} else {\n\t\t\tconst p = resource.path;\n\t\t\treturn (p.length > 1 && p.charCodeAt(p.length - 1) === CharCode.Slash) && !(/^[a-zA-Z]:(\\/$|\\\\$)/.test(resource.fsPath)); // ignore the slash at offset 0\n\t\t}\n\t}\n\n\tremoveTrailingPathSeparator(resource: URI, sep: string = paths.sep): URI {\n\t\t// Make sure that the path isn't a drive letter. A trailing separator there is not removable.\n\t\tif (hasTrailingPathSeparator(resource, sep)) {\n\t\t\treturn resource.with({ path: resource.path.substr(0, resource.path.length - 1) });\n\t\t}\n\t\treturn resource;\n\t}\n\n\taddTrailingPathSeparator(resource: URI, sep: string = paths.sep): URI {\n\t\tlet isRootSep: boolean = false;\n\t\tif (resource.scheme === Schemas.file) {\n\t\t\tconst fsp = originalFSPath(resource);\n\t\t\tisRootSep = ((fsp !== undefined) && (fsp.length === extpath.getRoot(fsp).length) && (fsp[fsp.length - 1] === sep));\n\t\t} else {\n\t\t\tsep = '/';\n\t\t\tconst p = resource.path;\n\t\t\tisRootSep = p.length === 1 && p.charCodeAt(p.length - 1) === CharCode.Slash;\n\t\t}\n\t\tif (!isRootSep && !hasTrailingPathSeparator(resource, sep)) {\n\t\t\treturn resource.with({ path: resource.path + '/' });\n\t\t}\n\t\treturn resource;\n\t}\n}\n\n\n/**\n * Unbiased utility that takes uris \"as they are\". This means it can be interchanged with\n * uri#toString() usages. The following is true\n * ```\n * assertEqual(aUri.toString() === bUri.toString(), exturi.isEqual(aUri, bUri))\n * ```\n */\nexport const extUri = new ExtUri(() => false);\n\n/**\n * BIASED utility that _mostly_ ignored the case of urs paths. ONLY use this util if you\n * understand what you are doing.\n *\n * This utility is INCOMPATIBLE with `uri.toString()`-usages and both CANNOT be used interchanged.\n *\n * When dealing with uris from files or documents, `extUri` (the unbiased friend)is sufficient\n * because those uris come from a \"trustworthy source\". When creating unknown uris it's always\n * better to use `IUriIdentityService` which exposes an `IExtUri`-instance which knows when path\n * casing matters.\n */\nexport const extUriBiasedIgnorePathCase = new ExtUri(uri => {\n\t// A file scheme resource is in the same platform as code, so ignore case for non linux platforms\n\t// Resource can be from another platform. Lowering the case as an hack. Should come from File system provider\n\treturn uri.scheme === Schemas.file ? !isLinux : true;\n});\n\n\n/**\n * BIASED utility that always ignores the casing of uris paths. ONLY use this util if you\n * understand what you are doing.\n *\n * This utility is INCOMPATIBLE with `uri.toString()`-usages and both CANNOT be used interchanged.\n *\n * When dealing with uris from files or documents, `extUri` (the unbiased friend)is sufficient\n * because those uris come from a \"trustworthy source\". When creating unknown uris it's always\n * better to use `IUriIdentityService` which exposes an `IExtUri`-instance which knows when path\n * casing matters.\n */\nexport const extUriIgnorePathCase = new ExtUri(_ => true);\n\nexport const isEqual = extUri.isEqual.bind(extUri);\nexport const isEqualOrParent = extUri.isEqualOrParent.bind(extUri);\nexport const getComparisonKey = extUri.getComparisonKey.bind(extUri);\nexport const basenameOrAuthority = extUri.basenameOrAuthority.bind(extUri);\nexport const basename = extUri.basename.bind(extUri);\nexport const extname = extUri.extname.bind(extUri);\nexport const dirname = extUri.dirname.bind(extUri);\nexport const joinPath = extUri.joinPath.bind(extUri);\nexport const normalizePath = extUri.normalizePath.bind(extUri);\nexport const relativePath = extUri.relativePath.bind(extUri);\nexport const resolvePath = extUri.resolvePath.bind(extUri);\nexport const isAbsolutePath = extUri.isAbsolutePath.bind(extUri);\nexport const isEqualAuthority = extUri.isEqualAuthority.bind(extUri);\nexport const hasTrailingPathSeparator = extUri.hasTrailingPathSeparator.bind(extUri);\nexport const removeTrailingPathSeparator = extUri.removeTrailingPathSeparator.bind(extUri);\nexport const addTrailingPathSeparator = extUri.addTrailingPathSeparator.bind(extUri);\n\n//#endregion\n\nexport function distinctParents<T>(items: T[], resourceAccessor: (item: T) => URI): T[] {\n\tconst distinctParents: T[] = [];\n\tfor (let i = 0; i < items.length; i++) {\n\t\tconst candidateResource = resourceAccessor(items[i]);\n\t\tif (items.some((otherItem, index) => {\n\t\t\tif (index === i) {\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn isEqualOrParent(candidateResource, resourceAccessor(otherItem));\n\t\t})) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tdistinctParents.push(items[i]);\n\t}\n\n\treturn distinctParents;\n}\n\n/**\n * Data URI related helpers.\n */\nexport namespace DataUri {\n\n\texport const META_DATA_LABEL = 'label';\n\texport const META_DATA_DESCRIPTION = 'description';\n\texport const META_DATA_SIZE = 'size';\n\texport const META_DATA_MIME = 'mime';\n\n\texport function parseMetaData(dataUri: URI): Map<string, string> {\n\t\tconst metadata = new Map<string, string>();\n\n\t\t// Given a URI of:  data:image/png;size:2313;label:SomeLabel;description:SomeDescription;base64,77+9UE5...\n\t\t// the metadata is: size:2313;label:SomeLabel;description:SomeDescription\n\t\tconst meta = dataUri.path.substring(dataUri.path.indexOf(';') + 1, dataUri.path.lastIndexOf(';'));\n\t\tmeta.split(';').forEach(property => {\n\t\t\tconst [key, value] = property.split(':');\n\t\t\tif (key && value) {\n\t\t\t\tmetadata.set(key, value);\n\t\t\t}\n\t\t});\n\n\t\t// Given a URI of:  data:image/png;size:2313;label:SomeLabel;description:SomeDescription;base64,77+9UE5...\n\t\t// the mime is: image/png\n\t\tconst mime = dataUri.path.substring(0, dataUri.path.indexOf(';'));\n\t\tif (mime) {\n\t\t\tmetadata.set(META_DATA_MIME, mime);\n\t\t}\n\n\t\treturn metadata;\n\t}\n}\n\nexport function toLocalResource(resource: URI, authority: string | undefined, localScheme: string): URI {\n\tif (authority) {\n\t\tlet path = resource.path;\n\t\tif (path && path[0] !== paths.posix.sep) {\n\t\t\tpath = paths.posix.sep + path;\n\t\t}\n\n\t\treturn resource.with({ scheme: localScheme, authority, path });\n\t}\n\n\treturn resource.with({ scheme: localScheme });\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n/**\n * Can be passed into the Delayed to defer using a microtask\n * */\nexport const MicrotaskDelay = Symbol('MicrotaskDelay');\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CancellationToken, CancellationTokenSource } from './cancellation.js';\nimport { BugIndicatingError, CancellationError } from './errors.js';\nimport { Emitter, Event } from './event.js';\nimport { Disposable, DisposableMap, DisposableStore, IDisposable, isDisposable, MutableDisposable, toDisposable } from './lifecycle.js';\nimport { extUri as defaultExtUri, IExtUri } from './resources.js';\nimport { URI } from './uri.js';\nimport { setTimeout0 } from './platform.js';\nimport { MicrotaskDelay } from './symbols.js';\nimport { Lazy } from './lazy.js';\n\nexport function isThenable<T>(obj: unknown): obj is Promise<T> {\n\treturn !!obj && typeof (obj as unknown as Promise<T>).then === 'function';\n}\n\nexport interface CancelablePromise<T> extends Promise<T> {\n\tcancel(): void;\n}\n\n/**\n * Returns a promise that can be cancelled using the provided cancellation token.\n *\n * @remarks When cancellation is requested, the promise will be rejected with a {@link CancellationError}.\n * If the promise resolves to a disposable object, it will be automatically disposed when cancellation\n * is requested.\n *\n * @param callback A function that accepts a cancellation token and returns a promise\n * @returns A promise that can be cancelled\n */\nexport function createCancelablePromise<T>(callback: (token: CancellationToken) => Promise<T>): CancelablePromise<T> {\n\tconst source = new CancellationTokenSource();\n\n\tconst thenable = callback(source.token);\n\n\tlet isCancelled = false;\n\n\tconst promise = new Promise<T>((resolve, reject) => {\n\t\tconst subscription = source.token.onCancellationRequested(() => {\n\t\t\tisCancelled = true;\n\t\t\tsubscription.dispose();\n\t\t\treject(new CancellationError());\n\t\t});\n\t\tPromise.resolve(thenable).then(value => {\n\t\t\tsubscription.dispose();\n\t\t\tsource.dispose();\n\n\t\t\tif (!isCancelled) {\n\t\t\t\tresolve(value);\n\n\t\t\t} else if (isDisposable(value)) {\n\t\t\t\t// promise has been cancelled, result is disposable and will\n\t\t\t\t// be cleaned up\n\t\t\t\tvalue.dispose();\n\t\t\t}\n\t\t}, err => {\n\t\t\tsubscription.dispose();\n\t\t\tsource.dispose();\n\t\t\treject(err);\n\t\t});\n\t});\n\n\treturn <CancelablePromise<T>>new class {\n\t\tcancel() {\n\t\t\tsource.cancel();\n\t\t\tsource.dispose();\n\t\t}\n\t\tthen<TResult1 = T, TResult2 = never>(resolve?: ((value: T) => TResult1 | Promise<TResult1>) | undefined | null, reject?: ((reason: unknown) => TResult2 | Promise<TResult2>) | undefined | null): Promise<TResult1 | TResult2> {\n\t\t\treturn promise.then(resolve, reject);\n\t\t}\n\t\tcatch<TResult = never>(reject?: ((reason: unknown) => TResult | Promise<TResult>) | undefined | null): Promise<T | TResult> {\n\t\t\treturn this.then(undefined, reject);\n\t\t}\n\t\tfinally(onfinally?: (() => void) | undefined | null): Promise<T> {\n\t\t\treturn promise.finally(onfinally);\n\t\t}\n\t};\n}\n\n/**\n * Returns a promise that resolves with `undefined` as soon as the passed token is cancelled.\n * @see {@link raceCancellationError}\n */\nexport function raceCancellation<T>(promise: Promise<T>, token: CancellationToken): Promise<T | undefined>;\n\n/**\n * Returns a promise that resolves with `defaultValue` as soon as the passed token is cancelled.\n * @see {@link raceCancellationError}\n */\nexport function raceCancellation<T>(promise: Promise<T>, token: CancellationToken, defaultValue: T): Promise<T>;\n\nexport function raceCancellation<T>(promise: Promise<T>, token: CancellationToken, defaultValue?: T): Promise<T | undefined> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst ref = token.onCancellationRequested(() => {\n\t\t\tref.dispose();\n\t\t\tresolve(defaultValue);\n\t\t});\n\t\tpromise.then(resolve, reject).finally(() => ref.dispose());\n\t});\n}\n\n/**\n * Returns a promise that rejects with an {@CancellationError} as soon as the passed token is cancelled.\n * @see {@link raceCancellation}\n */\nexport function raceCancellationError<T>(promise: Promise<T>, token: CancellationToken): Promise<T> {\n\treturn new Promise((resolve, reject) => {\n\t\tconst ref = token.onCancellationRequested(() => {\n\t\t\tref.dispose();\n\t\t\treject(new CancellationError());\n\t\t});\n\t\tpromise.then(resolve, reject).finally(() => ref.dispose());\n\t});\n}\n\n/**\n * Wraps a cancellable promise such that it is no cancellable. Can be used to\n * avoid issues with shared promises that would normally be returned as\n * cancellable to consumers.\n */\nexport function notCancellablePromise<T>(promise: CancelablePromise<T>): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tpromise.then(resolve, reject);\n\t});\n}\n\n/**\n * Returns as soon as one of the promises resolves or rejects and cancels remaining promises\n */\nexport function raceCancellablePromises<T>(cancellablePromises: (CancelablePromise<T> | Promise<T>)[]): CancelablePromise<T> {\n\tlet resolvedPromiseIndex = -1;\n\tconst promises = cancellablePromises.map((promise, index) => promise.then(result => { resolvedPromiseIndex = index; return result; }));\n\tconst promise = Promise.race(promises) as CancelablePromise<T>;\n\tpromise.cancel = () => {\n\t\tcancellablePromises.forEach((cancellablePromise, index) => {\n\t\t\tif (index !== resolvedPromiseIndex && (cancellablePromise as CancelablePromise<T>).cancel) {\n\t\t\t\t(cancellablePromise as CancelablePromise<T>).cancel();\n\t\t\t}\n\t\t});\n\t};\n\tpromise.finally(() => {\n\t\tpromise.cancel();\n\t});\n\treturn promise;\n}\n\nexport function raceTimeout<T>(promise: Promise<T>, timeout: number, onTimeout?: () => void): Promise<T | undefined> {\n\tlet promiseResolve: ((value: T | undefined) => void) | undefined = undefined;\n\n\tconst timer = setTimeout(() => {\n\t\tpromiseResolve?.(undefined);\n\t\tonTimeout?.();\n\t}, timeout);\n\n\treturn Promise.race([\n\t\tpromise.finally(() => clearTimeout(timer)),\n\t\tnew Promise<T | undefined>(resolve => promiseResolve = resolve)\n\t]);\n}\n\nexport function asPromise<T>(callback: () => T | Thenable<T>): Promise<T> {\n\treturn new Promise<T>((resolve, reject) => {\n\t\tconst item = callback();\n\t\tif (isThenable<T>(item)) {\n\t\t\titem.then(resolve, reject);\n\t\t} else {\n\t\t\tresolve(item);\n\t\t}\n\t});\n}\n\n/**\n * Creates and returns a new promise, plus its `resolve` and `reject` callbacks.\n *\n * Replace with standardized [`Promise.withResolvers`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise/withResolvers) once it is supported\n */\nexport function promiseWithResolvers<T>(): { promise: Promise<T>; resolve: (value: T | PromiseLike<T>) => void; reject: (err?: any) => void } {\n\tlet resolve: (value: T | PromiseLike<T>) => void;\n\tlet reject: (reason?: any) => void;\n\tconst promise = new Promise<T>((res, rej) => {\n\t\tresolve = res;\n\t\treject = rej;\n\t});\n\treturn { promise, resolve: resolve!, reject: reject! };\n}\n\nexport interface ITask<T> {\n\t(): T;\n}\n\nexport interface ICancellableTask<T> {\n\t(token: CancellationToken): T;\n}\n\n/**\n * A helper to prevent accumulation of sequential async tasks.\n *\n * Imagine a mail man with the sole task of delivering letters. As soon as\n * a letter submitted for delivery, he drives to the destination, delivers it\n * and returns to his base. Imagine that during the trip, N more letters were submitted.\n * When the mail man returns, he picks those N letters and delivers them all in a\n * single trip. Even though N+1 submissions occurred, only 2 deliveries were made.\n *\n * The throttler implements this via the queue() method, by providing it a task\n * factory. Following the example:\n *\n * \t\tconst throttler = new Throttler();\n * \t\tconst letters = [];\n *\n * \t\tfunction deliver() {\n * \t\t\tconst lettersToDeliver = letters;\n * \t\t\tletters = [];\n * \t\t\treturn makeTheTrip(lettersToDeliver);\n * \t\t}\n *\n * \t\tfunction onLetterReceived(l) {\n * \t\t\tletters.push(l);\n * \t\t\tthrottler.queue(deliver);\n * \t\t}\n */\nexport class Throttler implements IDisposable {\n\n\tprivate activePromise: Promise<any> | null;\n\tprivate queuedPromise: Promise<any> | null;\n\tprivate queuedPromiseFactory: ICancellableTask<Promise<any>> | null;\n\tprivate cancellationTokenSource: CancellationTokenSource;\n\n\tconstructor() {\n\t\tthis.activePromise = null;\n\t\tthis.queuedPromise = null;\n\t\tthis.queuedPromiseFactory = null;\n\n\t\tthis.cancellationTokenSource = new CancellationTokenSource();\n\t}\n\n\tqueue<T>(promiseFactory: ICancellableTask<Promise<T>>): Promise<T> {\n\t\tif (this.cancellationTokenSource.token.isCancellationRequested) {\n\t\t\treturn Promise.reject(new Error('Throttler is disposed'));\n\t\t}\n\n\t\tif (this.activePromise) {\n\t\t\tthis.queuedPromiseFactory = promiseFactory;\n\n\t\t\tif (!this.queuedPromise) {\n\t\t\t\tconst onComplete = () => {\n\t\t\t\t\tthis.queuedPromise = null;\n\n\t\t\t\t\tif (this.cancellationTokenSource.token.isCancellationRequested) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tconst result = this.queue(this.queuedPromiseFactory!);\n\t\t\t\t\tthis.queuedPromiseFactory = null;\n\n\t\t\t\t\treturn result;\n\t\t\t\t};\n\n\t\t\t\tthis.queuedPromise = new Promise(resolve => {\n\t\t\t\t\tthis.activePromise!.then(onComplete, onComplete).then(resolve);\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn new Promise((resolve, reject) => {\n\t\t\t\tthis.queuedPromise!.then(resolve, reject);\n\t\t\t});\n\t\t}\n\n\t\tthis.activePromise = promiseFactory(this.cancellationTokenSource.token);\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tthis.activePromise!.then((result: T) => {\n\t\t\t\tthis.activePromise = null;\n\t\t\t\tresolve(result);\n\t\t\t}, (err: unknown) => {\n\t\t\t\tthis.activePromise = null;\n\t\t\t\treject(err);\n\t\t\t});\n\t\t});\n\t}\n\n\tdispose(): void {\n\t\tthis.cancellationTokenSource.cancel();\n\t}\n}\n\nexport class Sequencer {\n\n\tprivate current: Promise<unknown> = Promise.resolve(null);\n\n\tqueue<T>(promiseTask: ITask<Promise<T>>): Promise<T> {\n\t\treturn this.current = this.current.then(() => promiseTask(), () => promiseTask());\n\t}\n}\n\nexport class SequencerByKey<TKey> {\n\n\tprivate promiseMap = new Map<TKey, Promise<unknown>>();\n\n\tqueue<T>(key: TKey, promiseTask: ITask<Promise<T>>): Promise<T> {\n\t\tconst runningPromise = this.promiseMap.get(key) ?? Promise.resolve();\n\t\tconst newPromise = runningPromise\n\t\t\t.catch(() => { })\n\t\t\t.then(promiseTask)\n\t\t\t.finally(() => {\n\t\t\t\tif (this.promiseMap.get(key) === newPromise) {\n\t\t\t\t\tthis.promiseMap.delete(key);\n\t\t\t\t}\n\t\t\t});\n\t\tthis.promiseMap.set(key, newPromise);\n\t\treturn newPromise;\n\t}\n\n\tpeek(key: TKey): Promise<unknown> | undefined {\n\t\treturn this.promiseMap.get(key) || undefined;\n\t}\n\n\tkeys(): IterableIterator<TKey> {\n\t\treturn this.promiseMap.keys();\n\t}\n}\n\ninterface IScheduledLater extends IDisposable {\n\tisTriggered(): boolean;\n}\n\nconst timeoutDeferred = (timeout: number, fn: () => void): IScheduledLater => {\n\tlet scheduled = true;\n\tconst handle = setTimeout(() => {\n\t\tscheduled = false;\n\t\tfn();\n\t}, timeout);\n\treturn {\n\t\tisTriggered: () => scheduled,\n\t\tdispose: () => {\n\t\t\tclearTimeout(handle);\n\t\t\tscheduled = false;\n\t\t},\n\t};\n};\n\nconst microtaskDeferred = (fn: () => void): IScheduledLater => {\n\tlet scheduled = true;\n\tqueueMicrotask(() => {\n\t\tif (scheduled) {\n\t\t\tscheduled = false;\n\t\t\tfn();\n\t\t}\n\t});\n\n\treturn {\n\t\tisTriggered: () => scheduled,\n\t\tdispose: () => { scheduled = false; },\n\t};\n};\n\n/**\n * A helper to delay (debounce) execution of a task that is being requested often.\n *\n * Following the throttler, now imagine the mail man wants to optimize the number of\n * trips proactively. The trip itself can be long, so he decides not to make the trip\n * as soon as a letter is submitted. Instead he waits a while, in case more\n * letters are submitted. After said waiting period, if no letters were submitted, he\n * decides to make the trip. Imagine that N more letters were submitted after the first\n * one, all within a short period of time between each other. Even though N+1\n * submissions occurred, only 1 delivery was made.\n *\n * The delayer offers this behavior via the trigger() method, into which both the task\n * to be executed and the waiting period (delay) must be passed in as arguments. Following\n * the example:\n *\n * \t\tconst delayer = new Delayer(WAITING_PERIOD);\n * \t\tconst letters = [];\n *\n * \t\tfunction letterReceived(l) {\n * \t\t\tletters.push(l);\n * \t\t\tdelayer.trigger(() => { return makeTheTrip(); });\n * \t\t}\n */\nexport class Delayer<T> implements IDisposable {\n\n\tprivate deferred: IScheduledLater | null;\n\tprivate completionPromise: Promise<any> | null;\n\tprivate doResolve: ((value?: any | Promise<any>) => void) | null;\n\tprivate doReject: ((err: unknown) => void) | null;\n\tprivate task: ITask<T | Promise<T>> | null;\n\n\tconstructor(public defaultDelay: number | typeof MicrotaskDelay) {\n\t\tthis.deferred = null;\n\t\tthis.completionPromise = null;\n\t\tthis.doResolve = null;\n\t\tthis.doReject = null;\n\t\tthis.task = null;\n\t}\n\n\ttrigger(task: ITask<T | Promise<T>>, delay = this.defaultDelay): Promise<T> {\n\t\tthis.task = task;\n\t\tthis.cancelTimeout();\n\n\t\tif (!this.completionPromise) {\n\t\t\tthis.completionPromise = new Promise((resolve, reject) => {\n\t\t\t\tthis.doResolve = resolve;\n\t\t\t\tthis.doReject = reject;\n\t\t\t}).then(() => {\n\t\t\t\tthis.completionPromise = null;\n\t\t\t\tthis.doResolve = null;\n\t\t\t\tif (this.task) {\n\t\t\t\t\tconst task = this.task;\n\t\t\t\t\tthis.task = null;\n\t\t\t\t\treturn task();\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t\t});\n\t\t}\n\n\t\tconst fn = () => {\n\t\t\tthis.deferred = null;\n\t\t\tthis.doResolve?.(null);\n\t\t};\n\n\t\tthis.deferred = delay === MicrotaskDelay ? microtaskDeferred(fn) : timeoutDeferred(delay, fn);\n\n\t\treturn this.completionPromise;\n\t}\n\n\tisTriggered(): boolean {\n\t\treturn !!this.deferred?.isTriggered();\n\t}\n\n\tcancel(): void {\n\t\tthis.cancelTimeout();\n\n\t\tif (this.completionPromise) {\n\t\t\tthis.doReject?.(new CancellationError());\n\t\t\tthis.completionPromise = null;\n\t\t}\n\t}\n\n\tprivate cancelTimeout(): void {\n\t\tthis.deferred?.dispose();\n\t\tthis.deferred = null;\n\t}\n\n\tdispose(): void {\n\t\tthis.cancel();\n\t}\n}\n\n/**\n * A helper to delay execution of a task that is being requested often, while\n * preventing accumulation of consecutive executions, while the task runs.\n *\n * The mail man is clever and waits for a certain amount of time, before going\n * out to deliver letters. While the mail man is going out, more letters arrive\n * and can only be delivered once he is back. Once he is back the mail man will\n * do one more trip to deliver the letters that have accumulated while he was out.\n */\nexport class ThrottledDelayer<T> {\n\n\tprivate delayer: Delayer<Promise<T>>;\n\tprivate throttler: Throttler;\n\n\tconstructor(defaultDelay: number) {\n\t\tthis.delayer = new Delayer(defaultDelay);\n\t\tthis.throttler = new Throttler();\n\t}\n\n\ttrigger(promiseFactory: ICancellableTask<Promise<T>>, delay?: number): Promise<T> {\n\t\treturn this.delayer.trigger(() => this.throttler.queue(promiseFactory), delay) as unknown as Promise<T>;\n\t}\n\n\tisTriggered(): boolean {\n\t\treturn this.delayer.isTriggered();\n\t}\n\n\tcancel(): void {\n\t\tthis.delayer.cancel();\n\t}\n\n\tdispose(): void {\n\t\tthis.delayer.dispose();\n\t\tthis.throttler.dispose();\n\t}\n}\n\n/**\n * A barrier that is initially closed and then becomes opened permanently.\n */\nexport class Barrier {\n\tprivate _isOpen: boolean;\n\tprivate _promise: Promise<boolean>;\n\tprivate _completePromise!: (v: boolean) => void;\n\n\tconstructor() {\n\t\tthis._isOpen = false;\n\t\tthis._promise = new Promise<boolean>((c, e) => {\n\t\t\tthis._completePromise = c;\n\t\t});\n\t}\n\n\tisOpen(): boolean {\n\t\treturn this._isOpen;\n\t}\n\n\topen(): void {\n\t\tthis._isOpen = true;\n\t\tthis._completePromise(true);\n\t}\n\n\twait(): Promise<boolean> {\n\t\treturn this._promise;\n\t}\n}\n\n/**\n * A barrier that is initially closed and then becomes opened permanently after a certain period of\n * time or when open is called explicitly\n */\nexport class AutoOpenBarrier extends Barrier {\n\n\tprivate readonly _timeout: Timeout;\n\n\tconstructor(autoOpenTimeMs: number) {\n\t\tsuper();\n\t\tthis._timeout = setTimeout(() => this.open(), autoOpenTimeMs);\n\t}\n\n\toverride open(): void {\n\t\tclearTimeout(this._timeout);\n\t\tsuper.open();\n\t}\n}\n\nexport function timeout(millis: number): CancelablePromise<void>;\nexport function timeout(millis: number, token: CancellationToken): Promise<void>;\nexport function timeout(millis: number, token?: CancellationToken): CancelablePromise<void> | Promise<void> {\n\tif (!token) {\n\t\treturn createCancelablePromise(token => timeout(millis, token));\n\t}\n\n\treturn new Promise((resolve, reject) => {\n\t\tconst handle = setTimeout(() => {\n\t\t\tdisposable.dispose();\n\t\t\tresolve();\n\t\t}, millis);\n\t\tconst disposable = token.onCancellationRequested(() => {\n\t\t\tclearTimeout(handle);\n\t\t\tdisposable.dispose();\n\t\t\treject(new CancellationError());\n\t\t});\n\t});\n}\n\n/**\n * Creates a timeout that can be disposed using its returned value.\n * @param handler The timeout handler.\n * @param timeout An optional timeout in milliseconds.\n * @param store An optional {@link DisposableStore} that will have the timeout disposable managed automatically.\n *\n * @example\n * const store = new DisposableStore;\n * // Call the timeout after 1000ms at which point it will be automatically\n * // evicted from the store.\n * const timeoutDisposable = disposableTimeout(() => {}, 1000, store);\n *\n * if (foo) {\n *   // Cancel the timeout and evict it from store.\n *   timeoutDisposable.dispose();\n * }\n */\nexport function disposableTimeout(handler: () => void, timeout = 0, store?: DisposableStore): IDisposable {\n\tconst timer = setTimeout(() => {\n\t\thandler();\n\t\tif (store) {\n\t\t\tdisposable.dispose();\n\t\t}\n\t}, timeout);\n\tconst disposable = toDisposable(() => {\n\t\tclearTimeout(timer);\n\t\tstore?.delete(disposable);\n\t});\n\tstore?.add(disposable);\n\treturn disposable;\n}\n\n/**\n * Runs the provided list of promise factories in sequential order. The returned\n * promise will complete to an array of results from each promise.\n */\n\nexport function sequence<T>(promiseFactories: ITask<Promise<T>>[]): Promise<T[]> {\n\tconst results: T[] = [];\n\tlet index = 0;\n\tconst len = promiseFactories.length;\n\n\tfunction next(): Promise<T> | null {\n\t\treturn index < len ? promiseFactories[index++]() : null;\n\t}\n\n\tfunction thenHandler(result: unknown): Promise<any> {\n\t\tif (result !== undefined && result !== null) {\n\t\t\tresults.push(result as T);\n\t\t}\n\n\t\tconst n = next();\n\t\tif (n) {\n\t\t\treturn n.then(thenHandler);\n\t\t}\n\n\t\treturn Promise.resolve(results);\n\t}\n\n\treturn Promise.resolve(null).then(thenHandler);\n}\n\nexport function first<T>(promiseFactories: ITask<Promise<T>>[], shouldStop: (t: T) => boolean = t => !!t, defaultValue: T | null = null): Promise<T | null> {\n\tlet index = 0;\n\tconst len = promiseFactories.length;\n\n\tconst loop: () => Promise<T | null> = () => {\n\t\tif (index >= len) {\n\t\t\treturn Promise.resolve(defaultValue);\n\t\t}\n\n\t\tconst factory = promiseFactories[index++];\n\t\tconst promise = Promise.resolve(factory());\n\n\t\treturn promise.then(result => {\n\t\t\tif (shouldStop(result)) {\n\t\t\t\treturn Promise.resolve(result);\n\t\t\t}\n\n\t\t\treturn loop();\n\t\t});\n\t};\n\n\treturn loop();\n}\n\n/**\n * Returns the result of the first promise that matches the \"shouldStop\",\n * running all promises in parallel. Supports cancelable promises.\n */\nexport function firstParallel<T>(promiseList: Promise<T>[], shouldStop?: (t: T) => boolean, defaultValue?: T | null): Promise<T | null>;\nexport function firstParallel<T, R extends T>(promiseList: Promise<T>[], shouldStop: (t: T) => t is R, defaultValue?: R | null): Promise<R | null>;\nexport function firstParallel<T>(promiseList: Promise<T>[], shouldStop: (t: T) => boolean = t => !!t, defaultValue: T | null = null) {\n\tif (promiseList.length === 0) {\n\t\treturn Promise.resolve(defaultValue);\n\t}\n\n\tlet todo = promiseList.length;\n\tconst finish = () => {\n\t\ttodo = -1;\n\t\tfor (const promise of promiseList) {\n\t\t\t(promise as Partial<CancelablePromise<T>>).cancel?.();\n\t\t}\n\t};\n\n\treturn new Promise<T | null>((resolve, reject) => {\n\t\tfor (const promise of promiseList) {\n\t\t\tpromise.then(result => {\n\t\t\t\tif (--todo >= 0 && shouldStop(result)) {\n\t\t\t\t\tfinish();\n\t\t\t\t\tresolve(result);\n\t\t\t\t} else if (todo === 0) {\n\t\t\t\t\tresolve(defaultValue);\n\t\t\t\t}\n\t\t\t})\n\t\t\t\t.catch(err => {\n\t\t\t\t\tif (--todo >= 0) {\n\t\t\t\t\t\tfinish();\n\t\t\t\t\t\treject(err);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t}\n\t});\n}\n\ninterface ILimitedTaskFactory<T> {\n\tfactory: ITask<Promise<T>>;\n\tc: (value: T | Promise<T>) => void;\n\te: (error?: unknown) => void;\n}\n\nexport interface ILimiter<T> {\n\n\treadonly size: number;\n\n\tqueue(factory: ITask<Promise<T>>): Promise<T>;\n\n\tclear(): void;\n}\n\n/**\n * A helper to queue N promises and run them all with a max degree of parallelism. The helper\n * ensures that at any time no more than M promises are running at the same time.\n */\nexport class Limiter<T> implements ILimiter<T> {\n\n\tprivate _size = 0;\n\tprivate _isDisposed = false;\n\tprivate runningPromises: number;\n\tprivate readonly maxDegreeOfParalellism: number;\n\tprivate readonly outstandingPromises: ILimitedTaskFactory<T>[];\n\tprivate readonly _onDrained: Emitter<void>;\n\n\tconstructor(maxDegreeOfParalellism: number) {\n\t\tthis.maxDegreeOfParalellism = maxDegreeOfParalellism;\n\t\tthis.outstandingPromises = [];\n\t\tthis.runningPromises = 0;\n\t\tthis._onDrained = new Emitter<void>();\n\t}\n\n\t/**\n\t *\n\t * @returns A promise that resolved when all work is done (onDrained) or when\n\t * there is nothing to do\n\t */\n\twhenIdle(): Promise<void> {\n\t\treturn this.size > 0\n\t\t\t? Event.toPromise(this.onDrained)\n\t\t\t: Promise.resolve();\n\t}\n\n\tget onDrained(): Event<void> {\n\t\treturn this._onDrained.event;\n\t}\n\n\tget size(): number {\n\t\treturn this._size;\n\t}\n\n\tqueue(factory: ITask<Promise<T>>): Promise<T> {\n\t\tif (this._isDisposed) {\n\t\t\tthrow new Error('Object has been disposed');\n\t\t}\n\t\tthis._size++;\n\n\t\treturn new Promise<T>((c, e) => {\n\t\t\tthis.outstandingPromises.push({ factory, c, e });\n\t\t\tthis.consume();\n\t\t});\n\t}\n\n\tprivate consume(): void {\n\t\twhile (this.outstandingPromises.length && this.runningPromises < this.maxDegreeOfParalellism) {\n\t\t\tconst iLimitedTask = this.outstandingPromises.shift()!;\n\t\t\tthis.runningPromises++;\n\n\t\t\tconst promise = iLimitedTask.factory();\n\t\t\tpromise.then(iLimitedTask.c, iLimitedTask.e);\n\t\t\tpromise.then(() => this.consumed(), () => this.consumed());\n\t\t}\n\t}\n\n\tprivate consumed(): void {\n\t\tif (this._isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.runningPromises--;\n\t\tif (--this._size === 0) {\n\t\t\tthis._onDrained.fire();\n\t\t}\n\n\t\tif (this.outstandingPromises.length > 0) {\n\t\t\tthis.consume();\n\t\t}\n\t}\n\n\tclear(): void {\n\t\tif (this._isDisposed) {\n\t\t\tthrow new Error('Object has been disposed');\n\t\t}\n\t\tthis.outstandingPromises.length = 0;\n\t\tthis._size = this.runningPromises;\n\t}\n\n\tdispose(): void {\n\t\tthis._isDisposed = true;\n\t\tthis.outstandingPromises.length = 0; // stop further processing\n\t\tthis._size = 0;\n\t\tthis._onDrained.dispose();\n\t}\n}\n\n/**\n * A queue is handles one promise at a time and guarantees that at any time only one promise is executing.\n */\nexport class Queue<T> extends Limiter<T> {\n\n\tconstructor() {\n\t\tsuper(1);\n\t}\n}\n\n/**\n * Same as `Queue`, ensures that only 1 task is executed at the same time. The difference to `Queue` is that\n * there is only 1 task about to be scheduled next. As such, calling `queue` while a task is executing will\n * replace the currently queued task until it executes.\n *\n * As such, the returned promise may not be from the factory that is passed in but from the next factory that\n * is running after having called `queue`.\n */\nexport class LimitedQueue {\n\n\tprivate readonly sequentializer = new TaskSequentializer();\n\n\tprivate tasks = 0;\n\n\tqueue(factory: ITask<Promise<void>>): Promise<void> {\n\t\tif (!this.sequentializer.isRunning()) {\n\t\t\treturn this.sequentializer.run(this.tasks++, factory());\n\t\t}\n\n\t\treturn this.sequentializer.queue(() => {\n\t\t\treturn this.sequentializer.run(this.tasks++, factory());\n\t\t});\n\t}\n}\n\n/**\n * A helper to organize queues per resource. The ResourceQueue makes sure to manage queues per resource\n * by disposing them once the queue is empty.\n */\nexport class ResourceQueue implements IDisposable {\n\n\tprivate readonly queues = new Map<string, Queue<void>>();\n\n\tprivate readonly drainers = new Set<DeferredPromise<void>>();\n\n\tprivate drainListeners: DisposableMap<number> | undefined = undefined;\n\tprivate drainListenerCount = 0;\n\n\tasync whenDrained(): Promise<void> {\n\t\tif (this.isDrained()) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst promise = new DeferredPromise<void>();\n\t\tthis.drainers.add(promise);\n\n\t\treturn promise.p;\n\t}\n\n\tprivate isDrained(): boolean {\n\t\tfor (const [, queue] of this.queues) {\n\t\t\tif (queue.size > 0) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\n\t\treturn true;\n\t}\n\n\tqueueSize(resource: URI, extUri: IExtUri = defaultExtUri): number {\n\t\tconst key = extUri.getComparisonKey(resource);\n\n\t\treturn this.queues.get(key)?.size ?? 0;\n\t}\n\n\tqueueFor(resource: URI, factory: ITask<Promise<void>>, extUri: IExtUri = defaultExtUri): Promise<void> {\n\t\tconst key = extUri.getComparisonKey(resource);\n\n\t\tlet queue = this.queues.get(key);\n\t\tif (!queue) {\n\t\t\tqueue = new Queue<void>();\n\t\t\tconst drainListenerId = this.drainListenerCount++;\n\t\t\tconst drainListener = Event.once(queue.onDrained)(() => {\n\t\t\t\tqueue?.dispose();\n\t\t\t\tthis.queues.delete(key);\n\t\t\t\tthis.onDidQueueDrain();\n\n\t\t\t\tthis.drainListeners?.deleteAndDispose(drainListenerId);\n\n\t\t\t\tif (this.drainListeners?.size === 0) {\n\t\t\t\t\tthis.drainListeners.dispose();\n\t\t\t\t\tthis.drainListeners = undefined;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tif (!this.drainListeners) {\n\t\t\t\tthis.drainListeners = new DisposableMap();\n\t\t\t}\n\t\t\tthis.drainListeners.set(drainListenerId, drainListener);\n\n\t\t\tthis.queues.set(key, queue);\n\t\t}\n\n\t\treturn queue.queue(factory);\n\t}\n\n\tprivate onDidQueueDrain(): void {\n\t\tif (!this.isDrained()) {\n\t\t\treturn; // not done yet\n\t\t}\n\n\t\tthis.releaseDrainers();\n\t}\n\n\tprivate releaseDrainers(): void {\n\t\tfor (const drainer of this.drainers) {\n\t\t\tdrainer.complete();\n\t\t}\n\n\t\tthis.drainers.clear();\n\t}\n\n\tdispose(): void {\n\t\tfor (const [, queue] of this.queues) {\n\t\t\tqueue.dispose();\n\t\t}\n\n\t\tthis.queues.clear();\n\n\t\t// Even though we might still have pending\n\t\t// tasks queued, after the queues have been\n\t\t// disposed, we can no longer track them, so\n\t\t// we release drainers to prevent hanging\n\t\t// promises when the resource queue is being\n\t\t// disposed.\n\t\tthis.releaseDrainers();\n\n\t\tthis.drainListeners?.dispose();\n\t}\n}\n\nexport type Task<T = void> = () => (Promise<T> | T);\n\n/**\n * Wrap a type in an optional promise. This can be useful to avoid the runtime\n * overhead of creating a promise.\n */\nexport type MaybePromise<T> = Promise<T> | T;\n\n/**\n * Processes tasks in the order they were scheduled.\n*/\nexport class TaskQueue {\n\tprivate _runningTask: Task<any> | undefined = undefined;\n\tprivate _pendingTasks: { task: Task<any>; deferred: DeferredPromise<any>; setUndefinedWhenCleared: boolean }[] = [];\n\n\t/**\n\t * Waits for the current and pending tasks to finish, then runs and awaits the given task.\n\t * If the task is skipped because of clearPending, the promise is rejected with a CancellationError.\n\t*/\n\tpublic schedule<T>(task: Task<T>): Promise<T> {\n\t\tconst deferred = new DeferredPromise<T>();\n\t\tthis._pendingTasks.push({ task, deferred, setUndefinedWhenCleared: false });\n\t\tthis._runIfNotRunning();\n\t\treturn deferred.p;\n\t}\n\n\t/**\n\t * Waits for the current and pending tasks to finish, then runs and awaits the given task.\n\t * If the task is skipped because of clearPending, the promise is resolved with undefined.\n\t*/\n\tpublic scheduleSkipIfCleared<T>(task: Task<T>): Promise<T | undefined> {\n\t\tconst deferred = new DeferredPromise<T>();\n\t\tthis._pendingTasks.push({ task, deferred, setUndefinedWhenCleared: true });\n\t\tthis._runIfNotRunning();\n\t\treturn deferred.p;\n\t}\n\n\tprivate _runIfNotRunning(): void {\n\t\tif (this._runningTask === undefined) {\n\t\t\tthis._processQueue();\n\t\t}\n\t}\n\n\tprivate async _processQueue(): Promise<void> {\n\t\tif (this._pendingTasks.length === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst next = this._pendingTasks.shift();\n\t\tif (!next) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (this._runningTask) {\n\t\t\tthrow new BugIndicatingError();\n\t\t}\n\n\t\tthis._runningTask = next.task;\n\n\t\ttry {\n\t\t\tconst result = await next.task();\n\t\t\tnext.deferred.complete(result);\n\t\t} catch (e) {\n\t\t\tnext.deferred.error(e);\n\t\t} finally {\n\t\t\tthis._runningTask = undefined;\n\t\t\tthis._processQueue();\n\t\t}\n\t}\n\n\t/**\n\t * Clears all pending tasks. Does not cancel the currently running task.\n\t*/\n\tpublic clearPending(): void {\n\t\tconst tasks = this._pendingTasks;\n\t\tthis._pendingTasks = [];\n\t\tfor (const task of tasks) {\n\t\t\tif (task.setUndefinedWhenCleared) {\n\t\t\t\ttask.deferred.complete(undefined);\n\t\t\t} else {\n\t\t\t\ttask.deferred.error(new CancellationError());\n\t\t\t}\n\t\t}\n\t}\n}\n\nexport class TimeoutTimer implements IDisposable {\n\tprivate _token: Timeout | undefined;\n\tprivate _isDisposed = false;\n\n\tconstructor();\n\tconstructor(runner: () => void, timeout: number);\n\tconstructor(runner?: () => void, timeout?: number) {\n\t\tthis._token = undefined;\n\n\t\tif (typeof runner === 'function' && typeof timeout === 'number') {\n\t\t\tthis.setIfNotSet(runner, timeout);\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis.cancel();\n\t\tthis._isDisposed = true;\n\t}\n\n\tcancel(): void {\n\t\tif (this._token !== undefined) {\n\t\t\tclearTimeout(this._token);\n\t\t\tthis._token = undefined;\n\t\t}\n\t}\n\n\tcancelAndSet(runner: () => void, timeout: number): void {\n\t\tif (this._isDisposed) {\n\t\t\tthrow new BugIndicatingError(`Calling 'cancelAndSet' on a disposed TimeoutTimer`);\n\t\t}\n\n\t\tthis.cancel();\n\t\tthis._token = setTimeout(() => {\n\t\t\tthis._token = undefined;\n\t\t\trunner();\n\t\t}, timeout);\n\t}\n\n\tsetIfNotSet(runner: () => void, timeout: number): void {\n\t\tif (this._isDisposed) {\n\t\t\tthrow new BugIndicatingError(`Calling 'setIfNotSet' on a disposed TimeoutTimer`);\n\t\t}\n\n\t\tif (this._token !== undefined) {\n\t\t\t// timer is already set\n\t\t\treturn;\n\t\t}\n\t\tthis._token = setTimeout(() => {\n\t\t\tthis._token = undefined;\n\t\t\trunner();\n\t\t}, timeout);\n\t}\n}\n\nexport class IntervalTimer implements IDisposable {\n\n\tprivate disposable: IDisposable | undefined = undefined;\n\tprivate isDisposed = false;\n\n\tcancel(): void {\n\t\tthis.disposable?.dispose();\n\t\tthis.disposable = undefined;\n\t}\n\n\tcancelAndSet(runner: () => void, interval: number, context = globalThis): void {\n\t\tif (this.isDisposed) {\n\t\t\tthrow new BugIndicatingError(`Calling 'cancelAndSet' on a disposed IntervalTimer`);\n\t\t}\n\n\t\tthis.cancel();\n\t\tconst handle = context.setInterval(() => {\n\t\t\trunner();\n\t\t}, interval);\n\n\t\tthis.disposable = toDisposable(() => {\n\t\t\tcontext.clearInterval(handle);\n\t\t\tthis.disposable = undefined;\n\t\t});\n\t}\n\n\tdispose(): void {\n\t\tthis.cancel();\n\t\tthis.isDisposed = true;\n\t}\n}\n\nexport class RunOnceScheduler implements IDisposable {\n\n\tprotected runner: ((...args: unknown[]) => void) | null;\n\n\tprivate timeoutToken: Timeout | undefined;\n\tprivate timeout: number;\n\tprivate timeoutHandler: () => void;\n\n\tconstructor(runner: (...args: any[]) => void, delay: number) {\n\t\tthis.timeoutToken = undefined;\n\t\tthis.runner = runner;\n\t\tthis.timeout = delay;\n\t\tthis.timeoutHandler = this.onTimeout.bind(this);\n\t}\n\n\t/**\n\t * Dispose RunOnceScheduler\n\t */\n\tdispose(): void {\n\t\tthis.cancel();\n\t\tthis.runner = null;\n\t}\n\n\t/**\n\t * Cancel current scheduled runner (if any).\n\t */\n\tcancel(): void {\n\t\tif (this.isScheduled()) {\n\t\t\tclearTimeout(this.timeoutToken);\n\t\t\tthis.timeoutToken = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Cancel previous runner (if any) & schedule a new runner.\n\t */\n\tschedule(delay = this.timeout): void {\n\t\tthis.cancel();\n\t\tthis.timeoutToken = setTimeout(this.timeoutHandler, delay);\n\t}\n\n\tget delay(): number {\n\t\treturn this.timeout;\n\t}\n\n\tset delay(value: number) {\n\t\tthis.timeout = value;\n\t}\n\n\t/**\n\t * Returns true if scheduled.\n\t */\n\tisScheduled(): boolean {\n\t\treturn this.timeoutToken !== undefined;\n\t}\n\n\tflush(): void {\n\t\tif (this.isScheduled()) {\n\t\t\tthis.cancel();\n\t\t\tthis.doRun();\n\t\t}\n\t}\n\n\tprivate onTimeout() {\n\t\tthis.timeoutToken = undefined;\n\t\tif (this.runner) {\n\t\t\tthis.doRun();\n\t\t}\n\t}\n\n\tprotected doRun(): void {\n\t\tthis.runner?.();\n\t}\n}\n\n/**\n * Same as `RunOnceScheduler`, but doesn't count the time spent in sleep mode.\n * > **NOTE**: Only offers 1s resolution.\n *\n * When calling `setTimeout` with 3hrs, and putting the computer immediately to sleep\n * for 8hrs, `setTimeout` will fire **as soon as the computer wakes from sleep**. But\n * this scheduler will execute 3hrs **after waking the computer from sleep**.\n */\nexport class ProcessTimeRunOnceScheduler {\n\n\tprivate runner: (() => void) | null;\n\tprivate timeout: number;\n\n\tprivate counter: number;\n\tprivate intervalToken: Timeout | undefined;\n\tprivate intervalHandler: () => void;\n\n\tconstructor(runner: () => void, delay: number) {\n\t\tif (delay % 1000 !== 0) {\n\t\t\tconsole.warn(`ProcessTimeRunOnceScheduler resolution is 1s, ${delay}ms is not a multiple of 1000ms.`);\n\t\t}\n\t\tthis.runner = runner;\n\t\tthis.timeout = delay;\n\t\tthis.counter = 0;\n\t\tthis.intervalToken = undefined;\n\t\tthis.intervalHandler = this.onInterval.bind(this);\n\t}\n\n\tdispose(): void {\n\t\tthis.cancel();\n\t\tthis.runner = null;\n\t}\n\n\tcancel(): void {\n\t\tif (this.isScheduled()) {\n\t\t\tclearInterval(this.intervalToken);\n\t\t\tthis.intervalToken = undefined;\n\t\t}\n\t}\n\n\t/**\n\t * Cancel previous runner (if any) & schedule a new runner.\n\t */\n\tschedule(delay = this.timeout): void {\n\t\tif (delay % 1000 !== 0) {\n\t\t\tconsole.warn(`ProcessTimeRunOnceScheduler resolution is 1s, ${delay}ms is not a multiple of 1000ms.`);\n\t\t}\n\t\tthis.cancel();\n\t\tthis.counter = Math.ceil(delay / 1000);\n\t\tthis.intervalToken = setInterval(this.intervalHandler, 1000);\n\t}\n\n\t/**\n\t * Returns true if scheduled.\n\t */\n\tisScheduled(): boolean {\n\t\treturn this.intervalToken !== undefined;\n\t}\n\n\tprivate onInterval() {\n\t\tthis.counter--;\n\t\tif (this.counter > 0) {\n\t\t\t// still need to wait\n\t\t\treturn;\n\t\t}\n\n\t\t// time elapsed\n\t\tclearInterval(this.intervalToken);\n\t\tthis.intervalToken = undefined;\n\t\tthis.runner?.();\n\t}\n}\n\nexport class RunOnceWorker<T> extends RunOnceScheduler {\n\n\tprivate units: T[] = [];\n\n\tconstructor(runner: (units: T[]) => void, timeout: number) {\n\t\tsuper(runner, timeout);\n\t}\n\n\twork(unit: T): void {\n\t\tthis.units.push(unit);\n\n\t\tif (!this.isScheduled()) {\n\t\t\tthis.schedule();\n\t\t}\n\t}\n\n\tprotected override doRun(): void {\n\t\tconst units = this.units;\n\t\tthis.units = [];\n\n\t\tthis.runner?.(units);\n\t}\n\n\toverride dispose(): void {\n\t\tthis.units = [];\n\n\t\tsuper.dispose();\n\t}\n}\n\nexport interface IThrottledWorkerOptions {\n\n\t/**\n\t * maximum of units the worker will pass onto handler at once\n\t */\n\tmaxWorkChunkSize: number;\n\n\t/**\n\t * maximum of units the worker will keep in memory for processing\n\t */\n\tmaxBufferedWork: number | undefined;\n\n\t/**\n\t * delay before processing the next round of chunks when chunk size exceeds limits\n\t */\n\tthrottleDelay: number;\n\n\t/**\n\t * When enabled will guarantee that two distinct calls to `work()` are not executed\n\t * without throttle delay between them.\n\t * Otherwise if the worker isn't currently throttling it will execute work immediately.\n\t */\n\twaitThrottleDelayBetweenWorkUnits?: boolean;\n}\n\n/**\n * The `ThrottledWorker` will accept units of work `T`\n * to handle. The contract is:\n * * there is a maximum of units the worker can handle at once (via `maxWorkChunkSize`)\n * * there is a maximum of units the worker will keep in memory for processing (via `maxBufferedWork`)\n * * after having handled `maxWorkChunkSize` units, the worker needs to rest (via `throttleDelay`)\n */\nexport class ThrottledWorker<T> extends Disposable {\n\n\tprivate readonly pendingWork: T[] = [];\n\n\tprivate readonly throttler = this._register(new MutableDisposable<RunOnceScheduler>());\n\tprivate disposed = false;\n\tprivate lastExecutionTime = 0;\n\n\tconstructor(\n\t\tprivate options: IThrottledWorkerOptions,\n\t\tprivate readonly handler: (units: T[]) => void\n\t) {\n\t\tsuper();\n\t}\n\n\t/**\n\t * The number of work units that are pending to be processed.\n\t */\n\tget pending(): number { return this.pendingWork.length; }\n\n\t/**\n\t * Add units to be worked on. Use `pending` to figure out\n\t * how many units are not yet processed after this method\n\t * was called.\n\t *\n\t * @returns whether the work was accepted or not. If the\n\t * worker is disposed, it will not accept any more work.\n\t * If the number of pending units would become larger\n\t * than `maxPendingWork`, more work will also not be accepted.\n\t */\n\twork(units: readonly T[]): boolean {\n\t\tif (this.disposed) {\n\t\t\treturn false; // work not accepted: disposed\n\t\t}\n\n\t\t// Check for reaching maximum of pending work\n\t\tif (typeof this.options.maxBufferedWork === 'number') {\n\n\t\t\t// Throttled: simple check if pending + units exceeds max pending\n\t\t\tif (this.throttler.value) {\n\t\t\t\tif (this.pending + units.length > this.options.maxBufferedWork) {\n\t\t\t\t\treturn false; // work not accepted: too much pending work\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Unthrottled: same as throttled, but account for max chunk getting\n\t\t\t// worked on directly without being pending\n\t\t\telse {\n\t\t\t\tif (this.pending + units.length - this.options.maxWorkChunkSize > this.options.maxBufferedWork) {\n\t\t\t\t\treturn false; // work not accepted: too much pending work\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Add to pending units first\n\t\tfor (const unit of units) {\n\t\t\tthis.pendingWork.push(unit);\n\t\t}\n\n\t\tconst timeSinceLastExecution = Date.now() - this.lastExecutionTime;\n\n\t\tif (!this.throttler.value && (!this.options.waitThrottleDelayBetweenWorkUnits || timeSinceLastExecution >= this.options.throttleDelay)) {\n\t\t\t// Work directly if we are not throttling and we are not\n\t\t\t// enforced to throttle between `work()` calls.\n\t\t\tthis.doWork();\n\t\t} else if (!this.throttler.value && this.options.waitThrottleDelayBetweenWorkUnits) {\n\t\t\t// Otherwise, schedule the throttler to work.\n\t\t\tthis.scheduleThrottler(Math.max(this.options.throttleDelay - timeSinceLastExecution, 0));\n\t\t} else {\n\t\t\t// Otherwise, our work will be picked up by the running throttler\n\t\t}\n\n\t\treturn true; // work accepted\n\t}\n\n\tprivate doWork(): void {\n\t\tthis.lastExecutionTime = Date.now();\n\n\t\t// Extract chunk to handle and handle it\n\t\tthis.handler(this.pendingWork.splice(0, this.options.maxWorkChunkSize));\n\n\t\t// If we have remaining work, schedule it after a delay\n\t\tif (this.pendingWork.length > 0) {\n\t\t\tthis.scheduleThrottler();\n\t\t}\n\t}\n\n\tprivate scheduleThrottler(delay = this.options.throttleDelay): void {\n\t\tthis.throttler.value = new RunOnceScheduler(() => {\n\t\t\tthis.throttler.clear();\n\n\t\t\tthis.doWork();\n\t\t}, delay);\n\t\tthis.throttler.value.schedule();\n\t}\n\n\toverride dispose(): void {\n\t\tsuper.dispose();\n\n\t\tthis.pendingWork.length = 0;\n\t\tthis.disposed = true;\n\t}\n}\n\n//#region -- run on idle tricks ------------\n\nexport interface IdleDeadline {\n\treadonly didTimeout: boolean;\n\ttimeRemaining(): number;\n}\n\ntype IdleApi = Pick<typeof globalThis, 'requestIdleCallback' | 'cancelIdleCallback'>;\n\n\n/**\n * Execute the callback the next time the browser is idle, returning an\n * {@link IDisposable} that will cancel the callback when disposed. This wraps\n * [requestIdleCallback] so it will fallback to [setTimeout] if the environment\n * doesn't support it.\n *\n * @param callback The callback to run when idle, this includes an\n * [IdleDeadline] that provides the time alloted for the idle callback by the\n * browser. Not respecting this deadline will result in a degraded user\n * experience.\n * @param timeout A timeout at which point to queue no longer wait for an idle\n * callback but queue it on the regular event loop (like setTimeout). Typically\n * this should not be used.\n *\n * [IdleDeadline]: https://developer.mozilla.org/en-US/docs/Web/API/IdleDeadline\n * [requestIdleCallback]: https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback\n * [setTimeout]: https://developer.mozilla.org/en-US/docs/Web/API/Window/setTimeout\n *\n * **Note** that there is `dom.ts#runWhenWindowIdle` which is better suited when running inside a browser\n * context\n */\nexport let runWhenGlobalIdle: (callback: (idle: IdleDeadline) => void, timeout?: number) => IDisposable;\n\nexport let _runWhenIdle: (targetWindow: IdleApi, callback: (idle: IdleDeadline) => void, timeout?: number) => IDisposable;\n\n(function () {\n\tconst safeGlobal: any = globalThis;\n\tif (typeof safeGlobal.requestIdleCallback !== 'function' || typeof safeGlobal.cancelIdleCallback !== 'function') {\n\t\t_runWhenIdle = (_targetWindow, runner, timeout?) => {\n\t\t\tsetTimeout0(() => {\n\t\t\t\tif (disposed) {\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tconst end = Date.now() + 15; // one frame at 64fps\n\t\t\t\tconst deadline: IdleDeadline = {\n\t\t\t\t\tdidTimeout: true,\n\t\t\t\t\ttimeRemaining() {\n\t\t\t\t\t\treturn Math.max(0, end - Date.now());\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t\trunner(Object.freeze(deadline));\n\t\t\t});\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t}\n\t\t\t};\n\t\t};\n\t} else {\n\t\t_runWhenIdle = (targetWindow: typeof safeGlobal, runner, timeout?) => {\n\t\t\tconst handle: number = targetWindow.requestIdleCallback(runner, typeof timeout === 'number' ? { timeout } : undefined);\n\t\t\tlet disposed = false;\n\t\t\treturn {\n\t\t\t\tdispose() {\n\t\t\t\t\tif (disposed) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\tdisposed = true;\n\t\t\t\t\ttargetWindow.cancelIdleCallback(handle);\n\t\t\t\t}\n\t\t\t};\n\t\t};\n\t}\n\trunWhenGlobalIdle = (runner, timeout) => _runWhenIdle(globalThis, runner, timeout);\n})();\n\nexport abstract class AbstractIdleValue<T> {\n\n\tprivate readonly _executor: () => void;\n\tprivate readonly _handle: IDisposable;\n\n\tprivate _didRun: boolean = false;\n\tprivate _value?: T;\n\tprivate _error: unknown;\n\n\tconstructor(targetWindow: IdleApi, executor: () => T) {\n\t\tthis._executor = () => {\n\t\t\ttry {\n\t\t\t\tthis._value = executor();\n\t\t\t} catch (err) {\n\t\t\t\tthis._error = err;\n\t\t\t} finally {\n\t\t\t\tthis._didRun = true;\n\t\t\t}\n\t\t};\n\t\tthis._handle = _runWhenIdle(targetWindow, () => this._executor());\n\t}\n\n\tdispose(): void {\n\t\tthis._handle.dispose();\n\t}\n\n\tget value(): T {\n\t\tif (!this._didRun) {\n\t\t\tthis._handle.dispose();\n\t\t\tthis._executor();\n\t\t}\n\t\tif (this._error) {\n\t\t\tthrow this._error;\n\t\t}\n\t\treturn this._value!;\n\t}\n\n\tget isInitialized(): boolean {\n\t\treturn this._didRun;\n\t}\n}\n\n/**\n * An `IdleValue` that always uses the current window (which might be throttled or inactive)\n *\n * **Note** that there is `dom.ts#WindowIdleValue` which is better suited when running inside a browser\n * context\n */\nexport class GlobalIdleValue<T> extends AbstractIdleValue<T> {\n\n\tconstructor(executor: () => T) {\n\t\tsuper(globalThis, executor);\n\t}\n}\n\n//#endregion\n\nexport async function retry<T>(task: ITask<Promise<T>>, delay: number, retries: number): Promise<T> {\n\tlet lastError: Error | undefined;\n\n\tfor (let i = 0; i < retries; i++) {\n\t\ttry {\n\t\t\treturn await task();\n\t\t} catch (error) {\n\t\t\tlastError = error;\n\n\t\t\tawait timeout(delay);\n\t\t}\n\t}\n\n\tthrow lastError;\n}\n\n//#region Task Sequentializer\n\ninterface IRunningTask {\n\treadonly taskId: number;\n\treadonly cancel: () => void;\n\treadonly promise: Promise<void>;\n}\n\ninterface IQueuedTask {\n\treadonly promise: Promise<void>;\n\treadonly promiseResolve: () => void;\n\treadonly promiseReject: (error: Error) => void;\n\trun: ITask<Promise<void>>;\n}\n\nexport interface ITaskSequentializerWithRunningTask {\n\treadonly running: Promise<void>;\n}\n\nexport interface ITaskSequentializerWithQueuedTask {\n\treadonly queued: IQueuedTask;\n}\n\n/**\n * @deprecated use `LimitedQueue` instead for an easier to use API\n */\nexport class TaskSequentializer {\n\n\tprivate _running?: IRunningTask;\n\tprivate _queued?: IQueuedTask;\n\n\tisRunning(taskId?: number): this is ITaskSequentializerWithRunningTask {\n\t\tif (typeof taskId === 'number') {\n\t\t\treturn this._running?.taskId === taskId;\n\t\t}\n\n\t\treturn !!this._running;\n\t}\n\n\tget running(): Promise<void> | undefined {\n\t\treturn this._running?.promise;\n\t}\n\n\tcancelRunning(): void {\n\t\tthis._running?.cancel();\n\t}\n\n\trun(taskId: number, promise: Promise<void>, onCancel?: () => void,): Promise<void> {\n\t\tthis._running = { taskId, cancel: () => onCancel?.(), promise };\n\n\t\tpromise.then(() => this.doneRunning(taskId), () => this.doneRunning(taskId));\n\n\t\treturn promise;\n\t}\n\n\tprivate doneRunning(taskId: number): void {\n\t\tif (this._running && taskId === this._running.taskId) {\n\n\t\t\t// only set running to done if the promise finished that is associated with that taskId\n\t\t\tthis._running = undefined;\n\n\t\t\t// schedule the queued task now that we are free if we have any\n\t\t\tthis.runQueued();\n\t\t}\n\t}\n\n\tprivate runQueued(): void {\n\t\tif (this._queued) {\n\t\t\tconst queued = this._queued;\n\t\t\tthis._queued = undefined;\n\n\t\t\t// Run queued task and complete on the associated promise\n\t\t\tqueued.run().then(queued.promiseResolve, queued.promiseReject);\n\t\t}\n\t}\n\n\t/**\n\t * Note: the promise to schedule as next run MUST itself call `run`.\n\t *       Otherwise, this sequentializer will report `false` for `isRunning`\n\t *       even when this task is running. Missing this detail means that\n\t *       suddenly multiple tasks will run in parallel.\n\t */\n\tqueue(run: ITask<Promise<void>>): Promise<void> {\n\n\t\t// this is our first queued task, so we create associated promise with it\n\t\t// so that we can return a promise that completes when the task has\n\t\t// completed.\n\t\tif (!this._queued) {\n\t\t\tconst { promise, resolve: promiseResolve, reject: promiseReject } = promiseWithResolvers<void>();\n\t\t\tthis._queued = {\n\t\t\t\trun,\n\t\t\t\tpromise,\n\t\t\t\tpromiseResolve,\n\t\t\t\tpromiseReject\n\t\t\t};\n\t\t}\n\n\t\t// we have a previous queued task, just overwrite it\n\t\telse {\n\t\t\tthis._queued.run = run;\n\t\t}\n\n\t\treturn this._queued.promise;\n\t}\n\n\thasQueued(): this is ITaskSequentializerWithQueuedTask {\n\t\treturn !!this._queued;\n\t}\n\n\tasync join(): Promise<void> {\n\t\treturn this._queued?.promise ?? this._running?.promise;\n\t}\n}\n\n//#endregion\n\n//#region\n\n/**\n * The `IntervalCounter` allows to count the number\n * of calls to `increment()` over a duration of\n * `interval`. This utility can be used to conditionally\n * throttle a frequent task when a certain threshold\n * is reached.\n */\nexport class IntervalCounter {\n\n\tprivate lastIncrementTime = 0;\n\n\tprivate value = 0;\n\n\tconstructor(private readonly interval: number, private readonly nowFn = () => Date.now()) { }\n\n\tincrement(): number {\n\t\tconst now = this.nowFn();\n\n\t\t// We are outside of the range of `interval` and as such\n\t\t// start counting from 0 and remember the time\n\t\tif (now - this.lastIncrementTime > this.interval) {\n\t\t\tthis.lastIncrementTime = now;\n\t\t\tthis.value = 0;\n\t\t}\n\n\t\tthis.value++;\n\n\t\treturn this.value;\n\t}\n}\n\n//#endregion\n\n//#region\n\nexport type ValueCallback<T = unknown> = (value: T | Promise<T>) => void;\n\nconst enum DeferredOutcome {\n\tResolved,\n\tRejected\n}\n\n/**\n * Creates a promise whose resolution or rejection can be controlled imperatively.\n */\nexport class DeferredPromise<T> {\n\n\tpublic static fromPromise<T>(promise: Promise<T>): DeferredPromise<T> {\n\t\tconst deferred = new DeferredPromise<T>();\n\t\tdeferred.settleWith(promise);\n\t\treturn deferred;\n\t}\n\n\tprivate completeCallback!: ValueCallback<T>;\n\tprivate errorCallback!: (err: unknown) => void;\n\tprivate outcome?: { outcome: DeferredOutcome.Rejected; value: unknown } | { outcome: DeferredOutcome.Resolved; value: T };\n\n\tpublic get isRejected() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Rejected;\n\t}\n\n\tpublic get isResolved() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved;\n\t}\n\n\tpublic get isSettled() {\n\t\treturn !!this.outcome;\n\t}\n\n\tpublic get value() {\n\t\treturn this.outcome?.outcome === DeferredOutcome.Resolved ? this.outcome?.value : undefined;\n\t}\n\n\tpublic readonly p: Promise<T>;\n\n\tconstructor() {\n\t\tthis.p = new Promise<T>((c, e) => {\n\t\t\tthis.completeCallback = c;\n\t\t\tthis.errorCallback = e;\n\t\t});\n\t}\n\n\tpublic complete(value: T) {\n\t\tif (this.isSettled) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.completeCallback(value);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Resolved, value };\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tpublic error(err: unknown) {\n\t\tif (this.isSettled) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\treturn new Promise<void>(resolve => {\n\t\t\tthis.errorCallback(err);\n\t\t\tthis.outcome = { outcome: DeferredOutcome.Rejected, value: err };\n\t\t\tresolve();\n\t\t});\n\t}\n\n\tpublic settleWith(promise: Promise<T>): Promise<void> {\n\t\treturn promise.then(\n\t\t\tvalue => this.complete(value),\n\t\t\terror => this.error(error)\n\t\t);\n\t}\n\n\tpublic cancel() {\n\t\treturn this.error(new CancellationError());\n\t}\n}\n\n//#endregion\n\n//#region Promises\n\nexport namespace Promises {\n\n\t/**\n\t * A drop-in replacement for `Promise.all` with the only difference\n\t * that the method awaits every promise to either fulfill or reject.\n\t *\n\t * Similar to `Promise.all`, only the first error will be returned\n\t * if any.\n\t */\n\texport async function settled<T>(promises: Promise<T>[]): Promise<T[]> {\n\t\tlet firstError: Error | undefined = undefined;\n\n\t\tconst result = await Promise.all(promises.map(promise => promise.then(value => value, error => {\n\t\t\tif (!firstError) {\n\t\t\t\tfirstError = error;\n\t\t\t}\n\n\t\t\treturn undefined; // do not rethrow so that other promises can settle\n\t\t})));\n\n\t\tif (typeof firstError !== 'undefined') {\n\t\t\tthrow firstError;\n\t\t}\n\n\t\treturn result as unknown as T[]; // cast is needed and protected by the `throw` above\n\t}\n\n\t/**\n\t * A helper to create a new `Promise<T>` with a body that is a promise\n\t * itself. By default, an error that raises from the async body will\n\t * end up as a unhandled rejection, so this utility properly awaits the\n\t * body and rejects the promise as a normal promise does without async\n\t * body.\n\t *\n\t * This method should only be used in rare cases where otherwise `async`\n\t * cannot be used (e.g. when callbacks are involved that require this).\n\t */\n\texport function withAsyncBody<T, E = Error>(bodyFn: (resolve: (value: T) => unknown, reject: (error: E) => unknown) => Promise<unknown>): Promise<T> {\n\t\t// eslint-disable-next-line no-async-promise-executor\n\t\treturn new Promise<T>(async (resolve, reject) => {\n\t\t\ttry {\n\t\t\t\tawait bodyFn(resolve, reject);\n\t\t\t} catch (error) {\n\t\t\t\treject(error);\n\t\t\t}\n\t\t});\n\t}\n}\n\nexport class StatefulPromise<T> {\n\tprivate _value: T | undefined = undefined;\n\tget value(): T | undefined { return this._value; }\n\n\tprivate _error: unknown = undefined;\n\tget error(): unknown { return this._error; }\n\n\tprivate _isResolved = false;\n\tget isResolved() { return this._isResolved; }\n\n\tpublic readonly promise: Promise<T>;\n\n\tconstructor(promise: Promise<T>) {\n\t\tthis.promise = promise.then(\n\t\t\tvalue => {\n\t\t\t\tthis._value = value;\n\t\t\t\tthis._isResolved = true;\n\t\t\t\treturn value;\n\t\t\t},\n\t\t\terror => {\n\t\t\t\tthis._error = error;\n\t\t\t\tthis._isResolved = true;\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t);\n\t}\n\n\t/**\n\t * Returns the resolved value.\n\t * Throws if the promise is not resolved yet.\n\t */\n\tpublic requireValue(): T {\n\t\tif (!this._isResolved) {\n\t\t\tthrow new BugIndicatingError('Promise is not resolved yet');\n\t\t}\n\t\tif (this._error) {\n\t\t\tthrow this._error;\n\t\t}\n\t\treturn this._value!;\n\t}\n}\n\nexport class LazyStatefulPromise<T> {\n\tprivate readonly _promise = new Lazy(() => new StatefulPromise(this._compute()));\n\n\tconstructor(\n\t\tprivate readonly _compute: () => Promise<T>,\n\t) { }\n\n\t/**\n\t * Returns the resolved value.\n\t * Throws if the promise is not resolved yet.\n\t */\n\tpublic requireValue(): T {\n\t\treturn this._promise.value.requireValue();\n\t}\n\n\t/**\n\t * Returns the promise (and triggers a computation of the promise if not yet done so).\n\t */\n\tpublic getPromise(): Promise<T> {\n\t\treturn this._promise.value.promise;\n\t}\n\n\t/**\n\t * Reads the current value without triggering a computation of the promise.\n\t */\n\tpublic get currentValue(): T | undefined {\n\t\treturn this._promise.rawValue?.value;\n\t}\n}\n\n//#endregion\n\n//#region\n\nconst enum AsyncIterableSourceState {\n\tInitial,\n\tDoneOK,\n\tDoneError,\n}\n\n/**\n * An object that allows to emit async values asynchronously or bring the iterable to an error state using `reject()`.\n * This emitter is valid only for the duration of the executor (until the promise returned by the executor settles).\n */\nexport interface AsyncIterableEmitter<T> {\n\t/**\n\t * The value will be appended at the end.\n\t *\n\t * **NOTE** If `reject()` has already been called, this method has no effect.\n\t */\n\temitOne(value: T): void;\n\t/**\n\t * The values will be appended at the end.\n\t *\n\t * **NOTE** If `reject()` has already been called, this method has no effect.\n\t */\n\temitMany(values: T[]): void;\n\t/**\n\t * Writing an error will permanently invalidate this iterable.\n\t * The current users will receive an error thrown, as will all future users.\n\t *\n\t * **NOTE** If `reject()` have already been called, this method has no effect.\n\t */\n\treject(error: Error): void;\n}\n\n/**\n * An executor for the `AsyncIterableObject` that has access to an emitter.\n */\nexport interface AsyncIterableExecutor<T> {\n\t/**\n\t * @param emitter An object that allows to emit async values valid only for the duration of the executor.\n\t */\n\t(emitter: AsyncIterableEmitter<T>): unknown | Promise<unknown>;\n}\n\n/**\n * A rich implementation for an `AsyncIterable<T>`.\n */\nexport class AsyncIterableObject<T> implements AsyncIterable<T> {\n\n\tpublic static fromArray<T>(items: T[]): AsyncIterableObject<T> {\n\t\treturn new AsyncIterableObject<T>((writer) => {\n\t\t\twriter.emitMany(items);\n\t\t});\n\t}\n\n\tpublic static fromPromise<T>(promise: Promise<T[]>): AsyncIterableObject<T> {\n\t\treturn new AsyncIterableObject<T>(async (emitter) => {\n\t\t\temitter.emitMany(await promise);\n\t\t});\n\t}\n\n\tpublic static fromPromisesResolveOrder<T>(promises: Promise<T>[]): AsyncIterableObject<T> {\n\t\treturn new AsyncIterableObject<T>(async (emitter) => {\n\t\t\tawait Promise.all(promises.map(async (p) => emitter.emitOne(await p)));\n\t\t});\n\t}\n\n\tpublic static merge<T>(iterables: AsyncIterable<T>[]): AsyncIterableObject<T> {\n\t\treturn new AsyncIterableObject(async (emitter) => {\n\t\t\tawait Promise.all(iterables.map(async (iterable) => {\n\t\t\t\tfor await (const item of iterable) {\n\t\t\t\t\temitter.emitOne(item);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\t}\n\n\tpublic static EMPTY = AsyncIterableObject.fromArray<any>([]);\n\n\tprivate _state: AsyncIterableSourceState;\n\tprivate _results: T[];\n\tprivate _error: Error | null;\n\tprivate readonly _onReturn?: () => void | Promise<void>;\n\tprivate readonly _onStateChanged: Emitter<void>;\n\n\tconstructor(executor: AsyncIterableExecutor<T>, onReturn?: () => void | Promise<void>) {\n\t\tthis._state = AsyncIterableSourceState.Initial;\n\t\tthis._results = [];\n\t\tthis._error = null;\n\t\tthis._onReturn = onReturn;\n\t\tthis._onStateChanged = new Emitter<void>();\n\n\t\tqueueMicrotask(async () => {\n\t\t\tconst writer: AsyncIterableEmitter<T> = {\n\t\t\t\temitOne: (item) => this.emitOne(item),\n\t\t\t\temitMany: (items) => this.emitMany(items),\n\t\t\t\treject: (error) => this.reject(error)\n\t\t\t};\n\t\t\ttry {\n\t\t\t\tawait Promise.resolve(executor(writer));\n\t\t\t\tthis.resolve();\n\t\t\t} catch (err) {\n\t\t\t\tthis.reject(err);\n\t\t\t} finally {\n\t\t\t\twriter.emitOne = undefined!;\n\t\t\t\twriter.emitMany = undefined!;\n\t\t\t\twriter.reject = undefined!;\n\t\t\t}\n\t\t});\n\t}\n\n\t[Symbol.asyncIterator](): AsyncIterator<T, undefined, undefined> {\n\t\tlet i = 0;\n\t\treturn {\n\t\t\tnext: async () => {\n\t\t\t\tdo {\n\t\t\t\t\tif (this._state === AsyncIterableSourceState.DoneError) {\n\t\t\t\t\t\tthrow this._error;\n\t\t\t\t\t}\n\t\t\t\t\tif (i < this._results.length) {\n\t\t\t\t\t\treturn { done: false, value: this._results[i++] };\n\t\t\t\t\t}\n\t\t\t\t\tif (this._state === AsyncIterableSourceState.DoneOK) {\n\t\t\t\t\t\treturn { done: true, value: undefined };\n\t\t\t\t\t}\n\t\t\t\t\tawait Event.toPromise(this._onStateChanged.event);\n\t\t\t\t} while (true);\n\t\t\t},\n\t\t\treturn: async () => {\n\t\t\t\tthis._onReturn?.();\n\t\t\t\treturn { done: true, value: undefined };\n\t\t\t}\n\t\t};\n\t}\n\n\tpublic static map<T, R>(iterable: AsyncIterable<T>, mapFn: (item: T) => R): AsyncIterableObject<R> {\n\t\treturn new AsyncIterableObject<R>(async (emitter) => {\n\t\t\tfor await (const item of iterable) {\n\t\t\t\temitter.emitOne(mapFn(item));\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic map<R>(mapFn: (item: T) => R): AsyncIterableObject<R> {\n\t\treturn AsyncIterableObject.map(this, mapFn);\n\t}\n\n\tpublic static filter<T>(iterable: AsyncIterable<T>, filterFn: (item: T) => boolean): AsyncIterableObject<T> {\n\t\treturn new AsyncIterableObject<T>(async (emitter) => {\n\t\t\tfor await (const item of iterable) {\n\t\t\t\tif (filterFn(item)) {\n\t\t\t\t\temitter.emitOne(item);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic filter<T2 extends T>(filterFn: (item: T) => item is T2): AsyncIterableObject<T2>;\n\tpublic filter(filterFn: (item: T) => boolean): AsyncIterableObject<T>;\n\tpublic filter(filterFn: (item: T) => boolean): AsyncIterableObject<T> {\n\t\treturn AsyncIterableObject.filter(this, filterFn);\n\t}\n\n\tpublic static coalesce<T>(iterable: AsyncIterable<T | undefined | null>): AsyncIterableObject<T> {\n\t\treturn <AsyncIterableObject<T>>AsyncIterableObject.filter(iterable, item => !!item);\n\t}\n\n\tpublic coalesce(): AsyncIterableObject<NonNullable<T>> {\n\t\treturn AsyncIterableObject.coalesce(this) as AsyncIterableObject<NonNullable<T>>;\n\t}\n\n\tpublic static async toPromise<T>(iterable: AsyncIterable<T>): Promise<T[]> {\n\t\tconst result: T[] = [];\n\t\tfor await (const item of iterable) {\n\t\t\tresult.push(item);\n\t\t}\n\t\treturn result;\n\t}\n\n\tpublic toPromise(): Promise<T[]> {\n\t\treturn AsyncIterableObject.toPromise(this);\n\t}\n\n\t/**\n\t * The value will be appended at the end.\n\t *\n\t * **NOTE** If `resolve()` or `reject()` have already been called, this method has no effect.\n\t */\n\tprivate emitOne(value: T): void {\n\t\tif (this._state !== AsyncIterableSourceState.Initial) {\n\t\t\treturn;\n\t\t}\n\t\t// it is important to add new values at the end,\n\t\t// as we may have iterators already running on the array\n\t\tthis._results.push(value);\n\t\tthis._onStateChanged.fire();\n\t}\n\n\t/**\n\t * The values will be appended at the end.\n\t *\n\t * **NOTE** If `resolve()` or `reject()` have already been called, this method has no effect.\n\t */\n\tprivate emitMany(values: T[]): void {\n\t\tif (this._state !== AsyncIterableSourceState.Initial) {\n\t\t\treturn;\n\t\t}\n\t\t// it is important to add new values at the end,\n\t\t// as we may have iterators already running on the array\n\t\tthis._results = this._results.concat(values);\n\t\tthis._onStateChanged.fire();\n\t}\n\n\t/**\n\t * Calling `resolve()` will mark the result array as complete.\n\t *\n\t * **NOTE** `resolve()` must be called, otherwise all consumers of this iterable will hang indefinitely, similar to a non-resolved promise.\n\t * **NOTE** If `resolve()` or `reject()` have already been called, this method has no effect.\n\t */\n\tprivate resolve(): void {\n\t\tif (this._state !== AsyncIterableSourceState.Initial) {\n\t\t\treturn;\n\t\t}\n\t\tthis._state = AsyncIterableSourceState.DoneOK;\n\t\tthis._onStateChanged.fire();\n\t}\n\n\t/**\n\t * Writing an error will permanently invalidate this iterable.\n\t * The current users will receive an error thrown, as will all future users.\n\t *\n\t * **NOTE** If `resolve()` or `reject()` have already been called, this method has no effect.\n\t */\n\tprivate reject(error: Error) {\n\t\tif (this._state !== AsyncIterableSourceState.Initial) {\n\t\t\treturn;\n\t\t}\n\t\tthis._state = AsyncIterableSourceState.DoneError;\n\t\tthis._error = error;\n\t\tthis._onStateChanged.fire();\n\t}\n}\n\n\nexport function createCancelableAsyncIterableProducer<T>(callback: (token: CancellationToken) => AsyncIterable<T>): CancelableAsyncIterableProducer<T> {\n\tconst source = new CancellationTokenSource();\n\tconst innerIterable = callback(source.token);\n\n\treturn new CancelableAsyncIterableProducer<T>(source, async (emitter) => {\n\t\tconst subscription = source.token.onCancellationRequested(() => {\n\t\t\tsubscription.dispose();\n\t\t\tsource.dispose();\n\t\t\temitter.reject(new CancellationError());\n\t\t});\n\t\ttry {\n\t\t\tfor await (const item of innerIterable) {\n\t\t\t\tif (source.token.isCancellationRequested) {\n\t\t\t\t\t// canceled in the meantime\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\temitter.emitOne(item);\n\t\t\t}\n\t\t\tsubscription.dispose();\n\t\t\tsource.dispose();\n\t\t} catch (err) {\n\t\t\tsubscription.dispose();\n\t\t\tsource.dispose();\n\t\t\temitter.reject(err);\n\t\t}\n\t});\n}\n\nexport class AsyncIterableSource<T> {\n\n\tprivate readonly _deferred = new DeferredPromise<void>();\n\tprivate readonly _asyncIterable: AsyncIterableObject<T>;\n\n\tprivate _errorFn: (error: Error) => void;\n\tprivate _emitOneFn: (item: T) => void;\n\tprivate _emitManyFn: (item: T[]) => void;\n\n\t/**\n\t *\n\t * @param onReturn A function that will be called when consuming the async iterable\n\t * has finished by the consumer, e.g the for-await-loop has be existed (break, return) early.\n\t * This is NOT called when resolving this source by its owner.\n\t */\n\tconstructor(onReturn?: () => Promise<void> | void) {\n\t\tthis._asyncIterable = new AsyncIterableObject(emitter => {\n\n\t\t\tif (earlyError) {\n\t\t\t\temitter.reject(earlyError);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (earlyItems) {\n\t\t\t\temitter.emitMany(earlyItems);\n\t\t\t}\n\t\t\tthis._errorFn = (error: Error) => emitter.reject(error);\n\t\t\tthis._emitOneFn = (item: T) => emitter.emitOne(item);\n\t\t\tthis._emitManyFn = (items: T[]) => emitter.emitMany(items);\n\t\t\treturn this._deferred.p;\n\t\t}, onReturn);\n\n\t\tlet earlyError: Error | undefined;\n\t\tlet earlyItems: T[] | undefined;\n\n\n\t\tthis._errorFn = (error: Error) => {\n\t\t\tif (!earlyError) {\n\t\t\t\tearlyError = error;\n\t\t\t}\n\t\t};\n\t\tthis._emitOneFn = (item: T) => {\n\t\t\tif (!earlyItems) {\n\t\t\t\tearlyItems = [];\n\t\t\t}\n\t\t\tearlyItems.push(item);\n\t\t};\n\t\tthis._emitManyFn = (items: T[]) => {\n\t\t\tif (!earlyItems) {\n\t\t\t\tearlyItems = items.slice();\n\t\t\t} else {\n\t\t\t\titems.forEach(item => earlyItems!.push(item));\n\t\t\t}\n\t\t};\n\t}\n\n\tget asyncIterable(): AsyncIterableObject<T> {\n\t\treturn this._asyncIterable;\n\t}\n\n\tresolve(): void {\n\t\tthis._deferred.complete();\n\t}\n\n\treject(error: Error): void {\n\t\tthis._errorFn(error);\n\t\tthis._deferred.complete();\n\t}\n\n\temitOne(item: T): void {\n\t\tthis._emitOneFn(item);\n\t}\n\n\temitMany(items: T[]) {\n\t\tthis._emitManyFn(items);\n\t}\n}\n\nexport function cancellableIterable<T>(iterableOrIterator: AsyncIterator<T> | AsyncIterable<T>, token: CancellationToken): AsyncIterableIterator<T> {\n\tconst iterator = Symbol.asyncIterator in iterableOrIterator ? iterableOrIterator[Symbol.asyncIterator]() : iterableOrIterator;\n\n\treturn {\n\t\tasync next(): Promise<IteratorResult<T>> {\n\t\t\tif (token.isCancellationRequested) {\n\t\t\t\treturn { done: true, value: undefined };\n\t\t\t}\n\t\t\tconst result = await raceCancellation(iterator.next(), token);\n\t\t\treturn result || { done: true, value: undefined };\n\t\t},\n\t\tthrow: iterator.throw?.bind(iterator),\n\t\treturn: iterator.return?.bind(iterator),\n\t\t[Symbol.asyncIterator]() {\n\t\t\treturn this;\n\t\t}\n\t};\n}\n\ntype ProducerConsumerValue<T> = {\n\tok: true;\n\tvalue: T;\n} | {\n\tok: false;\n\terror: Error;\n};\n\nclass ProducerConsumer<T> {\n\tprivate readonly _unsatisfiedConsumers: DeferredPromise<T>[] = [];\n\tprivate readonly _unconsumedValues: ProducerConsumerValue<T>[] = [];\n\tprivate _finalValue: ProducerConsumerValue<T> | undefined;\n\n\tpublic get hasFinalValue(): boolean {\n\t\treturn !!this._finalValue;\n\t}\n\n\tproduce(value: ProducerConsumerValue<T>): void {\n\t\tthis._ensureNoFinalValue();\n\t\tif (this._unsatisfiedConsumers.length > 0) {\n\t\t\tconst deferred = this._unsatisfiedConsumers.shift()!;\n\t\t\tthis._resolveOrRejectDeferred(deferred, value);\n\t\t} else {\n\t\t\tthis._unconsumedValues.push(value);\n\t\t}\n\t}\n\n\tproduceFinal(value: ProducerConsumerValue<T>): void {\n\t\tthis._ensureNoFinalValue();\n\t\tthis._finalValue = value;\n\t\tfor (const deferred of this._unsatisfiedConsumers) {\n\t\t\tthis._resolveOrRejectDeferred(deferred, value);\n\t\t}\n\t\tthis._unsatisfiedConsumers.length = 0;\n\t}\n\n\tprivate _ensureNoFinalValue(): void {\n\t\tif (this._finalValue) {\n\t\t\tthrow new BugIndicatingError('ProducerConsumer: cannot produce after final value has been set');\n\t\t}\n\t}\n\n\tprivate _resolveOrRejectDeferred(deferred: DeferredPromise<T>, value: ProducerConsumerValue<T>): void {\n\t\tif (value.ok) {\n\t\t\tdeferred.complete(value.value);\n\t\t} else {\n\t\t\tdeferred.error(value.error);\n\t\t}\n\t}\n\n\tconsume(): Promise<T> {\n\t\tif (this._unconsumedValues.length > 0 || this._finalValue) {\n\t\t\tconst value = this._unconsumedValues.length > 0 ? this._unconsumedValues.shift()! : this._finalValue!;\n\t\t\tif (value.ok) {\n\t\t\t\treturn Promise.resolve(value.value);\n\t\t\t} else {\n\t\t\t\treturn Promise.reject(value.error);\n\t\t\t}\n\t\t} else {\n\t\t\tconst deferred = new DeferredPromise<T>();\n\t\t\tthis._unsatisfiedConsumers.push(deferred);\n\t\t\treturn deferred.p;\n\t\t}\n\t}\n}\n\n/**\n * Important difference to AsyncIterableObject:\n * If it is iterated two times, the second iterator will not see the values emitted by the first iterator.\n */\nexport class AsyncIterableProducer<T> implements AsyncIterable<T> {\n\tprivate readonly _producerConsumer = new ProducerConsumer<IteratorResult<T>>();\n\n\tconstructor(executor: AsyncIterableExecutor<T>, private readonly _onReturn?: () => void) {\n\t\tqueueMicrotask(async () => {\n\t\t\tconst p = executor({\n\t\t\t\temitOne: value => this._producerConsumer.produce({ ok: true, value: { done: false, value: value } }),\n\t\t\t\temitMany: values => {\n\t\t\t\t\tfor (const value of values) {\n\t\t\t\t\t\tthis._producerConsumer.produce({ ok: true, value: { done: false, value: value } });\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\treject: error => this._finishError(error),\n\t\t\t});\n\n\t\t\tif (!this._producerConsumer.hasFinalValue) {\n\t\t\t\ttry {\n\t\t\t\t\tawait p;\n\t\t\t\t\tthis._finishOk();\n\t\t\t\t} catch (error) {\n\t\t\t\t\tthis._finishError(error);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic static fromArray<T>(items: T[]): AsyncIterableProducer<T> {\n\t\treturn new AsyncIterableProducer<T>((writer) => {\n\t\t\twriter.emitMany(items);\n\t\t});\n\t}\n\n\tpublic static fromPromise<T>(promise: Promise<T[]>): AsyncIterableProducer<T> {\n\t\treturn new AsyncIterableProducer<T>(async (emitter) => {\n\t\t\temitter.emitMany(await promise);\n\t\t});\n\t}\n\n\tpublic static fromPromisesResolveOrder<T>(promises: Promise<T>[]): AsyncIterableProducer<T> {\n\t\treturn new AsyncIterableProducer<T>(async (emitter) => {\n\t\t\tawait Promise.all(promises.map(async (p) => emitter.emitOne(await p)));\n\t\t});\n\t}\n\n\tpublic static merge<T>(iterables: AsyncIterable<T>[]): AsyncIterableProducer<T> {\n\t\treturn new AsyncIterableProducer(async (emitter) => {\n\t\t\tawait Promise.all(iterables.map(async (iterable) => {\n\t\t\t\tfor await (const item of iterable) {\n\t\t\t\t\temitter.emitOne(item);\n\t\t\t\t}\n\t\t\t}));\n\t\t});\n\t}\n\n\tpublic static EMPTY = AsyncIterableProducer.fromArray<any>([]);\n\n\tpublic static map<T, R>(iterable: AsyncIterable<T>, mapFn: (item: T) => R): AsyncIterableProducer<R> {\n\t\treturn new AsyncIterableProducer<R>(async (emitter) => {\n\t\t\tfor await (const item of iterable) {\n\t\t\t\temitter.emitOne(mapFn(item));\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic static tee<T>(iterable: AsyncIterable<T>): [AsyncIterableProducer<T>, AsyncIterableProducer<T>] {\n\t\tlet emitter1: AsyncIterableEmitter<T> | undefined;\n\t\tlet emitter2: AsyncIterableEmitter<T> | undefined;\n\n\t\tconst defer = new DeferredPromise<void>();\n\n\t\tconst start = async () => {\n\t\t\tif (!emitter1 || !emitter2) {\n\t\t\t\treturn; // not yet ready\n\t\t\t}\n\t\t\ttry {\n\t\t\t\tfor await (const item of iterable) {\n\t\t\t\t\temitter1.emitOne(item);\n\t\t\t\t\temitter2.emitOne(item);\n\t\t\t\t}\n\t\t\t} catch (err) {\n\t\t\t\temitter1.reject(err);\n\t\t\t\temitter2.reject(err);\n\t\t\t} finally {\n\t\t\t\tdefer.complete();\n\t\t\t}\n\t\t};\n\n\t\tconst p1 = new AsyncIterableProducer<T>(async (emitter) => {\n\t\t\temitter1 = emitter;\n\t\t\tstart();\n\t\t\treturn defer.p;\n\t\t});\n\t\tconst p2 = new AsyncIterableProducer<T>(async (emitter) => {\n\t\t\temitter2 = emitter;\n\t\t\tstart();\n\t\t\treturn defer.p;\n\t\t});\n\t\treturn [p1, p2];\n\t}\n\n\tpublic map<R>(mapFn: (item: T) => R): AsyncIterableProducer<R> {\n\t\treturn AsyncIterableProducer.map(this, mapFn);\n\t}\n\n\tpublic static coalesce<T>(iterable: AsyncIterable<T | undefined | null>): AsyncIterableProducer<T> {\n\t\treturn <AsyncIterableProducer<T>>AsyncIterableProducer.filter(iterable, item => !!item);\n\t}\n\n\tpublic coalesce(): AsyncIterableProducer<NonNullable<T>> {\n\t\treturn AsyncIterableProducer.coalesce(this) as AsyncIterableProducer<NonNullable<T>>;\n\t}\n\n\tpublic static filter<T>(iterable: AsyncIterable<T>, filterFn: (item: T) => boolean): AsyncIterableProducer<T> {\n\t\treturn new AsyncIterableProducer<T>(async (emitter) => {\n\t\t\tfor await (const item of iterable) {\n\t\t\t\tif (filterFn(item)) {\n\t\t\t\t\temitter.emitOne(item);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\tpublic filter<T2 extends T>(filterFn: (item: T) => item is T2): AsyncIterableProducer<T2>;\n\tpublic filter(filterFn: (item: T) => boolean): AsyncIterableProducer<T>;\n\tpublic filter(filterFn: (item: T) => boolean): AsyncIterableProducer<T> {\n\t\treturn AsyncIterableProducer.filter(this, filterFn);\n\t}\n\n\tprivate _finishOk(): void {\n\t\tif (!this._producerConsumer.hasFinalValue) {\n\t\t\tthis._producerConsumer.produceFinal({ ok: true, value: { done: true, value: undefined } });\n\t\t}\n\t}\n\n\tprivate _finishError(error: Error): void {\n\t\tif (!this._producerConsumer.hasFinalValue) {\n\t\t\tthis._producerConsumer.produceFinal({ ok: false, error: error });\n\t\t}\n\t\t// Warning: this can cause to dropped errors.\n\t}\n\n\tprivate readonly _iterator: AsyncIterator<T, void, void> = {\n\t\tnext: () => this._producerConsumer.consume(),\n\t\treturn: () => {\n\t\t\tthis._onReturn?.();\n\t\t\treturn Promise.resolve({ done: true, value: undefined });\n\t\t},\n\t\tthrow: async (e) => {\n\t\t\tthis._finishError(e);\n\t\t\treturn { done: true, value: undefined };\n\t\t},\n\t};\n\n\t[Symbol.asyncIterator](): AsyncIterator<T, void, void> {\n\t\treturn this._iterator;\n\t}\n}\n\nexport class CancelableAsyncIterableProducer<T> extends AsyncIterableProducer<T> {\n\tconstructor(\n\t\tprivate readonly _source: CancellationTokenSource,\n\t\texecutor: AsyncIterableExecutor<T>\n\t) {\n\t\tsuper(executor);\n\t}\n\n\tcancel(): void {\n\t\tthis._source.cancel();\n\t}\n}\n\n//#endregion\n\nexport const AsyncReaderEndOfStream = Symbol('AsyncReaderEndOfStream');\n\nexport class AsyncReader<T> {\n\tprivate _buffer: T[] = [];\n\tprivate _atEnd = false;\n\n\tpublic get endOfStream(): boolean { return this._buffer.length === 0 && this._atEnd; }\n\tprivate _extendBufferPromise: Promise<void> | undefined;\n\n\tconstructor(\n\t\tprivate readonly _source: AsyncIterator<T>\n\t) {\n\t}\n\n\tpublic async read(): Promise<T | typeof AsyncReaderEndOfStream> {\n\t\tif (this._buffer.length === 0 && !this._atEnd) {\n\t\t\tawait this._extendBuffer();\n\t\t}\n\t\tif (this._buffer.length === 0) {\n\t\t\treturn AsyncReaderEndOfStream;\n\t\t}\n\t\treturn this._buffer.shift()!;\n\t}\n\n\tpublic async readWhile(predicate: (value: T) => boolean, callback: (element: T) => unknown): Promise<void> {\n\t\tdo {\n\t\t\tconst piece = await this.peek();\n\t\t\tif (piece === AsyncReaderEndOfStream) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (!predicate(piece)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tawait this.read(); // consume\n\t\t\tawait callback(piece);\n\t\t} while (true);\n\t}\n\n\tpublic readBufferedOrThrow(): T | typeof AsyncReaderEndOfStream {\n\t\tconst value = this.peekBufferedOrThrow();\n\t\tthis._buffer.shift();\n\t\treturn value;\n\t}\n\n\tpublic async consumeToEnd(): Promise<void> {\n\t\twhile (!this.endOfStream) {\n\t\t\tawait this.read();\n\t\t}\n\t}\n\n\tpublic async peek(): Promise<T | typeof AsyncReaderEndOfStream> {\n\t\tif (this._buffer.length === 0 && !this._atEnd) {\n\t\t\tawait this._extendBuffer();\n\t\t}\n\t\tif (this._buffer.length === 0) {\n\t\t\treturn AsyncReaderEndOfStream;\n\t\t}\n\t\treturn this._buffer[0];\n\t}\n\n\tpublic peekBufferedOrThrow(): T | typeof AsyncReaderEndOfStream {\n\t\tif (this._buffer.length === 0) {\n\t\t\tif (this._atEnd) {\n\t\t\t\treturn AsyncReaderEndOfStream;\n\t\t\t}\n\t\t\tthrow new BugIndicatingError('No buffered elements');\n\t\t}\n\n\t\treturn this._buffer[0];\n\t}\n\n\tpublic async peekTimeout(timeoutMs: number): Promise<T | typeof AsyncReaderEndOfStream | undefined> {\n\t\tif (this._buffer.length === 0 && !this._atEnd) {\n\t\t\tawait raceTimeout(this._extendBuffer(), timeoutMs);\n\t\t}\n\t\tif (this._atEnd) {\n\t\t\treturn AsyncReaderEndOfStream;\n\t\t}\n\t\tif (this._buffer.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\t\treturn this._buffer[0];\n\t}\n\n\tprivate _extendBuffer(): Promise<void> {\n\t\tif (this._atEnd) {\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tif (!this._extendBufferPromise) {\n\t\t\tthis._extendBufferPromise = (async () => {\n\t\t\t\tconst { value, done } = await this._source.next();\n\t\t\t\tthis._extendBufferPromise = undefined;\n\t\t\t\tif (done) {\n\t\t\t\t\tthis._atEnd = true;\n\t\t\t\t} else {\n\t\t\t\t\tthis._buffer.push(value);\n\t\t\t\t}\n\t\t\t})();\n\t\t}\n\n\t\treturn this._extendBufferPromise;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nfunction createDecorator(mapFn: (fn: Function, key: string) => Function): MethodDecorator {\n\treturn (_target: Object, key: string | symbol, descriptor: TypedPropertyDescriptor<any>) => {\n\t\tlet fnKey: 'value' | 'get' | null = null;\n\t\tlet fn: Function | null = null;\n\n\t\tif (typeof descriptor.value === 'function') {\n\t\t\tfnKey = 'value';\n\t\t\tfn = descriptor.value;\n\t\t} else if (typeof descriptor.get === 'function') {\n\t\t\tfnKey = 'get';\n\t\t\tfn = descriptor.get;\n\t\t}\n\n\t\tif (!fn || typeof key === 'symbol') {\n\t\t\tthrow new Error('not supported');\n\t\t}\n\n\t\tdescriptor[fnKey!] = mapFn(fn, key);\n\t};\n}\n\nexport function memoize(_target: Object, key: string, descriptor: PropertyDescriptor) {\n\tlet fnKey: 'value' | 'get' | null = null;\n\tlet fn: Function | null = null;\n\n\tif (typeof descriptor.value === 'function') {\n\t\tfnKey = 'value';\n\t\tfn = descriptor.value;\n\n\t\tif (fn!.length !== 0) {\n\t\t\tconsole.warn('Memoize should only be used in functions with zero parameters');\n\t\t}\n\t} else if (typeof descriptor.get === 'function') {\n\t\tfnKey = 'get';\n\t\tfn = descriptor.get;\n\t}\n\n\tif (!fn) {\n\t\tthrow new Error('not supported');\n\t}\n\n\tconst memoizeKey = `$memoize$${key}`;\n\tdescriptor[fnKey!] = function (...args: any[]) {\n\t\tif (!this.hasOwnProperty(memoizeKey)) {\n\t\t\tObject.defineProperty(this, memoizeKey, {\n\t\t\t\tconfigurable: false,\n\t\t\t\tenumerable: false,\n\t\t\t\twritable: false,\n\t\t\t\tvalue: fn.apply(this, args)\n\t\t\t});\n\t\t}\n\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\treturn (this as any)[memoizeKey];\n\t};\n}\n\nexport interface IDebounceReducer<T> {\n\t(previousValue: T, ...args: any[]): T;\n}\n\nexport function debounce<T>(delay: number, reducer?: IDebounceReducer<T>, initialValueProvider?: () => T) {\n\treturn createDecorator((fn, key) => {\n\t\tconst timerKey = `$debounce$${key}`;\n\t\tconst resultKey = `$debounce$result$${key}`;\n\n\t\treturn function (this: any, ...args: any[]) {\n\t\t\tif (!this[resultKey]) {\n\t\t\t\tthis[resultKey] = initialValueProvider ? initialValueProvider() : undefined;\n\t\t\t}\n\n\t\t\tclearTimeout(this[timerKey]);\n\n\t\t\tif (reducer) {\n\t\t\t\tthis[resultKey] = reducer(this[resultKey], ...args);\n\t\t\t\targs = [this[resultKey]];\n\t\t\t}\n\n\t\t\tthis[timerKey] = setTimeout(() => {\n\t\t\t\tfn.apply(this, args);\n\t\t\t\tthis[resultKey] = initialValueProvider ? initialValueProvider() : undefined;\n\t\t\t}, delay);\n\t\t};\n\t});\n}\n\nexport function throttle<T>(delay: number, reducer?: IDebounceReducer<T>, initialValueProvider?: () => T) {\n\treturn createDecorator((fn, key) => {\n\t\tconst timerKey = `$throttle$timer$${key}`;\n\t\tconst resultKey = `$throttle$result$${key}`;\n\t\tconst lastRunKey = `$throttle$lastRun$${key}`;\n\t\tconst pendingKey = `$throttle$pending$${key}`;\n\n\t\treturn function (this: any, ...args: any[]) {\n\t\t\tif (!this[resultKey]) {\n\t\t\t\tthis[resultKey] = initialValueProvider ? initialValueProvider() : undefined;\n\t\t\t}\n\t\t\tif (this[lastRunKey] === null || this[lastRunKey] === undefined) {\n\t\t\t\tthis[lastRunKey] = -Number.MAX_VALUE;\n\t\t\t}\n\n\t\t\tif (reducer) {\n\t\t\t\tthis[resultKey] = reducer(this[resultKey], ...args);\n\t\t\t}\n\n\t\t\tif (this[pendingKey]) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst nextTime = this[lastRunKey] + delay;\n\t\t\tif (nextTime <= Date.now()) {\n\t\t\t\tthis[lastRunKey] = Date.now();\n\t\t\t\tfn.apply(this, [this[resultKey]]);\n\t\t\t\tthis[resultKey] = initialValueProvider ? initialValueProvider() : undefined;\n\t\t\t} else {\n\t\t\t\tthis[pendingKey] = true;\n\t\t\t\tthis[timerKey] = setTimeout(() => {\n\t\t\t\t\tthis[pendingKey] = false;\n\t\t\t\t\tthis[lastRunKey] = Date.now();\n\t\t\t\t\tfn.apply(this, [this[resultKey]]);\n\t\t\t\t\tthis[resultKey] = initialValueProvider ? initialValueProvider() : undefined;\n\t\t\t\t}, nextTime - Date.now());\n\t\t\t}\n\t\t};\n\t});\n}\n\nexport { cancelPreviousCalls } from './decorators/cancelPreviousCalls.js';\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer } from './buffer.js';\nimport { URI, UriComponents } from './uri.js';\nimport { MarshalledId } from './marshallingIds.js';\n\nexport function stringify(obj: unknown): string {\n\treturn JSON.stringify(obj, replacer);\n}\n\nexport function parse(text: string): any {\n\tlet data = JSON.parse(text);\n\tdata = revive(data);\n\treturn data;\n}\n\nexport interface MarshalledObject {\n\t$mid: MarshalledId;\n}\n\nfunction replacer(key: string, value: any): any {\n\t// URI is done via toJSON-member\n\tif (value instanceof RegExp) {\n\t\treturn {\n\t\t\t$mid: MarshalledId.Regexp,\n\t\t\tsource: value.source,\n\t\t\tflags: value.flags,\n\t\t};\n\t}\n\treturn value;\n}\n\n\ntype Deserialize<T> = T extends UriComponents ? URI\n\t: T extends VSBuffer ? VSBuffer\n\t: T extends object\n\t? Revived<T>\n\t: T;\n\nexport type Revived<T> = { [K in keyof T]: Deserialize<T[K]> };\n\nexport function revive<T = any>(obj: any, depth = 0): Revived<T> {\n\tif (!obj || depth > 200) {\n\t\treturn obj;\n\t}\n\n\tif (typeof obj === 'object') {\n\n\t\tswitch ((<MarshalledObject>obj).$mid) {\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tcase MarshalledId.Uri: return <any>URI.revive(obj);\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tcase MarshalledId.Regexp: return <any>new RegExp(obj.source, obj.flags);\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\tcase MarshalledId.Date: return <any>new Date(obj.source);\n\t\t}\n\n\t\tif (\n\t\t\tobj instanceof VSBuffer\n\t\t\t|| obj instanceof Uint8Array\n\t\t) {\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\treturn <any>obj;\n\t\t}\n\n\t\tif (Array.isArray(obj)) {\n\t\t\tfor (let i = 0; i < obj.length; ++i) {\n\t\t\t\tobj[i] = revive(obj[i], depth + 1);\n\t\t\t}\n\t\t} else {\n\t\t\t// walk object\n\t\t\tfor (const key in obj) {\n\t\t\t\tif (Object.hasOwnProperty.call(obj, key)) {\n\t\t\t\t\tobj[key] = revive(obj[key], depth + 1);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn obj;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { getRandomElement } from '../../../common/arrays.js';\nimport { CancelablePromise, createCancelablePromise, timeout } from '../../../common/async.js';\nimport { VSBuffer } from '../../../common/buffer.js';\nimport { CancellationToken, CancellationTokenSource } from '../../../common/cancellation.js';\nimport { memoize } from '../../../common/decorators.js';\nimport { CancellationError, ErrorNoTelemetry } from '../../../common/errors.js';\nimport { Emitter, Event, EventMultiplexer, Relay } from '../../../common/event.js';\nimport { createSingleCallFunction } from '../../../common/functional.js';\nimport { DisposableStore, dispose, IDisposable, toDisposable } from '../../../common/lifecycle.js';\nimport { revive } from '../../../common/marshalling.js';\nimport * as strings from '../../../common/strings.js';\nimport { isFunction, isUndefinedOrNull } from '../../../common/types.js';\n\n/**\n * An `IChannel` is an abstraction over a collection of commands.\n * You can `call` several commands on a channel, each taking at\n * most one single argument. A `call` always returns a promise\n * with at most one single return value.\n */\nexport interface IChannel {\n\tcall<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T>;\n\tlisten<T>(event: string, arg?: any): Event<T>;\n}\n\n/**\n * An `IServerChannel` is the counter part to `IChannel`,\n * on the server-side. You should implement this interface\n * if you'd like to handle remote promises or events.\n */\nexport interface IServerChannel<TContext = string> {\n\tcall<T>(ctx: TContext, command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T>;\n\tlisten<T>(ctx: TContext, event: string, arg?: any): Event<T>;\n}\n\nconst enum RequestType {\n\tPromise = 100,\n\tPromiseCancel = 101,\n\tEventListen = 102,\n\tEventDispose = 103\n}\n\nfunction requestTypeToStr(type: RequestType): string {\n\tswitch (type) {\n\t\tcase RequestType.Promise:\n\t\t\treturn 'req';\n\t\tcase RequestType.PromiseCancel:\n\t\t\treturn 'cancel';\n\t\tcase RequestType.EventListen:\n\t\t\treturn 'subscribe';\n\t\tcase RequestType.EventDispose:\n\t\t\treturn 'unsubscribe';\n\t}\n}\n\ntype IRawPromiseRequest = { type: RequestType.Promise; id: number; channelName: string; name: string; arg: any };\ntype IRawPromiseCancelRequest = { type: RequestType.PromiseCancel; id: number };\ntype IRawEventListenRequest = { type: RequestType.EventListen; id: number; channelName: string; name: string; arg: any };\ntype IRawEventDisposeRequest = { type: RequestType.EventDispose; id: number };\ntype IRawRequest = IRawPromiseRequest | IRawPromiseCancelRequest | IRawEventListenRequest | IRawEventDisposeRequest;\n\nconst enum ResponseType {\n\tInitialize = 200,\n\tPromiseSuccess = 201,\n\tPromiseError = 202,\n\tPromiseErrorObj = 203,\n\tEventFire = 204\n}\n\nfunction responseTypeToStr(type: ResponseType): string {\n\tswitch (type) {\n\t\tcase ResponseType.Initialize:\n\t\t\treturn `init`;\n\t\tcase ResponseType.PromiseSuccess:\n\t\t\treturn `reply:`;\n\t\tcase ResponseType.PromiseError:\n\t\tcase ResponseType.PromiseErrorObj:\n\t\t\treturn `replyErr:`;\n\t\tcase ResponseType.EventFire:\n\t\t\treturn `event:`;\n\t}\n}\n\ntype IRawInitializeResponse = { type: ResponseType.Initialize };\ntype IRawPromiseSuccessResponse = { type: ResponseType.PromiseSuccess; id: number; data: any };\ntype IRawPromiseErrorResponse = { type: ResponseType.PromiseError; id: number; data: { message: string; name: string; stack: string[] | undefined } };\ntype IRawPromiseErrorObjResponse = { type: ResponseType.PromiseErrorObj; id: number; data: any };\ntype IRawEventFireResponse = { type: ResponseType.EventFire; id: number; data: any };\ntype IRawResponse = IRawInitializeResponse | IRawPromiseSuccessResponse | IRawPromiseErrorResponse | IRawPromiseErrorObjResponse | IRawEventFireResponse;\n\ninterface IHandler {\n\t(response: IRawResponse): void;\n}\n\nexport interface IMessagePassingProtocol {\n\tsend(buffer: VSBuffer): void;\n\treadonly onMessage: Event<VSBuffer>;\n\t/**\n\t * Wait for the write buffer (if applicable) to become empty.\n\t */\n\tdrain?(): Promise<void>;\n}\n\nenum State {\n\tUninitialized,\n\tIdle\n}\n\n/**\n * An `IChannelServer` hosts a collection of channels. You are\n * able to register channels onto it, provided a channel name.\n */\nexport interface IChannelServer<TContext = string> {\n\tregisterChannel(channelName: string, channel: IServerChannel<TContext>): void;\n}\n\n/**\n * An `IChannelClient` has access to a collection of channels. You\n * are able to get those channels, given their channel name.\n */\nexport interface IChannelClient {\n\tgetChannel<T extends IChannel>(channelName: string): T;\n}\n\nexport interface Client<TContext> {\n\treadonly ctx: TContext;\n}\n\nexport interface IConnectionHub<TContext> {\n\treadonly connections: Connection<TContext>[];\n\treadonly onDidAddConnection: Event<Connection<TContext>>;\n\treadonly onDidRemoveConnection: Event<Connection<TContext>>;\n}\n\n/**\n * An `IClientRouter` is responsible for routing calls to specific\n * channels, in scenarios in which there are multiple possible\n * channels (each from a separate client) to pick from.\n */\nexport interface IClientRouter<TContext = string> {\n\trouteCall(hub: IConnectionHub<TContext>, command: string, arg?: any, cancellationToken?: CancellationToken): Promise<Client<TContext>>;\n\trouteEvent(hub: IConnectionHub<TContext>, event: string, arg?: any): Promise<Client<TContext>>;\n}\n\n/**\n * Similar to the `IChannelClient`, you can get channels from this\n * collection of channels. The difference being that in the\n * `IRoutingChannelClient`, there are multiple clients providing\n * the same channel. You'll need to pass in an `IClientRouter` in\n * order to pick the right one.\n */\nexport interface IRoutingChannelClient<TContext = string> {\n\tgetChannel<T extends IChannel>(channelName: string, router?: IClientRouter<TContext>): T;\n}\n\ninterface IReader {\n\tread(bytes: number): VSBuffer;\n}\n\ninterface IWriter {\n\twrite(buffer: VSBuffer): void;\n}\n\n\n/**\n * @see https://en.wikipedia.org/wiki/Variable-length_quantity\n */\nfunction readIntVQL(reader: IReader) {\n\tlet value = 0;\n\tfor (let n = 0; ; n += 7) {\n\t\tconst next = reader.read(1);\n\t\tvalue |= (next.buffer[0] & 0b01111111) << n;\n\t\tif (!(next.buffer[0] & 0b10000000)) {\n\t\t\treturn value;\n\t\t}\n\t}\n}\n\nconst vqlZero = createOneByteBuffer(0);\n\n/**\n * @see https://en.wikipedia.org/wiki/Variable-length_quantity\n */\nfunction writeInt32VQL(writer: IWriter, value: number) {\n\tif (value === 0) {\n\t\twriter.write(vqlZero);\n\t\treturn;\n\t}\n\n\tlet len = 0;\n\tfor (let v2 = value; v2 !== 0; v2 = v2 >>> 7) {\n\t\tlen++;\n\t}\n\n\tconst scratch = VSBuffer.alloc(len);\n\tfor (let i = 0; value !== 0; i++) {\n\t\tscratch.buffer[i] = value & 0b01111111;\n\t\tvalue = value >>> 7;\n\t\tif (value > 0) {\n\t\t\tscratch.buffer[i] |= 0b10000000;\n\t\t}\n\t}\n\n\twriter.write(scratch);\n}\n\nexport class BufferReader implements IReader {\n\n\tprivate pos = 0;\n\n\tconstructor(private buffer: VSBuffer) { }\n\n\tread(bytes: number): VSBuffer {\n\t\tconst result = this.buffer.slice(this.pos, this.pos + bytes);\n\t\tthis.pos += result.byteLength;\n\t\treturn result;\n\t}\n}\n\nexport class BufferWriter implements IWriter {\n\n\tprivate buffers: VSBuffer[] = [];\n\n\tget buffer(): VSBuffer {\n\t\treturn VSBuffer.concat(this.buffers);\n\t}\n\n\twrite(buffer: VSBuffer): void {\n\t\tthis.buffers.push(buffer);\n\t}\n}\n\nenum DataType {\n\tUndefined = 0,\n\tString = 1,\n\tBuffer = 2,\n\tVSBuffer = 3,\n\tArray = 4,\n\tObject = 5,\n\tInt = 6\n}\n\nfunction createOneByteBuffer(value: number): VSBuffer {\n\tconst result = VSBuffer.alloc(1);\n\tresult.writeUInt8(value, 0);\n\treturn result;\n}\n\nconst BufferPresets = {\n\tUndefined: createOneByteBuffer(DataType.Undefined),\n\tString: createOneByteBuffer(DataType.String),\n\tBuffer: createOneByteBuffer(DataType.Buffer),\n\tVSBuffer: createOneByteBuffer(DataType.VSBuffer),\n\tArray: createOneByteBuffer(DataType.Array),\n\tObject: createOneByteBuffer(DataType.Object),\n\tUint: createOneByteBuffer(DataType.Int),\n};\n\nexport function serialize(writer: IWriter, data: any): void {\n\tif (typeof data === 'undefined') {\n\t\twriter.write(BufferPresets.Undefined);\n\t} else if (typeof data === 'string') {\n\t\tconst buffer = VSBuffer.fromString(data);\n\t\twriter.write(BufferPresets.String);\n\t\twriteInt32VQL(writer, buffer.byteLength);\n\t\twriter.write(buffer);\n\t} else if (VSBuffer.isNativeBuffer(data)) {\n\t\tconst buffer = VSBuffer.wrap(data);\n\t\twriter.write(BufferPresets.Buffer);\n\t\twriteInt32VQL(writer, buffer.byteLength);\n\t\twriter.write(buffer);\n\t} else if (data instanceof VSBuffer) {\n\t\twriter.write(BufferPresets.VSBuffer);\n\t\twriteInt32VQL(writer, data.byteLength);\n\t\twriter.write(data);\n\t} else if (Array.isArray(data)) {\n\t\twriter.write(BufferPresets.Array);\n\t\twriteInt32VQL(writer, data.length);\n\n\t\tfor (const el of data) {\n\t\t\tserialize(writer, el);\n\t\t}\n\t} else if (typeof data === 'number' && (data | 0) === data) {\n\t\t// write a vql if it's a number that we can do bitwise operations on\n\t\twriter.write(BufferPresets.Uint);\n\t\twriteInt32VQL(writer, data);\n\t} else {\n\t\tconst buffer = VSBuffer.fromString(JSON.stringify(data));\n\t\twriter.write(BufferPresets.Object);\n\t\twriteInt32VQL(writer, buffer.byteLength);\n\t\twriter.write(buffer);\n\t}\n}\n\nexport function deserialize(reader: IReader): any {\n\tconst type = reader.read(1).readUInt8(0);\n\n\tswitch (type) {\n\t\tcase DataType.Undefined: return undefined;\n\t\tcase DataType.String: return reader.read(readIntVQL(reader)).toString();\n\t\tcase DataType.Buffer: return reader.read(readIntVQL(reader)).buffer;\n\t\tcase DataType.VSBuffer: return reader.read(readIntVQL(reader));\n\t\tcase DataType.Array: {\n\t\t\tconst length = readIntVQL(reader);\n\t\t\tconst result: any[] = [];\n\n\t\t\tfor (let i = 0; i < length; i++) {\n\t\t\t\tresult.push(deserialize(reader));\n\t\t\t}\n\n\t\t\treturn result;\n\t\t}\n\t\tcase DataType.Object: return JSON.parse(reader.read(readIntVQL(reader)).toString());\n\t\tcase DataType.Int: return readIntVQL(reader);\n\t}\n}\n\ninterface PendingRequest {\n\trequest: IRawPromiseRequest | IRawEventListenRequest;\n\ttimeoutTimer: Timeout;\n}\n\nexport class ChannelServer<TContext = string> implements IChannelServer<TContext>, IDisposable {\n\n\tprivate channels = new Map<string, IServerChannel<TContext>>();\n\tprivate activeRequests = new Map<number, IDisposable>();\n\tprivate protocolListener: IDisposable | null;\n\n\t// Requests might come in for channels which are not yet registered.\n\t// They will timeout after `timeoutDelay`.\n\tprivate pendingRequests = new Map<string, PendingRequest[]>();\n\n\tconstructor(private protocol: IMessagePassingProtocol, private ctx: TContext, private logger: IIPCLogger | null = null, private timeoutDelay = 1000) {\n\t\tthis.protocolListener = this.protocol.onMessage(msg => this.onRawMessage(msg));\n\t\tthis.sendResponse({ type: ResponseType.Initialize });\n\t}\n\n\tregisterChannel(channelName: string, channel: IServerChannel<TContext>): void {\n\t\tthis.channels.set(channelName, channel);\n\n\t\t// https://github.com/microsoft/vscode/issues/72531\n\t\tsetTimeout(() => this.flushPendingRequests(channelName), 0);\n\t}\n\n\tprivate sendResponse(response: IRawResponse): void {\n\t\tswitch (response.type) {\n\t\t\tcase ResponseType.Initialize: {\n\t\t\t\tconst msgLength = this.send([response.type]);\n\t\t\t\tthis.logger?.logOutgoing(msgLength, 0, RequestInitiator.OtherSide, responseTypeToStr(response.type));\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcase ResponseType.PromiseSuccess:\n\t\t\tcase ResponseType.PromiseError:\n\t\t\tcase ResponseType.EventFire:\n\t\t\tcase ResponseType.PromiseErrorObj: {\n\t\t\t\tconst msgLength = this.send([response.type, response.id], response.data);\n\t\t\t\tthis.logger?.logOutgoing(msgLength, response.id, RequestInitiator.OtherSide, responseTypeToStr(response.type), response.data);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate send(header: unknown, body: any = undefined): number {\n\t\tconst writer = new BufferWriter();\n\t\tserialize(writer, header);\n\t\tserialize(writer, body);\n\t\treturn this.sendBuffer(writer.buffer);\n\t}\n\n\tprivate sendBuffer(message: VSBuffer): number {\n\t\ttry {\n\t\t\tthis.protocol.send(message);\n\t\t\treturn message.byteLength;\n\t\t} catch (err) {\n\t\t\t// noop\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tprivate onRawMessage(message: VSBuffer): void {\n\t\tconst reader = new BufferReader(message);\n\t\tconst header = deserialize(reader);\n\t\tconst body = deserialize(reader);\n\t\tconst type = header[0] as RequestType;\n\n\t\tswitch (type) {\n\t\t\tcase RequestType.Promise:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, header[1], RequestInitiator.OtherSide, `${requestTypeToStr(type)}: ${header[2]}.${header[3]}`, body);\n\t\t\t\treturn this.onPromise({ type, id: header[1], channelName: header[2], name: header[3], arg: body });\n\t\t\tcase RequestType.EventListen:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, header[1], RequestInitiator.OtherSide, `${requestTypeToStr(type)}: ${header[2]}.${header[3]}`, body);\n\t\t\t\treturn this.onEventListen({ type, id: header[1], channelName: header[2], name: header[3], arg: body });\n\t\t\tcase RequestType.PromiseCancel:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, header[1], RequestInitiator.OtherSide, `${requestTypeToStr(type)}`);\n\t\t\t\treturn this.disposeActiveRequest({ type, id: header[1] });\n\t\t\tcase RequestType.EventDispose:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, header[1], RequestInitiator.OtherSide, `${requestTypeToStr(type)}`);\n\t\t\t\treturn this.disposeActiveRequest({ type, id: header[1] });\n\t\t}\n\t}\n\n\tprivate onPromise(request: IRawPromiseRequest): void {\n\t\tconst channel = this.channels.get(request.channelName);\n\n\t\tif (!channel) {\n\t\t\tthis.collectPendingRequest(request);\n\t\t\treturn;\n\t\t}\n\n\t\tconst cancellationTokenSource = new CancellationTokenSource();\n\t\tlet promise: Promise<any>;\n\n\t\ttry {\n\t\t\tpromise = channel.call(this.ctx, request.name, request.arg, cancellationTokenSource.token);\n\t\t} catch (err) {\n\t\t\tpromise = Promise.reject(err);\n\t\t}\n\n\t\tconst id = request.id;\n\n\t\tpromise.then(data => {\n\t\t\tthis.sendResponse({ id, data, type: ResponseType.PromiseSuccess });\n\t\t}, err => {\n\t\t\tif (err instanceof Error) {\n\t\t\t\tthis.sendResponse({\n\t\t\t\t\tid, data: {\n\t\t\t\t\t\tmessage: err.message,\n\t\t\t\t\t\tname: err.name,\n\t\t\t\t\t\tstack: err.stack ? err.stack.split('\\n') : undefined\n\t\t\t\t\t}, type: ResponseType.PromiseError\n\t\t\t\t});\n\t\t\t} else {\n\t\t\t\tthis.sendResponse({ id, data: err, type: ResponseType.PromiseErrorObj });\n\t\t\t}\n\t\t}).finally(() => {\n\t\t\tdisposable.dispose();\n\t\t\tthis.activeRequests.delete(request.id);\n\t\t});\n\n\t\tconst disposable = toDisposable(() => cancellationTokenSource.cancel());\n\t\tthis.activeRequests.set(request.id, disposable);\n\t}\n\n\tprivate onEventListen(request: IRawEventListenRequest): void {\n\t\tconst channel = this.channels.get(request.channelName);\n\n\t\tif (!channel) {\n\t\t\tthis.collectPendingRequest(request);\n\t\t\treturn;\n\t\t}\n\n\t\tconst id = request.id;\n\t\tconst event = channel.listen(this.ctx, request.name, request.arg);\n\t\tconst disposable = event(data => this.sendResponse({ id, data, type: ResponseType.EventFire }));\n\n\t\tthis.activeRequests.set(request.id, disposable);\n\t}\n\n\tprivate disposeActiveRequest(request: IRawRequest): void {\n\t\tconst disposable = this.activeRequests.get(request.id);\n\n\t\tif (disposable) {\n\t\t\tdisposable.dispose();\n\t\t\tthis.activeRequests.delete(request.id);\n\t\t}\n\t}\n\n\tprivate collectPendingRequest(request: IRawPromiseRequest | IRawEventListenRequest): void {\n\t\tlet pendingRequests = this.pendingRequests.get(request.channelName);\n\n\t\tif (!pendingRequests) {\n\t\t\tpendingRequests = [];\n\t\t\tthis.pendingRequests.set(request.channelName, pendingRequests);\n\t\t}\n\n\t\tconst timer = setTimeout(() => {\n\t\t\tconsole.error(`Unknown channel: ${request.channelName}`);\n\n\t\t\tif (request.type === RequestType.Promise) {\n\t\t\t\tthis.sendResponse({\n\t\t\t\t\tid: request.id,\n\t\t\t\t\tdata: { name: 'Unknown channel', message: `Channel name '${request.channelName}' timed out after ${this.timeoutDelay}ms`, stack: undefined },\n\t\t\t\t\ttype: ResponseType.PromiseError\n\t\t\t\t});\n\t\t\t}\n\t\t}, this.timeoutDelay);\n\n\t\tpendingRequests.push({ request, timeoutTimer: timer });\n\t}\n\n\tprivate flushPendingRequests(channelName: string): void {\n\t\tconst requests = this.pendingRequests.get(channelName);\n\n\t\tif (requests) {\n\t\t\tfor (const request of requests) {\n\t\t\t\tclearTimeout(request.timeoutTimer);\n\n\t\t\t\tswitch (request.request.type) {\n\t\t\t\t\tcase RequestType.Promise: this.onPromise(request.request); break;\n\t\t\t\t\tcase RequestType.EventListen: this.onEventListen(request.request); break;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthis.pendingRequests.delete(channelName);\n\t\t}\n\t}\n\n\tpublic dispose(): void {\n\t\tif (this.protocolListener) {\n\t\t\tthis.protocolListener.dispose();\n\t\t\tthis.protocolListener = null;\n\t\t}\n\t\tdispose(this.activeRequests.values());\n\t\tthis.activeRequests.clear();\n\t}\n}\n\nexport const enum RequestInitiator {\n\tLocalSide = 0,\n\tOtherSide = 1\n}\n\nexport interface IIPCLogger {\n\tlogIncoming(msgLength: number, requestId: number, initiator: RequestInitiator, str: string, data?: any): void;\n\tlogOutgoing(msgLength: number, requestId: number, initiator: RequestInitiator, str: string, data?: any): void;\n}\n\nexport class ChannelClient implements IChannelClient, IDisposable {\n\n\tprivate isDisposed = false;\n\tprivate state: State = State.Uninitialized;\n\tprivate activeRequests = new Set<IDisposable>();\n\tprivate handlers = new Map<number, IHandler>();\n\tprivate lastRequestId = 0;\n\tprivate protocolListener: IDisposable | null;\n\tprivate logger: IIPCLogger | null;\n\n\tprivate readonly _onDidInitialize = new Emitter<void>();\n\treadonly onDidInitialize = this._onDidInitialize.event;\n\n\tconstructor(private protocol: IMessagePassingProtocol, logger: IIPCLogger | null = null) {\n\t\tthis.protocolListener = this.protocol.onMessage(msg => this.onBuffer(msg));\n\t\tthis.logger = logger;\n\t}\n\n\tgetChannel<T extends IChannel>(channelName: string): T {\n\t\tconst that = this;\n\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\treturn {\n\t\t\tcall(command: string, arg?: any, cancellationToken?: CancellationToken) {\n\t\t\t\tif (that.isDisposed) {\n\t\t\t\t\treturn Promise.reject(new CancellationError());\n\t\t\t\t}\n\t\t\t\treturn that.requestPromise(channelName, command, arg, cancellationToken);\n\t\t\t},\n\t\t\tlisten(event: string, arg: any) {\n\t\t\t\tif (that.isDisposed) {\n\t\t\t\t\treturn Event.None;\n\t\t\t\t}\n\t\t\t\treturn that.requestEvent(channelName, event, arg);\n\t\t\t}\n\t\t} as T;\n\t}\n\n\tprivate requestPromise(channelName: string, name: string, arg?: any, cancellationToken = CancellationToken.None): Promise<unknown> {\n\t\tconst id = this.lastRequestId++;\n\t\tconst type = RequestType.Promise;\n\t\tconst request: IRawRequest = { id, type, channelName, name, arg };\n\n\t\tif (cancellationToken.isCancellationRequested) {\n\t\t\treturn Promise.reject(new CancellationError());\n\t\t}\n\n\t\tlet disposable: IDisposable;\n\t\tlet disposableWithRequestCancel: IDisposable;\n\n\t\tconst result = new Promise((c, e) => {\n\t\t\tif (cancellationToken.isCancellationRequested) {\n\t\t\t\treturn e(new CancellationError());\n\t\t\t}\n\n\t\t\tconst doRequest = () => {\n\t\t\t\tconst handler: IHandler = response => {\n\t\t\t\t\tswitch (response.type) {\n\t\t\t\t\t\tcase ResponseType.PromiseSuccess:\n\t\t\t\t\t\t\tthis.handlers.delete(id);\n\t\t\t\t\t\t\tc(response.data);\n\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\tcase ResponseType.PromiseError: {\n\t\t\t\t\t\t\tthis.handlers.delete(id);\n\t\t\t\t\t\t\tconst error = new Error(response.data.message);\n\t\t\t\t\t\t\terror.stack = Array.isArray(response.data.stack) ? response.data.stack.join('\\n') : response.data.stack;\n\t\t\t\t\t\t\terror.name = response.data.name;\n\t\t\t\t\t\t\te(error);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tcase ResponseType.PromiseErrorObj:\n\t\t\t\t\t\t\tthis.handlers.delete(id);\n\t\t\t\t\t\t\te(response.data);\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t};\n\n\t\t\t\tthis.handlers.set(id, handler);\n\t\t\t\tthis.sendRequest(request);\n\t\t\t};\n\n\t\t\tlet uninitializedPromise: CancelablePromise<void> | null = null;\n\t\t\tif (this.state === State.Idle) {\n\t\t\t\tdoRequest();\n\t\t\t} else {\n\t\t\t\tuninitializedPromise = createCancelablePromise(_ => this.whenInitialized());\n\t\t\t\tuninitializedPromise.then(() => {\n\t\t\t\t\tuninitializedPromise = null;\n\t\t\t\t\tdoRequest();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\tconst cancel = () => {\n\t\t\t\tif (uninitializedPromise) {\n\t\t\t\t\tuninitializedPromise.cancel();\n\t\t\t\t\tuninitializedPromise = null;\n\t\t\t\t} else {\n\t\t\t\t\tthis.sendRequest({ id, type: RequestType.PromiseCancel });\n\t\t\t\t}\n\n\t\t\t\te(new CancellationError());\n\t\t\t};\n\n\t\t\tdisposable = cancellationToken.onCancellationRequested(cancel);\n\t\t\tdisposableWithRequestCancel = {\n\t\t\t\tdispose: createSingleCallFunction(() => {\n\t\t\t\t\tcancel();\n\t\t\t\t\tdisposable.dispose();\n\t\t\t\t})\n\t\t\t};\n\n\t\t\tthis.activeRequests.add(disposableWithRequestCancel);\n\t\t});\n\n\t\treturn result.finally(() => {\n\t\t\tdisposable?.dispose(); // Seen as undefined in tests.\n\t\t\tthis.activeRequests.delete(disposableWithRequestCancel);\n\t\t});\n\t}\n\n\tprivate requestEvent(channelName: string, name: string, arg?: any): Event<any> {\n\t\tconst id = this.lastRequestId++;\n\t\tconst type = RequestType.EventListen;\n\t\tconst request: IRawRequest = { id, type, channelName, name, arg };\n\n\t\tlet uninitializedPromise: CancelablePromise<void> | null = null;\n\n\t\tconst emitter = new Emitter<any>({\n\t\t\tonWillAddFirstListener: () => {\n\t\t\t\tconst doRequest = () => {\n\t\t\t\t\tthis.activeRequests.add(emitter);\n\t\t\t\t\tthis.sendRequest(request);\n\t\t\t\t};\n\t\t\t\tif (this.state === State.Idle) {\n\t\t\t\t\tdoRequest();\n\t\t\t\t} else {\n\t\t\t\t\tuninitializedPromise = createCancelablePromise(_ => this.whenInitialized());\n\t\t\t\t\tuninitializedPromise.then(() => {\n\t\t\t\t\t\tuninitializedPromise = null;\n\t\t\t\t\t\tdoRequest();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t},\n\t\t\tonDidRemoveLastListener: () => {\n\t\t\t\tif (uninitializedPromise) {\n\t\t\t\t\tuninitializedPromise.cancel();\n\t\t\t\t\tuninitializedPromise = null;\n\t\t\t\t} else {\n\t\t\t\t\tthis.activeRequests.delete(emitter);\n\t\t\t\t\tthis.sendRequest({ id, type: RequestType.EventDispose });\n\t\t\t\t}\n\t\t\t\tthis.handlers.delete(id);\n\t\t\t}\n\t\t});\n\n\t\tconst handler: IHandler = (res: IRawResponse) => emitter.fire((res as IRawEventFireResponse).data);\n\t\tthis.handlers.set(id, handler);\n\n\t\treturn emitter.event;\n\t}\n\n\tprivate sendRequest(request: IRawRequest): void {\n\t\tswitch (request.type) {\n\t\t\tcase RequestType.Promise:\n\t\t\tcase RequestType.EventListen: {\n\t\t\t\tconst msgLength = this.send([request.type, request.id, request.channelName, request.name], request.arg);\n\t\t\t\tthis.logger?.logOutgoing(msgLength, request.id, RequestInitiator.LocalSide, `${requestTypeToStr(request.type)}: ${request.channelName}.${request.name}`, request.arg);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tcase RequestType.PromiseCancel:\n\t\t\tcase RequestType.EventDispose: {\n\t\t\t\tconst msgLength = this.send([request.type, request.id]);\n\t\t\t\tthis.logger?.logOutgoing(msgLength, request.id, RequestInitiator.LocalSide, requestTypeToStr(request.type));\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate send(header: unknown, body: any = undefined): number {\n\t\tconst writer = new BufferWriter();\n\t\tserialize(writer, header);\n\t\tserialize(writer, body);\n\t\treturn this.sendBuffer(writer.buffer);\n\t}\n\n\tprivate sendBuffer(message: VSBuffer): number {\n\t\ttry {\n\t\t\tthis.protocol.send(message);\n\t\t\treturn message.byteLength;\n\t\t} catch (err) {\n\t\t\t// noop\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tprivate onBuffer(message: VSBuffer): void {\n\t\tconst reader = new BufferReader(message);\n\t\tconst header = deserialize(reader);\n\t\tconst body = deserialize(reader);\n\t\tconst type: ResponseType = header[0];\n\n\t\tswitch (type) {\n\t\t\tcase ResponseType.Initialize:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, 0, RequestInitiator.LocalSide, responseTypeToStr(type));\n\t\t\t\treturn this.onResponse({ type: header[0] });\n\n\t\t\tcase ResponseType.PromiseSuccess:\n\t\t\tcase ResponseType.PromiseError:\n\t\t\tcase ResponseType.EventFire:\n\t\t\tcase ResponseType.PromiseErrorObj:\n\t\t\t\tthis.logger?.logIncoming(message.byteLength, header[1], RequestInitiator.LocalSide, responseTypeToStr(type), body);\n\t\t\t\treturn this.onResponse({ type: header[0], id: header[1], data: body });\n\t\t}\n\t}\n\n\tprivate onResponse(response: IRawResponse): void {\n\t\tif (response.type === ResponseType.Initialize) {\n\t\t\tthis.state = State.Idle;\n\t\t\tthis._onDidInitialize.fire();\n\t\t\treturn;\n\t\t}\n\n\t\tconst handler = this.handlers.get(response.id);\n\n\t\thandler?.(response);\n\t}\n\n\t@memoize\n\tget onDidInitializePromise(): Promise<void> {\n\t\treturn Event.toPromise(this.onDidInitialize);\n\t}\n\n\tprivate whenInitialized(): Promise<void> {\n\t\tif (this.state === State.Idle) {\n\t\t\treturn Promise.resolve();\n\t\t} else {\n\t\t\treturn this.onDidInitializePromise;\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis.isDisposed = true;\n\t\tif (this.protocolListener) {\n\t\t\tthis.protocolListener.dispose();\n\t\t\tthis.protocolListener = null;\n\t\t}\n\t\tdispose(this.activeRequests.values());\n\t\tthis.activeRequests.clear();\n\t}\n}\n\nexport interface ClientConnectionEvent {\n\tprotocol: IMessagePassingProtocol;\n\treadonly onDidClientDisconnect: Event<void>;\n}\n\ninterface Connection<TContext> extends Client<TContext> {\n\treadonly channelServer: ChannelServer<TContext>;\n\treadonly channelClient: ChannelClient;\n}\n\n/**\n * An `IPCServer` is both a channel server and a routing channel\n * client.\n *\n * As the owner of a protocol, you should extend both this\n * and the `IPCClient` classes to get IPC implementations\n * for your protocol.\n */\nexport class IPCServer<TContext = string> implements IChannelServer<TContext>, IRoutingChannelClient<TContext>, IConnectionHub<TContext>, IDisposable {\n\n\tprivate channels = new Map<string, IServerChannel<TContext>>();\n\tprivate _connections = new Set<Connection<TContext>>();\n\n\tprivate readonly _onDidAddConnection = new Emitter<Connection<TContext>>();\n\treadonly onDidAddConnection: Event<Connection<TContext>> = this._onDidAddConnection.event;\n\n\tprivate readonly _onDidRemoveConnection = new Emitter<Connection<TContext>>();\n\treadonly onDidRemoveConnection: Event<Connection<TContext>> = this._onDidRemoveConnection.event;\n\n\tprivate readonly disposables = new DisposableStore();\n\n\tget connections(): Connection<TContext>[] {\n\t\tconst result: Connection<TContext>[] = [];\n\t\tthis._connections.forEach(ctx => result.push(ctx));\n\t\treturn result;\n\t}\n\n\tconstructor(onDidClientConnect: Event<ClientConnectionEvent>, ipcLogger?: IIPCLogger | null, timeoutDelay?: number) {\n\t\tthis.disposables.add(onDidClientConnect(({ protocol, onDidClientDisconnect }) => {\n\t\t\tconst onFirstMessage = Event.once(protocol.onMessage);\n\n\t\t\tthis.disposables.add(onFirstMessage(msg => {\n\t\t\t\tconst reader = new BufferReader(msg);\n\t\t\t\tconst ctx = deserialize(reader) as TContext;\n\n\t\t\t\tconst channelServer = new ChannelServer(protocol, ctx, ipcLogger, timeoutDelay);\n\t\t\t\tconst channelClient = new ChannelClient(protocol, ipcLogger);\n\n\t\t\t\tthis.channels.forEach((channel, name) => channelServer.registerChannel(name, channel));\n\n\t\t\t\tconst connection: Connection<TContext> = { channelServer, channelClient, ctx };\n\t\t\t\tthis._connections.add(connection);\n\t\t\t\tthis._onDidAddConnection.fire(connection);\n\n\t\t\t\tthis.disposables.add(onDidClientDisconnect(() => {\n\t\t\t\t\tchannelServer.dispose();\n\t\t\t\t\tchannelClient.dispose();\n\t\t\t\t\tthis._connections.delete(connection);\n\t\t\t\t\tthis._onDidRemoveConnection.fire(connection);\n\t\t\t\t}));\n\t\t\t}));\n\t\t}));\n\t}\n\n\t/**\n\t * Get a channel from a remote client. When passed a router,\n\t * one can specify which client it wants to call and listen to/from.\n\t * Otherwise, when calling without a router, a random client will\n\t * be selected and when listening without a router, every client\n\t * will be listened to.\n\t */\n\tgetChannel<T extends IChannel>(channelName: string, router: IClientRouter<TContext>): T;\n\tgetChannel<T extends IChannel>(channelName: string, clientFilter: (client: Client<TContext>) => boolean): T;\n\tgetChannel<T extends IChannel>(channelName: string, routerOrClientFilter: IClientRouter<TContext> | ((client: Client<TContext>) => boolean)): T {\n\t\tconst that = this;\n\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\treturn {\n\t\t\tcall(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\t\tlet connectionPromise: Promise<Client<TContext>>;\n\n\t\t\t\tif (isFunction(routerOrClientFilter)) {\n\t\t\t\t\t// when no router is provided, we go random client picking\n\t\t\t\t\tconst connection = getRandomElement(that.connections.filter(routerOrClientFilter));\n\n\t\t\t\t\tconnectionPromise = connection\n\t\t\t\t\t\t// if we found a client, let's call on it\n\t\t\t\t\t\t? Promise.resolve(connection)\n\t\t\t\t\t\t// else, let's wait for a client to come along\n\t\t\t\t\t\t: Event.toPromise(Event.filter(that.onDidAddConnection, routerOrClientFilter));\n\t\t\t\t} else {\n\t\t\t\t\tconnectionPromise = routerOrClientFilter.routeCall(that, command, arg);\n\t\t\t\t}\n\n\t\t\t\tconst channelPromise = connectionPromise\n\t\t\t\t\t.then(connection => (connection as Connection<TContext>).channelClient.getChannel(channelName));\n\n\t\t\t\treturn getDelayedChannel(channelPromise)\n\t\t\t\t\t.call(command, arg, cancellationToken);\n\t\t\t},\n\t\t\tlisten(event: string, arg: any): Event<T> {\n\t\t\t\tif (isFunction(routerOrClientFilter)) {\n\t\t\t\t\treturn that.getMulticastEvent(channelName, routerOrClientFilter, event, arg);\n\t\t\t\t}\n\n\t\t\t\tconst channelPromise = routerOrClientFilter.routeEvent(that, event, arg)\n\t\t\t\t\t.then(connection => (connection as Connection<TContext>).channelClient.getChannel(channelName));\n\n\t\t\t\treturn getDelayedChannel(channelPromise)\n\t\t\t\t\t.listen(event, arg);\n\t\t\t}\n\t\t} as T;\n\t}\n\n\tprivate getMulticastEvent<T extends IChannel>(channelName: string, clientFilter: (client: Client<TContext>) => boolean, eventName: string, arg: any): Event<T> {\n\t\tconst that = this;\n\t\tlet disposables: DisposableStore | undefined;\n\n\t\t// Create an emitter which hooks up to all clients\n\t\t// as soon as first listener is added. It also\n\t\t// disconnects from all clients as soon as the last listener\n\t\t// is removed.\n\t\tconst emitter = new Emitter<T>({\n\t\t\tonWillAddFirstListener: () => {\n\t\t\t\tdisposables = new DisposableStore();\n\n\t\t\t\t// The event multiplexer is useful since the active\n\t\t\t\t// client list is dynamic. We need to hook up and disconnection\n\t\t\t\t// to/from clients as they come and go.\n\t\t\t\tconst eventMultiplexer = new EventMultiplexer<T>();\n\t\t\t\tconst map = new Map<Connection<TContext>, IDisposable>();\n\n\t\t\t\tconst onDidAddConnection = (connection: Connection<TContext>) => {\n\t\t\t\t\tconst channel = connection.channelClient.getChannel(channelName);\n\t\t\t\t\tconst event = channel.listen<T>(eventName, arg);\n\t\t\t\t\tconst disposable = eventMultiplexer.add(event);\n\n\t\t\t\t\tmap.set(connection, disposable);\n\t\t\t\t};\n\n\t\t\t\tconst onDidRemoveConnection = (connection: Connection<TContext>) => {\n\t\t\t\t\tconst disposable = map.get(connection);\n\n\t\t\t\t\tif (!disposable) {\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tdisposable.dispose();\n\t\t\t\t\tmap.delete(connection);\n\t\t\t\t};\n\n\t\t\t\tthat.connections.filter(clientFilter).forEach(onDidAddConnection);\n\t\t\t\tEvent.filter(that.onDidAddConnection, clientFilter)(onDidAddConnection, undefined, disposables);\n\t\t\t\tthat.onDidRemoveConnection(onDidRemoveConnection, undefined, disposables);\n\t\t\t\teventMultiplexer.event(emitter.fire, emitter, disposables);\n\n\t\t\t\tdisposables.add(eventMultiplexer);\n\t\t\t},\n\t\t\tonDidRemoveLastListener: () => {\n\t\t\t\tdisposables?.dispose();\n\t\t\t\tdisposables = undefined;\n\t\t\t}\n\t\t});\n\t\tthat.disposables.add(emitter);\n\n\t\treturn emitter.event;\n\t}\n\n\tregisterChannel(channelName: string, channel: IServerChannel<TContext>): void {\n\t\tthis.channels.set(channelName, channel);\n\n\t\tfor (const connection of this._connections) {\n\t\t\tconnection.channelServer.registerChannel(channelName, channel);\n\t\t}\n\t}\n\n\tdispose(): void {\n\t\tthis.disposables.dispose();\n\n\t\tfor (const connection of this._connections) {\n\t\t\tconnection.channelClient.dispose();\n\t\t\tconnection.channelServer.dispose();\n\t\t}\n\n\t\tthis._connections.clear();\n\t\tthis.channels.clear();\n\t\tthis._onDidAddConnection.dispose();\n\t\tthis._onDidRemoveConnection.dispose();\n\t}\n}\n\n/**\n * An `IPCClient` is both a channel client and a channel server.\n *\n * As the owner of a protocol, you should extend both this\n * and the `IPCServer` classes to get IPC implementations\n * for your protocol.\n */\nexport class IPCClient<TContext = string> implements IChannelClient, IChannelServer<TContext>, IDisposable {\n\n\tprivate channelClient: ChannelClient;\n\tprivate channelServer: ChannelServer<TContext>;\n\n\tconstructor(protocol: IMessagePassingProtocol, ctx: TContext, ipcLogger: IIPCLogger | null = null) {\n\t\tconst writer = new BufferWriter();\n\t\tserialize(writer, ctx);\n\t\tprotocol.send(writer.buffer);\n\n\t\tthis.channelClient = new ChannelClient(protocol, ipcLogger);\n\t\tthis.channelServer = new ChannelServer(protocol, ctx, ipcLogger);\n\t}\n\n\tgetChannel<T extends IChannel>(channelName: string): T {\n\t\treturn this.channelClient.getChannel(channelName);\n\t}\n\n\tregisterChannel(channelName: string, channel: IServerChannel<TContext>): void {\n\t\tthis.channelServer.registerChannel(channelName, channel);\n\t}\n\n\tdispose(): void {\n\t\tthis.channelClient.dispose();\n\t\tthis.channelServer.dispose();\n\t}\n}\n\nexport function getDelayedChannel<T extends IChannel>(promise: Promise<T>): T {\n\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\treturn {\n\t\tcall(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\treturn promise.then(c => c.call<T>(command, arg, cancellationToken));\n\t\t},\n\n\t\tlisten<T>(event: string, arg?: any): Event<T> {\n\t\t\tconst relay = new Relay<any>();\n\t\t\tpromise.then(c => relay.input = c.listen(event, arg));\n\t\t\treturn relay.event;\n\t\t}\n\t} as T;\n}\n\nexport function getNextTickChannel<T extends IChannel>(channel: T): T {\n\tlet didTick = false;\n\n\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\treturn {\n\t\tcall<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\tif (didTick) {\n\t\t\t\treturn channel.call(command, arg, cancellationToken);\n\t\t\t}\n\n\t\t\treturn timeout(0)\n\t\t\t\t.then(() => didTick = true)\n\t\t\t\t.then(() => channel.call<T>(command, arg, cancellationToken));\n\t\t},\n\t\tlisten<T>(event: string, arg?: any): Event<T> {\n\t\t\tif (didTick) {\n\t\t\t\treturn channel.listen<T>(event, arg);\n\t\t\t}\n\n\t\t\tconst relay = new Relay<T>();\n\n\t\t\ttimeout(0)\n\t\t\t\t.then(() => didTick = true)\n\t\t\t\t.then(() => relay.input = channel.listen<T>(event, arg));\n\n\t\t\treturn relay.event;\n\t\t}\n\t} as T;\n}\n\nexport class StaticRouter<TContext = string> implements IClientRouter<TContext> {\n\n\tconstructor(private fn: (ctx: TContext) => boolean | Promise<boolean>) { }\n\n\trouteCall(hub: IConnectionHub<TContext>): Promise<Client<TContext>> {\n\t\treturn this.route(hub);\n\t}\n\n\trouteEvent(hub: IConnectionHub<TContext>): Promise<Client<TContext>> {\n\t\treturn this.route(hub);\n\t}\n\n\tprivate async route(hub: IConnectionHub<TContext>): Promise<Client<TContext>> {\n\t\tfor (const connection of hub.connections) {\n\t\t\tif (await Promise.resolve(this.fn(connection.ctx))) {\n\t\t\t\treturn Promise.resolve(connection);\n\t\t\t}\n\t\t}\n\n\t\tawait Event.toPromise(hub.onDidAddConnection);\n\t\treturn await this.route(hub);\n\t}\n}\n\n/**\n * Use ProxyChannels to automatically wrapping and unwrapping\n * services to/from IPC channels, instead of manually wrapping\n * each service method and event.\n *\n * Restrictions:\n * - If marshalling is enabled, only `URI` and `RegExp` is converted\n *   automatically for you\n * - Events must follow the naming convention `onUpperCase`\n * - `CancellationToken` is currently not supported\n * - If a context is provided, you can use `AddFirstParameterToFunctions`\n *   utility to signal this in the receiving side type\n */\nexport namespace ProxyChannel {\n\n\texport interface IProxyOptions {\n\n\t\t/**\n\t\t * Disables automatic marshalling of `URI`.\n\t\t * If marshalling is disabled, `UriComponents`\n\t\t * must be used instead.\n\t\t */\n\t\tdisableMarshalling?: boolean;\n\t}\n\n\texport interface ICreateServiceChannelOptions extends IProxyOptions { }\n\n\texport function fromService<TContext>(service: unknown, disposables: DisposableStore, options?: ICreateServiceChannelOptions): IServerChannel<TContext> {\n\t\tconst handler = service as { [key: string]: unknown };\n\t\tconst disableMarshalling = options?.disableMarshalling;\n\n\t\t// Buffer any event that should be supported by\n\t\t// iterating over all property keys and finding them\n\t\t// However, this will not work for services that\n\t\t// are lazy and use a Proxy within. For that we\n\t\t// still need to check later (see below).\n\t\tconst mapEventNameToEvent = new Map<string, Event<unknown>>();\n\t\tfor (const key in handler) {\n\t\t\tif (propertyIsEvent(key)) {\n\t\t\t\tmapEventNameToEvent.set(key, Event.buffer(handler[key] as Event<unknown>, true, undefined, disposables));\n\t\t\t}\n\t\t}\n\n\t\treturn new class implements IServerChannel {\n\n\t\t\tlisten<T>(_: unknown, event: string, arg: any): Event<T> {\n\t\t\t\tconst eventImpl = mapEventNameToEvent.get(event);\n\t\t\t\tif (eventImpl) {\n\t\t\t\t\treturn eventImpl as Event<T>;\n\t\t\t\t}\n\n\t\t\t\tconst target = handler[event];\n\t\t\t\tif (typeof target === 'function') {\n\t\t\t\t\tif (propertyIsDynamicEvent(event)) {\n\t\t\t\t\t\treturn target.call(handler, arg);\n\t\t\t\t\t}\n\n\t\t\t\t\tif (propertyIsEvent(event)) {\n\t\t\t\t\t\tmapEventNameToEvent.set(event, Event.buffer(handler[event] as Event<unknown>, true, undefined, disposables));\n\n\t\t\t\t\t\treturn mapEventNameToEvent.get(event) as Event<T>;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tthrow new ErrorNoTelemetry(`Event not found: ${event}`);\n\t\t\t}\n\n\t\t\tcall(_: unknown, command: string, args?: any[]): Promise<any> {\n\t\t\t\tconst target = handler[command];\n\t\t\t\tif (typeof target === 'function') {\n\n\t\t\t\t\t// Revive unless marshalling disabled\n\t\t\t\t\tif (!disableMarshalling && Array.isArray(args)) {\n\t\t\t\t\t\tfor (let i = 0; i < args.length; i++) {\n\t\t\t\t\t\t\targs[i] = revive(args[i]);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tlet res = target.apply(handler, args);\n\t\t\t\t\tif (!(res instanceof Promise)) {\n\t\t\t\t\t\tres = Promise.resolve(res);\n\t\t\t\t\t}\n\t\t\t\t\treturn res;\n\t\t\t\t}\n\n\t\t\t\tthrow new ErrorNoTelemetry(`Method not found: ${command}`);\n\t\t\t}\n\t\t};\n\t}\n\n\texport interface ICreateProxyServiceOptions extends IProxyOptions {\n\n\t\t/**\n\t\t * If provided, will add the value of `context`\n\t\t * to each method call to the target.\n\t\t */\n\t\tcontext?: unknown;\n\n\t\t/**\n\t\t * If provided, will not proxy any of the properties\n\t\t * that are part of the Map but rather return that value.\n\t\t */\n\t\tproperties?: Map<string, unknown>;\n\t}\n\n\texport function toService<T extends object>(channel: IChannel, options?: ICreateProxyServiceOptions): T {\n\t\tconst disableMarshalling = options?.disableMarshalling;\n\n\t\treturn new Proxy({}, {\n\t\t\tget(_target: T, propKey: PropertyKey) {\n\t\t\t\tif (typeof propKey === 'string') {\n\n\t\t\t\t\t// Check for predefined values\n\t\t\t\t\tif (options?.properties?.has(propKey)) {\n\t\t\t\t\t\treturn options.properties.get(propKey);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Dynamic Event\n\t\t\t\t\tif (propertyIsDynamicEvent(propKey)) {\n\t\t\t\t\t\treturn function (arg: unknown) {\n\t\t\t\t\t\t\treturn channel.listen(propKey, arg);\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\n\t\t\t\t\t// Event\n\t\t\t\t\tif (propertyIsEvent(propKey)) {\n\t\t\t\t\t\treturn channel.listen(propKey);\n\t\t\t\t\t}\n\n\t\t\t\t\t// Function\n\t\t\t\t\treturn async function (...args: any[]) {\n\n\t\t\t\t\t\t// Add context if any\n\t\t\t\t\t\tlet methodArgs: any[];\n\t\t\t\t\t\tif (options && !isUndefinedOrNull(options.context)) {\n\t\t\t\t\t\t\tmethodArgs = [options.context, ...args];\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tmethodArgs = args;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tconst result = await channel.call(propKey, methodArgs);\n\n\t\t\t\t\t\t// Revive unless marshalling disabled\n\t\t\t\t\t\tif (!disableMarshalling) {\n\t\t\t\t\t\t\treturn revive(result);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn result;\n\t\t\t\t\t};\n\t\t\t\t}\n\n\t\t\t\tthrow new ErrorNoTelemetry(`Property not found: ${String(propKey)}`);\n\t\t\t}\n\t\t}) as T;\n\t}\n\n\tfunction propertyIsEvent(name: string): boolean {\n\t\t// Assume a property is an event if it has a form of \"onSomething\"\n\t\treturn name[0] === 'o' && name[1] === 'n' && strings.isUpperAsciiLetter(name.charCodeAt(2));\n\t}\n\n\tfunction propertyIsDynamicEvent(name: string): boolean {\n\t\t// Assume a property is a dynamic event (a method that returns an event) if it has a form of \"onDynamicSomething\"\n\t\treturn /^onDynamic/.test(name) && strings.isUpperAsciiLetter(name.charCodeAt(9));\n\t}\n}\n\nconst colorTables = [\n\t['#2977B1', '#FC802D', '#34A13A', '#D3282F', '#9366BA'],\n\t['#8B564C', '#E177C0', '#7F7F7F', '#BBBE3D', '#2EBECD']\n];\n\nfunction prettyWithoutArrays(data: unknown): any {\n\tif (Array.isArray(data)) {\n\t\treturn data;\n\t}\n\tif (data && typeof data === 'object' && typeof data.toString === 'function') {\n\t\tconst result = data.toString();\n\t\tif (result !== '[object Object]') {\n\t\t\treturn result;\n\t\t}\n\t}\n\treturn data;\n}\n\nfunction pretty(data: unknown): any {\n\tif (Array.isArray(data)) {\n\t\treturn data.map(prettyWithoutArrays);\n\t}\n\treturn prettyWithoutArrays(data);\n}\n\nfunction logWithColors(direction: string, totalLength: number, msgLength: number, req: number, initiator: RequestInitiator, str: string, data: any): void {\n\tdata = pretty(data);\n\n\tconst colorTable = colorTables[initiator];\n\tconst color = colorTable[req % colorTable.length];\n\tlet args = [`%c[${direction}]%c[${String(totalLength).padStart(7, ' ')}]%c[len: ${String(msgLength).padStart(5, ' ')}]%c${String(req).padStart(5, ' ')} - ${str}`, 'color: darkgreen', 'color: grey', 'color: grey', `color: ${color}`];\n\tif (/\\($/.test(str)) {\n\t\targs = args.concat(data);\n\t\targs.push(')');\n\t} else {\n\t\targs.push(data);\n\t}\n\tconsole.log.apply(console, args as [string, ...string[]]);\n}\n\nexport class IPCLogger implements IIPCLogger {\n\tprivate _totalIncoming = 0;\n\tprivate _totalOutgoing = 0;\n\n\tconstructor(\n\t\tprivate readonly _outgoingPrefix: string,\n\t\tprivate readonly _incomingPrefix: string,\n\t) { }\n\n\tpublic logOutgoing(msgLength: number, requestId: number, initiator: RequestInitiator, str: string, data?: any): void {\n\t\tthis._totalOutgoing += msgLength;\n\t\tlogWithColors(this._outgoingPrefix, this._totalOutgoing, msgLength, requestId, initiator, str, data);\n\t}\n\n\tpublic logIncoming(msgLength: number, requestId: number, initiator: RequestInitiator, str: string, data?: any): void {\n\t\tthis._totalIncoming += msgLength;\n\t\tlogWithColors(this._incomingPrefix, this._totalIncoming, msgLength, requestId, initiator, str, data);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ChildProcess, fork, ForkOptions } from 'child_process';\nimport { createCancelablePromise, Delayer } from '../../../common/async.js';\nimport { VSBuffer } from '../../../common/buffer.js';\nimport { CancellationToken } from '../../../common/cancellation.js';\nimport { isRemoteConsoleLog, log } from '../../../common/console.js';\nimport * as errors from '../../../common/errors.js';\nimport { Emitter, Event } from '../../../common/event.js';\nimport { dispose, IDisposable, toDisposable } from '../../../common/lifecycle.js';\nimport { deepClone } from '../../../common/objects.js';\nimport { createQueuedSender } from '../../../node/processes.js';\nimport { removeDangerousEnvVariables } from '../../../common/processes.js';\nimport { ChannelClient as IPCClient, ChannelServer as IPCServer, IChannel, IChannelClient } from '../common/ipc.js';\n\n/**\n * This implementation doesn't perform well since it uses base64 encoding for buffers.\n * We should move all implementations to use named ipc.net, so we stop depending on cp.fork.\n */\n\nexport class Server<TContext extends string> extends IPCServer<TContext> {\n\tconstructor(ctx: TContext) {\n\t\tsuper({\n\t\t\tsend: r => {\n\t\t\t\ttry {\n\t\t\t\t\tprocess.send?.((<Buffer>r.buffer).toString('base64'));\n\t\t\t\t} catch (e) { /* not much to do */ }\n\t\t\t},\n\t\t\tonMessage: Event.fromNodeEventEmitter(process, 'message', msg => VSBuffer.wrap(Buffer.from(msg, 'base64')))\n\t\t}, ctx);\n\n\t\tprocess.once('disconnect', () => this.dispose());\n\t}\n}\n\nexport interface IIPCOptions {\n\n\t/**\n\t * A descriptive name for the server this connection is to. Used in logging.\n\t */\n\tserverName: string;\n\n\t/**\n\t * Time in millies before killing the ipc process. The next request after killing will start it again.\n\t */\n\ttimeout?: number;\n\n\t/**\n\t * Arguments to the module to execute.\n\t */\n\targs?: string[];\n\n\t/**\n\t * Environment key-value pairs to be passed to the process that gets spawned for the ipc.\n\t */\n\tenv?: any;\n\n\t/**\n\t * Allows to assign a debug port for debugging the application executed.\n\t */\n\tdebug?: number;\n\n\t/**\n\t * Allows to assign a debug port for debugging the application and breaking it on the first line.\n\t */\n\tdebugBrk?: number;\n\n\t/**\n\t * If set, starts the fork with empty execArgv. If not set, execArgv from the parent process are inherited,\n\t * except --inspect= and --inspect-brk= which are filtered as they would result in a port conflict.\n\t */\n\tfreshExecArgv?: boolean;\n\n\t/**\n\t * Enables our createQueuedSender helper for this Client. Uses a queue when the internal Node.js queue is\n\t * full of messages - see notes on that method.\n\t */\n\tuseQueue?: boolean;\n}\n\nexport class Client implements IChannelClient, IDisposable {\n\n\tprivate disposeDelayer: Delayer<void> | undefined;\n\tprivate activeRequests = new Set<IDisposable>();\n\tprivate child: ChildProcess | null;\n\tprivate _client: IPCClient | null;\n\tprivate channels = new Map<string, IChannel>();\n\n\tprivate readonly _onDidProcessExit = new Emitter<{ code: number; signal: string }>();\n\treadonly onDidProcessExit = this._onDidProcessExit.event;\n\n\tconstructor(private modulePath: string, private options: IIPCOptions) {\n\t\tconst timeout = options.timeout || 60000;\n\t\tthis.disposeDelayer = new Delayer<void>(timeout);\n\t\tthis.child = null;\n\t\tthis._client = null;\n\t}\n\n\tgetChannel<T extends IChannel>(channelName: string): T {\n\t\tconst that = this;\n\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\treturn {\n\t\t\tcall<T>(command: string, arg?: any, cancellationToken?: CancellationToken): Promise<T> {\n\t\t\t\treturn that.requestPromise<T>(channelName, command, arg, cancellationToken);\n\t\t\t},\n\t\t\tlisten(event: string, arg?: any) {\n\t\t\t\treturn that.requestEvent(channelName, event, arg);\n\t\t\t}\n\t\t} as T;\n\t}\n\n\tprotected requestPromise<T>(channelName: string, name: string, arg?: any, cancellationToken = CancellationToken.None): Promise<T> {\n\t\tif (!this.disposeDelayer) {\n\t\t\treturn Promise.reject(new Error('disposed'));\n\t\t}\n\n\t\tif (cancellationToken.isCancellationRequested) {\n\t\t\treturn Promise.reject(errors.canceled());\n\t\t}\n\n\t\tthis.disposeDelayer.cancel();\n\n\t\tconst channel = this.getCachedChannel(channelName);\n\t\tconst result = createCancelablePromise(token => channel.call<T>(name, arg, token));\n\t\tconst cancellationTokenListener = cancellationToken.onCancellationRequested(() => result.cancel());\n\n\t\tconst disposable = toDisposable(() => result.cancel());\n\t\tthis.activeRequests.add(disposable);\n\n\t\tresult.finally(() => {\n\t\t\tcancellationTokenListener.dispose();\n\t\t\tthis.activeRequests.delete(disposable);\n\n\t\t\tif (this.activeRequests.size === 0 && this.disposeDelayer) {\n\t\t\t\tthis.disposeDelayer.trigger(() => this.disposeClient());\n\t\t\t}\n\t\t});\n\n\t\treturn result;\n\t}\n\n\tprotected requestEvent<T>(channelName: string, name: string, arg?: any): Event<T> {\n\t\tif (!this.disposeDelayer) {\n\t\t\treturn Event.None;\n\t\t}\n\n\t\tthis.disposeDelayer.cancel();\n\n\t\tlet listener: IDisposable;\n\t\tconst emitter = new Emitter<any>({\n\t\t\tonWillAddFirstListener: () => {\n\t\t\t\tconst channel = this.getCachedChannel(channelName);\n\t\t\t\tconst event: Event<T> = channel.listen(name, arg);\n\n\t\t\t\tlistener = event(emitter.fire, emitter);\n\t\t\t\tthis.activeRequests.add(listener);\n\t\t\t},\n\t\t\tonDidRemoveLastListener: () => {\n\t\t\t\tthis.activeRequests.delete(listener);\n\t\t\t\tlistener.dispose();\n\n\t\t\t\tif (this.activeRequests.size === 0 && this.disposeDelayer) {\n\t\t\t\t\tthis.disposeDelayer.trigger(() => this.disposeClient());\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\n\t\treturn emitter.event;\n\t}\n\n\tprivate get client(): IPCClient {\n\t\tif (!this._client) {\n\t\t\tconst args = this.options.args || [];\n\t\t\tconst forkOpts: ForkOptions = Object.create(null);\n\n\t\t\tforkOpts.env = { ...deepClone(process.env), 'VSCODE_PARENT_PID': String(process.pid) };\n\n\t\t\tif (this.options.env) {\n\t\t\t\tforkOpts.env = { ...forkOpts.env, ...this.options.env };\n\t\t\t}\n\n\t\t\tif (this.options.freshExecArgv) {\n\t\t\t\tforkOpts.execArgv = [];\n\t\t\t}\n\n\t\t\tif (typeof this.options.debug === 'number') {\n\t\t\t\tforkOpts.execArgv = ['--nolazy', '--inspect=' + this.options.debug];\n\t\t\t}\n\n\t\t\tif (typeof this.options.debugBrk === 'number') {\n\t\t\t\tforkOpts.execArgv = ['--nolazy', '--inspect-brk=' + this.options.debugBrk];\n\t\t\t}\n\n\t\t\tif (forkOpts.execArgv === undefined) {\n\t\t\t\tforkOpts.execArgv = process.execArgv\t\t\t// if not set, the forked process inherits the execArgv of the parent process\n\t\t\t\t\t.filter(a => !/^--inspect(-brk)?=/.test(a)) // --inspect and --inspect-brk can not be inherited as the port would conflict\n\t\t\t\t\t.filter(a => !a.startsWith('--vscode-')); \t// --vscode-* arguments are unsupported by node.js and thus need to remove\n\t\t\t}\n\n\t\t\tremoveDangerousEnvVariables(forkOpts.env);\n\n\t\t\tthis.child = fork(this.modulePath, args, forkOpts);\n\n\t\t\tconst onMessageEmitter = new Emitter<VSBuffer>();\n\t\t\tconst onRawMessage = Event.fromNodeEventEmitter(this.child, 'message', msg => msg);\n\n\t\t\tconst rawMessageDisposable = onRawMessage(msg => {\n\n\t\t\t\t// Handle remote console logs specially\n\t\t\t\tif (isRemoteConsoleLog(msg)) {\n\t\t\t\t\tlog(msg, `IPC Library: ${this.options.serverName}`);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\t// Anything else goes to the outside\n\t\t\t\tonMessageEmitter.fire(VSBuffer.wrap(Buffer.from(msg, 'base64')));\n\t\t\t});\n\n\t\t\tconst sender = this.options.useQueue ? createQueuedSender(this.child) : this.child;\n\t\t\tconst send = (r: VSBuffer) => this.child?.connected && sender.send((<Buffer>r.buffer).toString('base64'));\n\t\t\tconst onMessage = onMessageEmitter.event;\n\t\t\tconst protocol = { send, onMessage };\n\n\t\t\tthis._client = new IPCClient(protocol);\n\n\t\t\tconst onExit = () => this.disposeClient();\n\t\t\tprocess.once('exit', onExit);\n\n\t\t\tthis.child.on('error', err => console.warn('IPC \"' + this.options.serverName + '\" errored with ' + err));\n\n\t\t\tthis.child.on('exit', (code: any, signal: any) => {\n\t\t\t\tprocess.removeListener('exit' as 'loaded', onExit); // https://github.com/electron/electron/issues/21475\n\t\t\t\trawMessageDisposable.dispose();\n\n\t\t\t\tthis.activeRequests.forEach(r => dispose(r));\n\t\t\t\tthis.activeRequests.clear();\n\n\t\t\t\tif (code !== 0 && signal !== 'SIGTERM') {\n\t\t\t\t\tconsole.warn('IPC \"' + this.options.serverName + '\" crashed with exit code ' + code + ' and signal ' + signal);\n\t\t\t\t}\n\n\t\t\t\tthis.disposeDelayer?.cancel();\n\t\t\t\tthis.disposeClient();\n\t\t\t\tthis._onDidProcessExit.fire({ code, signal });\n\t\t\t});\n\t\t}\n\n\t\treturn this._client;\n\t}\n\n\tprivate getCachedChannel(name: string): IChannel {\n\t\tlet channel = this.channels.get(name);\n\n\t\tif (!channel) {\n\t\t\tchannel = this.client.getChannel(name);\n\t\t\tthis.channels.set(name, channel);\n\t\t}\n\n\t\treturn channel;\n\t}\n\n\tprivate disposeClient() {\n\t\tif (this._client) {\n\t\t\tif (this.child) {\n\t\t\t\tthis.child.kill();\n\t\t\t\tthis.child = null;\n\t\t\t}\n\t\t\tthis._client = null;\n\t\t\tthis.channels.clear();\n\t\t}\n\t}\n\n\tdispose() {\n\t\tthis._onDidProcessExit.dispose();\n\t\tthis.disposeDelayer?.cancel();\n\t\tthis.disposeDelayer = undefined;\n\t\tthis.disposeClient();\n\t\tthis.activeRequests.clear();\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { isTypedArray, isObject, isUndefinedOrNull } from './types.js';\n\nexport function deepClone<T>(obj: T): T {\n\tif (!obj || typeof obj !== 'object') {\n\t\treturn obj;\n\t}\n\tif (obj instanceof RegExp) {\n\t\treturn obj;\n\t}\n\tconst result: any = Array.isArray(obj) ? [] : {};\n\tObject.entries(obj).forEach(([key, value]) => {\n\t\tresult[key] = value && typeof value === 'object' ? deepClone(value) : value;\n\t});\n\treturn result;\n}\n\nexport function deepFreeze<T>(obj: T): T {\n\tif (!obj || typeof obj !== 'object') {\n\t\treturn obj;\n\t}\n\tconst stack: any[] = [obj];\n\twhile (stack.length > 0) {\n\t\tconst obj = stack.shift();\n\t\tObject.freeze(obj);\n\t\tfor (const key in obj) {\n\t\t\tif (_hasOwnProperty.call(obj, key)) {\n\t\t\t\tconst prop = obj[key];\n\t\t\t\tif (typeof prop === 'object' && !Object.isFrozen(prop) && !isTypedArray(prop)) {\n\t\t\t\t\tstack.push(prop);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\treturn obj;\n}\n\nconst _hasOwnProperty = Object.prototype.hasOwnProperty;\n\n\nexport function cloneAndChange(obj: any, changer: (orig: any) => any): any {\n\treturn _cloneAndChange(obj, changer, new Set());\n}\n\nfunction _cloneAndChange(obj: any, changer: (orig: any) => any, seen: Set<any>): any {\n\tif (isUndefinedOrNull(obj)) {\n\t\treturn obj;\n\t}\n\n\tconst changed = changer(obj);\n\tif (typeof changed !== 'undefined') {\n\t\treturn changed;\n\t}\n\n\tif (Array.isArray(obj)) {\n\t\tconst r1: any[] = [];\n\t\tfor (const e of obj) {\n\t\t\tr1.push(_cloneAndChange(e, changer, seen));\n\t\t}\n\t\treturn r1;\n\t}\n\n\tif (isObject(obj)) {\n\t\tif (seen.has(obj)) {\n\t\t\tthrow new Error('Cannot clone recursive data-structure');\n\t\t}\n\t\tseen.add(obj);\n\t\tconst r2: Record<string, unknown> = {};\n\t\tfor (const i2 in obj) {\n\t\t\tif (_hasOwnProperty.call(obj, i2)) {\n\t\t\t\tr2[i2] = _cloneAndChange(obj[i2], changer, seen);\n\t\t\t}\n\t\t}\n\t\tseen.delete(obj);\n\t\treturn r2;\n\t}\n\n\treturn obj;\n}\n\n/**\n * Copies all properties of source into destination. The optional parameter \"overwrite\" allows to control\n * if existing properties on the destination should be overwritten or not. Defaults to true (overwrite).\n */\nexport function mixin(destination: any, source: any, overwrite: boolean = true): any {\n\tif (!isObject(destination)) {\n\t\treturn source;\n\t}\n\n\tif (isObject(source)) {\n\t\tObject.keys(source).forEach(key => {\n\t\t\tif (key in destination) {\n\t\t\t\tif (overwrite) {\n\t\t\t\t\tif (isObject(destination[key]) && isObject(source[key])) {\n\t\t\t\t\t\tmixin(destination[key], source[key], overwrite);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tdestination[key] = source[key];\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdestination[key] = source[key];\n\t\t\t}\n\t\t});\n\t}\n\treturn destination;\n}\n\nexport function equals(one: any, other: any): boolean {\n\tif (one === other) {\n\t\treturn true;\n\t}\n\tif (one === null || one === undefined || other === null || other === undefined) {\n\t\treturn false;\n\t}\n\tif (typeof one !== typeof other) {\n\t\treturn false;\n\t}\n\tif (typeof one !== 'object') {\n\t\treturn false;\n\t}\n\tif ((Array.isArray(one)) !== (Array.isArray(other))) {\n\t\treturn false;\n\t}\n\n\tlet i: number;\n\tlet key: string;\n\n\tif (Array.isArray(one)) {\n\t\tif (one.length !== other.length) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (i = 0; i < one.length; i++) {\n\t\t\tif (!equals(one[i], other[i])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tconst oneKeys: string[] = [];\n\n\t\tfor (key in one) {\n\t\t\toneKeys.push(key);\n\t\t}\n\t\toneKeys.sort();\n\t\tconst otherKeys: string[] = [];\n\t\tfor (key in other) {\n\t\t\totherKeys.push(key);\n\t\t}\n\t\totherKeys.sort();\n\t\tif (!equals(oneKeys, otherKeys)) {\n\t\t\treturn false;\n\t\t}\n\t\tfor (i = 0; i < oneKeys.length; i++) {\n\t\t\tif (!equals(one[oneKeys[i]], other[oneKeys[i]])) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t}\n\treturn true;\n}\n\n/**\n * Calls `JSON.Stringify` with a replacer to break apart any circular references.\n * This prevents `JSON`.stringify` from throwing the exception\n *  \"Uncaught TypeError: Converting circular structure to JSON\"\n */\nexport function safeStringify(obj: any): string {\n\tconst seen = new Set<any>();\n\treturn JSON.stringify(obj, (key, value) => {\n\t\tif (isObject(value) || Array.isArray(value)) {\n\t\t\tif (seen.has(value)) {\n\t\t\t\treturn '[Circular]';\n\t\t\t} else {\n\t\t\t\tseen.add(value);\n\t\t\t}\n\t\t}\n\t\tif (typeof value === 'bigint') {\n\t\t\treturn `[BigInt ${value.toString()}]`;\n\t\t}\n\t\treturn value;\n\t});\n}\n\ntype obj = { [key: string]: any };\n/**\n * Returns an object that has keys for each value that is different in the base object. Keys\n * that do not exist in the target but in the base object are not considered.\n *\n * Note: This is not a deep-diffing method, so the values are strictly taken into the resulting\n * object if they differ.\n *\n * @param base the object to diff against\n * @param obj the object to use for diffing\n */\nexport function distinct(base: obj, target: obj): obj {\n\tconst result = Object.create(null);\n\n\tif (!base || !target) {\n\t\treturn result;\n\t}\n\n\tconst targetKeys = Object.keys(target);\n\ttargetKeys.forEach(k => {\n\t\tconst baseValue = base[k];\n\t\tconst targetValue = target[k];\n\n\t\tif (!equals(baseValue, targetValue)) {\n\t\t\tresult[k] = targetValue;\n\t\t}\n\t});\n\n\treturn result;\n}\n\nexport function getCaseInsensitive(target: obj, key: string): unknown {\n\tconst lowercaseKey = key.toLowerCase();\n\tconst equivalentKey = Object.keys(target).find(k => k.toLowerCase() === lowercaseKey);\n\treturn equivalentKey ? target[equivalentKey] : target[key];\n}\n\nexport function filter(obj: obj, predicate: (key: string, value: any) => boolean): obj {\n\tconst result = Object.create(null);\n\tfor (const [key, value] of Object.entries(obj)) {\n\t\tif (predicate(key, value)) {\n\t\t\tresult[key] = value;\n\t\t}\n\t}\n\treturn result;\n}\n\nexport function mapValues<T extends {}, R>(obj: T, fn: (value: T[keyof T], key: string) => R): { [K in keyof T]: R } {\n\tconst result: { [key: string]: R } = {};\n\tfor (const [key, value] of Object.entries(obj)) {\n\t\tresult[key] = fn(<T[keyof T]>value, key);\n\t}\n\treturn result as { [K in keyof T]: R };\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as cp from 'child_process';\nimport { Stats, promises } from 'fs';\nimport { getCaseInsensitive } from '../common/objects.js';\nimport * as path from '../common/path.js';\nimport * as Platform from '../common/platform.js';\nimport * as processCommon from '../common/process.js';\nimport { CommandOptions, ForkOptions, Source, SuccessData, TerminateResponse, TerminateResponseCode } from '../common/processes.js';\nimport * as Types from '../common/types.js';\nimport * as pfs from './pfs.js';\nimport { FileAccess } from '../common/network.js';\nimport Stream from 'stream';\nexport { Source, TerminateResponseCode, type CommandOptions, type ForkOptions, type SuccessData, type TerminateResponse };\n\nexport type ValueCallback<T> = (value: T | Promise<T>) => void;\nexport type ErrorCallback = (error?: any) => void;\nexport type ProgressCallback<T> = (progress: T) => void;\n\n\nexport function getWindowsShell(env = processCommon.env): string {\n\treturn env['comspec'] || 'cmd.exe';\n}\n\nexport interface IQueuedSender {\n\tsend: (msg: any) => void;\n}\n\n// Wrapper around process.send() that will queue any messages if the internal node.js\n// queue is filled with messages and only continue sending messages when the internal\n// queue is free again to consume messages.\n// On Windows we always wait for the send() method to return before sending the next message\n// to workaround https://github.com/nodejs/node/issues/7657 (IPC can freeze process)\nexport function createQueuedSender(childProcess: cp.ChildProcess): IQueuedSender {\n\tlet msgQueue: string[] = [];\n\tlet useQueue = false;\n\n\tconst send = function (msg: any): void {\n\t\tif (useQueue) {\n\t\t\tmsgQueue.push(msg); // add to the queue if the process cannot handle more messages\n\t\t\treturn;\n\t\t}\n\n\t\tconst result = childProcess.send(msg, (error: Error | null) => {\n\t\t\tif (error) {\n\t\t\t\tconsole.error(error); // unlikely to happen, best we can do is log this error\n\t\t\t}\n\n\t\t\tuseQueue = false; // we are good again to send directly without queue\n\n\t\t\t// now send all the messages that we have in our queue and did not send yet\n\t\t\tif (msgQueue.length > 0) {\n\t\t\t\tconst msgQueueCopy = msgQueue.slice(0);\n\t\t\t\tmsgQueue = [];\n\t\t\t\tmsgQueueCopy.forEach(entry => send(entry));\n\t\t\t}\n\t\t});\n\n\t\tif (!result || Platform.isWindows /* workaround https://github.com/nodejs/node/issues/7657 */) {\n\t\t\tuseQueue = true;\n\t\t}\n\t};\n\n\treturn { send };\n}\n\nasync function fileExistsDefault(path: string): Promise<boolean> {\n\tif (await pfs.Promises.exists(path)) {\n\t\tlet statValue: Stats | undefined;\n\t\ttry {\n\t\t\tstatValue = await promises.stat(path);\n\t\t} catch (e) {\n\t\t\tif (e.message.startsWith('EACCES')) {\n\t\t\t\t// it might be symlink\n\t\t\t\tstatValue = await promises.lstat(path);\n\t\t\t}\n\t\t}\n\t\treturn statValue ? !statValue.isDirectory() : false;\n\t}\n\treturn false;\n}\n\nexport async function findExecutable(command: string, cwd?: string, paths?: string[], env: Platform.IProcessEnvironment = processCommon.env, fileExists: (path: string) => Promise<boolean> = fileExistsDefault): Promise<string | undefined> {\n\t// If we have an absolute path then we take it.\n\tif (path.isAbsolute(command)) {\n\t\treturn await fileExists(command) ? command : undefined;\n\t}\n\tif (cwd === undefined) {\n\t\tcwd = processCommon.cwd();\n\t}\n\tconst dir = path.dirname(command);\n\tif (dir !== '.') {\n\t\t// We have a directory and the directory is relative (see above). Make the path absolute\n\t\t// to the current working directory.\n\t\tconst fullPath = path.join(cwd, command);\n\t\treturn await fileExists(fullPath) ? fullPath : undefined;\n\t}\n\tconst envPath = getCaseInsensitive(env, 'PATH');\n\tif (paths === undefined && Types.isString(envPath)) {\n\t\tpaths = envPath.split(path.delimiter);\n\t}\n\t// No PATH environment. Make path absolute to the cwd.\n\tif (paths === undefined || paths.length === 0) {\n\t\tconst fullPath = path.join(cwd, command);\n\t\treturn await fileExists(fullPath) ? fullPath : undefined;\n\t}\n\n\t// We have a simple file name. We get the path variable from the env\n\t// and try to find the executable on the path.\n\tfor (const pathEntry of paths) {\n\t\t// The path entry is absolute.\n\t\tlet fullPath: string;\n\t\tif (path.isAbsolute(pathEntry)) {\n\t\t\tfullPath = path.join(pathEntry, command);\n\t\t} else {\n\t\t\tfullPath = path.join(cwd, pathEntry, command);\n\t\t}\n\t\tif (Platform.isWindows) {\n\t\t\tconst pathExt = getCaseInsensitive(env, 'PATHEXT') as string || '.COM;.EXE;.BAT;.CMD';\n\t\t\tconst pathExtsFound = pathExt.split(';').map(async ext => {\n\t\t\t\tconst withExtension = fullPath + ext;\n\t\t\t\treturn await fileExists(withExtension) ? withExtension : undefined;\n\t\t\t});\n\t\t\tfor (const foundPromise of pathExtsFound) {\n\t\t\t\tconst found = await foundPromise;\n\t\t\t\tif (found) {\n\t\t\t\t\treturn found;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (await fileExists(fullPath)) {\n\t\t\treturn fullPath;\n\t\t}\n\t}\n\tconst fullPath = path.join(cwd, command);\n\treturn await fileExists(fullPath) ? fullPath : undefined;\n}\n\n/**\n * Kills a process and all its children.\n * @param pid the process id to kill\n * @param forceful whether to forcefully kill the process (default: false). Note\n * that on Windows, terminal processes can _only_ be killed forcefully and this\n * will throw when not forceful.\n */\nexport async function killTree(pid: number, forceful = false) {\n\tlet child: cp.ChildProcessByStdio<null, Stream.Readable, Stream.Readable>;\n\tif (Platform.isWindows) {\n\t\tconst windir = process.env['WINDIR'] || 'C:\\\\Windows';\n\t\tconst taskKill = path.join(windir, 'System32', 'taskkill.exe');\n\n\t\tconst args = ['/T'];\n\t\tif (forceful) {\n\t\t\targs.push('/F');\n\t\t}\n\t\targs.push('/PID', String(pid));\n\t\tchild = cp.spawn(taskKill, args, { stdio: ['ignore', 'pipe', 'pipe'] });\n\t} else {\n\t\tconst killScript = FileAccess.asFileUri('vs/base/node/terminateProcess.sh').fsPath;\n\t\tchild = cp.spawn('/bin/sh', [killScript, String(pid), forceful ? '9' : '15'], { stdio: ['ignore', 'pipe', 'pipe'] });\n\t}\n\n\treturn new Promise<void>((resolve, reject) => {\n\t\tconst stdout: Buffer[] = [];\n\t\tchild.stdout.on('data', (data) => stdout.push(data));\n\t\tchild.stderr.on('data', (data) => stdout.push(data));\n\t\tchild.on('error', reject);\n\t\tchild.on('exit', (code) => {\n\t\t\tif (code === 0) {\n\t\t\t\tresolve();\n\t\t\t} else {\n\t\t\t\treject(new Error(`taskkill exited with code ${code}: ${Buffer.concat(stdout).toString()}`));\n\t\t\t}\n\t\t});\n\t});\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProcessEnvironment, isLinux } from './platform.js';\n\n/**\n * Options to be passed to the external program or shell.\n */\nexport interface CommandOptions {\n\t/**\n\t * The current working directory of the executed program or shell.\n\t * If omitted VSCode's current workspace root is used.\n\t */\n\tcwd?: string;\n\n\t/**\n\t * The environment of the executed program or shell. If omitted\n\t * the parent process' environment is used.\n\t */\n\tenv?: { [key: string]: string };\n}\n\nexport interface Executable {\n\t/**\n\t * The command to be executed. Can be an external program or a shell\n\t * command.\n\t */\n\tcommand: string;\n\n\t/**\n\t * Specifies whether the command is a shell command and therefore must\n\t * be executed in a shell interpreter (e.g. cmd.exe, bash, ...).\n\t */\n\tisShellCommand: boolean;\n\n\t/**\n\t * The arguments passed to the command.\n\t */\n\targs: string[];\n\n\t/**\n\t * The command options used when the command is executed. Can be omitted.\n\t */\n\toptions?: CommandOptions;\n}\n\nexport interface ForkOptions extends CommandOptions {\n\texecArgv?: string[];\n}\n\nexport const enum Source {\n\tstdout,\n\tstderr\n}\n\n/**\n * The data send via a success callback\n */\nexport interface SuccessData {\n\terror?: Error;\n\tcmdCode?: number;\n\tterminated?: boolean;\n}\n\n/**\n * The data send via a error callback\n */\nexport interface ErrorData {\n\terror?: Error;\n\tterminated?: boolean;\n\tstdout?: string;\n\tstderr?: string;\n}\n\nexport interface TerminateResponse {\n\tsuccess: boolean;\n\tcode?: TerminateResponseCode;\n\terror?: any;\n}\n\nexport const enum TerminateResponseCode {\n\tSuccess = 0,\n\tUnknown = 1,\n\tAccessDenied = 2,\n\tProcessNotFound = 3,\n}\n\nexport interface ProcessItem {\n\tname: string;\n\tcmd: string;\n\tpid: number;\n\tppid: number;\n\tload: number;\n\tmem: number;\n\n\tchildren?: ProcessItem[];\n}\n\n/**\n * Sanitizes a VS Code process environment by removing all Electron/VS Code-related values.\n */\nexport function sanitizeProcessEnvironment(env: IProcessEnvironment, ...preserve: string[]): void {\n\tconst set = preserve.reduce<Record<string, boolean>>((set, key) => {\n\t\tset[key] = true;\n\t\treturn set;\n\t}, {});\n\tconst keysToRemove = [\n\t\t/^ELECTRON_.+$/,\n\t\t/^VSCODE_(?!(PORTABLE|SHELL_LOGIN|ENV_REPLACE|ENV_APPEND|ENV_PREPEND)).+$/,\n\t\t/^SNAP(|_.*)$/,\n\t\t/^GDK_PIXBUF_.+$/,\n\t];\n\tconst envKeys = Object.keys(env);\n\tenvKeys\n\t\t.filter(key => !set[key])\n\t\t.forEach(envKey => {\n\t\t\tfor (let i = 0; i < keysToRemove.length; i++) {\n\t\t\t\tif (envKey.search(keysToRemove[i]) !== -1) {\n\t\t\t\t\tdelete env[envKey];\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t});\n}\n\n/**\n * Remove dangerous environment variables that have caused crashes\n * in forked processes (i.e. in ELECTRON_RUN_AS_NODE processes)\n *\n * @param env The env object to change\n */\nexport function removeDangerousEnvVariables(env: IProcessEnvironment | undefined): void {\n\tif (!env) {\n\t\treturn;\n\t}\n\n\t// Unset `DEBUG`, as an invalid value might lead to process crashes\n\t// See https://github.com/microsoft/vscode/issues/130072\n\tdelete env['DEBUG'];\n\n\tif (isLinux) {\n\t\t// Unset `LD_PRELOAD`, as it might lead to process crashes\n\t\t// See https://github.com/microsoft/vscode/issues/134177\n\t\tdelete env['LD_PRELOAD'];\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport { tmpdir } from 'os';\nimport { promisify } from 'util';\nimport { ResourceQueue, timeout } from '../common/async.js';\nimport { isEqualOrParent, isRootOrDriveLetter, randomPath } from '../common/extpath.js';\nimport { normalizeNFC } from '../common/normalization.js';\nimport { basename, dirname, join, normalize, sep } from '../common/path.js';\nimport { isLinux, isMacintosh, isWindows } from '../common/platform.js';\nimport { extUriBiasedIgnorePathCase } from '../common/resources.js';\nimport { URI } from '../common/uri.js';\nimport { CancellationToken } from '../common/cancellation.js';\nimport { rtrim } from '../common/strings.js';\n\n//#region rimraf\n\nexport enum RimRafMode {\n\n\t/**\n\t * Slow version that unlinks each file and folder.\n\t */\n\tUNLINK,\n\n\t/**\n\t * Fast version that first moves the file/folder\n\t * into a temp directory and then deletes that\n\t * without waiting for it.\n\t */\n\tMOVE\n}\n\n/**\n * Allows to delete the provided path (either file or folder) recursively\n * with the options:\n * - `UNLINK`: direct removal from disk\n * - `MOVE`: faster variant that first moves the target to temp dir and then\n *           deletes it in the background without waiting for that to finish.\n *           the optional `moveToPath` allows to override where to rename the\n *           path to before deleting it.\n */\nasync function rimraf(path: string, mode: RimRafMode.UNLINK): Promise<void>;\nasync function rimraf(path: string, mode: RimRafMode.MOVE, moveToPath?: string): Promise<void>;\nasync function rimraf(path: string, mode?: RimRafMode, moveToPath?: string): Promise<void>;\nasync function rimraf(path: string, mode = RimRafMode.UNLINK, moveToPath?: string): Promise<void> {\n\tif (isRootOrDriveLetter(path)) {\n\t\tthrow new Error('rimraf - will refuse to recursively delete root');\n\t}\n\n\t// delete: via rm\n\tif (mode === RimRafMode.UNLINK) {\n\t\treturn rimrafUnlink(path);\n\t}\n\n\t// delete: via move\n\treturn rimrafMove(path, moveToPath);\n}\n\nasync function rimrafMove(path: string, moveToPath = randomPath(tmpdir())): Promise<void> {\n\ttry {\n\t\ttry {\n\t\t\tawait fs.promises.rename(path, moveToPath);\n\t\t} catch (error) {\n\t\t\tif (error.code === 'ENOENT') {\n\t\t\t\treturn; // ignore - path to delete did not exist\n\t\t\t}\n\n\t\t\treturn rimrafUnlink(path); // otherwise fallback to unlink\n\t\t}\n\n\t\t// Delete but do not return as promise\n\t\trimrafUnlink(moveToPath).catch(() => {/* ignore */ });\n\t} catch (error) {\n\t\tif (error.code !== 'ENOENT') {\n\t\t\tthrow error;\n\t\t}\n\t}\n}\n\nasync function rimrafUnlink(path: string): Promise<void> {\n\treturn fs.promises.rm(path, { recursive: true, force: true, maxRetries: 3 });\n}\n\n//#endregion\n\n//#region readdir with NFC support (macos)\n\nexport interface IDirent {\n\tname: string;\n\n\tisFile(): boolean;\n\tisDirectory(): boolean;\n\tisSymbolicLink(): boolean;\n}\n\n/**\n * Drop-in replacement of `fs.readdir` with support\n * for converting from macOS NFD unicon form to NFC\n * (https://github.com/nodejs/node/issues/2165)\n */\nasync function readdir(path: string): Promise<string[]>;\nasync function readdir(path: string, options: { withFileTypes: true }): Promise<IDirent[]>;\nasync function readdir(path: string, options?: { withFileTypes: true }): Promise<(string | IDirent)[]> {\n\ttry {\n\t\treturn await doReaddir(path, options);\n\t} catch (error) {\n\t\t// Workaround for #252361 that should be removed once the upstream issue\n\t\t// in node.js is resolved. Adds a trailing dot to a root drive letter path\n\t\t// (G:\\ => G:\\.) as a workaround.\n\t\tif (error.code === 'ENOENT' && isWindows && isRootOrDriveLetter(path)) {\n\t\t\ttry {\n\t\t\t\treturn await doReaddir(`${path}.`, options);\n\t\t\t} catch {\n\t\t\t\t// ignore\n\t\t\t}\n\t\t}\n\t\tthrow error;\n\t}\n}\n\nasync function doReaddir(path: string, options?: { withFileTypes: true }): Promise<(string | IDirent)[]> {\n\treturn handleDirectoryChildren(await (options ? safeReaddirWithFileTypes(path) : fs.promises.readdir(path)));\n}\n\nasync function safeReaddirWithFileTypes(path: string): Promise<IDirent[]> {\n\ttry {\n\t\treturn await fs.promises.readdir(path, { withFileTypes: true });\n\t} catch (error) {\n\t\tconsole.warn('[node.js fs] readdir with filetypes failed with error: ', error);\n\t}\n\n\t// Fallback to manually reading and resolving each\n\t// children of the folder in case we hit an error\n\t// previously.\n\t// This can only really happen on exotic file systems\n\t// such as explained in #115645 where we get entries\n\t// from `readdir` that we can later not `lstat`.\n\tconst result: IDirent[] = [];\n\tconst children = await readdir(path);\n\tfor (const child of children) {\n\t\tlet isFile = false;\n\t\tlet isDirectory = false;\n\t\tlet isSymbolicLink = false;\n\n\t\ttry {\n\t\t\tconst lstat = await fs.promises.lstat(join(path, child));\n\n\t\t\tisFile = lstat.isFile();\n\t\t\tisDirectory = lstat.isDirectory();\n\t\t\tisSymbolicLink = lstat.isSymbolicLink();\n\t\t} catch (error) {\n\t\t\tconsole.warn('[node.js fs] unexpected error from lstat after readdir: ', error);\n\t\t}\n\n\t\tresult.push({\n\t\t\tname: child,\n\t\t\tisFile: () => isFile,\n\t\t\tisDirectory: () => isDirectory,\n\t\t\tisSymbolicLink: () => isSymbolicLink\n\t\t});\n\t}\n\n\treturn result;\n}\n\nfunction handleDirectoryChildren(children: string[]): string[];\nfunction handleDirectoryChildren(children: IDirent[]): IDirent[];\nfunction handleDirectoryChildren(children: (string | IDirent)[]): (string | IDirent)[];\nfunction handleDirectoryChildren(children: (string | IDirent)[]): (string | IDirent)[] {\n\treturn children.map(child => {\n\n\t\t// Mac: uses NFD unicode form on disk, but we want NFC\n\t\t// See also https://github.com/nodejs/node/issues/2165\n\n\t\tif (typeof child === 'string') {\n\t\t\treturn isMacintosh ? normalizeNFC(child) : child;\n\t\t}\n\n\t\tchild.name = isMacintosh ? normalizeNFC(child.name) : child.name;\n\n\t\treturn child;\n\t});\n}\n\n/**\n * A convenience method to read all children of a path that\n * are directories.\n */\nasync function readDirsInDir(dirPath: string): Promise<string[]> {\n\tconst children = await readdir(dirPath);\n\tconst directories: string[] = [];\n\n\tfor (const child of children) {\n\t\tif (await SymlinkSupport.existsDirectory(join(dirPath, child))) {\n\t\t\tdirectories.push(child);\n\t\t}\n\t}\n\n\treturn directories;\n}\n\n//#endregion\n\n//#region whenDeleted()\n\n/**\n * A `Promise` that resolves when the provided `path`\n * is deleted from disk.\n */\nexport function whenDeleted(path: string, intervalMs = 1000): Promise<void> {\n\treturn new Promise<void>(resolve => {\n\t\tlet running = false;\n\t\tconst interval = setInterval(() => {\n\t\t\tif (!running) {\n\t\t\t\trunning = true;\n\t\t\t\tfs.access(path, err => {\n\t\t\t\t\trunning = false;\n\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\t\tresolve(undefined);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\t\t}, intervalMs);\n\t});\n}\n\n//#endregion\n\n//#region Methods with symbolic links support\n\nexport namespace SymlinkSupport {\n\n\texport interface IStats {\n\n\t\t// The stats of the file. If the file is a symbolic\n\t\t// link, the stats will be of that target file and\n\t\t// not the link itself.\n\t\t// If the file is a symbolic link pointing to a non\n\t\t// existing file, the stat will be of the link and\n\t\t// the `dangling` flag will indicate this.\n\t\tstat: fs.Stats;\n\n\t\t// Will be provided if the resource is a symbolic link\n\t\t// on disk. Use the `dangling` flag to find out if it\n\t\t// points to a resource that does not exist on disk.\n\t\tsymbolicLink?: { dangling: boolean };\n\t}\n\n\t/**\n\t * Resolves the `fs.Stats` of the provided path. If the path is a\n\t * symbolic link, the `fs.Stats` will be from the target it points\n\t * to. If the target does not exist, `dangling: true` will be returned\n\t * as `symbolicLink` value.\n\t */\n\texport async function stat(path: string): Promise<IStats> {\n\n\t\t// First stat the link\n\t\tlet lstats: fs.Stats | undefined;\n\t\ttry {\n\t\t\tlstats = await fs.promises.lstat(path);\n\n\t\t\t// Return early if the stat is not a symbolic link at all\n\t\t\tif (!lstats.isSymbolicLink()) {\n\t\t\t\treturn { stat: lstats };\n\t\t\t}\n\t\t} catch {\n\t\t\t/* ignore - use stat() instead */\n\t\t}\n\n\t\t// If the stat is a symbolic link or failed to stat, use fs.stat()\n\t\t// which for symbolic links will stat the target they point to\n\t\ttry {\n\t\t\tconst stats = await fs.promises.stat(path);\n\n\t\t\treturn { stat: stats, symbolicLink: lstats?.isSymbolicLink() ? { dangling: false } : undefined };\n\t\t} catch (error) {\n\n\t\t\t// If the link points to a nonexistent file we still want\n\t\t\t// to return it as result while setting dangling: true flag\n\t\t\tif (error.code === 'ENOENT' && lstats) {\n\t\t\t\treturn { stat: lstats, symbolicLink: { dangling: true } };\n\t\t\t}\n\n\t\t\t// Windows: workaround a node.js bug where reparse points\n\t\t\t// are not supported (https://github.com/nodejs/node/issues/36790)\n\t\t\tif (isWindows && error.code === 'EACCES') {\n\t\t\t\ttry {\n\t\t\t\t\tconst stats = await fs.promises.stat(await fs.promises.readlink(path));\n\n\t\t\t\t\treturn { stat: stats, symbolicLink: { dangling: false } };\n\t\t\t\t} catch (error) {\n\n\t\t\t\t\t// If the link points to a nonexistent file we still want\n\t\t\t\t\t// to return it as result while setting dangling: true flag\n\t\t\t\t\tif (error.code === 'ENOENT' && lstats) {\n\t\t\t\t\t\treturn { stat: lstats, symbolicLink: { dangling: true } };\n\t\t\t\t\t}\n\n\t\t\t\t\tthrow error;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tthrow error;\n\t\t}\n\t}\n\n\t/**\n\t * Figures out if the `path` exists and is a file with support\n\t * for symlinks.\n\t *\n\t * Note: this will return `false` for a symlink that exists on\n\t * disk but is dangling (pointing to a nonexistent path).\n\t *\n\t * Use `exists` if you only care about the path existing on disk\n\t * or not without support for symbolic links.\n\t */\n\texport async function existsFile(path: string): Promise<boolean> {\n\t\ttry {\n\t\t\tconst { stat, symbolicLink } = await SymlinkSupport.stat(path);\n\n\t\t\treturn stat.isFile() && symbolicLink?.dangling !== true;\n\t\t} catch {\n\t\t\t// Ignore, path might not exist\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Figures out if the `path` exists and is a directory with support for\n\t * symlinks.\n\t *\n\t * Note: this will return `false` for a symlink that exists on\n\t * disk but is dangling (pointing to a nonexistent path).\n\t *\n\t * Use `exists` if you only care about the path existing on disk\n\t * or not without support for symbolic links.\n\t */\n\texport async function existsDirectory(path: string): Promise<boolean> {\n\t\ttry {\n\t\t\tconst { stat, symbolicLink } = await SymlinkSupport.stat(path);\n\n\t\t\treturn stat.isDirectory() && symbolicLink?.dangling !== true;\n\t\t} catch {\n\t\t\t// Ignore, path might not exist\n\t\t}\n\n\t\treturn false;\n\t}\n}\n\n//#endregion\n\n//#region Write File\n\n// According to node.js docs (https://nodejs.org/docs/v14.16.0/api/fs.html#fs_fs_writefile_file_data_options_callback)\n// it is not safe to call writeFile() on the same path multiple times without waiting for the callback to return.\n// Therefor we use a Queue on the path that is given to us to sequentialize calls to the same path properly.\nconst writeQueues = new ResourceQueue();\n\n/**\n * Same as `fs.writeFile` but with an additional call to\n * `fs.fdatasync` after writing to ensure changes are\n * flushed to disk.\n *\n * In addition, multiple writes to the same path are queued.\n */\nfunction writeFile(path: string, data: string, options?: IWriteFileOptions): Promise<void>;\nfunction writeFile(path: string, data: Buffer, options?: IWriteFileOptions): Promise<void>;\nfunction writeFile(path: string, data: Uint8Array, options?: IWriteFileOptions): Promise<void>;\nfunction writeFile(path: string, data: string | Buffer | Uint8Array, options?: IWriteFileOptions): Promise<void>;\nfunction writeFile(path: string, data: string | Buffer | Uint8Array, options?: IWriteFileOptions): Promise<void> {\n\treturn writeQueues.queueFor(URI.file(path), () => {\n\t\tconst ensuredOptions = ensureWriteOptions(options);\n\n\t\treturn new Promise((resolve, reject) => doWriteFileAndFlush(path, data, ensuredOptions, error => error ? reject(error) : resolve()));\n\t}, extUriBiasedIgnorePathCase);\n}\n\ninterface IWriteFileOptions {\n\tmode?: number;\n\tflag?: string;\n}\n\ninterface IEnsuredWriteFileOptions extends IWriteFileOptions {\n\tmode: number;\n\tflag: string;\n}\n\nlet canFlush = true;\nexport function configureFlushOnWrite(enabled: boolean): void {\n\tcanFlush = enabled;\n}\n\n// Calls fs.writeFile() followed by a fs.sync() call to flush the changes to disk\n// We do this in cases where we want to make sure the data is really on disk and\n// not in some cache.\n//\n// See https://github.com/nodejs/node/blob/v5.10.0/lib/fs.js#L1194\nfunction doWriteFileAndFlush(path: string, data: string | Buffer | Uint8Array, options: IEnsuredWriteFileOptions, callback: (error: Error | null) => void): void {\n\tif (!canFlush) {\n\t\treturn fs.writeFile(path, data, { mode: options.mode, flag: options.flag }, callback);\n\t}\n\n\t// Open the file with same flags and mode as fs.writeFile()\n\tfs.open(path, options.flag, options.mode, (openError, fd) => {\n\t\tif (openError) {\n\t\t\treturn callback(openError);\n\t\t}\n\n\t\t// It is valid to pass a fd handle to fs.writeFile() and this will keep the handle open!\n\t\tfs.writeFile(fd, data, writeError => {\n\t\t\tif (writeError) {\n\t\t\t\treturn fs.close(fd, () => callback(writeError)); // still need to close the handle on error!\n\t\t\t}\n\n\t\t\t// Flush contents (not metadata) of the file to disk\n\t\t\t// https://github.com/microsoft/vscode/issues/9589\n\t\t\tfs.fdatasync(fd, (syncError: Error | null) => {\n\n\t\t\t\t// In some exotic setups it is well possible that node fails to sync\n\t\t\t\t// In that case we disable flushing and warn to the console\n\t\t\t\tif (syncError) {\n\t\t\t\t\tconsole.warn('[node.js fs] fdatasync is now disabled for this session because it failed: ', syncError);\n\t\t\t\t\tconfigureFlushOnWrite(false);\n\t\t\t\t}\n\n\t\t\t\treturn fs.close(fd, closeError => callback(closeError));\n\t\t\t});\n\t\t});\n\t});\n}\n\n/**\n * Same as `fs.writeFileSync` but with an additional call to\n * `fs.fdatasyncSync` after writing to ensure changes are\n * flushed to disk.\n *\n * @deprecated always prefer async variants over sync!\n */\nexport function writeFileSync(path: string, data: string | Buffer, options?: IWriteFileOptions): void {\n\tconst ensuredOptions = ensureWriteOptions(options);\n\n\tif (!canFlush) {\n\t\treturn fs.writeFileSync(path, data, { mode: ensuredOptions.mode, flag: ensuredOptions.flag });\n\t}\n\n\t// Open the file with same flags and mode as fs.writeFile()\n\tconst fd = fs.openSync(path, ensuredOptions.flag, ensuredOptions.mode);\n\n\ttry {\n\n\t\t// It is valid to pass a fd handle to fs.writeFile() and this will keep the handle open!\n\t\tfs.writeFileSync(fd, data);\n\n\t\t// Flush contents (not metadata) of the file to disk\n\t\ttry {\n\t\t\tfs.fdatasyncSync(fd); // https://github.com/microsoft/vscode/issues/9589\n\t\t} catch (syncError) {\n\t\t\tconsole.warn('[node.js fs] fdatasyncSync is now disabled for this session because it failed: ', syncError);\n\t\t\tconfigureFlushOnWrite(false);\n\t\t}\n\t} finally {\n\t\tfs.closeSync(fd);\n\t}\n}\n\nfunction ensureWriteOptions(options?: IWriteFileOptions): IEnsuredWriteFileOptions {\n\tif (!options) {\n\t\treturn { mode: 0o666 /* default node.js mode for files */, flag: 'w' };\n\t}\n\n\treturn {\n\t\tmode: typeof options.mode === 'number' ? options.mode : 0o666 /* default node.js mode for files */,\n\t\tflag: typeof options.flag === 'string' ? options.flag : 'w'\n\t};\n}\n\n//#endregion\n\n//#region Move / Copy\n\n/**\n * A drop-in replacement for `fs.rename` that:\n * - allows to move across multiple disks\n * - attempts to retry the operation for certain error codes on Windows\n */\nasync function rename(source: string, target: string, windowsRetryTimeout: number | false = 60000): Promise<void> {\n\tif (source === target) {\n\t\treturn;  // simulate node.js behaviour here and do a no-op if paths match\n\t}\n\n\ttry {\n\t\tif (isWindows && typeof windowsRetryTimeout === 'number') {\n\t\t\t// On Windows, a rename can fail when either source or target\n\t\t\t// is locked by AV software.\n\t\t\tawait renameWithRetry(source, target, Date.now(), windowsRetryTimeout);\n\t\t} else {\n\t\t\tawait fs.promises.rename(source, target);\n\t\t}\n\t} catch (error) {\n\t\t// In two cases we fallback to classic copy and delete:\n\t\t//\n\t\t// 1.) The EXDEV error indicates that source and target are on different devices\n\t\t// In this case, fallback to using a copy() operation as there is no way to\n\t\t// rename() between different devices.\n\t\t//\n\t\t// 2.) The user tries to rename a file/folder that ends with a dot. This is not\n\t\t// really possible to move then, at least on UNC devices.\n\t\tif (source.toLowerCase() !== target.toLowerCase() && error.code === 'EXDEV' || source.endsWith('.')) {\n\t\t\tawait copy(source, target, { preserveSymlinks: false /* copying to another device */ });\n\t\t\tawait rimraf(source, RimRafMode.MOVE);\n\t\t} else {\n\t\t\tthrow error;\n\t\t}\n\t}\n}\n\nasync function renameWithRetry(source: string, target: string, startTime: number, retryTimeout: number, attempt = 0): Promise<void> {\n\ttry {\n\t\treturn await fs.promises.rename(source, target);\n\t} catch (error) {\n\t\tif (error.code !== 'EACCES' && error.code !== 'EPERM' && error.code !== 'EBUSY') {\n\t\t\tthrow error; // only for errors we think are temporary\n\t\t}\n\n\t\tif (Date.now() - startTime >= retryTimeout) {\n\t\t\tconsole.error(`[node.js fs] rename failed after ${attempt} retries with error: ${error}`);\n\n\t\t\tthrow error; // give up after configurable timeout\n\t\t}\n\n\t\tif (attempt === 0) {\n\t\t\tlet abortRetry = false;\n\t\t\ttry {\n\t\t\t\tconst { stat } = await SymlinkSupport.stat(target);\n\t\t\t\tif (!stat.isFile()) {\n\t\t\t\t\tabortRetry = true; // if target is not a file, EPERM error may be raised and we should not attempt to retry\n\t\t\t\t}\n\t\t\t} catch {\n\t\t\t\t// Ignore\n\t\t\t}\n\n\t\t\tif (abortRetry) {\n\t\t\t\tthrow error;\n\t\t\t}\n\t\t}\n\n\t\t// Delay with incremental backoff up to 100ms\n\t\tawait timeout(Math.min(100, attempt * 10));\n\n\t\t// Attempt again\n\t\treturn renameWithRetry(source, target, startTime, retryTimeout, attempt + 1);\n\t}\n}\n\ninterface ICopyPayload {\n\treadonly root: { source: string; target: string };\n\treadonly options: { preserveSymlinks: boolean };\n\treadonly handledSourcePaths: Set<string>;\n}\n\n/**\n * Recursively copies all of `source` to `target`.\n *\n * The options `preserveSymlinks` configures how symbolic\n * links should be handled when encountered. Set to\n * `false` to not preserve them and `true` otherwise.\n */\nasync function copy(source: string, target: string, options: { preserveSymlinks: boolean }): Promise<void> {\n\treturn doCopy(source, target, { root: { source, target }, options, handledSourcePaths: new Set<string>() });\n}\n\n// When copying a file or folder, we want to preserve the mode\n// it had and as such provide it when creating. However, modes\n// can go beyond what we expect (see link below), so we mask it.\n// (https://github.com/nodejs/node-v0.x-archive/issues/3045#issuecomment-4862588)\nconst COPY_MODE_MASK = 0o777;\n\nasync function doCopy(source: string, target: string, payload: ICopyPayload): Promise<void> {\n\n\t// Keep track of paths already copied to prevent\n\t// cycles from symbolic links to cause issues\n\tif (payload.handledSourcePaths.has(source)) {\n\t\treturn;\n\t} else {\n\t\tpayload.handledSourcePaths.add(source);\n\t}\n\n\tconst { stat, symbolicLink } = await SymlinkSupport.stat(source);\n\n\t// Symlink\n\tif (symbolicLink) {\n\n\t\t// Try to re-create the symlink unless `preserveSymlinks: false`\n\t\tif (payload.options.preserveSymlinks) {\n\t\t\ttry {\n\t\t\t\treturn await doCopySymlink(source, target, payload);\n\t\t\t} catch {\n\t\t\t\t// in any case of an error fallback to normal copy via dereferencing\n\t\t\t}\n\t\t}\n\n\t\tif (symbolicLink.dangling) {\n\t\t\treturn; // skip dangling symbolic links from here on (https://github.com/microsoft/vscode/issues/111621)\n\t\t}\n\t}\n\n\t// Folder\n\tif (stat.isDirectory()) {\n\t\treturn doCopyDirectory(source, target, stat.mode & COPY_MODE_MASK, payload);\n\t}\n\n\t// File or file-like\n\telse {\n\t\treturn doCopyFile(source, target, stat.mode & COPY_MODE_MASK);\n\t}\n}\n\nasync function doCopyDirectory(source: string, target: string, mode: number, payload: ICopyPayload): Promise<void> {\n\n\t// Create folder\n\tawait fs.promises.mkdir(target, { recursive: true, mode });\n\n\t// Copy each file recursively\n\tconst files = await readdir(source);\n\tfor (const file of files) {\n\t\tawait doCopy(join(source, file), join(target, file), payload);\n\t}\n}\n\nasync function doCopyFile(source: string, target: string, mode: number): Promise<void> {\n\n\t// Copy file\n\tawait fs.promises.copyFile(source, target);\n\n\t// restore mode (https://github.com/nodejs/node/issues/1104)\n\tawait fs.promises.chmod(target, mode);\n}\n\nasync function doCopySymlink(source: string, target: string, payload: ICopyPayload): Promise<void> {\n\n\t// Figure out link target\n\tlet linkTarget = await fs.promises.readlink(source);\n\n\t// Special case: the symlink points to a target that is\n\t// actually within the path that is being copied. In that\n\t// case we want the symlink to point to the target and\n\t// not the source\n\tif (isEqualOrParent(linkTarget, payload.root.source, !isLinux)) {\n\t\tlinkTarget = join(payload.root.target, linkTarget.substr(payload.root.source.length + 1));\n\t}\n\n\t// Create symlink\n\tawait fs.promises.symlink(linkTarget, target);\n}\n\n//#endregion\n\n//#region Path resolvers\n\n/**\n * Given an absolute, normalized, and existing file path 'realcase' returns the\n * exact path that the file has on disk.\n * On a case insensitive file system, the returned path might differ from the original\n * path by character casing.\n * On a case sensitive file system, the returned path will always be identical to the\n * original path.\n * In case of errors, null is returned. But you cannot use this function to verify that\n * a path exists.\n *\n * realcase does not handle '..' or '.' path segments and it does not take the locale into account.\n */\nexport async function realcase(path: string, token?: CancellationToken): Promise<string | null> {\n\tif (isLinux) {\n\t\t// This method is unsupported on OS that have case sensitive\n\t\t// file system where the same path can exist in different forms\n\t\t// (see also https://github.com/microsoft/vscode/issues/139709)\n\t\treturn path;\n\t}\n\n\tconst dir = dirname(path);\n\tif (path === dir) {\t// end recursion\n\t\treturn path;\n\t}\n\n\tconst name = (basename(path) /* can be '' for windows drive letters */ || path).toLowerCase();\n\ttry {\n\t\tif (token?.isCancellationRequested) {\n\t\t\treturn null;\n\t\t}\n\n\t\tconst entries = await Promises.readdir(dir);\n\t\tconst found = entries.filter(e => e.toLowerCase() === name);\t// use a case insensitive search\n\t\tif (found.length === 1) {\n\t\t\t// on a case sensitive filesystem we cannot determine here, whether the file exists or not, hence we need the 'file exists' precondition\n\t\t\tconst prefix = await realcase(dir, token);   // recurse\n\t\t\tif (prefix) {\n\t\t\t\treturn join(prefix, found[0]);\n\t\t\t}\n\t\t} else if (found.length > 1) {\n\t\t\t// must be a case sensitive $filesystem\n\t\t\tconst ix = found.indexOf(name);\n\t\t\tif (ix >= 0) {\t// case sensitive\n\t\t\t\tconst prefix = await realcase(dir, token);   // recurse\n\t\t\t\tif (prefix) {\n\t\t\t\t\treturn join(prefix, found[ix]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} catch {\n\t\t// silently ignore error\n\t}\n\n\treturn null;\n}\n\nasync function realpath(path: string): Promise<string> {\n\ttry {\n\t\t// DO NOT USE `fs.promises.realpath` here as it internally\n\t\t// calls `fs.native.realpath` which will result in subst\n\t\t// drives to be resolved to their target on Windows\n\t\t// https://github.com/microsoft/vscode/issues/118562\n\t\treturn await promisify(fs.realpath)(path);\n\t} catch {\n\n\t\t// We hit an error calling fs.realpath(). Since fs.realpath() is doing some path normalization\n\t\t// we now do a similar normalization and then try again if we can access the path with read\n\t\t// permissions at least. If that succeeds, we return that path.\n\t\t// fs.realpath() is resolving symlinks and that can fail in certain cases. The workaround is\n\t\t// to not resolve links but to simply see if the path is read accessible or not.\n\t\tconst normalizedPath = normalizePath(path);\n\n\t\tawait fs.promises.access(normalizedPath, fs.constants.R_OK);\n\n\t\treturn normalizedPath;\n\t}\n}\n\n/**\n * @deprecated always prefer async variants over sync!\n */\nexport function realpathSync(path: string): string {\n\ttry {\n\t\treturn fs.realpathSync(path);\n\t} catch {\n\n\t\t// We hit an error calling fs.realpathSync(). Since fs.realpathSync() is doing some path normalization\n\t\t// we now do a similar normalization and then try again if we can access the path with read\n\t\t// permissions at least. If that succeeds, we return that path.\n\t\t// fs.realpath() is resolving symlinks and that can fail in certain cases. The workaround is\n\t\t// to not resolve links but to simply see if the path is read accessible or not.\n\t\tconst normalizedPath = normalizePath(path);\n\n\t\tfs.accessSync(normalizedPath, fs.constants.R_OK); // throws in case of an error\n\n\t\treturn normalizedPath;\n\t}\n}\n\nfunction normalizePath(path: string): string {\n\treturn rtrim(normalize(path), sep);\n}\n\n//#endregion\n\n//#region Promise based fs methods\n\n/**\n * Some low level `fs` methods provided as `Promises` similar to\n * `fs.promises` but with notable differences, either implemented\n * by us or by restoring the original callback based behavior.\n *\n * At least `realpath` is implemented differently in the promise\n * based implementation compared to the callback based one. The\n * promise based implementation actually calls `fs.realpath.native`.\n * (https://github.com/microsoft/vscode/issues/118562)\n */\nexport const Promises = new class {\n\n\t//#region Implemented by node.js\n\n\tget read() {\n\n\t\t// Not using `promisify` here for a reason: the return\n\t\t// type is not an object as indicated by TypeScript but\n\t\t// just the bytes read, so we create our own wrapper.\n\n\t\treturn (fd: number, buffer: Uint8Array, offset: number, length: number, position: number | null) => {\n\t\t\treturn new Promise<{ bytesRead: number; buffer: Uint8Array }>((resolve, reject) => {\n\t\t\t\tfs.read(fd, buffer, offset, length, position, (err, bytesRead, buffer) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn resolve({ bytesRead, buffer });\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t}\n\n\tget write() {\n\n\t\t// Not using `promisify` here for a reason: the return\n\t\t// type is not an object as indicated by TypeScript but\n\t\t// just the bytes written, so we create our own wrapper.\n\n\t\treturn (fd: number, buffer: Uint8Array, offset: number | undefined | null, length: number | undefined | null, position: number | undefined | null) => {\n\t\t\treturn new Promise<{ bytesWritten: number; buffer: Uint8Array }>((resolve, reject) => {\n\t\t\t\tfs.write(fd, buffer, offset, length, position, (err, bytesWritten, buffer) => {\n\t\t\t\t\tif (err) {\n\t\t\t\t\t\treturn reject(err);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn resolve({ bytesWritten, buffer });\n\t\t\t\t});\n\t\t\t});\n\t\t};\n\t}\n\n\tget fdatasync() { return promisify(fs.fdatasync); } // not exposed as API in 22.x yet\n\n\tget open() { return promisify(fs.open); } \t\t\t// changed to return `FileHandle` in promise API\n\tget close() { return promisify(fs.close); } \t\t// not exposed as API due to the `FileHandle` return type of `open`\n\n\tget ftruncate() { return promisify(fs.ftruncate); } // not exposed as API in 22.x yet\n\n\t//#endregion\n\n\t//#region Implemented by us\n\n\tasync exists(path: string): Promise<boolean> {\n\t\ttry {\n\t\t\tawait fs.promises.access(path);\n\n\t\t\treturn true;\n\t\t} catch {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tget readdir() { return readdir; }\n\tget readDirsInDir() { return readDirsInDir; }\n\n\tget writeFile() { return writeFile; }\n\n\tget rm() { return rimraf; }\n\n\tget rename() { return rename; }\n\tget copy() { return copy; }\n\n\tget realpath() { return realpath; }\t// `fs.promises.realpath` will use `fs.realpath.native` which we do not want\n\n\t//#endregion\n};\n\n//#endregion\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { LRUCache } from './map.js';\n\nconst nfcCache = new LRUCache<string, string>(10000); // bounded to 10000 elements\nexport function normalizeNFC(str: string): string {\n\treturn normalize(str, 'NFC', nfcCache);\n}\n\nconst nfdCache = new LRUCache<string, string>(10000); // bounded to 10000 elements\nexport function normalizeNFD(str: string): string {\n\treturn normalize(str, 'NFD', nfdCache);\n}\n\nconst nonAsciiCharactersPattern = /[^\\u0000-\\u0080]/;\nfunction normalize(str: string, form: string, normalizedCache: LRUCache<string, string>): string {\n\tif (!str) {\n\t\treturn str;\n\t}\n\n\tconst cached = normalizedCache.get(str);\n\tif (cached) {\n\t\treturn cached;\n\t}\n\n\tlet res: string;\n\tif (nonAsciiCharactersPattern.test(str)) {\n\t\tres = str.normalize(form);\n\t} else {\n\t\tres = str;\n\t}\n\n\t// Use the cache for fast lookup\n\tnormalizedCache.set(str, res);\n\n\treturn res;\n}\n\n/**\n * Attempts to normalize the string to Unicode base format (NFD -> remove accents -> lower case).\n * When original string contains accent characters directly, only lower casing will be performed.\n * This is done so as to keep the string length the same and not affect indices.\n *\n * @see https://stackoverflow.com/questions/990904/remove-accents-diacritics-in-a-string-in-javascript/37511463#37511463\n */\nexport const tryNormalizeToBase: (str: string) => string = function () {\n\tconst cache = new LRUCache<string, string>(10000); // bounded to 10000 elements\n\tconst accentsRegex = /[\\u0300-\\u036f]/g;\n\treturn function (str: string): string {\n\t\tconst cached = cache.get(str);\n\t\tif (cached) {\n\t\t\treturn cached;\n\t\t}\n\n\t\tconst noAccents = normalizeNFD(str).replace(accentsRegex, '');\n\t\tconst result = (noAccents.length === str.length ? noAccents : str).toLowerCase();\n\t\tcache.set(str, result);\n\t\treturn result;\n\t};\n}();\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport interface MessagePortMain extends NodeJS.EventEmitter {\n\n\t// Docs: https://electronjs.org/docs/api/message-port-main\n\n\t/**\n\t * Emitted when the remote end of a MessagePortMain object becomes disconnected.\n\t */\n\ton(event: 'close', listener: Function): this;\n\toff(event: 'close', listener: Function): this;\n\tonce(event: 'close', listener: Function): this;\n\taddListener(event: 'close', listener: Function): this;\n\tremoveListener(event: 'close', listener: Function): this;\n\t/**\n\t * Emitted when a MessagePortMain object receives a message.\n\t */\n\ton(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\toff(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\tonce(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\taddListener(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\tremoveListener(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\t/**\n\t * Disconnects the port, so it is no longer active.\n\t */\n\tclose(): void;\n\t/**\n\t * Sends a message from the port, and optionally, transfers ownership of objects to\n\t * other browsing contexts.\n\t */\n\tpostMessage(message: unknown, transfer?: MessagePortMain[]): void;\n\t/**\n\t * Starts the sending of messages queued on the port. Messages will be queued until\n\t * this method is called.\n\t */\n\tstart(): void;\n}\n\nexport interface MessageEvent {\n\tdata: unknown;\n\tports: MessagePortMain[];\n}\n\nexport interface ParentPort extends NodeJS.EventEmitter {\n\n\t// Docs: https://electronjs.org/docs/api/parent-port\n\n\t/**\n\t * Emitted when the process receives a message. Messages received on this port will\n\t * be queued up until a handler is registered for this event.\n\t */\n\ton(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\toff(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\tonce(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\taddListener(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\tremoveListener(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\t/**\n\t * Sends a message from the process to its parent.\n\t */\n\tpostMessage(message: unknown): void;\n}\n\nexport interface UtilityNodeJSProcess extends NodeJS.Process {\n\n\t/**\n\t * A `Electron.ParentPort` property if this is a `UtilityProcess` (or `null`\n\t * otherwise) allowing communication with the parent process.\n\t */\n\tparentPort: ParentPort;\n}\n\nexport function isUtilityProcess(process: NodeJS.Process): process is UtilityNodeJSProcess {\n\treturn !!(process as UtilityNodeJSProcess).parentPort;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { MessagePortMain, isUtilityProcess, MessageEvent } from '../../sandbox/node/electronTypes.js';\nimport { VSBuffer } from '../../../common/buffer.js';\nimport { ClientConnectionEvent, IMessagePassingProtocol, IPCServer } from '../common/ipc.js';\nimport { Emitter, Event } from '../../../common/event.js';\nimport { assertType } from '../../../common/types.js';\n\n/**\n * The MessagePort `Protocol` leverages MessagePortMain style IPC communication\n * for the implementation of the `IMessagePassingProtocol`.\n */\nclass Protocol implements IMessagePassingProtocol {\n\n\treadonly onMessage;\n\n\tconstructor(private port: MessagePortMain) {\n\t\tthis.onMessage = Event.fromNodeEventEmitter<VSBuffer>(this.port, 'message', (e: MessageEvent) => {\n\t\t\tif (e.data) {\n\t\t\t\treturn VSBuffer.wrap(e.data as Uint8Array);\n\t\t\t}\n\t\t\treturn VSBuffer.alloc(0);\n\t\t});\n\t\t// we must call start() to ensure messages are flowing\n\t\tport.start();\n\t}\n\n\tsend(message: VSBuffer): void {\n\t\tthis.port.postMessage(message.buffer);\n\t}\n\n\tdisconnect(): void {\n\t\tthis.port.close();\n\t}\n}\n\nexport interface IClientConnectionFilter {\n\n\t/**\n\t * Allows to filter incoming messages to the\n\t * server to handle them differently.\n\t *\n\t * @param e the message event to handle\n\t * @returns `true` if the event was handled\n\t * and should not be processed by the server.\n\t */\n\thandledClientConnection(e: MessageEvent): boolean;\n}\n\n/**\n * An implementation of a `IPCServer` on top of MessagePort style IPC communication.\n * The clients register themselves via Electron Utility Process IPC transfer.\n */\nexport class Server extends IPCServer {\n\n\tprivate static getOnDidClientConnect(filter?: IClientConnectionFilter): Event<ClientConnectionEvent> {\n\t\tassertType(isUtilityProcess(process), 'Electron Utility Process');\n\n\t\tconst onCreateMessageChannel = new Emitter<MessagePortMain>();\n\n\t\tprocess.parentPort.on('message', (e: MessageEvent) => {\n\t\t\tif (filter?.handledClientConnection(e)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst port = e.ports.at(0);\n\t\t\tif (port) {\n\t\t\t\tonCreateMessageChannel.fire(port);\n\t\t\t}\n\t\t});\n\n\t\treturn Event.map(onCreateMessageChannel.event, port => {\n\t\t\tconst protocol = new Protocol(port);\n\n\t\t\tconst result: ClientConnectionEvent = {\n\t\t\t\tprotocol,\n\t\t\t\t// Not part of the standard spec, but in Electron we get a `close` event\n\t\t\t\t// when the other side closes. We can use this to detect disconnects\n\t\t\t\t// (https://github.com/electron/electron/blob/11-x-y/docs/api/message-port-main.md#event-close)\n\t\t\t\tonDidClientDisconnect: Event.fromNodeEventEmitter(port, 'close')\n\t\t\t};\n\n\t\t\treturn result;\n\t\t});\n\t}\n\n\tconstructor(filter?: IClientConnectionFilter) {\n\t\tsuper(Server.getOnDidClientConnect(filter));\n\t}\n}\n\ninterface INodeMessagePortFragment {\n\ton(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n\tremoveListener(event: 'message', listener: (messageEvent: MessageEvent) => void): this;\n}\n\nexport function once(port: INodeMessagePortFragment, message: unknown, callback: () => void): void {\n\tconst listener = (e: MessageEvent) => {\n\t\tif (e.data === message) {\n\t\t\tport.removeListener('message', listener);\n\t\t\tcallback();\n\t\t}\n\t};\n\n\tport.on('message', listener);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport minimist from 'minimist';\nimport { isWindows } from '../../../base/common/platform.js';\nimport { localize } from '../../../nls.js';\nimport { NativeParsedArgs } from '../common/argv.js';\n\n/**\n * This code is also used by standalone cli's. Avoid adding any other dependencies.\n */\nconst helpCategories = {\n\to: localize('optionsUpperCase', \"Options\"),\n\te: localize('extensionsManagement', \"Extensions Management\"),\n\tt: localize('troubleshooting', \"Troubleshooting\"),\n\tm: localize('mcp', \"Model Context Protocol\")\n};\n\nexport interface Option<OptionType> {\n\ttype: OptionType;\n\talias?: string;\n\tdeprecates?: string[]; // old deprecated ids\n\targs?: string | string[];\n\tdescription?: string;\n\tdeprecationMessage?: string;\n\tallowEmptyValue?: boolean;\n\tcat?: keyof typeof helpCategories;\n\tglobal?: boolean;\n}\n\nexport interface Subcommand<T> {\n\ttype: 'subcommand';\n\tdescription?: string;\n\tdeprecationMessage?: string;\n\toptions: OptionDescriptions<Required<T>>;\n}\n\nexport type OptionDescriptions<T> = {\n\t[P in keyof T]:\n\tT[P] extends boolean | undefined ? Option<'boolean'> :\n\tT[P] extends string | undefined ? Option<'string'> :\n\tT[P] extends string[] | undefined ? Option<'string[]'> :\n\tSubcommand<T[P]>\n};\n\nexport const NATIVE_CLI_COMMANDS = ['tunnel', 'serve-web'] as const;\n\nexport const OPTIONS: OptionDescriptions<Required<NativeParsedArgs>> = {\n\t'chat': {\n\t\ttype: 'subcommand',\n\t\tdescription: 'Pass in a prompt to run in a chat session in the current working directory.',\n\t\toptions: {\n\t\t\t'_': { type: 'string[]', description: localize('prompt', \"The prompt to use as chat.\") },\n\t\t\t'mode': { type: 'string', cat: 'o', alias: 'm', args: 'mode', description: localize('chatMode', \"The mode to use for the chat session. Available options: 'ask', 'edit', 'agent', or the identifier of a custom mode. Defaults to 'agent'.\") },\n\t\t\t'add-file': { type: 'string[]', cat: 'o', alias: 'a', args: 'path', description: localize('addFile', \"Add files as context to the chat session.\") },\n\t\t\t'maximize': { type: 'boolean', cat: 'o', description: localize('chatMaximize', \"Maximize the chat session view.\") },\n\t\t\t'reuse-window': { type: 'boolean', cat: 'o', alias: 'r', description: localize('reuseWindowForChat', \"Force to use the last active window for the chat session.\") },\n\t\t\t'new-window': { type: 'boolean', cat: 'o', alias: 'n', description: localize('newWindowForChat', \"Force to open an empty window for the chat session.\") },\n\t\t\t'profile': { type: 'string', 'cat': 'o', args: 'profileName', description: localize('profileName', \"Opens the provided folder or workspace with the given profile and associates the profile with the workspace. If the profile does not exist, a new empty one is created.\") },\n\t\t\t'help': { type: 'boolean', alias: 'h', description: localize('help', \"Print usage.\") }\n\t\t}\n\t},\n\t'serve-web': {\n\t\ttype: 'subcommand',\n\t\tdescription: 'Run a server that displays the editor UI in browsers.',\n\t\toptions: {\n\t\t\t'cli-data-dir': { type: 'string', args: 'dir', description: localize('cliDataDir', \"Directory where CLI metadata should be stored.\") },\n\t\t\t'disable-telemetry': { type: 'boolean' },\n\t\t\t'telemetry-level': { type: 'string' },\n\t\t}\n\t},\n\t'tunnel': {\n\t\ttype: 'subcommand',\n\t\tdescription: 'Make the current machine accessible from vscode.dev or other machines through a secure tunnel.',\n\t\toptions: {\n\t\t\t'cli-data-dir': { type: 'string', args: 'dir', description: localize('cliDataDir', \"Directory where CLI metadata should be stored.\") },\n\t\t\t'disable-telemetry': { type: 'boolean' },\n\t\t\t'telemetry-level': { type: 'string' },\n\t\t\tuser: {\n\t\t\t\ttype: 'subcommand',\n\t\t\t\toptions: {\n\t\t\t\t\tlogin: {\n\t\t\t\t\t\ttype: 'subcommand',\n\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\tprovider: { type: 'string' },\n\t\t\t\t\t\t\t'access-token': { type: 'string' }\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t},\n\t'diff': { type: 'boolean', cat: 'o', alias: 'd', args: ['file', 'file'], description: localize('diff', \"Compare two files with each other.\") },\n\t'merge': { type: 'boolean', cat: 'o', alias: 'm', args: ['path1', 'path2', 'base', 'result'], description: localize('merge', \"Perform a three-way merge by providing paths for two modified versions of a file, the common origin of both modified versions and the output file to save merge results.\") },\n\t'add': { type: 'boolean', cat: 'o', alias: 'a', args: 'folder', description: localize('add', \"Add folder(s) to the last active window.\") },\n\t'remove': { type: 'boolean', cat: 'o', args: 'folder', description: localize('remove', \"Remove folder(s) from the last active window.\") },\n\t'goto': { type: 'boolean', cat: 'o', alias: 'g', args: 'file:line[:character]', description: localize('goto', \"Open a file at the path on the specified line and character position.\") },\n\t'new-window': { type: 'boolean', cat: 'o', alias: 'n', description: localize('newWindow', \"Force to open a new window.\") },\n\t'reuse-window': { type: 'boolean', cat: 'o', alias: 'r', description: localize('reuseWindow', \"Force to open a file or folder in an already opened window.\") },\n\t'wait': { type: 'boolean', cat: 'o', alias: 'w', description: localize('wait', \"Wait for the files to be closed before returning.\") },\n\t'waitMarkerFilePath': { type: 'string' },\n\t'locale': { type: 'string', cat: 'o', args: 'locale', description: localize('locale', \"The locale to use (e.g. en-US or zh-TW).\") },\n\t'user-data-dir': { type: 'string', cat: 'o', args: 'dir', description: localize('userDataDir', \"Specifies the directory that user data is kept in. Can be used to open multiple distinct instances of Code.\") },\n\t'profile': { type: 'string', 'cat': 'o', args: 'profileName', description: localize('profileName', \"Opens the provided folder or workspace with the given profile and associates the profile with the workspace. If the profile does not exist, a new empty one is created.\") },\n\t'help': { type: 'boolean', cat: 'o', alias: 'h', description: localize('help', \"Print usage.\") },\n\n\t'extensions-dir': { type: 'string', deprecates: ['extensionHomePath'], cat: 'e', args: 'dir', description: localize('extensionHomePath', \"Set the root path for extensions.\") },\n\t'extensions-download-dir': { type: 'string' },\n\t'builtin-extensions-dir': { type: 'string' },\n\t'list-extensions': { type: 'boolean', cat: 'e', description: localize('listExtensions', \"List the installed extensions.\") },\n\t'show-versions': { type: 'boolean', cat: 'e', description: localize('showVersions', \"Show versions of installed extensions, when using --list-extensions.\") },\n\t'category': { type: 'string', allowEmptyValue: true, cat: 'e', description: localize('category', \"Filters installed extensions by provided category, when using --list-extensions.\"), args: 'category' },\n\t'install-extension': { type: 'string[]', cat: 'e', args: 'ext-id | path', description: localize('installExtension', \"Installs or updates an extension. The argument is either an extension id or a path to a VSIX. The identifier of an extension is '${publisher}.${name}'. Use '--force' argument to update to latest version. To install a specific version provide '@${version}'. For example: 'vscode.csharp@1.2.3'.\") },\n\t'pre-release': { type: 'boolean', cat: 'e', description: localize('install prerelease', \"Installs the pre-release version of the extension, when using --install-extension\") },\n\t'uninstall-extension': { type: 'string[]', cat: 'e', args: 'ext-id', description: localize('uninstallExtension', \"Uninstalls an extension.\") },\n\t'update-extensions': { type: 'boolean', cat: 'e', description: localize('updateExtensions', \"Update the installed extensions.\") },\n\t'enable-proposed-api': { type: 'string[]', allowEmptyValue: true, cat: 'e', args: 'ext-id', description: localize('experimentalApis', \"Enables proposed API features for extensions. Can receive one or more extension IDs to enable individually.\") },\n\n\t'add-mcp': { type: 'string[]', cat: 'm', args: 'json', description: localize('addMcp', \"Adds a Model Context Protocol server definition to the user profile. Accepts JSON input in the form '{\\\"name\\\":\\\"server-name\\\",\\\"command\\\":...}'\") },\n\n\t'version': { type: 'boolean', cat: 't', alias: 'v', description: localize('version', \"Print version.\") },\n\t'verbose': { type: 'boolean', cat: 't', global: true, description: localize('verbose', \"Print verbose output (implies --wait).\") },\n\t'log': { type: 'string[]', cat: 't', args: 'level', global: true, description: localize('log', \"Log level to use. Default is 'info'. Allowed values are 'critical', 'error', 'warn', 'info', 'debug', 'trace', 'off'. You can also configure the log level of an extension by passing extension id and log level in the following format: '${publisher}.${name}:${logLevel}'. For example: 'vscode.csharp:trace'. Can receive one or more such entries.\") },\n\t'status': { type: 'boolean', alias: 's', cat: 't', description: localize('status', \"Print process usage and diagnostics information.\") },\n\t'prof-startup': { type: 'boolean', cat: 't', description: localize('prof-startup', \"Run CPU profiler during startup.\") },\n\t'prof-append-timers': { type: 'string' },\n\t'prof-duration-markers': { type: 'string[]' },\n\t'prof-duration-markers-file': { type: 'string' },\n\t'no-cached-data': { type: 'boolean' },\n\t'prof-startup-prefix': { type: 'string' },\n\t'prof-v8-extensions': { type: 'boolean' },\n\t'disable-extensions': { type: 'boolean', deprecates: ['disableExtensions'], cat: 't', description: localize('disableExtensions', \"Disable all installed extensions. This option is not persisted and is effective only when the command opens a new window.\") },\n\t'disable-extension': { type: 'string[]', cat: 't', args: 'ext-id', description: localize('disableExtension', \"Disable the provided extension. This option is not persisted and is effective only when the command opens a new window.\") },\n\t'sync': { type: 'string', cat: 't', description: localize('turn sync', \"Turn sync on or off.\"), args: ['on | off'] },\n\n\t'inspect-extensions': { type: 'string', allowEmptyValue: true, deprecates: ['debugPluginHost'], args: 'port', cat: 't', description: localize('inspect-extensions', \"Allow debugging and profiling of extensions. Check the developer tools for the connection URI.\") },\n\t'inspect-brk-extensions': { type: 'string', allowEmptyValue: true, deprecates: ['debugBrkPluginHost'], args: 'port', cat: 't', description: localize('inspect-brk-extensions', \"Allow debugging and profiling of extensions with the extension host being paused after start. Check the developer tools for the connection URI.\") },\n\t'disable-lcd-text': { type: 'boolean', cat: 't', description: localize('disableLCDText', \"Disable LCD font rendering.\") },\n\t'disable-gpu': { type: 'boolean', cat: 't', description: localize('disableGPU', \"Disable GPU hardware acceleration.\") },\n\t'disable-chromium-sandbox': { type: 'boolean', cat: 't', description: localize('disableChromiumSandbox', \"Use this option only when there is requirement to launch the application as sudo user on Linux or when running as an elevated user in an applocker environment on Windows.\") },\n\t'sandbox': { type: 'boolean' },\n\t'locate-shell-integration-path': { type: 'string', cat: 't', args: ['shell'], description: localize('locateShellIntegrationPath', \"Print the path to a terminal shell integration script. Allowed values are 'bash', 'pwsh', 'zsh' or 'fish'.\") },\n\t'telemetry': { type: 'boolean', cat: 't', description: localize('telemetry', \"Shows all telemetry events which VS code collects.\") },\n\n\t'remote': { type: 'string', allowEmptyValue: true },\n\t'folder-uri': { type: 'string[]', cat: 'o', args: 'uri' },\n\t'file-uri': { type: 'string[]', cat: 'o', args: 'uri' },\n\n\t'locate-extension': { type: 'string[]' },\n\t'extensionDevelopmentPath': { type: 'string[]' },\n\t'extensionDevelopmentKind': { type: 'string[]' },\n\t'extensionTestsPath': { type: 'string' },\n\t'extensionEnvironment': { type: 'string' },\n\t'debugId': { type: 'string' },\n\t'debugRenderer': { type: 'boolean' },\n\t'inspect-ptyhost': { type: 'string', allowEmptyValue: true },\n\t'inspect-brk-ptyhost': { type: 'string', allowEmptyValue: true },\n\t'inspect-search': { type: 'string', deprecates: ['debugSearch'], allowEmptyValue: true },\n\t'inspect-brk-search': { type: 'string', deprecates: ['debugBrkSearch'], allowEmptyValue: true },\n\t'inspect-sharedprocess': { type: 'string', allowEmptyValue: true },\n\t'inspect-brk-sharedprocess': { type: 'string', allowEmptyValue: true },\n\t'export-default-configuration': { type: 'string' },\n\t'export-policy-data': { type: 'string', allowEmptyValue: true },\n\t'install-source': { type: 'string' },\n\t'enable-smoke-test-driver': { type: 'boolean' },\n\t'logExtensionHostCommunication': { type: 'boolean' },\n\t'skip-release-notes': { type: 'boolean' },\n\t'skip-welcome': { type: 'boolean' },\n\t'disable-telemetry': { type: 'boolean' },\n\t'disable-updates': { type: 'boolean' },\n\t'transient': { type: 'boolean', cat: 't', description: localize('transient', \"Run with temporary data and extension directories, as if launched for the first time.\") },\n\t'use-inmemory-secretstorage': { type: 'boolean', deprecates: ['disable-keytar'] },\n\t'password-store': { type: 'string' },\n\t'disable-workspace-trust': { type: 'boolean' },\n\t'disable-crash-reporter': { type: 'boolean' },\n\t'crash-reporter-directory': { type: 'string' },\n\t'crash-reporter-id': { type: 'string' },\n\t'skip-add-to-recently-opened': { type: 'boolean' },\n\t'open-url': { type: 'boolean' },\n\t'file-write': { type: 'boolean' },\n\t'file-chmod': { type: 'boolean' },\n\t'install-builtin-extension': { type: 'string[]' },\n\t'force': { type: 'boolean' },\n\t'do-not-sync': { type: 'boolean' },\n\t'do-not-include-pack-dependencies': { type: 'boolean' },\n\t'trace': { type: 'boolean' },\n\t'trace-memory-infra': { type: 'boolean' },\n\t'trace-category-filter': { type: 'string' },\n\t'trace-options': { type: 'string' },\n\t'preserve-env': { type: 'boolean' },\n\t'force-user-env': { type: 'boolean' },\n\t'force-disable-user-env': { type: 'boolean' },\n\t'open-devtools': { type: 'boolean' },\n\t'disable-gpu-sandbox': { type: 'boolean' },\n\t'logsPath': { type: 'string' },\n\t'__enable-file-policy': { type: 'boolean' },\n\t'editSessionId': { type: 'string' },\n\t'continueOn': { type: 'string' },\n\t'enable-coi': { type: 'boolean' },\n\t'unresponsive-sample-interval': { type: 'string' },\n\t'unresponsive-sample-period': { type: 'string' },\n\t'enable-rdp-display-tracking': { type: 'boolean' },\n\t'disable-layout-restore': { type: 'boolean' },\n\t'disable-experiments': { type: 'boolean' },\n\n\t// chromium flags\n\t'no-proxy-server': { type: 'boolean' },\n\t// Minimist incorrectly parses keys that start with `--no`\n\t// https://github.com/substack/minimist/blob/aeb3e27dae0412de5c0494e9563a5f10c82cc7a9/index.js#L118-L121\n\t// If --no-sandbox is passed via cli wrapper it will be treated as --sandbox which is incorrect, we use\n\t// the alias here to make sure --no-sandbox is always respected.\n\t// For https://github.com/microsoft/vscode/issues/128279\n\t'no-sandbox': { type: 'boolean', alias: 'sandbox' },\n\t'proxy-server': { type: 'string' },\n\t'proxy-bypass-list': { type: 'string' },\n\t'proxy-pac-url': { type: 'string' },\n\t'js-flags': { type: 'string' }, // chrome js flags\n\t'inspect': { type: 'string', allowEmptyValue: true },\n\t'inspect-brk': { type: 'string', allowEmptyValue: true },\n\t'nolazy': { type: 'boolean' }, // node inspect\n\t'force-device-scale-factor': { type: 'string' },\n\t'force-renderer-accessibility': { type: 'boolean' },\n\t'ignore-certificate-errors': { type: 'boolean' },\n\t'allow-insecure-localhost': { type: 'boolean' },\n\t'log-net-log': { type: 'string' },\n\t'vmodule': { type: 'string' },\n\t'_urls': { type: 'string[]' },\n\t'disable-dev-shm-usage': { type: 'boolean' },\n\t'profile-temp': { type: 'boolean' },\n\t'ozone-platform': { type: 'string' },\n\t'enable-tracing': { type: 'string' },\n\t'trace-startup-format': { type: 'string' },\n\t'trace-startup-file': { type: 'string' },\n\t'trace-startup-duration': { type: 'string' },\n\t'xdg-portal-required-version': { type: 'string' },\n\n\t_: { type: 'string[]' } // main arguments\n};\n\nexport interface ErrorReporter {\n\tonUnknownOption(id: string): void;\n\tonMultipleValues(id: string, usedValue: string): void;\n\tonEmptyValue(id: string): void;\n\tonDeprecatedOption(deprecatedId: string, message: string): void;\n\n\tgetSubcommandReporter?(command: string): ErrorReporter;\n}\n\nconst ignoringReporter = {\n\tonUnknownOption: () => { },\n\tonMultipleValues: () => { },\n\tonEmptyValue: () => { },\n\tonDeprecatedOption: () => { }\n};\n\nexport function parseArgs<T>(args: string[], options: OptionDescriptions<T>, errorReporter: ErrorReporter = ignoringReporter): T {\n\t// Find the first non-option arg, which also isn't the value for a previous `--flag`\n\tconst firstPossibleCommand = args.find((a, i) => a.length > 0 && a[0] !== '-' && options.hasOwnProperty(a) && options[a as T].type === 'subcommand');\n\n\tconst alias: { [key: string]: string } = {};\n\tconst stringOptions: string[] = ['_'];\n\tconst booleanOptions: string[] = [];\n\tconst globalOptions: Record<string, Option<'boolean'> | Option<'string'> | Option<'string[]'>> = {};\n\tlet command: Subcommand<Record<string, unknown>> | undefined = undefined;\n\tfor (const optionId in options) {\n\t\tconst o = options[optionId];\n\t\tif (o.type === 'subcommand') {\n\t\t\tif (optionId === firstPossibleCommand) {\n\t\t\t\tcommand = o;\n\t\t\t}\n\t\t} else {\n\t\t\tif (o.alias) {\n\t\t\t\talias[optionId] = o.alias;\n\t\t\t}\n\n\t\t\tif (o.type === 'string' || o.type === 'string[]') {\n\t\t\t\tstringOptions.push(optionId);\n\t\t\t\tif (o.deprecates) {\n\t\t\t\t\tstringOptions.push(...o.deprecates);\n\t\t\t\t}\n\t\t\t} else if (o.type === 'boolean') {\n\t\t\t\tbooleanOptions.push(optionId);\n\t\t\t\tif (o.deprecates) {\n\t\t\t\t\tbooleanOptions.push(...o.deprecates);\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (o.global) {\n\t\t\t\tglobalOptions[optionId] = o;\n\t\t\t}\n\t\t}\n\t}\n\tif (command && firstPossibleCommand) {\n\t\tconst options: Record<string, Option<'boolean'> | Option<'string'> | Option<'string[]'> | Subcommand<Record<string, unknown>>> = globalOptions;\n\t\tfor (const optionId in command.options) {\n\t\t\toptions[optionId] = command.options[optionId];\n\t\t}\n\t\tconst newArgs = args.filter(a => a !== firstPossibleCommand);\n\t\tconst reporter = errorReporter.getSubcommandReporter ? errorReporter.getSubcommandReporter(firstPossibleCommand) : undefined;\n\t\tconst subcommandOptions = parseArgs(newArgs, options as OptionDescriptions<Record<string, unknown>>, reporter);\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\treturn <T>{\n\t\t\t[firstPossibleCommand]: subcommandOptions,\n\t\t\t_: []\n\t\t};\n\t}\n\n\n\t// remove aliases to avoid confusion\n\tconst parsedArgs = minimist(args, { string: stringOptions, boolean: booleanOptions, alias });\n\n\tconst cleanedArgs: Record<string, unknown> = {};\n\tconst remainingArgs: Record<string, unknown> = parsedArgs;\n\n\t// https://github.com/microsoft/vscode/issues/58177, https://github.com/microsoft/vscode/issues/106617\n\tcleanedArgs._ = parsedArgs._.map(arg => String(arg)).filter(arg => arg.length > 0);\n\n\tdelete remainingArgs._;\n\n\tfor (const optionId in options) {\n\t\tconst o = options[optionId];\n\t\tif (o.type === 'subcommand') {\n\t\t\tcontinue;\n\t\t}\n\t\tif (o.alias) {\n\t\t\tdelete remainingArgs[o.alias];\n\t\t}\n\n\t\tlet val = remainingArgs[optionId];\n\t\tif (o.deprecates) {\n\t\t\tfor (const deprecatedId of o.deprecates) {\n\t\t\t\tif (remainingArgs.hasOwnProperty(deprecatedId)) {\n\t\t\t\t\tif (!val) {\n\t\t\t\t\t\tval = remainingArgs[deprecatedId];\n\t\t\t\t\t\tif (val) {\n\t\t\t\t\t\t\terrorReporter.onDeprecatedOption(deprecatedId, o.deprecationMessage || localize('deprecated.useInstead', 'Use {0} instead.', optionId));\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tdelete remainingArgs[deprecatedId];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (typeof val !== 'undefined') {\n\t\t\tif (o.type === 'string[]') {\n\t\t\t\tif (!Array.isArray(val)) {\n\t\t\t\t\tval = [val];\n\t\t\t\t}\n\t\t\t\tif (!o.allowEmptyValue) {\n\t\t\t\t\tconst sanitized = (val as string[]).filter((v: string) => v.length > 0);\n\t\t\t\t\tif (sanitized.length !== (val as string[]).length) {\n\t\t\t\t\t\terrorReporter.onEmptyValue(optionId);\n\t\t\t\t\t\tval = sanitized.length > 0 ? sanitized : undefined;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (o.type === 'string') {\n\t\t\t\tif (Array.isArray(val)) {\n\t\t\t\t\tval = val.pop(); // take the last\n\t\t\t\t\terrorReporter.onMultipleValues(optionId, val as string);\n\t\t\t\t} else if (!val && !o.allowEmptyValue) {\n\t\t\t\t\terrorReporter.onEmptyValue(optionId);\n\t\t\t\t\tval = undefined;\n\t\t\t\t}\n\t\t\t}\n\t\t\tcleanedArgs[optionId] = val;\n\n\t\t\tif (o.deprecationMessage) {\n\t\t\t\terrorReporter.onDeprecatedOption(optionId, o.deprecationMessage);\n\t\t\t}\n\t\t}\n\t\tdelete remainingArgs[optionId];\n\t}\n\n\tfor (const key in remainingArgs) {\n\t\terrorReporter.onUnknownOption(key);\n\t}\n\n\treturn cleanedArgs as T;\n}\n\nfunction formatUsage(optionId: string, option: Option<'boolean'> | Option<'string'> | Option<'string[]'>) {\n\tlet args = '';\n\tif (option.args) {\n\t\tif (Array.isArray(option.args)) {\n\t\t\targs = ` <${option.args.join('> <')}>`;\n\t\t} else {\n\t\t\targs = ` <${option.args}>`;\n\t\t}\n\t}\n\tif (option.alias) {\n\t\treturn `-${option.alias} --${optionId}${args}`;\n\t}\n\treturn `--${optionId}${args}`;\n}\n\n// exported only for testing\nexport function formatOptions(options: OptionDescriptions<unknown> | Record<string, Option<'boolean'> | Option<'string'> | Option<'string[]'>>, columns: number): string[] {\n\tconst usageTexts: [string, string][] = [];\n\tfor (const optionId in options) {\n\t\tconst o = options[optionId as keyof typeof options] as Option<'boolean'> | Option<'string'> | Option<'string[]'>;\n\t\tconst usageText = formatUsage(optionId, o);\n\t\tusageTexts.push([usageText, o.description!]);\n\t}\n\treturn formatUsageTexts(usageTexts, columns);\n}\n\nfunction formatUsageTexts(usageTexts: [string, string][], columns: number) {\n\tconst maxLength = usageTexts.reduce((previous, e) => Math.max(previous, e[0].length), 12);\n\tconst argLength = maxLength + 2/*left padding*/ + 1/*right padding*/;\n\tif (columns - argLength < 25) {\n\t\t// Use a condensed version on narrow terminals\n\t\treturn usageTexts.reduce<string[]>((r, ut) => r.concat([`  ${ut[0]}`, `      ${ut[1]}`]), []);\n\t}\n\tconst descriptionColumns = columns - argLength - 1;\n\tconst result: string[] = [];\n\tfor (const ut of usageTexts) {\n\t\tconst usage = ut[0];\n\t\tconst wrappedDescription = wrapText(ut[1], descriptionColumns);\n\t\tconst keyPadding = indent(argLength - usage.length - 2/*left padding*/);\n\t\tresult.push('  ' + usage + keyPadding + wrappedDescription[0]);\n\t\tfor (let i = 1; i < wrappedDescription.length; i++) {\n\t\t\tresult.push(indent(argLength) + wrappedDescription[i]);\n\t\t}\n\t}\n\treturn result;\n}\n\nfunction indent(count: number): string {\n\treturn ' '.repeat(count);\n}\n\nfunction wrapText(text: string, columns: number): string[] {\n\tconst lines: string[] = [];\n\twhile (text.length) {\n\t\tlet index = text.length < columns ? text.length : text.lastIndexOf(' ', columns);\n\t\tif (index === 0) {\n\t\t\tindex = columns;\n\t\t}\n\t\tconst line = text.slice(0, index).trim();\n\t\ttext = text.slice(index).trimStart();\n\t\tlines.push(line);\n\t}\n\treturn lines;\n}\n\nexport function buildHelpMessage(productName: string, executableName: string, version: string, options: OptionDescriptions<unknown> | Record<string, Option<'boolean'> | Option<'string'> | Option<'string[]'> | Subcommand<Record<string, unknown>>>, capabilities?: { noPipe?: boolean; noInputFiles?: boolean; isChat?: boolean }): string {\n\tconst columns = (process.stdout).isTTY && (process.stdout).columns || 80;\n\tconst inputFiles = capabilities?.noInputFiles ? '' : capabilities?.isChat ? ` [${localize('cliPrompt', 'prompt')}]` : ` [${localize('paths', 'paths')}...]`;\n\tconst subcommand = capabilities?.isChat ? ' chat' : '';\n\n\tconst help = [`${productName} ${version}`];\n\thelp.push('');\n\thelp.push(`${localize('usage', \"Usage\")}: ${executableName}${subcommand} [${localize('options', \"options\")}]${inputFiles}`);\n\thelp.push('');\n\tif (capabilities?.noPipe !== true) {\n\t\thelp.push(buildStdinMessage(executableName, capabilities?.isChat));\n\t\thelp.push('');\n\t}\n\tconst optionsByCategory: { [P in keyof typeof helpCategories]?: Record<string, Option<'boolean'> | Option<'string'> | Option<'string[]'>> } = {};\n\tconst subcommands: { command: string; description: string }[] = [];\n\tfor (const optionId in options) {\n\t\tconst o = options[optionId as keyof typeof options] as Option<'boolean'> | Option<'string'> | Option<'string[]'> | Subcommand<Record<string, unknown>>;\n\t\tif (o.type === 'subcommand') {\n\t\t\tif (o.description) {\n\t\t\t\tsubcommands.push({ command: optionId, description: o.description });\n\t\t\t}\n\t\t} else if (o.description && o.cat) {\n\t\t\tconst cat = o.cat;\n\t\t\tlet optionsByCat = optionsByCategory[cat];\n\t\t\tif (!optionsByCat) {\n\t\t\t\toptionsByCategory[cat] = optionsByCat = {};\n\t\t\t}\n\t\t\toptionsByCat[optionId] = o;\n\t\t}\n\t}\n\n\tfor (const helpCategoryKey in optionsByCategory) {\n\t\tconst key = <keyof typeof helpCategories>helpCategoryKey;\n\n\t\tconst categoryOptions = optionsByCategory[key];\n\t\tif (categoryOptions) {\n\t\t\thelp.push(helpCategories[key]);\n\t\t\thelp.push(...formatOptions(categoryOptions, columns));\n\t\t\thelp.push('');\n\t\t}\n\t}\n\n\tif (subcommands.length) {\n\t\thelp.push(localize('subcommands', \"Subcommands\"));\n\t\thelp.push(...formatUsageTexts(subcommands.map(s => [s.command, s.description]), columns));\n\t\thelp.push('');\n\t}\n\n\treturn help.join('\\n');\n}\n\nexport function buildStdinMessage(executableName: string, isChat?: boolean): string {\n\tlet example: string;\n\tif (isWindows) {\n\t\tif (isChat) {\n\t\t\texample = `echo Hello World | ${executableName} chat <prompt> -`;\n\t\t} else {\n\t\t\texample = `echo Hello World | ${executableName} -`;\n\t\t}\n\t} else {\n\t\tif (isChat) {\n\t\t\texample = `ps aux | grep code | ${executableName} chat <prompt> -`;\n\t\t} else {\n\t\t\texample = `ps aux | grep code | ${executableName} -`;\n\t\t}\n\t}\n\n\treturn localize('stdinUsage', \"To read from stdin, append '-' (e.g. '{0}')\", example);\n}\n\nexport function buildVersionMessage(version: string | undefined, commit: string | undefined): string {\n\treturn `${version || localize('unknownVersion', \"Unknown version\")}\\n${commit || localize('unknownCommit', \"Unknown commit\")}\\n${process.arch}`;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { homedir, tmpdir } from 'os';\nimport { NativeParsedArgs } from '../common/argv.js';\nimport { IDebugParams } from '../common/environment.js';\nimport { AbstractNativeEnvironmentService, parseDebugParams } from '../common/environmentService.js';\nimport { getUserDataPath } from './userDataPath.js';\nimport { IProductService } from '../../product/common/productService.js';\n\nexport class NativeEnvironmentService extends AbstractNativeEnvironmentService {\n\n\tconstructor(args: NativeParsedArgs, productService: IProductService) {\n\t\tsuper(args, {\n\t\t\thomeDir: homedir(),\n\t\t\ttmpDir: tmpdir(),\n\t\t\tuserDataDir: getUserDataPath(args, productService.nameShort)\n\t\t}, productService);\n\t}\n}\n\nexport function parsePtyHostDebugPort(args: NativeParsedArgs, isBuilt: boolean): IDebugParams {\n\treturn parseDebugParams(args['inspect-ptyhost'], args['inspect-brk-ptyhost'], 5877, isBuilt, args.extensionEnvironment);\n}\n\nexport function parseSharedProcessDebugPort(args: NativeParsedArgs, isBuilt: boolean): IDebugParams {\n\treturn parseDebugParams(args['inspect-sharedprocess'], args['inspect-brk-sharedprocess'], 5879, isBuilt, args.extensionEnvironment);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { localize } from '../../nls.js';\nimport { Lazy } from './lazy.js';\nimport { LANGUAGE_DEFAULT } from './platform.js';\n\nconst minute = 60;\nconst hour = minute * 60;\nconst day = hour * 24;\nconst week = day * 7;\nconst month = day * 30;\nconst year = day * 365;\n\n/**\n * Create a localized difference of the time between now and the specified date.\n * @param date The date to generate the difference from.\n * @param appendAgoLabel Whether to append the \" ago\" to the end.\n * @param useFullTimeWords Whether to use full words (eg. seconds) instead of\n * shortened (eg. secs).\n * @param disallowNow Whether to disallow the string \"now\" when the difference\n * is less than 30 seconds.\n */\nexport function fromNow(date: number | Date, appendAgoLabel?: boolean, useFullTimeWords?: boolean, disallowNow?: boolean): string {\n\tif (typeof date !== 'number') {\n\t\tdate = date.getTime();\n\t}\n\n\tconst seconds = Math.round((new Date().getTime() - date) / 1000);\n\tif (seconds < -30) {\n\t\treturn localize('date.fromNow.in', 'in {0}', fromNow(new Date().getTime() + seconds * 1000, false));\n\t}\n\n\tif (!disallowNow && seconds < 30) {\n\t\treturn localize('date.fromNow.now', 'now');\n\t}\n\n\tlet value: number;\n\tif (seconds < minute) {\n\t\tvalue = seconds;\n\n\t\tif (appendAgoLabel) {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.seconds.singular.ago.fullWord', '{0} second ago', value)\n\t\t\t\t\t: localize('date.fromNow.seconds.singular.ago', '{0} sec ago', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.seconds.plural.ago.fullWord', '{0} seconds ago', value)\n\t\t\t\t\t: localize('date.fromNow.seconds.plural.ago', '{0} secs ago', value);\n\t\t\t}\n\t\t} else {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.seconds.singular.fullWord', '{0} second', value)\n\t\t\t\t\t: localize('date.fromNow.seconds.singular', '{0} sec', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.seconds.plural.fullWord', '{0} seconds', value)\n\t\t\t\t\t: localize('date.fromNow.seconds.plural', '{0} secs', value);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (seconds < hour) {\n\t\tvalue = Math.floor(seconds / minute);\n\t\tif (appendAgoLabel) {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.minutes.singular.ago.fullWord', '{0} minute ago', value)\n\t\t\t\t\t: localize('date.fromNow.minutes.singular.ago', '{0} min ago', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.minutes.plural.ago.fullWord', '{0} minutes ago', value)\n\t\t\t\t\t: localize('date.fromNow.minutes.plural.ago', '{0} mins ago', value);\n\t\t\t}\n\t\t} else {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.minutes.singular.fullWord', '{0} minute', value)\n\t\t\t\t\t: localize('date.fromNow.minutes.singular', '{0} min', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.minutes.plural.fullWord', '{0} minutes', value)\n\t\t\t\t\t: localize('date.fromNow.minutes.plural', '{0} mins', value);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (seconds < day) {\n\t\tvalue = Math.floor(seconds / hour);\n\t\tif (appendAgoLabel) {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.hours.singular.ago.fullWord', '{0} hour ago', value)\n\t\t\t\t\t: localize('date.fromNow.hours.singular.ago', '{0} hr ago', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.hours.plural.ago.fullWord', '{0} hours ago', value)\n\t\t\t\t\t: localize('date.fromNow.hours.plural.ago', '{0} hrs ago', value);\n\t\t\t}\n\t\t} else {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.hours.singular.fullWord', '{0} hour', value)\n\t\t\t\t\t: localize('date.fromNow.hours.singular', '{0} hr', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.hours.plural.fullWord', '{0} hours', value)\n\t\t\t\t\t: localize('date.fromNow.hours.plural', '{0} hrs', value);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (seconds < week) {\n\t\tvalue = Math.floor(seconds / day);\n\t\tif (appendAgoLabel) {\n\t\t\treturn value === 1\n\t\t\t\t? localize('date.fromNow.days.singular.ago', '{0} day ago', value)\n\t\t\t\t: localize('date.fromNow.days.plural.ago', '{0} days ago', value);\n\t\t} else {\n\t\t\treturn value === 1\n\t\t\t\t? localize('date.fromNow.days.singular', '{0} day', value)\n\t\t\t\t: localize('date.fromNow.days.plural', '{0} days', value);\n\t\t}\n\t}\n\n\tif (seconds < month) {\n\t\tvalue = Math.floor(seconds / week);\n\t\tif (appendAgoLabel) {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.weeks.singular.ago.fullWord', '{0} week ago', value)\n\t\t\t\t\t: localize('date.fromNow.weeks.singular.ago', '{0} wk ago', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.weeks.plural.ago.fullWord', '{0} weeks ago', value)\n\t\t\t\t\t: localize('date.fromNow.weeks.plural.ago', '{0} wks ago', value);\n\t\t\t}\n\t\t} else {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.weeks.singular.fullWord', '{0} week', value)\n\t\t\t\t\t: localize('date.fromNow.weeks.singular', '{0} wk', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.weeks.plural.fullWord', '{0} weeks', value)\n\t\t\t\t\t: localize('date.fromNow.weeks.plural', '{0} wks', value);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (seconds < year) {\n\t\tvalue = Math.floor(seconds / month);\n\t\tif (appendAgoLabel) {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.months.singular.ago.fullWord', '{0} month ago', value)\n\t\t\t\t\t: localize('date.fromNow.months.singular.ago', '{0} mo ago', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.months.plural.ago.fullWord', '{0} months ago', value)\n\t\t\t\t\t: localize('date.fromNow.months.plural.ago', '{0} mos ago', value);\n\t\t\t}\n\t\t} else {\n\t\t\tif (value === 1) {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.months.singular.fullWord', '{0} month', value)\n\t\t\t\t\t: localize('date.fromNow.months.singular', '{0} mo', value);\n\t\t\t} else {\n\t\t\t\treturn useFullTimeWords\n\t\t\t\t\t? localize('date.fromNow.months.plural.fullWord', '{0} months', value)\n\t\t\t\t\t: localize('date.fromNow.months.plural', '{0} mos', value);\n\t\t\t}\n\t\t}\n\t}\n\n\tvalue = Math.floor(seconds / year);\n\tif (appendAgoLabel) {\n\t\tif (value === 1) {\n\t\t\treturn useFullTimeWords\n\t\t\t\t? localize('date.fromNow.years.singular.ago.fullWord', '{0} year ago', value)\n\t\t\t\t: localize('date.fromNow.years.singular.ago', '{0} yr ago', value);\n\t\t} else {\n\t\t\treturn useFullTimeWords\n\t\t\t\t? localize('date.fromNow.years.plural.ago.fullWord', '{0} years ago', value)\n\t\t\t\t: localize('date.fromNow.years.plural.ago', '{0} yrs ago', value);\n\t\t}\n\t} else {\n\t\tif (value === 1) {\n\t\t\treturn useFullTimeWords\n\t\t\t\t? localize('date.fromNow.years.singular.fullWord', '{0} year', value)\n\t\t\t\t: localize('date.fromNow.years.singular', '{0} yr', value);\n\t\t} else {\n\t\t\treturn useFullTimeWords\n\t\t\t\t? localize('date.fromNow.years.plural.fullWord', '{0} years', value)\n\t\t\t\t: localize('date.fromNow.years.plural', '{0} yrs', value);\n\t\t}\n\t}\n}\n\nexport function fromNowByDay(date: number | Date, appendAgoLabel?: boolean, useFullTimeWords?: boolean): string {\n\tif (typeof date !== 'number') {\n\t\tdate = date.getTime();\n\t}\n\n\tconst todayMidnightTime = new Date();\n\ttodayMidnightTime.setHours(0, 0, 0, 0);\n\tconst yesterdayMidnightTime = new Date(todayMidnightTime.getTime());\n\tyesterdayMidnightTime.setDate(yesterdayMidnightTime.getDate() - 1);\n\n\tif (date > todayMidnightTime.getTime()) {\n\t\treturn localize('today', 'Today');\n\t}\n\n\tif (date > yesterdayMidnightTime.getTime()) {\n\t\treturn localize('yesterday', 'Yesterday');\n\t}\n\n\treturn fromNow(date, appendAgoLabel, useFullTimeWords);\n}\n\n/**\n * Gets a readable duration with intelligent/lossy precision. For example \"40ms\" or \"3.040s\")\n * @param ms The duration to get in milliseconds.\n * @param useFullTimeWords Whether to use full words (eg. seconds) instead of\n * shortened (eg. secs).\n */\nexport function getDurationString(ms: number, useFullTimeWords?: boolean) {\n\tconst seconds = Math.abs(ms / 1000);\n\tif (seconds < 1) {\n\t\treturn useFullTimeWords\n\t\t\t? localize('duration.ms.full', '{0} milliseconds', ms)\n\t\t\t: localize('duration.ms', '{0}ms', ms);\n\t}\n\tif (seconds < minute) {\n\t\treturn useFullTimeWords\n\t\t\t? localize('duration.s.full', '{0} seconds', Math.round(ms) / 1000)\n\t\t\t: localize('duration.s', '{0}s', Math.round(ms) / 1000);\n\t}\n\tif (seconds < hour) {\n\t\treturn useFullTimeWords\n\t\t\t? localize('duration.m.full', '{0} minutes', Math.round(ms / (1000 * minute)))\n\t\t\t: localize('duration.m', '{0} mins', Math.round(ms / (1000 * minute)));\n\t}\n\tif (seconds < day) {\n\t\treturn useFullTimeWords\n\t\t\t? localize('duration.h.full', '{0} hours', Math.round(ms / (1000 * hour)))\n\t\t\t: localize('duration.h', '{0} hrs', Math.round(ms / (1000 * hour)));\n\t}\n\treturn localize('duration.d', '{0} days', Math.round(ms / (1000 * day)));\n}\n\nexport function toLocalISOString(date: Date): string {\n\treturn date.getFullYear() +\n\t\t'-' + String(date.getMonth() + 1).padStart(2, '0') +\n\t\t'-' + String(date.getDate()).padStart(2, '0') +\n\t\t'T' + String(date.getHours()).padStart(2, '0') +\n\t\t':' + String(date.getMinutes()).padStart(2, '0') +\n\t\t':' + String(date.getSeconds()).padStart(2, '0') +\n\t\t'.' + (date.getMilliseconds() / 1000).toFixed(3).slice(2, 5) +\n\t\t'Z';\n}\n\nexport const safeIntl = {\n\tDateTimeFormat(locales?: Intl.LocalesArgument, options?: Intl.DateTimeFormatOptions): Lazy<Intl.DateTimeFormat> {\n\t\treturn new Lazy(() => {\n\t\t\ttry {\n\t\t\t\treturn new Intl.DateTimeFormat(locales, options);\n\t\t\t} catch {\n\t\t\t\treturn new Intl.DateTimeFormat(undefined, options);\n\t\t\t}\n\t\t});\n\t},\n\tCollator(locales?: Intl.LocalesArgument, options?: Intl.CollatorOptions): Lazy<Intl.Collator> {\n\t\treturn new Lazy(() => {\n\t\t\ttry {\n\t\t\t\treturn new Intl.Collator(locales, options);\n\t\t\t} catch {\n\t\t\t\treturn new Intl.Collator(undefined, options);\n\t\t\t}\n\t\t});\n\t},\n\tSegmenter(locales?: Intl.LocalesArgument, options?: Intl.SegmenterOptions): Lazy<Intl.Segmenter> {\n\t\treturn new Lazy(() => {\n\t\t\ttry {\n\t\t\t\treturn new Intl.Segmenter(locales, options);\n\t\t\t} catch {\n\t\t\t\treturn new Intl.Segmenter(undefined, options);\n\t\t\t}\n\t\t});\n\t},\n\tLocale(tag: Intl.Locale | string, options?: Intl.LocaleOptions): Lazy<Intl.Locale> {\n\t\treturn new Lazy(() => {\n\t\t\ttry {\n\t\t\t\treturn new Intl.Locale(tag, options);\n\t\t\t} catch {\n\t\t\t\treturn new Intl.Locale(LANGUAGE_DEFAULT, options);\n\t\t\t}\n\t\t});\n\t},\n\tNumberFormat(locales?: Intl.LocalesArgument, options?: Intl.NumberFormatOptions): Lazy<Intl.NumberFormat> {\n\t\treturn new Lazy(() => {\n\t\t\ttry {\n\t\t\t\treturn new Intl.NumberFormat(locales, options);\n\t\t\t} catch {\n\t\t\t\treturn new Intl.NumberFormat(undefined, options);\n\t\t\t}\n\t\t});\n\t}\n};\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { toLocalISOString } from '../../../base/common/date.js';\nimport { memoize } from '../../../base/common/decorators.js';\nimport { FileAccess, Schemas } from '../../../base/common/network.js';\nimport { dirname, join, normalize, resolve } from '../../../base/common/path.js';\nimport { env } from '../../../base/common/process.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { NativeParsedArgs } from './argv.js';\nimport { ExtensionKind, IExtensionHostDebugParams, INativeEnvironmentService } from './environment.js';\nimport { IProductService } from '../../product/common/productService.js';\n\nexport const EXTENSION_IDENTIFIER_WITH_LOG_REGEX = /^([^.]+\\..+)[:=](.+)$/;\n\nexport interface INativeEnvironmentPaths {\n\n\t/**\n\t * The user data directory to use for anything that should be\n\t * persisted except for the content that is meant for the `homeDir`.\n\t *\n\t * Only one instance of VSCode can use the same `userDataDir`.\n\t */\n\tuserDataDir: string;\n\n\t/**\n\t * The user home directory mainly used for persisting extensions\n\t * and global configuration that should be shared across all\n\t * versions.\n\t */\n\thomeDir: string;\n\n\t/**\n\t * OS tmp dir.\n\t */\n\ttmpDir: string;\n}\n\nexport abstract class AbstractNativeEnvironmentService implements INativeEnvironmentService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\t@memoize\n\tget appRoot(): string { return dirname(FileAccess.asFileUri('').fsPath); }\n\n\t@memoize\n\tget userHome(): URI { return URI.file(this.paths.homeDir); }\n\n\t@memoize\n\tget userDataPath(): string { return this.paths.userDataDir; }\n\n\t@memoize\n\tget appSettingsHome(): URI { return URI.file(join(this.userDataPath, 'User')); }\n\n\t@memoize\n\tget tmpDir(): URI { return URI.file(this.paths.tmpDir); }\n\n\t@memoize\n\tget cacheHome(): URI { return URI.file(this.userDataPath); }\n\n\t@memoize\n\tget stateResource(): URI { return joinPath(this.appSettingsHome, 'globalStorage', 'storage.json'); }\n\n\t@memoize\n\tget userRoamingDataHome(): URI { return this.appSettingsHome.with({ scheme: Schemas.vscodeUserData }); }\n\n\t@memoize\n\tget userDataSyncHome(): URI { return joinPath(this.appSettingsHome, 'sync'); }\n\n\tget logsHome(): URI {\n\t\tif (!this.args.logsPath) {\n\t\t\tconst key = toLocalISOString(new Date()).replace(/-|:|\\.\\d+Z$/g, '');\n\t\t\tthis.args.logsPath = join(this.userDataPath, 'logs', key);\n\t\t}\n\n\t\treturn URI.file(this.args.logsPath);\n\t}\n\n\t@memoize\n\tget sync(): 'on' | 'off' | undefined { return this.args.sync; }\n\n\t@memoize\n\tget workspaceStorageHome(): URI { return joinPath(this.appSettingsHome, 'workspaceStorage'); }\n\n\t@memoize\n\tget localHistoryHome(): URI { return joinPath(this.appSettingsHome, 'History'); }\n\n\t@memoize\n\tget keyboardLayoutResource(): URI { return joinPath(this.userRoamingDataHome, 'keyboardLayout.json'); }\n\n\t@memoize\n\tget argvResource(): URI {\n\t\tconst vscodePortable = env['VSCODE_PORTABLE'];\n\t\tif (vscodePortable) {\n\t\t\treturn URI.file(join(vscodePortable, 'argv.json'));\n\t\t}\n\n\t\treturn joinPath(this.userHome, this.productService.dataFolderName, 'argv.json');\n\t}\n\n\t@memoize\n\tget isExtensionDevelopment(): boolean { return !!this.args.extensionDevelopmentPath; }\n\n\t@memoize\n\tget untitledWorkspacesHome(): URI { return URI.file(join(this.userDataPath, 'Workspaces')); }\n\n\t@memoize\n\tget builtinExtensionsPath(): string {\n\t\tconst cliBuiltinExtensionsDir = this.args['builtin-extensions-dir'];\n\t\tif (cliBuiltinExtensionsDir) {\n\t\t\treturn resolve(cliBuiltinExtensionsDir);\n\t\t}\n\n\t\treturn normalize(join(FileAccess.asFileUri('').fsPath, '..', 'extensions'));\n\t}\n\n\tget extensionsDownloadLocation(): URI {\n\t\tconst cliExtensionsDownloadDir = this.args['extensions-download-dir'];\n\t\tif (cliExtensionsDownloadDir) {\n\t\t\treturn URI.file(resolve(cliExtensionsDownloadDir));\n\t\t}\n\n\t\treturn URI.file(join(this.userDataPath, 'CachedExtensionVSIXs'));\n\t}\n\n\t@memoize\n\tget extensionsPath(): string {\n\t\tconst cliExtensionsDir = this.args['extensions-dir'];\n\t\tif (cliExtensionsDir) {\n\t\t\treturn resolve(cliExtensionsDir);\n\t\t}\n\n\t\tconst vscodeExtensions = env['VSCODE_EXTENSIONS'];\n\t\tif (vscodeExtensions) {\n\t\t\treturn vscodeExtensions;\n\t\t}\n\n\t\tconst vscodePortable = env['VSCODE_PORTABLE'];\n\t\tif (vscodePortable) {\n\t\t\treturn join(vscodePortable, 'extensions');\n\t\t}\n\n\t\treturn joinPath(this.userHome, this.productService.dataFolderName, 'extensions').fsPath;\n\t}\n\n\t@memoize\n\tget extensionDevelopmentLocationURI(): URI[] | undefined {\n\t\tconst extensionDevelopmentPaths = this.args.extensionDevelopmentPath;\n\t\tif (Array.isArray(extensionDevelopmentPaths)) {\n\t\t\treturn extensionDevelopmentPaths.map(extensionDevelopmentPath => {\n\t\t\t\tif (/^[^:/?#]+?:\\/\\//.test(extensionDevelopmentPath)) {\n\t\t\t\t\treturn URI.parse(extensionDevelopmentPath);\n\t\t\t\t}\n\n\t\t\t\treturn URI.file(normalize(extensionDevelopmentPath));\n\t\t\t});\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\t@memoize\n\tget extensionDevelopmentKind(): ExtensionKind[] | undefined {\n\t\treturn this.args.extensionDevelopmentKind?.map(kind => kind === 'ui' || kind === 'workspace' || kind === 'web' ? kind : 'workspace');\n\t}\n\n\t@memoize\n\tget extensionTestsLocationURI(): URI | undefined {\n\t\tconst extensionTestsPath = this.args.extensionTestsPath;\n\t\tif (extensionTestsPath) {\n\t\t\tif (/^[^:/?#]+?:\\/\\//.test(extensionTestsPath)) {\n\t\t\t\treturn URI.parse(extensionTestsPath);\n\t\t\t}\n\n\t\t\treturn URI.file(normalize(extensionTestsPath));\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tget disableExtensions(): boolean | string[] {\n\t\tif (this.args['disable-extensions']) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst disableExtensions = this.args['disable-extension'];\n\t\tif (disableExtensions) {\n\t\t\tif (typeof disableExtensions === 'string') {\n\t\t\t\treturn [disableExtensions];\n\t\t\t}\n\n\t\t\tif (Array.isArray(disableExtensions) && disableExtensions.length > 0) {\n\t\t\t\treturn disableExtensions;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t@memoize\n\tget debugExtensionHost(): IExtensionHostDebugParams { return parseExtensionHostDebugPort(this.args, this.isBuilt); }\n\tget debugRenderer(): boolean { return !!this.args.debugRenderer; }\n\n\tget isBuilt(): boolean { return !env['VSCODE_DEV']; }\n\tget verbose(): boolean { return !!this.args.verbose; }\n\n\t@memoize\n\tget logLevel(): string | undefined { return this.args.log?.find(entry => !EXTENSION_IDENTIFIER_WITH_LOG_REGEX.test(entry)); }\n\t@memoize\n\tget extensionLogLevel(): [string, string][] | undefined {\n\t\tconst result: [string, string][] = [];\n\t\tfor (const entry of this.args.log || []) {\n\t\t\tconst matches = EXTENSION_IDENTIFIER_WITH_LOG_REGEX.exec(entry);\n\t\t\tif (matches?.[1] && matches[2]) {\n\t\t\t\tresult.push([matches[1], matches[2]]);\n\t\t\t}\n\t\t}\n\t\treturn result.length ? result : undefined;\n\t}\n\n\t@memoize\n\tget serviceMachineIdResource(): URI { return joinPath(URI.file(this.userDataPath), 'machineid'); }\n\n\tget crashReporterId(): string | undefined { return this.args['crash-reporter-id']; }\n\tget crashReporterDirectory(): string | undefined { return this.args['crash-reporter-directory']; }\n\n\t@memoize\n\tget disableTelemetry(): boolean { return !!this.args['disable-telemetry']; }\n\n\t@memoize\n\tget disableExperiments(): boolean { return !!this.args['disable-experiments']; }\n\n\t@memoize\n\tget disableWorkspaceTrust(): boolean { return !!this.args['disable-workspace-trust']; }\n\n\t@memoize\n\tget useInMemorySecretStorage(): boolean { return !!this.args['use-inmemory-secretstorage']; }\n\n\t@memoize\n\tget policyFile(): URI | undefined {\n\t\tif (this.args['__enable-file-policy']) {\n\t\t\tconst vscodePortable = env['VSCODE_PORTABLE'];\n\t\t\tif (vscodePortable) {\n\t\t\t\treturn URI.file(join(vscodePortable, 'policy.json'));\n\t\t\t}\n\n\t\t\treturn joinPath(this.userHome, this.productService.dataFolderName, 'policy.json');\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tget editSessionId(): string | undefined { return this.args['editSessionId']; }\n\n\tget exportPolicyData(): string | undefined {\n\t\treturn this.args['export-policy-data'];\n\t}\n\n\tget continueOn(): string | undefined {\n\t\treturn this.args['continueOn'];\n\t}\n\n\tset continueOn(value: string | undefined) {\n\t\tthis.args['continueOn'] = value;\n\t}\n\n\tget args(): NativeParsedArgs { return this._args; }\n\n\tconstructor(\n\t\tprivate readonly _args: NativeParsedArgs,\n\t\tprivate readonly paths: INativeEnvironmentPaths,\n\t\tprotected readonly productService: IProductService\n\t) { }\n}\n\nexport function parseExtensionHostDebugPort(args: NativeParsedArgs, isBuilt: boolean): IExtensionHostDebugParams {\n\treturn parseDebugParams(args['inspect-extensions'], args['inspect-brk-extensions'], 5870, isBuilt, args.debugId, args.extensionEnvironment);\n}\n\nexport function parseDebugParams(debugArg: string | undefined, debugBrkArg: string | undefined, defaultBuildPort: number, isBuilt: boolean, debugId?: string, environmentString?: string): IExtensionHostDebugParams {\n\tconst portStr = debugBrkArg || debugArg;\n\tconst port = Number(portStr) || (!isBuilt ? defaultBuildPort : null);\n\tconst brk = port ? Boolean(!!debugBrkArg) : false;\n\tlet env: Record<string, string> | undefined;\n\tif (environmentString) {\n\t\ttry {\n\t\t\tenv = JSON.parse(environmentString);\n\t\t} catch {\n\t\t\t// ignore\n\t\t}\n\t}\n\n\treturn { port, break: brk, debugId, env };\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { homedir } from 'os';\nimport { NativeParsedArgs } from '../common/argv.js';\n\n// This file used to be a pure JS file and was always\n// importing `path` from node.js even though we ship\n// our own version of the library and prefer to use\n// that.\n// However, resolution of user-data-path is critical\n// and while our version of `path` is a copy of node.js\n// one, you never know. As such, preserve the use of\n// the built-in `path` lib for the time being.\n// eslint-disable-next-line local/code-import-patterns\nimport { resolve, isAbsolute, join } from 'path';\n\nconst cwd = process.env['VSCODE_CWD'] || process.cwd();\n\n/**\n * Returns the user data path to use with some rules:\n * - respect portable mode\n * - respect VSCODE_APPDATA environment variable\n * - respect --user-data-dir CLI argument\n */\nexport function getUserDataPath(cliArgs: NativeParsedArgs, productName: string): string {\n\tconst userDataPath = doGetUserDataPath(cliArgs, productName);\n\tconst pathsToResolve = [userDataPath];\n\n\t// If the user-data-path is not absolute, make\n\t// sure to resolve it against the passed in\n\t// current working directory. We cannot use the\n\t// node.js `path.resolve()` logic because it will\n\t// not pick up our `VSCODE_CWD` environment variable\n\t// (https://github.com/microsoft/vscode/issues/120269)\n\tif (!isAbsolute(userDataPath)) {\n\t\tpathsToResolve.unshift(cwd);\n\t}\n\n\treturn resolve(...pathsToResolve);\n}\n\nfunction doGetUserDataPath(cliArgs: NativeParsedArgs, productName: string): string {\n\n\t// 0. Running out of sources has a fixed productName\n\tif (process.env['VSCODE_DEV']) {\n\t\tproductName = 'code-oss-dev';\n\t}\n\n\t// 1. Support portable mode\n\tconst portablePath = process.env['VSCODE_PORTABLE'];\n\tif (portablePath) {\n\t\treturn join(portablePath, 'user-data');\n\t}\n\n\t// 2. Support global VSCODE_APPDATA environment variable\n\tlet appDataPath = process.env['VSCODE_APPDATA'];\n\tif (appDataPath) {\n\t\treturn join(appDataPath, productName);\n\t}\n\n\t// With Electron>=13 --user-data-dir switch will be propagated to\n\t// all processes https://github.com/electron/electron/blob/1897b14af36a02e9aa7e4d814159303441548251/shell/browser/electron_browser_client.cc#L546-L553\n\t// Check VSCODE_PORTABLE and VSCODE_APPDATA before this case to get correct values.\n\t// 3. Support explicit --user-data-dir\n\tconst cliPath = cliArgs['user-data-dir'];\n\tif (cliPath) {\n\t\treturn cliPath;\n\t}\n\n\t// 4. Otherwise check per platform\n\tswitch (process.platform) {\n\t\tcase 'win32':\n\t\t\tappDataPath = process.env['APPDATA'];\n\t\t\tif (!appDataPath) {\n\t\t\t\tconst userProfile = process.env['USERPROFILE'];\n\t\t\t\tif (typeof userProfile !== 'string') {\n\t\t\t\t\tthrow new Error('Windows: Unexpected undefined %USERPROFILE% environment variable');\n\t\t\t\t}\n\n\t\t\t\tappDataPath = join(userProfile, 'AppData', 'Roaming');\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 'darwin':\n\t\t\tappDataPath = join(homedir(), 'Library', 'Application Support');\n\t\t\tbreak;\n\t\tcase 'linux':\n\t\t\tappDataPath = process.env['XDG_CONFIG_HOME'] || join(homedir(), '.config');\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tthrow new Error('Platform not supported');\n\t}\n\n\treturn join(appDataPath, productName);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as arrays from './arrays.js';\nimport * as types from './types.js';\nimport * as nls from '../../nls.js';\nimport { IAction } from './actions.js';\n\nfunction exceptionToErrorMessage(exception: any, verbose: boolean): string {\n\tif (verbose && (exception.stack || exception.stacktrace)) {\n\t\treturn nls.localize('stackTrace.format', \"{0}: {1}\", detectSystemErrorMessage(exception), stackToString(exception.stack) || stackToString(exception.stacktrace));\n\t}\n\n\treturn detectSystemErrorMessage(exception);\n}\n\nfunction stackToString(stack: string[] | string | undefined): string | undefined {\n\tif (Array.isArray(stack)) {\n\t\treturn stack.join('\\n');\n\t}\n\n\treturn stack;\n}\n\nfunction detectSystemErrorMessage(exception: any): string {\n\n\t// Custom node.js error from us\n\tif (exception.code === 'ERR_UNC_HOST_NOT_ALLOWED') {\n\t\treturn `${exception.message}. Please update the 'security.allowedUNCHosts' setting if you want to allow this host.`;\n\t}\n\n\t// See https://nodejs.org/api/errors.html#errors_class_system_error\n\tif (typeof exception.code === 'string' && typeof exception.errno === 'number' && typeof exception.syscall === 'string') {\n\t\treturn nls.localize('nodeExceptionMessage', \"A system error occurred ({0})\", exception.message);\n\t}\n\n\treturn exception.message || nls.localize('error.defaultMessage', \"An unknown error occurred. Please consult the log for more details.\");\n}\n\n/**\n * Tries to generate a human readable error message out of the error. If the verbose parameter\n * is set to true, the error message will include stacktrace details if provided.\n *\n * @returns A string containing the error message.\n */\nexport function toErrorMessage(error: any = null, verbose: boolean = false): string {\n\tif (!error) {\n\t\treturn nls.localize('error.defaultMessage', \"An unknown error occurred. Please consult the log for more details.\");\n\t}\n\n\tif (Array.isArray(error)) {\n\t\tconst errors: any[] = arrays.coalesce(error);\n\t\tconst msg = toErrorMessage(errors[0], verbose);\n\n\t\tif (errors.length > 1) {\n\t\t\treturn nls.localize('error.moreErrors', \"{0} ({1} errors in total)\", msg, errors.length);\n\t\t}\n\n\t\treturn msg;\n\t}\n\n\tif (types.isString(error)) {\n\t\treturn error;\n\t}\n\n\tif (error.detail) {\n\t\tconst detail = error.detail;\n\n\t\tif (detail.error) {\n\t\t\treturn exceptionToErrorMessage(detail.error, verbose);\n\t\t}\n\n\t\tif (detail.exception) {\n\t\t\treturn exceptionToErrorMessage(detail.exception, verbose);\n\t\t}\n\t}\n\n\tif (error.stack) {\n\t\treturn exceptionToErrorMessage(error, verbose);\n\t}\n\n\tif (error.message) {\n\t\treturn error.message;\n\t}\n\n\treturn nls.localize('error.defaultMessage', \"An unknown error occurred. Please consult the log for more details.\");\n}\n\n\nexport interface IErrorWithActions extends Error {\n\tactions: IAction[];\n}\n\nexport function isErrorWithActions(obj: unknown): obj is IErrorWithActions {\n\tconst candidate = obj as IErrorWithActions | undefined;\n\n\treturn candidate instanceof Error && Array.isArray(candidate.actions);\n}\n\nexport function createErrorWithActions(messageOrError: string | Error, actions: IAction[]): IErrorWithActions {\n\tlet error: IErrorWithActions;\n\tif (typeof messageOrError === 'string') {\n\t\terror = new Error(messageOrError) as IErrorWithActions;\n\t} else {\n\t\terror = messageOrError as IErrorWithActions;\n\t}\n\n\terror.actions = actions;\n\n\treturn error;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { encodeHex, VSBuffer } from './buffer.js';\nimport * as strings from './strings.js';\n\ntype NotSyncHashable = ArrayBufferLike | ArrayBufferView;\n\n/**\n * Return a hash value for an object.\n *\n * Note that this should not be used for binary data types. Instead,\n * prefer {@link hashAsync}.\n */\nexport function hash<T>(obj: T extends NotSyncHashable ? never : T): number {\n\treturn doHash(obj, 0);\n}\n\nexport function doHash(obj: unknown, hashVal: number): number {\n\tswitch (typeof obj) {\n\t\tcase 'object':\n\t\t\tif (obj === null) {\n\t\t\t\treturn numberHash(349, hashVal);\n\t\t\t} else if (Array.isArray(obj)) {\n\t\t\t\treturn arrayHash(obj, hashVal);\n\t\t\t}\n\t\t\treturn objectHash(obj, hashVal);\n\t\tcase 'string':\n\t\t\treturn stringHash(obj, hashVal);\n\t\tcase 'boolean':\n\t\t\treturn booleanHash(obj, hashVal);\n\t\tcase 'number':\n\t\t\treturn numberHash(obj, hashVal);\n\t\tcase 'undefined':\n\t\t\treturn numberHash(937, hashVal);\n\t\tdefault:\n\t\t\treturn numberHash(617, hashVal);\n\t}\n}\n\nexport function numberHash(val: number, initialHashVal: number): number {\n\treturn (((initialHashVal << 5) - initialHashVal) + val) | 0;  // hashVal * 31 + ch, keep as int32\n}\n\nfunction booleanHash(b: boolean, initialHashVal: number): number {\n\treturn numberHash(b ? 433 : 863, initialHashVal);\n}\n\nexport function stringHash(s: string, hashVal: number) {\n\thashVal = numberHash(149417, hashVal);\n\tfor (let i = 0, length = s.length; i < length; i++) {\n\t\thashVal = numberHash(s.charCodeAt(i), hashVal);\n\t}\n\treturn hashVal;\n}\n\nfunction arrayHash(arr: unknown[], initialHashVal: number): number {\n\tinitialHashVal = numberHash(104579, initialHashVal);\n\treturn arr.reduce<number>((hashVal, item) => doHash(item, hashVal), initialHashVal);\n}\n\nfunction objectHash(obj: object, initialHashVal: number): number {\n\tinitialHashVal = numberHash(181387, initialHashVal);\n\treturn Object.keys(obj).sort().reduce((hashVal, key) => {\n\t\thashVal = stringHash(key, hashVal);\n\t\treturn doHash((obj as Record<string, unknown>)[key], hashVal);\n\t}, initialHashVal);\n}\n\n\n\n/** Hashes the input as SHA-1, returning a hex-encoded string. */\nexport const hashAsync = (input: string | ArrayBufferView | VSBuffer) => {\n\t// Note: I would very much like to expose a streaming interface for hashing\n\t// generally, but this is not available in web crypto yet, see\n\t// https://github.com/w3c/webcrypto/issues/73\n\n\t// StringSHA1 is faster for small string input, use it since we have it:\n\tif (typeof input === 'string' && input.length < 250) {\n\t\tconst sha = new StringSHA1();\n\t\tsha.update(input);\n\t\treturn Promise.resolve(sha.digest());\n\t}\n\n\tlet buff: ArrayBufferView;\n\tif (typeof input === 'string') {\n\t\tbuff = new TextEncoder().encode(input);\n\t} else if (input instanceof VSBuffer) {\n\t\tbuff = input.buffer;\n\t} else {\n\t\tbuff = input;\n\t}\n\n\treturn crypto.subtle.digest('sha-1', buff as ArrayBufferView<ArrayBuffer>).then(toHexString); // CodeQL [SM04514] we use sha1 here for validating old stored client state, not for security\n};\n\nconst enum SHA1Constant {\n\tBLOCK_SIZE = 64, // 512 / 8\n\tUNICODE_REPLACEMENT = 0xFFFD,\n}\n\nfunction leftRotate(value: number, bits: number, totalBits: number = 32): number {\n\t// delta + bits = totalBits\n\tconst delta = totalBits - bits;\n\n\t// All ones, expect `delta` zeros aligned to the right\n\tconst mask = ~((1 << delta) - 1);\n\n\t// Join (value left-shifted `bits` bits) with (masked value right-shifted `delta` bits)\n\treturn ((value << bits) | ((mask & value) >>> delta)) >>> 0;\n}\n\nfunction toHexString(buffer: ArrayBuffer): string;\nfunction toHexString(value: number, bitsize?: number): string;\nfunction toHexString(bufferOrValue: ArrayBuffer | number, bitsize: number = 32): string {\n\tif (bufferOrValue instanceof ArrayBuffer) {\n\t\treturn encodeHex(VSBuffer.wrap(new Uint8Array(bufferOrValue)));\n\t}\n\n\treturn (bufferOrValue >>> 0).toString(16).padStart(bitsize / 4, '0');\n}\n\n/**\n * A SHA1 implementation that works with strings and does not allocate.\n *\n * Prefer to use {@link hashAsync} in async contexts\n */\nexport class StringSHA1 {\n\tprivate static _bigBlock32 = new DataView(new ArrayBuffer(320)); // 80 * 4 = 320\n\n\tprivate _h0 = 0x67452301;\n\tprivate _h1 = 0xEFCDAB89;\n\tprivate _h2 = 0x98BADCFE;\n\tprivate _h3 = 0x10325476;\n\tprivate _h4 = 0xC3D2E1F0;\n\n\tprivate readonly _buff: Uint8Array;\n\tprivate readonly _buffDV: DataView;\n\tprivate _buffLen: number;\n\tprivate _totalLen: number;\n\tprivate _leftoverHighSurrogate: number;\n\tprivate _finished: boolean;\n\n\tconstructor() {\n\t\tthis._buff = new Uint8Array(SHA1Constant.BLOCK_SIZE + 3 /* to fit any utf-8 */);\n\t\tthis._buffDV = new DataView(this._buff.buffer);\n\t\tthis._buffLen = 0;\n\t\tthis._totalLen = 0;\n\t\tthis._leftoverHighSurrogate = 0;\n\t\tthis._finished = false;\n\t}\n\n\tpublic update(str: string): void {\n\t\tconst strLen = str.length;\n\t\tif (strLen === 0) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst buff = this._buff;\n\t\tlet buffLen = this._buffLen;\n\t\tlet leftoverHighSurrogate = this._leftoverHighSurrogate;\n\t\tlet charCode: number;\n\t\tlet offset: number;\n\n\t\tif (leftoverHighSurrogate !== 0) {\n\t\t\tcharCode = leftoverHighSurrogate;\n\t\t\toffset = -1;\n\t\t\tleftoverHighSurrogate = 0;\n\t\t} else {\n\t\t\tcharCode = str.charCodeAt(0);\n\t\t\toffset = 0;\n\t\t}\n\n\t\twhile (true) {\n\t\t\tlet codePoint = charCode;\n\t\t\tif (strings.isHighSurrogate(charCode)) {\n\t\t\t\tif (offset + 1 < strLen) {\n\t\t\t\t\tconst nextCharCode = str.charCodeAt(offset + 1);\n\t\t\t\t\tif (strings.isLowSurrogate(nextCharCode)) {\n\t\t\t\t\t\toffset++;\n\t\t\t\t\t\tcodePoint = strings.computeCodePoint(charCode, nextCharCode);\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// illegal => unicode replacement character\n\t\t\t\t\t\tcodePoint = SHA1Constant.UNICODE_REPLACEMENT;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\t// last character is a surrogate pair\n\t\t\t\t\tleftoverHighSurrogate = charCode;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else if (strings.isLowSurrogate(charCode)) {\n\t\t\t\t// illegal => unicode replacement character\n\t\t\t\tcodePoint = SHA1Constant.UNICODE_REPLACEMENT;\n\t\t\t}\n\n\t\t\tbuffLen = this._push(buff, buffLen, codePoint);\n\t\t\toffset++;\n\t\t\tif (offset < strLen) {\n\t\t\t\tcharCode = str.charCodeAt(offset);\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tthis._buffLen = buffLen;\n\t\tthis._leftoverHighSurrogate = leftoverHighSurrogate;\n\t}\n\n\tprivate _push(buff: Uint8Array, buffLen: number, codePoint: number): number {\n\t\tif (codePoint < 0x0080) {\n\t\t\tbuff[buffLen++] = codePoint;\n\t\t} else if (codePoint < 0x0800) {\n\t\t\tbuff[buffLen++] = 0b11000000 | ((codePoint & 0b00000000000000000000011111000000) >>> 6);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000000000000000111111) >>> 0);\n\t\t} else if (codePoint < 0x10000) {\n\t\t\tbuff[buffLen++] = 0b11100000 | ((codePoint & 0b00000000000000001111000000000000) >>> 12);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000000000111111000000) >>> 6);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000000000000000111111) >>> 0);\n\t\t} else {\n\t\t\tbuff[buffLen++] = 0b11110000 | ((codePoint & 0b00000000000111000000000000000000) >>> 18);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000111111000000000000) >>> 12);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000000000111111000000) >>> 6);\n\t\t\tbuff[buffLen++] = 0b10000000 | ((codePoint & 0b00000000000000000000000000111111) >>> 0);\n\t\t}\n\n\t\tif (buffLen >= SHA1Constant.BLOCK_SIZE) {\n\t\t\tthis._step();\n\t\t\tbuffLen -= SHA1Constant.BLOCK_SIZE;\n\t\t\tthis._totalLen += SHA1Constant.BLOCK_SIZE;\n\t\t\t// take last 3 in case of UTF8 overflow\n\t\t\tbuff[0] = buff[SHA1Constant.BLOCK_SIZE + 0];\n\t\t\tbuff[1] = buff[SHA1Constant.BLOCK_SIZE + 1];\n\t\t\tbuff[2] = buff[SHA1Constant.BLOCK_SIZE + 2];\n\t\t}\n\n\t\treturn buffLen;\n\t}\n\n\tpublic digest(): string {\n\t\tif (!this._finished) {\n\t\t\tthis._finished = true;\n\t\t\tif (this._leftoverHighSurrogate) {\n\t\t\t\t// illegal => unicode replacement character\n\t\t\t\tthis._leftoverHighSurrogate = 0;\n\t\t\t\tthis._buffLen = this._push(this._buff, this._buffLen, SHA1Constant.UNICODE_REPLACEMENT);\n\t\t\t}\n\t\t\tthis._totalLen += this._buffLen;\n\t\t\tthis._wrapUp();\n\t\t}\n\n\t\treturn toHexString(this._h0) + toHexString(this._h1) + toHexString(this._h2) + toHexString(this._h3) + toHexString(this._h4);\n\t}\n\n\tprivate _wrapUp(): void {\n\t\tthis._buff[this._buffLen++] = 0x80;\n\t\tthis._buff.subarray(this._buffLen).fill(0);\n\n\t\tif (this._buffLen > 56) {\n\t\t\tthis._step();\n\t\t\tthis._buff.fill(0);\n\t\t}\n\n\t\t// this will fit because the mantissa can cover up to 52 bits\n\t\tconst ml = 8 * this._totalLen;\n\n\t\tthis._buffDV.setUint32(56, Math.floor(ml / 4294967296), false);\n\t\tthis._buffDV.setUint32(60, ml % 4294967296, false);\n\n\t\tthis._step();\n\t}\n\n\tprivate _step(): void {\n\t\tconst bigBlock32 = StringSHA1._bigBlock32;\n\t\tconst data = this._buffDV;\n\n\t\tfor (let j = 0; j < 64 /* 16*4 */; j += 4) {\n\t\t\tbigBlock32.setUint32(j, data.getUint32(j, false), false);\n\t\t}\n\n\t\tfor (let j = 64; j < 320 /* 80*4 */; j += 4) {\n\t\t\tbigBlock32.setUint32(j, leftRotate((bigBlock32.getUint32(j - 12, false) ^ bigBlock32.getUint32(j - 32, false) ^ bigBlock32.getUint32(j - 56, false) ^ bigBlock32.getUint32(j - 64, false)), 1), false);\n\t\t}\n\n\t\tlet a = this._h0;\n\t\tlet b = this._h1;\n\t\tlet c = this._h2;\n\t\tlet d = this._h3;\n\t\tlet e = this._h4;\n\n\t\tlet f: number, k: number;\n\t\tlet temp: number;\n\n\t\tfor (let j = 0; j < 80; j++) {\n\t\t\tif (j < 20) {\n\t\t\t\tf = (b & c) | ((~b) & d);\n\t\t\t\tk = 0x5A827999;\n\t\t\t} else if (j < 40) {\n\t\t\t\tf = b ^ c ^ d;\n\t\t\t\tk = 0x6ED9EBA1;\n\t\t\t} else if (j < 60) {\n\t\t\t\tf = (b & c) | (b & d) | (c & d);\n\t\t\t\tk = 0x8F1BBCDC;\n\t\t\t} else {\n\t\t\t\tf = b ^ c ^ d;\n\t\t\t\tk = 0xCA62C1D6;\n\t\t\t}\n\n\t\t\ttemp = (leftRotate(a, 5) + f + e + k + bigBlock32.getUint32(j * 4, false)) & 0xffffffff;\n\t\t\te = d;\n\t\t\td = c;\n\t\t\tc = leftRotate(b, 30);\n\t\t\tb = a;\n\t\t\ta = temp;\n\t\t}\n\n\t\tthis._h0 = (this._h0 + a) & 0xffffffff;\n\t\tthis._h1 = (this._h1 + b) & 0xffffffff;\n\t\tthis._h2 = (this._h2 + c) & 0xffffffff;\n\t\tthis._h3 = (this._h3 + d) & 0xffffffff;\n\t\tthis._h4 = (this._h4 + e) & 0xffffffff;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CharCode } from '../../../base/common/charCode.js';\nimport { illegalState } from '../../../base/common/errors.js';\nimport { localize } from '../../../nls.js';\n\nexport const enum TokenType {\n\tLParen,\n\tRParen,\n\tNeg,\n\tEq,\n\tNotEq,\n\tLt,\n\tLtEq,\n\tGt,\n\tGtEq,\n\tRegexOp,\n\tRegexStr,\n\tTrue,\n\tFalse,\n\tIn,\n\tNot,\n\tAnd,\n\tOr,\n\tStr,\n\tQuotedStr,\n\tError,\n\tEOF,\n}\n\nexport type Token =\n\t| { type: TokenType.LParen; offset: number }\n\t| { type: TokenType.RParen; offset: number }\n\t| { type: TokenType.Neg; offset: number }\n\t| { type: TokenType.Eq; offset: number; isTripleEq: boolean }\n\t| { type: TokenType.NotEq; offset: number; isTripleEq: boolean }\n\t| { type: TokenType.Lt; offset: number }\n\t| { type: TokenType.LtEq; offset: number }\n\t| { type: TokenType.Gt; offset: number }\n\t| { type: TokenType.GtEq; offset: number }\n\t| { type: TokenType.RegexOp; offset: number }\n\t| { type: TokenType.RegexStr; offset: number; lexeme: string }\n\t| { type: TokenType.True; offset: number }\n\t| { type: TokenType.False; offset: number }\n\t| { type: TokenType.In; offset: number }\n\t| { type: TokenType.Not; offset: number }\n\t| { type: TokenType.And; offset: number }\n\t| { type: TokenType.Or; offset: number }\n\t| { type: TokenType.Str; offset: number; lexeme: string }\n\t| { type: TokenType.QuotedStr; offset: number; lexeme: string }\n\t| { type: TokenType.Error; offset: number; lexeme: string }\n\t| { type: TokenType.EOF; offset: number };\n\ntype KeywordTokenType = TokenType.Not | TokenType.In | TokenType.False | TokenType.True;\ntype TokenTypeWithoutLexeme =\n\tTokenType.LParen |\n\tTokenType.RParen |\n\tTokenType.Neg |\n\tTokenType.Lt |\n\tTokenType.LtEq |\n\tTokenType.Gt |\n\tTokenType.GtEq |\n\tTokenType.RegexOp |\n\tTokenType.True |\n\tTokenType.False |\n\tTokenType.In |\n\tTokenType.Not |\n\tTokenType.And |\n\tTokenType.Or |\n\tTokenType.EOF;\n\n/**\n * Example:\n * `foo == bar'` - note how single quote doesn't have a corresponding closing quote,\n * so it's reported as unexpected\n */\nexport type LexingError = {\n\toffset: number; /** note that this doesn't take into account escape characters from the original encoding of the string, e.g., within an extension manifest file's JSON encoding  */\n\tlexeme: string;\n\tadditionalInfo?: string;\n};\n\nfunction hintDidYouMean(...meant: string[]) {\n\tswitch (meant.length) {\n\t\tcase 1:\n\t\t\treturn localize('contextkey.scanner.hint.didYouMean1', \"Did you mean {0}?\", meant[0]);\n\t\tcase 2:\n\t\t\treturn localize('contextkey.scanner.hint.didYouMean2', \"Did you mean {0} or {1}?\", meant[0], meant[1]);\n\t\tcase 3:\n\t\t\treturn localize('contextkey.scanner.hint.didYouMean3', \"Did you mean {0}, {1} or {2}?\", meant[0], meant[1], meant[2]);\n\t\tdefault: // we just don't expect that many\n\t\t\treturn undefined;\n\t}\n}\n\nconst hintDidYouForgetToOpenOrCloseQuote = localize('contextkey.scanner.hint.didYouForgetToOpenOrCloseQuote', \"Did you forget to open or close the quote?\");\nconst hintDidYouForgetToEscapeSlash = localize('contextkey.scanner.hint.didYouForgetToEscapeSlash', \"Did you forget to escape the '/' (slash) character? Put two backslashes before it to escape, e.g., '\\\\\\\\/\\'.\");\n\n/**\n * A simple scanner for context keys.\n *\n * Example:\n *\n * ```ts\n * const scanner = new Scanner().reset('resourceFileName =~ /docker/ && !config.docker.enabled');\n * const tokens = [...scanner];\n * if (scanner.errorTokens.length > 0) {\n *     scanner.errorTokens.forEach(err => console.error(`Unexpected token at ${err.offset}: ${err.lexeme}\\nHint: ${err.additional}`));\n * } else {\n *     // process tokens\n * }\n * ```\n */\nexport class Scanner {\n\n\tstatic getLexeme(token: Token): string {\n\t\tswitch (token.type) {\n\t\t\tcase TokenType.LParen:\n\t\t\t\treturn '(';\n\t\t\tcase TokenType.RParen:\n\t\t\t\treturn ')';\n\t\t\tcase TokenType.Neg:\n\t\t\t\treturn '!';\n\t\t\tcase TokenType.Eq:\n\t\t\t\treturn token.isTripleEq ? '===' : '==';\n\t\t\tcase TokenType.NotEq:\n\t\t\t\treturn token.isTripleEq ? '!==' : '!=';\n\t\t\tcase TokenType.Lt:\n\t\t\t\treturn '<';\n\t\t\tcase TokenType.LtEq:\n\t\t\t\treturn '<=';\n\t\t\tcase TokenType.Gt:\n\t\t\t\treturn '>=';\n\t\t\tcase TokenType.GtEq:\n\t\t\t\treturn '>=';\n\t\t\tcase TokenType.RegexOp:\n\t\t\t\treturn '=~';\n\t\t\tcase TokenType.RegexStr:\n\t\t\t\treturn token.lexeme;\n\t\t\tcase TokenType.True:\n\t\t\t\treturn 'true';\n\t\t\tcase TokenType.False:\n\t\t\t\treturn 'false';\n\t\t\tcase TokenType.In:\n\t\t\t\treturn 'in';\n\t\t\tcase TokenType.Not:\n\t\t\t\treturn 'not';\n\t\t\tcase TokenType.And:\n\t\t\t\treturn '&&';\n\t\t\tcase TokenType.Or:\n\t\t\t\treturn '||';\n\t\t\tcase TokenType.Str:\n\t\t\t\treturn token.lexeme;\n\t\t\tcase TokenType.QuotedStr:\n\t\t\t\treturn token.lexeme;\n\t\t\tcase TokenType.Error:\n\t\t\t\treturn token.lexeme;\n\t\t\tcase TokenType.EOF:\n\t\t\t\treturn 'EOF';\n\t\t\tdefault:\n\t\t\t\tthrow illegalState(`unhandled token type: ${JSON.stringify(token)}; have you forgotten to add a case?`);\n\t\t}\n\t}\n\n\tprivate static _regexFlags = new Set(['i', 'g', 's', 'm', 'y', 'u'].map(ch => ch.charCodeAt(0)));\n\n\tprivate static _keywords = new Map<string, KeywordTokenType>([\n\t\t['not', TokenType.Not],\n\t\t['in', TokenType.In],\n\t\t['false', TokenType.False],\n\t\t['true', TokenType.True],\n\t]);\n\n\tprivate _input: string = '';\n\tprivate _start: number = 0;\n\tprivate _current: number = 0;\n\tprivate _tokens: Token[] = [];\n\tprivate _errors: LexingError[] = [];\n\n\tget errors(): Readonly<LexingError[]> {\n\t\treturn this._errors;\n\t}\n\n\treset(value: string) {\n\t\tthis._input = value;\n\n\t\tthis._start = 0;\n\t\tthis._current = 0;\n\t\tthis._tokens = [];\n\t\tthis._errors = [];\n\n\t\treturn this;\n\t}\n\n\tscan() {\n\t\twhile (!this._isAtEnd()) {\n\n\t\t\tthis._start = this._current;\n\n\t\t\tconst ch = this._advance();\n\t\t\tswitch (ch) {\n\t\t\t\tcase CharCode.OpenParen: this._addToken(TokenType.LParen); break;\n\t\t\t\tcase CharCode.CloseParen: this._addToken(TokenType.RParen); break;\n\n\t\t\t\tcase CharCode.ExclamationMark:\n\t\t\t\t\tif (this._match(CharCode.Equals)) {\n\t\t\t\t\t\tconst isTripleEq = this._match(CharCode.Equals); // eat last `=` if `!==`\n\t\t\t\t\t\tthis._tokens.push({ type: TokenType.NotEq, offset: this._start, isTripleEq });\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._addToken(TokenType.Neg);\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CharCode.SingleQuote: this._quotedString(); break;\n\t\t\t\tcase CharCode.Slash: this._regex(); break;\n\n\t\t\t\tcase CharCode.Equals:\n\t\t\t\t\tif (this._match(CharCode.Equals)) { // support `==`\n\t\t\t\t\t\tconst isTripleEq = this._match(CharCode.Equals); // eat last `=` if `===`\n\t\t\t\t\t\tthis._tokens.push({ type: TokenType.Eq, offset: this._start, isTripleEq });\n\t\t\t\t\t} else if (this._match(CharCode.Tilde)) {\n\t\t\t\t\t\tthis._addToken(TokenType.RegexOp);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._error(hintDidYouMean('==', '=~'));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CharCode.LessThan: this._addToken(this._match(CharCode.Equals) ? TokenType.LtEq : TokenType.Lt); break;\n\n\t\t\t\tcase CharCode.GreaterThan: this._addToken(this._match(CharCode.Equals) ? TokenType.GtEq : TokenType.Gt); break;\n\n\t\t\t\tcase CharCode.Ampersand:\n\t\t\t\t\tif (this._match(CharCode.Ampersand)) {\n\t\t\t\t\t\tthis._addToken(TokenType.And);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._error(hintDidYouMean('&&'));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\tcase CharCode.Pipe:\n\t\t\t\t\tif (this._match(CharCode.Pipe)) {\n\t\t\t\t\t\tthis._addToken(TokenType.Or);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._error(hintDidYouMean('||'));\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\n\t\t\t\t// TODO@ulugbekna: 1) rewrite using a regex 2) reconsider what characters are considered whitespace, including unicode, nbsp, etc.\n\t\t\t\tcase CharCode.Space:\n\t\t\t\tcase CharCode.CarriageReturn:\n\t\t\t\tcase CharCode.Tab:\n\t\t\t\tcase CharCode.LineFeed:\n\t\t\t\tcase CharCode.NoBreakSpace: // &nbsp\n\t\t\t\t\tbreak;\n\n\t\t\t\tdefault:\n\t\t\t\t\tthis._string();\n\t\t\t}\n\t\t}\n\n\t\tthis._start = this._current;\n\t\tthis._addToken(TokenType.EOF);\n\n\t\treturn Array.from(this._tokens);\n\t}\n\n\tprivate _match(expected: number): boolean {\n\t\tif (this._isAtEnd()) {\n\t\t\treturn false;\n\t\t}\n\t\tif (this._input.charCodeAt(this._current) !== expected) {\n\t\t\treturn false;\n\t\t}\n\t\tthis._current++;\n\t\treturn true;\n\t}\n\n\tprivate _advance(): number {\n\t\treturn this._input.charCodeAt(this._current++);\n\t}\n\n\tprivate _peek(): number {\n\t\treturn this._isAtEnd() ? CharCode.Null : this._input.charCodeAt(this._current);\n\t}\n\n\tprivate _addToken(type: TokenTypeWithoutLexeme) {\n\t\tthis._tokens.push({ type, offset: this._start });\n\t}\n\n\tprivate _error(additional?: string) {\n\t\tconst offset = this._start;\n\t\tconst lexeme = this._input.substring(this._start, this._current);\n\t\tconst errToken: Token = { type: TokenType.Error, offset: this._start, lexeme };\n\t\tthis._errors.push({ offset, lexeme, additionalInfo: additional });\n\t\tthis._tokens.push(errToken);\n\t}\n\n\t// u - unicode, y - sticky // TODO@ulugbekna: we accept double quotes as part of the string rather than as a delimiter (to preserve old parser's behavior)\n\tprivate stringRe = /[a-zA-Z0-9_<>\\-\\./\\\\:\\*\\?\\+\\[\\]\\^,#@;\"%\\$\\p{L}-]+/uy;\n\tprivate _string() {\n\t\tthis.stringRe.lastIndex = this._start;\n\t\tconst match = this.stringRe.exec(this._input);\n\t\tif (match) {\n\t\t\tthis._current = this._start + match[0].length;\n\t\t\tconst lexeme = this._input.substring(this._start, this._current);\n\t\t\tconst keyword = Scanner._keywords.get(lexeme);\n\t\t\tif (keyword) {\n\t\t\t\tthis._addToken(keyword);\n\t\t\t} else {\n\t\t\t\tthis._tokens.push({ type: TokenType.Str, lexeme, offset: this._start });\n\t\t\t}\n\t\t}\n\t}\n\n\t// captures the lexeme without the leading and trailing '\n\tprivate _quotedString() {\n\t\twhile (this._peek() !== CharCode.SingleQuote && !this._isAtEnd()) { // TODO@ulugbekna: add support for escaping ' ?\n\t\t\tthis._advance();\n\t\t}\n\n\t\tif (this._isAtEnd()) {\n\t\t\tthis._error(hintDidYouForgetToOpenOrCloseQuote);\n\t\t\treturn;\n\t\t}\n\n\t\t// consume the closing '\n\t\tthis._advance();\n\n\t\tthis._tokens.push({ type: TokenType.QuotedStr, lexeme: this._input.substring(this._start + 1, this._current - 1), offset: this._start + 1 });\n\t}\n\n\t/*\n\t * Lexing a regex expression: /.../[igsmyu]*\n\t * Based on https://github.com/microsoft/TypeScript/blob/9247ef115e617805983740ba795d7a8164babf89/src/compiler/scanner.ts#L2129-L2181\n\t *\n\t * Note that we want slashes within a regex to be escaped, e.g., /file:\\\\/\\\\/\\\\// should match `file:///`\n\t */\n\tprivate _regex() {\n\t\tlet p = this._current;\n\n\t\tlet inEscape = false;\n\t\tlet inCharacterClass = false;\n\t\twhile (true) {\n\t\t\tif (p >= this._input.length) {\n\t\t\t\tthis._current = p;\n\t\t\t\tthis._error(hintDidYouForgetToEscapeSlash);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst ch = this._input.charCodeAt(p);\n\n\t\t\tif (inEscape) { // parsing an escape character\n\t\t\t\tinEscape = false;\n\t\t\t} else if (ch === CharCode.Slash && !inCharacterClass) { // end of regex\n\t\t\t\tp++;\n\t\t\t\tbreak;\n\t\t\t} else if (ch === CharCode.OpenSquareBracket) {\n\t\t\t\tinCharacterClass = true;\n\t\t\t} else if (ch === CharCode.Backslash) {\n\t\t\t\tinEscape = true;\n\t\t\t} else if (ch === CharCode.CloseSquareBracket) {\n\t\t\t\tinCharacterClass = false;\n\t\t\t}\n\t\t\tp++;\n\t\t}\n\n\t\t// Consume flags // TODO@ulugbekna: use regex instead\n\t\twhile (p < this._input.length && Scanner._regexFlags.has(this._input.charCodeAt(p))) {\n\t\t\tp++;\n\t\t}\n\n\t\tthis._current = p;\n\n\t\tconst lexeme = this._input.substring(this._start, this._current);\n\t\tthis._tokens.push({ type: TokenType.RegexStr, lexeme, offset: this._start });\n\t}\n\n\tprivate _isAtEnd() {\n\t\treturn this._current >= this._input.length;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\nimport * as descriptors from './descriptors.js';\nimport { ServiceCollection } from './serviceCollection.js';\n\n// ------ internal util\n\nexport namespace _util {\n\n\texport const serviceIds = new Map<string, ServiceIdentifier<any>>();\n\n\texport const DI_TARGET = '$di$target';\n\texport const DI_DEPENDENCIES = '$di$dependencies';\n\n\texport function getServiceDependencies(ctor: DI_TARGET_OBJ): { id: ServiceIdentifier<any>; index: number }[] {\n\t\treturn ctor[DI_DEPENDENCIES] || [];\n\t}\n\n\texport interface DI_TARGET_OBJ extends Function {\n\t\t[DI_TARGET]: Function;\n\t\t[DI_DEPENDENCIES]: { id: ServiceIdentifier<any>; index: number }[];\n\t}\n}\n\n// --- interfaces ------\n\nexport type BrandedService = { _serviceBrand: undefined };\n\nexport interface IConstructorSignature<T, Args extends any[] = []> {\n\tnew <Services extends BrandedService[]>(...args: [...Args, ...Services]): T;\n}\n\nexport interface ServicesAccessor {\n\tget<T>(id: ServiceIdentifier<T>): T;\n}\n\nexport const IInstantiationService = createDecorator<IInstantiationService>('instantiationService');\n\n/**\n * Given a list of arguments as a tuple, attempt to extract the leading, non-service arguments\n * to their own tuple.\n */\nexport type GetLeadingNonServiceArgs<TArgs extends any[]> =\n\tTArgs extends [] ? []\n\t: TArgs extends [...infer TFirst, BrandedService] ? GetLeadingNonServiceArgs<TFirst>\n\t: TArgs;\n\nexport interface IInstantiationService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Synchronously creates an instance that is denoted by the descriptor\n\t */\n\tcreateInstance<T>(descriptor: descriptors.SyncDescriptor0<T>): T;\n\tcreateInstance<Ctor extends new (...args: any[]) => unknown, R extends InstanceType<Ctor>>(ctor: Ctor, ...args: GetLeadingNonServiceArgs<ConstructorParameters<Ctor>>): R;\n\n\t/**\n\t * Calls a function with a service accessor.\n\t */\n\tinvokeFunction<R, TS extends any[] = []>(fn: (accessor: ServicesAccessor, ...args: TS) => R, ...args: TS): R;\n\n\t/**\n\t * Creates a child of this service which inherits all current services\n\t * and adds/overwrites the given services.\n\t *\n\t * NOTE that the returned child is `disposable` and should be disposed when not used\n\t * anymore. This will also dispose all the services that this service has created.\n\t */\n\tcreateChild(services: ServiceCollection, store?: DisposableStore): IInstantiationService;\n\n\t/**\n\t * Disposes this instantiation service.\n\t *\n\t * - Will dispose all services that this instantiation service has created.\n\t * - Will dispose all its children but not its parent.\n\t * - Will NOT dispose services-instances that this service has been created with\n\t * - Will NOT dispose consumer-instances this service has created\n\t */\n\tdispose(): void;\n}\n\n\n/**\n * Identifies a service of type `T`.\n */\nexport interface ServiceIdentifier<T> {\n\t(...args: any[]): void;\n\ttype: T;\n}\n\n\nfunction storeServiceDependency(id: ServiceIdentifier<unknown>, target: Function, index: number): void {\n\tif ((target as _util.DI_TARGET_OBJ)[_util.DI_TARGET] === target) {\n\t\t(target as _util.DI_TARGET_OBJ)[_util.DI_DEPENDENCIES].push({ id, index });\n\t} else {\n\t\t(target as _util.DI_TARGET_OBJ)[_util.DI_DEPENDENCIES] = [{ id, index }];\n\t\t(target as _util.DI_TARGET_OBJ)[_util.DI_TARGET] = target;\n\t}\n}\n\n/**\n * The *only* valid way to create a {{ServiceIdentifier}}.\n */\nexport function createDecorator<T>(serviceId: string): ServiceIdentifier<T> {\n\n\tif (_util.serviceIds.has(serviceId)) {\n\t\treturn _util.serviceIds.get(serviceId)!;\n\t}\n\n\tconst id = function (target: Function, key: string, index: number) {\n\t\tif (arguments.length !== 3) {\n\t\t\tthrow new Error('@IServiceName-decorator can only be used to decorate a parameter');\n\t\t}\n\t\tstoreServiceDependency(id, target, index);\n\t} as ServiceIdentifier<T>;\n\n\tid.toString = () => serviceId;\n\n\t_util.serviceIds.set(serviceId, id);\n\treturn id;\n}\n\nexport function refineServiceDecorator<T1, T extends T1>(serviceIdentifier: ServiceIdentifier<T1>): ServiceIdentifier<T> {\n\treturn <ServiceIdentifier<T>>serviceIdentifier;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { CharCode } from '../../../base/common/charCode.js';\nimport { Event } from '../../../base/common/event.js';\nimport { isChrome, isEdge, isFirefox, isLinux, isMacintosh, isSafari, isWeb, isWindows } from '../../../base/common/platform.js';\nimport { isFalsyOrWhitespace } from '../../../base/common/strings.js';\nimport { Scanner, LexingError, Token, TokenType } from './scanner.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\nimport { localize } from '../../../nls.js';\nimport { IDisposable } from '../../../base/common/lifecycle.js';\nimport { illegalArgument } from '../../../base/common/errors.js';\n\nconst CONSTANT_VALUES = new Map<string, boolean>();\nCONSTANT_VALUES.set('false', false);\nCONSTANT_VALUES.set('true', true);\nCONSTANT_VALUES.set('isMac', isMacintosh);\nCONSTANT_VALUES.set('isLinux', isLinux);\nCONSTANT_VALUES.set('isWindows', isWindows);\nCONSTANT_VALUES.set('isWeb', isWeb);\nCONSTANT_VALUES.set('isMacNative', isMacintosh && !isWeb);\nCONSTANT_VALUES.set('isEdge', isEdge);\nCONSTANT_VALUES.set('isFirefox', isFirefox);\nCONSTANT_VALUES.set('isChrome', isChrome);\nCONSTANT_VALUES.set('isSafari', isSafari);\n\n/** allow register constant context keys that are known only after startup; requires running `substituteConstants` on the context key - https://github.com/microsoft/vscode/issues/174218#issuecomment-1437972127 */\nexport function setConstant(key: string, value: boolean) {\n\tif (CONSTANT_VALUES.get(key) !== undefined) { throw illegalArgument('contextkey.setConstant(k, v) invoked with already set constant `k`'); }\n\n\tCONSTANT_VALUES.set(key, value);\n}\n\nconst hasOwnProperty = Object.prototype.hasOwnProperty;\n\nexport const enum ContextKeyExprType {\n\tFalse = 0,\n\tTrue = 1,\n\tDefined = 2,\n\tNot = 3,\n\tEquals = 4,\n\tNotEquals = 5,\n\tAnd = 6,\n\tRegex = 7,\n\tNotRegex = 8,\n\tOr = 9,\n\tIn = 10,\n\tNotIn = 11,\n\tGreater = 12,\n\tGreaterEquals = 13,\n\tSmaller = 14,\n\tSmallerEquals = 15,\n}\n\nexport interface IContextKeyExprMapper {\n\tmapDefined(key: string): ContextKeyExpression;\n\tmapNot(key: string): ContextKeyExpression;\n\tmapEquals(key: string, value: any): ContextKeyExpression;\n\tmapNotEquals(key: string, value: any): ContextKeyExpression;\n\tmapGreater(key: string, value: any): ContextKeyExpression;\n\tmapGreaterEquals(key: string, value: any): ContextKeyExpression;\n\tmapSmaller(key: string, value: any): ContextKeyExpression;\n\tmapSmallerEquals(key: string, value: any): ContextKeyExpression;\n\tmapRegex(key: string, regexp: RegExp | null): ContextKeyRegexExpr;\n\tmapIn(key: string, valueKey: string): ContextKeyInExpr;\n\tmapNotIn(key: string, valueKey: string): ContextKeyNotInExpr;\n}\n\nexport interface IContextKeyExpression {\n\tcmp(other: ContextKeyExpression): number;\n\tequals(other: ContextKeyExpression): boolean;\n\tsubstituteConstants(): ContextKeyExpression | undefined;\n\tevaluate(context: IContext): boolean;\n\tserialize(): string;\n\tkeys(): string[];\n\tmap(mapFnc: IContextKeyExprMapper): ContextKeyExpression;\n\tnegate(): ContextKeyExpression;\n\n}\n\nexport type ContextKeyExpression = (\n\tContextKeyFalseExpr | ContextKeyTrueExpr | ContextKeyDefinedExpr | ContextKeyNotExpr\n\t| ContextKeyEqualsExpr | ContextKeyNotEqualsExpr | ContextKeyRegexExpr\n\t| ContextKeyNotRegexExpr | ContextKeyAndExpr | ContextKeyOrExpr | ContextKeyInExpr\n\t| ContextKeyNotInExpr | ContextKeyGreaterExpr | ContextKeyGreaterEqualsExpr\n\t| ContextKeySmallerExpr | ContextKeySmallerEqualsExpr\n);\n\n\n/*\n\nSyntax grammar:\n\n```ebnf\n\nexpression ::= or\n\nor ::= and { '||' and }*\n\nand ::= term { '&&' term }*\n\nterm ::=\n\t| '!' (KEY | true | false | parenthesized)\n\t| primary\n\nprimary ::=\n\t| 'true'\n\t| 'false'\n\t| parenthesized\n\t| KEY '=~' REGEX\n\t| KEY [ ('==' | '!=' | '<' | '<=' | '>' | '>=' | 'not' 'in' | 'in') value ]\n\nparenthesized ::=\n\t| '(' expression ')'\n\nvalue ::=\n\t| 'true'\n\t| 'false'\n\t| 'in'      \t// we support `in` as a value because there's an extension that uses it, ie \"when\": \"languageId == in\"\n\t| VALUE \t\t// matched by the same regex as KEY; consider putting the value in single quotes if it's a string (e.g., with spaces)\n\t| SINGLE_QUOTED_STR\n\t| EMPTY_STR  \t// this allows \"when\": \"foo == \" which's used by existing extensions\n\n```\n*/\n\nexport type ParserConfig = {\n\t/**\n\t * with this option enabled, the parser can recover from regex parsing errors, e.g., unescaped slashes: `/src//` is accepted as `/src\\//` would be\n\t */\n\tregexParsingWithErrorRecovery: boolean;\n};\n\nconst defaultConfig: ParserConfig = {\n\tregexParsingWithErrorRecovery: true\n};\n\nexport type ParsingError = {\n\tmessage: string;\n\toffset: number;\n\tlexeme: string;\n\tadditionalInfo?: string;\n};\n\nconst errorEmptyString = localize('contextkey.parser.error.emptyString', \"Empty context key expression\");\nconst hintEmptyString = localize('contextkey.parser.error.emptyString.hint', \"Did you forget to write an expression? You can also put 'false' or 'true' to always evaluate to false or true, respectively.\");\nconst errorNoInAfterNot = localize('contextkey.parser.error.noInAfterNot', \"'in' after 'not'.\");\nconst errorClosingParenthesis = localize('contextkey.parser.error.closingParenthesis', \"closing parenthesis ')'\");\nconst errorUnexpectedToken = localize('contextkey.parser.error.unexpectedToken', \"Unexpected token\");\nconst hintUnexpectedToken = localize('contextkey.parser.error.unexpectedToken.hint', \"Did you forget to put && or || before the token?\");\nconst errorUnexpectedEOF = localize('contextkey.parser.error.unexpectedEOF', \"Unexpected end of expression\");\nconst hintUnexpectedEOF = localize('contextkey.parser.error.unexpectedEOF.hint', \"Did you forget to put a context key?\");\n\n/**\n * A parser for context key expressions.\n *\n * Example:\n * ```ts\n * const parser = new Parser();\n * const expr = parser.parse('foo == \"bar\" && baz == true');\n *\n * if (expr === undefined) {\n * \t// there were lexing or parsing errors\n * \t// process lexing errors with `parser.lexingErrors`\n *  // process parsing errors with `parser.parsingErrors`\n * } else {\n * \t// expr is a valid expression\n * }\n * ```\n */\nexport class Parser {\n\t// Note: this doesn't produce an exact syntax tree but a normalized one\n\t// ContextKeyExpression's that we use as AST nodes do not expose constructors that do not normalize\n\n\tprivate static _parseError = new Error();\n\n\t// lifetime note: `_scanner` lives as long as the parser does, i.e., is not reset between calls to `parse`\n\tprivate readonly _scanner = new Scanner();\n\n\t// lifetime note: `_tokens`, `_current`, and `_parsingErrors` must be reset between calls to `parse`\n\tprivate _tokens: Token[] = [];\n\tprivate _current = 0; \t\t\t\t\t// invariant: 0 <= this._current < this._tokens.length ; any incrementation of this value must first call `_isAtEnd`\n\tprivate _parsingErrors: ParsingError[] = [];\n\n\tget lexingErrors(): Readonly<LexingError[]> {\n\t\treturn this._scanner.errors;\n\t}\n\n\tget parsingErrors(): Readonly<ParsingError[]> {\n\t\treturn this._parsingErrors;\n\t}\n\n\tconstructor(private readonly _config: ParserConfig = defaultConfig) {\n\t}\n\n\t/**\n\t * Parse a context key expression.\n\t *\n\t * @param input the expression to parse\n\t * @returns the parsed expression or `undefined` if there's an error - call `lexingErrors` and `parsingErrors` to see the errors\n\t */\n\tparse(input: string): ContextKeyExpression | undefined {\n\n\t\tif (input === '') {\n\t\t\tthis._parsingErrors.push({ message: errorEmptyString, offset: 0, lexeme: '', additionalInfo: hintEmptyString });\n\t\t\treturn undefined;\n\t\t}\n\n\t\tthis._tokens = this._scanner.reset(input).scan();\n\t\t// @ulugbekna: we do not stop parsing if there are lexing errors to be able to reconstruct regexes with unescaped slashes; TODO@ulugbekna: make this respect config option for recovery\n\n\t\tthis._current = 0;\n\t\tthis._parsingErrors = [];\n\n\t\ttry {\n\t\t\tconst expr = this._expr();\n\t\t\tif (!this._isAtEnd()) {\n\t\t\t\tconst peek = this._peek();\n\t\t\t\tconst additionalInfo = peek.type === TokenType.Str ? hintUnexpectedToken : undefined;\n\t\t\t\tthis._parsingErrors.push({ message: errorUnexpectedToken, offset: peek.offset, lexeme: Scanner.getLexeme(peek), additionalInfo });\n\t\t\t\tthrow Parser._parseError;\n\t\t\t}\n\t\t\treturn expr;\n\t\t} catch (e) {\n\t\t\tif (!(e === Parser._parseError)) {\n\t\t\t\tthrow e;\n\t\t\t}\n\t\t\treturn undefined;\n\t\t}\n\t}\n\n\tprivate _expr(): ContextKeyExpression | undefined {\n\t\treturn this._or();\n\t}\n\n\tprivate _or(): ContextKeyExpression | undefined {\n\t\tconst expr = [this._and()];\n\n\t\twhile (this._matchOne(TokenType.Or)) {\n\t\t\tconst right = this._and();\n\t\t\texpr.push(right);\n\t\t}\n\n\t\treturn expr.length === 1 ? expr[0] : ContextKeyExpr.or(...expr);\n\t}\n\n\tprivate _and(): ContextKeyExpression | undefined {\n\t\tconst expr = [this._term()];\n\n\t\twhile (this._matchOne(TokenType.And)) {\n\t\t\tconst right = this._term();\n\t\t\texpr.push(right);\n\t\t}\n\n\t\treturn expr.length === 1 ? expr[0] : ContextKeyExpr.and(...expr);\n\t}\n\n\tprivate _term(): ContextKeyExpression | undefined {\n\t\tif (this._matchOne(TokenType.Neg)) {\n\t\t\tconst peek = this._peek();\n\t\t\tswitch (peek.type) {\n\t\t\t\tcase TokenType.True:\n\t\t\t\t\tthis._advance();\n\t\t\t\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t\t\t\tcase TokenType.False:\n\t\t\t\t\tthis._advance();\n\t\t\t\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t\t\t\tcase TokenType.LParen: {\n\t\t\t\t\tthis._advance();\n\t\t\t\t\tconst expr = this._expr();\n\t\t\t\t\tthis._consume(TokenType.RParen, errorClosingParenthesis);\n\t\t\t\t\treturn expr?.negate();\n\t\t\t\t}\n\t\t\t\tcase TokenType.Str:\n\t\t\t\t\tthis._advance();\n\t\t\t\t\treturn ContextKeyNotExpr.create(peek.lexeme);\n\t\t\t\tdefault:\n\t\t\t\t\tthrow this._errExpectedButGot(`KEY | true | false | '(' expression ')'`, peek);\n\t\t\t}\n\t\t}\n\t\treturn this._primary();\n\t}\n\n\tprivate _primary(): ContextKeyExpression | undefined {\n\n\t\tconst peek = this._peek();\n\t\tswitch (peek.type) {\n\t\t\tcase TokenType.True:\n\t\t\t\tthis._advance();\n\t\t\t\treturn ContextKeyExpr.true();\n\n\t\t\tcase TokenType.False:\n\t\t\t\tthis._advance();\n\t\t\t\treturn ContextKeyExpr.false();\n\n\t\t\tcase TokenType.LParen: {\n\t\t\t\tthis._advance();\n\t\t\t\tconst expr = this._expr();\n\t\t\t\tthis._consume(TokenType.RParen, errorClosingParenthesis);\n\t\t\t\treturn expr;\n\t\t\t}\n\n\t\t\tcase TokenType.Str: {\n\t\t\t\t// KEY\n\t\t\t\tconst key = peek.lexeme;\n\t\t\t\tthis._advance();\n\n\t\t\t\t// =~ regex\n\t\t\t\tif (this._matchOne(TokenType.RegexOp)) {\n\n\t\t\t\t\t// @ulugbekna: we need to reconstruct the regex from the tokens because some extensions use unescaped slashes in regexes\n\t\t\t\t\tconst expr = this._peek();\n\n\t\t\t\t\tif (!this._config.regexParsingWithErrorRecovery) {\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\tif (expr.type !== TokenType.RegexStr) {\n\t\t\t\t\t\t\tthrow this._errExpectedButGot(`REGEX`, expr);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tconst regexLexeme = expr.lexeme;\n\t\t\t\t\t\tconst closingSlashIndex = regexLexeme.lastIndexOf('/');\n\t\t\t\t\t\tconst flags = closingSlashIndex === regexLexeme.length - 1 ? undefined : this._removeFlagsGY(regexLexeme.substring(closingSlashIndex + 1));\n\t\t\t\t\t\tlet regexp: RegExp | null;\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tregexp = new RegExp(regexLexeme.substring(1, closingSlashIndex), flags);\n\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\tthrow this._errExpectedButGot(`REGEX`, expr);\n\t\t\t\t\t\t}\n\t\t\t\t\t\treturn ContextKeyRegexExpr.create(key, regexp);\n\t\t\t\t\t}\n\n\t\t\t\t\tswitch (expr.type) {\n\t\t\t\t\t\tcase TokenType.RegexStr:\n\t\t\t\t\t\tcase TokenType.Error: { // also handle an ErrorToken in case of smth such as /(/file)/\n\t\t\t\t\t\t\tconst lexemeReconstruction = [expr.lexeme]; // /REGEX/ or /REGEX/FLAGS\n\t\t\t\t\t\t\tthis._advance();\n\n\t\t\t\t\t\t\tlet followingToken = this._peek();\n\t\t\t\t\t\t\tlet parenBalance = 0;\n\t\t\t\t\t\t\tfor (let i = 0; i < expr.lexeme.length; i++) {\n\t\t\t\t\t\t\t\tif (expr.lexeme.charCodeAt(i) === CharCode.OpenParen) {\n\t\t\t\t\t\t\t\t\tparenBalance++;\n\t\t\t\t\t\t\t\t} else if (expr.lexeme.charCodeAt(i) === CharCode.CloseParen) {\n\t\t\t\t\t\t\t\t\tparenBalance--;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\twhile (!this._isAtEnd() && followingToken.type !== TokenType.And && followingToken.type !== TokenType.Or) {\n\t\t\t\t\t\t\t\tswitch (followingToken.type) {\n\t\t\t\t\t\t\t\t\tcase TokenType.LParen:\n\t\t\t\t\t\t\t\t\t\tparenBalance++;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase TokenType.RParen:\n\t\t\t\t\t\t\t\t\t\tparenBalance--;\n\t\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t\tcase TokenType.RegexStr:\n\t\t\t\t\t\t\t\t\tcase TokenType.QuotedStr:\n\t\t\t\t\t\t\t\t\t\tfor (let i = 0; i < followingToken.lexeme.length; i++) {\n\t\t\t\t\t\t\t\t\t\t\tif (followingToken.lexeme.charCodeAt(i) === CharCode.OpenParen) {\n\t\t\t\t\t\t\t\t\t\t\t\tparenBalance++;\n\t\t\t\t\t\t\t\t\t\t\t} else if (expr.lexeme.charCodeAt(i) === CharCode.CloseParen) {\n\t\t\t\t\t\t\t\t\t\t\t\tparenBalance--;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tif (parenBalance < 0) {\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\tlexemeReconstruction.push(Scanner.getLexeme(followingToken));\n\t\t\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\t\t\tfollowingToken = this._peek();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tconst regexLexeme = lexemeReconstruction.join('');\n\t\t\t\t\t\t\tconst closingSlashIndex = regexLexeme.lastIndexOf('/');\n\t\t\t\t\t\t\tconst flags = closingSlashIndex === regexLexeme.length - 1 ? undefined : this._removeFlagsGY(regexLexeme.substring(closingSlashIndex + 1));\n\t\t\t\t\t\t\tlet regexp: RegExp | null;\n\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\tregexp = new RegExp(regexLexeme.substring(1, closingSlashIndex), flags);\n\t\t\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\t\t\tthrow this._errExpectedButGot(`REGEX`, expr);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\treturn ContextKeyExpr.regex(key, regexp);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tcase TokenType.QuotedStr: {\n\t\t\t\t\t\t\tconst serializedValue = expr.lexeme;\n\t\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\t\t// replicate old regex parsing behavior\n\n\t\t\t\t\t\t\tlet regex: RegExp | null = null;\n\n\t\t\t\t\t\t\tif (!isFalsyOrWhitespace(serializedValue)) {\n\t\t\t\t\t\t\t\tconst start = serializedValue.indexOf('/');\n\t\t\t\t\t\t\t\tconst end = serializedValue.lastIndexOf('/');\n\t\t\t\t\t\t\t\tif (start !== end && start >= 0) {\n\n\t\t\t\t\t\t\t\t\tconst value = serializedValue.slice(start + 1, end);\n\t\t\t\t\t\t\t\t\tconst caseIgnoreFlag = serializedValue[end + 1] === 'i' ? 'i' : '';\n\t\t\t\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\t\t\t\tregex = new RegExp(value, caseIgnoreFlag);\n\t\t\t\t\t\t\t\t\t} catch (_e) {\n\t\t\t\t\t\t\t\t\t\tthrow this._errExpectedButGot(`REGEX`, expr);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (regex === null) {\n\t\t\t\t\t\t\t\tthrow this._errExpectedButGot('REGEX', expr);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn ContextKeyRegexExpr.create(key, regex);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\tthrow this._errExpectedButGot('REGEX', this._peek());\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// [ 'not' 'in' value ]\n\t\t\t\tif (this._matchOne(TokenType.Not)) {\n\t\t\t\t\tthis._consume(TokenType.In, errorNoInAfterNot);\n\t\t\t\t\tconst right = this._value();\n\t\t\t\t\treturn ContextKeyExpr.notIn(key, right);\n\t\t\t\t}\n\n\t\t\t\t// [ ('==' | '!=' | '<' | '<=' | '>' | '>=' | 'in') value ]\n\t\t\t\tconst maybeOp = this._peek().type;\n\t\t\t\tswitch (maybeOp) {\n\t\t\t\t\tcase TokenType.Eq: {\n\t\t\t\t\t\tthis._advance();\n\n\t\t\t\t\t\tconst right = this._value();\n\t\t\t\t\t\tif (this._previous().type === TokenType.QuotedStr) { // to preserve old parser behavior: \"foo == 'true'\" is preserved as \"foo == 'true'\", but \"foo == true\" is optimized as \"foo\"\n\t\t\t\t\t\t\treturn ContextKeyExpr.equals(key, right);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tswitch (right) {\n\t\t\t\t\t\t\tcase 'true':\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.has(key);\n\t\t\t\t\t\t\tcase 'false':\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.not(key);\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.equals(key, right);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tcase TokenType.NotEq: {\n\t\t\t\t\t\tthis._advance();\n\n\t\t\t\t\t\tconst right = this._value();\n\t\t\t\t\t\tif (this._previous().type === TokenType.QuotedStr) { // same as above with \"foo != 'true'\"\n\t\t\t\t\t\t\treturn ContextKeyExpr.notEquals(key, right);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tswitch (right) {\n\t\t\t\t\t\t\tcase 'true':\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.not(key);\n\t\t\t\t\t\t\tcase 'false':\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.has(key);\n\t\t\t\t\t\t\tdefault:\n\t\t\t\t\t\t\t\treturn ContextKeyExpr.notEquals(key, right);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// TODO: ContextKeyExpr.smaller(key, right) accepts only `number` as `right` AND during eval of this node, we just eval to `false` if `right` is not a number\n\t\t\t\t\t// consequently, package.json linter should _warn_ the user if they're passing undesired things to ops\n\t\t\t\t\tcase TokenType.Lt:\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\treturn ContextKeySmallerExpr.create(key, this._value());\n\n\t\t\t\t\tcase TokenType.LtEq:\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\treturn ContextKeySmallerEqualsExpr.create(key, this._value());\n\n\t\t\t\t\tcase TokenType.Gt:\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\treturn ContextKeyGreaterExpr.create(key, this._value());\n\n\t\t\t\t\tcase TokenType.GtEq:\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\treturn ContextKeyGreaterEqualsExpr.create(key, this._value());\n\n\t\t\t\t\tcase TokenType.In:\n\t\t\t\t\t\tthis._advance();\n\t\t\t\t\t\treturn ContextKeyExpr.in(key, this._value());\n\n\t\t\t\t\tdefault:\n\t\t\t\t\t\treturn ContextKeyExpr.has(key);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcase TokenType.EOF:\n\t\t\t\tthis._parsingErrors.push({ message: errorUnexpectedEOF, offset: peek.offset, lexeme: '', additionalInfo: hintUnexpectedEOF });\n\t\t\t\tthrow Parser._parseError;\n\n\t\t\tdefault:\n\t\t\t\tthrow this._errExpectedButGot(`true | false | KEY \\n\\t| KEY '=~' REGEX \\n\\t| KEY ('==' | '!=' | '<' | '<=' | '>' | '>=' | 'in' | 'not' 'in') value`, this._peek());\n\n\t\t}\n\t}\n\n\tprivate _value(): string {\n\t\tconst token = this._peek();\n\t\tswitch (token.type) {\n\t\t\tcase TokenType.Str:\n\t\t\tcase TokenType.QuotedStr:\n\t\t\t\tthis._advance();\n\t\t\t\treturn token.lexeme;\n\t\t\tcase TokenType.True:\n\t\t\t\tthis._advance();\n\t\t\t\treturn 'true';\n\t\t\tcase TokenType.False:\n\t\t\t\tthis._advance();\n\t\t\t\treturn 'false';\n\t\t\tcase TokenType.In: // we support `in` as a value, e.g., \"when\": \"languageId == in\" - exists in existing extensions\n\t\t\t\tthis._advance();\n\t\t\t\treturn 'in';\n\t\t\tdefault:\n\t\t\t\t// this allows \"when\": \"foo == \" which's used by existing extensions\n\t\t\t\t// we do not call `_advance` on purpose - we don't want to eat unintended tokens\n\t\t\t\treturn '';\n\t\t}\n\t}\n\n\tprivate _flagsGYRe = /g|y/g;\n\tprivate _removeFlagsGY(flags: string): string {\n\t\treturn flags.replaceAll(this._flagsGYRe, '');\n\t}\n\n\t// careful: this can throw if current token is the initial one (ie index = 0)\n\tprivate _previous() {\n\t\treturn this._tokens[this._current - 1];\n\t}\n\n\tprivate _matchOne(token: TokenType) {\n\t\tif (this._check(token)) {\n\t\t\tthis._advance();\n\t\t\treturn true;\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tprivate _advance() {\n\t\tif (!this._isAtEnd()) {\n\t\t\tthis._current++;\n\t\t}\n\t\treturn this._previous();\n\t}\n\n\tprivate _consume(type: TokenType, message: string) {\n\t\tif (this._check(type)) {\n\t\t\treturn this._advance();\n\t\t}\n\n\t\tthrow this._errExpectedButGot(message, this._peek());\n\t}\n\n\tprivate _errExpectedButGot(expected: string, got: Token, additionalInfo?: string) {\n\t\tconst message = localize('contextkey.parser.error.expectedButGot', \"Expected: {0}\\nReceived: '{1}'.\", expected, Scanner.getLexeme(got));\n\t\tconst offset = got.offset;\n\t\tconst lexeme = Scanner.getLexeme(got);\n\t\tthis._parsingErrors.push({ message, offset, lexeme, additionalInfo });\n\t\treturn Parser._parseError;\n\t}\n\n\tprivate _check(type: TokenType) {\n\t\treturn this._peek().type === type;\n\t}\n\n\tprivate _peek() {\n\t\treturn this._tokens[this._current];\n\t}\n\n\tprivate _isAtEnd() {\n\t\treturn this._peek().type === TokenType.EOF;\n\t}\n}\n\nexport abstract class ContextKeyExpr {\n\n\tpublic static false(): ContextKeyExpression {\n\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t}\n\tpublic static true(): ContextKeyExpression {\n\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t}\n\tpublic static has(key: string): ContextKeyExpression {\n\t\treturn ContextKeyDefinedExpr.create(key);\n\t}\n\tpublic static equals(key: string, value: any): ContextKeyExpression {\n\t\treturn ContextKeyEqualsExpr.create(key, value);\n\t}\n\tpublic static notEquals(key: string, value: any): ContextKeyExpression {\n\t\treturn ContextKeyNotEqualsExpr.create(key, value);\n\t}\n\tpublic static regex(key: string, value: RegExp): ContextKeyExpression {\n\t\treturn ContextKeyRegexExpr.create(key, value);\n\t}\n\tpublic static in(key: string, value: string): ContextKeyExpression {\n\t\treturn ContextKeyInExpr.create(key, value);\n\t}\n\tpublic static notIn(key: string, value: string): ContextKeyExpression {\n\t\treturn ContextKeyNotInExpr.create(key, value);\n\t}\n\tpublic static not(key: string): ContextKeyExpression {\n\t\treturn ContextKeyNotExpr.create(key);\n\t}\n\tpublic static and(...expr: Array<ContextKeyExpression | undefined | null>): ContextKeyExpression | undefined {\n\t\treturn ContextKeyAndExpr.create(expr, null, true);\n\t}\n\tpublic static or(...expr: Array<ContextKeyExpression | undefined | null>): ContextKeyExpression | undefined {\n\t\treturn ContextKeyOrExpr.create(expr, null, true);\n\t}\n\tpublic static greater(key: string, value: number): ContextKeyExpression {\n\t\treturn ContextKeyGreaterExpr.create(key, value);\n\t}\n\tpublic static greaterEquals(key: string, value: number): ContextKeyExpression {\n\t\treturn ContextKeyGreaterEqualsExpr.create(key, value);\n\t}\n\tpublic static smaller(key: string, value: number): ContextKeyExpression {\n\t\treturn ContextKeySmallerExpr.create(key, value);\n\t}\n\tpublic static smallerEquals(key: string, value: number): ContextKeyExpression {\n\t\treturn ContextKeySmallerEqualsExpr.create(key, value);\n\t}\n\n\tprivate static _parser = new Parser({ regexParsingWithErrorRecovery: false });\n\tpublic static deserialize(serialized: string | null | undefined): ContextKeyExpression | undefined {\n\t\tif (serialized === undefined || serialized === null) { // an empty string needs to be handled by the parser to get a corresponding parsing error reported\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst expr = this._parser.parse(serialized);\n\t\treturn expr;\n\t}\n\n}\n\n\nexport function validateWhenClauses(whenClauses: string[]): any {\n\n\tconst parser = new Parser({ regexParsingWithErrorRecovery: false }); // we run with no recovery to guide users to use correct regexes\n\n\treturn whenClauses.map(whenClause => {\n\t\tparser.parse(whenClause);\n\n\t\tif (parser.lexingErrors.length > 0) {\n\t\t\treturn parser.lexingErrors.map((se: LexingError) => ({\n\t\t\t\terrorMessage: se.additionalInfo ?\n\t\t\t\t\tlocalize('contextkey.scanner.errorForLinterWithHint', \"Unexpected token. Hint: {0}\", se.additionalInfo) :\n\t\t\t\t\tlocalize('contextkey.scanner.errorForLinter', \"Unexpected token.\"),\n\t\t\t\toffset: se.offset,\n\t\t\t\tlength: se.lexeme.length,\n\t\t\t}));\n\t\t} else if (parser.parsingErrors.length > 0) {\n\t\t\treturn parser.parsingErrors.map((pe: ParsingError) => ({\n\t\t\t\terrorMessage: pe.additionalInfo ? `${pe.message}. ${pe.additionalInfo}` : pe.message,\n\t\t\t\toffset: pe.offset,\n\t\t\t\tlength: pe.lexeme.length,\n\t\t\t}));\n\t\t} else {\n\t\t\treturn [];\n\t\t}\n\t});\n}\n\nexport function expressionsAreEqualWithConstantSubstitution(a: ContextKeyExpression | null | undefined, b: ContextKeyExpression | null | undefined): boolean {\n\tconst aExpr = a ? a.substituteConstants() : undefined;\n\tconst bExpr = b ? b.substituteConstants() : undefined;\n\tif (!aExpr && !bExpr) {\n\t\treturn true;\n\t}\n\tif (!aExpr || !bExpr) {\n\t\treturn false;\n\t}\n\treturn aExpr.equals(bExpr);\n}\n\nfunction cmp(a: ContextKeyExpression, b: ContextKeyExpression): number {\n\treturn a.cmp(b);\n}\n\nexport class ContextKeyFalseExpr implements IContextKeyExpression {\n\tpublic static INSTANCE = new ContextKeyFalseExpr();\n\n\tpublic readonly type = ContextKeyExprType.False;\n\n\tprotected constructor() {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\treturn this.type - other.type;\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\treturn (other.type === this.type);\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn false;\n\t}\n\n\tpublic serialize(): string {\n\t\treturn 'false';\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn this;\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t}\n}\n\nexport class ContextKeyTrueExpr implements IContextKeyExpression {\n\tpublic static INSTANCE = new ContextKeyTrueExpr();\n\n\tpublic readonly type = ContextKeyExprType.True;\n\n\tprotected constructor() {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\treturn this.type - other.type;\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\treturn (other.type === this.type);\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn true;\n\t}\n\n\tpublic serialize(): string {\n\t\treturn 'true';\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn this;\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t}\n}\n\nexport class ContextKeyDefinedExpr implements IContextKeyExpression {\n\tpublic static create(key: string, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\tconst constantValue = CONSTANT_VALUES.get(key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\treturn constantValue ? ContextKeyTrueExpr.INSTANCE : ContextKeyFalseExpr.INSTANCE;\n\t\t}\n\t\treturn new ContextKeyDefinedExpr(key, negated);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Defined;\n\n\tprotected constructor(\n\t\treadonly key: string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp1(this.key, other.key);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst constantValue = CONSTANT_VALUES.get(this.key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\treturn constantValue ? ContextKeyTrueExpr.INSTANCE : ContextKeyFalseExpr.INSTANCE;\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn (!!context.getValue(this.key));\n\t}\n\n\tpublic serialize(): string {\n\t\treturn this.key;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapDefined(this.key);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyNotExpr.create(this.key, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyEqualsExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\tif (typeof value === 'boolean') {\n\t\t\treturn (value ? ContextKeyDefinedExpr.create(key, negated) : ContextKeyNotExpr.create(key, negated));\n\t\t}\n\t\tconst constantValue = CONSTANT_VALUES.get(key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\tconst trueValue = constantValue ? 'true' : 'false';\n\t\t\treturn (value === trueValue ? ContextKeyTrueExpr.INSTANCE : ContextKeyFalseExpr.INSTANCE);\n\t\t}\n\t\treturn new ContextKeyEqualsExpr(key, value, negated);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Equals;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: any,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst constantValue = CONSTANT_VALUES.get(this.key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\tconst trueValue = constantValue ? 'true' : 'false';\n\t\t\treturn (this.value === trueValue ? ContextKeyTrueExpr.INSTANCE : ContextKeyFalseExpr.INSTANCE);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\t// Intentional ==\n\t\t// eslint-disable-next-line eqeqeq\n\t\treturn (context.getValue(this.key) == this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} == '${this.value}'`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapEquals(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyNotEqualsExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyInExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, valueKey: string): ContextKeyInExpr {\n\t\treturn new ContextKeyInExpr(key, valueKey);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.In;\n\tprivate negated: ContextKeyExpression | null = null;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly valueKey: string,\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.valueKey, other.key, other.valueKey);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.valueKey === other.valueKey);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tconst source = context.getValue(this.valueKey);\n\n\t\tconst item = context.getValue(this.key);\n\n\t\tif (Array.isArray(source)) {\n\t\t\t// eslint-disable-next-line local/code-no-any-casts\n\t\t\treturn source.includes(item as any);\n\t\t}\n\n\t\tif (typeof item === 'string' && typeof source === 'object' && source !== null) {\n\t\t\treturn hasOwnProperty.call(source, item);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} in '${this.valueKey}'`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key, this.valueKey];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyInExpr {\n\t\treturn mapFnc.mapIn(this.key, this.valueKey);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyNotInExpr.create(this.key, this.valueKey);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyNotInExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, valueKey: string): ContextKeyNotInExpr {\n\t\treturn new ContextKeyNotInExpr(key, valueKey);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.NotIn;\n\n\tprivate readonly _negated: ContextKeyInExpr;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly valueKey: string,\n\t) {\n\t\tthis._negated = ContextKeyInExpr.create(key, valueKey);\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn this._negated.cmp(other._negated);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn this._negated.equals(other._negated);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn !this._negated.evaluate(context);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} not in '${this.valueKey}'`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn this._negated.keys();\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapNotIn(this.key, this.valueKey);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\treturn this._negated;\n\t}\n}\n\nexport class ContextKeyNotEqualsExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\tif (typeof value === 'boolean') {\n\t\t\tif (value) {\n\t\t\t\treturn ContextKeyNotExpr.create(key, negated);\n\t\t\t}\n\t\t\treturn ContextKeyDefinedExpr.create(key, negated);\n\t\t}\n\t\tconst constantValue = CONSTANT_VALUES.get(key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\tconst falseValue = constantValue ? 'true' : 'false';\n\t\t\treturn (value === falseValue ? ContextKeyFalseExpr.INSTANCE : ContextKeyTrueExpr.INSTANCE);\n\t\t}\n\t\treturn new ContextKeyNotEqualsExpr(key, value, negated);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.NotEquals;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: any,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst constantValue = CONSTANT_VALUES.get(this.key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\tconst falseValue = constantValue ? 'true' : 'false';\n\t\t\treturn (this.value === falseValue ? ContextKeyFalseExpr.INSTANCE : ContextKeyTrueExpr.INSTANCE);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\t// Intentional !=\n\t\t// eslint-disable-next-line eqeqeq\n\t\treturn (context.getValue(this.key) != this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} != '${this.value}'`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapNotEquals(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyEqualsExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyNotExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\tconst constantValue = CONSTANT_VALUES.get(key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\treturn (constantValue ? ContextKeyFalseExpr.INSTANCE : ContextKeyTrueExpr.INSTANCE);\n\t\t}\n\t\treturn new ContextKeyNotExpr(key, negated);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Not;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp1(this.key, other.key);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst constantValue = CONSTANT_VALUES.get(this.key);\n\t\tif (typeof constantValue === 'boolean') {\n\t\t\treturn (constantValue ? ContextKeyFalseExpr.INSTANCE : ContextKeyTrueExpr.INSTANCE);\n\t\t}\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn (!context.getValue(this.key));\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `!${this.key}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapNot(this.key);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyDefinedExpr.create(this.key, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nfunction withFloatOrStr<T extends ContextKeyExpression>(value: any, callback: (value: number | string) => T): T | ContextKeyFalseExpr {\n\tif (typeof value === 'string') {\n\t\tconst n = parseFloat(value);\n\t\tif (!isNaN(n)) {\n\t\t\tvalue = n;\n\t\t}\n\t}\n\tif (typeof value === 'string' || typeof value === 'number') {\n\t\treturn callback(value);\n\t}\n\treturn ContextKeyFalseExpr.INSTANCE;\n}\n\nexport class ContextKeyGreaterExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, _value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\treturn withFloatOrStr(_value, (value) => new ContextKeyGreaterExpr(key, value, negated));\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Greater;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: number | string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) { }\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tif (typeof this.value === 'string') {\n\t\t\treturn false;\n\t\t}\n\t\treturn (parseFloat(context.getValue<any>(this.key)) > this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} > ${this.value}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapGreater(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeySmallerEqualsExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyGreaterEqualsExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, _value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\treturn withFloatOrStr(_value, (value) => new ContextKeyGreaterEqualsExpr(key, value, negated));\n\t}\n\n\tpublic readonly type = ContextKeyExprType.GreaterEquals;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: number | string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) { }\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tif (typeof this.value === 'string') {\n\t\t\treturn false;\n\t\t}\n\t\treturn (parseFloat(context.getValue<any>(this.key)) >= this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} >= ${this.value}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapGreaterEquals(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeySmallerExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeySmallerExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, _value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\treturn withFloatOrStr(_value, (value) => new ContextKeySmallerExpr(key, value, negated));\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Smaller;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: number | string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tif (typeof this.value === 'string') {\n\t\t\treturn false;\n\t\t}\n\t\treturn (parseFloat(context.getValue<any>(this.key)) < this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} < ${this.value}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapSmaller(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyGreaterEqualsExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeySmallerEqualsExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, _value: any, negated: ContextKeyExpression | null = null): ContextKeyExpression {\n\t\treturn withFloatOrStr(_value, (value) => new ContextKeySmallerEqualsExpr(key, value, negated));\n\t}\n\n\tpublic readonly type = ContextKeyExprType.SmallerEquals;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly value: number | string,\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn cmp2(this.key, this.value, other.key, other.value);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn (this.key === other.key && this.value === other.value);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tif (typeof this.value === 'string') {\n\t\t\treturn false;\n\t\t}\n\t\treturn (parseFloat(context.getValue<any>(this.key)) <= this.value);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `${this.key} <= ${this.value}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn mapFnc.mapSmallerEquals(this.key, this.value);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyGreaterExpr.create(this.key, this.value, this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyRegexExpr implements IContextKeyExpression {\n\n\tpublic static create(key: string, regexp: RegExp | null): ContextKeyRegexExpr {\n\t\treturn new ContextKeyRegexExpr(key, regexp);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Regex;\n\tprivate negated: ContextKeyExpression | null = null;\n\n\tprivate constructor(\n\t\tprivate readonly key: string,\n\t\tprivate readonly regexp: RegExp | null\n\t) {\n\t\t//\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\tif (this.key < other.key) {\n\t\t\treturn -1;\n\t\t}\n\t\tif (this.key > other.key) {\n\t\t\treturn 1;\n\t\t}\n\t\tconst thisSource = this.regexp ? this.regexp.source : '';\n\t\tconst otherSource = other.regexp ? other.regexp.source : '';\n\t\tif (thisSource < otherSource) {\n\t\t\treturn -1;\n\t\t}\n\t\tif (thisSource > otherSource) {\n\t\t\treturn 1;\n\t\t}\n\t\treturn 0;\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\tconst thisSource = this.regexp ? this.regexp.source : '';\n\t\t\tconst otherSource = other.regexp ? other.regexp.source : '';\n\t\t\treturn (this.key === other.key && thisSource === otherSource);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tconst value = context.getValue<any>(this.key);\n\t\treturn this.regexp ? this.regexp.test(value) : false;\n\t}\n\n\tpublic serialize(): string {\n\t\tconst value = this.regexp\n\t\t\t? `/${this.regexp.source}/${this.regexp.flags}`\n\t\t\t: '/invalid/';\n\t\treturn `${this.key} =~ ${value}`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn [this.key];\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyRegexExpr {\n\t\treturn mapFnc.mapRegex(this.key, this.regexp);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tthis.negated = ContextKeyNotRegexExpr.create(this);\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyNotRegexExpr implements IContextKeyExpression {\n\n\tpublic static create(actual: ContextKeyRegexExpr): ContextKeyExpression {\n\t\treturn new ContextKeyNotRegexExpr(actual);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.NotRegex;\n\n\tprivate constructor(private readonly _actual: ContextKeyRegexExpr) {\n\t\t//\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\treturn this._actual.cmp(other._actual);\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\treturn this._actual.equals(other._actual);\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\treturn this;\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\treturn !this._actual.evaluate(context);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn `!(${this._actual.serialize()})`;\n\t}\n\n\tpublic keys(): string[] {\n\t\treturn this._actual.keys();\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn new ContextKeyNotRegexExpr(this._actual.map(mapFnc));\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\treturn this._actual;\n\t}\n}\n\n/**\n * @returns the same instance if nothing changed.\n */\nfunction eliminateConstantsInArray(arr: ContextKeyExpression[]): (ContextKeyExpression | undefined)[] {\n\t// Allocate array only if there is a difference\n\tlet newArr: (ContextKeyExpression | undefined)[] | null = null;\n\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\tconst newExpr = arr[i].substituteConstants();\n\n\t\tif (arr[i] !== newExpr) {\n\t\t\t// something has changed!\n\n\t\t\t// allocate array on first difference\n\t\t\tif (newArr === null) {\n\t\t\t\tnewArr = [];\n\t\t\t\tfor (let j = 0; j < i; j++) {\n\t\t\t\t\tnewArr[j] = arr[j];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tif (newArr !== null) {\n\t\t\tnewArr[i] = newExpr;\n\t\t}\n\t}\n\n\tif (newArr === null) {\n\t\treturn arr;\n\t}\n\treturn newArr;\n}\n\nexport class ContextKeyAndExpr implements IContextKeyExpression {\n\n\tpublic static create(_expr: ReadonlyArray<ContextKeyExpression | null | undefined>, negated: ContextKeyExpression | null, extraRedundantCheck: boolean): ContextKeyExpression | undefined {\n\t\treturn ContextKeyAndExpr._normalizeArr(_expr, negated, extraRedundantCheck);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.And;\n\n\tprivate constructor(\n\t\tpublic readonly expr: ContextKeyExpression[],\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\tif (this.expr.length < other.expr.length) {\n\t\t\treturn -1;\n\t\t}\n\t\tif (this.expr.length > other.expr.length) {\n\t\t\treturn 1;\n\t\t}\n\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\tconst r = cmp(this.expr[i], other.expr[i]);\n\t\t\tif (r !== 0) {\n\t\t\t\treturn r;\n\t\t\t}\n\t\t}\n\t\treturn 0;\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\tif (this.expr.length !== other.expr.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\t\tif (!this.expr[i].equals(other.expr[i])) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst exprArr = eliminateConstantsInArray(this.expr);\n\t\tif (exprArr === this.expr) {\n\t\t\t// no change\n\t\t\treturn this;\n\t\t}\n\t\treturn ContextKeyAndExpr.create(exprArr, this.negated, false);\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\tif (!this.expr[i].evaluate(context)) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\treturn true;\n\t}\n\n\tprivate static _normalizeArr(arr: ReadonlyArray<ContextKeyExpression | null | undefined>, negated: ContextKeyExpression | null, extraRedundantCheck: boolean): ContextKeyExpression | undefined {\n\t\tconst expr: ContextKeyExpression[] = [];\n\t\tlet hasTrue = false;\n\n\t\tfor (const e of arr) {\n\t\t\tif (!e) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (e.type === ContextKeyExprType.True) {\n\t\t\t\t// anything && true ==> anything\n\t\t\t\thasTrue = true;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (e.type === ContextKeyExprType.False) {\n\t\t\t\t// anything && false ==> false\n\t\t\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t\t\t}\n\n\t\t\tif (e.type === ContextKeyExprType.And) {\n\t\t\t\texpr.push(...e.expr);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\texpr.push(e);\n\t\t}\n\n\t\tif (expr.length === 0 && hasTrue) {\n\t\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t\t}\n\n\t\tif (expr.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (expr.length === 1) {\n\t\t\treturn expr[0];\n\t\t}\n\n\t\texpr.sort(cmp);\n\n\t\t// eliminate duplicate terms\n\t\tfor (let i = 1; i < expr.length; i++) {\n\t\t\tif (expr[i - 1].equals(expr[i])) {\n\t\t\t\texpr.splice(i, 1);\n\t\t\t\ti--;\n\t\t\t}\n\t\t}\n\n\t\tif (expr.length === 1) {\n\t\t\treturn expr[0];\n\t\t}\n\n\t\t// We must distribute any OR expression because we don't support parens\n\t\t// OR extensions will be at the end (due to sorting rules)\n\t\twhile (expr.length > 1) {\n\t\t\tconst lastElement = expr[expr.length - 1];\n\t\t\tif (lastElement.type !== ContextKeyExprType.Or) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t// pop the last element\n\t\t\texpr.pop();\n\n\t\t\t// pop the second to last element\n\t\t\tconst secondToLastElement = expr.pop()!;\n\n\t\t\tconst isFinished = (expr.length === 0);\n\n\t\t\t// distribute `lastElement` over `secondToLastElement`\n\t\t\tconst resultElement = ContextKeyOrExpr.create(\n\t\t\t\tlastElement.expr.map(el => ContextKeyAndExpr.create([el, secondToLastElement], null, extraRedundantCheck)),\n\t\t\t\tnull,\n\t\t\t\tisFinished\n\t\t\t);\n\n\t\t\tif (resultElement) {\n\t\t\t\texpr.push(resultElement);\n\t\t\t\texpr.sort(cmp);\n\t\t\t}\n\t\t}\n\n\t\tif (expr.length === 1) {\n\t\t\treturn expr[0];\n\t\t}\n\n\t\t// resolve false AND expressions\n\t\tif (extraRedundantCheck) {\n\t\t\tfor (let i = 0; i < expr.length; i++) {\n\t\t\t\tfor (let j = i + 1; j < expr.length; j++) {\n\t\t\t\t\tif (expr[i].negate().equals(expr[j])) {\n\t\t\t\t\t\t// A && !A case\n\t\t\t\t\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (expr.length === 1) {\n\t\t\t\treturn expr[0];\n\t\t\t}\n\t\t}\n\n\t\treturn new ContextKeyAndExpr(expr, negated);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn this.expr.map(e => e.serialize()).join(' && ');\n\t}\n\n\tpublic keys(): string[] {\n\t\tconst result: string[] = [];\n\t\tfor (const expr of this.expr) {\n\t\t\tresult.push(...expr.keys());\n\t\t}\n\t\treturn result;\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn new ContextKeyAndExpr(this.expr.map(expr => expr.map(mapFnc)), null);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tconst result: ContextKeyExpression[] = [];\n\t\t\tfor (const expr of this.expr) {\n\t\t\t\tresult.push(expr.negate());\n\t\t\t}\n\t\t\tthis.negated = ContextKeyOrExpr.create(result, this, true)!;\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport class ContextKeyOrExpr implements IContextKeyExpression {\n\n\tpublic static create(_expr: ReadonlyArray<ContextKeyExpression | null | undefined>, negated: ContextKeyExpression | null, extraRedundantCheck: boolean): ContextKeyExpression | undefined {\n\t\treturn ContextKeyOrExpr._normalizeArr(_expr, negated, extraRedundantCheck);\n\t}\n\n\tpublic readonly type = ContextKeyExprType.Or;\n\n\tprivate constructor(\n\t\tpublic readonly expr: ContextKeyExpression[],\n\t\tprivate negated: ContextKeyExpression | null\n\t) {\n\t}\n\n\tpublic cmp(other: ContextKeyExpression): number {\n\t\tif (other.type !== this.type) {\n\t\t\treturn this.type - other.type;\n\t\t}\n\t\tif (this.expr.length < other.expr.length) {\n\t\t\treturn -1;\n\t\t}\n\t\tif (this.expr.length > other.expr.length) {\n\t\t\treturn 1;\n\t\t}\n\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\tconst r = cmp(this.expr[i], other.expr[i]);\n\t\t\tif (r !== 0) {\n\t\t\t\treturn r;\n\t\t\t}\n\t\t}\n\t\treturn 0;\n\t}\n\n\tpublic equals(other: ContextKeyExpression): boolean {\n\t\tif (other.type === this.type) {\n\t\t\tif (this.expr.length !== other.expr.length) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\t\tif (!this.expr[i].equals(other.expr[i])) {\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tpublic substituteConstants(): ContextKeyExpression | undefined {\n\t\tconst exprArr = eliminateConstantsInArray(this.expr);\n\t\tif (exprArr === this.expr) {\n\t\t\t// no change\n\t\t\treturn this;\n\t\t}\n\t\treturn ContextKeyOrExpr.create(exprArr, this.negated, false);\n\t}\n\n\tpublic evaluate(context: IContext): boolean {\n\t\tfor (let i = 0, len = this.expr.length; i < len; i++) {\n\t\t\tif (this.expr[i].evaluate(context)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate static _normalizeArr(arr: ReadonlyArray<ContextKeyExpression | null | undefined>, negated: ContextKeyExpression | null, extraRedundantCheck: boolean): ContextKeyExpression | undefined {\n\t\tlet expr: ContextKeyExpression[] = [];\n\t\tlet hasFalse = false;\n\n\t\tif (arr) {\n\t\t\tfor (let i = 0, len = arr.length; i < len; i++) {\n\t\t\t\tconst e = arr[i];\n\t\t\t\tif (!e) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif (e.type === ContextKeyExprType.False) {\n\t\t\t\t\t// anything || false ==> anything\n\t\t\t\t\thasFalse = true;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tif (e.type === ContextKeyExprType.True) {\n\t\t\t\t\t// anything || true ==> true\n\t\t\t\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t\t\t\t}\n\n\t\t\t\tif (e.type === ContextKeyExprType.Or) {\n\t\t\t\t\texpr = expr.concat(e.expr);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\texpr.push(e);\n\t\t\t}\n\n\t\t\tif (expr.length === 0 && hasFalse) {\n\t\t\t\treturn ContextKeyFalseExpr.INSTANCE;\n\t\t\t}\n\n\t\t\texpr.sort(cmp);\n\t\t}\n\n\t\tif (expr.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tif (expr.length === 1) {\n\t\t\treturn expr[0];\n\t\t}\n\n\t\t// eliminate duplicate terms\n\t\tfor (let i = 1; i < expr.length; i++) {\n\t\t\tif (expr[i - 1].equals(expr[i])) {\n\t\t\t\texpr.splice(i, 1);\n\t\t\t\ti--;\n\t\t\t}\n\t\t}\n\n\t\tif (expr.length === 1) {\n\t\t\treturn expr[0];\n\t\t}\n\n\t\t// resolve true OR expressions\n\t\tif (extraRedundantCheck) {\n\t\t\tfor (let i = 0; i < expr.length; i++) {\n\t\t\t\tfor (let j = i + 1; j < expr.length; j++) {\n\t\t\t\t\tif (expr[i].negate().equals(expr[j])) {\n\t\t\t\t\t\t// A || !A case\n\t\t\t\t\t\treturn ContextKeyTrueExpr.INSTANCE;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (expr.length === 1) {\n\t\t\t\treturn expr[0];\n\t\t\t}\n\t\t}\n\n\t\treturn new ContextKeyOrExpr(expr, negated);\n\t}\n\n\tpublic serialize(): string {\n\t\treturn this.expr.map(e => e.serialize()).join(' || ');\n\t}\n\n\tpublic keys(): string[] {\n\t\tconst result: string[] = [];\n\t\tfor (const expr of this.expr) {\n\t\t\tresult.push(...expr.keys());\n\t\t}\n\t\treturn result;\n\t}\n\n\tpublic map(mapFnc: IContextKeyExprMapper): ContextKeyExpression {\n\t\treturn new ContextKeyOrExpr(this.expr.map(expr => expr.map(mapFnc)), null);\n\t}\n\n\tpublic negate(): ContextKeyExpression {\n\t\tif (!this.negated) {\n\t\t\tconst result: ContextKeyExpression[] = [];\n\t\t\tfor (const expr of this.expr) {\n\t\t\t\tresult.push(expr.negate());\n\t\t\t}\n\n\t\t\t// We don't support parens, so here we distribute the AND over the OR terminals\n\t\t\t// We always take the first 2 AND pairs and distribute them\n\t\t\twhile (result.length > 1) {\n\t\t\t\tconst LEFT = result.shift()!;\n\t\t\t\tconst RIGHT = result.shift()!;\n\n\t\t\t\tconst all: ContextKeyExpression[] = [];\n\t\t\t\tfor (const left of getTerminals(LEFT)) {\n\t\t\t\t\tfor (const right of getTerminals(RIGHT)) {\n\t\t\t\t\t\tall.push(ContextKeyAndExpr.create([left, right], null, false)!);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tresult.unshift(ContextKeyOrExpr.create(all, null, false)!);\n\t\t\t}\n\n\t\t\tthis.negated = ContextKeyOrExpr.create(result, this, true)!;\n\t\t}\n\t\treturn this.negated;\n\t}\n}\n\nexport interface ContextKeyInfo {\n\treadonly key: string;\n\treadonly type?: string;\n\treadonly description?: string;\n}\n\nexport class RawContextKey<T extends ContextKeyValue> extends ContextKeyDefinedExpr {\n\n\tprivate static _info: ContextKeyInfo[] = [];\n\n\tstatic all(): IterableIterator<ContextKeyInfo> {\n\t\treturn RawContextKey._info.values();\n\t}\n\n\tprivate readonly _defaultValue: T | undefined;\n\n\tconstructor(key: string, defaultValue: T | undefined, metaOrHide?: string | true | { type: string; description: string }) {\n\t\tsuper(key, null);\n\t\tthis._defaultValue = defaultValue;\n\n\t\t// collect all context keys into a central place\n\t\tif (typeof metaOrHide === 'object') {\n\t\t\tRawContextKey._info.push({ ...metaOrHide, key });\n\t\t} else if (metaOrHide !== true) {\n\t\t\tRawContextKey._info.push({ key, description: metaOrHide, type: defaultValue !== null && defaultValue !== undefined ? typeof defaultValue : undefined });\n\t\t}\n\t}\n\n\tpublic bindTo(target: IContextKeyService): IContextKey<T> {\n\t\treturn target.createKey(this.key, this._defaultValue);\n\t}\n\n\tpublic getValue(target: IContextKeyService): T | undefined {\n\t\treturn target.getContextKeyValue<T>(this.key);\n\t}\n\n\tpublic toNegated(): ContextKeyExpression {\n\t\treturn this.negate();\n\t}\n\n\tpublic isEqualTo(value: any): ContextKeyExpression {\n\t\treturn ContextKeyEqualsExpr.create(this.key, value);\n\t}\n\n\tpublic notEqualsTo(value: any): ContextKeyExpression {\n\t\treturn ContextKeyNotEqualsExpr.create(this.key, value);\n\t}\n\n\tpublic greater(value: any): ContextKeyExpression {\n\t\treturn ContextKeyGreaterExpr.create(this.key, value);\n\t}\n}\n\nexport type ContextKeyValue = null | undefined | boolean | number | string\n\t| Array<null | undefined | boolean | number | string>\n\t| Record<string, null | undefined | boolean | number | string>;\n\nexport interface IContext {\n\tgetValue<T extends ContextKeyValue = ContextKeyValue>(key: string): T | undefined;\n}\n\nexport interface IContextKey<T extends ContextKeyValue = ContextKeyValue> {\n\tset(value: T): void;\n\treset(): void;\n\tget(): T | undefined;\n}\n\nexport interface IContextKeyServiceTarget {\n\tparentElement: IContextKeyServiceTarget | null;\n\tsetAttribute(attr: string, value: string): void;\n\tremoveAttribute(attr: string): void;\n\thasAttribute(attr: string): boolean;\n\tgetAttribute(attr: string): string | null;\n}\n\nexport const IContextKeyService = createDecorator<IContextKeyService>('contextKeyService');\n\nexport interface IReadableSet<T> {\n\thas(value: T): boolean;\n}\n\nexport interface IContextKeyChangeEvent {\n\taffectsSome(keys: IReadableSet<string>): boolean;\n\tallKeysContainedIn(keys: IReadableSet<string>): boolean;\n}\n\nexport type IScopedContextKeyService = IContextKeyService & IDisposable;\n\nexport interface IContextKeyService {\n\treadonly _serviceBrand: undefined;\n\n\treadonly onDidChangeContext: Event<IContextKeyChangeEvent>;\n\tbufferChangeEvents(callback: Function): void;\n\n\tcreateKey<T extends ContextKeyValue>(key: string, defaultValue: T | undefined): IContextKey<T>;\n\tcontextMatchesRules(rules: ContextKeyExpression | undefined): boolean;\n\tgetContextKeyValue<T>(key: string): T | undefined;\n\n\tcreateScoped(target: IContextKeyServiceTarget): IScopedContextKeyService;\n\tcreateOverlay(overlay: Iterable<[string, any]>): IContextKeyService;\n\tgetContext(target: IContextKeyServiceTarget | null): IContext;\n\n\tupdateParent(parentContextKeyService: IContextKeyService): void;\n}\n\nfunction cmp1(key1: string, key2: string): number {\n\tif (key1 < key2) {\n\t\treturn -1;\n\t}\n\tif (key1 > key2) {\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nfunction cmp2(key1: string, value1: any, key2: string, value2: any): number {\n\tif (key1 < key2) {\n\t\treturn -1;\n\t}\n\tif (key1 > key2) {\n\t\treturn 1;\n\t}\n\tif (value1 < value2) {\n\t\treturn -1;\n\t}\n\tif (value1 > value2) {\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\n/**\n * Returns true if it is provable `p` implies `q`.\n */\nexport function implies(p: ContextKeyExpression, q: ContextKeyExpression): boolean {\n\n\tif (p.type === ContextKeyExprType.False || q.type === ContextKeyExprType.True) {\n\t\t// false implies anything\n\t\t// anything implies true\n\t\treturn true;\n\t}\n\n\tif (p.type === ContextKeyExprType.Or) {\n\t\tif (q.type === ContextKeyExprType.Or) {\n\t\t\t// `a || b || c` can only imply something like `a || b || c || d`\n\t\t\treturn allElementsIncluded(p.expr, q.expr);\n\t\t}\n\t\treturn false;\n\t}\n\n\tif (q.type === ContextKeyExprType.Or) {\n\t\tfor (const element of q.expr) {\n\t\t\tif (implies(p, element)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tif (p.type === ContextKeyExprType.And) {\n\t\tif (q.type === ContextKeyExprType.And) {\n\t\t\t// `a && b && c` implies `a && c`\n\t\t\treturn allElementsIncluded(q.expr, p.expr);\n\t\t}\n\t\tfor (const element of p.expr) {\n\t\t\tif (implies(element, q)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\treturn p.equals(q);\n}\n\n/**\n * Returns true if all elements in `p` are also present in `q`.\n * The two arrays are assumed to be sorted\n */\nfunction allElementsIncluded(p: ContextKeyExpression[], q: ContextKeyExpression[]): boolean {\n\tlet pIndex = 0;\n\tlet qIndex = 0;\n\twhile (pIndex < p.length && qIndex < q.length) {\n\t\tconst cmp = p[pIndex].cmp(q[qIndex]);\n\n\t\tif (cmp < 0) {\n\t\t\t// an element from `p` is missing from `q`\n\t\t\treturn false;\n\t\t} else if (cmp === 0) {\n\t\t\tpIndex++;\n\t\t\tqIndex++;\n\t\t} else {\n\t\t\tqIndex++;\n\t\t}\n\t}\n\treturn (pIndex === p.length);\n}\n\nfunction getTerminals(node: ContextKeyExpression) {\n\tif (node.type === ContextKeyExprType.Or) {\n\t\treturn node.expr;\n\t}\n\treturn [node];\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as nls from '../../../nls.js';\nimport { toErrorMessage } from '../../../base/common/errorMessage.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { hash } from '../../../base/common/hash.js';\nimport { Disposable, IDisposable } from '../../../base/common/lifecycle.js';\nimport { ResourceMap } from '../../../base/common/map.js';\nimport { isWindows } from '../../../base/common/platform.js';\nimport { joinPath } from '../../../base/common/resources.js';\nimport { Mutable, isNumber, isString } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { ILocalizedString } from '../../action/common/action.js';\nimport { RawContextKey } from '../../contextkey/common/contextkey.js';\nimport { IEnvironmentService } from '../../environment/common/environment.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\n\nexport const ILogService = createDecorator<ILogService>('logService');\nexport const ILoggerService = createDecorator<ILoggerService>('loggerService');\n\nfunction now(): string {\n\treturn new Date().toISOString();\n}\n\nexport function isLogLevel(thing: unknown): thing is LogLevel {\n\treturn isNumber(thing);\n}\n\nexport enum LogLevel {\n\tOff,\n\tTrace,\n\tDebug,\n\tInfo,\n\tWarning,\n\tError\n}\n\nexport const DEFAULT_LOG_LEVEL: LogLevel = LogLevel.Info;\n\nexport interface ILogger extends IDisposable {\n\treadonly onDidChangeLogLevel: Event<LogLevel>;\n\tgetLevel(): LogLevel;\n\tsetLevel(level: LogLevel): void;\n\n\ttrace(message: string, ...args: unknown[]): void;\n\tdebug(message: string, ...args: unknown[]): void;\n\tinfo(message: string, ...args: unknown[]): void;\n\twarn(message: string, ...args: unknown[]): void;\n\terror(message: string | Error, ...args: unknown[]): void;\n\n\t/**\n\t * An operation to flush the contents. Can be synchronous.\n\t */\n\tflush(): void;\n}\n\nexport function canLog(loggerLevel: LogLevel, messageLevel: LogLevel): boolean {\n\treturn loggerLevel !== LogLevel.Off && loggerLevel <= messageLevel;\n}\n\nexport function log(logger: ILogger, level: LogLevel, message: string): void {\n\tswitch (level) {\n\t\tcase LogLevel.Trace: logger.trace(message); break;\n\t\tcase LogLevel.Debug: logger.debug(message); break;\n\t\tcase LogLevel.Info: logger.info(message); break;\n\t\tcase LogLevel.Warning: logger.warn(message); break;\n\t\tcase LogLevel.Error: logger.error(message); break;\n\t\tcase LogLevel.Off: /* do nothing */ break;\n\t\tdefault: throw new Error(`Invalid log level ${level}`);\n\t}\n}\n\nfunction format(args: any, verbose: boolean = false): string {\n\tlet result = '';\n\n\tfor (let i = 0; i < args.length; i++) {\n\t\tlet a = args[i];\n\n\t\tif (a instanceof Error) {\n\t\t\ta = toErrorMessage(a, verbose);\n\t\t}\n\n\t\tif (typeof a === 'object') {\n\t\t\ttry {\n\t\t\t\ta = JSON.stringify(a);\n\t\t\t} catch (e) { }\n\t\t}\n\n\t\tresult += (i > 0 ? ' ' : '') + a;\n\t}\n\n\treturn result;\n}\n\nexport type LoggerGroup = {\n\treadonly id: string;\n\treadonly name: string;\n};\n\nexport interface ILogService extends ILogger {\n\treadonly _serviceBrand: undefined;\n}\n\nexport interface ILoggerOptions {\n\n\t/**\n\t * Id of the logger.\n\t */\n\tid?: string;\n\n\t/**\n\t * Name of the logger.\n\t */\n\tname?: string;\n\n\t/**\n\t * Do not create rotating files if max size exceeds.\n\t */\n\tdonotRotate?: boolean;\n\n\t/**\n\t * Do not use formatters.\n\t */\n\tdonotUseFormatters?: boolean;\n\n\t/**\n\t * When to log. Set to `always` to log always.\n\t */\n\tlogLevel?: 'always' | LogLevel;\n\n\t/**\n\t * Whether the log should be hidden from the user.\n\t */\n\thidden?: boolean;\n\n\t/**\n\t * Condition which must be true to show this logger\n\t */\n\twhen?: string;\n\n\t/**\n\t * Id of the extension that created this logger.\n\t */\n\textensionId?: string;\n\n\t/**\n\t * Group of the logger.\n\t */\n\tgroup?: LoggerGroup;\n}\n\nexport interface ILoggerResource {\n\treadonly resource: URI;\n\treadonly id: string;\n\treadonly name?: string;\n\treadonly logLevel?: LogLevel;\n\treadonly hidden?: boolean;\n\treadonly when?: string;\n\treadonly extensionId?: string;\n\treadonly group?: LoggerGroup;\n}\n\nexport type DidChangeLoggersEvent = {\n\treadonly added: Iterable<ILoggerResource>;\n\treadonly removed: Iterable<ILoggerResource>;\n};\n\nexport interface ILoggerService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * Creates a logger for the given resource, or gets one if it already exists.\n\t *\n\t * This will also register the logger with the logger service.\n\t */\n\tcreateLogger(resource: URI, options?: ILoggerOptions): ILogger;\n\n\t/**\n\t * Creates a logger with the given id in the logs folder, or gets one if it already exists.\n\t *\n\t * This will also register the logger with the logger service.\n\t */\n\tcreateLogger(id: string, options?: Omit<ILoggerOptions, 'id'>): ILogger;\n\n\t/**\n\t * Gets an existing logger, if any.\n\t */\n\tgetLogger(resourceOrId: URI | string): ILogger | undefined;\n\n\t/**\n\t * An event which fires when the log level of a logger has changed\n\t */\n\treadonly onDidChangeLogLevel: Event<LogLevel | [URI, LogLevel]>;\n\n\t/**\n\t * Set default log level.\n\t */\n\tsetLogLevel(level: LogLevel): void;\n\n\t/**\n\t * Set log level for a logger.\n\t */\n\tsetLogLevel(resource: URI, level: LogLevel): void;\n\n\t/**\n\t * Get log level for a logger or the default log level.\n\t */\n\tgetLogLevel(resource?: URI): LogLevel;\n\n\t/**\n\t * An event which fires when the visibility of a logger has changed\n\t */\n\treadonly onDidChangeVisibility: Event<[URI, boolean]>;\n\n\t/**\n\t * Set the visibility of a logger.\n\t */\n\tsetVisibility(resourceOrId: URI | string, visible: boolean): void;\n\n\t/**\n\t * An event which fires when the logger resources are changed\n\t */\n\treadonly onDidChangeLoggers: Event<DidChangeLoggersEvent>;\n\n\t/**\n\t * Register a logger with the logger service.\n\t *\n\t * Note that this will not create a logger, but only register it.\n\t *\n\t * Use `createLogger` to create a logger and register it.\n\t *\n\t * Use it when you want to register a logger that is not created by the logger service.\n\t */\n\tregisterLogger(resource: ILoggerResource): void;\n\n\t/**\n\t * Deregister the logger for the given resource.\n\t */\n\tderegisterLogger(idOrResource: URI | string): void;\n\n\t/**\n\t * Get all registered loggers\n\t */\n\tgetRegisteredLoggers(): Iterable<ILoggerResource>;\n\n\t/**\n\t * Get the registered logger for the given resource.\n\t */\n\tgetRegisteredLogger(resource: URI): ILoggerResource | undefined;\n}\n\nexport abstract class AbstractLogger extends Disposable implements ILogger {\n\n\tprivate level: LogLevel = DEFAULT_LOG_LEVEL;\n\tprivate readonly _onDidChangeLogLevel: Emitter<LogLevel> = this._register(new Emitter<LogLevel>());\n\tget onDidChangeLogLevel(): Event<LogLevel> { return this._onDidChangeLogLevel.event; }\n\n\tsetLevel(level: LogLevel): void {\n\t\tif (this.level !== level) {\n\t\t\tthis.level = level;\n\t\t\tthis._onDidChangeLogLevel.fire(this.level);\n\t\t}\n\t}\n\n\tgetLevel(): LogLevel {\n\t\treturn this.level;\n\t}\n\n\tprotected checkLogLevel(level: LogLevel): boolean {\n\t\treturn canLog(this.level, level);\n\t}\n\n\tprotected canLog(level: LogLevel): boolean {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.checkLogLevel(level);\n\t}\n\n\tabstract trace(message: string, ...args: unknown[]): void;\n\tabstract debug(message: string, ...args: unknown[]): void;\n\tabstract info(message: string, ...args: unknown[]): void;\n\tabstract warn(message: string, ...args: unknown[]): void;\n\tabstract error(message: string | Error, ...args: unknown[]): void;\n\tabstract flush(): void;\n}\n\nexport abstract class AbstractMessageLogger extends AbstractLogger implements ILogger {\n\n\tconstructor(private readonly logAlways?: boolean) {\n\t\tsuper();\n\t}\n\n\tprotected override checkLogLevel(level: LogLevel): boolean {\n\t\treturn this.logAlways || super.checkLogLevel(level);\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Trace)) {\n\t\t\tthis.log(LogLevel.Trace, format([message, ...args], true));\n\t\t}\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Debug)) {\n\t\t\tthis.log(LogLevel.Debug, format([message, ...args]));\n\t\t}\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Info)) {\n\t\t\tthis.log(LogLevel.Info, format([message, ...args]));\n\t\t}\n\t}\n\n\twarn(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Warning)) {\n\t\t\tthis.log(LogLevel.Warning, format([message, ...args]));\n\t\t}\n\t}\n\n\terror(message: string | Error, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Error)) {\n\t\t\tif (message instanceof Error) {\n\t\t\t\tconst array = Array.prototype.slice.call(arguments);\n\t\t\t\tarray[0] = message.stack;\n\t\t\t\tthis.log(LogLevel.Error, format(array));\n\t\t\t} else {\n\t\t\t\tthis.log(LogLevel.Error, format([message, ...args]));\n\t\t\t}\n\t\t}\n\t}\n\n\tflush(): void { }\n\n\tprotected abstract log(level: LogLevel, message: string): void;\n}\n\n\nexport class ConsoleMainLogger extends AbstractLogger implements ILogger {\n\n\tprivate useColors: boolean;\n\n\tconstructor(logLevel: LogLevel = DEFAULT_LOG_LEVEL) {\n\t\tsuper();\n\t\tthis.setLevel(logLevel);\n\t\tthis.useColors = !isWindows;\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Trace)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log(`\\x1b[90m[main ${now()}]\\x1b[0m`, message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(`[main ${now()}]`, message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Debug)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log(`\\x1b[90m[main ${now()}]\\x1b[0m`, message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(`[main ${now()}]`, message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Info)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log(`\\x1b[90m[main ${now()}]\\x1b[0m`, message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(`[main ${now()}]`, message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\twarn(message: string | Error, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Warning)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.warn(`\\x1b[93m[main ${now()}]\\x1b[0m`, message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.warn(`[main ${now()}]`, message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\terror(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Error)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.error(`\\x1b[91m[main ${now()}]\\x1b[0m`, message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.error(`[main ${now()}]`, message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\tflush(): void {\n\t\t// noop\n\t}\n\n}\n\nexport class ConsoleLogger extends AbstractLogger implements ILogger {\n\n\tconstructor(logLevel: LogLevel = DEFAULT_LOG_LEVEL, private readonly useColors: boolean = true) {\n\t\tsuper();\n\t\tthis.setLevel(logLevel);\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Trace)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log('%cTRACE', 'color: #888', message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Debug)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log('%cDEBUG', 'background: #eee; color: #888', message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Info)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.log('%c INFO', 'color: #33f', message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\twarn(message: string | Error, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Warning)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.warn('%c WARN', 'color: #993', message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.log(message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\terror(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Error)) {\n\t\t\tif (this.useColors) {\n\t\t\t\tconsole.error('%c  ERR', 'color: #f33', message, ...args);\n\t\t\t} else {\n\t\t\t\tconsole.error(message, ...args);\n\t\t\t}\n\t\t}\n\t}\n\n\n\tflush(): void {\n\t\t// noop\n\t}\n}\n\nexport class AdapterLogger extends AbstractLogger implements ILogger {\n\n\tconstructor(private readonly adapter: { log: (logLevel: LogLevel, args: any[]) => void }, logLevel: LogLevel = DEFAULT_LOG_LEVEL) {\n\t\tsuper();\n\t\tthis.setLevel(logLevel);\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Trace)) {\n\t\t\tthis.adapter.log(LogLevel.Trace, [this.extractMessage(message), ...args]);\n\t\t}\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Debug)) {\n\t\t\tthis.adapter.log(LogLevel.Debug, [this.extractMessage(message), ...args]);\n\t\t}\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Info)) {\n\t\t\tthis.adapter.log(LogLevel.Info, [this.extractMessage(message), ...args]);\n\t\t}\n\t}\n\n\twarn(message: string | Error, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Warning)) {\n\t\t\tthis.adapter.log(LogLevel.Warning, [this.extractMessage(message), ...args]);\n\t\t}\n\t}\n\n\terror(message: string | Error, ...args: unknown[]): void {\n\t\tif (this.canLog(LogLevel.Error)) {\n\t\t\tthis.adapter.log(LogLevel.Error, [this.extractMessage(message), ...args]);\n\t\t}\n\t}\n\n\tprivate extractMessage(msg: string | Error): string {\n\t\tif (typeof msg === 'string') {\n\t\t\treturn msg;\n\t\t}\n\n\t\treturn toErrorMessage(msg, this.canLog(LogLevel.Trace));\n\t}\n\n\tflush(): void {\n\t\t// noop\n\t}\n}\n\nexport class MultiplexLogger extends AbstractLogger implements ILogger {\n\n\tconstructor(private readonly loggers: ReadonlyArray<ILogger>) {\n\t\tsuper();\n\t\tif (loggers.length) {\n\t\t\tthis.setLevel(loggers[0].getLevel());\n\t\t}\n\t}\n\n\toverride setLevel(level: LogLevel): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.setLevel(level);\n\t\t}\n\t\tsuper.setLevel(level);\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.trace(message, ...args);\n\t\t}\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.debug(message, ...args);\n\t\t}\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.info(message, ...args);\n\t\t}\n\t}\n\n\twarn(message: string, ...args: unknown[]): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.warn(message, ...args);\n\t\t}\n\t}\n\n\terror(message: string | Error, ...args: unknown[]): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.error(message, ...args);\n\t\t}\n\t}\n\n\tflush(): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.flush();\n\t\t}\n\t}\n\n\toverride dispose(): void {\n\t\tfor (const logger of this.loggers) {\n\t\t\tlogger.dispose();\n\t\t}\n\t\tsuper.dispose();\n\t}\n}\n\ntype LoggerEntry = { logger: ILogger | undefined; info: Mutable<ILoggerResource> };\n\nexport abstract class AbstractLoggerService extends Disposable implements ILoggerService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _loggers = new ResourceMap<LoggerEntry>();\n\n\tprivate _onDidChangeLoggers = this._register(new Emitter<{ added: ILoggerResource[]; removed: ILoggerResource[] }>);\n\treadonly onDidChangeLoggers = this._onDidChangeLoggers.event;\n\n\tprivate _onDidChangeLogLevel = this._register(new Emitter<LogLevel | [URI, LogLevel]>);\n\treadonly onDidChangeLogLevel = this._onDidChangeLogLevel.event;\n\n\tprivate _onDidChangeVisibility = this._register(new Emitter<[URI, boolean]>);\n\treadonly onDidChangeVisibility = this._onDidChangeVisibility.event;\n\n\tconstructor(\n\t\tprotected logLevel: LogLevel,\n\t\tprivate readonly logsHome: URI,\n\t\tloggerResources?: Iterable<ILoggerResource>,\n\t) {\n\t\tsuper();\n\t\tif (loggerResources) {\n\t\t\tfor (const loggerResource of loggerResources) {\n\t\t\t\tthis._loggers.set(loggerResource.resource, { logger: undefined, info: loggerResource });\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate getLoggerEntry(resourceOrId: URI | string): LoggerEntry | undefined {\n\t\tif (isString(resourceOrId)) {\n\t\t\treturn [...this._loggers.values()].find(logger => logger.info.id === resourceOrId);\n\t\t}\n\t\treturn this._loggers.get(resourceOrId);\n\t}\n\n\tgetLogger(resourceOrId: URI | string): ILogger | undefined {\n\t\treturn this.getLoggerEntry(resourceOrId)?.logger;\n\t}\n\n\tcreateLogger(idOrResource: URI | string, options?: ILoggerOptions): ILogger {\n\t\tconst resource = this.toResource(idOrResource);\n\t\tconst id = isString(idOrResource) ? idOrResource : (options?.id ?? hash(resource.toString()).toString(16));\n\t\tlet logger = this._loggers.get(resource)?.logger;\n\t\tconst logLevel = options?.logLevel === 'always' ? LogLevel.Trace : options?.logLevel;\n\t\tif (!logger) {\n\t\t\tlogger = this.doCreateLogger(resource, logLevel ?? this.getLogLevel(resource) ?? this.logLevel, { ...options, id });\n\t\t}\n\t\tconst loggerEntry: LoggerEntry = {\n\t\t\tlogger,\n\t\t\tinfo: {\n\t\t\t\tresource,\n\t\t\t\tid,\n\t\t\t\tlogLevel,\n\t\t\t\tname: options?.name,\n\t\t\t\thidden: options?.hidden,\n\t\t\t\tgroup: options?.group,\n\t\t\t\textensionId: options?.extensionId,\n\t\t\t\twhen: options?.when\n\t\t\t}\n\t\t};\n\t\tthis.registerLogger(loggerEntry.info);\n\t\t// TODO: @sandy081 Remove this once registerLogger can take ILogger\n\t\tthis._loggers.set(resource, loggerEntry);\n\t\treturn logger;\n\t}\n\n\tprotected toResource(idOrResource: string | URI): URI {\n\t\treturn isString(idOrResource) ? joinPath(this.logsHome, `${idOrResource.replace(/[\\\\/:\\*\\?\"<>\\|]/g, '')}.log`) : idOrResource;\n\t}\n\n\tsetLogLevel(logLevel: LogLevel): void;\n\tsetLogLevel(resource: URI, logLevel: LogLevel): void;\n\tsetLogLevel(arg1: any, arg2?: any): void {\n\t\tif (URI.isUri(arg1)) {\n\t\t\tconst resource = arg1;\n\t\t\tconst logLevel = arg2;\n\t\t\tconst logger = this._loggers.get(resource);\n\t\t\tif (logger && logLevel !== logger.info.logLevel) {\n\t\t\t\tlogger.info.logLevel = logLevel === this.logLevel ? undefined : logLevel;\n\t\t\t\tlogger.logger?.setLevel(logLevel);\n\t\t\t\tthis._loggers.set(logger.info.resource, logger);\n\t\t\t\tthis._onDidChangeLogLevel.fire([resource, logLevel]);\n\t\t\t}\n\t\t} else {\n\t\t\tthis.logLevel = arg1;\n\t\t\tfor (const [resource, logger] of this._loggers.entries()) {\n\t\t\t\tif (this._loggers.get(resource)?.info.logLevel === undefined) {\n\t\t\t\t\tlogger.logger?.setLevel(this.logLevel);\n\t\t\t\t}\n\t\t\t}\n\t\t\tthis._onDidChangeLogLevel.fire(this.logLevel);\n\t\t}\n\t}\n\n\tsetVisibility(resourceOrId: URI | string, visibility: boolean): void {\n\t\tconst logger = this.getLoggerEntry(resourceOrId);\n\t\tif (logger && visibility !== !logger.info.hidden) {\n\t\t\tlogger.info.hidden = !visibility;\n\t\t\tthis._loggers.set(logger.info.resource, logger);\n\t\t\tthis._onDidChangeVisibility.fire([logger.info.resource, visibility]);\n\t\t}\n\t}\n\n\tgetLogLevel(resource?: URI): LogLevel {\n\t\tlet logLevel;\n\t\tif (resource) {\n\t\t\tlogLevel = this._loggers.get(resource)?.info.logLevel;\n\t\t}\n\t\treturn logLevel ?? this.logLevel;\n\t}\n\n\tregisterLogger(resource: ILoggerResource): void {\n\t\tconst existing = this._loggers.get(resource.resource);\n\t\tif (existing) {\n\t\t\tif (existing.info.hidden !== resource.hidden) {\n\t\t\t\tthis.setVisibility(resource.resource, !resource.hidden);\n\t\t\t}\n\t\t} else {\n\t\t\tthis._loggers.set(resource.resource, { info: resource, logger: undefined });\n\t\t\tthis._onDidChangeLoggers.fire({ added: [resource], removed: [] });\n\t\t}\n\t}\n\n\tderegisterLogger(idOrResource: URI | string): void {\n\t\tconst resource = this.toResource(idOrResource);\n\t\tconst existing = this._loggers.get(resource);\n\t\tif (existing) {\n\t\t\tif (existing.logger) {\n\t\t\t\texisting.logger.dispose();\n\t\t\t}\n\t\t\tthis._loggers.delete(resource);\n\t\t\tthis._onDidChangeLoggers.fire({ added: [], removed: [existing.info] });\n\t\t}\n\t}\n\n\t*getRegisteredLoggers(): Iterable<ILoggerResource> {\n\t\tfor (const entry of this._loggers.values()) {\n\t\t\tyield entry.info;\n\t\t}\n\t}\n\n\tgetRegisteredLogger(resource: URI): ILoggerResource | undefined {\n\t\treturn this._loggers.get(resource)?.info;\n\t}\n\n\toverride dispose(): void {\n\t\tthis._loggers.forEach(logger => logger.logger?.dispose());\n\t\tthis._loggers.clear();\n\t\tsuper.dispose();\n\t}\n\n\tprotected abstract doCreateLogger(resource: URI, logLevel: LogLevel, options?: ILoggerOptions): ILogger;\n}\n\nexport class NullLogger implements ILogger {\n\treadonly onDidChangeLogLevel: Event<LogLevel> = new Emitter<LogLevel>().event;\n\tsetLevel(level: LogLevel): void { }\n\tgetLevel(): LogLevel { return LogLevel.Info; }\n\ttrace(message: string, ...args: unknown[]): void { }\n\tdebug(message: string, ...args: unknown[]): void { }\n\tinfo(message: string, ...args: unknown[]): void { }\n\twarn(message: string, ...args: unknown[]): void { }\n\terror(message: string | Error, ...args: unknown[]): void { }\n\tcritical(message: string | Error, ...args: unknown[]): void { }\n\tdispose(): void { }\n\tflush(): void { }\n}\n\nexport class NullLogService extends NullLogger implements ILogService {\n\tdeclare readonly _serviceBrand: undefined;\n}\n\nexport class NullLoggerService extends AbstractLoggerService {\n\tconstructor() {\n\t\tsuper(LogLevel.Off, URI.parse('log:///log'));\n\t}\n\tprotected override doCreateLogger(resource: URI, logLevel: LogLevel, options?: ILoggerOptions): ILogger {\n\t\treturn new NullLogger();\n\t}\n}\n\nexport function getLogLevel(environmentService: IEnvironmentService): LogLevel {\n\tif (environmentService.verbose) {\n\t\treturn LogLevel.Trace;\n\t}\n\tif (typeof environmentService.logLevel === 'string') {\n\t\tconst logLevel = parseLogLevel(environmentService.logLevel.toLowerCase());\n\t\tif (logLevel !== undefined) {\n\t\t\treturn logLevel;\n\t\t}\n\t}\n\treturn DEFAULT_LOG_LEVEL;\n}\n\nexport function LogLevelToString(logLevel: LogLevel): string {\n\tswitch (logLevel) {\n\t\tcase LogLevel.Trace: return 'trace';\n\t\tcase LogLevel.Debug: return 'debug';\n\t\tcase LogLevel.Info: return 'info';\n\t\tcase LogLevel.Warning: return 'warn';\n\t\tcase LogLevel.Error: return 'error';\n\t\tcase LogLevel.Off: return 'off';\n\t}\n}\n\nexport function LogLevelToLocalizedString(logLevel: LogLevel): ILocalizedString {\n\tswitch (logLevel) {\n\t\tcase LogLevel.Trace: return { original: 'Trace', value: nls.localize('trace', \"Trace\") };\n\t\tcase LogLevel.Debug: return { original: 'Debug', value: nls.localize('debug', \"Debug\") };\n\t\tcase LogLevel.Info: return { original: 'Info', value: nls.localize('info', \"Info\") };\n\t\tcase LogLevel.Warning: return { original: 'Warning', value: nls.localize('warn', \"Warning\") };\n\t\tcase LogLevel.Error: return { original: 'Error', value: nls.localize('error', \"Error\") };\n\t\tcase LogLevel.Off: return { original: 'Off', value: nls.localize('off', \"Off\") };\n\t}\n}\n\nexport function parseLogLevel(logLevel: string): LogLevel | undefined {\n\tswitch (logLevel) {\n\t\tcase 'trace':\n\t\t\treturn LogLevel.Trace;\n\t\tcase 'debug':\n\t\t\treturn LogLevel.Debug;\n\t\tcase 'info':\n\t\t\treturn LogLevel.Info;\n\t\tcase 'warn':\n\t\t\treturn LogLevel.Warning;\n\t\tcase 'error':\n\t\t\treturn LogLevel.Error;\n\t\tcase 'critical':\n\t\t\treturn LogLevel.Error;\n\t\tcase 'off':\n\t\t\treturn LogLevel.Off;\n\t}\n\treturn undefined;\n}\n\n// Contexts\nexport const CONTEXT_LOG_LEVEL = new RawContextKey<string>('logLevel', LogLevelToString(LogLevel.Info));\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from '../../../base/common/uri.js';\nimport { Event } from '../../../base/common/event.js';\nimport { IChannel, IServerChannel } from '../../../base/parts/ipc/common/ipc.js';\nimport { AbstractLoggerService, AbstractMessageLogger, AdapterLogger, DidChangeLoggersEvent, ILogger, ILoggerOptions, ILoggerResource, ILoggerService, isLogLevel, LogLevel } from './log.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { IURITransformer } from '../../../base/common/uriIpc.js';\n\nexport class LoggerChannelClient extends AbstractLoggerService implements ILoggerService {\n\n\tconstructor(private readonly windowId: number | undefined, logLevel: LogLevel, logsHome: URI, loggers: ILoggerResource[], private readonly channel: IChannel) {\n\t\tsuper(logLevel, logsHome, loggers);\n\t\tthis._register(channel.listen<LogLevel | [URI, LogLevel]>('onDidChangeLogLevel', windowId)(arg => {\n\t\t\tif (isLogLevel(arg)) {\n\t\t\t\tsuper.setLogLevel(arg);\n\t\t\t} else {\n\t\t\t\tsuper.setLogLevel(URI.revive(arg[0]), arg[1]);\n\t\t\t}\n\t\t}));\n\t\tthis._register(channel.listen<[URI, boolean]>('onDidChangeVisibility', windowId)(([resource, visibility]) => super.setVisibility(URI.revive(resource), visibility)));\n\t\tthis._register(channel.listen<DidChangeLoggersEvent>('onDidChangeLoggers', windowId)(({ added, removed }) => {\n\t\t\tfor (const loggerResource of added) {\n\t\t\t\tsuper.registerLogger({ ...loggerResource, resource: URI.revive(loggerResource.resource) });\n\t\t\t}\n\t\t\tfor (const loggerResource of removed) {\n\t\t\t\tsuper.deregisterLogger(loggerResource.resource);\n\t\t\t}\n\t\t}));\n\t}\n\n\tcreateConsoleMainLogger(): ILogger {\n\t\treturn new AdapterLogger({\n\t\t\tlog: (level: LogLevel, args: any[]) => {\n\t\t\t\tthis.channel.call('consoleLog', [level, args]);\n\t\t\t}\n\t\t});\n\t}\n\n\toverride registerLogger(logger: ILoggerResource): void {\n\t\tsuper.registerLogger(logger);\n\t\tthis.channel.call('registerLogger', [logger, this.windowId]);\n\t}\n\n\toverride deregisterLogger(resource: URI): void {\n\t\tsuper.deregisterLogger(resource);\n\t\tthis.channel.call('deregisterLogger', [resource, this.windowId]);\n\t}\n\n\toverride setLogLevel(logLevel: LogLevel): void;\n\toverride setLogLevel(resource: URI, logLevel: LogLevel): void;\n\toverride setLogLevel(arg1: any, arg2?: any): void {\n\t\tsuper.setLogLevel(arg1, arg2);\n\t\tthis.channel.call('setLogLevel', [arg1, arg2]);\n\t}\n\n\toverride setVisibility(resourceOrId: URI | string, visibility: boolean): void {\n\t\tsuper.setVisibility(resourceOrId, visibility);\n\t\tthis.channel.call('setVisibility', [this.toResource(resourceOrId), visibility]);\n\t}\n\n\tprotected doCreateLogger(file: URI, logLevel: LogLevel, options?: ILoggerOptions): ILogger {\n\t\treturn new Logger(this.channel, file, logLevel, options, this.windowId);\n\t}\n\n\tpublic static setLogLevel(channel: IChannel, level: LogLevel): Promise<void>;\n\tpublic static setLogLevel(channel: IChannel, resource: URI, level: LogLevel): Promise<void>;\n\tpublic static setLogLevel(channel: IChannel, arg1: any, arg2?: any): Promise<void> {\n\t\treturn channel.call('setLogLevel', [arg1, arg2]);\n\t}\n\n}\n\nclass Logger extends AbstractMessageLogger {\n\n\tprivate isLoggerCreated: boolean = false;\n\tprivate buffer: [LogLevel, string][] = [];\n\n\tconstructor(\n\t\tprivate readonly channel: IChannel,\n\t\tprivate readonly file: URI,\n\t\tlogLevel: LogLevel,\n\t\tloggerOptions?: ILoggerOptions,\n\t\twindowId?: number | undefined\n\t) {\n\t\tsuper(loggerOptions?.logLevel === 'always');\n\t\tthis.setLevel(logLevel);\n\t\tthis.channel.call('createLogger', [file, loggerOptions, windowId])\n\t\t\t.then(() => {\n\t\t\t\tthis.doLog(this.buffer);\n\t\t\t\tthis.isLoggerCreated = true;\n\t\t\t});\n\t}\n\n\tprotected log(level: LogLevel, message: string) {\n\t\tconst messages: [LogLevel, string][] = [[level, message]];\n\t\tif (this.isLoggerCreated) {\n\t\t\tthis.doLog(messages);\n\t\t} else {\n\t\t\tthis.buffer.push(...messages);\n\t\t}\n\t}\n\n\tprivate doLog(messages: [LogLevel, string][]) {\n\t\tthis.channel.call('log', [this.file, messages]);\n\t}\n}\n\nexport class LoggerChannel implements IServerChannel {\n\n\tconstructor(private readonly loggerService: ILoggerService, private getUriTransformer: (requestContext: any) => IURITransformer) { }\n\n\tlisten(context: any, event: string): Event<any> {\n\t\tconst uriTransformer = this.getUriTransformer(context);\n\t\tswitch (event) {\n\t\t\tcase 'onDidChangeLoggers': return Event.map<DidChangeLoggersEvent, DidChangeLoggersEvent>(this.loggerService.onDidChangeLoggers, (e) =>\n\t\t\t({\n\t\t\t\tadded: [...e.added].map(logger => this.transformLogger(logger, uriTransformer)),\n\t\t\t\tremoved: [...e.removed].map(logger => this.transformLogger(logger, uriTransformer)),\n\t\t\t}));\n\t\t\tcase 'onDidChangeVisibility': return Event.map<[URI, boolean], [URI, boolean]>(this.loggerService.onDidChangeVisibility, e => [uriTransformer.transformOutgoingURI(e[0]), e[1]]);\n\t\t\tcase 'onDidChangeLogLevel': return Event.map<LogLevel | [URI, LogLevel], LogLevel | [URI, LogLevel]>(this.loggerService.onDidChangeLogLevel, e => isLogLevel(e) ? e : [uriTransformer.transformOutgoingURI(e[0]), e[1]]);\n\t\t}\n\t\tthrow new Error(`Event not found: ${event}`);\n\t}\n\n\tasync call(context: any, command: string, arg?: any): Promise<any> {\n\t\tconst uriTransformer: IURITransformer | null = this.getUriTransformer(context);\n\t\tswitch (command) {\n\t\t\tcase 'setLogLevel': return isLogLevel(arg[0]) ? this.loggerService.setLogLevel(arg[0]) : this.loggerService.setLogLevel(URI.revive(uriTransformer.transformIncoming(arg[0][0])), arg[0][1]);\n\t\t\tcase 'getRegisteredLoggers': return Promise.resolve([...this.loggerService.getRegisteredLoggers()].map(logger => this.transformLogger(logger, uriTransformer)));\n\t\t}\n\n\t\tthrow new Error(`Call not found: ${command}`);\n\t}\n\n\tprivate transformLogger(logger: ILoggerResource, transformer: IURITransformer): ILoggerResource {\n\t\treturn {\n\t\t\t...logger,\n\t\t\tresource: transformer.transformOutgoingURI(logger.resource)\n\t\t};\n\t}\n\n}\n\nexport class RemoteLoggerChannelClient extends Disposable {\n\n\tconstructor(loggerService: ILoggerService, channel: IChannel) {\n\t\tsuper();\n\n\t\tchannel.call('setLogLevel', [loggerService.getLogLevel()]);\n\t\tthis._register(loggerService.onDidChangeLogLevel(arg => channel.call('setLogLevel', [arg])));\n\n\t\tchannel.call<ILoggerResource[]>('getRegisteredLoggers').then(loggers => {\n\t\t\tfor (const loggerResource of loggers) {\n\t\t\t\tloggerService.registerLogger({ ...loggerResource, resource: URI.revive(loggerResource.resource) });\n\t\t\t}\n\t\t});\n\n\t\tthis._register(channel.listen<[URI, boolean]>('onDidChangeVisibility')(([resource, visibility]) => loggerService.setVisibility(URI.revive(resource), visibility)));\n\n\t\tthis._register(channel.listen<DidChangeLoggersEvent>('onDidChangeLoggers')(({ added, removed }) => {\n\t\t\tfor (const loggerResource of added) {\n\t\t\t\tloggerService.registerLogger({ ...loggerResource, resource: URI.revive(loggerResource.resource) });\n\t\t\t}\n\t\t\tfor (const loggerResource of removed) {\n\t\t\t\tloggerService.deregisterLogger(loggerResource.resource);\n\t\t\t}\n\t\t}));\n\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { Event } from '../../../base/common/event.js';\nimport { ILogger, ILogService, LogLevel, MultiplexLogger } from './log.js';\n\nexport class LogService extends Disposable implements ILogService {\n\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly logger: ILogger;\n\n\tconstructor(primaryLogger: ILogger, otherLoggers: ILogger[] = []) {\n\t\tsuper();\n\t\tthis.logger = new MultiplexLogger([primaryLogger, ...otherLoggers]);\n\t\tthis._register(primaryLogger.onDidChangeLogLevel(level => this.setLevel(level)));\n\t}\n\n\tget onDidChangeLogLevel(): Event<LogLevel> {\n\t\treturn this.logger.onDidChangeLogLevel;\n\t}\n\n\tsetLevel(level: LogLevel): void {\n\t\tthis.logger.setLevel(level);\n\t}\n\n\tgetLevel(): LogLevel {\n\t\treturn this.logger.getLevel();\n\t}\n\n\ttrace(message: string, ...args: unknown[]): void {\n\t\tthis.logger.trace(message, ...args);\n\t}\n\n\tdebug(message: string, ...args: unknown[]): void {\n\t\tthis.logger.debug(message, ...args);\n\t}\n\n\tinfo(message: string, ...args: unknown[]): void {\n\t\tthis.logger.info(message, ...args);\n\t}\n\n\twarn(message: string, ...args: unknown[]): void {\n\t\tthis.logger.warn(message, ...args);\n\t}\n\n\terror(message: string | Error, ...args: unknown[]): void {\n\t\tthis.logger.error(message, ...args);\n\t}\n\n\tflush(): void {\n\t\tthis.logger.flush();\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\n\nconst _UUIDPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;\n\nexport function isUUID(value: string): boolean {\n\treturn _UUIDPattern.test(value);\n}\n\nexport const generateUuid = (function (): () => string {\n\n\t// use `randomUUID` if possible\n\tif (typeof crypto.randomUUID === 'function') {\n\t\t// see https://developer.mozilla.org/en-US/docs/Web/API/Window/crypto\n\t\t// > Although crypto is available on all windows, the returned Crypto object only has one\n\t\t// > usable feature in insecure contexts: the getRandomValues() method.\n\t\t// > In general, you should use this API only in secure contexts.\n\n\t\treturn crypto.randomUUID.bind(crypto);\n\t}\n\n\t// prep-work\n\tconst _data = new Uint8Array(16);\n\tconst _hex: string[] = [];\n\tfor (let i = 0; i < 256; i++) {\n\t\t_hex.push(i.toString(16).padStart(2, '0'));\n\t}\n\n\treturn function generateUuid(): string {\n\t\t// get data\n\t\tcrypto.getRandomValues(_data);\n\n\t\t// set version bits\n\t\t_data[6] = (_data[6] & 0x0f) | 0x40;\n\t\t_data[8] = (_data[8] & 0x3f) | 0x80;\n\n\t\t// print as string\n\t\tlet i = 0;\n\t\tlet result = '';\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += '-';\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += '-';\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += '-';\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += '-';\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\tresult += _hex[_data[i++]];\n\t\treturn result;\n\t};\n})();\n\n/** Namespace should be 3 letter. */\nexport function prefixedUuid(namespace: string): string {\n\treturn `${namespace}-${generateUuid()}`;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { shuffle } from './arrays.js';\nimport { assert } from './assert.js';\nimport { CharCode } from './charCode.js';\nimport { compare, compareIgnoreCase, compareSubstring, compareSubstringIgnoreCase } from './strings.js';\nimport { URI } from './uri.js';\n\nexport interface IKeyIterator<K> {\n\treset(key: K): this;\n\tnext(): this;\n\n\thasNext(): boolean;\n\tcmp(a: string): number;\n\tvalue(): string;\n}\n\nexport class StringIterator implements IKeyIterator<string> {\n\n\tprivate _value: string = '';\n\tprivate _pos: number = 0;\n\n\treset(key: string): this {\n\t\tthis._value = key;\n\t\tthis._pos = 0;\n\t\treturn this;\n\t}\n\n\tnext(): this {\n\t\tthis._pos += 1;\n\t\treturn this;\n\t}\n\n\thasNext(): boolean {\n\t\treturn this._pos < this._value.length - 1;\n\t}\n\n\tcmp(a: string): number {\n\t\tconst aCode = a.charCodeAt(0);\n\t\tconst thisCode = this._value.charCodeAt(this._pos);\n\t\treturn aCode - thisCode;\n\t}\n\n\tvalue(): string {\n\t\treturn this._value[this._pos];\n\t}\n}\n\nexport class ConfigKeysIterator implements IKeyIterator<string> {\n\n\tprivate _value!: string;\n\tprivate _from!: number;\n\tprivate _to!: number;\n\n\tconstructor(\n\t\tprivate readonly _caseSensitive: boolean = true\n\t) { }\n\n\treset(key: string): this {\n\t\tthis._value = key;\n\t\tthis._from = 0;\n\t\tthis._to = 0;\n\t\treturn this.next();\n\t}\n\n\thasNext(): boolean {\n\t\treturn this._to < this._value.length;\n\t}\n\n\tnext(): this {\n\t\t// this._data = key.split(/[\\\\/]/).filter(s => !!s);\n\t\tthis._from = this._to;\n\t\tlet justSeps = true;\n\t\tfor (; this._to < this._value.length; this._to++) {\n\t\t\tconst ch = this._value.charCodeAt(this._to);\n\t\t\tif (ch === CharCode.Period) {\n\t\t\t\tif (justSeps) {\n\t\t\t\t\tthis._from++;\n\t\t\t\t} else {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tjustSeps = false;\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\tcmp(a: string): number {\n\t\treturn this._caseSensitive\n\t\t\t? compareSubstring(a, this._value, 0, a.length, this._from, this._to)\n\t\t\t: compareSubstringIgnoreCase(a, this._value, 0, a.length, this._from, this._to);\n\t}\n\n\tvalue(): string {\n\t\treturn this._value.substring(this._from, this._to);\n\t}\n}\n\nexport class PathIterator implements IKeyIterator<string> {\n\n\tprivate _value!: string;\n\tprivate _valueLen!: number;\n\tprivate _from!: number;\n\tprivate _to!: number;\n\n\tconstructor(\n\t\tprivate readonly _splitOnBackslash: boolean = true,\n\t\tprivate readonly _caseSensitive: boolean = true\n\t) { }\n\n\treset(key: string): this {\n\t\tthis._from = 0;\n\t\tthis._to = 0;\n\t\tthis._value = key;\n\t\tthis._valueLen = key.length;\n\t\tfor (let pos = key.length - 1; pos >= 0; pos--, this._valueLen--) {\n\t\t\tconst ch = this._value.charCodeAt(pos);\n\t\t\tif (!(ch === CharCode.Slash || this._splitOnBackslash && ch === CharCode.Backslash)) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\treturn this.next();\n\t}\n\n\thasNext(): boolean {\n\t\treturn this._to < this._valueLen;\n\t}\n\n\tnext(): this {\n\t\t// this._data = key.split(/[\\\\/]/).filter(s => !!s);\n\t\tthis._from = this._to;\n\t\tlet justSeps = true;\n\t\tfor (; this._to < this._valueLen; this._to++) {\n\t\t\tconst ch = this._value.charCodeAt(this._to);\n\t\t\tif (ch === CharCode.Slash || this._splitOnBackslash && ch === CharCode.Backslash) {\n\t\t\t\tif (justSeps) {\n\t\t\t\t\tthis._from++;\n\t\t\t\t} else {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tjustSeps = false;\n\t\t\t}\n\t\t}\n\t\treturn this;\n\t}\n\n\tcmp(a: string): number {\n\t\treturn this._caseSensitive\n\t\t\t? compareSubstring(a, this._value, 0, a.length, this._from, this._to)\n\t\t\t: compareSubstringIgnoreCase(a, this._value, 0, a.length, this._from, this._to);\n\t}\n\n\tvalue(): string {\n\t\treturn this._value.substring(this._from, this._to);\n\t}\n}\n\nconst enum UriIteratorState {\n\tScheme = 1, Authority = 2, Path = 3, Query = 4, Fragment = 5\n}\n\nexport class UriIterator implements IKeyIterator<URI> {\n\n\tprivate _pathIterator!: PathIterator;\n\tprivate _value!: URI;\n\tprivate _states: UriIteratorState[] = [];\n\tprivate _stateIdx: number = 0;\n\n\tconstructor(\n\t\tprivate readonly _ignorePathCasing: (uri: URI) => boolean,\n\t\tprivate readonly _ignoreQueryAndFragment: (uri: URI) => boolean) { }\n\n\treset(key: URI): this {\n\t\tthis._value = key;\n\t\tthis._states = [];\n\t\tif (this._value.scheme) {\n\t\t\tthis._states.push(UriIteratorState.Scheme);\n\t\t}\n\t\tif (this._value.authority) {\n\t\t\tthis._states.push(UriIteratorState.Authority);\n\t\t}\n\t\tif (this._value.path) {\n\t\t\tthis._pathIterator = new PathIterator(false, !this._ignorePathCasing(key));\n\t\t\tthis._pathIterator.reset(key.path);\n\t\t\tif (this._pathIterator.value()) {\n\t\t\t\tthis._states.push(UriIteratorState.Path);\n\t\t\t}\n\t\t}\n\t\tif (!this._ignoreQueryAndFragment(key)) {\n\t\t\tif (this._value.query) {\n\t\t\t\tthis._states.push(UriIteratorState.Query);\n\t\t\t}\n\t\t\tif (this._value.fragment) {\n\t\t\t\tthis._states.push(UriIteratorState.Fragment);\n\t\t\t}\n\t\t}\n\t\tthis._stateIdx = 0;\n\t\treturn this;\n\t}\n\n\tnext(): this {\n\t\tif (this._states[this._stateIdx] === UriIteratorState.Path && this._pathIterator.hasNext()) {\n\t\t\tthis._pathIterator.next();\n\t\t} else {\n\t\t\tthis._stateIdx += 1;\n\t\t}\n\t\treturn this;\n\t}\n\n\thasNext(): boolean {\n\t\treturn (this._states[this._stateIdx] === UriIteratorState.Path && this._pathIterator.hasNext())\n\t\t\t|| this._stateIdx < this._states.length - 1;\n\t}\n\n\tcmp(a: string): number {\n\t\tif (this._states[this._stateIdx] === UriIteratorState.Scheme) {\n\t\t\treturn compareIgnoreCase(a, this._value.scheme);\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Authority) {\n\t\t\treturn compareIgnoreCase(a, this._value.authority);\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Path) {\n\t\t\treturn this._pathIterator.cmp(a);\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Query) {\n\t\t\treturn compare(a, this._value.query);\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Fragment) {\n\t\t\treturn compare(a, this._value.fragment);\n\t\t}\n\t\tthrow new Error();\n\t}\n\n\tvalue(): string {\n\t\tif (this._states[this._stateIdx] === UriIteratorState.Scheme) {\n\t\t\treturn this._value.scheme;\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Authority) {\n\t\t\treturn this._value.authority;\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Path) {\n\t\t\treturn this._pathIterator.value();\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Query) {\n\t\t\treturn this._value.query;\n\t\t} else if (this._states[this._stateIdx] === UriIteratorState.Fragment) {\n\t\t\treturn this._value.fragment;\n\t\t}\n\t\tthrow new Error();\n\t}\n}\n\nabstract class Undef {\n\n\tstatic readonly Val: unique symbol = Symbol('undefined_placeholder');\n\n\tstatic wrap<V>(value: V | undefined): V | typeof Undef.Val {\n\t\treturn value === undefined ? Undef.Val : value;\n\t}\n\n\tstatic unwrap<V>(value: V | typeof Undef.Val): V | undefined {\n\t\treturn value === Undef.Val ? undefined : value;\n\t}\n}\n\nclass TernarySearchTreeNode<K, V> {\n\theight: number = 1;\n\tsegment!: string;\n\tvalue: V | typeof Undef.Val | undefined = undefined;\n\tkey: K | undefined = undefined;\n\tleft: TernarySearchTreeNode<K, V> | undefined = undefined;\n\tmid: TernarySearchTreeNode<K, V> | undefined = undefined;\n\tright: TernarySearchTreeNode<K, V> | undefined = undefined;\n\n\tisEmpty(): boolean {\n\t\treturn !this.left && !this.mid && !this.right && this.value === undefined;\n\t}\n\n\trotateLeft() {\n\t\tconst tmp = this.right!;\n\t\tthis.right = tmp.left;\n\t\ttmp.left = this;\n\t\tthis.updateHeight();\n\t\ttmp.updateHeight();\n\t\treturn tmp;\n\t}\n\n\trotateRight() {\n\t\tconst tmp = this.left!;\n\t\tthis.left = tmp.right;\n\t\ttmp.right = this;\n\t\tthis.updateHeight();\n\t\ttmp.updateHeight();\n\t\treturn tmp;\n\t}\n\n\tupdateHeight() {\n\t\tthis.height = 1 + Math.max(this.heightLeft, this.heightRight);\n\t}\n\n\tbalanceFactor() {\n\t\treturn this.heightRight - this.heightLeft;\n\t}\n\n\tget heightLeft() {\n\t\treturn this.left?.height ?? 0;\n\t}\n\n\tget heightRight() {\n\t\treturn this.right?.height ?? 0;\n\t}\n}\n\nconst enum Dir {\n\tLeft = -1,\n\tMid = 0,\n\tRight = 1\n}\n\nexport class TernarySearchTree<K, V> {\n\n\tstatic forUris<E>(ignorePathCasing: (key: URI) => boolean = () => false, ignoreQueryAndFragment: (key: URI) => boolean = () => false): TernarySearchTree<URI, E> {\n\t\treturn new TernarySearchTree<URI, E>(new UriIterator(ignorePathCasing, ignoreQueryAndFragment));\n\t}\n\n\tstatic forPaths<E>(ignorePathCasing = false): TernarySearchTree<string, E> {\n\t\treturn new TernarySearchTree<string, E>(new PathIterator(undefined, !ignorePathCasing));\n\t}\n\n\tstatic forStrings<E>(): TernarySearchTree<string, E> {\n\t\treturn new TernarySearchTree<string, E>(new StringIterator());\n\t}\n\n\tstatic forConfigKeys<E>(): TernarySearchTree<string, E> {\n\t\treturn new TernarySearchTree<string, E>(new ConfigKeysIterator());\n\t}\n\n\tprivate _iter: IKeyIterator<K>;\n\tprivate _root: TernarySearchTreeNode<K, V> | undefined;\n\n\tconstructor(segments: IKeyIterator<K>) {\n\t\tthis._iter = segments;\n\t}\n\n\tclear(): void {\n\t\tthis._root = undefined;\n\t}\n\n\t/**\n\t * Fill the tree with the same value of the given keys\n\t */\n\tfill(element: V, keys: readonly K[]): void;\n\t/**\n\t * Fill the tree with given [key,value]-tuples\n\t */\n\tfill(values: readonly [K, V][]): void;\n\tfill(values: readonly [K, V][] | V, keys?: readonly K[]): void {\n\t\tif (keys) {\n\t\t\tconst arr = keys.slice(0);\n\t\t\tshuffle(arr);\n\t\t\tfor (const k of arr) {\n\t\t\t\tthis.set(k, (<V>values));\n\t\t\t}\n\t\t} else {\n\t\t\tconst arr = (<[K, V][]>values).slice(0);\n\t\t\tshuffle(arr);\n\t\t\tfor (const entry of arr) {\n\t\t\t\tthis.set(entry[0], entry[1]);\n\t\t\t}\n\t\t}\n\t}\n\n\tset(key: K, element: V): V | undefined {\n\t\tconst iter = this._iter.reset(key);\n\t\tlet node: TernarySearchTreeNode<K, V>;\n\n\t\tif (!this._root) {\n\t\t\tthis._root = new TernarySearchTreeNode<K, V>();\n\t\t\tthis._root.segment = iter.value();\n\t\t}\n\t\tconst stack: [Dir, TernarySearchTreeNode<K, V>][] = [];\n\n\t\t// find insert_node\n\t\tnode = this._root;\n\t\twhile (true) {\n\t\t\tconst val = iter.cmp(node.segment);\n\t\t\tif (val > 0) {\n\t\t\t\t// left\n\t\t\t\tif (!node.left) {\n\t\t\t\t\tnode.left = new TernarySearchTreeNode<K, V>();\n\t\t\t\t\tnode.left.segment = iter.value();\n\t\t\t\t}\n\t\t\t\tstack.push([Dir.Left, node]);\n\t\t\t\tnode = node.left;\n\n\t\t\t} else if (val < 0) {\n\t\t\t\t// right\n\t\t\t\tif (!node.right) {\n\t\t\t\t\tnode.right = new TernarySearchTreeNode<K, V>();\n\t\t\t\t\tnode.right.segment = iter.value();\n\t\t\t\t}\n\t\t\t\tstack.push([Dir.Right, node]);\n\t\t\t\tnode = node.right;\n\n\t\t\t} else if (iter.hasNext()) {\n\t\t\t\t// mid\n\t\t\t\titer.next();\n\t\t\t\tif (!node.mid) {\n\t\t\t\t\tnode.mid = new TernarySearchTreeNode<K, V>();\n\t\t\t\t\tnode.mid.segment = iter.value();\n\t\t\t\t}\n\t\t\t\tstack.push([Dir.Mid, node]);\n\t\t\t\tnode = node.mid;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// set value\n\t\tconst oldElement = Undef.unwrap(node.value);\n\t\tnode.value = Undef.wrap(element);\n\t\tnode.key = key;\n\n\t\t// balance\n\t\tfor (let i = stack.length - 1; i >= 0; i--) {\n\t\t\tconst node = stack[i][1];\n\n\t\t\tnode.updateHeight();\n\t\t\tconst bf = node.balanceFactor();\n\n\t\t\tif (bf < -1 || bf > 1) {\n\t\t\t\t// needs rotate\n\t\t\t\tconst d1 = stack[i][0];\n\t\t\t\tconst d2 = stack[i + 1][0];\n\n\t\t\t\tif (d1 === Dir.Right && d2 === Dir.Right) {\n\t\t\t\t\t//right, right -> rotate left\n\t\t\t\t\tstack[i][1] = node.rotateLeft();\n\n\t\t\t\t} else if (d1 === Dir.Left && d2 === Dir.Left) {\n\t\t\t\t\t// left, left -> rotate right\n\t\t\t\t\tstack[i][1] = node.rotateRight();\n\n\t\t\t\t} else if (d1 === Dir.Right && d2 === Dir.Left) {\n\t\t\t\t\t// right, left -> double rotate right, left\n\t\t\t\t\tnode.right = stack[i + 1][1] = stack[i + 1][1].rotateRight();\n\t\t\t\t\tstack[i][1] = node.rotateLeft();\n\n\t\t\t\t} else if (d1 === Dir.Left && d2 === Dir.Right) {\n\t\t\t\t\t// left, right -> double rotate left, right\n\t\t\t\t\tnode.left = stack[i + 1][1] = stack[i + 1][1].rotateLeft();\n\t\t\t\t\tstack[i][1] = node.rotateRight();\n\n\t\t\t\t} else {\n\t\t\t\t\tthrow new Error();\n\t\t\t\t}\n\n\t\t\t\t// patch path to parent\n\t\t\t\tif (i > 0) {\n\t\t\t\t\tswitch (stack[i - 1][0]) {\n\t\t\t\t\t\tcase Dir.Left:\n\t\t\t\t\t\t\tstack[i - 1][1].left = stack[i][1];\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase Dir.Right:\n\t\t\t\t\t\t\tstack[i - 1][1].right = stack[i][1];\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase Dir.Mid:\n\t\t\t\t\t\t\tstack[i - 1][1].mid = stack[i][1];\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis._root = stack[0][1];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn oldElement;\n\t}\n\n\tget(key: K): V | undefined {\n\t\treturn Undef.unwrap(this._getNode(key)?.value);\n\t}\n\n\tprivate _getNode(key: K) {\n\t\tconst iter = this._iter.reset(key);\n\t\tlet node = this._root;\n\t\twhile (node) {\n\t\t\tconst val = iter.cmp(node.segment);\n\t\t\tif (val > 0) {\n\t\t\t\t// left\n\t\t\t\tnode = node.left;\n\t\t\t} else if (val < 0) {\n\t\t\t\t// right\n\t\t\t\tnode = node.right;\n\t\t\t} else if (iter.hasNext()) {\n\t\t\t\t// mid\n\t\t\t\titer.next();\n\t\t\t\tnode = node.mid;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn node;\n\t}\n\n\thas(key: K): boolean {\n\t\tconst node = this._getNode(key);\n\t\treturn !(node?.value === undefined && node?.mid === undefined);\n\t}\n\n\tdelete(key: K): void {\n\t\treturn this._delete(key, false);\n\t}\n\n\tdeleteSuperstr(key: K): void {\n\t\treturn this._delete(key, true);\n\t}\n\n\tprivate _delete(key: K, superStr: boolean): void {\n\t\tconst iter = this._iter.reset(key);\n\t\tconst stack: [Dir, TernarySearchTreeNode<K, V>][] = [];\n\t\tlet node = this._root;\n\n\t\t// find node\n\t\twhile (node) {\n\t\t\tconst val = iter.cmp(node.segment);\n\t\t\tif (val > 0) {\n\t\t\t\t// left\n\t\t\t\tstack.push([Dir.Left, node]);\n\t\t\t\tnode = node.left;\n\t\t\t} else if (val < 0) {\n\t\t\t\t// right\n\t\t\t\tstack.push([Dir.Right, node]);\n\t\t\t\tnode = node.right;\n\t\t\t} else if (iter.hasNext()) {\n\t\t\t\t// mid\n\t\t\t\titer.next();\n\t\t\t\tstack.push([Dir.Mid, node]);\n\t\t\t\tnode = node.mid;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (!node) {\n\t\t\t// node not found\n\t\t\treturn;\n\t\t}\n\n\t\tif (superStr) {\n\t\t\t// removing children, reset height\n\t\t\tnode.left = undefined;\n\t\t\tnode.mid = undefined;\n\t\t\tnode.right = undefined;\n\t\t\tnode.height = 1;\n\t\t} else {\n\t\t\t// removing element\n\t\t\tnode.key = undefined;\n\t\t\tnode.value = undefined;\n\t\t}\n\n\t\t// BST node removal\n\t\tif (!node.mid && !node.value) {\n\t\t\tif (node.left && node.right) {\n\t\t\t\t// full node\n\t\t\t\t// replace deleted-node with the min-node of the right branch.\n\t\t\t\t// If there is no true min-node leave things as they are\n\t\t\t\tconst stack2: typeof stack = [[Dir.Right, node]];\n\t\t\t\tconst min = this._min(node.right, stack2);\n\n\t\t\t\tif (min.key) {\n\n\t\t\t\t\tnode.key = min.key;\n\t\t\t\t\tnode.value = min.value;\n\t\t\t\t\tnode.segment = min.segment;\n\n\t\t\t\t\t// remove NODE (inorder successor can only have right child)\n\t\t\t\t\tconst newChild = min.right;\n\t\t\t\t\tif (stack2.length > 1) {\n\t\t\t\t\t\tconst [dir, parent] = stack2[stack2.length - 1];\n\t\t\t\t\t\tswitch (dir) {\n\t\t\t\t\t\t\tcase Dir.Left: parent.left = newChild; break;\n\t\t\t\t\t\t\tcase Dir.Mid: assert(false);\n\t\t\t\t\t\t\tcase Dir.Right: assert(false);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tnode.right = newChild;\n\t\t\t\t\t}\n\n\t\t\t\t\t// balance right branch and UPDATE parent pointer for stack\n\t\t\t\t\tconst newChild2 = this._balanceByStack(stack2)!;\n\t\t\t\t\tif (stack.length > 0) {\n\t\t\t\t\t\tconst [dir, parent] = stack[stack.length - 1];\n\t\t\t\t\t\tswitch (dir) {\n\t\t\t\t\t\t\tcase Dir.Left: parent.left = newChild2; break;\n\t\t\t\t\t\t\tcase Dir.Mid: parent.mid = newChild2; break;\n\t\t\t\t\t\t\tcase Dir.Right: parent.right = newChild2; break;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._root = newChild2;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t} else {\n\t\t\t\t// empty or half empty\n\t\t\t\tconst newChild = node.left ?? node.right;\n\t\t\t\tif (stack.length > 0) {\n\t\t\t\t\tconst [dir, parent] = stack[stack.length - 1];\n\t\t\t\t\tswitch (dir) {\n\t\t\t\t\t\tcase Dir.Left: parent.left = newChild; break;\n\t\t\t\t\t\tcase Dir.Mid: parent.mid = newChild; break;\n\t\t\t\t\t\tcase Dir.Right: parent.right = newChild; break;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tthis._root = newChild;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// AVL balance\n\t\tthis._root = this._balanceByStack(stack) ?? this._root;\n\t}\n\n\tprivate _min(node: TernarySearchTreeNode<K, V>, stack: [Dir, TernarySearchTreeNode<K, V>][]): TernarySearchTreeNode<K, V> {\n\t\twhile (node.left) {\n\t\t\tstack.push([Dir.Left, node]);\n\t\t\tnode = node.left;\n\t\t}\n\t\treturn node;\n\t}\n\n\tprivate _balanceByStack(stack: [Dir, TernarySearchTreeNode<K, V>][]) {\n\n\t\tfor (let i = stack.length - 1; i >= 0; i--) {\n\t\t\tconst node = stack[i][1];\n\n\t\t\tnode.updateHeight();\n\t\t\tconst bf = node.balanceFactor();\n\t\t\tif (bf > 1) {\n\t\t\t\t// right heavy\n\t\t\t\tif (node.right!.balanceFactor() >= 0) {\n\t\t\t\t\t// right, right -> rotate left\n\t\t\t\t\tstack[i][1] = node.rotateLeft();\n\t\t\t\t} else {\n\t\t\t\t\t// right, left -> double rotate\n\t\t\t\t\tnode.right = node.right!.rotateRight();\n\t\t\t\t\tstack[i][1] = node.rotateLeft();\n\t\t\t\t}\n\n\t\t\t} else if (bf < -1) {\n\t\t\t\t// left heavy\n\t\t\t\tif (node.left!.balanceFactor() <= 0) {\n\t\t\t\t\t// left, left -> rotate right\n\t\t\t\t\tstack[i][1] = node.rotateRight();\n\t\t\t\t} else {\n\t\t\t\t\t// left, right -> double rotate\n\t\t\t\t\tnode.left = node.left!.rotateLeft();\n\t\t\t\t\tstack[i][1] = node.rotateRight();\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// patch path to parent\n\t\t\tif (i > 0) {\n\t\t\t\tswitch (stack[i - 1][0]) {\n\t\t\t\t\tcase Dir.Left:\n\t\t\t\t\t\tstack[i - 1][1].left = stack[i][1];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase Dir.Right:\n\t\t\t\t\t\tstack[i - 1][1].right = stack[i][1];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase Dir.Mid:\n\t\t\t\t\t\tstack[i - 1][1].mid = stack[i][1];\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\treturn stack[0][1];\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tfindSubstr(key: K): V | undefined {\n\t\tconst iter = this._iter.reset(key);\n\t\tlet node = this._root;\n\t\tlet candidate: V | undefined = undefined;\n\t\twhile (node) {\n\t\t\tconst val = iter.cmp(node.segment);\n\t\t\tif (val > 0) {\n\t\t\t\t// left\n\t\t\t\tnode = node.left;\n\t\t\t} else if (val < 0) {\n\t\t\t\t// right\n\t\t\t\tnode = node.right;\n\t\t\t} else if (iter.hasNext()) {\n\t\t\t\t// mid\n\t\t\t\titer.next();\n\t\t\t\tcandidate = Undef.unwrap(node.value) || candidate;\n\t\t\t\tnode = node.mid;\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn node && Undef.unwrap(node.value) || candidate;\n\t}\n\n\tfindSuperstr(key: K): IterableIterator<[K, V]> | undefined {\n\t\treturn this._findSuperstrOrElement(key, false);\n\t}\n\n\tprivate _findSuperstrOrElement(key: K, allowValue: true): IterableIterator<[K, V]> | V | undefined;\n\tprivate _findSuperstrOrElement(key: K, allowValue: false): IterableIterator<[K, V]> | undefined;\n\tprivate _findSuperstrOrElement(key: K, allowValue: boolean): IterableIterator<[K, V]> | V | undefined {\n\t\tconst iter = this._iter.reset(key);\n\t\tlet node = this._root;\n\t\twhile (node) {\n\t\t\tconst val = iter.cmp(node.segment);\n\t\t\tif (val > 0) {\n\t\t\t\t// left\n\t\t\t\tnode = node.left;\n\t\t\t} else if (val < 0) {\n\t\t\t\t// right\n\t\t\t\tnode = node.right;\n\t\t\t} else if (iter.hasNext()) {\n\t\t\t\t// mid\n\t\t\t\titer.next();\n\t\t\t\tnode = node.mid;\n\t\t\t} else {\n\t\t\t\t// collect\n\t\t\t\tif (!node.mid) {\n\t\t\t\t\tif (allowValue) {\n\t\t\t\t\t\treturn Undef.unwrap(node.value);\n\t\t\t\t\t} else {\n\t\t\t\t\t\treturn undefined;\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\treturn this._entries(node.mid);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\thasElementOrSubtree(key: K): boolean {\n\t\treturn this._findSuperstrOrElement(key, true) !== undefined;\n\t}\n\n\tforEach(callback: (value: V, index: K) => unknown): void {\n\t\tfor (const [key, value] of this) {\n\t\t\tcallback(value, key);\n\t\t}\n\t}\n\n\t*[Symbol.iterator](): IterableIterator<[K, V]> {\n\t\tyield* this._entries(this._root);\n\t}\n\n\tprivate _entries(node: TernarySearchTreeNode<K, V> | undefined): IterableIterator<[K, V]> {\n\t\tconst result: [K, V][] = [];\n\t\tthis._dfsEntries(node, result);\n\t\treturn result[Symbol.iterator]();\n\t}\n\n\tprivate _dfsEntries(node: TernarySearchTreeNode<K, V> | undefined, bucket: [K, V][]) {\n\t\t// DFS\n\t\tif (!node) {\n\t\t\treturn;\n\t\t}\n\t\tif (node.left) {\n\t\t\tthis._dfsEntries(node.left, bucket);\n\t\t}\n\t\tif (node.value !== undefined) {\n\t\t\tbucket.push([node.key!, Undef.unwrap(node.value)!]);\n\t\t}\n\t\tif (node.mid) {\n\t\t\tthis._dfsEntries(node.mid, bucket);\n\t\t}\n\t\tif (node.right) {\n\t\t\tthis._dfsEntries(node.right, bucket);\n\t\t}\n\t}\n\n\t// for debug/testing\n\t_isBalanced(): boolean {\n\t\tconst nodeIsBalanced = (node: TernarySearchTreeNode<unknown, unknown> | undefined): boolean => {\n\t\t\tif (!node) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tconst bf = node.balanceFactor();\n\t\t\tif (bf < -1 || bf > 1) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn nodeIsBalanced(node.left) && nodeIsBalanced(node.right);\n\t\t};\n\t\treturn nodeIsBalanced(this._root);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { VSBuffer, VSBufferReadable, VSBufferReadableStream } from '../../../base/common/buffer.js';\nimport { CancellationToken } from '../../../base/common/cancellation.js';\nimport { Event } from '../../../base/common/event.js';\nimport { IExpression, IRelativePattern } from '../../../base/common/glob.js';\nimport { IDisposable } from '../../../base/common/lifecycle.js';\nimport { TernarySearchTree } from '../../../base/common/ternarySearchTree.js';\nimport { sep } from '../../../base/common/path.js';\nimport { ReadableStreamEvents } from '../../../base/common/stream.js';\nimport { startsWithIgnoreCase } from '../../../base/common/strings.js';\nimport { isNumber } from '../../../base/common/types.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { localize } from '../../../nls.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\nimport { isWeb } from '../../../base/common/platform.js';\nimport { Schemas } from '../../../base/common/network.js';\nimport { IMarkdownString } from '../../../base/common/htmlContent.js';\nimport { Lazy } from '../../../base/common/lazy.js';\n\n//#region file service & providers\n\nexport const IFileService = createDecorator<IFileService>('fileService');\n\nexport interface IFileService {\n\n\treadonly _serviceBrand: undefined;\n\n\t/**\n\t * An event that is fired when a file system provider is added or removed\n\t */\n\treadonly onDidChangeFileSystemProviderRegistrations: Event<IFileSystemProviderRegistrationEvent>;\n\n\t/**\n\t * An event that is fired when a registered file system provider changes its capabilities.\n\t */\n\treadonly onDidChangeFileSystemProviderCapabilities: Event<IFileSystemProviderCapabilitiesChangeEvent>;\n\n\t/**\n\t * An event that is fired when a file system provider is about to be activated. Listeners\n\t * can join this event with a long running promise to help in the activation process.\n\t */\n\treadonly onWillActivateFileSystemProvider: Event<IFileSystemProviderActivationEvent>;\n\n\t/**\n\t * Registers a file system provider for a certain scheme.\n\t */\n\tregisterProvider(scheme: string, provider: IFileSystemProvider): IDisposable;\n\n\t/**\n\t * Returns a file system provider for a certain scheme.\n\t */\n\tgetProvider(scheme: string): IFileSystemProvider | undefined;\n\n\t/**\n\t * Tries to activate a provider with the given scheme.\n\t */\n\tactivateProvider(scheme: string): Promise<void>;\n\n\t/**\n\t * Checks if this file service can handle the given resource by\n\t * first activating any extension that wants to be activated\n\t * on the provided resource scheme to include extensions that\n\t * contribute file system providers for the given resource.\n\t */\n\tcanHandleResource(resource: URI): Promise<boolean>;\n\n\t/**\n\t * Checks if the file service has a registered provider for the\n\t * provided resource.\n\t *\n\t * Note: this does NOT account for contributed providers from\n\t * extensions that have not been activated yet. To include those,\n\t * consider to call `await fileService.canHandleResource(resource)`.\n\t */\n\thasProvider(resource: URI): boolean;\n\n\t/**\n\t * Checks if the provider for the provided resource has the provided file system capability.\n\t */\n\thasCapability(resource: URI, capability: FileSystemProviderCapabilities): boolean;\n\n\t/**\n\t * List the schemes and capabilities for registered file system providers\n\t */\n\tlistCapabilities(): Iterable<{ scheme: string; capabilities: FileSystemProviderCapabilities }>;\n\n\t/**\n\t * Allows to listen for file changes. The event will fire for every file within the opened workspace\n\t * (if any) as well as all files that have been watched explicitly using the #watch() API.\n\t */\n\treadonly onDidFilesChange: Event<FileChangesEvent>;\n\n\t/**\n\t * An event that is fired upon successful completion of a certain file operation.\n\t */\n\treadonly onDidRunOperation: Event<FileOperationEvent>;\n\n\t/**\n\t * Resolve the properties of a file/folder identified by the resource. For a folder, children\n\t * information is resolved as well depending on the provided options. Use `stat()` method if\n\t * you do not need children information.\n\t *\n\t * If the optional parameter \"resolveTo\" is specified in options, the stat service is asked\n\t * to provide a stat object that should contain the full graph of folders up to all of the\n\t * target resources.\n\t *\n\t * If the optional parameter \"resolveSingleChildDescendants\" is specified in options,\n\t * the stat service is asked to automatically resolve child folders that only\n\t * contain a single element.\n\t *\n\t * If the optional parameter \"resolveMetadata\" is specified in options,\n\t * the stat will contain metadata information such as size, mtime and etag.\n\t */\n\tresolve(resource: URI, options: IResolveMetadataFileOptions): Promise<IFileStatWithMetadata>;\n\tresolve(resource: URI, options?: IResolveFileOptions): Promise<IFileStat>;\n\n\t/**\n\t * Same as `resolve()` but supports resolving multiple resources in parallel.\n\t *\n\t * If one of the resolve targets fails to resolve returns a fake `IFileStat` instead of\n\t * making the whole call fail.\n\t */\n\tresolveAll(toResolve: { resource: URI; options: IResolveMetadataFileOptions }[]): Promise<IFileStatResult[]>;\n\tresolveAll(toResolve: { resource: URI; options?: IResolveFileOptions }[]): Promise<IFileStatResult[]>;\n\n\t/**\n\t * Same as `resolve()` but without resolving the children of a folder if the\n\t * resource is pointing to a folder.\n\t */\n\tstat(resource: URI): Promise<IFileStatWithPartialMetadata>;\n\n\t/**\n\t * Attempts to resolve the real path of the provided resource. The real path can be\n\t * different from the resource path for example when it is a symlink.\n\t *\n\t * Will return `undefined` if the real path cannot be resolved.\n\t */\n\trealpath(resource: URI): Promise<URI | undefined>;\n\n\t/**\n\t * Finds out if a file/folder identified by the resource exists.\n\t */\n\texists(resource: URI): Promise<boolean>;\n\n\t/**\n\t * Read the contents of the provided resource unbuffered.\n\t */\n\treadFile(resource: URI, options?: IReadFileOptions, token?: CancellationToken): Promise<IFileContent>;\n\n\t/**\n\t * Read the contents of the provided resource buffered as stream.\n\t */\n\treadFileStream(resource: URI, options?: IReadFileStreamOptions, token?: CancellationToken): Promise<IFileStreamContent>;\n\n\t/**\n\t * Updates the content replacing its previous value.\n\t *\n\t * Emits a `FileOperation.WRITE` file operation event when successful.\n\t */\n\twriteFile(resource: URI, bufferOrReadableOrStream: VSBuffer | VSBufferReadable | VSBufferReadableStream, options?: IWriteFileOptions): Promise<IFileStatWithMetadata>;\n\n\t/**\n\t * Moves the file/folder to a new path identified by the resource.\n\t *\n\t * The optional parameter overwrite can be set to replace an existing file at the location.\n\t *\n\t * Emits a `FileOperation.MOVE` file operation event when successful.\n\t */\n\tmove(source: URI, target: URI, overwrite?: boolean): Promise<IFileStatWithMetadata>;\n\n\t/**\n\t * Find out if a move operation is possible given the arguments. No changes on disk will\n\t * be performed. Returns an Error if the operation cannot be done.\n\t */\n\tcanMove(source: URI, target: URI, overwrite?: boolean): Promise<Error | true>;\n\n\t/**\n\t * Copies the file/folder to a path identified by the resource. A folder is copied\n\t * recursively.\n\t *\n\t * Emits a `FileOperation.COPY` file operation event when successful.\n\t */\n\tcopy(source: URI, target: URI, overwrite?: boolean): Promise<IFileStatWithMetadata>;\n\n\t/**\n\t * Find out if a copy operation is possible given the arguments. No changes on disk will\n\t * be performed. Returns an Error if the operation cannot be done.\n\t */\n\tcanCopy(source: URI, target: URI, overwrite?: boolean): Promise<Error | true>;\n\n\t/**\n\t * Clones a file to a path identified by the resource. Folders are not supported.\n\t *\n\t * If the target path exists, it will be overwritten.\n\t */\n\tcloneFile(source: URI, target: URI): Promise<void>;\n\n\t/**\n\t * Creates a new file with the given path and optional contents. The returned promise\n\t * will have the stat model object as a result.\n\t *\n\t * The optional parameter content can be used as value to fill into the new file.\n\t *\n\t * Emits a `FileOperation.CREATE` file operation event when successful.\n\t */\n\tcreateFile(resource: URI, bufferOrReadableOrStream?: VSBuffer | VSBufferReadable | VSBufferReadableStream, options?: ICreateFileOptions): Promise<IFileStatWithMetadata>;\n\n\t/**\n\t * Find out if a file create operation is possible given the arguments. No changes on disk will\n\t * be performed. Returns an Error if the operation cannot be done.\n\t */\n\tcanCreateFile(resource: URI, options?: ICreateFileOptions): Promise<Error | true>;\n\n\t/**\n\t * Creates a new folder with the given path. The returned promise\n\t * will have the stat model object as a result.\n\t *\n\t * Emits a `FileOperation.CREATE` file operation event when successful.\n\t */\n\tcreateFolder(resource: URI): Promise<IFileStatWithMetadata>;\n\n\t/**\n\t * Deletes the provided file. The optional useTrash parameter allows to\n\t * move the file to trash. The optional recursive parameter allows to delete\n\t * non-empty folders recursively.\n\t *\n\t * Emits a `FileOperation.DELETE` file operation event when successful.\n\t */\n\tdel(resource: URI, options?: Partial<IFileDeleteOptions>): Promise<void>;\n\n\t/**\n\t * Find out if a delete operation is possible given the arguments. No changes on disk will\n\t * be performed. Returns an Error if the operation cannot be done.\n\t */\n\tcanDelete(resource: URI, options?: Partial<IFileDeleteOptions>): Promise<Error | true>;\n\n\t/**\n\t * An event that signals an error when watching for file changes.\n\t */\n\treadonly onDidWatchError: Event<Error>;\n\n\t/**\n\t * Allows to start a watcher that reports file/folder change events on the provided resource.\n\t *\n\t * The watcher runs correlated and thus, file events will be reported on the returned\n\t * `IFileSystemWatcher` and not on the generic `IFileService.onDidFilesChange` event.\n\t *\n\t * Note: only non-recursive file watching supports event correlation for now.\n\t */\n\tcreateWatcher(resource: URI, options: IWatchOptionsWithoutCorrelation & { recursive: false }): IFileSystemWatcher;\n\n\t/**\n\t * Allows to start a watcher that reports file/folder change events on the provided resource.\n\t *\n\t * The watcher runs uncorrelated and thus will report all events from `IFileService.onDidFilesChange`.\n\t * This means, most listeners in the application will receive your events. It is encouraged to\n\t * use correlated watchers (via `IWatchOptionsWithCorrelation`) to limit events to your listener.\n\t*/\n\twatch(resource: URI, options?: IWatchOptionsWithoutCorrelation): IDisposable;\n\n\t/**\n\t * Frees up any resources occupied by this service.\n\t */\n\tdispose(): void;\n}\n\nexport interface IFileOverwriteOptions {\n\n\t/**\n\t * Set to `true` to overwrite a file if it exists. Will\n\t * throw an error otherwise if the file does exist.\n\t */\n\treadonly overwrite: boolean;\n}\n\nexport interface IFileUnlockOptions {\n\n\t/**\n\t * Set to `true` to try to remove any write locks the file might\n\t * have. A file that is write locked will throw an error for any\n\t * attempt to write to unless `unlock: true` is provided.\n\t */\n\treadonly unlock: boolean;\n}\n\nexport interface IFileAtomicReadOptions {\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `readFile` method is not running in parallel with\n\t * any `write` operations in the same process.\n\t *\n\t * Typically you should not need to use this flag but if\n\t * for example you are quickly reading a file right after\n\t * a file event occurred and the file changes a lot, there\n\t * is a chance that a read returns an empty or partial file\n\t * because a pending write has not finished yet.\n\t *\n\t * Note: this does not prevent the file from being written\n\t * to from a different process. If you need such atomic\n\t * operations, you better use a real database as storage.\n\t */\n\treadonly atomic: boolean;\n}\n\nexport interface IFileAtomicOptions {\n\n\t/**\n\t * The postfix is used to create a temporary file based\n\t * on the original resource. The resulting temporary\n\t * file will be in the same folder as the resource and\n\t * have `postfix` appended to the resource name.\n\t *\n\t * Example: given a file resource `file:///some/path/foo.txt`\n\t * and a postfix `.vsctmp`, the temporary file will be\n\t * created as `file:///some/path/foo.txt.vsctmp`.\n\t */\n\treadonly postfix: string;\n}\n\nexport interface IFileAtomicWriteOptions {\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `writeFile` method updates the target file atomically\n\t * by first writing to a temporary file in the same folder\n\t * and then renaming it over the target.\n\t */\n\treadonly atomic: IFileAtomicOptions | false;\n}\n\nexport interface IFileAtomicDeleteOptions {\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `delete` method deletes the target atomically by\n\t * first renaming it to a temporary resource in the same\n\t * folder and then deleting it.\n\t */\n\treadonly atomic: IFileAtomicOptions | false;\n}\n\nexport interface IFileReadLimits {\n\n\t/**\n\t * If the file exceeds the given size, an error of kind\n\t * `FILE_TOO_LARGE` will be thrown.\n\t */\n\tsize?: number;\n}\n\nexport interface IFileReadStreamOptions {\n\n\t/**\n\t * Is an integer specifying where to begin reading from in the file. If position is undefined,\n\t * data will be read from the current file position.\n\t */\n\treadonly position?: number;\n\n\t/**\n\t * Is an integer specifying how many bytes to read from the file. By default, all bytes\n\t * will be read.\n\t */\n\treadonly length?: number;\n\n\t/**\n\t * If provided, the size of the file will be checked against the limits\n\t * and an error will be thrown if any limit is exceeded.\n\t */\n\treadonly limits?: IFileReadLimits;\n}\n\nexport interface IFileWriteOptions extends IFileOverwriteOptions, IFileUnlockOptions, IFileAtomicWriteOptions {\n\n\t/**\n\t * Set to `true` to create a file when it does not exist. Will\n\t * throw an error otherwise if the file does not exist.\n\t */\n\treadonly create: boolean;\n}\n\nexport type IFileOpenOptions = IFileOpenForReadOptions | IFileOpenForWriteOptions;\n\nexport function isFileOpenForWriteOptions(options: IFileOpenOptions): options is IFileOpenForWriteOptions {\n\treturn options.create === true;\n}\n\nexport interface IFileOpenForReadOptions {\n\n\t/**\n\t * A hint that the file should be opened for reading only.\n\t */\n\treadonly create: false;\n}\n\nexport interface IFileOpenForWriteOptions extends IFileUnlockOptions {\n\n\t/**\n\t * A hint that the file should be opened for reading and writing.\n\t */\n\treadonly create: true;\n}\n\nexport interface IFileDeleteOptions {\n\n\t/**\n\t * Set to `true` to recursively delete any children of the file. This\n\t * only applies to folders and can lead to an error unless provided\n\t * if the folder is not empty.\n\t */\n\treadonly recursive: boolean;\n\n\t/**\n\t * Set to `true` to attempt to move the file to trash\n\t * instead of deleting it permanently from disk.\n\t *\n\t * This option maybe not be supported on all providers.\n\t */\n\treadonly useTrash: boolean;\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `delete` method deletes the target atomically by\n\t * first renaming it to a temporary resource in the same\n\t * folder and then deleting it.\n\t *\n\t * This option maybe not be supported on all providers.\n\t */\n\treadonly atomic: IFileAtomicOptions | false;\n}\n\nexport enum FileType {\n\n\t/**\n\t * File is unknown (neither file, directory nor symbolic link).\n\t */\n\tUnknown = 0,\n\n\t/**\n\t * File is a normal file.\n\t */\n\tFile = 1,\n\n\t/**\n\t * File is a directory.\n\t */\n\tDirectory = 2,\n\n\t/**\n\t * File is a symbolic link.\n\t *\n\t * Note: even when the file is a symbolic link, you can test for\n\t * `FileType.File` and `FileType.Directory` to know the type of\n\t * the target the link points to.\n\t */\n\tSymbolicLink = 64\n}\n\nexport enum FilePermission {\n\n\t/**\n\t * File is readonly. Components like editors should not\n\t * offer to edit the contents.\n\t */\n\tReadonly = 1,\n\n\t/**\n\t * File is locked. Components like editors should offer\n\t * to edit the contents and ask the user upon saving to\n\t * remove the lock.\n\t */\n\tLocked = 2\n}\n\nexport interface IStat {\n\n\t/**\n\t * The file type.\n\t */\n\treadonly type: FileType;\n\n\t/**\n\t * The last modification date represented as millis from unix epoch.\n\t */\n\treadonly mtime: number;\n\n\t/**\n\t * The creation date represented as millis from unix epoch.\n\t */\n\treadonly ctime: number;\n\n\t/**\n\t * The size of the file in bytes.\n\t */\n\treadonly size: number;\n\n\t/**\n\t * The file permissions.\n\t */\n\treadonly permissions?: FilePermission;\n}\n\nexport interface IWatchOptionsWithoutCorrelation {\n\n\t/**\n\t * Set to `true` to watch for changes recursively in a folder\n\t * and all of its children.\n\t */\n\trecursive: boolean;\n\n\t/**\n\t * A set of glob patterns or paths to exclude from watching.\n\t * Paths can be relative or absolute and when relative are\n\t * resolved against the watched folder. Glob patterns are\n\t * always matched relative to the watched folder.\n\t */\n\texcludes: string[];\n\n\t/**\n\t * An optional set of glob patterns or paths to include for\n\t * watching. If not provided, all paths are considered for\n\t * events.\n\t * Paths can be relative or absolute and when relative are\n\t * resolved against the watched folder. Glob patterns are\n\t * always matched relative to the watched folder.\n\t */\n\tincludes?: Array<string | IRelativePattern>;\n\n\t/**\n\t * If provided, allows to filter the events that the watcher should consider\n\t * for emitting. If not provided, all events are emitted.\n\t *\n\t * For example, to emit added and updated events, set to:\n\t * `FileChangeFilter.ADDED | FileChangeFilter.UPDATED`.\n\t */\n\tfilter?: FileChangeFilter;\n}\n\nexport interface IWatchOptions extends IWatchOptionsWithoutCorrelation {\n\n\t/**\n\t * If provided, file change events from the watcher that\n\t * are a result of this watch request will carry the same\n\t * id.\n\t */\n\treadonly correlationId?: number;\n}\n\nexport const enum FileChangeFilter {\n\tUPDATED = 1 << 1,\n\tADDED = 1 << 2,\n\tDELETED = 1 << 3\n}\n\nexport interface IWatchOptionsWithCorrelation extends IWatchOptions {\n\treadonly correlationId: number;\n}\n\nexport interface IFileSystemWatcher extends IDisposable {\n\n\t/**\n\t * An event which fires on file/folder change only for changes\n\t * that correlate to the watch request with matching correlation\n\t * identifier.\n\t */\n\treadonly onDidChange: Event<FileChangesEvent>;\n}\n\nexport function isFileSystemWatcher(thing: unknown): thing is IFileSystemWatcher {\n\tconst candidate = thing as IFileSystemWatcher | undefined;\n\n\treturn !!candidate && typeof candidate.onDidChange === 'function';\n}\n\nexport const enum FileSystemProviderCapabilities {\n\n\t/**\n\t * No capabilities.\n\t */\n\tNone = 0,\n\n\t/**\n\t * Provider supports unbuffered read/write.\n\t */\n\tFileReadWrite = 1 << 1,\n\n\t/**\n\t * Provider supports open/read/write/close low level file operations.\n\t */\n\tFileOpenReadWriteClose = 1 << 2,\n\n\t/**\n\t * Provider supports stream based reading.\n\t */\n\tFileReadStream = 1 << 4,\n\n\t/**\n\t * Provider supports copy operation.\n\t */\n\tFileFolderCopy = 1 << 3,\n\n\t/**\n\t * Provider is path case sensitive.\n\t */\n\tPathCaseSensitive = 1 << 10,\n\n\t/**\n\t * All files of the provider are readonly.\n\t */\n\tReadonly = 1 << 11,\n\n\t/**\n\t * Provider supports to delete via trash.\n\t */\n\tTrash = 1 << 12,\n\n\t/**\n\t * Provider support to unlock files for writing.\n\t */\n\tFileWriteUnlock = 1 << 13,\n\n\t/**\n\t * Provider support to read files atomically. This implies the\n\t * provider provides the `FileReadWrite` capability too.\n\t */\n\tFileAtomicRead = 1 << 14,\n\n\t/**\n\t * Provider support to write files atomically. This implies the\n\t * provider provides the `FileReadWrite` capability too.\n\t */\n\tFileAtomicWrite = 1 << 15,\n\n\t/**\n\t * Provider support to delete atomically.\n\t */\n\tFileAtomicDelete = 1 << 16,\n\n\t/**\n\t * Provider support to clone files atomically.\n\t */\n\tFileClone = 1 << 17,\n\n\t/**\n\t * Provider support to resolve real paths.\n\t */\n\tFileRealpath = 1 << 18\n}\n\nexport interface IFileSystemProvider {\n\n\treadonly capabilities: FileSystemProviderCapabilities;\n\treadonly onDidChangeCapabilities: Event<void>;\n\n\treadonly onDidChangeFile: Event<readonly IFileChange[]>;\n\treadonly onDidWatchError?: Event<string>;\n\twatch(resource: URI, opts: IWatchOptions): IDisposable;\n\n\tstat(resource: URI): Promise<IStat>;\n\tmkdir(resource: URI): Promise<void>;\n\treaddir(resource: URI): Promise<[string, FileType][]>;\n\tdelete(resource: URI, opts: IFileDeleteOptions): Promise<void>;\n\n\trename(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void>;\n\tcopy?(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void>;\n\n\treadFile?(resource: URI): Promise<Uint8Array>;\n\twriteFile?(resource: URI, content: Uint8Array, opts: IFileWriteOptions): Promise<void>;\n\n\treadFileStream?(resource: URI, opts: IFileReadStreamOptions, token: CancellationToken): ReadableStreamEvents<Uint8Array>;\n\n\topen?(resource: URI, opts: IFileOpenOptions): Promise<number>;\n\tclose?(fd: number): Promise<void>;\n\tread?(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number>;\n\twrite?(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number>;\n\n\tcloneFile?(from: URI, to: URI): Promise<void>;\n}\n\nexport interface IFileSystemProviderWithFileReadWriteCapability extends IFileSystemProvider {\n\treadFile(resource: URI): Promise<Uint8Array>;\n\twriteFile(resource: URI, content: Uint8Array, opts: IFileWriteOptions): Promise<void>;\n}\n\nexport function hasReadWriteCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileReadWriteCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileReadWrite);\n}\n\nexport interface IFileSystemProviderWithFileFolderCopyCapability extends IFileSystemProvider {\n\tcopy(from: URI, to: URI, opts: IFileOverwriteOptions): Promise<void>;\n}\n\nexport function hasFileFolderCopyCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileFolderCopyCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileFolderCopy);\n}\n\nexport interface IFileSystemProviderWithFileCloneCapability extends IFileSystemProvider {\n\tcloneFile(from: URI, to: URI): Promise<void>;\n}\n\nexport function hasFileCloneCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileCloneCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileClone);\n}\n\nexport interface IFileSystemProviderWithFileRealpathCapability extends IFileSystemProvider {\n\trealpath(resource: URI): Promise<string>;\n}\n\nexport function hasFileRealpathCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileRealpathCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileRealpath);\n}\n\nexport interface IFileSystemProviderWithOpenReadWriteCloseCapability extends IFileSystemProvider {\n\topen(resource: URI, opts: IFileOpenOptions): Promise<number>;\n\tclose(fd: number): Promise<void>;\n\tread(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number>;\n\twrite(fd: number, pos: number, data: Uint8Array, offset: number, length: number): Promise<number>;\n}\n\nexport function hasOpenReadWriteCloseCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithOpenReadWriteCloseCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileOpenReadWriteClose);\n}\n\nexport interface IFileSystemProviderWithFileReadStreamCapability extends IFileSystemProvider {\n\treadFileStream(resource: URI, opts: IFileReadStreamOptions, token: CancellationToken): ReadableStreamEvents<Uint8Array>;\n}\n\nexport function hasFileReadStreamCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileReadStreamCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileReadStream);\n}\n\nexport interface IFileSystemProviderWithFileAtomicReadCapability extends IFileSystemProvider {\n\treadFile(resource: URI, opts?: IFileAtomicReadOptions): Promise<Uint8Array>;\n\tenforceAtomicReadFile?(resource: URI): boolean;\n}\n\nexport function hasFileAtomicReadCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileAtomicReadCapability {\n\tif (!hasReadWriteCapability(provider)) {\n\t\treturn false; // we require the `FileReadWrite` capability too\n\t}\n\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileAtomicRead);\n}\n\nexport interface IFileSystemProviderWithFileAtomicWriteCapability extends IFileSystemProvider {\n\twriteFile(resource: URI, contents: Uint8Array, opts?: IFileAtomicWriteOptions): Promise<void>;\n\tenforceAtomicWriteFile?(resource: URI): IFileAtomicOptions | false;\n}\n\nexport function hasFileAtomicWriteCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileAtomicWriteCapability {\n\tif (!hasReadWriteCapability(provider)) {\n\t\treturn false; // we require the `FileReadWrite` capability too\n\t}\n\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileAtomicWrite);\n}\n\nexport interface IFileSystemProviderWithFileAtomicDeleteCapability extends IFileSystemProvider {\n\tdelete(resource: URI, opts: IFileAtomicDeleteOptions): Promise<void>;\n\tenforceAtomicDelete?(resource: URI): IFileAtomicOptions | false;\n}\n\nexport function hasFileAtomicDeleteCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithFileAtomicDeleteCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.FileAtomicDelete);\n}\n\nexport interface IFileSystemProviderWithReadonlyCapability extends IFileSystemProvider {\n\n\treadonly capabilities: FileSystemProviderCapabilities.Readonly & FileSystemProviderCapabilities;\n\n\t/**\n\t * An optional message to show in the UI to explain why the file system is readonly.\n\t */\n\treadonly readOnlyMessage?: IMarkdownString;\n}\n\nexport function hasReadonlyCapability(provider: IFileSystemProvider): provider is IFileSystemProviderWithReadonlyCapability {\n\treturn !!(provider.capabilities & FileSystemProviderCapabilities.Readonly);\n}\n\nexport enum FileSystemProviderErrorCode {\n\tFileExists = 'EntryExists',\n\tFileNotFound = 'EntryNotFound',\n\tFileNotADirectory = 'EntryNotADirectory',\n\tFileIsADirectory = 'EntryIsADirectory',\n\tFileExceedsStorageQuota = 'EntryExceedsStorageQuota',\n\tFileTooLarge = 'EntryTooLarge',\n\tFileWriteLocked = 'EntryWriteLocked',\n\tNoPermissions = 'NoPermissions',\n\tUnavailable = 'Unavailable',\n\tUnknown = 'Unknown'\n}\n\nexport interface IFileSystemProviderError extends Error {\n\treadonly name: string;\n\treadonly code: FileSystemProviderErrorCode;\n}\n\nexport class FileSystemProviderError extends Error implements IFileSystemProviderError {\n\n\tstatic create(error: Error | string, code: FileSystemProviderErrorCode): FileSystemProviderError {\n\t\tconst providerError = new FileSystemProviderError(error.toString(), code);\n\t\tmarkAsFileSystemProviderError(providerError, code);\n\n\t\treturn providerError;\n\t}\n\n\tprivate constructor(message: string, readonly code: FileSystemProviderErrorCode) {\n\t\tsuper(message);\n\t}\n}\n\nexport function createFileSystemProviderError(error: Error | string, code: FileSystemProviderErrorCode): FileSystemProviderError {\n\treturn FileSystemProviderError.create(error, code);\n}\n\nexport function ensureFileSystemProviderError(error?: Error): Error {\n\tif (!error) {\n\t\treturn createFileSystemProviderError(localize('unknownError', \"Unknown Error\"), FileSystemProviderErrorCode.Unknown); // https://github.com/microsoft/vscode/issues/72798\n\t}\n\n\treturn error;\n}\n\nexport function markAsFileSystemProviderError(error: Error, code: FileSystemProviderErrorCode): Error {\n\terror.name = code ? `${code} (FileSystemError)` : `FileSystemError`;\n\n\treturn error;\n}\n\nexport function toFileSystemProviderErrorCode(error: Error | undefined | null): FileSystemProviderErrorCode {\n\n\t// Guard against abuse\n\tif (!error) {\n\t\treturn FileSystemProviderErrorCode.Unknown;\n\t}\n\n\t// FileSystemProviderError comes with the code\n\tif (error instanceof FileSystemProviderError) {\n\t\treturn error.code;\n\t}\n\n\t// Any other error, check for name match by assuming that the error\n\t// went through the markAsFileSystemProviderError() method\n\tconst match = /^(.+) \\(FileSystemError\\)$/.exec(error.name);\n\tif (!match) {\n\t\treturn FileSystemProviderErrorCode.Unknown;\n\t}\n\n\tswitch (match[1]) {\n\t\tcase FileSystemProviderErrorCode.FileExists: return FileSystemProviderErrorCode.FileExists;\n\t\tcase FileSystemProviderErrorCode.FileIsADirectory: return FileSystemProviderErrorCode.FileIsADirectory;\n\t\tcase FileSystemProviderErrorCode.FileNotADirectory: return FileSystemProviderErrorCode.FileNotADirectory;\n\t\tcase FileSystemProviderErrorCode.FileNotFound: return FileSystemProviderErrorCode.FileNotFound;\n\t\tcase FileSystemProviderErrorCode.FileTooLarge: return FileSystemProviderErrorCode.FileTooLarge;\n\t\tcase FileSystemProviderErrorCode.FileWriteLocked: return FileSystemProviderErrorCode.FileWriteLocked;\n\t\tcase FileSystemProviderErrorCode.NoPermissions: return FileSystemProviderErrorCode.NoPermissions;\n\t\tcase FileSystemProviderErrorCode.Unavailable: return FileSystemProviderErrorCode.Unavailable;\n\t}\n\n\treturn FileSystemProviderErrorCode.Unknown;\n}\n\nexport function toFileOperationResult(error: Error): FileOperationResult {\n\n\t// FileSystemProviderError comes with the result already\n\tif (error instanceof FileOperationError) {\n\t\treturn error.fileOperationResult;\n\t}\n\n\t// Otherwise try to find from code\n\tswitch (toFileSystemProviderErrorCode(error)) {\n\t\tcase FileSystemProviderErrorCode.FileNotFound:\n\t\t\treturn FileOperationResult.FILE_NOT_FOUND;\n\t\tcase FileSystemProviderErrorCode.FileIsADirectory:\n\t\t\treturn FileOperationResult.FILE_IS_DIRECTORY;\n\t\tcase FileSystemProviderErrorCode.FileNotADirectory:\n\t\t\treturn FileOperationResult.FILE_NOT_DIRECTORY;\n\t\tcase FileSystemProviderErrorCode.FileWriteLocked:\n\t\t\treturn FileOperationResult.FILE_WRITE_LOCKED;\n\t\tcase FileSystemProviderErrorCode.NoPermissions:\n\t\t\treturn FileOperationResult.FILE_PERMISSION_DENIED;\n\t\tcase FileSystemProviderErrorCode.FileExists:\n\t\t\treturn FileOperationResult.FILE_MOVE_CONFLICT;\n\t\tcase FileSystemProviderErrorCode.FileTooLarge:\n\t\t\treturn FileOperationResult.FILE_TOO_LARGE;\n\t\tdefault:\n\t\t\treturn FileOperationResult.FILE_OTHER_ERROR;\n\t}\n}\n\nexport interface IFileSystemProviderRegistrationEvent {\n\treadonly added: boolean;\n\treadonly scheme: string;\n\treadonly provider?: IFileSystemProvider;\n}\n\nexport interface IFileSystemProviderCapabilitiesChangeEvent {\n\treadonly provider: IFileSystemProvider;\n\treadonly scheme: string;\n}\n\nexport interface IFileSystemProviderActivationEvent {\n\treadonly scheme: string;\n\tjoin(promise: Promise<void>): void;\n}\n\nexport const enum FileOperation {\n\tCREATE,\n\tDELETE,\n\tMOVE,\n\tCOPY,\n\tWRITE\n}\n\nexport interface IFileOperationEvent {\n\n\treadonly resource: URI;\n\treadonly operation: FileOperation;\n\n\tisOperation(operation: FileOperation.DELETE | FileOperation.WRITE): boolean;\n\tisOperation(operation: FileOperation.CREATE | FileOperation.MOVE | FileOperation.COPY): this is IFileOperationEventWithMetadata;\n}\n\nexport interface IFileOperationEventWithMetadata extends IFileOperationEvent {\n\treadonly target: IFileStatWithMetadata;\n}\n\nexport class FileOperationEvent implements IFileOperationEvent {\n\n\tconstructor(resource: URI, operation: FileOperation.DELETE | FileOperation.WRITE);\n\tconstructor(resource: URI, operation: FileOperation.CREATE | FileOperation.MOVE | FileOperation.COPY, target: IFileStatWithMetadata);\n\tconstructor(readonly resource: URI, readonly operation: FileOperation, readonly target?: IFileStatWithMetadata) { }\n\n\tisOperation(operation: FileOperation.DELETE | FileOperation.WRITE): boolean;\n\tisOperation(operation: FileOperation.CREATE | FileOperation.MOVE | FileOperation.COPY): this is IFileOperationEventWithMetadata;\n\tisOperation(operation: FileOperation): boolean {\n\t\treturn this.operation === operation;\n\t}\n}\n\n/**\n * Possible changes that can occur to a file.\n */\nexport const enum FileChangeType {\n\tUPDATED,\n\tADDED,\n\tDELETED\n}\n\n/**\n * Identifies a single change in a file.\n */\nexport interface IFileChange {\n\n\t/**\n\t * The type of change that occurred to the file.\n\t */\n\ttype: FileChangeType;\n\n\t/**\n\t * The unified resource identifier of the file that changed.\n\t */\n\treadonly resource: URI;\n\n\t/**\n\t * If provided when starting the file watcher, the correlation\n\t * identifier will match the original file watching request as\n\t * a way to identify the original component that is interested\n\t * in the change.\n\t */\n\treadonly cId?: number;\n}\n\nexport class FileChangesEvent {\n\n\tprivate static readonly MIXED_CORRELATION = null;\n\n\tprivate readonly correlationId: number | undefined | typeof FileChangesEvent.MIXED_CORRELATION = undefined;\n\n\tconstructor(changes: readonly IFileChange[], private readonly ignorePathCasing: boolean) {\n\t\tfor (const change of changes) {\n\n\t\t\t// Split by type\n\t\t\tswitch (change.type) {\n\t\t\t\tcase FileChangeType.ADDED:\n\t\t\t\t\tthis.rawAdded.push(change.resource);\n\t\t\t\t\tbreak;\n\t\t\t\tcase FileChangeType.UPDATED:\n\t\t\t\t\tthis.rawUpdated.push(change.resource);\n\t\t\t\t\tbreak;\n\t\t\t\tcase FileChangeType.DELETED:\n\t\t\t\t\tthis.rawDeleted.push(change.resource);\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\t// Figure out events correlation\n\t\t\tif (this.correlationId !== FileChangesEvent.MIXED_CORRELATION) {\n\t\t\t\tif (typeof change.cId === 'number') {\n\t\t\t\t\tif (this.correlationId === undefined) {\n\t\t\t\t\t\tthis.correlationId = change.cId; \t\t\t\t\t\t\t// correlation not yet set, just take it\n\t\t\t\t\t} else if (this.correlationId !== change.cId) {\n\t\t\t\t\t\tthis.correlationId = FileChangesEvent.MIXED_CORRELATION;\t// correlation mismatch, we have mixed correlation\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tif (this.correlationId !== undefined) {\n\t\t\t\t\t\tthis.correlationId = FileChangesEvent.MIXED_CORRELATION;\t// correlation mismatch, we have mixed correlation\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate readonly added = new Lazy(() => {\n\t\tconst added = TernarySearchTree.forUris<boolean>(() => this.ignorePathCasing);\n\t\tadded.fill(this.rawAdded.map(resource => [resource, true]));\n\n\t\treturn added;\n\t});\n\n\tprivate readonly updated = new Lazy(() => {\n\t\tconst updated = TernarySearchTree.forUris<boolean>(() => this.ignorePathCasing);\n\t\tupdated.fill(this.rawUpdated.map(resource => [resource, true]));\n\n\t\treturn updated;\n\t});\n\n\tprivate readonly deleted = new Lazy(() => {\n\t\tconst deleted = TernarySearchTree.forUris<boolean>(() => this.ignorePathCasing);\n\t\tdeleted.fill(this.rawDeleted.map(resource => [resource, true]));\n\n\t\treturn deleted;\n\t});\n\n\t/**\n\t * Find out if the file change events match the provided resource.\n\t *\n\t * Note: when passing `FileChangeType.DELETED`, we consider a match\n\t * also when the parent of the resource got deleted.\n\t */\n\tcontains(resource: URI, ...types: FileChangeType[]): boolean {\n\t\treturn this.doContains(resource, { includeChildren: false }, ...types);\n\t}\n\n\t/**\n\t * Find out if the file change events either match the provided\n\t * resource, or contain a child of this resource.\n\t */\n\taffects(resource: URI, ...types: FileChangeType[]): boolean {\n\t\treturn this.doContains(resource, { includeChildren: true }, ...types);\n\t}\n\n\tprivate doContains(resource: URI, options: { includeChildren: boolean }, ...types: FileChangeType[]): boolean {\n\t\tif (!resource) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst hasTypesFilter = types.length > 0;\n\n\t\t// Added\n\t\tif (!hasTypesFilter || types.includes(FileChangeType.ADDED)) {\n\t\t\tif (this.added.value.get(resource)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (options.includeChildren && this.added.value.findSuperstr(resource)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// Updated\n\t\tif (!hasTypesFilter || types.includes(FileChangeType.UPDATED)) {\n\t\t\tif (this.updated.value.get(resource)) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (options.includeChildren && this.updated.value.findSuperstr(resource)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// Deleted\n\t\tif (!hasTypesFilter || types.includes(FileChangeType.DELETED)) {\n\t\t\tif (this.deleted.value.findSubstr(resource) /* deleted also considers parent folders */) {\n\t\t\t\treturn true;\n\t\t\t}\n\n\t\t\tif (options.includeChildren && this.deleted.value.findSuperstr(resource)) {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\treturn false;\n\t}\n\n\t/**\n\t * Returns if this event contains added files.\n\t */\n\tgotAdded(): boolean {\n\t\treturn this.rawAdded.length > 0;\n\t}\n\n\t/**\n\t * Returns if this event contains deleted files.\n\t */\n\tgotDeleted(): boolean {\n\t\treturn this.rawDeleted.length > 0;\n\t}\n\n\t/**\n\t * Returns if this event contains updated files.\n\t */\n\tgotUpdated(): boolean {\n\t\treturn this.rawUpdated.length > 0;\n\t}\n\n\t/**\n\t * Returns if this event contains changes that correlate to the\n\t * provided `correlationId`.\n\t *\n\t * File change event correlation is an advanced watch feature that\n\t * allows to  identify from which watch request the events originate\n\t * from. This correlation allows to route events specifically\n\t * only to the requestor and not emit them to all listeners.\n\t */\n\tcorrelates(correlationId: number): boolean {\n\t\treturn this.correlationId === correlationId;\n\t}\n\n\t/**\n\t * Figure out if the event contains changes that correlate to one\n\t * correlation identifier.\n\t *\n\t * File change event correlation is an advanced watch feature that\n\t * allows to  identify from which watch request the events originate\n\t * from. This correlation allows to route events specifically\n\t * only to the requestor and not emit them to all listeners.\n\t */\n\thasCorrelation(): boolean {\n\t\treturn typeof this.correlationId === 'number';\n\t}\n\n\t/**\n\t * @deprecated use the `contains` or `affects` method to efficiently find\n\t * out if the event relates to a given resource. these methods ensure:\n\t * - that there is no expensive lookup needed (by using a `TernarySearchTree`)\n\t * - correctly handles `FileChangeType.DELETED` events\n\t */\n\treadonly rawAdded: URI[] = [];\n\n\t/**\n\t* @deprecated use the `contains` or `affects` method to efficiently find\n\t* out if the event relates to a given resource. these methods ensure:\n\t* - that there is no expensive lookup needed (by using a `TernarySearchTree`)\n\t* - correctly handles `FileChangeType.DELETED` events\n\t*/\n\treadonly rawUpdated: URI[] = [];\n\n\t/**\n\t* @deprecated use the `contains` or `affects` method to efficiently find\n\t* out if the event relates to a given resource. these methods ensure:\n\t* - that there is no expensive lookup needed (by using a `TernarySearchTree`)\n\t* - correctly handles `FileChangeType.DELETED` events\n\t*/\n\treadonly rawDeleted: URI[] = [];\n}\n\nexport function isParent(path: string, candidate: string, ignoreCase?: boolean): boolean {\n\tif (!path || !candidate || path === candidate) {\n\t\treturn false;\n\t}\n\n\tif (candidate.length > path.length) {\n\t\treturn false;\n\t}\n\n\tif (candidate.charAt(candidate.length - 1) !== sep) {\n\t\tcandidate += sep;\n\t}\n\n\tif (ignoreCase) {\n\t\treturn startsWithIgnoreCase(path, candidate);\n\t}\n\n\treturn path.indexOf(candidate) === 0;\n}\n\nexport interface IBaseFileStat {\n\n\t/**\n\t * The unified resource identifier of this file or folder.\n\t */\n\treadonly resource: URI;\n\n\t/**\n\t * The name which is the last segment\n\t * of the {{path}}.\n\t */\n\treadonly name: string;\n\n\t/**\n\t * The size of the file.\n\t *\n\t * The value may or may not be resolved as\n\t * it is optional.\n\t */\n\treadonly size?: number;\n\n\t/**\n\t * The last modification date represented as millis from unix epoch.\n\t *\n\t * The value may or may not be resolved as\n\t * it is optional.\n\t */\n\treadonly mtime?: number;\n\n\t/**\n\t * The creation date represented as millis from unix epoch.\n\t *\n\t * The value may or may not be resolved as\n\t * it is optional.\n\t */\n\treadonly ctime?: number;\n\n\t/**\n\t * A unique identifier that represents the\n\t * current state of the file or directory.\n\t *\n\t * The value may or may not be resolved as\n\t * it is optional.\n\t */\n\treadonly etag?: string;\n\n\t/**\n\t * File is readonly. Components like editors should not\n\t * offer to edit the contents.\n\t */\n\treadonly readonly?: boolean;\n\n\t/**\n\t * File is locked. Components like editors should offer\n\t * to edit the contents and ask the user upon saving to\n\t * remove the lock.\n\t */\n\treadonly locked?: boolean;\n}\n\nexport interface IBaseFileStatWithMetadata extends Required<IBaseFileStat> { }\n\n/**\n * A file resource with meta information and resolved children if any.\n */\nexport interface IFileStat extends IBaseFileStat {\n\n\t/**\n\t * The resource is a file.\n\t */\n\treadonly isFile: boolean;\n\n\t/**\n\t * The resource is a directory.\n\t */\n\treadonly isDirectory: boolean;\n\n\t/**\n\t * The resource is a symbolic link. Note: even when the\n\t * file is a symbolic link, you can test for `FileType.File`\n\t * and `FileType.Directory` to know the type of the target\n\t * the link points to.\n\t */\n\treadonly isSymbolicLink: boolean;\n\n\t/**\n\t * The children of the file stat or undefined if none.\n\t */\n\tchildren: IFileStat[] | undefined;\n}\n\nexport interface IFileStatWithMetadata extends IFileStat, IBaseFileStatWithMetadata {\n\treadonly mtime: number;\n\treadonly ctime: number;\n\treadonly etag: string;\n\treadonly size: number;\n\treadonly readonly: boolean;\n\treadonly locked: boolean;\n\treadonly children: IFileStatWithMetadata[] | undefined;\n}\n\nexport interface IFileStatResult {\n\treadonly stat?: IFileStat;\n\treadonly success: boolean;\n}\n\nexport interface IFileStatResultWithMetadata extends IFileStatResult {\n\treadonly stat?: IFileStatWithMetadata;\n}\n\nexport interface IFileStatWithPartialMetadata extends Omit<IFileStatWithMetadata, 'children'> { }\n\nexport interface IFileContent extends IBaseFileStatWithMetadata {\n\n\t/**\n\t * The content of a file as buffer.\n\t */\n\treadonly value: VSBuffer;\n}\n\nexport interface IFileStreamContent extends IBaseFileStatWithMetadata {\n\n\t/**\n\t * The content of a file as stream.\n\t */\n\treadonly value: VSBufferReadableStream;\n}\n\nexport interface IBaseReadFileOptions extends IFileReadStreamOptions {\n\n\t/**\n\t * The optional etag parameter allows to return early from resolving the resource if\n\t * the contents on disk match the etag. This prevents accumulated reading of resources\n\t * that have been read already with the same etag.\n\t * It is the task of the caller to makes sure to handle this error case from the promise.\n\t */\n\treadonly etag?: string;\n}\n\nexport interface IReadFileStreamOptions extends IBaseReadFileOptions { }\n\nexport interface IReadFileOptions extends IBaseReadFileOptions {\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `readFile` method is not running in parallel with\n\t * any `write` operations in the same process.\n\t *\n\t * Typically you should not need to use this flag but if\n\t * for example you are quickly reading a file right after\n\t * a file event occurred and the file changes a lot, there\n\t * is a chance that a read returns an empty or partial file\n\t * because a pending write has not finished yet.\n\t *\n\t * Note: this does not prevent the file from being written\n\t * to from a different process. If you need such atomic\n\t * operations, you better use a real database as storage.\n\t */\n\treadonly atomic?: boolean;\n}\n\nexport interface IWriteFileOptions {\n\n\t/**\n\t * The last known modification time of the file. This can be used to prevent dirty writes.\n\t */\n\treadonly mtime?: number;\n\n\t/**\n\t * The etag of the file. This can be used to prevent dirty writes.\n\t */\n\treadonly etag?: string;\n\n\t/**\n\t * Whether to attempt to unlock a file before writing.\n\t */\n\treadonly unlock?: boolean;\n\n\t/**\n\t * The optional `atomic` flag can be used to make sure\n\t * the `writeFile` method updates the target file atomically\n\t * by first writing to a temporary file in the same folder\n\t * and then renaming it over the target.\n\t */\n\treadonly atomic?: IFileAtomicOptions | false;\n}\n\nexport interface IResolveFileOptions {\n\n\t/**\n\t * Automatically continue resolving children of a directory until the provided resources\n\t * are found.\n\t */\n\treadonly resolveTo?: readonly URI[];\n\n\t/**\n\t * Automatically continue resolving children of a directory if the number of children is 1.\n\t */\n\treadonly resolveSingleChildDescendants?: boolean;\n\n\t/**\n\t * Will resolve mtime, ctime, size and etag of files if enabled. This can have a negative impact\n\t * on performance and thus should only be used when these values are required.\n\t */\n\treadonly resolveMetadata?: boolean;\n}\n\nexport interface IResolveMetadataFileOptions extends IResolveFileOptions {\n\treadonly resolveMetadata: true;\n}\n\nexport interface ICreateFileOptions {\n\n\t/**\n\t * Overwrite the file to create if it already exists on disk. Otherwise\n\t * an error will be thrown (FILE_MODIFIED_SINCE).\n\t */\n\treadonly overwrite?: boolean;\n}\n\nexport class FileOperationError extends Error {\n\tconstructor(\n\t\tmessage: string,\n\t\treadonly fileOperationResult: FileOperationResult,\n\t\treadonly options?: IReadFileOptions | IWriteFileOptions | ICreateFileOptions\n\t) {\n\t\tsuper(message);\n\t}\n}\n\nexport class TooLargeFileOperationError extends FileOperationError {\n\tconstructor(\n\t\tmessage: string,\n\t\toverride readonly fileOperationResult: FileOperationResult.FILE_TOO_LARGE,\n\t\treadonly size: number,\n\t\toptions?: IReadFileOptions\n\t) {\n\t\tsuper(message, fileOperationResult, options);\n\t}\n}\n\nexport class NotModifiedSinceFileOperationError extends FileOperationError {\n\n\tconstructor(\n\t\tmessage: string,\n\t\treadonly stat: IFileStatWithMetadata,\n\t\toptions?: IReadFileOptions\n\t) {\n\t\tsuper(message, FileOperationResult.FILE_NOT_MODIFIED_SINCE, options);\n\t}\n}\n\nexport const enum FileOperationResult {\n\tFILE_IS_DIRECTORY,\n\tFILE_NOT_FOUND,\n\tFILE_NOT_MODIFIED_SINCE,\n\tFILE_MODIFIED_SINCE,\n\tFILE_MOVE_CONFLICT,\n\tFILE_WRITE_LOCKED,\n\tFILE_PERMISSION_DENIED,\n\tFILE_TOO_LARGE,\n\tFILE_INVALID_PATH,\n\tFILE_NOT_DIRECTORY,\n\tFILE_OTHER_ERROR\n}\n\n//#endregion\n\n//#region Settings\n\nexport const AutoSaveConfiguration = {\n\tOFF: 'off',\n\tAFTER_DELAY: 'afterDelay',\n\tON_FOCUS_CHANGE: 'onFocusChange',\n\tON_WINDOW_CHANGE: 'onWindowChange'\n};\n\nexport const HotExitConfiguration = {\n\tOFF: 'off',\n\tON_EXIT: 'onExit',\n\tON_EXIT_AND_WINDOW_CLOSE: 'onExitAndWindowClose'\n};\n\nexport const FILES_ASSOCIATIONS_CONFIG = 'files.associations';\nexport const FILES_EXCLUDE_CONFIG = 'files.exclude';\nexport const FILES_READONLY_INCLUDE_CONFIG = 'files.readonlyInclude';\nexport const FILES_READONLY_EXCLUDE_CONFIG = 'files.readonlyExclude';\nexport const FILES_READONLY_FROM_PERMISSIONS_CONFIG = 'files.readonlyFromPermissions';\n\nexport interface IGlobPatterns {\n\t[filepattern: string]: boolean;\n}\n\nexport interface IFilesConfiguration {\n\tfiles?: IFilesConfigurationNode;\n}\n\nexport interface IFilesConfigurationNode {\n\tassociations: { [filepattern: string]: string };\n\texclude: IExpression;\n\twatcherExclude: IGlobPatterns;\n\twatcherInclude: string[];\n\tencoding: string;\n\tautoGuessEncoding: boolean;\n\tcandidateGuessEncodings: string[];\n\tdefaultLanguage: string;\n\ttrimTrailingWhitespace: boolean;\n\tautoSave: string;\n\tautoSaveDelay: number;\n\tautoSaveWorkspaceFilesOnly: boolean;\n\tautoSaveWhenNoErrors: boolean;\n\teol: string;\n\tenableTrash: boolean;\n\thotExit: string;\n\tsaveConflictResolution: 'askUser' | 'overwriteFileOnDisk';\n\treadonlyInclude: IGlobPatterns;\n\treadonlyExclude: IGlobPatterns;\n\treadonlyFromPermissions: boolean;\n}\n\n//#endregion\n\n//#region Utilities\n\nexport enum FileKind {\n\tFILE,\n\tFOLDER,\n\tROOT_FOLDER\n}\n\n/**\n * A hint to disable etag checking for reading/writing.\n */\nexport const ETAG_DISABLED = '';\n\nexport function etag(stat: { mtime: number; size: number }): string;\nexport function etag(stat: { mtime: number | undefined; size: number | undefined }): string | undefined;\nexport function etag(stat: { mtime: number | undefined; size: number | undefined }): string | undefined {\n\tif (typeof stat.size !== 'number' || typeof stat.mtime !== 'number') {\n\t\treturn undefined;\n\t}\n\n\treturn stat.mtime.toString(29) + stat.size.toString(31);\n}\n\nexport async function whenProviderRegistered(file: URI, fileService: IFileService): Promise<void> {\n\tif (fileService.hasProvider(URI.from({ scheme: file.scheme }))) {\n\t\treturn;\n\t}\n\n\treturn new Promise(resolve => {\n\t\tconst disposable = fileService.onDidChangeFileSystemProviderRegistrations(e => {\n\t\t\tif (e.scheme === file.scheme && e.added) {\n\t\t\t\tdisposable.dispose();\n\t\t\t\tresolve();\n\t\t\t}\n\t\t});\n\t});\n}\n\n/**\n * Helper to format a raw byte size into a human readable label.\n */\nexport class ByteSize {\n\n\tstatic readonly KB = 1024;\n\tstatic readonly MB = ByteSize.KB * ByteSize.KB;\n\tstatic readonly GB = ByteSize.MB * ByteSize.KB;\n\tstatic readonly TB = ByteSize.GB * ByteSize.KB;\n\n\tstatic formatSize(size: number): string {\n\t\tif (!isNumber(size)) {\n\t\t\tsize = 0;\n\t\t}\n\n\t\tif (size < ByteSize.KB) {\n\t\t\treturn localize('sizeB', \"{0}B\", size.toFixed(0));\n\t\t}\n\n\t\tif (size < ByteSize.MB) {\n\t\t\treturn localize('sizeKB', \"{0}KB\", (size / ByteSize.KB).toFixed(2));\n\t\t}\n\n\t\tif (size < ByteSize.GB) {\n\t\t\treturn localize('sizeMB', \"{0}MB\", (size / ByteSize.MB).toFixed(2));\n\t\t}\n\n\t\tif (size < ByteSize.TB) {\n\t\t\treturn localize('sizeGB', \"{0}GB\", (size / ByteSize.GB).toFixed(2));\n\t\t}\n\n\t\treturn localize('sizeTB', \"{0}TB\", (size / ByteSize.TB).toFixed(2));\n\t}\n}\n\n// File limits\n\nexport function getLargeFileConfirmationLimit(remoteAuthority?: string): number;\nexport function getLargeFileConfirmationLimit(uri?: URI): number;\nexport function getLargeFileConfirmationLimit(arg?: string | URI): number {\n\tconst isRemote = typeof arg === 'string' || arg?.scheme === Schemas.vscodeRemote;\n\tconst isLocal = typeof arg !== 'string' && arg?.scheme === Schemas.file;\n\n\tif (isLocal) {\n\t\t// Local almost has no limit in file size\n\t\treturn 1024 * ByteSize.MB;\n\t}\n\n\tif (isRemote) {\n\t\t// With a remote, pick a low limit to avoid\n\t\t// potentially costly file transfers\n\t\treturn 10 * ByteSize.MB;\n\t}\n\n\tif (isWeb) {\n\t\t// Web: we cannot know for sure if a cost\n\t\t// is associated with the file transfer\n\t\t// so we pick a reasonably small limit\n\t\treturn 50 * ByteSize.MB;\n\t}\n\n\t// Local desktop: almost no limit in file size\n\treturn 1024 * ByteSize.MB;\n}\n\n//#endregion\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type * as spdlog from '@vscode/spdlog';\nimport { ByteSize } from '../../files/common/files.js';\nimport { AbstractMessageLogger, ILogger, LogLevel } from '../common/log.js';\n\nenum SpdLogLevel {\n\tTrace,\n\tDebug,\n\tInfo,\n\tWarning,\n\tError,\n\tCritical,\n\tOff\n}\n\nasync function createSpdLogLogger(name: string, logfilePath: string, filesize: number, filecount: number, donotUseFormatters: boolean): Promise<spdlog.Logger | null> {\n\t// Do not crash if spdlog cannot be loaded\n\ttry {\n\t\tconst _spdlog = await import('@vscode/spdlog');\n\t\t_spdlog.setFlushOn(SpdLogLevel.Trace);\n\t\tconst logger = await _spdlog.createAsyncRotatingLogger(name, logfilePath, filesize, filecount);\n\t\tif (donotUseFormatters) {\n\t\t\tlogger.clearFormatters();\n\t\t} else {\n\t\t\tlogger.setPattern('%Y-%m-%d %H:%M:%S.%e [%l] %v');\n\t\t}\n\t\treturn logger;\n\t} catch (e) {\n\t\tconsole.error(e);\n\t}\n\treturn null;\n}\n\ninterface ILog {\n\tlevel: LogLevel;\n\tmessage: string;\n}\n\nfunction log(logger: spdlog.Logger, level: LogLevel, message: string): void {\n\tswitch (level) {\n\t\tcase LogLevel.Trace: logger.trace(message); break;\n\t\tcase LogLevel.Debug: logger.debug(message); break;\n\t\tcase LogLevel.Info: logger.info(message); break;\n\t\tcase LogLevel.Warning: logger.warn(message); break;\n\t\tcase LogLevel.Error: logger.error(message); break;\n\t\tcase LogLevel.Off: /* do nothing */ break;\n\t\tdefault: throw new Error(`Invalid log level ${level}`);\n\t}\n}\n\nfunction setLogLevel(logger: spdlog.Logger, level: LogLevel): void {\n\tswitch (level) {\n\t\tcase LogLevel.Trace: logger.setLevel(SpdLogLevel.Trace); break;\n\t\tcase LogLevel.Debug: logger.setLevel(SpdLogLevel.Debug); break;\n\t\tcase LogLevel.Info: logger.setLevel(SpdLogLevel.Info); break;\n\t\tcase LogLevel.Warning: logger.setLevel(SpdLogLevel.Warning); break;\n\t\tcase LogLevel.Error: logger.setLevel(SpdLogLevel.Error); break;\n\t\tcase LogLevel.Off: logger.setLevel(SpdLogLevel.Off); break;\n\t\tdefault: throw new Error(`Invalid log level ${level}`);\n\t}\n}\n\nexport class SpdLogLogger extends AbstractMessageLogger implements ILogger {\n\n\tprivate buffer: ILog[] = [];\n\tprivate readonly _loggerCreationPromise: Promise<void>;\n\tprivate _logger: spdlog.Logger | undefined;\n\n\tconstructor(\n\t\tname: string,\n\t\tfilepath: string,\n\t\trotating: boolean,\n\t\tdonotUseFormatters: boolean,\n\t\tlevel: LogLevel,\n\t) {\n\t\tsuper();\n\t\tthis.setLevel(level);\n\t\tthis._loggerCreationPromise = this._createSpdLogLogger(name, filepath, rotating, donotUseFormatters);\n\t\tthis._register(this.onDidChangeLogLevel(level => {\n\t\t\tif (this._logger) {\n\t\t\t\tsetLogLevel(this._logger, level);\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate async _createSpdLogLogger(name: string, filepath: string, rotating: boolean, donotUseFormatters: boolean): Promise<void> {\n\t\tconst filecount = rotating ? 6 : 1;\n\t\tconst filesize = (30 / filecount) * ByteSize.MB;\n\t\tconst logger = await createSpdLogLogger(name, filepath, filesize, filecount, donotUseFormatters);\n\t\tif (logger) {\n\t\t\tthis._logger = logger;\n\t\t\tsetLogLevel(this._logger, this.getLevel());\n\t\t\tfor (const { level, message } of this.buffer) {\n\t\t\t\tlog(this._logger, level, message);\n\t\t\t}\n\t\t\tthis.buffer = [];\n\t\t}\n\t}\n\n\tprotected log(level: LogLevel, message: string): void {\n\t\tif (this._logger) {\n\t\t\tlog(this._logger, level, message);\n\t\t} else if (this.getLevel() <= level) {\n\t\t\tthis.buffer.push({ level, message });\n\t\t}\n\t}\n\n\toverride flush(): void {\n\t\tif (this._logger) {\n\t\t\tthis.flushLogger();\n\t\t} else {\n\t\t\tthis._loggerCreationPromise.then(() => this.flushLogger());\n\t\t}\n\t}\n\n\toverride dispose(): void {\n\t\tif (this._logger) {\n\t\t\tthis.disposeLogger();\n\t\t} else {\n\t\t\tthis._loggerCreationPromise.then(() => this.disposeLogger());\n\t\t}\n\t\tsuper.dispose();\n\t}\n\n\tprivate flushLogger(): void {\n\t\tif (this._logger) {\n\t\t\tthis._logger.flush();\n\t\t}\n\t}\n\n\tprivate disposeLogger(): void {\n\t\tif (this._logger) {\n\t\t\tthis._logger.drop();\n\t\t\tthis._logger = undefined;\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { URI } from '../../../base/common/uri.js';\nimport { generateUuid } from '../../../base/common/uuid.js';\nimport { AbstractLoggerService, ILogger, ILoggerOptions, ILoggerService, LogLevel } from '../common/log.js';\nimport { SpdLogLogger } from './spdlogLog.js';\n\nexport class LoggerService extends AbstractLoggerService implements ILoggerService {\n\n\tprotected doCreateLogger(resource: URI, logLevel: LogLevel, options?: ILoggerOptions): ILogger {\n\t\treturn new SpdLogLogger(generateUuid(), resource.fsPath, !options?.donotRotate, !!options?.donotUseFormatters, logLevel);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { env } from '../../../base/common/process.js';\nimport { IProductConfiguration } from '../../../base/common/product.js';\nimport { ISandboxConfiguration } from '../../../base/parts/sandbox/common/sandboxTypes.js';\n\n/**\n * @deprecated It is preferred that you use `IProductService` if you can. This\n * allows web embedders to override our defaults. But for things like `product.quality`,\n * the use is fine because that property is not overridable.\n */\nlet product: IProductConfiguration;\n\n// Native sandbox environment\nconst vscodeGlobal = (globalThis as { vscode?: { context?: { configuration(): ISandboxConfiguration | undefined } } }).vscode;\nif (typeof vscodeGlobal !== 'undefined' && typeof vscodeGlobal.context !== 'undefined') {\n\tconst configuration: ISandboxConfiguration | undefined = vscodeGlobal.context.configuration();\n\tif (configuration) {\n\t\tproduct = configuration.product;\n\t} else {\n\t\tthrow new Error('Sandbox: unable to resolve product configuration from preload script.');\n\t}\n}\n// _VSCODE environment\nelse if (globalThis._VSCODE_PRODUCT_JSON && globalThis._VSCODE_PACKAGE_JSON) {\n\t// Obtain values from product.json and package.json-data\n\tproduct = globalThis._VSCODE_PRODUCT_JSON as unknown as IProductConfiguration;\n\n\t// Running out of sources\n\tif (env['VSCODE_DEV']) {\n\t\tObject.assign(product, {\n\t\t\tnameShort: `${product.nameShort} Dev`,\n\t\t\tnameLong: `${product.nameLong} Dev`,\n\t\t\tdataFolderName: `${product.dataFolderName}-dev`,\n\t\t\tserverDataFolderName: product.serverDataFolderName ? `${product.serverDataFolderName}-dev` : undefined\n\t\t});\n\t}\n\n\t// Version is added during built time, but we still\n\t// want to have it running out of sources so we\n\t// read it from package.json only when we need it.\n\tif (!product.version) {\n\t\tconst pkg = globalThis._VSCODE_PACKAGE_JSON as { version: string };\n\n\t\tObject.assign(product, {\n\t\t\tversion: pkg.version\n\t\t});\n\t}\n}\n\n// Web environment or unknown\nelse {\n\n\t// Built time configuration (do NOT modify)\n\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\tproduct = { /*BUILD->INSERT_PRODUCT_CONFIGURATION*/ } as unknown as IProductConfiguration;\n\n\t// Running out of sources\n\tif (Object.keys(product).length === 0) {\n\t\tObject.assign(product, {\n\t\t\tversion: '1.104.0-dev',\n\t\t\tnameShort: 'Code - OSS Dev',\n\t\t\tnameLong: 'Code - OSS Dev',\n\t\t\tapplicationName: 'code-oss',\n\t\t\tdataFolderName: '.vscode-oss',\n\t\t\turlProtocol: 'code-oss',\n\t\t\treportIssueUrl: 'https://github.com/microsoft/vscode/issues/new',\n\t\t\tlicenseName: 'MIT',\n\t\t\tlicenseUrl: 'https://github.com/microsoft/vscode/blob/main/LICENSE.txt',\n\t\t\tserverLicenseUrl: 'https://github.com/microsoft/vscode/blob/main/LICENSE.txt'\n\t\t});\n\t}\n}\n\nexport default product;\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as Assert from '../../../base/common/assert.js';\nimport * as Types from '../../../base/common/types.js';\n\nexport interface IRegistry {\n\n\t/**\n\t * Adds the extension functions and properties defined by data to the\n\t * platform. The provided id must be unique.\n\t * @param id a unique identifier\n\t * @param data a contribution\n\t */\n\tadd(id: string, data: any): void;\n\n\t/**\n\t * Returns true iff there is an extension with the provided id.\n\t * @param id an extension identifier\n\t */\n\tknows(id: string): boolean;\n\n\t/**\n\t * Returns the extension functions and properties defined by the specified key or null.\n\t * @param id an extension identifier\n\t */\n\tas<T>(id: string): T;\n}\n\nclass RegistryImpl implements IRegistry {\n\n\tprivate readonly data = new Map<string, any>();\n\n\tpublic add(id: string, data: any): void {\n\t\tAssert.ok(Types.isString(id));\n\t\tAssert.ok(Types.isObject(data));\n\t\tAssert.ok(!this.data.has(id), 'There is already an extension with this id');\n\n\t\tthis.data.set(id, data);\n\t}\n\n\tpublic knows(id: string): boolean {\n\t\treturn this.data.has(id);\n\t}\n\n\tpublic as(id: string): any {\n\t\treturn this.data.get(id) || null;\n\t}\n\n\tpublic dispose() {\n\t\tthis.data.forEach((value) => {\n\t\t\tif (Types.isFunction(value.dispose)) {\n\t\t\t\tvalue.dispose();\n\t\t\t}\n\t\t});\n\t\tthis.data.clear();\n\t}\n\n}\n\nexport const Registry: IRegistry = new RegistryImpl();\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { IProcessEnvironment, OperatingSystem } from '../../../base/common/platform.js';\nimport { URI, UriComponents } from '../../../base/common/uri.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\nimport { IPtyHostProcessReplayEvent, ISerializedCommandDetectionCapability, ITerminalCapabilityStore, type ITerminalCommand } from './capabilities/capabilities.js';\nimport { IGetTerminalLayoutInfoArgs, IProcessDetails, ISetTerminalLayoutInfoArgs } from './terminalProcess.js';\nimport { ThemeIcon } from '../../../base/common/themables.js';\nimport { ISerializableEnvironmentVariableCollections } from './environmentVariable.js';\nimport { IWorkspaceFolder } from '../../workspace/common/workspace.js';\nimport { Registry } from '../../registry/common/platform.js';\nimport type * as performance from '../../../base/common/performance.js';\nimport { ILogService } from '../../log/common/log.js';\nimport type { IAction } from '../../../base/common/actions.js';\nimport type { IDisposable } from '../../../base/common/lifecycle.js';\nimport type { SingleOrMany } from '../../../base/common/types.js';\n\nexport const enum TerminalSettingPrefix {\n\tAutomationProfile = 'terminal.integrated.automationProfile.',\n\tDefaultProfile = 'terminal.integrated.defaultProfile.',\n\tProfiles = 'terminal.integrated.profiles.'\n}\n\nexport const enum TerminalSettingId {\n\tSendKeybindingsToShell = 'terminal.integrated.sendKeybindingsToShell',\n\tAutomationProfileLinux = 'terminal.integrated.automationProfile.linux',\n\tAutomationProfileMacOs = 'terminal.integrated.automationProfile.osx',\n\tAutomationProfileWindows = 'terminal.integrated.automationProfile.windows',\n\tProfilesWindows = 'terminal.integrated.profiles.windows',\n\tProfilesMacOs = 'terminal.integrated.profiles.osx',\n\tProfilesLinux = 'terminal.integrated.profiles.linux',\n\tDefaultProfileLinux = 'terminal.integrated.defaultProfile.linux',\n\tDefaultProfileMacOs = 'terminal.integrated.defaultProfile.osx',\n\tDefaultProfileWindows = 'terminal.integrated.defaultProfile.windows',\n\tUseWslProfiles = 'terminal.integrated.useWslProfiles',\n\tTabsDefaultColor = 'terminal.integrated.tabs.defaultColor',\n\tTabsDefaultIcon = 'terminal.integrated.tabs.defaultIcon',\n\tTabsEnabled = 'terminal.integrated.tabs.enabled',\n\tTabsEnableAnimation = 'terminal.integrated.tabs.enableAnimation',\n\tTabsHideCondition = 'terminal.integrated.tabs.hideCondition',\n\tTabsShowActiveTerminal = 'terminal.integrated.tabs.showActiveTerminal',\n\tTabsShowActions = 'terminal.integrated.tabs.showActions',\n\tTabsLocation = 'terminal.integrated.tabs.location',\n\tTabsFocusMode = 'terminal.integrated.tabs.focusMode',\n\tMacOptionIsMeta = 'terminal.integrated.macOptionIsMeta',\n\tMacOptionClickForcesSelection = 'terminal.integrated.macOptionClickForcesSelection',\n\tAltClickMovesCursor = 'terminal.integrated.altClickMovesCursor',\n\tCopyOnSelection = 'terminal.integrated.copyOnSelection',\n\tEnableMultiLinePasteWarning = 'terminal.integrated.enableMultiLinePasteWarning',\n\tDrawBoldTextInBrightColors = 'terminal.integrated.drawBoldTextInBrightColors',\n\tFontFamily = 'terminal.integrated.fontFamily',\n\tFontSize = 'terminal.integrated.fontSize',\n\tLetterSpacing = 'terminal.integrated.letterSpacing',\n\tLineHeight = 'terminal.integrated.lineHeight',\n\tMinimumContrastRatio = 'terminal.integrated.minimumContrastRatio',\n\tTabStopWidth = 'terminal.integrated.tabStopWidth',\n\tFastScrollSensitivity = 'terminal.integrated.fastScrollSensitivity',\n\tMouseWheelScrollSensitivity = 'terminal.integrated.mouseWheelScrollSensitivity',\n\tBellDuration = 'terminal.integrated.bellDuration',\n\tFontWeight = 'terminal.integrated.fontWeight',\n\tFontWeightBold = 'terminal.integrated.fontWeightBold',\n\tCursorBlinking = 'terminal.integrated.cursorBlinking',\n\tCursorStyle = 'terminal.integrated.cursorStyle',\n\tCursorStyleInactive = 'terminal.integrated.cursorStyleInactive',\n\tCursorWidth = 'terminal.integrated.cursorWidth',\n\tScrollback = 'terminal.integrated.scrollback',\n\tDetectLocale = 'terminal.integrated.detectLocale',\n\tDefaultLocation = 'terminal.integrated.defaultLocation',\n\tGpuAcceleration = 'terminal.integrated.gpuAcceleration',\n\tTerminalTitleSeparator = 'terminal.integrated.tabs.separator',\n\tTerminalTitle = 'terminal.integrated.tabs.title',\n\tTerminalDescription = 'terminal.integrated.tabs.description',\n\tRightClickBehavior = 'terminal.integrated.rightClickBehavior',\n\tMiddleClickBehavior = 'terminal.integrated.middleClickBehavior',\n\tCwd = 'terminal.integrated.cwd',\n\tConfirmOnExit = 'terminal.integrated.confirmOnExit',\n\tConfirmOnKill = 'terminal.integrated.confirmOnKill',\n\tEnableBell = 'terminal.integrated.enableBell',\n\tEnableVisualBell = 'terminal.integrated.enableVisualBell',\n\tCommandsToSkipShell = 'terminal.integrated.commandsToSkipShell',\n\tAllowChords = 'terminal.integrated.allowChords',\n\tAllowMnemonics = 'terminal.integrated.allowMnemonics',\n\tTabFocusMode = 'terminal.integrated.tabFocusMode',\n\tEnvMacOs = 'terminal.integrated.env.osx',\n\tEnvLinux = 'terminal.integrated.env.linux',\n\tEnvWindows = 'terminal.integrated.env.windows',\n\tEnvironmentChangesRelaunch = 'terminal.integrated.environmentChangesRelaunch',\n\tShowExitAlert = 'terminal.integrated.showExitAlert',\n\tSplitCwd = 'terminal.integrated.splitCwd',\n\tWindowsEnableConpty = 'terminal.integrated.windowsEnableConpty',\n\tWindowsUseConptyDll = 'terminal.integrated.windowsUseConptyDll',\n\tWordSeparators = 'terminal.integrated.wordSeparators',\n\tEnableFileLinks = 'terminal.integrated.enableFileLinks',\n\tAllowedLinkSchemes = 'terminal.integrated.allowedLinkSchemes',\n\tUnicodeVersion = 'terminal.integrated.unicodeVersion',\n\tEnablePersistentSessions = 'terminal.integrated.enablePersistentSessions',\n\tPersistentSessionReviveProcess = 'terminal.integrated.persistentSessionReviveProcess',\n\tHideOnStartup = 'terminal.integrated.hideOnStartup',\n\tHideOnLastClosed = 'terminal.integrated.hideOnLastClosed',\n\tCustomGlyphs = 'terminal.integrated.customGlyphs',\n\tRescaleOverlappingGlyphs = 'terminal.integrated.rescaleOverlappingGlyphs',\n\tPersistentSessionScrollback = 'terminal.integrated.persistentSessionScrollback',\n\tInheritEnv = 'terminal.integrated.inheritEnv',\n\tShowLinkHover = 'terminal.integrated.showLinkHover',\n\tIgnoreProcessNames = 'terminal.integrated.ignoreProcessNames',\n\tShellIntegrationEnabled = 'terminal.integrated.shellIntegration.enabled',\n\tShellIntegrationShowWelcome = 'terminal.integrated.shellIntegration.showWelcome',\n\tShellIntegrationDecorationsEnabled = 'terminal.integrated.shellIntegration.decorationsEnabled',\n\tShellIntegrationTimeout = 'terminal.integrated.shellIntegration.timeout',\n\tShellIntegrationQuickFixEnabled = 'terminal.integrated.shellIntegration.quickFixEnabled',\n\tShellIntegrationEnvironmentReporting = 'terminal.integrated.shellIntegration.environmentReporting',\n\tEnableImages = 'terminal.integrated.enableImages',\n\tSmoothScrolling = 'terminal.integrated.smoothScrolling',\n\tIgnoreBracketedPasteMode = 'terminal.integrated.ignoreBracketedPasteMode',\n\tFocusAfterRun = 'terminal.integrated.focusAfterRun',\n\tFontLigaturesEnabled = 'terminal.integrated.fontLigatures.enabled',\n\tFontLigaturesFeatureSettings = 'terminal.integrated.fontLigatures.featureSettings',\n\tFontLigaturesFallbackLigatures = 'terminal.integrated.fontLigatures.fallbackLigatures',\n\n\t// Developer/debug settings\n\n\t/** Simulated latency applied to all calls made to the pty host */\n\tDeveloperPtyHostLatency = 'terminal.integrated.developer.ptyHost.latency',\n\t/** Simulated startup delay of the pty host process */\n\tDeveloperPtyHostStartupDelay = 'terminal.integrated.developer.ptyHost.startupDelay',\n\t/** Shows the textarea element */\n\tDevMode = 'terminal.integrated.developer.devMode'\n}\n\nexport const enum PosixShellType {\n\tBash = 'bash',\n\tFish = 'fish',\n\tSh = 'sh',\n\tCsh = 'csh',\n\tKsh = 'ksh',\n\tZsh = 'zsh',\n\n}\nexport const enum WindowsShellType {\n\tCommandPrompt = 'cmd',\n\tWsl = 'wsl',\n\tGitBash = 'gitbash',\n}\n\nexport const enum GeneralShellType {\n\tPowerShell = 'pwsh',\n\tPython = 'python',\n\tJulia = 'julia',\n\tNuShell = 'nu',\n\tNode = 'node',\n}\nexport type TerminalShellType = PosixShellType | WindowsShellType | GeneralShellType | undefined;\n\nexport interface IRawTerminalInstanceLayoutInfo<T> {\n\trelativeSize: number;\n\tterminal: T;\n}\nexport type ITerminalInstanceLayoutInfoById = IRawTerminalInstanceLayoutInfo<number>;\nexport type ITerminalInstanceLayoutInfo = IRawTerminalInstanceLayoutInfo<IPtyHostAttachTarget>;\n\nexport interface IRawTerminalTabLayoutInfo<T> {\n\tisActive: boolean;\n\tactivePersistentProcessId: number | undefined;\n\tterminals: IRawTerminalInstanceLayoutInfo<T>[];\n}\n\nexport type ITerminalTabLayoutInfoById = IRawTerminalTabLayoutInfo<number>;\n\nexport interface IRawTerminalsLayoutInfo<T> {\n\ttabs: IRawTerminalTabLayoutInfo<T>[];\n\tbackground: T[] | null;\n}\n\nexport interface IPtyHostAttachTarget {\n\tid: number;\n\tpid: number;\n\ttitle: string;\n\ttitleSource: TitleEventSource;\n\tcwd: string;\n\tworkspaceId: string;\n\tworkspaceName: string;\n\tisOrphan: boolean;\n\ticon: TerminalIcon | undefined;\n\tfixedDimensions: IFixedTerminalDimensions | undefined;\n\tenvironmentVariableCollections: ISerializableEnvironmentVariableCollections | undefined;\n\treconnectionProperties?: IReconnectionProperties;\n\twaitOnExit?: WaitOnExitValue;\n\thideFromUser?: boolean;\n\tisFeatureTerminal?: boolean;\n\ttype?: TerminalType;\n\thasChildProcesses: boolean;\n\tshellIntegrationNonce: string;\n\ttabActions?: ITerminalTabAction[];\n}\n\nexport interface IReconnectionProperties {\n\townerId: string;\n\tdata?: unknown;\n}\n\nexport type TerminalType = 'Task' | 'Local' | undefined;\n\nexport enum TitleEventSource {\n\t/** From the API or the rename command that overrides any other type */\n\tApi,\n\t/** From the process name property*/\n\tProcess,\n\t/** From the VT sequence */\n\tSequence,\n\t/** Config changed */\n\tConfig\n}\n\nexport type ITerminalsLayoutInfo = IRawTerminalsLayoutInfo<IPtyHostAttachTarget | null>;\nexport type ITerminalsLayoutInfoById = IRawTerminalsLayoutInfo<number>;\n\nexport enum TerminalIpcChannels {\n\t/**\n\t * Communicates between the renderer process and shared process.\n\t */\n\tLocalPty = 'localPty',\n\t/**\n\t * Communicates between the shared process and the pty host process.\n\t */\n\tPtyHost = 'ptyHost',\n\t/**\n\t * Communicates between the renderer process and the pty host process.\n\t */\n\tPtyHostWindow = 'ptyHostWindow',\n\t/**\n\t * Deals with logging from the pty host process.\n\t */\n\tLogger = 'logger',\n\t/**\n\t * Enables the detection of unresponsive pty hosts.\n\t */\n\tHeartbeat = 'heartbeat'\n}\n\nexport const enum ProcessPropertyType {\n\tCwd = 'cwd',\n\tInitialCwd = 'initialCwd',\n\tFixedDimensions = 'fixedDimensions',\n\tTitle = 'title',\n\tShellType = 'shellType',\n\tHasChildProcesses = 'hasChildProcesses',\n\tResolvedShellLaunchConfig = 'resolvedShellLaunchConfig',\n\tOverrideDimensions = 'overrideDimensions',\n\tFailedShellIntegrationActivation = 'failedShellIntegrationActivation',\n\tUsedShellIntegrationInjection = 'usedShellIntegrationInjection',\n\tShellIntegrationInjectionFailureReason = 'shellIntegrationInjectionFailureReason',\n}\n\nexport interface IProcessProperty<T extends ProcessPropertyType = ProcessPropertyType> {\n\ttype: T;\n\tvalue: IProcessPropertyMap[T];\n}\n\nexport interface IProcessPropertyMap {\n\t[ProcessPropertyType.Cwd]: string;\n\t[ProcessPropertyType.InitialCwd]: string;\n\t[ProcessPropertyType.FixedDimensions]: IFixedTerminalDimensions;\n\t[ProcessPropertyType.Title]: string;\n\t[ProcessPropertyType.ShellType]: TerminalShellType | undefined;\n\t[ProcessPropertyType.HasChildProcesses]: boolean;\n\t[ProcessPropertyType.ResolvedShellLaunchConfig]: IShellLaunchConfig;\n\t[ProcessPropertyType.OverrideDimensions]: ITerminalDimensionsOverride | undefined;\n\t[ProcessPropertyType.FailedShellIntegrationActivation]: boolean | undefined;\n\t[ProcessPropertyType.UsedShellIntegrationInjection]: boolean | undefined;\n\t[ProcessPropertyType.ShellIntegrationInjectionFailureReason]: ShellIntegrationInjectionFailureReason | undefined;\n}\n\nexport interface IFixedTerminalDimensions {\n\t/**\n\t * The fixed columns of the terminal.\n\t */\n\tcols?: number;\n\n\t/**\n\t * The fixed rows of the terminal.\n\t */\n\trows?: number;\n}\n\nexport interface ITerminalLaunchResult {\n\tinjectedArgs: string[];\n}\n\n/**\n * A service that communicates with a pty host.\n*/\nexport interface IPtyService {\n\treadonly _serviceBrand: undefined;\n\n\treadonly onProcessData: Event<{ id: number; event: IProcessDataEvent | string }>;\n\treadonly onProcessReady: Event<{ id: number; event: IProcessReadyEvent }>;\n\treadonly onProcessReplay: Event<{ id: number; event: IPtyHostProcessReplayEvent }>;\n\treadonly onProcessOrphanQuestion: Event<{ id: number }>;\n\treadonly onDidRequestDetach: Event<{ requestId: number; workspaceId: string; instanceId: number }>;\n\treadonly onDidChangeProperty: Event<{ id: number; property: IProcessProperty }>;\n\treadonly onProcessExit: Event<{ id: number; event: number | undefined }>;\n\n\tcreateProcess(\n\t\tshellLaunchConfig: IShellLaunchConfig,\n\t\tcwd: string,\n\t\tcols: number,\n\t\trows: number,\n\t\tunicodeVersion: '6' | '11',\n\t\tenv: IProcessEnvironment,\n\t\texecutableEnv: IProcessEnvironment,\n\t\toptions: ITerminalProcessOptions,\n\t\tshouldPersist: boolean,\n\t\tworkspaceId: string,\n\t\tworkspaceName: string\n\t): Promise<number>;\n\tattachToProcess(id: number): Promise<void>;\n\tdetachFromProcess(id: number, forcePersist?: boolean): Promise<void>;\n\tshutdownAll(): Promise<void>;\n\n\t/**\n\t * Lists all orphaned processes, ie. those without a connected frontend.\n\t */\n\tlistProcesses(): Promise<IProcessDetails[]>;\n\tgetPerformanceMarks(): Promise<performance.PerformanceMark[]>;\n\t/**\n\t * Measures and returns the latency of the current and all other processes to the pty host.\n\t */\n\tgetLatency(): Promise<IPtyHostLatencyMeasurement[]>;\n\n\tstart(id: number): Promise<ITerminalLaunchError | ITerminalLaunchResult | undefined>;\n\tshutdown(id: number, immediate: boolean): Promise<void>;\n\tinput(id: number, data: string): Promise<void>;\n\tsendSignal(id: number, signal: string): Promise<void>;\n\tresize(id: number, cols: number, rows: number): Promise<void>;\n\tclearBuffer(id: number): Promise<void>;\n\tgetInitialCwd(id: number): Promise<string>;\n\tgetCwd(id: number): Promise<string>;\n\tacknowledgeDataEvent(id: number, charCount: number): Promise<void>;\n\tsetNextCommandId(id: number, commandLine: string, commandId: string): Promise<void>;\n\tsetUnicodeVersion(id: number, version: '6' | '11'): Promise<void>;\n\tprocessBinary(id: number, data: string): Promise<void>;\n\t/** Confirm the process is _not_ an orphan. */\n\torphanQuestionReply(id: number): Promise<void>;\n\tupdateTitle(id: number, title: string, titleSource: TitleEventSource): Promise<void>;\n\tupdateIcon(id: number, userInitiated: boolean, icon: TerminalIcon, color?: string): Promise<void>;\n\n\tgetDefaultSystemShell(osOverride?: OperatingSystem): Promise<string>;\n\tgetEnvironment(): Promise<IProcessEnvironment>;\n\tgetWslPath(original: string, direction: 'unix-to-win' | 'win-to-unix'): Promise<string>;\n\tgetRevivedPtyNewId(workspaceId: string, id: number): Promise<number | undefined>;\n\tsetTerminalLayoutInfo(args: ISetTerminalLayoutInfoArgs): Promise<void>;\n\tgetTerminalLayoutInfo(args: IGetTerminalLayoutInfoArgs): Promise<ITerminalsLayoutInfo | undefined>;\n\treduceConnectionGraceTime(): Promise<void>;\n\trequestDetachInstance(workspaceId: string, instanceId: number): Promise<IProcessDetails | undefined>;\n\tacceptDetachInstanceReply(requestId: number, persistentProcessId?: number): Promise<void>;\n\tfreePortKillProcess(port: string): Promise<{ port: string; processId: string }>;\n\t/**\n\t * Serializes and returns terminal state.\n\t * @param ids The persistent terminal IDs to serialize.\n\t */\n\tserializeTerminalState(ids: number[]): Promise<string>;\n\t/**\n\t * Revives a workspaces terminal processes, these can then be reconnected to using the normal\n\t * flow for restoring terminals after reloading.\n\t */\n\treviveTerminalProcesses(workspaceId: string, state: ISerializedTerminalState[], dateTimeFormatLocate: string): Promise<void>;\n\trefreshProperty<T extends ProcessPropertyType>(id: number, property: T): Promise<IProcessPropertyMap[T]>;\n\tupdateProperty<T extends ProcessPropertyType>(id: number, property: T, value: IProcessPropertyMap[T]): Promise<void>;\n\n\t// TODO: Make mandatory and remove impl from pty host service\n\trefreshIgnoreProcessNames?(names: string[]): Promise<void>;\n\n\t// #region Pty service contribution RPC calls\n\n\tinstallAutoReply(match: string, reply: string): Promise<void>;\n\tuninstallAllAutoReplies(): Promise<void>;\n\n\t// #endregion\n}\nexport const IPtyService = createDecorator<IPtyService>('ptyService');\n\nexport interface IPtyServiceContribution {\n\thandleProcessReady(persistentProcessId: number, process: ITerminalChildProcess): void;\n\thandleProcessDispose(persistentProcessId: number): void;\n\thandleProcessInput(persistentProcessId: number, data: string): void;\n\thandleProcessResize(persistentProcessId: number, cols: number, rows: number): void;\n}\n\nexport interface IPtyHostController {\n\treadonly onPtyHostExit: Event<number>;\n\treadonly onPtyHostStart: Event<void>;\n\treadonly onPtyHostUnresponsive: Event<void>;\n\treadonly onPtyHostResponsive: Event<void>;\n\treadonly onPtyHostRequestResolveVariables: Event<IRequestResolveVariablesEvent>;\n\n\trestartPtyHost(): Promise<void>;\n\tacceptPtyHostResolvedVariables(requestId: number, resolved: string[]): Promise<void>;\n\tgetProfiles(workspaceId: string, profiles: unknown, defaultProfile: unknown, includeDetectedProfiles?: boolean): Promise<ITerminalProfile[]>;\n}\n\n/**\n * A service that communicates with a pty host controller (eg. main or server\n * process) and is able to launch and forward requests to the pty host.\n*/\nexport interface IPtyHostService extends IPtyService, IPtyHostController {\n}\n\nexport interface IPtyHostLatencyMeasurement {\n\tlabel: string;\n\tlatency: number;\n}\n\n/**\n * Serialized terminal state matching the interface that can be used across versions, the version\n * should be verified before using the state payload.\n */\nexport interface ICrossVersionSerializedTerminalState {\n\tversion: number;\n\tstate: unknown;\n}\n\nexport interface ISerializedTerminalState {\n\tid: number;\n\tshellLaunchConfig: IShellLaunchConfig;\n\tprocessDetails: IProcessDetails;\n\tprocessLaunchConfig: IPersistentTerminalProcessLaunchConfig;\n\tunicodeVersion: '6' | '11';\n\treplayEvent: IPtyHostProcessReplayEvent;\n\ttimestamp: number;\n}\n\nexport interface IPersistentTerminalProcessLaunchConfig {\n\tenv: IProcessEnvironment;\n\texecutableEnv: IProcessEnvironment;\n\toptions: ITerminalProcessOptions;\n}\n\nexport interface IRequestResolveVariablesEvent {\n\trequestId: number;\n\tworkspaceId: string;\n\toriginalText: string[];\n}\n\nexport enum HeartbeatConstants {\n\t/**\n\t * The duration between heartbeats\n\t */\n\tBeatInterval = 5000,\n\t/**\n\t * The duration of the first heartbeat while the pty host is starting up. This is much larger\n\t * than the regular BeatInterval to accommodate slow machines, we still want to warn about the\n\t * pty host's unresponsiveness eventually though.\n\t */\n\tConnectingBeatInterval = 20000,\n\t/**\n\t * Defines a multiplier for BeatInterval for how long to wait before starting the second wait\n\t * timer.\n\t */\n\tFirstWaitMultiplier = 1.2,\n\t/**\n\t * Defines a multiplier for BeatInterval for how long to wait before telling the user about\n\t * non-responsiveness. The second timer is to avoid informing the user incorrectly when waking\n\t * the computer up from sleep\n\t */\n\tSecondWaitMultiplier = 1,\n\t/**\n\t * How long to wait before telling the user about non-responsiveness when they try to create a\n\t * process. This short circuits the standard wait timeouts to tell the user sooner and only\n\t * create process is handled to avoid additional perf overhead.\n\t */\n\tCreateProcessTimeout = 5000\n}\n\nexport interface IHeartbeatService {\n\treadonly onBeat: Event<void>;\n}\n\n\nexport interface IShellLaunchConfig {\n\t/**\n\t * The name of the terminal, if this is not set the name of the process will be used.\n\t */\n\tname?: string;\n\n\t/**\n\t * A string to follow the name of the terminal with, indicating the type of terminal\n\t */\n\ttype?: 'Task' | 'Local';\n\n\t/**\n\t * The shell executable (bash, cmd, etc.).\n\t */\n\texecutable?: string;\n\n\t/**\n\t * The CLI arguments to use with executable, a string[] is in argv format and will be escaped,\n\t * a string is in \"CommandLine\" pre-escaped format and will be used as is. The string option is\n\t * only supported on Windows and will throw an exception if used on macOS or Linux.\n\t */\n\targs?: string[] | string;\n\n\t/**\n\t * The current working directory of the terminal, this overrides the `terminal.integrated.cwd`\n\t * settings key.\n\t */\n\tcwd?: string | URI;\n\n\t/**\n\t * A custom environment for the terminal, if this is not set the environment will be inherited\n\t * from the VS Code process.\n\t */\n\tenv?: ITerminalEnvironment;\n\n\t/**\n\t * Whether to ignore a custom cwd from the `terminal.integrated.cwd` settings key (e.g. if the\n\t * shell is being launched by an extension).\n\t */\n\tignoreConfigurationCwd?: boolean;\n\n\t/**\n\t * The reconnection properties for this terminal\n\t */\n\treconnectionProperties?: IReconnectionProperties;\n\n\t/** Whether to wait for a key press before closing the terminal. */\n\twaitOnExit?: WaitOnExitValue;\n\n\t/**\n\t * A string including ANSI escape sequences that will be written to the terminal emulator\n\t * _before_ the terminal process has launched, when a string is specified, a trailing \\n is\n\t * added at the end. This allows for example the terminal instance to display a styled message\n\t * as the first line of the terminal. Use \\x1b over \\033 or \\e for the escape control character.\n\t */\n\tinitialText?: string | { text: string; trailingNewLine: boolean };\n\n\t/**\n\t * Custom PTY/pseudoterminal process to use.\n\t */\n\tcustomPtyImplementation?: (terminalId: number, cols: number, rows: number) => ITerminalChildProcess;\n\n\t/**\n\t * A UUID generated by the extension host process for terminals created on the extension host process.\n\t */\n\textHostTerminalId?: string;\n\n\t/**\n\t * This is a terminal that attaches to an already running terminal.\n\t */\n\tattachPersistentProcess?: {\n\t\tid: number;\n\t\tfindRevivedId?: boolean;\n\t\tpid: number;\n\t\ttitle: string;\n\t\ttitleSource: TitleEventSource;\n\t\tcwd: string;\n\t\ticon?: TerminalIcon;\n\t\tcolor?: string;\n\t\thasChildProcesses?: boolean;\n\t\tfixedDimensions?: IFixedTerminalDimensions;\n\t\tenvironmentVariableCollections?: ISerializableEnvironmentVariableCollections;\n\t\treconnectionProperties?: IReconnectionProperties;\n\t\ttype?: TerminalType;\n\t\twaitOnExit?: WaitOnExitValue;\n\t\thideFromUser?: boolean;\n\t\tisFeatureTerminal?: boolean;\n\t\tshellIntegrationNonce: string;\n\t\ttabActions?: ITerminalTabAction[];\n\t};\n\n\t/**\n\t * Whether the terminal process environment should be exactly as provided in\n\t * `TerminalOptions.env`. When this is false (default), the environment will be based on the\n\t * window's environment and also apply configured platform settings like\n\t * `terminal.integrated.env.windows` on top. When this is true, the complete environment must be\n\t * provided as nothing will be inherited from the process or any configuration.\n\t */\n\tstrictEnv?: boolean;\n\n\t/**\n\t * Whether the terminal process environment will inherit VS Code's \"shell environment\" that may\n\t * get sourced from running a login shell depnding on how the application was launched.\n\t * Consumers that rely on development tools being present in the $PATH should set this to true.\n\t * This will overwrite the value of the inheritEnv setting.\n\t */\n\tuseShellEnvironment?: boolean;\n\n\t/**\n\t * When enabled the terminal will run the process as normal but not be surfaced to the user\n\t * until `Terminal.show` is called. The typical usage for this is when you need to run\n\t * something that may need interactivity but only want to tell the user about it when\n\t * interaction is needed. Note that the terminals will still be exposed to all extensions\n\t * as normal. The hidden terminals will not be restored when the workspace is next opened.\n\t */\n\thideFromUser?: boolean;\n\n\t/**\n\t * Whether to force the terminal to persist across sessions regardless of the other\n\t * launch config, like `hideFromUser`.\n\t */\n\tforcePersist?: boolean;\n\n\t/**\n\t * Whether this terminal is not a terminal that the user directly created and uses, but rather\n\t * a terminal used to drive some VS Code feature.\n\t */\n\tisFeatureTerminal?: boolean;\n\n\t/**\n\t * Whether this terminal was created by an extension.\n\t */\n\tisExtensionOwnedTerminal?: boolean;\n\n\t/**\n\t * The icon for the terminal, used primarily in the terminal tab.\n\t */\n\ticon?: TerminalIcon;\n\n\t/**\n\t * The color ID to use for this terminal. If not specified it will use the default fallback\n\t */\n\tcolor?: string;\n\n\t/**\n\t * When a parent terminal is provided via API, the group needs\n\t * to find the index in order to place the child\n\t * directly to the right of its parent.\n\t */\n\tparentTerminalId?: number;\n\n\t/**\n\t * The dimensions for the instance as set by the user\n\t * or via Size to Content Width\n\t */\n\tfixedDimensions?: IFixedTerminalDimensions;\n\n\t/**\n\t * Opt-out of the default terminal persistence on restart and reload\n\t */\n\tisTransient?: boolean;\n\n\t/**\n\t * Attempt to force shell integration to be enabled by bypassing the {@link isFeatureTerminal}\n\t * equals false requirement.\n\t */\n\tforceShellIntegration?: boolean;\n\n\t/**\n\t * Create a terminal without shell integration even when it's enabled\n\t */\n\tignoreShellIntegration?: boolean;\n\n\t/**\n\t * Actions to include inline on hover of the terminal tab. E.g. the \"Rerun task\" action\n\t */\n\ttabActions?: ITerminalTabAction[];\n\t/**\n\t * Report terminal's shell environment variables to VS Code and extensions\n\t */\n\tshellIntegrationEnvironmentReporting?: boolean;\n\n\t/**\n\t * A custom nonce to use for shell integration when provided by an extension.\n\t * This allows extensions to control shell integration for terminals they create.\n\t */\n\tshellIntegrationNonce?: string;\n}\n\nexport interface ITerminalTabAction {\n\tid: string;\n\tlabel: string;\n\ticon?: ThemeIcon;\n}\n\nexport type WaitOnExitValue = boolean | string | ((exitCode: number) => string);\n\nexport interface ICreateContributedTerminalProfileOptions {\n\ticon?: URI | string | { light: URI; dark: URI };\n\tcolor?: string;\n\tlocation?: TerminalLocation | { viewColumn: number; preserveState?: boolean } | { splitActiveTerminal: boolean };\n\tcwd?: string | URI;\n}\n\nexport enum TerminalLocation {\n\tPanel = 1,\n\tEditor = 2\n}\n\nexport const enum TerminalLocationConfigValue {\n\tTerminalView = 'view',\n\tEditor = 'editor'\n}\n\nexport type TerminalIcon = ThemeIcon | URI | { light: URI; dark: URI };\n\nexport interface IShellLaunchConfigDto {\n\tname?: string;\n\texecutable?: string;\n\targs?: string[] | string;\n\tcwd?: string | UriComponents;\n\tenv?: ITerminalEnvironment;\n\tuseShellEnvironment?: boolean;\n\thideFromUser?: boolean;\n\treconnectionProperties?: IReconnectionProperties;\n\ttype?: 'Task' | 'Local';\n\tisFeatureTerminal?: boolean;\n\ttabActions?: ITerminalTabAction[];\n\tshellIntegrationEnvironmentReporting?: boolean;\n}\n\n/**\n * A set of options for the terminal process. These differ from the shell launch config in that they\n * are set internally to the terminal component, not from the outside.\n */\nexport interface ITerminalProcessOptions {\n\tshellIntegration: {\n\t\tenabled: boolean;\n\t\tsuggestEnabled: boolean;\n\t\tnonce: string;\n\t};\n\twindowsEnableConpty: boolean;\n\twindowsUseConptyDll: boolean;\n\tenvironmentVariableCollections: ISerializableEnvironmentVariableCollections | undefined;\n\tworkspaceFolder: IWorkspaceFolder | undefined;\n\tisScreenReaderOptimized: boolean;\n}\n\nexport interface ITerminalEnvironment {\n\t[key: string]: string | null | undefined;\n}\n\nexport interface ITerminalLaunchError {\n\tmessage: string;\n\tcode?: number;\n}\n\nexport interface IProcessReadyEvent {\n\tpid: number;\n\tcwd: string;\n\twindowsPty: IProcessReadyWindowsPty | undefined;\n}\n\nexport interface IProcessReadyWindowsPty {\n\t/**\n\t * What pty emulation backend is being used.\n\t */\n\tbackend: 'conpty' | 'winpty';\n\t/**\n\t * The Windows build version (eg. 19045)\n\t */\n\tbuildNumber: number;\n}\n\n/**\n * An interface representing a raw terminal child process, this contains a subset of the\n * child_process.ChildProcess node.js interface.\n */\nexport interface ITerminalChildProcess {\n\t/**\n\t * A unique identifier for the terminal process. Note that the uniqueness only applies to a\n\t * given pty service connection, IDs will be duplicated for remote and local terminals for\n\t * example. The ID will be 0 if it does not support reconnection.\n\t */\n\tid: number;\n\n\t/**\n\t * Whether the process should be persisted across reloads.\n\t */\n\tshouldPersist: boolean;\n\n\treadonly onProcessData: Event<IProcessDataEvent | string>;\n\treadonly onProcessReady: Event<IProcessReadyEvent>;\n\treadonly onProcessReplayComplete?: Event<void>;\n\treadonly onDidChangeProperty: Event<IProcessProperty>;\n\treadonly onProcessExit: Event<number | undefined>;\n\treadonly onRestoreCommands?: Event<ISerializedCommandDetectionCapability>;\n\n\t/**\n\t * Starts the process.\n\t *\n\t * @returns undefined when the process was successfully started, otherwise an object containing\n\t * information on what went wrong.\n\t */\n\tstart(): Promise<ITerminalLaunchError | ITerminalLaunchResult | undefined>;\n\n\t/**\n\t * Detach the process from the UI and await reconnect.\n\t * @param forcePersist Whether to force the process to persist if it supports persistence.\n\t */\n\tdetach?(forcePersist?: boolean): Promise<void>;\n\n\t/**\n\t * Frees the port and kills the process\n\t */\n\tfreePortKillProcess?(port: string): Promise<{ port: string; processId: string }>;\n\n\t/**\n\t * Shutdown the terminal process.\n\t *\n\t * @param immediate When true the process will be killed immediately, otherwise the process will\n\t * be given some time to make sure no additional data comes through.\n\t */\n\tshutdown(immediate: boolean): void;\n\tinput(data: string): void;\n\tsendSignal(signal: string): void;\n\tprocessBinary(data: string): Promise<void>;\n\tresize(cols: number, rows: number): void;\n\tclearBuffer(): void | Promise<void>;\n\n\t/**\n\t * Acknowledge a data event has been parsed by the terminal, this is used to implement flow\n\t * control to ensure remote processes to not get too far ahead of the client and flood the\n\t * connection.\n\t * @param charCount The number of characters being acknowledged.\n\t */\n\tacknowledgeDataEvent(charCount: number): void;\n\n\t/**\n\t * Sets the unicode version for the process, this drives the size of some characters in the\n\t * xterm-headless instance.\n\t */\n\tsetUnicodeVersion(version: '6' | '11'): Promise<void>;\n\n\tgetInitialCwd(): Promise<string>;\n\tgetCwd(): Promise<string>;\n\trefreshProperty<T extends ProcessPropertyType>(property: T): Promise<IProcessPropertyMap[T]>;\n\tupdateProperty<T extends ProcessPropertyType>(property: T, value: IProcessPropertyMap[T]): Promise<void>;\n}\n\nexport interface IReconnectConstants {\n\tgraceTime: number;\n\tshortGraceTime: number;\n\tscrollback: number;\n}\n\nexport const enum LocalReconnectConstants {\n\t/**\n\t * If there is no reconnection within this time-frame, consider the connection permanently closed...\n\t*/\n\tGraceTime = 60000, // 60 seconds\n\t/**\n\t * Maximal grace time between the first and the last reconnection...\n\t*/\n\tShortGraceTime = 6000, // 6 seconds\n}\n\nexport const enum FlowControlConstants {\n\t/**\n\t * The number of _unacknowledged_ chars to have been sent before the pty is paused in order for\n\t * the client to catch up.\n\t */\n\tHighWatermarkChars = 100000,\n\t/**\n\t * After flow control pauses the pty for the client the catch up, this is the number of\n\t * _unacknowledged_ chars to have been caught up to on the client before resuming the pty again.\n\t * This is used to attempt to prevent pauses in the flowing data; ideally while the pty is\n\t * paused the number of unacknowledged chars would always be greater than 0 or the client will\n\t * appear to stutter. In reality this balance is hard to accomplish though so heavy commands\n\t * will likely pause as latency grows, not flooding the connection is the important thing as\n\t * it's shared with other core functionality.\n\t */\n\tLowWatermarkChars = 5000,\n\t/**\n\t * The number characters that are accumulated on the client side before sending an ack event.\n\t * This must be less than or equal to LowWatermarkChars or the terminal max never unpause.\n\t */\n\tCharCountAckSize = 5000\n}\n\nexport interface IProcessDataEvent {\n\tdata: string;\n\ttrackCommit: boolean;\n\t/**\n\t * When trackCommit is set, this will be set to a promise that resolves when the data is parsed.\n\t */\n\twritePromise?: Promise<void>;\n}\n\nexport interface ITerminalDimensions {\n\t/**\n\t * The columns of the terminal.\n\t */\n\tcols: number;\n\n\t/**\n\t * The rows of the terminal.\n\t */\n\trows: number;\n}\n\nexport interface ITerminalProfile {\n\tprofileName: string;\n\tpath: string;\n\tisDefault: boolean;\n\t/**\n\t * Whether the terminal profile contains a potentially unsafe {@link path}. For example, the path\n\t * `C:\\Cygwin` is the default install for Cygwin on Windows, but it could be created by any\n\t * user in a multi-user environment. As such, we don't want to blindly present it as a profile\n\t * without a warning.\n\t */\n\tisUnsafePath?: boolean;\n\t/**\n\t * An additional unsafe path that must exist, for example a script that appears in {@link args}.\n\t */\n\trequiresUnsafePath?: string;\n\tisAutoDetected?: boolean;\n\t/**\n\t * Whether the profile path was found on the `$PATH` environment variable, if so it will be\n\t * cleaner to display this profile in the UI using only `basename(path)`.\n\t */\n\tisFromPath?: boolean;\n\targs?: SingleOrMany<string> | undefined;\n\tenv?: ITerminalEnvironment;\n\toverrideName?: boolean;\n\tcolor?: string;\n\ticon?: ThemeIcon | URI | { light: URI; dark: URI };\n}\n\nexport interface ITerminalDimensionsOverride extends Readonly<ITerminalDimensions> {\n\t/**\n\t * indicate that xterm must receive these exact dimensions, even if they overflow the ui!\n\t */\n\tforceExactSize?: boolean;\n}\n\nexport const enum ProfileSource {\n\tGitBash = 'Git Bash',\n\tPwsh = 'PowerShell'\n}\n\nexport interface IBaseUnresolvedTerminalProfile {\n\targs?: SingleOrMany<string> | undefined;\n\tisAutoDetected?: boolean;\n\toverrideName?: boolean;\n\ticon?: string | ThemeIcon | URI | { light: URI; dark: URI };\n\tcolor?: string;\n\tenv?: ITerminalEnvironment;\n\trequiresPath?: string | ITerminalUnsafePath;\n}\n\nexport interface ITerminalUnsafePath {\n\tpath: string;\n\tisUnsafe: true;\n}\n\nexport interface ITerminalExecutable extends IBaseUnresolvedTerminalProfile {\n\tpath: SingleOrMany<string | ITerminalUnsafePath>;\n}\n\nexport interface ITerminalProfileSource extends IBaseUnresolvedTerminalProfile {\n\tsource: ProfileSource;\n}\n\nexport interface ITerminalProfileContribution {\n\ttitle: string;\n\tid: string;\n\ticon?: URI | { light: URI; dark: URI } | string;\n\tcolor?: string;\n}\n\nexport interface IExtensionTerminalProfile extends ITerminalProfileContribution {\n\textensionIdentifier: string;\n}\n\nexport type ITerminalProfileObject = ITerminalExecutable | ITerminalProfileSource | IExtensionTerminalProfile | null;\n\nexport interface IShellIntegration {\n\treadonly capabilities: ITerminalCapabilityStore;\n\treadonly seenSequences: ReadonlySet<string>;\n\treadonly status: ShellIntegrationStatus;\n\n\treadonly onDidChangeStatus: Event<ShellIntegrationStatus>;\n\treadonly onDidChangeSeenSequences: Event<ReadonlySet<string>>;\n\n\tdeserialize(serialized: ISerializedCommandDetectionCapability): void;\n\n\tsetNextCommandId(command: string, commandId: string): void;\n}\n\nexport interface IDecorationAddon {\n\tregisterMenuItems(command: ITerminalCommand, items: IAction[]): IDisposable;\n}\n\nexport interface ITerminalCompletionProviderContribution {\n\tdescription?: string;\n}\n\nexport interface ITerminalContributions {\n\tprofiles?: ITerminalProfileContribution[];\n\tcompletionProviders?: ITerminalCompletionProviderContribution[];\n}\n\nexport const enum ShellIntegrationStatus {\n\t/** No shell integration sequences have been encountered. */\n\tOff,\n\t/** Final term shell integration sequences have been encountered. */\n\tFinalTerm,\n\t/** VS Code shell integration sequences have been encountered. Supercedes FinalTerm. */\n\tVSCode\n}\n\n\nexport const enum ShellIntegrationInjectionFailureReason {\n\t/**\n\t * The setting is disabled.\n\t */\n\tInjectionSettingDisabled = 'injectionSettingDisabled',\n\t/**\n\t * There is no executable (so there's no way to determine how to inject).\n\t */\n\tNoExecutable = 'noExecutable',\n\t/**\n\t * It's a feature terminal (tasks, debug), unless it's explicitly being forced.\n\t */\n\tFeatureTerminal = 'featureTerminal',\n\t/**\n\t * The ignoreShellIntegration flag is passed (eg. relaunching without shell integration).\n\t */\n\tIgnoreShellIntegrationFlag = 'ignoreShellIntegrationFlag',\n\t/**\n\t * Shell integration doesn't work with winpty.\n\t */\n\tWinpty = 'winpty',\n\t/**\n\t * We're conservative whether we inject when we don't recognize the arguments used for the\n\t * shell as we would prefer launching one without shell integration than breaking their profile.\n\t */\n\tUnsupportedArgs = 'unsupportedArgs',\n\t/**\n\t * The shell doesn't have built-in shell integration. Note that this doesn't mean the shell\n\t * won't have shell integration in the end.\n\t */\n\tUnsupportedShell = 'unsupportedShell',\n\n\n\t/**\n\t * For zsh, we failed to set the sticky bit on the shell integration script folder.\n\t */\n\tFailedToSetStickyBit = 'failedToSetStickyBit',\n\n\t/**\n\t * For zsh, we failed to create a temp directory for the shell integration script.\n\t */\n\tFailedToCreateTmpDir = 'failedToCreateTmpDir',\n}\n\nexport enum TerminalExitReason {\n\tUnknown = 0,\n\tShutdown = 1,\n\tProcess = 2,\n\tUser = 3,\n\tExtension = 4,\n}\n\nexport interface ITerminalOutputMatch {\n\tregexMatch: RegExpMatchArray;\n\toutputLines: string[];\n}\n\n/**\n * A matcher that runs on a sub-section of a terminal command's output\n */\nexport interface ITerminalOutputMatcher {\n\t/**\n\t * A string or regex to match against the unwrapped line. If this is a regex with the multiline\n\t * flag, it will scan an amount of lines equal to `\\n` instances in the regex + 1.\n\t */\n\tlineMatcher: string | RegExp;\n\t/**\n\t * Which side of the output to anchor the {@link offset} and {@link length} against.\n\t */\n\tanchor: 'top' | 'bottom';\n\t/**\n\t * The number of rows above or below the {@link anchor} to start matching against.\n\t */\n\toffset: number;\n\t/**\n\t * The number of rows to match against, this should be as small as possible for performance\n\t * reasons. This is capped at 40.\n\t */\n\tlength: number;\n\n\t/**\n\t * If multiple matches are expected - this will result in {@link outputLines} being returned\n\t * when there's a {@link regexMatch} from {@link offset} to {@link length}\n\t */\n\tmultipleMatches?: boolean;\n}\n\nexport interface ITerminalCommandSelector {\n\tid: string;\n\tcommandLineMatcher: string | RegExp;\n\toutputMatcher?: ITerminalOutputMatcher;\n\texitStatus: boolean;\n\tcommandExitResult: 'success' | 'error';\n\tkind?: 'fix' | 'explain';\n}\n\nexport interface ITerminalBackend extends ITerminalBackendPtyServiceContributions {\n\treadonly remoteAuthority: string | undefined;\n\n\treadonly isResponsive: boolean;\n\n\t/**\n\t * A promise that resolves when the backend is ready to be used, ie. after terminal persistence\n\t * has been actioned.\n\t */\n\treadonly whenReady: Promise<void>;\n\n\t/**\n\t * Signal to the backend that persistence has been actioned and is ready for use.\n\t */\n\tsetReady(): void;\n\n\t/**\n\t * Fired when the ptyHost process becomes non-responsive, this should disable stdin for all\n\t * terminals using this pty host connection and mark them as disconnected.\n\t */\n\treadonly onPtyHostUnresponsive: Event<void>;\n\t/**\n\t * Fired when the ptyHost process becomes responsive after being non-responsive. Allowing\n\t * previously disconnected terminals to reconnect.\n\t */\n\treadonly onPtyHostResponsive: Event<void>;\n\t/**\n\t * Fired when the ptyHost has been restarted, this is used as a signal for listening terminals\n\t * that its pty has been lost and will remain disconnected.\n\t */\n\treadonly onPtyHostRestart: Event<void>;\n\n\treadonly onDidRequestDetach: Event<{ requestId: number; workspaceId: string; instanceId: number }>;\n\n\tattachToProcess(id: number): Promise<ITerminalChildProcess | undefined>;\n\tattachToRevivedProcess(id: number): Promise<ITerminalChildProcess | undefined>;\n\tlistProcesses(): Promise<IProcessDetails[]>;\n\tgetLatency(): Promise<IPtyHostLatencyMeasurement[]>;\n\tgetDefaultSystemShell(osOverride?: OperatingSystem): Promise<string>;\n\tgetProfiles(profiles: unknown, defaultProfile: unknown, includeDetectedProfiles?: boolean): Promise<ITerminalProfile[]>;\n\tgetWslPath(original: string, direction: 'unix-to-win' | 'win-to-unix'): Promise<string>;\n\tgetEnvironment(): Promise<IProcessEnvironment>;\n\tgetShellEnvironment(): Promise<IProcessEnvironment | undefined>;\n\tsetTerminalLayoutInfo(layoutInfo?: ITerminalsLayoutInfoById): Promise<void>;\n\tupdateTitle(id: number, title: string, titleSource: TitleEventSource): Promise<void>;\n\tupdateIcon(id: number, userInitiated: boolean, icon: TerminalIcon, color?: string): Promise<void>;\n\tsetNextCommandId(id: number, commandLine: string, commandId: string): Promise<void>;\n\tgetTerminalLayoutInfo(): Promise<ITerminalsLayoutInfo | undefined>;\n\tgetPerformanceMarks(): Promise<performance.PerformanceMark[]>;\n\treduceConnectionGraceTime(): Promise<void>;\n\trequestDetachInstance(workspaceId: string, instanceId: number): Promise<IProcessDetails | undefined>;\n\tacceptDetachInstanceReply(requestId: number, persistentProcessId?: number): Promise<void>;\n\tpersistTerminalState(): Promise<void>;\n\n\tcreateProcess(\n\t\tshellLaunchConfig: IShellLaunchConfig,\n\t\tcwd: string,\n\t\tcols: number,\n\t\trows: number,\n\t\tunicodeVersion: '6' | '11',\n\t\tenv: IProcessEnvironment,\n\t\toptions: ITerminalProcessOptions,\n\t\tshouldPersist: boolean\n\t): Promise<ITerminalChildProcess>;\n\n\trestartPtyHost(): void;\n}\n\nexport interface ITerminalBackendPtyServiceContributions {\n\tinstallAutoReply(match: string, reply: string): Promise<void>;\n\tuninstallAllAutoReplies(): Promise<void>;\n}\n\nexport const TerminalExtensions = {\n\tBackend: 'workbench.contributions.terminal.processBackend'\n};\n\nexport interface ITerminalBackendRegistry {\n\t/**\n\t * Gets all backends in the registry.\n\t */\n\tbackends: ReadonlyMap<string, ITerminalBackend>;\n\n\t/**\n\t * Registers a terminal backend for a remote authority.\n\t */\n\tregisterTerminalBackend(backend: ITerminalBackend): void;\n\n\t/**\n\t * Returns the registered terminal backend for a remote authority.\n\t */\n\tgetTerminalBackend(remoteAuthority?: string): ITerminalBackend | undefined;\n}\n\nclass TerminalBackendRegistry implements ITerminalBackendRegistry {\n\tprivate readonly _backends = new Map<string, ITerminalBackend>();\n\n\tget backends(): ReadonlyMap<string, ITerminalBackend> { return this._backends; }\n\n\tregisterTerminalBackend(backend: ITerminalBackend): void {\n\t\tconst key = this._sanitizeRemoteAuthority(backend.remoteAuthority);\n\t\tif (this._backends.has(key)) {\n\t\t\tthrow new Error(`A terminal backend with remote authority '${key}' was already registered.`);\n\t\t}\n\t\tthis._backends.set(key, backend);\n\t}\n\n\tgetTerminalBackend(remoteAuthority: string | undefined): ITerminalBackend | undefined {\n\t\treturn this._backends.get(this._sanitizeRemoteAuthority(remoteAuthority));\n\t}\n\n\tprivate _sanitizeRemoteAuthority(remoteAuthority: string | undefined) {\n\t\t// Normalize the key to lowercase as the authority is case-insensitive\n\t\treturn remoteAuthority?.toLowerCase() ?? '';\n\t}\n}\nRegistry.add(TerminalExtensions.Backend, new TerminalBackendRegistry());\n\nexport const ILocalPtyService = createDecorator<ILocalPtyService>('localPtyService');\n\n/**\n * A service responsible for communicating with the pty host process on Electron.\n *\n * **This service should only be used within the terminal component.**\n */\nexport interface ILocalPtyService extends IPtyHostService { }\n\nexport const ITerminalLogService = createDecorator<ITerminalLogService>('terminalLogService');\nexport interface ITerminalLogService extends ILogService {\n\t/**\n\t * Similar to _serviceBrand but used to differentiate this service at compile time from\n\t * ILogService; ITerminalLogService is an ILogService, but ILogService is not an\n\t * ITerminalLogService.\n\t */\n\treadonly _logBrand: undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { HeartbeatConstants, IHeartbeatService } from '../common/terminal.js';\n\nexport class HeartbeatService extends Disposable implements IHeartbeatService {\n\tprivate readonly _onBeat = this._register(new Emitter<void>());\n\treadonly onBeat = this._onBeat.event;\n\n\tconstructor() {\n\t\tsuper();\n\n\t\tconst interval = setInterval(() => {\n\t\t\tthis._onBeat.fire();\n\t\t}, HeartbeatConstants.BeatInterval);\n\t\tthis._register(toDisposable(() => clearInterval(interval)));\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { execFile, exec } from 'child_process';\nimport { AutoOpenBarrier, ProcessTimeRunOnceScheduler, Promises, Queue, timeout } from '../../../base/common/async.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { IProcessEnvironment, isWindows, OperatingSystem, OS } from '../../../base/common/platform.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { getSystemShell } from '../../../base/node/shell.js';\nimport { ILogService, LogLevel } from '../../log/common/log.js';\nimport { RequestStore } from '../common/requestStore.js';\nimport { IProcessDataEvent, IProcessReadyEvent, IPtyService, IRawTerminalInstanceLayoutInfo, IReconnectConstants, IShellLaunchConfig, ITerminalInstanceLayoutInfoById, ITerminalLaunchError, ITerminalsLayoutInfo, ITerminalTabLayoutInfoById, TerminalIcon, IProcessProperty, TitleEventSource, ProcessPropertyType, IProcessPropertyMap, IFixedTerminalDimensions, IPersistentTerminalProcessLaunchConfig, ICrossVersionSerializedTerminalState, ISerializedTerminalState, ITerminalProcessOptions, IPtyHostLatencyMeasurement, type IPtyServiceContribution, PosixShellType, ITerminalLaunchResult } from '../common/terminal.js';\nimport { TerminalDataBufferer } from '../common/terminalDataBuffering.js';\nimport { escapeNonWindowsPath } from '../common/terminalEnvironment.js';\nimport type { ISerializeOptions, SerializeAddon as XtermSerializeAddon } from '@xterm/addon-serialize';\nimport type { Unicode11Addon as XtermUnicode11Addon } from '@xterm/addon-unicode11';\nimport { IGetTerminalLayoutInfoArgs, IProcessDetails, ISetTerminalLayoutInfoArgs, ITerminalTabLayoutInfoDto } from '../common/terminalProcess.js';\nimport { getWindowsBuildNumber } from './terminalEnvironment.js';\nimport { TerminalProcess } from './terminalProcess.js';\nimport { localize } from '../../../nls.js';\nimport { ignoreProcessNames } from './childProcessMonitor.js';\nimport { ErrorNoTelemetry } from '../../../base/common/errors.js';\nimport { ShellIntegrationAddon } from '../common/xterm/shellIntegrationAddon.js';\nimport { formatMessageForTerminal } from '../common/terminalStrings.js';\nimport { IPtyHostProcessReplayEvent } from '../common/capabilities/capabilities.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { join } from '../../../base/common/path.js';\nimport { memoize } from '../../../base/common/decorators.js';\nimport * as performance from '../../../base/common/performance.js';\nimport pkg from '@xterm/headless';\nimport { AutoRepliesPtyServiceContribution } from './terminalContrib/autoReplies/autoRepliesContribController.js';\nimport { hasKey, isFunction, isNumber, isString } from '../../../base/common/types.js';\n\ntype XtermTerminal = pkg.Terminal;\nconst { Terminal: XtermTerminal } = pkg;\n\ninterface ITraceRpcArgs {\n\tlogService: ILogService;\n\tsimulatedLatency: number;\n}\n\nexport function traceRpc(_target: Object, key: string, descriptor: PropertyDescriptor) {\n\tif (!isFunction(descriptor.value)) {\n\t\tthrow new Error('not supported');\n\t}\n\tconst fnKey = 'value';\n\tconst fn = descriptor.value;\n\tdescriptor[fnKey] = async function <TThis extends { traceRpcArgs: ITraceRpcArgs }>(this: TThis, ...args: unknown[]) {\n\t\tif (this.traceRpcArgs.logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis.traceRpcArgs.logService.trace(`[RPC Request] PtyService#${fn.name}(${args.map(e => JSON.stringify(e)).join(', ')})`);\n\t\t}\n\t\tif (this.traceRpcArgs.simulatedLatency) {\n\t\t\tawait timeout(this.traceRpcArgs.simulatedLatency);\n\t\t}\n\t\tlet result: unknown;\n\t\ttry {\n\t\t\tresult = await fn.apply(this, args);\n\t\t} catch (e) {\n\t\t\tthis.traceRpcArgs.logService.error(`[RPC Response] PtyService#${fn.name}`, e);\n\t\t\tthrow e;\n\t\t}\n\t\tif (this.traceRpcArgs.logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis.traceRpcArgs.logService.trace(`[RPC Response] PtyService#${fn.name}`, result);\n\t\t}\n\t\treturn result;\n\t};\n}\n\ntype WorkspaceId = string;\n\nlet SerializeAddon: typeof XtermSerializeAddon;\nlet Unicode11Addon: typeof XtermUnicode11Addon;\n\nexport class PtyService extends Disposable implements IPtyService {\n\tdeclare readonly _serviceBrand: undefined;\n\n\tprivate readonly _ptys: Map<number, PersistentTerminalProcess> = new Map();\n\tprivate readonly _workspaceLayoutInfos = new Map<WorkspaceId, ISetTerminalLayoutInfoArgs>();\n\tprivate readonly _detachInstanceRequestStore: RequestStore<IProcessDetails | undefined, { workspaceId: string; instanceId: number }>;\n\tprivate readonly _revivedPtyIdMap: Map<string, { newId: number; state: ISerializedTerminalState }> = new Map();\n\n\t// #region Pty service contribution RPC calls\n\n\tprivate readonly _autoRepliesContribution: AutoRepliesPtyServiceContribution;\n\t@traceRpc\n\tasync installAutoReply(match: string, reply: string) {\n\t\tawait this._autoRepliesContribution.installAutoReply(match, reply);\n\t}\n\t@traceRpc\n\tasync uninstallAllAutoReplies() {\n\t\tawait this._autoRepliesContribution.uninstallAllAutoReplies();\n\t}\n\n\t// #endregion\n\n\tprivate readonly _contributions: IPtyServiceContribution[];\n\n\tprivate _lastPtyId: number = 0;\n\n\tprivate readonly _onHeartbeat = this._register(new Emitter<void>());\n\treadonly onHeartbeat = this._traceEvent('_onHeartbeat', this._onHeartbeat.event);\n\n\tprivate readonly _onProcessData = this._register(new Emitter<{ id: number; event: IProcessDataEvent | string }>());\n\treadonly onProcessData = this._traceEvent('_onProcessData', this._onProcessData.event);\n\tprivate readonly _onProcessReplay = this._register(new Emitter<{ id: number; event: IPtyHostProcessReplayEvent }>());\n\treadonly onProcessReplay = this._traceEvent('_onProcessReplay', this._onProcessReplay.event);\n\tprivate readonly _onProcessReady = this._register(new Emitter<{ id: number; event: IProcessReadyEvent }>());\n\treadonly onProcessReady = this._traceEvent('_onProcessReady', this._onProcessReady.event);\n\tprivate readonly _onProcessExit = this._register(new Emitter<{ id: number; event: number | undefined }>());\n\treadonly onProcessExit = this._traceEvent('_onProcessExit', this._onProcessExit.event);\n\tprivate readonly _onProcessOrphanQuestion = this._register(new Emitter<{ id: number }>());\n\treadonly onProcessOrphanQuestion = this._traceEvent('_onProcessOrphanQuestion', this._onProcessOrphanQuestion.event);\n\tprivate readonly _onDidRequestDetach = this._register(new Emitter<{ requestId: number; workspaceId: string; instanceId: number }>());\n\treadonly onDidRequestDetach = this._traceEvent('_onDidRequestDetach', this._onDidRequestDetach.event);\n\tprivate readonly _onDidChangeProperty = this._register(new Emitter<{ id: number; property: IProcessProperty }>());\n\treadonly onDidChangeProperty = this._traceEvent('_onDidChangeProperty', this._onDidChangeProperty.event);\n\n\tprivate _traceEvent<T>(name: string, event: Event<T>): Event<T> {\n\t\tevent(e => {\n\t\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\t\tthis._logService.trace(`[RPC Event] PtyService#${name}.fire(${JSON.stringify(e)})`);\n\t\t\t}\n\t\t});\n\t\treturn event;\n\t}\n\n\t@memoize\n\tget traceRpcArgs(): ITraceRpcArgs {\n\t\treturn {\n\t\t\tlogService: this._logService,\n\t\t\tsimulatedLatency: this._simulatedLatency\n\t\t};\n\t}\n\n\tconstructor(\n\t\tprivate readonly _logService: ILogService,\n\t\tprivate readonly _productService: IProductService,\n\t\tprivate readonly _reconnectConstants: IReconnectConstants,\n\t\tprivate readonly _simulatedLatency: number\n\t) {\n\t\tsuper();\n\n\t\tthis._register(toDisposable(() => {\n\t\t\tfor (const pty of this._ptys.values()) {\n\t\t\t\tpty.shutdown(true);\n\t\t\t}\n\t\t\tthis._ptys.clear();\n\t\t}));\n\n\t\tthis._detachInstanceRequestStore = this._register(new RequestStore(undefined, this._logService));\n\t\tthis._detachInstanceRequestStore.onCreateRequest(this._onDidRequestDetach.fire, this._onDidRequestDetach);\n\n\t\tthis._autoRepliesContribution = new AutoRepliesPtyServiceContribution(this._logService);\n\n\t\tthis._contributions = [this._autoRepliesContribution];\n\n\t}\n\n\t@traceRpc\n\tasync refreshIgnoreProcessNames(names: string[]): Promise<void> {\n\t\tignoreProcessNames.length = 0;\n\t\tignoreProcessNames.push(...names);\n\t}\n\n\t@traceRpc\n\tasync requestDetachInstance(workspaceId: string, instanceId: number): Promise<IProcessDetails | undefined> {\n\t\treturn this._detachInstanceRequestStore.createRequest({ workspaceId, instanceId });\n\t}\n\n\t@traceRpc\n\tasync acceptDetachInstanceReply(requestId: number, persistentProcessId: number): Promise<void> {\n\t\tlet processDetails: IProcessDetails | undefined = undefined;\n\t\tconst pty = this._ptys.get(persistentProcessId);\n\t\tif (pty) {\n\t\t\tprocessDetails = await this._buildProcessDetails(persistentProcessId, pty);\n\t\t}\n\t\tthis._detachInstanceRequestStore.acceptReply(requestId, processDetails);\n\t}\n\n\t@traceRpc\n\tasync freePortKillProcess(port: string): Promise<{ port: string; processId: string }> {\n\t\tconst stdout = await new Promise<string>((resolve, reject) => {\n\t\t\texec(isWindows ? `netstat -ano | findstr \"${port}\"` : `lsof -nP -iTCP -sTCP:LISTEN | grep ${port}`, {}, (err, stdout) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn reject('Problem occurred when listing active processes');\n\t\t\t\t}\n\t\t\t\tresolve(stdout);\n\t\t\t});\n\t\t});\n\t\tconst processesForPort = stdout.split(/\\r?\\n/).filter(s => !!s.trim());\n\t\tif (processesForPort.length >= 1) {\n\t\t\tconst capturePid = /\\s+(\\d+)(?:\\s+|$)/;\n\t\t\tconst processId = processesForPort[0].match(capturePid)?.[1];\n\t\t\tif (processId) {\n\t\t\t\ttry {\n\t\t\t\t\tprocess.kill(Number.parseInt(processId));\n\t\t\t\t} catch { }\n\t\t\t} else {\n\t\t\t\tthrow new Error(`Processes for port ${port} were not found`);\n\t\t\t}\n\t\t\treturn { port, processId };\n\t\t}\n\t\tthrow new Error(`Could not kill process with port ${port}`);\n\t}\n\n\t@traceRpc\n\tasync serializeTerminalState(ids: number[]): Promise<string> {\n\t\tconst promises: Promise<ISerializedTerminalState>[] = [];\n\t\tfor (const [persistentProcessId, persistentProcess] of this._ptys.entries()) {\n\t\t\t// Only serialize persistent processes that have had data written or performed a replay\n\t\t\tif (persistentProcess.hasWrittenData && ids.indexOf(persistentProcessId) !== -1) {\n\t\t\t\tpromises.push(Promises.withAsyncBody<ISerializedTerminalState>(async r => {\n\t\t\t\t\tr({\n\t\t\t\t\t\tid: persistentProcessId,\n\t\t\t\t\t\tshellLaunchConfig: persistentProcess.shellLaunchConfig,\n\t\t\t\t\t\tprocessDetails: await this._buildProcessDetails(persistentProcessId, persistentProcess),\n\t\t\t\t\t\tprocessLaunchConfig: persistentProcess.processLaunchOptions,\n\t\t\t\t\t\tunicodeVersion: persistentProcess.unicodeVersion,\n\t\t\t\t\t\treplayEvent: await persistentProcess.serializeNormalBuffer(),\n\t\t\t\t\t\ttimestamp: Date.now()\n\t\t\t\t\t});\n\t\t\t\t}));\n\t\t\t}\n\t\t}\n\t\tconst serialized: ICrossVersionSerializedTerminalState = {\n\t\t\tversion: 1,\n\t\t\tstate: await Promise.all(promises)\n\t\t};\n\t\treturn JSON.stringify(serialized);\n\t}\n\n\t@traceRpc\n\tasync reviveTerminalProcesses(workspaceId: string, state: ISerializedTerminalState[], dateTimeFormatLocale: string) {\n\t\tconst promises: Promise<void>[] = [];\n\t\tfor (const terminal of state) {\n\t\t\tpromises.push(this._reviveTerminalProcess(workspaceId, terminal));\n\t\t}\n\t\tawait Promise.all(promises);\n\t}\n\n\tprivate async _reviveTerminalProcess(workspaceId: string, terminal: ISerializedTerminalState): Promise<void> {\n\t\tconst restoreMessage = localize('terminal-history-restored', \"History restored\");\n\n\t\t// Conpty v1.22+ uses passthrough and doesn't reprint the buffer often, this means that when\n\t\t// the terminal is revived, the cursor would be at the bottom of the buffer then when\n\t\t// PSReadLine requests `GetConsoleCursorInfo` it will be handled by conpty itself by design.\n\t\t// This causes the cursor to move to the top into the replayed terminal contents. To avoid\n\t\t// this, the post restore message will print new lines to get a clear viewport and put the\n\t\t// cursor back at to top left.\n\t\tlet postRestoreMessage = '';\n\t\tif (isWindows) {\n\t\t\tconst lastReplayEvent = terminal.replayEvent.events.length > 0 ? terminal.replayEvent.events.at(-1) : undefined;\n\t\t\tif (lastReplayEvent) {\n\t\t\t\tpostRestoreMessage += '\\r\\n'.repeat(lastReplayEvent.rows - 1) + `\\x1b[H`;\n\t\t\t}\n\t\t}\n\n\t\t// TODO: We may at some point want to show date information in a hover via a custom sequence:\n\t\t//   new Date(terminal.timestamp).toLocaleDateString(dateTimeFormatLocale)\n\t\t//   new Date(terminal.timestamp).toLocaleTimeString(dateTimeFormatLocale)\n\t\tconst newId = await this.createProcess(\n\t\t\t{\n\t\t\t\t...terminal.shellLaunchConfig,\n\t\t\t\tcwd: terminal.processDetails.cwd,\n\t\t\t\tcolor: terminal.processDetails.color,\n\t\t\t\ticon: terminal.processDetails.icon,\n\t\t\t\tname: terminal.processDetails.titleSource === TitleEventSource.Api ? terminal.processDetails.title : undefined,\n\t\t\t\tinitialText: terminal.replayEvent.events[0].data + formatMessageForTerminal(restoreMessage, { loudFormatting: true }) + postRestoreMessage\n\t\t\t},\n\t\t\tterminal.processDetails.cwd,\n\t\t\tterminal.replayEvent.events[0].cols,\n\t\t\tterminal.replayEvent.events[0].rows,\n\t\t\tterminal.unicodeVersion,\n\t\t\tterminal.processLaunchConfig.env,\n\t\t\tterminal.processLaunchConfig.executableEnv,\n\t\t\tterminal.processLaunchConfig.options,\n\t\t\ttrue,\n\t\t\tterminal.processDetails.workspaceId,\n\t\t\tterminal.processDetails.workspaceName,\n\t\t\ttrue,\n\t\t\tterminal.replayEvent.events[0].data\n\t\t);\n\t\t// Don't start the process here as there's no terminal to answer CPR\n\t\tconst oldId = this._getRevivingProcessId(workspaceId, terminal.id);\n\t\tthis._revivedPtyIdMap.set(oldId, { newId, state: terminal });\n\t\tthis._logService.info(`Revived process, old id ${oldId} -> new id ${newId}`);\n\t}\n\n\t@traceRpc\n\tasync shutdownAll(): Promise<void> {\n\t\tthis.dispose();\n\t}\n\n\t@traceRpc\n\tasync createProcess(\n\t\tshellLaunchConfig: IShellLaunchConfig,\n\t\tcwd: string,\n\t\tcols: number,\n\t\trows: number,\n\t\tunicodeVersion: '6' | '11',\n\t\tenv: IProcessEnvironment,\n\t\texecutableEnv: IProcessEnvironment,\n\t\toptions: ITerminalProcessOptions,\n\t\tshouldPersist: boolean,\n\t\tworkspaceId: string,\n\t\tworkspaceName: string,\n\t\tisReviving?: boolean,\n\t\trawReviveBuffer?: string\n\t): Promise<number> {\n\t\tif (shellLaunchConfig.attachPersistentProcess) {\n\t\t\tthrow new Error('Attempt to create a process when attach object was provided');\n\t\t}\n\t\tconst id = ++this._lastPtyId;\n\t\tconst process = new TerminalProcess(shellLaunchConfig, cwd, cols, rows, env, executableEnv, options, this._logService, this._productService);\n\t\tconst processLaunchOptions: IPersistentTerminalProcessLaunchConfig = {\n\t\t\tenv,\n\t\t\texecutableEnv,\n\t\t\toptions\n\t\t};\n\t\tconst persistentProcess = new PersistentTerminalProcess(id, process, workspaceId, workspaceName, shouldPersist, cols, rows, processLaunchOptions, unicodeVersion, this._reconnectConstants, this._logService, isReviving && isString(shellLaunchConfig.initialText) ? shellLaunchConfig.initialText : undefined, rawReviveBuffer, shellLaunchConfig.icon, shellLaunchConfig.color, shellLaunchConfig.name, shellLaunchConfig.fixedDimensions);\n\t\tprocess.onProcessExit(event => {\n\t\t\tfor (const contrib of this._contributions) {\n\t\t\t\tcontrib.handleProcessDispose(id);\n\t\t\t}\n\t\t\tpersistentProcess.dispose();\n\t\t\tthis._ptys.delete(id);\n\t\t\tthis._onProcessExit.fire({ id, event });\n\t\t});\n\t\tpersistentProcess.onProcessData(event => this._onProcessData.fire({ id, event }));\n\t\tpersistentProcess.onProcessReplay(event => this._onProcessReplay.fire({ id, event }));\n\t\tpersistentProcess.onProcessReady(event => this._onProcessReady.fire({ id, event }));\n\t\tpersistentProcess.onProcessOrphanQuestion(() => this._onProcessOrphanQuestion.fire({ id }));\n\t\tpersistentProcess.onDidChangeProperty(property => this._onDidChangeProperty.fire({ id, property }));\n\t\tpersistentProcess.onPersistentProcessReady(() => {\n\t\t\tfor (const contrib of this._contributions) {\n\t\t\t\tcontrib.handleProcessReady(id, process);\n\t\t\t}\n\t\t});\n\t\tthis._ptys.set(id, persistentProcess);\n\t\treturn id;\n\t}\n\n\t@traceRpc\n\tasync attachToProcess(id: number): Promise<void> {\n\t\ttry {\n\t\t\tawait this._throwIfNoPty(id).attach();\n\t\t\tthis._logService.info(`Persistent process reconnection \"${id}\"`);\n\t\t} catch (e) {\n\t\t\tthis._logService.warn(`Persistent process reconnection \"${id}\" failed`, e.message);\n\t\t\tthrow e;\n\t\t}\n\t}\n\n\t@traceRpc\n\tasync updateTitle(id: number, title: string, titleSource: TitleEventSource): Promise<void> {\n\t\tthis._throwIfNoPty(id).setTitle(title, titleSource);\n\t}\n\n\t@traceRpc\n\tasync updateIcon(id: number, userInitiated: boolean, icon: URI | { light: URI; dark: URI } | { id: string; color?: { id: string } }, color?: string): Promise<void> {\n\t\tthis._throwIfNoPty(id).setIcon(userInitiated, icon, color);\n\t}\n\n\t@traceRpc\n\tasync clearBuffer(id: number): Promise<void> {\n\t\tthis._throwIfNoPty(id).clearBuffer();\n\t}\n\n\t@traceRpc\n\tasync refreshProperty<T extends ProcessPropertyType>(id: number, type: T): Promise<IProcessPropertyMap[T]> {\n\t\treturn this._throwIfNoPty(id).refreshProperty(type);\n\t}\n\n\t@traceRpc\n\tasync updateProperty<T extends ProcessPropertyType>(id: number, type: T, value: IProcessPropertyMap[T]): Promise<void> {\n\t\treturn this._throwIfNoPty(id).updateProperty(type, value);\n\t}\n\n\t@traceRpc\n\tasync detachFromProcess(id: number, forcePersist?: boolean): Promise<void> {\n\t\treturn this._throwIfNoPty(id).detach(forcePersist);\n\t}\n\n\t@traceRpc\n\tasync reduceConnectionGraceTime(): Promise<void> {\n\t\tfor (const pty of this._ptys.values()) {\n\t\t\tpty.reduceGraceTime();\n\t\t}\n\t}\n\n\t@traceRpc\n\tasync listProcesses(): Promise<IProcessDetails[]> {\n\t\tconst persistentProcesses = Array.from(this._ptys.entries()).filter(([_, pty]) => pty.shouldPersistTerminal);\n\n\t\tthis._logService.info(`Listing ${persistentProcesses.length} persistent terminals, ${this._ptys.size} total terminals`);\n\t\tconst promises = persistentProcesses.map(async ([id, terminalProcessData]) => this._buildProcessDetails(id, terminalProcessData));\n\t\tconst allTerminals = await Promise.all(promises);\n\t\treturn allTerminals.filter(entry => entry.isOrphan);\n\t}\n\n\t@traceRpc\n\tasync getPerformanceMarks(): Promise<performance.PerformanceMark[]> {\n\t\treturn performance.getMarks();\n\t}\n\n\t@traceRpc\n\tasync start(id: number): Promise<ITerminalLaunchError | ITerminalLaunchResult | undefined> {\n\t\tconst pty = this._ptys.get(id);\n\t\treturn pty ? pty.start() : { message: `Could not find pty with id \"${id}\"` };\n\t}\n\n\t@traceRpc\n\tasync shutdown(id: number, immediate: boolean): Promise<void> {\n\t\t// Don't throw if the pty is already shutdown\n\t\treturn this._ptys.get(id)?.shutdown(immediate);\n\t}\n\t@traceRpc\n\tasync input(id: number, data: string): Promise<void> {\n\t\tconst pty = this._throwIfNoPty(id);\n\t\tif (pty) {\n\t\t\tfor (const contrib of this._contributions) {\n\t\t\t\tcontrib.handleProcessInput(id, data);\n\t\t\t}\n\t\t\tpty.input(data);\n\t\t}\n\t}\n\t@traceRpc\n\tasync sendSignal(id: number, signal: string): Promise<void> {\n\t\treturn this._throwIfNoPty(id).sendSignal(signal);\n\t}\n\t@traceRpc\n\tasync processBinary(id: number, data: string): Promise<void> {\n\t\treturn this._throwIfNoPty(id).writeBinary(data);\n\t}\n\t@traceRpc\n\tasync resize(id: number, cols: number, rows: number): Promise<void> {\n\t\tconst pty = this._throwIfNoPty(id);\n\t\tif (pty) {\n\t\t\tfor (const contrib of this._contributions) {\n\t\t\t\tcontrib.handleProcessResize(id, cols, rows);\n\t\t\t}\n\t\t\tpty.resize(cols, rows);\n\t\t}\n\t}\n\t@traceRpc\n\tasync getInitialCwd(id: number): Promise<string> {\n\t\treturn this._throwIfNoPty(id).getInitialCwd();\n\t}\n\t@traceRpc\n\tasync getCwd(id: number): Promise<string> {\n\t\treturn this._throwIfNoPty(id).getCwd();\n\t}\n\t@traceRpc\n\tasync acknowledgeDataEvent(id: number, charCount: number): Promise<void> {\n\t\treturn this._throwIfNoPty(id).acknowledgeDataEvent(charCount);\n\t}\n\t@traceRpc\n\tasync setUnicodeVersion(id: number, version: '6' | '11'): Promise<void> {\n\t\treturn this._throwIfNoPty(id).setUnicodeVersion(version);\n\t}\n\n\t@traceRpc\n\tasync setNextCommandId(id: number, commandLine: string, commandId: string): Promise<void> {\n\t\treturn this._throwIfNoPty(id).setNextCommandId(commandLine, commandId);\n\t}\n\t@traceRpc\n\tasync getLatency(): Promise<IPtyHostLatencyMeasurement[]> {\n\t\treturn [];\n\t}\n\t@traceRpc\n\tasync orphanQuestionReply(id: number): Promise<void> {\n\t\treturn this._throwIfNoPty(id).orphanQuestionReply();\n\t}\n\n\t@traceRpc\n\tasync getDefaultSystemShell(osOverride: OperatingSystem = OS): Promise<string> {\n\t\treturn getSystemShell(osOverride, process.env);\n\t}\n\n\t@traceRpc\n\tasync getEnvironment(): Promise<IProcessEnvironment> {\n\t\treturn { ...process.env };\n\t}\n\n\t@traceRpc\n\tasync getWslPath(original: string, direction: 'unix-to-win' | 'win-to-unix' | unknown): Promise<string> {\n\t\tif (direction === 'win-to-unix') {\n\t\t\tif (!isWindows) {\n\t\t\t\treturn original;\n\t\t\t}\n\t\t\tif (getWindowsBuildNumber() < 17063) {\n\t\t\t\treturn original.replace(/\\\\/g, '/');\n\t\t\t}\n\t\t\tconst wslExecutable = this._getWSLExecutablePath();\n\t\t\tif (!wslExecutable) {\n\t\t\t\treturn original;\n\t\t\t}\n\t\t\treturn new Promise<string>(c => {\n\t\t\t\tconst proc = execFile(wslExecutable, ['-e', 'wslpath', original], {}, (error, stdout, stderr) => {\n\t\t\t\t\tc(error ? original : escapeNonWindowsPath(stdout.trim(), PosixShellType.Bash));\n\t\t\t\t});\n\t\t\t\tproc.stdin!.end();\n\t\t\t});\n\t\t}\n\t\tif (direction === 'unix-to-win') {\n\t\t\t// The backend is Windows, for example a local Windows workspace with a wsl session in\n\t\t\t// the terminal.\n\t\t\tif (isWindows) {\n\t\t\t\tif (getWindowsBuildNumber() < 17063) {\n\t\t\t\t\treturn original;\n\t\t\t\t}\n\t\t\t\tconst wslExecutable = this._getWSLExecutablePath();\n\t\t\t\tif (!wslExecutable) {\n\t\t\t\t\treturn original;\n\t\t\t\t}\n\t\t\t\treturn new Promise<string>(c => {\n\t\t\t\t\tconst proc = execFile(wslExecutable, ['-e', 'wslpath', '-w', original], {}, (error, stdout, stderr) => {\n\t\t\t\t\t\tc(error ? original : stdout.trim());\n\t\t\t\t\t});\n\t\t\t\t\tproc.stdin!.end();\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\t\t// Fallback just in case\n\t\treturn original;\n\t}\n\n\tprivate _getWSLExecutablePath(): string | undefined {\n\t\tconst useWSLexe = getWindowsBuildNumber() >= 16299;\n\t\tconst is32ProcessOn64Windows = process.env.hasOwnProperty('PROCESSOR_ARCHITEW6432');\n\t\tconst systemRoot = process.env['SystemRoot'];\n\t\tif (systemRoot) {\n\t\t\treturn join(systemRoot, is32ProcessOn64Windows ? 'Sysnative' : 'System32', useWSLexe ? 'wsl.exe' : 'bash.exe');\n\t\t}\n\t\treturn undefined;\n\t}\n\n\t@traceRpc\n\tasync getRevivedPtyNewId(workspaceId: string, id: number): Promise<number | undefined> {\n\t\ttry {\n\t\t\treturn this._revivedPtyIdMap.get(this._getRevivingProcessId(workspaceId, id))?.newId;\n\t\t} catch (e) {\n\t\t\tthis._logService.warn(`Couldn't find terminal ID ${workspaceId}-${id}`, e.message);\n\t\t}\n\t\treturn undefined;\n\t}\n\n\t@traceRpc\n\tasync setTerminalLayoutInfo(args: ISetTerminalLayoutInfoArgs): Promise<void> {\n\t\tthis._workspaceLayoutInfos.set(args.workspaceId, args);\n\t}\n\n\t@traceRpc\n\tasync getTerminalLayoutInfo(args: IGetTerminalLayoutInfoArgs): Promise<ITerminalsLayoutInfo | undefined> {\n\t\tperformance.mark('code/willGetTerminalLayoutInfo');\n\t\tconst layout = this._workspaceLayoutInfos.get(args.workspaceId);\n\t\tif (layout) {\n\t\t\tconst doneSet: Set<number> = new Set();\n\t\t\tconst expandedTabs = await Promise.all(layout.tabs.map(async tab => this._expandTerminalTab(args.workspaceId, tab, doneSet)));\n\t\t\tconst tabs = expandedTabs.filter(t => t.terminals.length > 0);\n\t\t\tconst expandedBackground = (await Promise.all(layout.background?.map(b => this._expandTerminalInstance(args.workspaceId, b, doneSet)) ?? [])).filter(b => b.terminal !== null).map(b => b.terminal);\n\t\t\tperformance.mark('code/didGetTerminalLayoutInfo');\n\t\t\treturn { tabs, background: expandedBackground };\n\t\t}\n\t\tperformance.mark('code/didGetTerminalLayoutInfo');\n\t\treturn undefined;\n\t}\n\n\tprivate async _expandTerminalTab(workspaceId: string, tab: ITerminalTabLayoutInfoById, doneSet: Set<number>): Promise<ITerminalTabLayoutInfoDto> {\n\t\tconst expandedTerminals = (await Promise.all(tab.terminals.map(t => this._expandTerminalInstance(workspaceId, t, doneSet))));\n\t\tconst filtered = expandedTerminals.filter(term => term.terminal !== null) as IRawTerminalInstanceLayoutInfo<IProcessDetails>[];\n\t\treturn {\n\t\t\tisActive: tab.isActive,\n\t\t\tactivePersistentProcessId: tab.activePersistentProcessId,\n\t\t\tterminals: filtered\n\t\t};\n\t}\n\n\tprivate async _expandTerminalInstance(workspaceId: string, t: ITerminalInstanceLayoutInfoById | number, doneSet: Set<number>): Promise<IRawTerminalInstanceLayoutInfo<IProcessDetails | null>> {\n\t\tconst hasLayout = !isNumber(t);\n\t\tconst ptyId = hasLayout ? t.terminal : t;\n\t\ttry {\n\t\t\tconst oldId = this._getRevivingProcessId(workspaceId, ptyId);\n\t\t\tconst revivedPtyId = this._revivedPtyIdMap.get(oldId)?.newId;\n\t\t\tthis._logService.info(`Expanding terminal instance, old id ${oldId} -> new id ${revivedPtyId}`);\n\t\t\tthis._revivedPtyIdMap.delete(oldId);\n\t\t\tconst persistentProcessId = revivedPtyId ?? ptyId;\n\t\t\tif (doneSet.has(persistentProcessId)) {\n\t\t\t\tthrow new Error(`Terminal ${persistentProcessId} has already been expanded`);\n\t\t\t}\n\t\t\tdoneSet.add(persistentProcessId);\n\t\t\tconst persistentProcess = this._throwIfNoPty(persistentProcessId);\n\t\t\tconst processDetails = persistentProcess && await this._buildProcessDetails(ptyId, persistentProcess, revivedPtyId !== undefined);\n\t\t\treturn {\n\t\t\t\tterminal: { ...processDetails, id: persistentProcessId },\n\t\t\t\trelativeSize: hasLayout ? t.relativeSize : 0\n\t\t\t};\n\t\t} catch (e) {\n\t\t\tthis._logService.warn(`Couldn't get layout info, a terminal was probably disconnected`, e.message);\n\t\t\tthis._logService.debug('Reattach to wrong terminal debug info - layout info by id', t);\n\t\t\tthis._logService.debug('Reattach to wrong terminal debug info - _revivePtyIdMap', Array.from(this._revivedPtyIdMap.values()));\n\t\t\tthis._logService.debug('Reattach to wrong terminal debug info - _ptys ids', Array.from(this._ptys.keys()));\n\t\t\t// this will be filtered out and not reconnected\n\t\t\treturn {\n\t\t\t\tterminal: null,\n\t\t\t\trelativeSize: hasLayout ? t.relativeSize : 0\n\t\t\t};\n\t\t}\n\t}\n\n\tprivate _getRevivingProcessId(workspaceId: string, ptyId: number): string {\n\t\treturn `${workspaceId}-${ptyId}`;\n\t}\n\n\tprivate async _buildProcessDetails(id: number, persistentProcess: PersistentTerminalProcess, wasRevived: boolean = false): Promise<IProcessDetails> {\n\t\tperformance.mark(`code/willBuildProcessDetails/${id}`);\n\t\t// If the process was just revived, don't do the orphan check as it will\n\t\t// take some time\n\t\tconst [cwd, isOrphan] = await Promise.all([persistentProcess.getCwd(), wasRevived ? true : persistentProcess.isOrphaned()]);\n\t\tconst result = {\n\t\t\tid,\n\t\t\ttitle: persistentProcess.title,\n\t\t\ttitleSource: persistentProcess.titleSource,\n\t\t\tpid: persistentProcess.pid,\n\t\t\tworkspaceId: persistentProcess.workspaceId,\n\t\t\tworkspaceName: persistentProcess.workspaceName,\n\t\t\tcwd,\n\t\t\tisOrphan,\n\t\t\ticon: persistentProcess.icon,\n\t\t\tcolor: persistentProcess.color,\n\t\t\tfixedDimensions: persistentProcess.fixedDimensions,\n\t\t\tenvironmentVariableCollections: persistentProcess.processLaunchOptions.options.environmentVariableCollections,\n\t\t\treconnectionProperties: persistentProcess.shellLaunchConfig.reconnectionProperties,\n\t\t\twaitOnExit: persistentProcess.shellLaunchConfig.waitOnExit,\n\t\t\thideFromUser: persistentProcess.shellLaunchConfig.hideFromUser,\n\t\t\tisFeatureTerminal: persistentProcess.shellLaunchConfig.isFeatureTerminal,\n\t\t\ttype: persistentProcess.shellLaunchConfig.type,\n\t\t\thasChildProcesses: persistentProcess.hasChildProcesses,\n\t\t\tshellIntegrationNonce: persistentProcess.processLaunchOptions.options.shellIntegration.nonce,\n\t\t\ttabActions: persistentProcess.shellLaunchConfig.tabActions\n\t\t};\n\t\tperformance.mark(`code/didBuildProcessDetails/${id}`);\n\t\treturn result;\n\t}\n\n\tprivate _throwIfNoPty(id: number): PersistentTerminalProcess {\n\t\tconst pty = this._ptys.get(id);\n\t\tif (!pty) {\n\t\t\tthrow new ErrorNoTelemetry(`Could not find pty ${id} on pty host`);\n\t\t}\n\t\treturn pty;\n\t}\n}\n\nconst enum InteractionState {\n\t/** The terminal has not been interacted with. */\n\tNone = 'None',\n\t/** The terminal has only been interacted with by the replay mechanism. */\n\tReplayOnly = 'ReplayOnly',\n\t/** The terminal has been directly interacted with this session. */\n\tSession = 'Session'\n}\n\nclass PersistentTerminalProcess extends Disposable {\n\n\tprivate readonly _bufferer: TerminalDataBufferer;\n\n\tprivate readonly _pendingCommands = new Map<number, { resolve: (data: unknown) => void; reject: (err: unknown) => void }>();\n\n\tprivate _isStarted: boolean = false;\n\tprivate _interactionState: MutationLogger<InteractionState>;\n\n\tprivate _orphanQuestionBarrier: AutoOpenBarrier | null;\n\tprivate _orphanQuestionReplyTime: number;\n\tprivate _orphanRequestQueue = new Queue<boolean>();\n\tprivate _disconnectRunner1: ProcessTimeRunOnceScheduler;\n\tprivate _disconnectRunner2: ProcessTimeRunOnceScheduler;\n\n\tprivate readonly _onProcessReplay = this._register(new Emitter<IPtyHostProcessReplayEvent>());\n\treadonly onProcessReplay = this._onProcessReplay.event;\n\tprivate readonly _onProcessReady = this._register(new Emitter<IProcessReadyEvent>());\n\treadonly onProcessReady = this._onProcessReady.event;\n\tprivate readonly _onPersistentProcessReady = this._register(new Emitter<void>());\n\t/** Fired when the persistent process has a ready process and has finished its replay. */\n\treadonly onPersistentProcessReady = this._onPersistentProcessReady.event;\n\tprivate readonly _onProcessData = this._register(new Emitter<string>());\n\treadonly onProcessData = this._onProcessData.event;\n\tprivate readonly _onProcessOrphanQuestion = this._register(new Emitter<void>());\n\treadonly onProcessOrphanQuestion = this._onProcessOrphanQuestion.event;\n\tprivate readonly _onDidChangeProperty = this._register(new Emitter<IProcessProperty>());\n\treadonly onDidChangeProperty = this._onDidChangeProperty.event;\n\n\tprivate _inReplay = false;\n\n\tprivate _pid = -1;\n\tprivate _cwd = '';\n\tprivate _title: string | undefined;\n\tprivate _titleSource: TitleEventSource = TitleEventSource.Process;\n\tprivate _serializer: ITerminalSerializer;\n\tprivate _wasRevived: boolean;\n\tprivate _fixedDimensions: IFixedTerminalDimensions | undefined;\n\n\tget pid(): number { return this._pid; }\n\tget shellLaunchConfig(): IShellLaunchConfig { return this._terminalProcess.shellLaunchConfig; }\n\tget hasWrittenData(): boolean { return this._interactionState.value !== InteractionState.None; }\n\tget title(): string { return this._title || this._terminalProcess.currentTitle; }\n\tget titleSource(): TitleEventSource { return this._titleSource; }\n\tget icon(): TerminalIcon | undefined { return this._icon; }\n\tget color(): string | undefined { return this._color; }\n\tget fixedDimensions(): IFixedTerminalDimensions | undefined { return this._fixedDimensions; }\n\tget hasChildProcesses(): boolean { return this._terminalProcess.hasChildProcesses; }\n\n\tsetTitle(title: string, titleSource: TitleEventSource): void {\n\t\tif (titleSource === TitleEventSource.Api) {\n\t\t\tthis._interactionState.setValue(InteractionState.Session, 'setTitle');\n\t\t\tthis._serializer.freeRawReviveBuffer();\n\t\t}\n\t\tthis._title = title;\n\t\tthis._titleSource = titleSource;\n\t}\n\n\tsetIcon(userInitiated: boolean, icon: TerminalIcon, color?: string): void {\n\t\tif (!this._icon || hasKey(icon, { id: true }) && hasKey(this._icon, { id: true }) && icon.id !== this._icon.id ||\n\t\t\t!this.color || color !== this._color) {\n\n\t\t\tthis._serializer.freeRawReviveBuffer();\n\t\t\tif (userInitiated) {\n\t\t\t\tthis._interactionState.setValue(InteractionState.Session, 'setIcon');\n\t\t\t}\n\t\t}\n\t\tthis._icon = icon;\n\t\tthis._color = color;\n\t}\n\n\tprivate _setFixedDimensions(fixedDimensions?: IFixedTerminalDimensions): void {\n\t\tthis._fixedDimensions = fixedDimensions;\n\t}\n\n\tconstructor(\n\t\tprivate _persistentProcessId: number,\n\t\tprivate readonly _terminalProcess: TerminalProcess,\n\t\treadonly workspaceId: string,\n\t\treadonly workspaceName: string,\n\t\treadonly shouldPersistTerminal: boolean,\n\t\tcols: number,\n\t\trows: number,\n\t\treadonly processLaunchOptions: IPersistentTerminalProcessLaunchConfig,\n\t\tpublic unicodeVersion: '6' | '11',\n\t\treconnectConstants: IReconnectConstants,\n\t\tprivate readonly _logService: ILogService,\n\t\treviveBuffer: string | undefined,\n\t\trawReviveBuffer: string | undefined,\n\t\tprivate _icon?: TerminalIcon,\n\t\tprivate _color?: string,\n\t\tname?: string,\n\t\tfixedDimensions?: IFixedTerminalDimensions\n\t) {\n\t\tsuper();\n\t\tthis._interactionState = new MutationLogger(`Persistent process \"${this._persistentProcessId}\" interaction state`, InteractionState.None, this._logService);\n\t\tthis._wasRevived = reviveBuffer !== undefined;\n\t\tthis._serializer = new XtermSerializer(\n\t\t\tcols,\n\t\t\trows,\n\t\t\treconnectConstants.scrollback,\n\t\t\tunicodeVersion,\n\t\t\treviveBuffer,\n\t\t\tprocessLaunchOptions.options.shellIntegration.nonce,\n\t\t\tshouldPersistTerminal ? rawReviveBuffer : undefined,\n\t\t\tthis._logService\n\t\t);\n\t\tif (name) {\n\t\t\tthis.setTitle(name, TitleEventSource.Api);\n\t\t}\n\t\tthis._fixedDimensions = fixedDimensions;\n\t\tthis._orphanQuestionBarrier = null;\n\t\tthis._orphanQuestionReplyTime = 0;\n\t\tthis._disconnectRunner1 = this._register(new ProcessTimeRunOnceScheduler(() => {\n\t\t\tthis._logService.info(`Persistent process \"${this._persistentProcessId}\": The reconnection grace time of ${printTime(reconnectConstants.graceTime)} has expired, shutting down pid \"${this._pid}\"`);\n\t\t\tthis.shutdown(true);\n\t\t}, reconnectConstants.graceTime));\n\t\tthis._disconnectRunner2 = this._register(new ProcessTimeRunOnceScheduler(() => {\n\t\t\tthis._logService.info(`Persistent process \"${this._persistentProcessId}\": The short reconnection grace time of ${printTime(reconnectConstants.shortGraceTime)} has expired, shutting down pid ${this._pid}`);\n\t\t\tthis.shutdown(true);\n\t\t}, reconnectConstants.shortGraceTime));\n\t\tthis._register(this._terminalProcess.onProcessExit(() => this._bufferer.stopBuffering(this._persistentProcessId)));\n\t\tthis._register(this._terminalProcess.onProcessReady(e => {\n\t\t\tthis._pid = e.pid;\n\t\t\tthis._cwd = e.cwd;\n\t\t\tthis._onProcessReady.fire(e);\n\t\t}));\n\t\tthis._register(this._terminalProcess.onDidChangeProperty(e => {\n\t\t\tthis._onDidChangeProperty.fire(e);\n\t\t}));\n\n\t\t// Data buffering to reduce the amount of messages going to the renderer\n\t\tthis._bufferer = new TerminalDataBufferer((_, data) => this._onProcessData.fire(data));\n\t\tthis._register(this._bufferer.startBuffering(this._persistentProcessId, this._terminalProcess.onProcessData));\n\n\t\t// Data recording for reconnect\n\t\tthis._register(this.onProcessData(e => this._serializer.handleData(e)));\n\t}\n\n\tasync attach(): Promise<void> {\n\t\tif (!this._disconnectRunner1.isScheduled() && !this._disconnectRunner2.isScheduled()) {\n\t\t\tthis._logService.warn(`Persistent process \"${this._persistentProcessId}\": Process had no disconnect runners but was an orphan`);\n\t\t}\n\t\tthis._disconnectRunner1.cancel();\n\t\tthis._disconnectRunner2.cancel();\n\t}\n\n\tasync detach(forcePersist?: boolean): Promise<void> {\n\t\t// Keep the process around if it was indicated to persist and it has had some iteraction or\n\t\t// was replayed\n\t\tif (this.shouldPersistTerminal && (this._interactionState.value !== InteractionState.None || forcePersist)) {\n\t\t\tthis._disconnectRunner1.schedule();\n\t\t} else {\n\t\t\tthis.shutdown(true);\n\t\t}\n\t}\n\n\tserializeNormalBuffer(): Promise<IPtyHostProcessReplayEvent> {\n\t\treturn this._serializer.generateReplayEvent(true, this._interactionState.value !== InteractionState.Session);\n\t}\n\n\tasync refreshProperty<T extends ProcessPropertyType>(type: T): Promise<IProcessPropertyMap[T]> {\n\t\treturn this._terminalProcess.refreshProperty(type);\n\t}\n\n\tasync updateProperty<T extends ProcessPropertyType>(type: T, value: IProcessPropertyMap[T]): Promise<void> {\n\t\tif (type === ProcessPropertyType.FixedDimensions) {\n\t\t\treturn this._setFixedDimensions(value as IProcessPropertyMap[ProcessPropertyType.FixedDimensions]);\n\t\t}\n\t}\n\n\tasync start(): Promise<ITerminalLaunchError | ITerminalLaunchResult | undefined> {\n\t\tif (!this._isStarted) {\n\t\t\tconst result = await this._terminalProcess.start();\n\t\t\tif (result && hasKey(result, { message: true })) {\n\t\t\t\t// it's a terminal launch error\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\tthis._isStarted = true;\n\n\t\t\t// If the process was revived, trigger a replay on first start. An alternative approach\n\t\t\t// could be to start it on the pty host before attaching but this fails on Windows as\n\t\t\t// conpty's inherit cursor option which is required, ends up sending DSR CPR which\n\t\t\t// causes conhost to hang when no response is received from the terminal (which wouldn't\n\t\t\t// be attached yet). https://github.com/microsoft/terminal/issues/11213\n\t\t\tif (this._wasRevived) {\n\t\t\t\tthis.triggerReplay();\n\t\t\t} else {\n\t\t\t\tthis._onPersistentProcessReady.fire();\n\t\t\t}\n\t\t\treturn result;\n\t\t}\n\n\t\tthis._onProcessReady.fire({ pid: this._pid, cwd: this._cwd, windowsPty: this._terminalProcess.getWindowsPty() });\n\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.Title, value: this._terminalProcess.currentTitle });\n\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellType, value: this._terminalProcess.shellType });\n\t\tthis.triggerReplay();\n\t\treturn undefined;\n\t}\n\tshutdown(immediate: boolean): void {\n\t\treturn this._terminalProcess.shutdown(immediate);\n\t}\n\tinput(data: string): void {\n\t\tthis._interactionState.setValue(InteractionState.Session, 'input');\n\t\tthis._serializer.freeRawReviveBuffer();\n\t\tif (this._inReplay) {\n\t\t\treturn;\n\t\t}\n\t\treturn this._terminalProcess.input(data);\n\t}\n\tsendSignal(signal: string): void {\n\t\tif (this._inReplay) {\n\t\t\treturn;\n\t\t}\n\t\treturn this._terminalProcess.sendSignal(signal);\n\t}\n\twriteBinary(data: string): Promise<void> {\n\t\treturn this._terminalProcess.processBinary(data);\n\t}\n\tresize(cols: number, rows: number): void {\n\t\tif (this._inReplay) {\n\t\t\treturn;\n\t\t}\n\t\tthis._serializer.handleResize(cols, rows);\n\n\t\t// Buffered events should flush when a resize occurs\n\t\tthis._bufferer.flushBuffer(this._persistentProcessId);\n\n\t\treturn this._terminalProcess.resize(cols, rows);\n\t}\n\tasync clearBuffer(): Promise<void> {\n\t\tthis._serializer.clearBuffer();\n\t\tthis._terminalProcess.clearBuffer();\n\t}\n\tsetUnicodeVersion(version: '6' | '11'): void {\n\t\tthis.unicodeVersion = version;\n\t\tthis._serializer.setUnicodeVersion?.(version);\n\t\t// TODO: Pass in unicode version in ctor\n\t}\n\n\tasync setNextCommandId(commandLine: string, commandId: string): Promise<void> {\n\t\tthis._serializer.setNextCommandId?.(commandLine, commandId);\n\t}\n\n\tacknowledgeDataEvent(charCount: number): void {\n\t\tif (this._inReplay) {\n\t\t\treturn;\n\t\t}\n\t\treturn this._terminalProcess.acknowledgeDataEvent(charCount);\n\t}\n\tgetInitialCwd(): Promise<string> {\n\t\treturn this._terminalProcess.getInitialCwd();\n\t}\n\tgetCwd(): Promise<string> {\n\t\treturn this._terminalProcess.getCwd();\n\t}\n\n\tasync triggerReplay(): Promise<void> {\n\t\tif (this._interactionState.value === InteractionState.None) {\n\t\t\tthis._interactionState.setValue(InteractionState.ReplayOnly, 'triggerReplay');\n\t\t}\n\t\tconst ev = await this._serializer.generateReplayEvent();\n\t\tlet dataLength = 0;\n\t\tfor (const e of ev.events) {\n\t\t\tdataLength += e.data.length;\n\t\t}\n\t\tthis._logService.info(`Persistent process \"${this._persistentProcessId}\": Replaying ${dataLength} chars and ${ev.events.length} size events`);\n\t\tthis._onProcessReplay.fire(ev);\n\t\tthis._terminalProcess.clearUnacknowledgedChars();\n\t\tthis._onPersistentProcessReady.fire();\n\t}\n\n\tsendCommandResult(reqId: number, isError: boolean, serializedPayload: unknown): void {\n\t\tconst data = this._pendingCommands.get(reqId);\n\t\tif (!data) {\n\t\t\treturn;\n\t\t}\n\t\tthis._pendingCommands.delete(reqId);\n\t}\n\n\torphanQuestionReply(): void {\n\t\tthis._orphanQuestionReplyTime = Date.now();\n\t\tif (this._orphanQuestionBarrier) {\n\t\t\tconst barrier = this._orphanQuestionBarrier;\n\t\t\tthis._orphanQuestionBarrier = null;\n\t\t\tbarrier.open();\n\t\t}\n\t}\n\n\treduceGraceTime(): void {\n\t\tif (this._disconnectRunner2.isScheduled()) {\n\t\t\t// we are disconnected and already running the short reconnection timer\n\t\t\treturn;\n\t\t}\n\t\tif (this._disconnectRunner1.isScheduled()) {\n\t\t\t// we are disconnected and running the long reconnection timer\n\t\t\tthis._disconnectRunner2.schedule();\n\t\t}\n\t}\n\n\tasync isOrphaned(): Promise<boolean> {\n\t\treturn await this._orphanRequestQueue.queue(async () => this._isOrphaned());\n\t}\n\n\tprivate async _isOrphaned(): Promise<boolean> {\n\t\t// The process is already known to be orphaned\n\t\tif (this._disconnectRunner1.isScheduled() || this._disconnectRunner2.isScheduled()) {\n\t\t\treturn true;\n\t\t}\n\n\t\t// Ask whether the renderer(s) whether the process is orphaned and await the reply\n\t\tif (!this._orphanQuestionBarrier) {\n\t\t\t// the barrier opens after 4 seconds with or without a reply\n\t\t\tthis._orphanQuestionBarrier = new AutoOpenBarrier(4000);\n\t\t\tthis._orphanQuestionReplyTime = 0;\n\t\t\tthis._onProcessOrphanQuestion.fire();\n\t\t}\n\n\t\tawait this._orphanQuestionBarrier.wait();\n\t\treturn (Date.now() - this._orphanQuestionReplyTime > 500);\n\t}\n}\n\nclass MutationLogger<T> {\n\tget value(): T { return this._value; }\n\tsetValue(value: T, reason: string) {\n\t\tif (this._value !== value) {\n\t\t\tthis._value = value;\n\t\t\tthis._log(reason);\n\t\t}\n\t}\n\n\tconstructor(\n\t\tprivate readonly _name: string,\n\t\tprivate _value: T,\n\t\tprivate readonly _logService: ILogService\n\t) {\n\t\tthis._log('initialized');\n\t}\n\n\tprivate _log(reason: string): void {\n\t\tthis._logService.debug(`MutationLogger \"${this._name}\" set to \"${this._value}\", reason: ${reason}`);\n\t}\n}\n\nclass XtermSerializer implements ITerminalSerializer {\n\tprivate readonly _xterm: XtermTerminal;\n\tprivate readonly _shellIntegrationAddon: ShellIntegrationAddon;\n\tprivate _unicodeAddon?: XtermUnicode11Addon;\n\n\tconstructor(\n\t\tcols: number,\n\t\trows: number,\n\t\tscrollback: number,\n\t\tunicodeVersion: '6' | '11',\n\t\treviveBufferWithRestoreMessage: string | undefined,\n\t\tshellIntegrationNonce: string,\n\t\tprivate _rawReviveBuffer: string | undefined,\n\t\tlogService: ILogService\n\t) {\n\t\tthis._xterm = new XtermTerminal({\n\t\t\tcols,\n\t\t\trows,\n\t\t\tscrollback,\n\t\t\tallowProposedApi: true\n\t\t});\n\t\tif (reviveBufferWithRestoreMessage) {\n\t\t\tthis._xterm.writeln(reviveBufferWithRestoreMessage);\n\t\t}\n\t\tthis.setUnicodeVersion(unicodeVersion);\n\t\tthis._shellIntegrationAddon = new ShellIntegrationAddon(shellIntegrationNonce, true, undefined, undefined, logService);\n\t\tthis._xterm.loadAddon(this._shellIntegrationAddon);\n\t}\n\n\tfreeRawReviveBuffer(): void {\n\t\t// Free the memory of the terminal if it will need to be re-serialized\n\t\tthis._rawReviveBuffer = undefined;\n\t}\n\n\thandleData(data: string): void {\n\t\tthis._xterm.write(data);\n\t}\n\n\thandleResize(cols: number, rows: number): void {\n\t\tthis._xterm.resize(cols, rows);\n\t}\n\n\tclearBuffer(): void {\n\t\tthis._xterm.clear();\n\t}\n\n\tsetNextCommandId(commandLine: string, commandId: string): void {\n\t\tthis._shellIntegrationAddon.setNextCommandId(commandLine, commandId);\n\t}\n\n\tasync generateReplayEvent(normalBufferOnly?: boolean, restoreToLastReviveBuffer?: boolean): Promise<IPtyHostProcessReplayEvent> {\n\t\tconst serialize = new (await this._getSerializeConstructor());\n\t\tthis._xterm.loadAddon(serialize);\n\t\tconst options: ISerializeOptions = {\n\t\t\tscrollback: this._xterm.options.scrollback\n\t\t};\n\t\tif (normalBufferOnly) {\n\t\t\toptions.excludeAltBuffer = true;\n\t\t\toptions.excludeModes = true;\n\t\t}\n\t\tlet serialized: string;\n\t\tif (restoreToLastReviveBuffer && this._rawReviveBuffer) {\n\t\t\tserialized = this._rawReviveBuffer;\n\t\t} else {\n\t\t\tserialized = serialize.serialize(options);\n\t\t}\n\t\treturn {\n\t\t\tevents: [\n\t\t\t\t{\n\t\t\t\t\tcols: this._xterm.cols,\n\t\t\t\t\trows: this._xterm.rows,\n\t\t\t\t\tdata: serialized\n\t\t\t\t}\n\t\t\t],\n\t\t\tcommands: this._shellIntegrationAddon.serialize()\n\t\t};\n\t}\n\n\tasync setUnicodeVersion(version: '6' | '11'): Promise<void> {\n\t\tif (this._xterm.unicode.activeVersion === version) {\n\t\t\treturn;\n\t\t}\n\t\tif (version === '11') {\n\t\t\tthis._unicodeAddon = new (await this._getUnicode11Constructor());\n\t\t\tthis._xterm.loadAddon(this._unicodeAddon);\n\t\t} else {\n\t\t\tthis._unicodeAddon?.dispose();\n\t\t\tthis._unicodeAddon = undefined;\n\t\t}\n\t\tthis._xterm.unicode.activeVersion = version;\n\t}\n\n\tasync _getUnicode11Constructor(): Promise<typeof Unicode11Addon> {\n\t\tif (!Unicode11Addon) {\n\t\t\tUnicode11Addon = (await import('@xterm/addon-unicode11')).Unicode11Addon;\n\t\t}\n\t\treturn Unicode11Addon;\n\t}\n\n\tasync _getSerializeConstructor(): Promise<typeof SerializeAddon> {\n\t\tif (!SerializeAddon) {\n\t\t\tSerializeAddon = (await import('@xterm/addon-serialize')).SerializeAddon;\n\t\t}\n\t\treturn SerializeAddon;\n\t}\n}\n\nfunction printTime(ms: number): string {\n\tlet h = 0;\n\tlet m = 0;\n\tlet s = 0;\n\tif (ms >= 1000) {\n\t\ts = Math.floor(ms / 1000);\n\t\tms -= s * 1000;\n\t}\n\tif (s >= 60) {\n\t\tm = Math.floor(s / 60);\n\t\ts -= m * 60;\n\t}\n\tif (m >= 60) {\n\t\th = Math.floor(m / 60);\n\t\tm -= h * 60;\n\t}\n\tconst _h = h ? `${h}h` : ``;\n\tconst _m = m ? `${m}m` : ``;\n\tconst _s = s ? `${s}s` : ``;\n\tconst _ms = ms ? `${ms}ms` : ``;\n\treturn `${_h}${_m}${_s}${_ms}`;\n}\n\ninterface ITerminalSerializer {\n\thandleData(data: string): void;\n\tfreeRawReviveBuffer(): void;\n\thandleResize(cols: number, rows: number): void;\n\tclearBuffer(): void;\n\tgenerateReplayEvent(normalBufferOnly?: boolean, restoreToLastReviveBuffer?: boolean): Promise<IPtyHostProcessReplayEvent>;\n\tsetUnicodeVersion?(version: '6' | '11'): void;\n\tsetNextCommandId?(commandLine: string, commandId: string): void;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { userInfo } from 'os';\nimport * as platform from '../common/platform.js';\nimport { getFirstAvailablePowerShellInstallation } from './powershell.js';\nimport * as processes from './processes.js';\n\n/**\n * Gets the detected default shell for the _system_, not to be confused with VS Code's _default_\n * shell that the terminal uses by default.\n * @param os The platform to detect the shell of.\n */\nexport async function getSystemShell(os: platform.OperatingSystem, env: platform.IProcessEnvironment): Promise<string> {\n\tif (os === platform.OperatingSystem.Windows) {\n\t\tif (platform.isWindows) {\n\t\t\treturn getSystemShellWindows();\n\t\t}\n\t\t// Don't detect Windows shell when not on Windows\n\t\treturn processes.getWindowsShell(env);\n\t}\n\n\treturn getSystemShellUnixLike(os, env);\n}\n\nlet _TERMINAL_DEFAULT_SHELL_UNIX_LIKE: string | null = null;\nfunction getSystemShellUnixLike(os: platform.OperatingSystem, env: platform.IProcessEnvironment): string {\n\t// Only use $SHELL for the current OS\n\tif (platform.isLinux && os === platform.OperatingSystem.Macintosh || platform.isMacintosh && os === platform.OperatingSystem.Linux) {\n\t\treturn '/bin/bash';\n\t}\n\n\tif (!_TERMINAL_DEFAULT_SHELL_UNIX_LIKE) {\n\t\tlet unixLikeTerminal: string | undefined | null;\n\t\tif (platform.isWindows) {\n\t\t\tunixLikeTerminal = '/bin/bash'; // for WSL\n\t\t} else {\n\t\t\tunixLikeTerminal = env['SHELL'];\n\n\t\t\tif (!unixLikeTerminal) {\n\t\t\t\ttry {\n\t\t\t\t\t// It's possible for $SHELL to be unset, this API reads /etc/passwd. See https://github.com/github/codespaces/issues/1639\n\t\t\t\t\t// Node docs: \"Throws a SystemError if a user has no username or homedir.\"\n\t\t\t\t\tunixLikeTerminal = userInfo().shell;\n\t\t\t\t} catch (err) { }\n\t\t\t}\n\n\t\t\tif (!unixLikeTerminal) {\n\t\t\t\tunixLikeTerminal = 'sh';\n\t\t\t}\n\n\t\t\t// Some systems have $SHELL set to /bin/false which breaks the terminal\n\t\t\tif (unixLikeTerminal === '/bin/false') {\n\t\t\t\tunixLikeTerminal = '/bin/bash';\n\t\t\t}\n\t\t}\n\t\t_TERMINAL_DEFAULT_SHELL_UNIX_LIKE = unixLikeTerminal;\n\t}\n\treturn _TERMINAL_DEFAULT_SHELL_UNIX_LIKE;\n}\n\nlet _TERMINAL_DEFAULT_SHELL_WINDOWS: string | null = null;\nasync function getSystemShellWindows(): Promise<string> {\n\tif (!_TERMINAL_DEFAULT_SHELL_WINDOWS) {\n\t\t_TERMINAL_DEFAULT_SHELL_WINDOWS = (await getFirstAvailablePowerShellInstallation())!.exePath;\n\t}\n\treturn _TERMINAL_DEFAULT_SHELL_WINDOWS;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as os from 'os';\nimport * as path from '../common/path.js';\nimport * as pfs from './pfs.js';\n\n// This is required, since parseInt(\"7-preview\") will return 7.\nconst IntRegex: RegExp = /^\\d+$/;\n\nconst PwshMsixRegex: RegExp = /^Microsoft.PowerShell_.*/;\nconst PwshPreviewMsixRegex: RegExp = /^Microsoft.PowerShellPreview_.*/;\n\nconst enum Arch {\n\tx64,\n\tx86,\n\tARM\n}\n\nlet processArch: Arch;\nswitch (process.arch) {\n\tcase 'ia32':\n\t\tprocessArch = Arch.x86;\n\t\tbreak;\n\tcase 'arm':\n\tcase 'arm64':\n\t\tprocessArch = Arch.ARM;\n\t\tbreak;\n\tdefault:\n\t\tprocessArch = Arch.x64;\n\t\tbreak;\n}\n\n/*\nCurrently, here are the values for these environment variables on their respective archs:\n\nOn x86 process on x86:\nPROCESSOR_ARCHITECTURE is X86\nPROCESSOR_ARCHITEW6432 is undefined\n\nOn x86 process on x64:\nPROCESSOR_ARCHITECTURE is X86\nPROCESSOR_ARCHITEW6432 is AMD64\n\nOn x64 process on x64:\nPROCESSOR_ARCHITECTURE is AMD64\nPROCESSOR_ARCHITEW6432 is undefined\n\nOn ARM process on ARM:\nPROCESSOR_ARCHITECTURE is ARM64\nPROCESSOR_ARCHITEW6432 is undefined\n\nOn x86 process on ARM:\nPROCESSOR_ARCHITECTURE is X86\nPROCESSOR_ARCHITEW6432 is ARM64\n\nOn x64 process on ARM:\nPROCESSOR_ARCHITECTURE is ARM64\nPROCESSOR_ARCHITEW6432 is undefined\n*/\nlet osArch: Arch;\nif (process.env['PROCESSOR_ARCHITEW6432']) {\n\tosArch = process.env['PROCESSOR_ARCHITEW6432'] === 'ARM64'\n\t\t? Arch.ARM\n\t\t: Arch.x64;\n} else if (process.env['PROCESSOR_ARCHITECTURE'] === 'ARM64') {\n\tosArch = Arch.ARM;\n} else if (process.env['PROCESSOR_ARCHITECTURE'] === 'X86') {\n\tosArch = Arch.x86;\n} else {\n\tosArch = Arch.x64;\n}\n\nexport interface IPowerShellExeDetails {\n\treadonly displayName: string;\n\treadonly exePath: string;\n}\n\ninterface IPossiblePowerShellExe extends IPowerShellExeDetails {\n\texists(): Promise<boolean>;\n}\n\nclass PossiblePowerShellExe implements IPossiblePowerShellExe {\n\tconstructor(\n\t\tpublic readonly exePath: string,\n\t\tpublic readonly displayName: string,\n\t\tprivate knownToExist?: boolean) { }\n\n\tpublic async exists(): Promise<boolean> {\n\t\tif (this.knownToExist === undefined) {\n\t\t\tthis.knownToExist = await pfs.SymlinkSupport.existsFile(this.exePath);\n\t\t}\n\t\treturn this.knownToExist;\n\t}\n}\n\nfunction getProgramFilesPath(\n\t{ useAlternateBitness = false }: { useAlternateBitness?: boolean } = {}): string | null {\n\n\tif (!useAlternateBitness) {\n\t\t// Just use the native system bitness\n\t\treturn process.env.ProgramFiles || null;\n\t}\n\n\t// We might be a 64-bit process looking for 32-bit program files\n\tif (processArch === Arch.x64) {\n\t\treturn process.env['ProgramFiles(x86)'] || null;\n\t}\n\n\t// We might be a 32-bit process looking for 64-bit program files\n\tif (osArch === Arch.x64) {\n\t\treturn process.env.ProgramW6432 || null;\n\t}\n\n\t// We're a 32-bit process on 32-bit Windows, there is no other Program Files dir\n\treturn null;\n}\n\nasync function findPSCoreWindowsInstallation(\n\t{ useAlternateBitness = false, findPreview = false }:\n\t\t{ useAlternateBitness?: boolean; findPreview?: boolean } = {}): Promise<IPossiblePowerShellExe | null> {\n\n\tconst programFilesPath = getProgramFilesPath({ useAlternateBitness });\n\tif (!programFilesPath) {\n\t\treturn null;\n\t}\n\n\tconst powerShellInstallBaseDir = path.join(programFilesPath, 'PowerShell');\n\n\t// Ensure the base directory exists\n\tif (!await pfs.SymlinkSupport.existsDirectory(powerShellInstallBaseDir)) {\n\t\treturn null;\n\t}\n\n\tlet highestSeenVersion: number = -1;\n\tlet pwshExePath: string | null = null;\n\tfor (const item of await pfs.Promises.readdir(powerShellInstallBaseDir)) {\n\n\t\tlet currentVersion: number = -1;\n\t\tif (findPreview) {\n\t\t\t// We are looking for something like \"7-preview\"\n\n\t\t\t// Preview dirs all have dashes in them\n\t\t\tconst dashIndex = item.indexOf('-');\n\t\t\tif (dashIndex < 0) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Verify that the part before the dash is an integer\n\t\t\t// and that the part after the dash is \"preview\"\n\t\t\tconst intPart: string = item.substring(0, dashIndex);\n\t\t\tif (!IntRegex.test(intPart) || item.substring(dashIndex + 1) !== 'preview') {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcurrentVersion = parseInt(intPart, 10);\n\t\t} else {\n\t\t\t// Search for a directory like \"6\" or \"7\"\n\t\t\tif (!IntRegex.test(item)) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tcurrentVersion = parseInt(item, 10);\n\t\t}\n\n\t\t// Ensure we haven't already seen a higher version\n\t\tif (currentVersion <= highestSeenVersion) {\n\t\t\tcontinue;\n\t\t}\n\n\t\t// Now look for the file\n\t\tconst exePath = path.join(powerShellInstallBaseDir, item, 'pwsh.exe');\n\t\tif (!await pfs.SymlinkSupport.existsFile(exePath)) {\n\t\t\tcontinue;\n\t\t}\n\n\t\tpwshExePath = exePath;\n\t\thighestSeenVersion = currentVersion;\n\t}\n\n\tif (!pwshExePath) {\n\t\treturn null;\n\t}\n\n\tconst bitness: string = programFilesPath.includes('x86') ? ' (x86)' : '';\n\tconst preview: string = findPreview ? ' Preview' : '';\n\n\treturn new PossiblePowerShellExe(pwshExePath, `PowerShell${preview}${bitness}`, true);\n}\n\nasync function findPSCoreMsix({ findPreview }: { findPreview?: boolean } = {}): Promise<IPossiblePowerShellExe | null> {\n\t// We can't proceed if there's no LOCALAPPDATA path\n\tif (!process.env.LOCALAPPDATA) {\n\t\treturn null;\n\t}\n\n\t// Find the base directory for MSIX application exe shortcuts\n\tconst msixAppDir = path.join(process.env.LOCALAPPDATA, 'Microsoft', 'WindowsApps');\n\n\tif (!await pfs.SymlinkSupport.existsDirectory(msixAppDir)) {\n\t\treturn null;\n\t}\n\n\t// Define whether we're looking for the preview or the stable\n\tconst { pwshMsixDirRegex, pwshMsixName } = findPreview\n\t\t? { pwshMsixDirRegex: PwshPreviewMsixRegex, pwshMsixName: 'PowerShell Preview (Store)' }\n\t\t: { pwshMsixDirRegex: PwshMsixRegex, pwshMsixName: 'PowerShell (Store)' };\n\n\t// We should find only one such application, so return on the first one\n\tfor (const subdir of await pfs.Promises.readdir(msixAppDir)) {\n\t\tif (pwshMsixDirRegex.test(subdir)) {\n\t\t\tconst pwshMsixPath = path.join(msixAppDir, subdir, 'pwsh.exe');\n\t\t\treturn new PossiblePowerShellExe(pwshMsixPath, pwshMsixName);\n\t\t}\n\t}\n\n\t// If we find nothing, return null\n\treturn null;\n}\n\nfunction findPSCoreDotnetGlobalTool(): IPossiblePowerShellExe {\n\tconst dotnetGlobalToolExePath: string = path.join(os.homedir(), '.dotnet', 'tools', 'pwsh.exe');\n\n\treturn new PossiblePowerShellExe(dotnetGlobalToolExePath, '.NET Core PowerShell Global Tool');\n}\n\nfunction findPSCoreScoopInstallation(): IPossiblePowerShellExe {\n\tconst scoopAppsDir = path.join(os.homedir(), 'scoop', 'apps');\n\tconst scoopPwsh = path.join(scoopAppsDir, 'pwsh', 'current', 'pwsh.exe');\n\n\treturn new PossiblePowerShellExe(scoopPwsh, 'PowerShell (Scoop)');\n}\n\nfunction findWinPS(): IPossiblePowerShellExe | null {\n\tconst winPSPath = path.join(\n\t\tprocess.env.windir!,\n\t\tprocessArch === Arch.x86 && osArch !== Arch.x86 ? 'SysNative' : 'System32',\n\t\t'WindowsPowerShell', 'v1.0', 'powershell.exe');\n\n\treturn new PossiblePowerShellExe(winPSPath, 'Windows PowerShell', true);\n}\n\n/**\n * Iterates through all the possible well-known PowerShell installations on a machine.\n * Returned values may not exist, but come with an .exists property\n * which will check whether the executable exists.\n */\nasync function* enumerateDefaultPowerShellInstallations(): AsyncIterable<IPossiblePowerShellExe> {\n\t// Find PSCore stable first\n\tlet pwshExe = await findPSCoreWindowsInstallation();\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Windows may have a 32-bit pwsh.exe\n\tpwshExe = await findPSCoreWindowsInstallation({ useAlternateBitness: true });\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Also look for the MSIX/UWP installation\n\tpwshExe = await findPSCoreMsix();\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Look for the .NET global tool\n\t// Some older versions of PowerShell have a bug in this where startup will fail,\n\t// but this is fixed in newer versions\n\tpwshExe = findPSCoreDotnetGlobalTool();\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Look for PSCore preview\n\tpwshExe = await findPSCoreWindowsInstallation({ findPreview: true });\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Find a preview MSIX\n\tpwshExe = await findPSCoreMsix({ findPreview: true });\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Look for pwsh-preview with the opposite bitness\n\tpwshExe = await findPSCoreWindowsInstallation({ useAlternateBitness: true, findPreview: true });\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\tpwshExe = await findPSCoreScoopInstallation();\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n\n\t// Finally, get Windows PowerShell\n\tpwshExe = findWinPS();\n\tif (pwshExe) {\n\t\tyield pwshExe;\n\t}\n}\n\n/**\n * Iterates through PowerShell installations on the machine according\n * to configuration passed in through the constructor.\n * PowerShell items returned by this object are verified\n * to exist on the filesystem.\n */\nexport async function* enumeratePowerShellInstallations(): AsyncIterable<IPowerShellExeDetails> {\n\t// Get the default PowerShell installations first\n\tfor await (const defaultPwsh of enumerateDefaultPowerShellInstallations()) {\n\t\tif (await defaultPwsh.exists()) {\n\t\t\tyield defaultPwsh;\n\t\t}\n\t}\n}\n\n/**\n* Returns the first available PowerShell executable found in the search order.\n*/\nexport async function getFirstAvailablePowerShellInstallation(): Promise<IPowerShellExeDetails | null> {\n\tfor await (const pwsh of enumeratePowerShellInstallations()) {\n\t\treturn pwsh;\n\t}\n\treturn null;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from '../../../base/common/async.js';\nimport { CancellationTokenSource } from '../../../base/common/cancellation.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable, dispose, IDisposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport { ILogService } from '../../log/common/log.js';\n\n/**\n * A helper class to track requests that have replies. Using this it's easy to implement an event\n * that accepts a reply.\n */\nexport class RequestStore<T, RequestArgs> extends Disposable {\n\tprivate _lastRequestId = 0;\n\tprivate readonly _timeout: number;\n\tprivate _pendingRequests: Map<number, (resolved: T) => void> = new Map();\n\tprivate _pendingRequestDisposables: Map<number, IDisposable[]> = new Map();\n\n\tprivate readonly _onCreateRequest = this._register(new Emitter<RequestArgs & { requestId: number }>());\n\treadonly onCreateRequest = this._onCreateRequest.event;\n\n\t/**\n\t * @param timeout How long in ms to allow requests to go unanswered for, undefined will use the\n\t * default (15 seconds).\n\t */\n\tconstructor(\n\t\ttimeout: number | undefined,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t\tthis._timeout = timeout === undefined ? 15000 : timeout;\n\t\tthis._register(toDisposable(() => {\n\t\t\tfor (const d of this._pendingRequestDisposables.values()) {\n\t\t\t\tdispose(d);\n\t\t\t}\n\t\t}));\n\t}\n\n\t/**\n\t * Creates a request.\n\t * @param args The arguments to pass to the onCreateRequest event.\n\t */\n\tcreateRequest(args: RequestArgs): Promise<T> {\n\t\treturn new Promise<T>((resolve, reject) => {\n\t\t\tconst requestId = ++this._lastRequestId;\n\t\t\tthis._pendingRequests.set(requestId, resolve);\n\t\t\tthis._onCreateRequest.fire({ requestId, ...args });\n\t\t\tconst tokenSource = new CancellationTokenSource();\n\t\t\ttimeout(this._timeout, tokenSource.token).then(() => reject(`Request ${requestId} timed out (${this._timeout}ms)`));\n\t\t\tthis._pendingRequestDisposables.set(requestId, [toDisposable(() => tokenSource.cancel())]);\n\t\t});\n\t}\n\n\t/**\n\t * Accept a reply to a request.\n\t * @param requestId The request ID originating from the onCreateRequest event.\n\t * @param data The reply data.\n\t */\n\tacceptReply(requestId: number, data: T) {\n\t\tconst resolveRequest = this._pendingRequests.get(requestId);\n\t\tif (resolveRequest) {\n\t\t\tthis._pendingRequests.delete(requestId);\n\t\t\tdispose(this._pendingRequestDisposables.get(requestId) || []);\n\t\t\tthis._pendingRequestDisposables.delete(requestId);\n\t\t\tresolveRequest(data);\n\t\t} else {\n\t\t\tthis._logService.warn(`RequestStore#acceptReply was called without receiving a matching request ${requestId}`);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Event } from '../../../base/common/event.js';\nimport { IDisposable } from '../../../base/common/lifecycle.js';\nimport { isString } from '../../../base/common/types.js';\nimport { IProcessDataEvent } from './terminal.js';\n\ninterface TerminalDataBuffer extends IDisposable {\n\tdata: string[];\n\ttimeoutId: Timeout;\n}\n\nexport class TerminalDataBufferer implements IDisposable {\n\tprivate readonly _terminalBufferMap = new Map<number, TerminalDataBuffer>();\n\n\tconstructor(private readonly _callback: (id: number, data: string) => void) {\n\t}\n\n\tdispose() {\n\t\tfor (const buffer of this._terminalBufferMap.values()) {\n\t\t\tbuffer.dispose();\n\t\t}\n\t}\n\n\tstartBuffering(id: number, event: Event<string | IProcessDataEvent>, throttleBy: number = 5): IDisposable {\n\n\t\tconst disposable = event((e: string | IProcessDataEvent) => {\n\t\t\tconst data = isString(e) ? e : e.data;\n\t\t\tlet buffer = this._terminalBufferMap.get(id);\n\t\t\tif (buffer) {\n\t\t\t\tbuffer.data.push(data);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst timeoutId = setTimeout(() => this.flushBuffer(id), throttleBy);\n\t\t\tbuffer = {\n\t\t\t\tdata: [data],\n\t\t\t\ttimeoutId,\n\t\t\t\tdispose: () => {\n\t\t\t\t\tclearTimeout(timeoutId);\n\t\t\t\t\tthis.flushBuffer(id);\n\t\t\t\t\tdisposable.dispose();\n\t\t\t\t}\n\t\t\t};\n\t\t\tthis._terminalBufferMap.set(id, buffer);\n\t\t});\n\t\treturn disposable;\n\t}\n\n\tstopBuffering(id: number) {\n\t\tconst buffer = this._terminalBufferMap.get(id);\n\t\tbuffer?.dispose();\n\t}\n\n\tflushBuffer(id: number): void {\n\t\tconst buffer = this._terminalBufferMap.get(id);\n\t\tif (buffer) {\n\t\t\tthis._terminalBufferMap.delete(id);\n\t\t\tthis._callback(id, buffer.data.join(''));\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { OperatingSystem, OS } from '../../../base/common/platform.js';\nimport { IShellLaunchConfig, TerminalShellType, PosixShellType, WindowsShellType, GeneralShellType } from './terminal.js';\n\n/**\n * Aggressively escape non-windows paths to prepare for being sent to a shell. This will do some\n * escaping inaccurately to be careful about possible script injection via the file path. For\n * example, we're trying to prevent this sort of attack: `/foo/file$(echo evil)`.\n */\nexport function escapeNonWindowsPath(path: string, shellType?: TerminalShellType): string {\n\tlet newPath = path;\n\tif (newPath.includes('\\\\')) {\n\t\tnewPath = newPath.replace(/\\\\/g, '\\\\\\\\');\n\t}\n\n\t// Define shell-specific escaping rules\n\tinterface ShellEscapeConfig {\n\t\t// How to handle paths with both single and double quotes\n\t\tbothQuotes: (path: string) => string;\n\t\t// How to handle paths with only single quotes\n\t\tsingleQuotes: (path: string) => string;\n\t\t// How to handle paths with no single quotes (may have double quotes)\n\t\tnoSingleQuotes: (path: string) => string;\n\t}\n\n\tlet escapeConfig: ShellEscapeConfig;\n\tswitch (shellType) {\n\t\tcase PosixShellType.Bash:\n\t\tcase PosixShellType.Sh:\n\t\tcase PosixShellType.Zsh:\n\t\tcase WindowsShellType.GitBash:\n\t\t\tescapeConfig = {\n\t\t\t\tbothQuotes: (path) => `$'${path.replace(/'/g, '\\\\\\'')}'`,\n\t\t\t\tsingleQuotes: (path) => `'${path.replace(/'/g, '\\\\\\'')}'`,\n\t\t\t\tnoSingleQuotes: (path) => `'${path}'`\n\t\t\t};\n\t\t\tbreak;\n\t\tcase PosixShellType.Fish:\n\t\t\tescapeConfig = {\n\t\t\t\tbothQuotes: (path) => `\"${path.replace(/\"/g, '\\\\\"')}\"`,\n\t\t\t\tsingleQuotes: (path) => `'${path.replace(/'/g, '\\\\\\'')}'`,\n\t\t\t\tnoSingleQuotes: (path) => `'${path}'`\n\t\t\t};\n\t\t\tbreak;\n\t\tcase GeneralShellType.PowerShell:\n\t\t\t// PowerShell should be handled separately in preparePathForShell\n\t\t\t// but if we get here, use PowerShell escaping\n\t\t\tescapeConfig = {\n\t\t\t\tbothQuotes: (path) => `\"${path.replace(/\"/g, '`\"')}\"`,\n\t\t\t\tsingleQuotes: (path) => `'${path.replace(/'/g, '\\'\\'')}'`,\n\t\t\t\tnoSingleQuotes: (path) => `'${path}'`\n\t\t\t};\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t// Default to POSIX shell escaping for unknown shells\n\t\t\tescapeConfig = {\n\t\t\t\tbothQuotes: (path) => `$'${path.replace(/'/g, '\\\\\\'')}'`,\n\t\t\t\tsingleQuotes: (path) => `'${path.replace(/'/g, '\\\\\\'')}'`,\n\t\t\t\tnoSingleQuotes: (path) => `'${path}'`\n\t\t\t};\n\t\t\tbreak;\n\t}\n\n\t// Remove dangerous characters except single and double quotes, which we'll escape properly\n\tconst bannedChars = /[\\`\\$\\|\\&\\>\\~\\#\\!\\^\\*\\;\\<]/g;\n\tnewPath = newPath.replace(bannedChars, '');\n\n\t// Apply shell-specific escaping based on quote content\n\tif (newPath.includes('\\'') && newPath.includes('\"')) {\n\t\treturn escapeConfig.bothQuotes(newPath);\n\t} else if (newPath.includes('\\'')) {\n\t\treturn escapeConfig.singleQuotes(newPath);\n\t} else {\n\t\treturn escapeConfig.noSingleQuotes(newPath);\n\t}\n}\n\n/**\n * Collapses the user's home directory into `~` if it exists within the path, this gives a shorter\n * path that is more suitable within the context of a terminal.\n */\nexport function collapseTildePath(path: string | undefined, userHome: string | undefined, separator: string): string {\n\tif (!path) {\n\t\treturn '';\n\t}\n\tif (!userHome) {\n\t\treturn path;\n\t}\n\t// Trim the trailing separator from the end if it exists\n\tif (userHome.match(/[\\/\\\\]$/)) {\n\t\tuserHome = userHome.slice(0, userHome.length - 1);\n\t}\n\tconst normalizedPath = path.replace(/\\\\/g, '/').toLowerCase();\n\tconst normalizedUserHome = userHome.replace(/\\\\/g, '/').toLowerCase();\n\tif (!normalizedPath.includes(normalizedUserHome)) {\n\t\treturn path;\n\t}\n\treturn `~${separator}${path.slice(userHome.length + 1)}`;\n}\n\n/**\n * Sanitizes a cwd string, removing any wrapping quotes and making the Windows drive letter\n * uppercase.\n * @param cwd The directory to sanitize.\n */\nexport function sanitizeCwd(cwd: string): string {\n\t// Sanity check that the cwd is not wrapped in quotes (see #160109)\n\tif (cwd.match(/^['\"].*['\"]$/)) {\n\t\tcwd = cwd.substring(1, cwd.length - 1);\n\t}\n\t// Make the drive letter uppercase on Windows (see #9448)\n\tif (OS === OperatingSystem.Windows && cwd && cwd[1] === ':') {\n\t\treturn cwd[0].toUpperCase() + cwd.substring(1);\n\t}\n\treturn cwd;\n}\n\n/**\n * Determines whether the given shell launch config should use the environment variable collection.\n * @param slc The shell launch config to check.\n */\nexport function shouldUseEnvironmentVariableCollection(slc: IShellLaunchConfig): boolean {\n\treturn !slc.strictEnv;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as os from 'os';\nimport { FileAccess } from '../../../base/common/network.js';\nimport * as path from '../../../base/common/path.js';\nimport { IProcessEnvironment, isMacintosh, isWindows } from '../../../base/common/platform.js';\nimport * as process from '../../../base/common/process.js';\nimport { format } from '../../../base/common/strings.js';\nimport { ILogService } from '../../log/common/log.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { IShellLaunchConfig, ITerminalEnvironment, ITerminalProcessOptions, ShellIntegrationInjectionFailureReason } from '../common/terminal.js';\nimport { EnvironmentVariableMutatorType } from '../common/environmentVariable.js';\nimport { deserializeEnvironmentVariableCollections } from '../common/environmentVariableShared.js';\nimport { MergedEnvironmentVariableCollection } from '../common/environmentVariableCollection.js';\nimport { chmod, realpathSync, mkdirSync } from 'fs';\nimport { promisify } from 'util';\nimport { isString, SingleOrMany } from '../../../base/common/types.js';\n\nexport function getWindowsBuildNumber(): number {\n\tconst osVersion = (/(\\d+)\\.(\\d+)\\.(\\d+)/g).exec(os.release());\n\tlet buildNumber: number = 0;\n\tif (osVersion && osVersion.length === 4) {\n\t\tbuildNumber = parseInt(osVersion[3]);\n\t}\n\treturn buildNumber;\n}\n\nexport interface IShellIntegrationConfigInjection {\n\treadonly type: 'injection';\n\t/**\n\t * A new set of arguments to use.\n\t */\n\treadonly newArgs: string[] | undefined;\n\t/**\n\t * An optional environment to mixing to the real environment.\n\t */\n\treadonly envMixin?: IProcessEnvironment;\n\t/**\n\t * An optional array of files to copy from `source` to `dest`.\n\t */\n\treadonly filesToCopy?: {\n\t\tsource: string;\n\t\tdest: string;\n\t}[];\n}\n\nexport interface IShellIntegrationInjectionFailure {\n\treadonly type: 'failure';\n\treadonly reason: ShellIntegrationInjectionFailureReason;\n}\n\n/**\n * For a given shell launch config, returns arguments to replace and an optional environment to\n * mixin to the SLC's environment to enable shell integration. This must be run within the context\n * that creates the process to ensure accuracy. Returns undefined if shell integration cannot be\n * enabled.\n */\nexport async function getShellIntegrationInjection(\n\tshellLaunchConfig: IShellLaunchConfig,\n\toptions: ITerminalProcessOptions,\n\tenv: ITerminalEnvironment | undefined,\n\tlogService: ILogService,\n\tproductService: IProductService,\n\tskipStickyBit: boolean = false\n): Promise<IShellIntegrationConfigInjection | IShellIntegrationInjectionFailure> {\n\t// The global setting is disabled\n\tif (!options.shellIntegration.enabled) {\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.InjectionSettingDisabled };\n\t}\n\t// There is no executable (so there's no way to determine how to inject)\n\tif (!shellLaunchConfig.executable) {\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.NoExecutable };\n\t}\n\t// It's a feature terminal (tasks, debug), unless it's explicitly being forced\n\tif (shellLaunchConfig.isFeatureTerminal && !shellLaunchConfig.forceShellIntegration) {\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.FeatureTerminal };\n\t}\n\t// The ignoreShellIntegration flag is passed (eg. relaunching without shell integration)\n\tif (shellLaunchConfig.ignoreShellIntegration) {\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.IgnoreShellIntegrationFlag };\n\t}\n\t// Shell integration doesn't work with winpty\n\tif (isWindows && (!options.windowsEnableConpty || getWindowsBuildNumber() < 18309)) {\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.Winpty };\n\t}\n\n\tconst originalArgs = shellLaunchConfig.args;\n\tconst shell = process.platform === 'win32' ? path.basename(shellLaunchConfig.executable).toLowerCase() : path.basename(shellLaunchConfig.executable);\n\tconst appRoot = path.dirname(FileAccess.asFileUri('').fsPath);\n\tconst type = 'injection';\n\tlet newArgs: string[] | undefined;\n\tconst envMixin: IProcessEnvironment = {\n\t\t'VSCODE_INJECTION': '1'\n\t};\n\n\tif (options.shellIntegration.nonce) {\n\t\tenvMixin['VSCODE_NONCE'] = options.shellIntegration.nonce;\n\t}\n\t// Temporarily pass list of hardcoded env vars for shell env api\n\tconst scopedDownShellEnvs = ['PATH', 'VIRTUAL_ENV', 'HOME', 'SHELL', 'PWD'];\n\tif (shellLaunchConfig.shellIntegrationEnvironmentReporting) {\n\t\tif (isWindows) {\n\t\t\tconst enableWindowsEnvReporting = options.windowsUseConptyDll || options.windowsEnableConpty && getWindowsBuildNumber() >= 22631 && shell !== 'bash.exe';\n\t\t\tif (enableWindowsEnvReporting) {\n\t\t\t\tenvMixin['VSCODE_SHELL_ENV_REPORTING'] = scopedDownShellEnvs.join(',');\n\t\t\t}\n\t\t} else {\n\t\t\tenvMixin['VSCODE_SHELL_ENV_REPORTING'] = scopedDownShellEnvs.join(',');\n\t\t}\n\t}\n\n\t// Windows\n\tif (isWindows) {\n\t\tif (shell === 'pwsh.exe' || shell === 'powershell.exe') {\n\t\t\tenvMixin['VSCODE_A11Y_MODE'] = options.isScreenReaderOptimized ? '1' : '0';\n\n\t\t\tif (!originalArgs || arePwshImpliedArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.WindowsPwsh);\n\t\t\t} else if (arePwshLoginArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.WindowsPwshLogin);\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot, '');\n\t\t\tenvMixin['VSCODE_STABLE'] = productService.quality === 'stable' ? '1' : '0';\n\t\t\treturn { type, newArgs, envMixin };\n\t\t} else if (shell === 'bash.exe') {\n\t\t\tif (!originalArgs || originalArgs.length === 0) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Bash);\n\t\t\t} else if (areZshBashFishLoginArgs(originalArgs)) {\n\t\t\t\tenvMixin['VSCODE_SHELL_LOGIN'] = '1';\n\t\t\t\taddEnvMixinPathPrefix(options, envMixin, shell);\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Bash);\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\t\t\tnewArgs = [...newArgs]; // Shallow clone the array to avoid setting the default array\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot);\n\t\t\tenvMixin['VSCODE_STABLE'] = productService.quality === 'stable' ? '1' : '0';\n\t\t\treturn { type, newArgs, envMixin };\n\t\t}\n\t\tlogService.warn(`Shell integration cannot be enabled for executable \"${shellLaunchConfig.executable}\" and args`, shellLaunchConfig.args);\n\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedShell };\n\t}\n\n\t// Linux & macOS\n\tswitch (shell) {\n\t\tcase 'bash': {\n\t\t\tif (!originalArgs || originalArgs.length === 0) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Bash);\n\t\t\t} else if (areZshBashFishLoginArgs(originalArgs)) {\n\t\t\t\tenvMixin['VSCODE_SHELL_LOGIN'] = '1';\n\t\t\t\taddEnvMixinPathPrefix(options, envMixin, shell);\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Bash);\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\t\t\tnewArgs = [...newArgs]; // Shallow clone the array to avoid setting the default array\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot);\n\t\t\tenvMixin['VSCODE_STABLE'] = productService.quality === 'stable' ? '1' : '0';\n\t\t\treturn { type, newArgs, envMixin };\n\t\t}\n\t\tcase 'fish': {\n\t\t\tif (!originalArgs || originalArgs.length === 0) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Fish);\n\t\t\t} else if (areZshBashFishLoginArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.FishLogin);\n\t\t\t} else if (originalArgs === shellIntegrationArgs.get(ShellIntegrationExecutable.Fish) || originalArgs === shellIntegrationArgs.get(ShellIntegrationExecutable.FishLogin)) {\n\t\t\t\tnewArgs = originalArgs;\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\n\t\t\t// On fish, '$fish_user_paths' is always prepended to the PATH, for both login and non-login shells, so we need\n\t\t\t// to apply the path prefix fix always, not only for login shells (see #232291)\n\t\t\taddEnvMixinPathPrefix(options, envMixin, shell);\n\n\t\t\tnewArgs = [...newArgs]; // Shallow clone the array to avoid setting the default array\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot);\n\t\t\treturn { type, newArgs, envMixin };\n\t\t}\n\t\tcase 'pwsh': {\n\t\t\tif (!originalArgs || arePwshImpliedArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Pwsh);\n\t\t\t} else if (arePwshLoginArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.PwshLogin);\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\t\t\tnewArgs = [...newArgs]; // Shallow clone the array to avoid setting the default array\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot, '');\n\t\t\tenvMixin['VSCODE_STABLE'] = productService.quality === 'stable' ? '1' : '0';\n\t\t\treturn { type, newArgs, envMixin };\n\t\t}\n\t\tcase 'zsh': {\n\t\t\tif (!originalArgs || originalArgs.length === 0) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.Zsh);\n\t\t\t} else if (areZshBashFishLoginArgs(originalArgs)) {\n\t\t\t\tnewArgs = shellIntegrationArgs.get(ShellIntegrationExecutable.ZshLogin);\n\t\t\t\taddEnvMixinPathPrefix(options, envMixin, shell);\n\t\t\t} else if (originalArgs === shellIntegrationArgs.get(ShellIntegrationExecutable.Zsh) || originalArgs === shellIntegrationArgs.get(ShellIntegrationExecutable.ZshLogin)) {\n\t\t\t\tnewArgs = originalArgs;\n\t\t\t}\n\t\t\tif (!newArgs) {\n\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedArgs };\n\t\t\t}\n\t\t\tnewArgs = [...newArgs]; // Shallow clone the array to avoid setting the default array\n\t\t\tnewArgs[newArgs.length - 1] = format(newArgs[newArgs.length - 1], appRoot);\n\n\t\t\t// Move .zshrc into $ZDOTDIR as the way to activate the script\n\t\t\tlet username: string;\n\t\t\ttry {\n\t\t\t\tusername = os.userInfo().username;\n\t\t\t} catch {\n\t\t\t\tusername = 'unknown';\n\t\t\t}\n\n\t\t\t// Resolve the actual tmp directory so we can set the sticky bit\n\t\t\tconst realTmpDir = realpathSync(os.tmpdir());\n\t\t\tconst zdotdir = path.join(realTmpDir, `${username}-${productService.applicationName}-zsh`);\n\n\t\t\t// Set directory permissions using octal notation:\n\t\t\t// - 0o1700:\n\t\t\t// - Sticky bit is set, preventing non-owners from deleting or renaming files within this directory (1)\n\t\t\t// - Owner has full read (4), write (2), execute (1) permissions\n\t\t\t// - Group has no permissions (0)\n\t\t\t// - Others have no permissions (0)\n\t\t\tif (!skipStickyBit) {\n\t\t\t\t// skip for tests\n\t\t\t\ttry {\n\t\t\t\t\tconst chmodAsync = promisify(chmod);\n\t\t\t\t\tawait chmodAsync(zdotdir, 0o1700);\n\t\t\t\t} catch (err) {\n\t\t\t\t\tif (err.message.includes('ENOENT')) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tmkdirSync(zdotdir);\n\t\t\t\t\t\t} catch (err) {\n\t\t\t\t\t\t\tlogService.error(`Failed to create zdotdir at ${zdotdir}: ${err}`);\n\t\t\t\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.FailedToCreateTmpDir };\n\t\t\t\t\t\t}\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst chmodAsync = promisify(chmod);\n\t\t\t\t\t\t\tawait chmodAsync(zdotdir, 0o1700);\n\t\t\t\t\t\t} catch {\n\t\t\t\t\t\t\tlogService.error(`Failed to set sticky bit on ${zdotdir}: ${err}`);\n\t\t\t\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.FailedToSetStickyBit };\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tlogService.error(`Failed to set sticky bit on ${zdotdir}: ${err}`);\n\t\t\t\t\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.FailedToSetStickyBit };\n\t\t\t\t}\n\t\t\t}\n\t\t\tenvMixin['ZDOTDIR'] = zdotdir;\n\t\t\tconst userZdotdir = env?.ZDOTDIR ?? os.homedir() ?? `~`;\n\t\t\tenvMixin['USER_ZDOTDIR'] = userZdotdir;\n\t\t\tconst filesToCopy: IShellIntegrationConfigInjection['filesToCopy'] = [];\n\t\t\tfilesToCopy.push({\n\t\t\t\tsource: path.join(appRoot, 'out/vs/workbench/contrib/terminal/common/scripts/shellIntegration-rc.zsh'),\n\t\t\t\tdest: path.join(zdotdir, '.zshrc')\n\t\t\t});\n\t\t\tfilesToCopy.push({\n\t\t\t\tsource: path.join(appRoot, 'out/vs/workbench/contrib/terminal/common/scripts/shellIntegration-profile.zsh'),\n\t\t\t\tdest: path.join(zdotdir, '.zprofile')\n\t\t\t});\n\t\t\tfilesToCopy.push({\n\t\t\t\tsource: path.join(appRoot, 'out/vs/workbench/contrib/terminal/common/scripts/shellIntegration-env.zsh'),\n\t\t\t\tdest: path.join(zdotdir, '.zshenv')\n\t\t\t});\n\t\t\tfilesToCopy.push({\n\t\t\t\tsource: path.join(appRoot, 'out/vs/workbench/contrib/terminal/common/scripts/shellIntegration-login.zsh'),\n\t\t\t\tdest: path.join(zdotdir, '.zlogin')\n\t\t\t});\n\t\t\treturn { type, newArgs, envMixin, filesToCopy };\n\t\t}\n\t}\n\tlogService.warn(`Shell integration cannot be enabled for executable \"${shellLaunchConfig.executable}\" and args`, shellLaunchConfig.args);\n\treturn { type: 'failure', reason: ShellIntegrationInjectionFailureReason.UnsupportedShell };\n}\n\n/**\n * There are a few situations where some directories are added to the beginning of the PATH.\n * 1. On macOS when the profile calls path_helper.\n * 2. For fish terminals, which always prepend \"$fish_user_paths\" to the PATH.\n *\n * This causes significant problems for the environment variable\n * collection API as the custom paths added to the end will now be somewhere in the middle of\n * the PATH. To combat this, VSCODE_PATH_PREFIX is used to re-apply any prefix after the profile\n * has run. This will cause duplication in the PATH but should fix the issue.\n *\n * See #99878 for more information.\n */\nfunction addEnvMixinPathPrefix(options: ITerminalProcessOptions, envMixin: IProcessEnvironment, shell: string): void {\n\tif ((isMacintosh || shell === 'fish') && options.environmentVariableCollections) {\n\t\t// Deserialize and merge\n\t\tconst deserialized = deserializeEnvironmentVariableCollections(options.environmentVariableCollections);\n\t\tconst merged = new MergedEnvironmentVariableCollection(deserialized);\n\n\t\t// Get all prepend PATH entries\n\t\tconst pathEntry = merged.getVariableMap({ workspaceFolder: options.workspaceFolder }).get('PATH');\n\t\tconst prependToPath: string[] = [];\n\t\tif (pathEntry) {\n\t\t\tfor (const mutator of pathEntry) {\n\t\t\t\tif (mutator.type === EnvironmentVariableMutatorType.Prepend) {\n\t\t\t\t\tprependToPath.push(mutator.value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Add to the environment mixin to be applied in the shell integration script\n\t\tif (prependToPath.length > 0) {\n\t\t\tenvMixin['VSCODE_PATH_PREFIX'] = prependToPath.join('');\n\t\t}\n\t}\n}\n\nenum ShellIntegrationExecutable {\n\tWindowsPwsh = 'windows-pwsh',\n\tWindowsPwshLogin = 'windows-pwsh-login',\n\tPwsh = 'pwsh',\n\tPwshLogin = 'pwsh-login',\n\tZsh = 'zsh',\n\tZshLogin = 'zsh-login',\n\tBash = 'bash',\n\tFish = 'fish',\n\tFishLogin = 'fish-login',\n}\n\nconst shellIntegrationArgs: Map<ShellIntegrationExecutable, string[]> = new Map();\n// The try catch swallows execution policy errors in the case of the archive distributable\nshellIntegrationArgs.set(ShellIntegrationExecutable.WindowsPwsh, ['-noexit', '-command', 'try { . \\\"{0}\\\\out\\\\vs\\\\workbench\\\\contrib\\\\terminal\\\\common\\\\scripts\\\\shellIntegration.ps1\\\" } catch {}{1}']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.WindowsPwshLogin, ['-l', '-noexit', '-command', 'try { . \\\"{0}\\\\out\\\\vs\\\\workbench\\\\contrib\\\\terminal\\\\common\\\\scripts\\\\shellIntegration.ps1\\\" } catch {}{1}']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.Pwsh, ['-noexit', '-command', '. \"{0}/out/vs/workbench/contrib/terminal/common/scripts/shellIntegration.ps1\"{1}']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.PwshLogin, ['-l', '-noexit', '-command', '. \"{0}/out/vs/workbench/contrib/terminal/common/scripts/shellIntegration.ps1\"']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.Zsh, ['-i']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.ZshLogin, ['-il']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.Bash, ['--init-file', '{0}/out/vs/workbench/contrib/terminal/common/scripts/shellIntegration-bash.sh']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.Fish, ['--init-command', 'source \"{0}/out/vs/workbench/contrib/terminal/common/scripts/shellIntegration.fish\"']);\nshellIntegrationArgs.set(ShellIntegrationExecutable.FishLogin, ['-l', '--init-command', 'source \"{0}/out/vs/workbench/contrib/terminal/common/scripts/shellIntegration.fish\"']);\nconst pwshLoginArgs = ['-login', '-l'];\nconst shLoginArgs = ['--login', '-l'];\nconst shInteractiveArgs = ['-i', '--interactive'];\nconst pwshImpliedArgs = ['-nol', '-nologo'];\n\nfunction arePwshLoginArgs(originalArgs: SingleOrMany<string>): boolean {\n\tif (isString(originalArgs)) {\n\t\treturn pwshLoginArgs.includes(originalArgs.toLowerCase());\n\t} else {\n\t\treturn originalArgs.length === 1 && pwshLoginArgs.includes(originalArgs[0].toLowerCase()) ||\n\t\t\t(originalArgs.length === 2 &&\n\t\t\t\t(((pwshLoginArgs.includes(originalArgs[0].toLowerCase())) || pwshLoginArgs.includes(originalArgs[1].toLowerCase())))\n\t\t\t\t&& ((pwshImpliedArgs.includes(originalArgs[0].toLowerCase())) || pwshImpliedArgs.includes(originalArgs[1].toLowerCase())));\n\t}\n}\n\nfunction arePwshImpliedArgs(originalArgs: SingleOrMany<string>): boolean {\n\tif (isString(originalArgs)) {\n\t\treturn pwshImpliedArgs.includes(originalArgs.toLowerCase());\n\t} else {\n\t\treturn originalArgs.length === 0 || originalArgs?.length === 1 && pwshImpliedArgs.includes(originalArgs[0].toLowerCase());\n\t}\n}\n\nfunction areZshBashFishLoginArgs(originalArgs: SingleOrMany<string>): boolean {\n\tif (!isString(originalArgs)) {\n\t\toriginalArgs = originalArgs.filter(arg => !shInteractiveArgs.includes(arg.toLowerCase()));\n\t}\n\treturn isString(originalArgs) && shLoginArgs.includes(originalArgs.toLowerCase())\n\t\t|| !isString(originalArgs) && originalArgs.length === 1 && shLoginArgs.includes(originalArgs[0].toLowerCase());\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProcessEnvironment } from '../../../base/common/platform.js';\nimport { IWorkspaceFolderData } from '../../workspace/common/workspace.js';\n\nexport enum EnvironmentVariableMutatorType {\n\tReplace = 1,\n\tAppend = 2,\n\tPrepend = 3\n}\nexport interface IEnvironmentVariableMutator {\n\treadonly variable: string;\n\treadonly value: string;\n\treadonly type: EnvironmentVariableMutatorType;\n\treadonly scope?: EnvironmentVariableScope;\n\treadonly options?: IEnvironmentVariableMutatorOptions;\n}\n\nexport interface IEnvironmentVariableCollectionDescription {\n\treadonly description: string | undefined;\n\treadonly scope?: EnvironmentVariableScope;\n}\n\nexport interface IEnvironmentVariableMutatorOptions {\n\tapplyAtProcessCreation?: boolean;\n\tapplyAtShellIntegration?: boolean;\n}\n\nexport type EnvironmentVariableScope = {\n\tworkspaceFolder?: IWorkspaceFolderData;\n};\n\nexport interface IEnvironmentVariableCollection {\n\treadonly map: ReadonlyMap<string, IEnvironmentVariableMutator>;\n\treadonly descriptionMap?: ReadonlyMap<string, IEnvironmentVariableCollectionDescription>;\n}\n\n/** [variable, mutator] */\nexport type ISerializableEnvironmentVariableCollection = [string, IEnvironmentVariableMutator][];\n\nexport type ISerializableEnvironmentDescriptionMap = [string, IEnvironmentVariableCollectionDescription][];\nexport interface IExtensionOwnedEnvironmentDescriptionMutator extends IEnvironmentVariableCollectionDescription {\n\treadonly extensionIdentifier: string;\n}\n\n/** [extension, collection, description] */\nexport type ISerializableEnvironmentVariableCollections = [string, ISerializableEnvironmentVariableCollection, ISerializableEnvironmentDescriptionMap][];\n\nexport interface IExtensionOwnedEnvironmentVariableMutator extends IEnvironmentVariableMutator {\n\treadonly extensionIdentifier: string;\n}\n\nexport interface IMergedEnvironmentVariableCollectionDiff {\n\tadded: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\tchanged: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\tremoved: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n}\n\ntype VariableResolver = (str: string) => Promise<string>;\n\n/**\n * Represents an environment variable collection that results from merging several collections\n * together.\n */\nexport interface IMergedEnvironmentVariableCollection {\n\treadonly collections: ReadonlyMap<string, IEnvironmentVariableCollection>;\n\t/**\n\t * Gets the variable map for a given scope.\n\t * @param scope The scope to get the variable map for. If undefined, the global scope is used.\n\t */\n\tgetVariableMap(scope: EnvironmentVariableScope | undefined): Map<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\t/**\n\t * Gets the description map for a given scope.\n\t * @param scope The scope to get the description map for. If undefined, description map for the\n\t * global scope is returned.\n\t */\n\tgetDescriptionMap(scope: EnvironmentVariableScope | undefined): Map<string, string | undefined>;\n\t/**\n\t * Applies this collection to a process environment.\n\t * @param variableResolver An optional function to use to resolve variables within the\n\t * environment values.\n\t */\n\tapplyToProcessEnvironment(env: IProcessEnvironment, scope: EnvironmentVariableScope | undefined, variableResolver?: VariableResolver): Promise<void>;\n\n\t/**\n\t * Generates a diff of this collection against another. Returns undefined if the collections are\n\t * the same.\n\t */\n\tdiff(other: IMergedEnvironmentVariableCollection, scope: EnvironmentVariableScope | undefined): IMergedEnvironmentVariableCollectionDiff | undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProcessEnvironment } from '../../../base/common/platform.js';\nimport { IWorkspaceFolderData } from '../../workspace/common/workspace.js';\n\nexport enum EnvironmentVariableMutatorType {\n\tReplace = 1,\n\tAppend = 2,\n\tPrepend = 3\n}\nexport interface IEnvironmentVariableMutator {\n\treadonly variable: string;\n\treadonly value: string;\n\treadonly type: EnvironmentVariableMutatorType;\n\treadonly scope?: EnvironmentVariableScope;\n\treadonly options?: IEnvironmentVariableMutatorOptions;\n}\n\nexport interface IEnvironmentVariableCollectionDescription {\n\treadonly description: string | undefined;\n\treadonly scope?: EnvironmentVariableScope;\n}\n\nexport interface IEnvironmentVariableMutatorOptions {\n\tapplyAtProcessCreation?: boolean;\n\tapplyAtShellIntegration?: boolean;\n}\n\nexport type EnvironmentVariableScope = {\n\tworkspaceFolder?: IWorkspaceFolderData;\n};\n\nexport interface IEnvironmentVariableCollection {\n\treadonly map: ReadonlyMap<string, IEnvironmentVariableMutator>;\n\treadonly descriptionMap?: ReadonlyMap<string, IEnvironmentVariableCollectionDescription>;\n}\n\n/** [variable, mutator] */\nexport type ISerializableEnvironmentVariableCollection = [string, IEnvironmentVariableMutator][];\n\nexport type ISerializableEnvironmentDescriptionMap = [string, IEnvironmentVariableCollectionDescription][];\nexport interface IExtensionOwnedEnvironmentDescriptionMutator extends IEnvironmentVariableCollectionDescription {\n\treadonly extensionIdentifier: string;\n}\n\n/** [extension, collection, description] */\nexport type ISerializableEnvironmentVariableCollections = [string, ISerializableEnvironmentVariableCollection, ISerializableEnvironmentDescriptionMap][];\n\nexport interface IExtensionOwnedEnvironmentVariableMutator extends IEnvironmentVariableMutator {\n\treadonly extensionIdentifier: string;\n}\n\nexport interface IMergedEnvironmentVariableCollectionDiff {\n\tadded: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\tchanged: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\tremoved: ReadonlyMap<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n}\n\ntype VariableResolver = (str: string) => Promise<string>;\n\n/**\n * Represents an environment variable collection that results from merging several collections\n * together.\n */\nexport interface IMergedEnvironmentVariableCollection {\n\treadonly collections: ReadonlyMap<string, IEnvironmentVariableCollection>;\n\t/**\n\t * Gets the variable map for a given scope.\n\t * @param scope The scope to get the variable map for. If undefined, the global scope is used.\n\t */\n\tgetVariableMap(scope: EnvironmentVariableScope | undefined): Map<string, IExtensionOwnedEnvironmentVariableMutator[]>;\n\t/**\n\t * Gets the description map for a given scope.\n\t * @param scope The scope to get the description map for. If undefined, description map for the\n\t * global scope is returned.\n\t */\n\tgetDescriptionMap(scope: EnvironmentVariableScope | undefined): Map<string, string | undefined>;\n\t/**\n\t * Applies this collection to a process environment.\n\t * @param variableResolver An optional function to use to resolve variables within the\n\t * environment values.\n\t */\n\tapplyToProcessEnvironment(env: IProcessEnvironment, scope: EnvironmentVariableScope | undefined, variableResolver?: VariableResolver): Promise<void>;\n\n\t/**\n\t * Generates a diff of this collection against another. Returns undefined if the collections are\n\t * the same.\n\t */\n\tdiff(other: IMergedEnvironmentVariableCollection, scope: EnvironmentVariableScope | undefined): IMergedEnvironmentVariableCollectionDiff | undefined;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IEnvironmentVariableCollectionDescription, IEnvironmentVariableCollection, IEnvironmentVariableMutator, ISerializableEnvironmentDescriptionMap as ISerializableEnvironmentDescriptionMap, ISerializableEnvironmentVariableCollection, ISerializableEnvironmentVariableCollections } from './environmentVariable.js';\n\n// This file is shared between the renderer and extension host\n\nexport function serializeEnvironmentVariableCollection(collection: ReadonlyMap<string, IEnvironmentVariableMutator>): ISerializableEnvironmentVariableCollection {\n\treturn [...collection.entries()];\n}\n\nexport function serializeEnvironmentDescriptionMap(descriptionMap: ReadonlyMap<string, IEnvironmentVariableCollectionDescription> | undefined): ISerializableEnvironmentDescriptionMap {\n\treturn descriptionMap ? [...descriptionMap.entries()] : [];\n}\n\nexport function deserializeEnvironmentVariableCollection(\n\tserializedCollection: ISerializableEnvironmentVariableCollection\n): Map<string, IEnvironmentVariableMutator> {\n\treturn new Map<string, IEnvironmentVariableMutator>(serializedCollection);\n}\n\nexport function deserializeEnvironmentDescriptionMap(\n\tserializableEnvironmentDescription: ISerializableEnvironmentDescriptionMap | undefined\n): Map<string, IEnvironmentVariableCollectionDescription> {\n\treturn new Map<string, IEnvironmentVariableCollectionDescription>(serializableEnvironmentDescription ?? []);\n}\n\nexport function serializeEnvironmentVariableCollections(collections: ReadonlyMap<string, IEnvironmentVariableCollection>): ISerializableEnvironmentVariableCollections {\n\treturn Array.from(collections.entries()).map(e => {\n\t\treturn [e[0], serializeEnvironmentVariableCollection(e[1].map), serializeEnvironmentDescriptionMap(e[1].descriptionMap)];\n\t});\n}\n\nexport function deserializeEnvironmentVariableCollections(\n\tserializedCollection: ISerializableEnvironmentVariableCollections\n): Map<string, IEnvironmentVariableCollection> {\n\treturn new Map<string, IEnvironmentVariableCollection>(serializedCollection.map(e => {\n\t\treturn [e[0], { map: deserializeEnvironmentVariableCollection(e[1]), descriptionMap: deserializeEnvironmentDescriptionMap(e[2]) }];\n\t}));\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProcessEnvironment, isWindows } from '../../../base/common/platform.js';\nimport { EnvironmentVariableMutatorType, EnvironmentVariableScope, IEnvironmentVariableCollection, IExtensionOwnedEnvironmentDescriptionMutator, IExtensionOwnedEnvironmentVariableMutator, IMergedEnvironmentVariableCollection, IMergedEnvironmentVariableCollectionDiff } from './environmentVariable.js';\n\ntype VariableResolver = (str: string) => Promise<string>;\n\nconst mutatorTypeToLabelMap: Map<EnvironmentVariableMutatorType, string> = new Map([\n\t[EnvironmentVariableMutatorType.Append, 'APPEND'],\n\t[EnvironmentVariableMutatorType.Prepend, 'PREPEND'],\n\t[EnvironmentVariableMutatorType.Replace, 'REPLACE']\n]);\nconst PYTHON_ACTIVATION_VARS_PATTERN = /^VSCODE_PYTHON_(PWSH|ZSH|BASH|FISH)_ACTIVATE/;\nconst PYTHON_ENV_EXTENSION_ID = 'ms-python.vscode-python-envs';\n\nexport class MergedEnvironmentVariableCollection implements IMergedEnvironmentVariableCollection {\n\tprivate readonly map: Map<string, IExtensionOwnedEnvironmentVariableMutator[]> = new Map();\n\tprivate readonly descriptionMap: Map<string, IExtensionOwnedEnvironmentDescriptionMutator[]> = new Map();\n\n\tconstructor(\n\t\treadonly collections: ReadonlyMap<string, IEnvironmentVariableCollection>,\n\t) {\n\t\tcollections.forEach((collection, extensionIdentifier) => {\n\t\t\tthis.populateDescriptionMap(collection, extensionIdentifier);\n\t\t\tconst it = collection.map.entries();\n\t\t\tlet next = it.next();\n\t\t\twhile (!next.done) {\n\t\t\t\tconst mutator = next.value[1];\n\t\t\t\tconst key = next.value[0];\n\n\t\t\t\tif (this.blockPythonActivationVar(key, extensionIdentifier)) {\n\t\t\t\t\tnext = it.next();\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tlet entry = this.map.get(key);\n\t\t\t\tif (!entry) {\n\t\t\t\t\tentry = [];\n\t\t\t\t\tthis.map.set(key, entry);\n\t\t\t\t}\n\n\t\t\t\t// If the first item in the entry is replace ignore any other entries as they would\n\t\t\t\t// just get replaced by this one.\n\t\t\t\tif (entry.length > 0 && entry[0].type === EnvironmentVariableMutatorType.Replace) {\n\t\t\t\t\tnext = it.next();\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tconst extensionMutator = {\n\t\t\t\t\textensionIdentifier,\n\t\t\t\t\tvalue: mutator.value,\n\t\t\t\t\ttype: mutator.type,\n\t\t\t\t\tscope: mutator.scope,\n\t\t\t\t\tvariable: mutator.variable,\n\t\t\t\t\toptions: mutator.options\n\t\t\t\t};\n\t\t\t\tif (!extensionMutator.scope) {\n\t\t\t\t\tdelete extensionMutator.scope; // Convenient for tests\n\t\t\t\t}\n\t\t\t\t// Mutators get applied in the reverse order than they are created\n\t\t\t\tentry.unshift(extensionMutator);\n\n\t\t\t\tnext = it.next();\n\t\t\t}\n\t\t});\n\t}\n\n\tasync applyToProcessEnvironment(env: IProcessEnvironment, scope: EnvironmentVariableScope | undefined, variableResolver?: VariableResolver): Promise<void> {\n\t\tlet lowerToActualVariableNames: { [lowerKey: string]: string | undefined } | undefined;\n\t\tif (isWindows) {\n\t\t\tlowerToActualVariableNames = {};\n\t\t\tObject.keys(env).forEach(e => lowerToActualVariableNames![e.toLowerCase()] = e);\n\t\t}\n\t\tfor (const [variable, mutators] of this.getVariableMap(scope)) {\n\t\t\tconst actualVariable = isWindows ? lowerToActualVariableNames![variable.toLowerCase()] || variable : variable;\n\t\t\tfor (const mutator of mutators) {\n\t\t\t\tconst value = variableResolver ? await variableResolver(mutator.value) : mutator.value;\n\n\t\t\t\tif (this.blockPythonActivationVar(mutator.variable, mutator.extensionIdentifier)) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t// Default: true\n\t\t\t\tif (mutator.options?.applyAtProcessCreation ?? true) {\n\t\t\t\t\tswitch (mutator.type) {\n\t\t\t\t\t\tcase EnvironmentVariableMutatorType.Append:\n\t\t\t\t\t\t\tenv[actualVariable] = (env[actualVariable] || '') + value;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase EnvironmentVariableMutatorType.Prepend:\n\t\t\t\t\t\t\tenv[actualVariable] = value + (env[actualVariable] || '');\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\tcase EnvironmentVariableMutatorType.Replace:\n\t\t\t\t\t\t\tenv[actualVariable] = value;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Default: false\n\t\t\t\tif (mutator.options?.applyAtShellIntegration ?? false) {\n\t\t\t\t\tconst key = `VSCODE_ENV_${mutatorTypeToLabelMap.get(mutator.type)!}`;\n\t\t\t\t\tenv[key] = (env[key] ? env[key] + ':' : '') + variable + '=' + this._encodeColons(value);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _encodeColons(value: string): string {\n\t\treturn value.replaceAll(':', '\\\\x3a');\n\t}\n\n\tprivate blockPythonActivationVar(variable: string, extensionIdentifier: string): boolean {\n\t\t// Only Python env extension can modify Python activate env var.\n\t\tif (PYTHON_ACTIVATION_VARS_PATTERN.test(variable) && PYTHON_ENV_EXTENSION_ID !== extensionIdentifier) {\n\t\t\treturn true;\n\t\t}\n\t\treturn false;\n\t}\n\n\tdiff(other: IMergedEnvironmentVariableCollection, scope: EnvironmentVariableScope | undefined): IMergedEnvironmentVariableCollectionDiff | undefined {\n\t\tconst added: Map<string, IExtensionOwnedEnvironmentVariableMutator[]> = new Map();\n\t\tconst changed: Map<string, IExtensionOwnedEnvironmentVariableMutator[]> = new Map();\n\t\tconst removed: Map<string, IExtensionOwnedEnvironmentVariableMutator[]> = new Map();\n\n\t\t// Find added\n\t\tother.getVariableMap(scope).forEach((otherMutators, variable) => {\n\t\t\tconst currentMutators = this.getVariableMap(scope).get(variable);\n\t\t\tconst result = getMissingMutatorsFromArray(otherMutators, currentMutators);\n\t\t\tif (result) {\n\t\t\t\tadded.set(variable, result);\n\t\t\t}\n\t\t});\n\n\t\t// Find removed\n\t\tthis.getVariableMap(scope).forEach((currentMutators, variable) => {\n\t\t\tconst otherMutators = other.getVariableMap(scope).get(variable);\n\t\t\tconst result = getMissingMutatorsFromArray(currentMutators, otherMutators);\n\t\t\tif (result) {\n\t\t\t\tremoved.set(variable, result);\n\t\t\t}\n\t\t});\n\n\t\t// Find changed\n\t\tthis.getVariableMap(scope).forEach((currentMutators, variable) => {\n\t\t\tconst otherMutators = other.getVariableMap(scope).get(variable);\n\t\t\tconst result = getChangedMutatorsFromArray(currentMutators, otherMutators);\n\t\t\tif (result) {\n\t\t\t\tchanged.set(variable, result);\n\t\t\t}\n\t\t});\n\n\t\tif (added.size === 0 && changed.size === 0 && removed.size === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn { added, changed, removed };\n\t}\n\n\tgetVariableMap(scope: EnvironmentVariableScope | undefined): Map<string, IExtensionOwnedEnvironmentVariableMutator[]> {\n\t\tconst result = new Map<string, IExtensionOwnedEnvironmentVariableMutator[]>();\n\t\tfor (const mutators of this.map.values()) {\n\t\t\tconst filteredMutators = mutators.filter(m => filterScope(m, scope));\n\t\t\tif (filteredMutators.length > 0) {\n\t\t\t\t// All of these mutators are for the same variable because they are in the same scope, hence choose anyone to form a key.\n\t\t\t\tresult.set(filteredMutators[0].variable, filteredMutators);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tgetDescriptionMap(scope: EnvironmentVariableScope | undefined): Map<string, string | undefined> {\n\t\tconst result = new Map<string, string | undefined>();\n\t\tfor (const mutators of this.descriptionMap.values()) {\n\t\t\tconst filteredMutators = mutators.filter(m => filterScope(m, scope, true));\n\t\t\tfor (const mutator of filteredMutators) {\n\t\t\t\tresult.set(mutator.extensionIdentifier, mutator.description);\n\t\t\t}\n\t\t}\n\t\treturn result;\n\t}\n\n\tprivate populateDescriptionMap(collection: IEnvironmentVariableCollection, extensionIdentifier: string): void {\n\t\tif (!collection.descriptionMap) {\n\t\t\treturn;\n\t\t}\n\t\tconst it = collection.descriptionMap.entries();\n\t\tlet next = it.next();\n\t\twhile (!next.done) {\n\t\t\tconst mutator = next.value[1];\n\t\t\tconst key = next.value[0];\n\t\t\tlet entry = this.descriptionMap.get(key);\n\t\t\tif (!entry) {\n\t\t\t\tentry = [];\n\t\t\t\tthis.descriptionMap.set(key, entry);\n\t\t\t}\n\t\t\tconst extensionMutator = {\n\t\t\t\textensionIdentifier,\n\t\t\t\tscope: mutator.scope,\n\t\t\t\tdescription: mutator.description\n\t\t\t};\n\t\t\tif (!extensionMutator.scope) {\n\t\t\t\tdelete extensionMutator.scope; // Convenient for tests\n\t\t\t}\n\t\t\tentry.push(extensionMutator);\n\n\t\t\tnext = it.next();\n\t\t}\n\n\t}\n}\n\n/**\n * Returns whether a mutator matches with the scope provided.\n * @param mutator Mutator to filter\n * @param scope Scope to be used for querying\n * @param strictFilter If true, mutators with global scope is not returned when querying for workspace scope.\n * i.e whether mutator scope should always exactly match with query scope.\n */\nfunction filterScope(\n\tmutator: IExtensionOwnedEnvironmentVariableMutator | IExtensionOwnedEnvironmentDescriptionMutator,\n\tscope: EnvironmentVariableScope | undefined,\n\tstrictFilter = false\n): boolean {\n\tif (!mutator.scope) {\n\t\tif (strictFilter) {\n\t\t\treturn scope === mutator.scope;\n\t\t}\n\t\treturn true;\n\t}\n\t// If a mutator is scoped to a workspace folder, only apply it if the workspace\n\t// folder matches.\n\tif (mutator.scope.workspaceFolder && scope?.workspaceFolder && mutator.scope.workspaceFolder.index === scope.workspaceFolder.index) {\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nfunction getMissingMutatorsFromArray(\n\tcurrent: IExtensionOwnedEnvironmentVariableMutator[],\n\tother: IExtensionOwnedEnvironmentVariableMutator[] | undefined\n): IExtensionOwnedEnvironmentVariableMutator[] | undefined {\n\t// If it doesn't exist, all are removed\n\tif (!other) {\n\t\treturn current;\n\t}\n\n\t// Create a map to help\n\tconst otherMutatorExtensions = new Set<string>();\n\tother.forEach(m => otherMutatorExtensions.add(m.extensionIdentifier));\n\n\t// Find entries removed from other\n\tconst result: IExtensionOwnedEnvironmentVariableMutator[] = [];\n\tcurrent.forEach(mutator => {\n\t\tif (!otherMutatorExtensions.has(mutator.extensionIdentifier)) {\n\t\t\tresult.push(mutator);\n\t\t}\n\t});\n\n\treturn result.length === 0 ? undefined : result;\n}\n\nfunction getChangedMutatorsFromArray(\n\tcurrent: IExtensionOwnedEnvironmentVariableMutator[],\n\tother: IExtensionOwnedEnvironmentVariableMutator[] | undefined\n): IExtensionOwnedEnvironmentVariableMutator[] | undefined {\n\t// If it doesn't exist, none are changed (they are removed)\n\tif (!other) {\n\t\treturn undefined;\n\t}\n\n\t// Create a map to help\n\tconst otherMutatorExtensions = new Map<string, IExtensionOwnedEnvironmentVariableMutator>();\n\tother.forEach(m => otherMutatorExtensions.set(m.extensionIdentifier, m));\n\n\t// Find entries that exist in both but are not equal\n\tconst result: IExtensionOwnedEnvironmentVariableMutator[] = [];\n\tcurrent.forEach(mutator => {\n\t\tconst otherMutator = otherMutatorExtensions.get(mutator.extensionIdentifier);\n\t\tif (otherMutator && (mutator.type !== otherMutator.type || mutator.value !== otherMutator.value || mutator.scope?.workspaceFolder?.index !== otherMutator.scope?.workspaceFolder?.index)) {\n\t\t\t// Return the new result, not the old one\n\t\t\tresult.push(otherMutator);\n\t\t}\n\t});\n\n\treturn result.length === 0 ? undefined : result;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport * as fs from 'fs';\nimport { exec } from 'child_process';\nimport { timeout } from '../../../base/common/async.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, toDisposable } from '../../../base/common/lifecycle.js';\nimport * as path from '../../../base/common/path.js';\nimport { IProcessEnvironment, isLinux, isMacintosh, isWindows } from '../../../base/common/platform.js';\nimport { findExecutable } from '../../../base/node/processes.js';\nimport { URI } from '../../../base/common/uri.js';\nimport { localize } from '../../../nls.js';\nimport { ILogService, LogLevel } from '../../log/common/log.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { FlowControlConstants, IShellLaunchConfig, ITerminalChildProcess, ITerminalLaunchError, IProcessProperty, IProcessPropertyMap as IProcessPropertyMap, ProcessPropertyType, TerminalShellType, IProcessReadyEvent, ITerminalProcessOptions, PosixShellType, IProcessReadyWindowsPty, GeneralShellType, ITerminalLaunchResult } from '../common/terminal.js';\nimport { ChildProcessMonitor } from './childProcessMonitor.js';\nimport { getShellIntegrationInjection, getWindowsBuildNumber, IShellIntegrationConfigInjection } from './terminalEnvironment.js';\nimport { WindowsShellHelper } from './windowsShellHelper.js';\nimport { IPty, IPtyForkOptions, IWindowsPtyForkOptions, spawn } from 'node-pty';\nimport { isNumber } from '../../../base/common/types.js';\n\nconst enum ShutdownConstants {\n\t/**\n\t * The amount of ms that must pass between data events after exit is queued before the actual\n\t * kill call is triggered. This data flush mechanism works around an [issue in node-pty][1]\n\t * where not all data is flushed which causes problems for task problem matchers. Additionally\n\t * on Windows under conpty, killing a process while data is being output will cause the [conhost\n\t * flush to hang the pty host][2] because [conhost should be hosted on another thread][3].\n\t *\n\t * [1]: https://github.com/Tyriar/node-pty/issues/72\n\t * [2]: https://github.com/microsoft/vscode/issues/71966\n\t * [3]: https://github.com/microsoft/node-pty/pull/415\n\t */\n\tDataFlushTimeout = 250,\n\t/**\n\t * The maximum ms to allow after dispose is called because forcefully killing the process.\n\t */\n\tMaximumShutdownTime = 5000\n}\n\nconst enum Constants {\n\t/**\n\t * The minimum duration between kill and spawn calls on Windows/conpty as a mitigation for a\n\t * hang issue. See:\n\t * - https://github.com/microsoft/vscode/issues/71966\n\t * - https://github.com/microsoft/vscode/issues/117956\n\t * - https://github.com/microsoft/vscode/issues/121336\n\t */\n\tKillSpawnThrottleInterval = 250,\n\t/**\n\t * The amount of time to wait when a call is throttled beyond the exact amount, this is used to\n\t * try prevent early timeouts causing a kill/spawn call to happen at double the regular\n\t * interval.\n\t */\n\tKillSpawnSpacingDuration = 50,\n}\n\nconst posixShellTypeMap = new Map<string, PosixShellType>([\n\t['bash', PosixShellType.Bash],\n\t['csh', PosixShellType.Csh],\n\t['fish', PosixShellType.Fish],\n\t['ksh', PosixShellType.Ksh],\n\t['sh', PosixShellType.Sh],\n\t['zsh', PosixShellType.Zsh]\n]);\n\nconst generalShellTypeMap = new Map<string, GeneralShellType>([\n\t['pwsh', GeneralShellType.PowerShell],\n\t['powershell', GeneralShellType.PowerShell],\n\t['python', GeneralShellType.Python],\n\t['julia', GeneralShellType.Julia],\n\t['nu', GeneralShellType.NuShell],\n\t['node', GeneralShellType.Node],\n\n]);\nexport class TerminalProcess extends Disposable implements ITerminalChildProcess {\n\treadonly id = 0;\n\treadonly shouldPersist = false;\n\n\tprivate _properties: IProcessPropertyMap = {\n\t\tcwd: '',\n\t\tinitialCwd: '',\n\t\tfixedDimensions: { cols: undefined, rows: undefined },\n\t\ttitle: '',\n\t\tshellType: undefined,\n\t\thasChildProcesses: true,\n\t\tresolvedShellLaunchConfig: {},\n\t\toverrideDimensions: undefined,\n\t\tfailedShellIntegrationActivation: false,\n\t\tusedShellIntegrationInjection: undefined,\n\t\tshellIntegrationInjectionFailureReason: undefined,\n\t};\n\tprivate static _lastKillOrStart = 0;\n\tprivate _exitCode: number | undefined;\n\tprivate _exitMessage: string | undefined;\n\tprivate _closeTimeout: Timeout | undefined;\n\tprivate _ptyProcess: IPty | undefined;\n\tprivate _currentTitle: string = '';\n\tprivate _processStartupComplete: Promise<void> | undefined;\n\tprivate _windowsShellHelper: WindowsShellHelper | undefined;\n\tprivate _childProcessMonitor: ChildProcessMonitor | undefined;\n\tprivate _titleInterval: Timeout | undefined;\n\tprivate _delayedResizer: DelayedResizer | undefined;\n\tprivate readonly _initialCwd: string;\n\tprivate readonly _ptyOptions: IPtyForkOptions | IWindowsPtyForkOptions;\n\n\tprivate _isPtyPaused: boolean = false;\n\tprivate _unacknowledgedCharCount: number = 0;\n\tget exitMessage(): string | undefined { return this._exitMessage; }\n\n\tget currentTitle(): string { return this._windowsShellHelper?.shellTitle || this._currentTitle; }\n\tget shellType(): TerminalShellType | undefined { return isWindows ? this._windowsShellHelper?.shellType : posixShellTypeMap.get(this._currentTitle) || generalShellTypeMap.get(this._currentTitle); }\n\tget hasChildProcesses(): boolean { return this._childProcessMonitor?.hasChildProcesses || false; }\n\n\tprivate readonly _onProcessData = this._register(new Emitter<string>());\n\treadonly onProcessData = this._onProcessData.event;\n\tprivate readonly _onProcessReady = this._register(new Emitter<IProcessReadyEvent>());\n\treadonly onProcessReady = this._onProcessReady.event;\n\tprivate readonly _onDidChangeProperty = this._register(new Emitter<IProcessProperty>());\n\treadonly onDidChangeProperty = this._onDidChangeProperty.event;\n\tprivate readonly _onProcessExit = this._register(new Emitter<number>());\n\treadonly onProcessExit = this._onProcessExit.event;\n\n\tconstructor(\n\t\treadonly shellLaunchConfig: IShellLaunchConfig,\n\t\tcwd: string,\n\t\tcols: number,\n\t\trows: number,\n\t\tenv: IProcessEnvironment,\n\t\t/**\n\t\t * environment used for `findExecutable`\n\t\t */\n\t\tprivate readonly _executableEnv: IProcessEnvironment,\n\t\tprivate readonly _options: ITerminalProcessOptions,\n\t\t@ILogService private readonly _logService: ILogService,\n\t\t@IProductService private readonly _productService: IProductService\n\t) {\n\t\tsuper();\n\t\tlet name: string;\n\t\tif (isWindows) {\n\t\t\tname = path.basename(this.shellLaunchConfig.executable || '');\n\t\t} else {\n\t\t\t// Using 'xterm-256color' here helps ensure that the majority of Linux distributions will use a\n\t\t\t// color prompt as defined in the default ~/.bashrc file.\n\t\t\tname = 'xterm-256color';\n\t\t}\n\t\tthis._initialCwd = cwd;\n\t\tthis._properties[ProcessPropertyType.InitialCwd] = this._initialCwd;\n\t\tthis._properties[ProcessPropertyType.Cwd] = this._initialCwd;\n\t\tconst useConpty = this._options.windowsEnableConpty && process.platform === 'win32' && getWindowsBuildNumber() >= 18309;\n\t\tconst useConptyDll = useConpty && this._options.windowsUseConptyDll;\n\t\tthis._ptyOptions = {\n\t\t\tname,\n\t\t\tcwd,\n\t\t\t// TODO: When node-pty is updated this cast can be removed\n\t\t\tenv: env as { [key: string]: string },\n\t\t\tcols,\n\t\t\trows,\n\t\t\tuseConpty,\n\t\t\tuseConptyDll,\n\t\t\t// This option will force conpty to not redraw the whole viewport on launch\n\t\t\tconptyInheritCursor: useConpty && !!shellLaunchConfig.initialText\n\t\t};\n\t\t// Delay resizes to avoid conpty not respecting very early resize calls\n\t\tif (isWindows) {\n\t\t\tif (useConpty && cols === 0 && rows === 0 && this.shellLaunchConfig.executable?.endsWith('Git\\\\bin\\\\bash.exe')) {\n\t\t\t\tthis._delayedResizer = new DelayedResizer();\n\t\t\t\tthis._register(this._delayedResizer.onTrigger(dimensions => {\n\t\t\t\t\tthis._delayedResizer?.dispose();\n\t\t\t\t\tthis._delayedResizer = undefined;\n\t\t\t\t\tif (dimensions.cols && dimensions.rows) {\n\t\t\t\t\t\tthis.resize(dimensions.cols, dimensions.rows);\n\t\t\t\t\t}\n\t\t\t\t}));\n\t\t\t}\n\t\t\t// WindowsShellHelper is used to fetch the process title and shell type\n\t\t\tthis.onProcessReady(e => {\n\t\t\t\tthis._windowsShellHelper = this._register(new WindowsShellHelper(e.pid));\n\t\t\t\tthis._register(this._windowsShellHelper.onShellTypeChanged(e => this._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellType, value: e })));\n\t\t\t\tthis._register(this._windowsShellHelper.onShellNameChanged(e => this._onDidChangeProperty.fire({ type: ProcessPropertyType.Title, value: e })));\n\t\t\t});\n\t\t}\n\t\tthis._register(toDisposable(() => {\n\t\t\tif (this._titleInterval) {\n\t\t\t\tclearInterval(this._titleInterval);\n\t\t\t\tthis._titleInterval = undefined;\n\t\t\t}\n\t\t}));\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis._ptyProcess = undefined;\n\t\t\tthis._processStartupComplete = undefined;\n\t\t}));\n\t}\n\n\tasync start(): Promise<ITerminalLaunchError | ITerminalLaunchResult | undefined> {\n\t\tconst results = await Promise.all([this._validateCwd(), this._validateExecutable()]);\n\t\tconst firstError = results.find(r => r !== undefined);\n\t\tif (firstError) {\n\t\t\treturn firstError;\n\t\t}\n\n\t\tconst injection = await getShellIntegrationInjection(this.shellLaunchConfig, this._options, this._ptyOptions.env, this._logService, this._productService);\n\t\tif (injection.type === 'injection') {\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.UsedShellIntegrationInjection, value: true });\n\t\t\tif (injection.envMixin) {\n\t\t\t\tfor (const [key, value] of Object.entries(injection.envMixin)) {\n\t\t\t\t\tthis._ptyOptions.env ||= {};\n\t\t\t\t\tthis._ptyOptions.env[key] = value;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (injection.filesToCopy) {\n\t\t\t\tfor (const f of injection.filesToCopy) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tawait fs.promises.mkdir(path.dirname(f.dest), { recursive: true });\n\t\t\t\t\t\tawait fs.promises.copyFile(f.source, f.dest);\n\t\t\t\t\t} catch {\n\t\t\t\t\t\t// Swallow error, this should only happen when multiple users are on the same\n\t\t\t\t\t\t// machine. Since the shell integration scripts rarely change, plus the other user\n\t\t\t\t\t\t// should be using the same version of the server in this case, assume the script is\n\t\t\t\t\t\t// fine if copy fails and swallow the error.\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.FailedShellIntegrationActivation, value: true });\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellIntegrationInjectionFailureReason, value: injection.reason });\n\t\t\t// Even if shell integration injection failed, still set the nonce if one was provided\n\t\t\t// This allows extensions to use shell integration with custom shells\n\t\t\tif (this._options.shellIntegration.nonce) {\n\t\t\t\tthis._ptyOptions.env ||= {};\n\t\t\t\tthis._ptyOptions.env['VSCODE_NONCE'] = this._options.shellIntegration.nonce;\n\t\t\t}\n\t\t}\n\n\t\ttry {\n\t\t\tconst injectionConfig: IShellIntegrationConfigInjection | undefined = injection.type === 'injection' ? injection : undefined;\n\t\t\tawait this.setupPtyProcess(this.shellLaunchConfig, this._ptyOptions, injectionConfig);\n\t\t\tif (injectionConfig?.newArgs) {\n\t\t\t\treturn { injectedArgs: injectionConfig.newArgs };\n\t\t\t}\n\t\t\treturn undefined;\n\t\t} catch (err) {\n\t\t\tthis._logService.trace('node-pty.node-pty.IPty#spawn native exception', err);\n\t\t\treturn { message: `A native exception occurred during launch (${err.message})` };\n\t\t}\n\t}\n\n\tprivate async _validateCwd(): Promise<undefined | ITerminalLaunchError> {\n\t\ttry {\n\t\t\tconst result = await fs.promises.stat(this._initialCwd);\n\t\t\tif (!result.isDirectory()) {\n\t\t\t\treturn { message: localize('launchFail.cwdNotDirectory', \"Starting directory (cwd) \\\"{0}\\\" is not a directory\", this._initialCwd.toString()) };\n\t\t\t}\n\t\t} catch (err) {\n\t\t\tif (err?.code === 'ENOENT') {\n\t\t\t\treturn { message: localize('launchFail.cwdDoesNotExist', \"Starting directory (cwd) \\\"{0}\\\" does not exist\", this._initialCwd.toString()) };\n\t\t\t}\n\t\t}\n\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.InitialCwd, value: this._initialCwd });\n\t\treturn undefined;\n\t}\n\n\tprivate async _validateExecutable(): Promise<undefined | ITerminalLaunchError> {\n\t\tconst slc = this.shellLaunchConfig;\n\t\tif (!slc.executable) {\n\t\t\tthrow new Error('IShellLaunchConfig.executable not set');\n\t\t}\n\n\t\tconst cwd = slc.cwd instanceof URI ? slc.cwd.path : slc.cwd;\n\t\tconst envPaths: string[] | undefined = (slc.env && slc.env.PATH) ? slc.env.PATH.split(path.delimiter) : undefined;\n\t\tconst executable = await findExecutable(slc.executable, cwd, envPaths, this._executableEnv);\n\t\tif (!executable) {\n\t\t\treturn { message: localize('launchFail.executableDoesNotExist', \"Path to shell executable \\\"{0}\\\" does not exist\", slc.executable) };\n\t\t}\n\n\t\ttry {\n\t\t\tconst result = await fs.promises.stat(executable);\n\t\t\tif (!result.isFile() && !result.isSymbolicLink()) {\n\t\t\t\treturn { message: localize('launchFail.executableIsNotFileOrSymlink', \"Path to shell executable \\\"{0}\\\" is not a file or a symlink\", slc.executable) };\n\t\t\t}\n\t\t\t// Set the executable explicitly here so that node-pty doesn't need to search the\n\t\t\t// $PATH too.\n\t\t\tslc.executable = executable;\n\t\t} catch (err) {\n\t\t\tif (err?.code === 'EACCES') {\n\t\t\t\t// Swallow\n\t\t\t} else {\n\t\t\t\tthrow err;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tprivate async setupPtyProcess(\n\t\tshellLaunchConfig: IShellLaunchConfig,\n\t\toptions: IPtyForkOptions,\n\t\tshellIntegrationInjection: IShellIntegrationConfigInjection | undefined\n\t): Promise<void> {\n\t\tconst args = shellIntegrationInjection?.newArgs || shellLaunchConfig.args || [];\n\t\tawait this._throttleKillSpawn();\n\t\tthis._logService.trace('node-pty.IPty#spawn', shellLaunchConfig.executable, args, options);\n\t\tconst ptyProcess = spawn(shellLaunchConfig.executable!, args, options);\n\t\tthis._ptyProcess = ptyProcess;\n\t\tthis._childProcessMonitor = this._register(new ChildProcessMonitor(ptyProcess.pid, this._logService));\n\t\tthis._register(this._childProcessMonitor.onDidChangeHasChildProcesses(value => this._onDidChangeProperty.fire({ type: ProcessPropertyType.HasChildProcesses, value })));\n\t\tthis._processStartupComplete = new Promise<void>(c => {\n\t\t\tthis._register(this.onProcessReady(() => c()));\n\t\t});\n\t\tthis._register(ptyProcess.onData(data => {\n\t\t\t// Handle flow control\n\t\t\tthis._unacknowledgedCharCount += data.length;\n\t\t\tif (!this._isPtyPaused && this._unacknowledgedCharCount > FlowControlConstants.HighWatermarkChars) {\n\t\t\t\tthis._logService.trace(`Flow control: Pause (${this._unacknowledgedCharCount} > ${FlowControlConstants.HighWatermarkChars})`);\n\t\t\t\tthis._isPtyPaused = true;\n\t\t\t\tptyProcess.pause();\n\t\t\t}\n\n\t\t\t// Refire the data event\n\t\t\tthis._logService.trace('node-pty.IPty#onData', data);\n\t\t\tthis._onProcessData.fire(data);\n\t\t\tif (this._closeTimeout) {\n\t\t\t\tthis._queueProcessExit();\n\t\t\t}\n\t\t\tthis._windowsShellHelper?.checkShell();\n\t\t\tthis._childProcessMonitor?.handleOutput();\n\t\t}));\n\t\tthis._register(ptyProcess.onExit(e => {\n\t\t\tthis._exitCode = e.exitCode;\n\t\t\tthis._queueProcessExit();\n\t\t}));\n\t\tthis._sendProcessId(ptyProcess.pid);\n\t\tthis._setupTitlePolling(ptyProcess);\n\t}\n\n\tprivate _setupTitlePolling(ptyProcess: IPty) {\n\t\t// Send initial timeout async to give event listeners a chance to init\n\t\tsetTimeout(() => this._sendProcessTitle(ptyProcess));\n\t\t// Setup polling for non-Windows, for Windows `process` doesn't change\n\t\tif (!isWindows) {\n\t\t\tthis._titleInterval = setInterval(() => {\n\t\t\t\tif (this._currentTitle !== ptyProcess.process) {\n\t\t\t\t\tthis._sendProcessTitle(ptyProcess);\n\t\t\t\t}\n\t\t\t}, 200);\n\t\t}\n\t}\n\n\t// Allow any trailing data events to be sent before the exit event is sent.\n\t// See https://github.com/Tyriar/node-pty/issues/72\n\tprivate _queueProcessExit() {\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis._logService.trace('TerminalProcess#_queueProcessExit', new Error().stack?.replace(/^Error/, ''));\n\t\t}\n\t\tif (this._closeTimeout) {\n\t\t\tclearTimeout(this._closeTimeout);\n\t\t}\n\t\tthis._closeTimeout = setTimeout(() => {\n\t\t\tthis._closeTimeout = undefined;\n\t\t\tthis._kill();\n\t\t}, ShutdownConstants.DataFlushTimeout);\n\t}\n\n\tprivate async _kill(): Promise<void> {\n\t\t// Wait to kill to process until the start up code has run. This prevents us from firing a process exit before a\n\t\t// process start.\n\t\tawait this._processStartupComplete;\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\t// Attempt to kill the pty, it may have already been killed at this\n\t\t// point but we want to make sure\n\t\ttry {\n\t\t\tif (this._ptyProcess) {\n\t\t\t\tawait this._throttleKillSpawn();\n\t\t\t\tthis._logService.trace('node-pty.IPty#kill');\n\t\t\t\tthis._ptyProcess.kill();\n\t\t\t}\n\t\t} catch (ex) {\n\t\t\t// Swallow, the pty has already been killed\n\t\t}\n\t\tthis._onProcessExit.fire(this._exitCode || 0);\n\t\tthis.dispose();\n\t}\n\n\tprivate async _throttleKillSpawn(): Promise<void> {\n\t\t// Only throttle on Windows/conpty\n\t\tif (!isWindows || !hasConptyOption(this._ptyOptions) || !this._ptyOptions.useConpty) {\n\t\t\treturn;\n\t\t}\n\t\t// Don't throttle when using conpty.dll as it seems to have been fixed in later versions\n\t\tif (this._ptyOptions.useConptyDll) {\n\t\t\treturn;\n\t\t}\n\t\t// Use a loop to ensure multiple calls in a single interval space out\n\t\twhile (Date.now() - TerminalProcess._lastKillOrStart < Constants.KillSpawnThrottleInterval) {\n\t\t\tthis._logService.trace('Throttling kill/spawn call');\n\t\t\tawait timeout(Constants.KillSpawnThrottleInterval - (Date.now() - TerminalProcess._lastKillOrStart) + Constants.KillSpawnSpacingDuration);\n\t\t}\n\t\tTerminalProcess._lastKillOrStart = Date.now();\n\t}\n\n\tprivate _sendProcessId(pid: number) {\n\t\tthis._onProcessReady.fire({\n\t\t\tpid,\n\t\t\tcwd: this._initialCwd,\n\t\t\twindowsPty: this.getWindowsPty()\n\t\t});\n\t}\n\n\tprivate _sendProcessTitle(ptyProcess: IPty): void {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\t// HACK: The node-pty API can return undefined somehow https://github.com/microsoft/vscode/issues/222323\n\t\tthis._currentTitle = (ptyProcess.process ?? '');\n\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.Title, value: this._currentTitle });\n\t\t// If fig is installed it may change the title of the process\n\t\tlet sanitizedTitle = this.currentTitle.replace(/ \\(figterm\\)$/g, '');\n\t\t// Ensure any prefixed path is removed so that the executable name since we use this to\n\t\t// detect the shell type\n\t\tif (!isWindows) {\n\t\t\tsanitizedTitle = path.basename(sanitizedTitle);\n\t\t}\n\n\t\tif (sanitizedTitle.toLowerCase().startsWith('python')) {\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellType, value: GeneralShellType.Python });\n\t\t} else if (sanitizedTitle.toLowerCase().startsWith('julia')) {\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellType, value: GeneralShellType.Julia });\n\t\t} else {\n\t\t\tconst shellTypeValue = posixShellTypeMap.get(sanitizedTitle) || generalShellTypeMap.get(sanitizedTitle);\n\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.ShellType, value: shellTypeValue });\n\t\t}\n\t}\n\n\tshutdown(immediate: boolean): void {\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis._logService.trace('TerminalProcess#shutdown', new Error().stack?.replace(/^Error/, ''));\n\t\t}\n\t\t// don't force immediate disposal of the terminal processes on Windows as an additional\n\t\t// mitigation for https://github.com/microsoft/vscode/issues/71966 which causes the pty host\n\t\t// to become unresponsive, disconnecting all terminals across all windows.\n\t\tif (immediate && !isWindows) {\n\t\t\tthis._kill();\n\t\t} else {\n\t\t\tif (!this._closeTimeout && !this._store.isDisposed) {\n\t\t\t\tthis._queueProcessExit();\n\t\t\t\t// Allow a maximum amount of time for the process to exit, otherwise force kill it\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (this._closeTimeout && !this._store.isDisposed) {\n\t\t\t\t\t\tthis._closeTimeout = undefined;\n\t\t\t\t\t\tthis._kill();\n\t\t\t\t\t}\n\t\t\t\t}, ShutdownConstants.MaximumShutdownTime);\n\t\t\t}\n\t\t}\n\t}\n\n\tinput(data: string, isBinary: boolean = false): void {\n\t\tthis._logService.trace('node-pty.IPty#write', data, isBinary);\n\t\tif (isBinary) {\n\t\t\tthis._ptyProcess!.write(Buffer.from(data, 'binary'));\n\t\t} else {\n\t\t\tthis._ptyProcess!.write(data);\n\t\t}\n\t\tthis._childProcessMonitor?.handleInput();\n\t}\n\n\tsendSignal(signal: string): void {\n\t\tif (this._store.isDisposed || !this._ptyProcess) {\n\t\t\treturn;\n\t\t}\n\t\tthis._ptyProcess.kill(signal);\n\t}\n\n\tasync processBinary(data: string): Promise<void> {\n\t\tthis.input(data, true);\n\t}\n\n\tasync refreshProperty<T extends ProcessPropertyType>(type: T): Promise<IProcessPropertyMap[T]> {\n\t\tswitch (type) {\n\t\t\tcase ProcessPropertyType.Cwd: {\n\t\t\t\tconst newCwd = await this.getCwd();\n\t\t\t\tif (newCwd !== this._properties.cwd) {\n\t\t\t\t\tthis._properties.cwd = newCwd;\n\t\t\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.Cwd, value: this._properties.cwd });\n\t\t\t\t}\n\t\t\t\treturn newCwd as IProcessPropertyMap[T];\n\t\t\t}\n\t\t\tcase ProcessPropertyType.InitialCwd: {\n\t\t\t\tconst initialCwd = await this.getInitialCwd();\n\t\t\t\tif (initialCwd !== this._properties.initialCwd) {\n\t\t\t\t\tthis._properties.initialCwd = initialCwd;\n\t\t\t\t\tthis._onDidChangeProperty.fire({ type: ProcessPropertyType.InitialCwd, value: this._properties.initialCwd });\n\t\t\t\t}\n\t\t\t\treturn initialCwd as IProcessPropertyMap[T];\n\t\t\t}\n\t\t\tcase ProcessPropertyType.Title:\n\t\t\t\treturn this.currentTitle as IProcessPropertyMap[T];\n\t\t\tdefault:\n\t\t\t\treturn this.shellType as IProcessPropertyMap[T];\n\t\t}\n\t}\n\n\tasync updateProperty<T extends ProcessPropertyType>(type: T, value: IProcessPropertyMap[T]): Promise<void> {\n\t\tif (type === ProcessPropertyType.FixedDimensions) {\n\t\t\tthis._properties.fixedDimensions = value as IProcessPropertyMap[ProcessPropertyType.FixedDimensions];\n\t\t}\n\t}\n\n\tresize(cols: number, rows: number): void {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tif (!isNumber(cols) || !isNumber(rows)) {\n\t\t\treturn;\n\t\t}\n\t\t// Ensure that cols and rows are always >= 1, this prevents a native\n\t\t// exception in winpty.\n\t\tif (this._ptyProcess) {\n\t\t\tcols = Math.max(cols, 1);\n\t\t\trows = Math.max(rows, 1);\n\n\t\t\t// Delay resize if needed\n\t\t\tif (this._delayedResizer) {\n\t\t\t\tthis._delayedResizer.cols = cols;\n\t\t\t\tthis._delayedResizer.rows = rows;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis._logService.trace('node-pty.IPty#resize', cols, rows);\n\t\t\ttry {\n\t\t\t\tthis._ptyProcess.resize(cols, rows);\n\t\t\t} catch (e) {\n\t\t\t\t// Swallow error if the pty has already exited\n\t\t\t\tthis._logService.trace('node-pty.IPty#resize exception ' + e.message);\n\t\t\t\tif (this._exitCode !== undefined &&\n\t\t\t\t\te.message !== 'ioctl(2) failed, EBADF' &&\n\t\t\t\t\te.message !== 'Cannot resize a pty that has already exited') {\n\t\t\t\t\tthrow e;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tclearBuffer(): void {\n\t\tthis._ptyProcess?.clear();\n\t}\n\n\tacknowledgeDataEvent(charCount: number): void {\n\t\t// Prevent lower than 0 to heal from errors\n\t\tthis._unacknowledgedCharCount = Math.max(this._unacknowledgedCharCount - charCount, 0);\n\t\tthis._logService.trace(`Flow control: Ack ${charCount} chars (unacknowledged: ${this._unacknowledgedCharCount})`);\n\t\tif (this._isPtyPaused && this._unacknowledgedCharCount < FlowControlConstants.LowWatermarkChars) {\n\t\t\tthis._logService.trace(`Flow control: Resume (${this._unacknowledgedCharCount} < ${FlowControlConstants.LowWatermarkChars})`);\n\t\t\tthis._ptyProcess?.resume();\n\t\t\tthis._isPtyPaused = false;\n\t\t}\n\t}\n\n\tclearUnacknowledgedChars(): void {\n\t\tthis._unacknowledgedCharCount = 0;\n\t\tthis._logService.trace(`Flow control: Cleared all unacknowledged chars, forcing resume`);\n\t\tif (this._isPtyPaused) {\n\t\t\tthis._ptyProcess?.resume();\n\t\t\tthis._isPtyPaused = false;\n\t\t}\n\t}\n\n\tasync setUnicodeVersion(version: '6' | '11'): Promise<void> {\n\t\t// No-op\n\t}\n\n\tgetInitialCwd(): Promise<string> {\n\t\treturn Promise.resolve(this._initialCwd);\n\t}\n\n\tasync getCwd(): Promise<string> {\n\t\tif (isMacintosh) {\n\t\t\t// From Big Sur (darwin v20) there is a spawn blocking thread issue on Electron,\n\t\t\t// this is fixed in VS Code's internal Electron.\n\t\t\t// https://github.com/Microsoft/vscode/issues/105446\n\t\t\treturn new Promise<string>(resolve => {\n\t\t\t\tif (!this._ptyProcess) {\n\t\t\t\t\tresolve(this._initialCwd);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis._logService.trace('node-pty.IPty#pid');\n\t\t\t\texec('lsof -OPln -p ' + this._ptyProcess.pid + ' | grep cwd', { env: { ...process.env, LANG: 'en_US.UTF-8' } }, (error, stdout, stderr) => {\n\t\t\t\t\tif (!error && stdout !== '') {\n\t\t\t\t\t\tresolve(stdout.substring(stdout.indexOf('/'), stdout.length - 1));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis._logService.error('lsof did not run successfully, it may not be on the $PATH?', error, stdout, stderr);\n\t\t\t\t\t\tresolve(this._initialCwd);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (isLinux) {\n\t\t\tif (!this._ptyProcess) {\n\t\t\t\treturn this._initialCwd;\n\t\t\t}\n\t\t\tthis._logService.trace('node-pty.IPty#pid');\n\t\t\ttry {\n\t\t\t\treturn await fs.promises.readlink(`/proc/${this._ptyProcess.pid}/cwd`);\n\t\t\t} catch (error) {\n\t\t\t\treturn this._initialCwd;\n\t\t\t}\n\t\t}\n\n\t\treturn this._initialCwd;\n\t}\n\n\tgetWindowsPty(): IProcessReadyWindowsPty | undefined {\n\t\treturn isWindows ? {\n\t\t\tbackend: hasConptyOption(this._ptyOptions) && this._ptyOptions.useConpty ? 'conpty' : 'winpty',\n\t\t\tbuildNumber: getWindowsBuildNumber()\n\t\t} : undefined;\n\t}\n}\n\n/**\n * Tracks the latest resize event to be trigger at a later point.\n */\nclass DelayedResizer extends Disposable {\n\trows: number | undefined;\n\tcols: number | undefined;\n\tprivate _timeout: Timeout;\n\n\tprivate readonly _onTrigger = this._register(new Emitter<{ rows?: number; cols?: number }>());\n\tget onTrigger(): Event<{ rows?: number; cols?: number }> { return this._onTrigger.event; }\n\n\tconstructor() {\n\t\tsuper();\n\t\tthis._timeout = setTimeout(() => {\n\t\t\tthis._onTrigger.fire({ rows: this.rows, cols: this.cols });\n\t\t}, 1000);\n\t\tthis._register(toDisposable(() => clearTimeout(this._timeout)));\n\t}\n}\n\nfunction hasConptyOption(obj: IPtyForkOptions | IWindowsPtyForkOptions): obj is IWindowsPtyForkOptions {\n\treturn 'useConpty' in obj;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IProductConfiguration } from '../../../base/common/product.js';\nimport { createDecorator } from '../../instantiation/common/instantiation.js';\n\nexport const IProductService = createDecorator<IProductService>('productService');\n\nexport interface IProductService extends Readonly<IProductConfiguration> {\n\n\treadonly _serviceBrand: undefined;\n\n}\n\nexport const productSchemaId = 'vscode://schemas/vscode-product';\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { exec } from 'child_process';\nimport { totalmem } from 'os';\nimport { FileAccess } from '../common/network.js';\nimport { ProcessItem } from '../common/processes.js';\nimport { isWindows } from '../common/platform.js';\n\nexport const JS_FILENAME_PATTERN = /[a-zA-Z-]+\\.js\\b/g;\n\nexport function listProcesses(rootPid: number): Promise<ProcessItem> {\n\treturn new Promise((resolve, reject) => {\n\t\tlet rootItem: ProcessItem | undefined;\n\t\tconst map = new Map<number, ProcessItem>();\n\t\tconst totalMemory = totalmem();\n\n\t\tfunction addToTree(pid: number, ppid: number, cmd: string, load: number, mem: number) {\n\t\t\tconst parent = map.get(ppid);\n\t\t\tif (pid === rootPid || parent) {\n\t\t\t\tconst item: ProcessItem = {\n\t\t\t\t\tname: findName(cmd),\n\t\t\t\t\tcmd,\n\t\t\t\t\tpid,\n\t\t\t\t\tppid,\n\t\t\t\t\tload,\n\t\t\t\t\tmem: isWindows ? mem : (totalMemory * (mem / 100))\n\t\t\t\t};\n\t\t\t\tmap.set(pid, item);\n\n\t\t\t\tif (pid === rootPid) {\n\t\t\t\t\trootItem = item;\n\t\t\t\t}\n\n\t\t\t\tif (parent) {\n\t\t\t\t\tif (!parent.children) {\n\t\t\t\t\t\tparent.children = [];\n\t\t\t\t\t}\n\t\t\t\t\tparent.children.push(item);\n\t\t\t\t\tif (parent.children.length > 1) {\n\t\t\t\t\t\tparent.children = parent.children.sort((a, b) => a.pid - b.pid);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction findName(cmd: string): string {\n\t\t\tconst UTILITY_NETWORK_HINT = /--utility-sub-type=network/i;\n\t\t\tconst WINDOWS_CRASH_REPORTER = /--crashes-directory/i;\n\t\t\tconst WINPTY = /\\\\pipe\\\\winpty-control/i;\n\t\t\tconst CONPTY = /conhost\\.exe.+--headless/i;\n\t\t\tconst TYPE = /--type=([a-zA-Z-]+)/;\n\n\t\t\t// find windows crash reporter\n\t\t\tif (WINDOWS_CRASH_REPORTER.exec(cmd)) {\n\t\t\t\treturn 'electron-crash-reporter';\n\t\t\t}\n\n\t\t\t// find winpty process\n\t\t\tif (WINPTY.exec(cmd)) {\n\t\t\t\treturn 'winpty-agent';\n\t\t\t}\n\n\t\t\t// find conpty process\n\t\t\tif (CONPTY.exec(cmd)) {\n\t\t\t\treturn 'conpty-agent';\n\t\t\t}\n\n\t\t\t// find \"--type=xxxx\"\n\t\t\tlet matches = TYPE.exec(cmd);\n\t\t\tif (matches && matches.length === 2) {\n\t\t\t\tif (matches[1] === 'renderer') {\n\t\t\t\t\treturn `window`;\n\t\t\t\t} else if (matches[1] === 'utility') {\n\t\t\t\t\tif (UTILITY_NETWORK_HINT.exec(cmd)) {\n\t\t\t\t\t\treturn 'utility-network-service';\n\t\t\t\t\t}\n\n\t\t\t\t\treturn 'utility-process';\n\t\t\t\t} else if (matches[1] === 'extensionHost') {\n\t\t\t\t\treturn 'extension-host'; // normalize remote extension host type\n\t\t\t\t}\n\t\t\t\treturn matches[1];\n\t\t\t}\n\n\t\t\tif (cmd.indexOf('node ') < 0 && cmd.indexOf('node.exe') < 0) {\n\t\t\t\tlet result = ''; // find all xyz.js\n\t\t\t\tdo {\n\t\t\t\t\tmatches = JS_FILENAME_PATTERN.exec(cmd);\n\t\t\t\t\tif (matches) {\n\t\t\t\t\t\tresult += matches + ' ';\n\t\t\t\t\t}\n\t\t\t\t} while (matches);\n\n\t\t\t\tif (result) {\n\t\t\t\t\treturn `electron-nodejs (${result.trim()})`;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn cmd;\n\t\t}\n\n\t\tif (process.platform === 'win32') {\n\t\t\tconst cleanUNCPrefix = (value: string): string => {\n\t\t\t\tif (value.indexOf('\\\\\\\\?\\\\') === 0) {\n\t\t\t\t\treturn value.substring(4);\n\t\t\t\t} else if (value.indexOf('\\\\??\\\\') === 0) {\n\t\t\t\t\treturn value.substring(4);\n\t\t\t\t} else if (value.indexOf('\"\\\\\\\\?\\\\') === 0) {\n\t\t\t\t\treturn '\"' + value.substring(5);\n\t\t\t\t} else if (value.indexOf('\"\\\\??\\\\') === 0) {\n\t\t\t\t\treturn '\"' + value.substring(5);\n\t\t\t\t} else {\n\t\t\t\t\treturn value;\n\t\t\t\t}\n\t\t\t};\n\n\t\t\t(import('@vscode/windows-process-tree')).then(windowsProcessTree => {\n\t\t\t\twindowsProcessTree.getProcessList(rootPid, (processList) => {\n\t\t\t\t\tif (!processList) {\n\t\t\t\t\t\treject(new Error(`Root process ${rootPid} not found`));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t\twindowsProcessTree.getProcessCpuUsage(processList, (completeProcessList) => {\n\t\t\t\t\t\tconst processItems: Map<number, ProcessItem> = new Map();\n\t\t\t\t\t\tcompleteProcessList.forEach(process => {\n\t\t\t\t\t\t\tconst commandLine = cleanUNCPrefix(process.commandLine || '');\n\t\t\t\t\t\t\tprocessItems.set(process.pid, {\n\t\t\t\t\t\t\t\tname: findName(commandLine),\n\t\t\t\t\t\t\t\tcmd: commandLine,\n\t\t\t\t\t\t\t\tpid: process.pid,\n\t\t\t\t\t\t\t\tppid: process.ppid,\n\t\t\t\t\t\t\t\tload: process.cpu || 0,\n\t\t\t\t\t\t\t\tmem: process.memory || 0\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\trootItem = processItems.get(rootPid);\n\t\t\t\t\t\tif (rootItem) {\n\t\t\t\t\t\t\tprocessItems.forEach(item => {\n\t\t\t\t\t\t\t\tconst parent = processItems.get(item.ppid);\n\t\t\t\t\t\t\t\tif (parent) {\n\t\t\t\t\t\t\t\t\tif (!parent.children) {\n\t\t\t\t\t\t\t\t\t\tparent.children = [];\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\tparent.children.push(item);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\tprocessItems.forEach(item => {\n\t\t\t\t\t\t\t\tif (item.children) {\n\t\t\t\t\t\t\t\t\titem.children = item.children.sort((a, b) => a.pid - b.pid);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\tresolve(rootItem);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\treject(new Error(`Root process ${rootPid} not found`));\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}, windowsProcessTree.ProcessDataFlag.CommandLine | windowsProcessTree.ProcessDataFlag.Memory);\n\t\t\t});\n\t\t}\n\n\t\t// OS X & Linux\n\t\telse {\n\t\t\tfunction calculateLinuxCpuUsage() {\n\n\t\t\t\t// Flatten rootItem to get a list of all VSCode processes\n\t\t\t\tlet processes = [rootItem];\n\t\t\t\tconst pids: number[] = [];\n\t\t\t\twhile (processes.length) {\n\t\t\t\t\tconst process = processes.shift();\n\t\t\t\t\tif (process) {\n\t\t\t\t\t\tpids.push(process.pid);\n\t\t\t\t\t\tif (process.children) {\n\t\t\t\t\t\t\tprocesses = processes.concat(process.children);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\t// The cpu usage value reported on Linux is the average over the process lifetime,\n\t\t\t\t// recalculate the usage over a one second interval\n\t\t\t\t// JSON.stringify is needed to escape spaces, https://github.com/nodejs/node/issues/6803\n\t\t\t\tlet cmd = JSON.stringify(FileAccess.asFileUri('vs/base/node/cpuUsage.sh').fsPath);\n\t\t\t\tcmd += ' ' + pids.join(' ');\n\n\t\t\t\texec(cmd, {}, (err, stdout, stderr) => {\n\t\t\t\t\tif (err || stderr) {\n\t\t\t\t\t\treject(err || new Error(stderr.toString()));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst cpuUsage = stdout.toString().split('\\n');\n\t\t\t\t\t\tfor (let i = 0; i < pids.length; i++) {\n\t\t\t\t\t\t\tconst processInfo = map.get(pids[i])!;\n\t\t\t\t\t\t\tprocessInfo.load = parseFloat(cpuUsage[i]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (!rootItem) {\n\t\t\t\t\t\t\treject(new Error(`Root process ${rootPid} not found`));\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tresolve(rootItem);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t}\n\n\t\t\texec('which ps', {}, (err, stdout, stderr) => {\n\t\t\t\tif (err || stderr) {\n\t\t\t\t\tif (process.platform !== 'linux') {\n\t\t\t\t\t\treject(err || new Error(stderr.toString()));\n\t\t\t\t\t} else {\n\t\t\t\t\t\tconst cmd = JSON.stringify(FileAccess.asFileUri('vs/base/node/ps.sh').fsPath);\n\t\t\t\t\t\texec(cmd, {}, (err, stdout, stderr) => {\n\t\t\t\t\t\t\tif (err || stderr) {\n\t\t\t\t\t\t\t\treject(err || new Error(stderr.toString()));\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tparsePsOutput(stdout, addToTree);\n\t\t\t\t\t\t\t\tcalculateLinuxCpuUsage();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconst ps = stdout.toString().trim();\n\t\t\t\t\tconst args = '-ax -o pid=,ppid=,pcpu=,pmem=,command=';\n\n\t\t\t\t\t// Set numeric locale to ensure '.' is used as the decimal separator\n\t\t\t\t\texec(`${ps} ${args}`, { maxBuffer: 1000 * 1024, env: { LC_NUMERIC: 'en_US.UTF-8' } }, (err, stdout, stderr) => {\n\t\t\t\t\t\t// Silently ignoring the screen size is bogus error. See https://github.com/microsoft/vscode/issues/98590\n\t\t\t\t\t\tif (err || (stderr && !stderr.includes('screen size is bogus'))) {\n\t\t\t\t\t\t\treject(err || new Error(stderr.toString()));\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tparsePsOutput(stdout, addToTree);\n\n\t\t\t\t\t\t\tif (process.platform === 'linux') {\n\t\t\t\t\t\t\t\tcalculateLinuxCpuUsage();\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tif (!rootItem) {\n\t\t\t\t\t\t\t\t\treject(new Error(`Root process ${rootPid} not found`));\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tresolve(rootItem);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t});\n}\n\nfunction parsePsOutput(stdout: string, addToTree: (pid: number, ppid: number, cmd: string, load: number, mem: number) => void): void {\n\tconst PID_CMD = /^\\s*([0-9]+)\\s+([0-9]+)\\s+([0-9]+\\.[0-9]+)\\s+([0-9]+\\.[0-9]+)\\s+(.+)$/;\n\tconst lines = stdout.toString().split('\\n');\n\tfor (const line of lines) {\n\t\tconst matches = PID_CMD.exec(line.trim());\n\t\tif (matches && matches.length === 6) {\n\t\t\taddToTree(parseInt(matches[1]), parseInt(matches[2]), matches[5], parseFloat(matches[3]), parseFloat(matches[4]));\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { parse } from '../../../base/common/path.js';\nimport { debounce, throttle } from '../../../base/common/decorators.js';\nimport { Emitter } from '../../../base/common/event.js';\nimport { Disposable } from '../../../base/common/lifecycle.js';\nimport { ProcessItem } from '../../../base/common/processes.js';\nimport { listProcesses } from '../../../base/node/ps.js';\nimport { ILogService } from '../../log/common/log.js';\n\nconst enum Constants {\n\t/**\n\t * The amount of time to throttle checks when the process receives output.\n\t */\n\tInactiveThrottleDuration = 5000,\n\t/**\n\t * The amount of time to debounce check when the process receives input.\n\t */\n\tActiveDebounceDuration = 1000,\n}\n\nexport const ignoreProcessNames: string[] = [];\n\n/**\n * Monitors a process for child processes, checking at differing times depending on input and output\n * calls into the monitor.\n */\nexport class ChildProcessMonitor extends Disposable {\n\tprivate _hasChildProcesses: boolean = false;\n\tprivate set hasChildProcesses(value: boolean) {\n\t\tif (this._hasChildProcesses !== value) {\n\t\t\tthis._hasChildProcesses = value;\n\t\t\tthis._logService.debug('ChildProcessMonitor: Has child processes changed', value);\n\t\t\tthis._onDidChangeHasChildProcesses.fire(value);\n\t\t}\n\t}\n\t/**\n\t * Whether the process has child processes.\n\t */\n\tget hasChildProcesses(): boolean { return this._hasChildProcesses; }\n\n\tprivate readonly _onDidChangeHasChildProcesses = this._register(new Emitter<boolean>());\n\t/**\n\t * An event that fires when whether the process has child processes changes.\n\t */\n\treadonly onDidChangeHasChildProcesses = this._onDidChangeHasChildProcesses.event;\n\n\tconstructor(\n\t\tprivate readonly _pid: number,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t}\n\n\t/**\n\t * Input was triggered on the process.\n\t */\n\thandleInput() {\n\t\tthis._refreshActive();\n\t}\n\n\t/**\n\t * Output was triggered on the process.\n\t */\n\thandleOutput() {\n\t\tthis._refreshInactive();\n\t}\n\n\t@debounce(Constants.ActiveDebounceDuration)\n\tprivate async _refreshActive(): Promise<void> {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\ttry {\n\t\t\tconst processItem = await listProcesses(this._pid);\n\t\t\tthis.hasChildProcesses = this._processContainsChildren(processItem);\n\t\t} catch (e) {\n\t\t\tthis._logService.debug('ChildProcessMonitor: Fetching process tree failed', e);\n\t\t}\n\t}\n\n\t@throttle(Constants.InactiveThrottleDuration)\n\tprivate _refreshInactive(): void {\n\t\tthis._refreshActive();\n\t}\n\n\tprivate _processContainsChildren(processItem: ProcessItem): boolean {\n\t\t// No child processes\n\t\tif (!processItem.children) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// A single child process, handle special cases\n\t\tif (processItem.children.length === 1) {\n\t\t\tconst item = processItem.children[0];\n\t\t\tlet cmd: string;\n\t\t\tif (item.cmd.startsWith(`\"`)) {\n\t\t\t\tcmd = item.cmd.substring(1, item.cmd.indexOf(`\"`, 1));\n\t\t\t} else {\n\t\t\t\tconst spaceIndex = item.cmd.indexOf(` `);\n\t\t\t\tif (spaceIndex === -1) {\n\t\t\t\t\tcmd = item.cmd;\n\t\t\t\t} else {\n\t\t\t\t\tcmd = item.cmd.substring(0, spaceIndex);\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn ignoreProcessNames.indexOf(parse(cmd).name) === -1;\n\t\t}\n\n\t\t// Fallback, count child processes\n\t\treturn processItem.children.length > 0;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from '../../../base/common/async.js';\nimport { debounce } from '../../../base/common/decorators.js';\nimport { Emitter, Event } from '../../../base/common/event.js';\nimport { Disposable, IDisposable } from '../../../base/common/lifecycle.js';\nimport { isWindows, platform } from '../../../base/common/platform.js';\nimport { GeneralShellType, TerminalShellType, WindowsShellType } from '../common/terminal.js';\nimport type * as WindowsProcessTreeType from '@vscode/windows-process-tree';\n\nexport interface IWindowsShellHelper extends IDisposable {\n\treadonly onShellNameChanged: Event<string>;\n\treadonly onShellTypeChanged: Event<TerminalShellType | undefined>;\n\tgetShellType(title: string): TerminalShellType | undefined;\n\tgetShellName(): Promise<string>;\n}\n\nconst SHELL_EXECUTABLES = [\n\t'cmd.exe',\n\t'powershell.exe',\n\t'pwsh.exe',\n\t'bash.exe',\n\t'git-cmd.exe',\n\t'wsl.exe',\n\t'ubuntu.exe',\n\t'ubuntu1804.exe',\n\t'kali.exe',\n\t'debian.exe',\n\t'opensuse-42.exe',\n\t'sles-12.exe',\n\t'julia.exe',\n\t'nu.exe',\n\t'node.exe',\n];\n\nconst SHELL_EXECUTABLE_REGEXES = [\n\t/^python(\\d(\\.\\d{0,2})?)?\\.exe$/,\n];\n\nlet windowsProcessTree: typeof WindowsProcessTreeType;\n\nexport class WindowsShellHelper extends Disposable implements IWindowsShellHelper {\n\tprivate _currentRequest: Promise<string> | undefined;\n\tprivate _shellType: TerminalShellType | undefined;\n\tget shellType(): TerminalShellType | undefined { return this._shellType; }\n\tprivate _shellTitle: string = '';\n\tget shellTitle(): string { return this._shellTitle; }\n\tprivate readonly _onShellNameChanged = new Emitter<string>();\n\tget onShellNameChanged(): Event<string> { return this._onShellNameChanged.event; }\n\tprivate readonly _onShellTypeChanged = new Emitter<TerminalShellType | undefined>();\n\tget onShellTypeChanged(): Event<TerminalShellType | undefined> { return this._onShellTypeChanged.event; }\n\n\tconstructor(\n\t\tprivate _rootProcessId: number\n\t) {\n\t\tsuper();\n\n\t\tif (!isWindows) {\n\t\t\tthrow new Error(`WindowsShellHelper cannot be instantiated on ${platform}`);\n\t\t}\n\n\t\tthis._startMonitoringShell();\n\t}\n\n\tprivate async _startMonitoringShell(): Promise<void> {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tthis.checkShell();\n\t}\n\n\t@debounce(500)\n\tasync checkShell(): Promise<void> {\n\t\tif (isWindows) {\n\t\t\t// Wait to give the shell some time to actually launch a process, this\n\t\t\t// could lead to a race condition but it would be recovered from when\n\t\t\t// data stops and should cover the majority of cases\n\t\t\tawait timeout(300);\n\t\t\tthis.getShellName().then(title => {\n\t\t\t\tconst type = this.getShellType(title);\n\t\t\t\tif (type !== this._shellType) {\n\t\t\t\t\tthis._onShellTypeChanged.fire(type);\n\t\t\t\t\tthis._onShellNameChanged.fire(title);\n\t\t\t\t\tthis._shellType = type;\n\t\t\t\t\tthis._shellTitle = title;\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\tprivate traverseTree(tree: WindowsProcessTreeType.IProcessTreeNode | undefined): string {\n\t\tif (!tree) {\n\t\t\treturn '';\n\t\t}\n\t\tif (SHELL_EXECUTABLES.indexOf(tree.name) === -1) {\n\t\t\treturn tree.name;\n\t\t}\n\t\tfor (const regex of SHELL_EXECUTABLE_REGEXES) {\n\t\t\tif (tree.name.match(regex)) {\n\t\t\t\treturn tree.name;\n\t\t\t}\n\t\t}\n\t\tif (!tree.children || tree.children.length === 0) {\n\t\t\treturn tree.name;\n\t\t}\n\t\tlet favouriteChild = 0;\n\t\tfor (; favouriteChild < tree.children.length; favouriteChild++) {\n\t\t\tconst child = tree.children[favouriteChild];\n\t\t\tif (!child.children || child.children.length === 0) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (child.children[0].name !== 'conhost.exe') {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (favouriteChild >= tree.children.length) {\n\t\t\treturn tree.name;\n\t\t}\n\t\treturn this.traverseTree(tree.children[favouriteChild]);\n\t}\n\n\t/**\n\t * Returns the innermost shell executable running in the terminal\n\t */\n\tasync getShellName(): Promise<string> {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn Promise.resolve('');\n\t\t}\n\t\t// Prevent multiple requests at once, instead return current request\n\t\tif (this._currentRequest) {\n\t\t\treturn this._currentRequest;\n\t\t}\n\t\tif (!windowsProcessTree) {\n\t\t\twindowsProcessTree = await import('@vscode/windows-process-tree');\n\t\t}\n\t\tthis._currentRequest = new Promise<string>(resolve => {\n\t\t\twindowsProcessTree.getProcessTree(this._rootProcessId, tree => {\n\t\t\t\tconst name = this.traverseTree(tree);\n\t\t\t\tthis._currentRequest = undefined;\n\t\t\t\tresolve(name);\n\t\t\t});\n\t\t});\n\t\treturn this._currentRequest;\n\t}\n\n\tgetShellType(executable: string): TerminalShellType | undefined {\n\t\tswitch (executable.toLowerCase()) {\n\t\t\tcase 'cmd.exe':\n\t\t\t\treturn WindowsShellType.CommandPrompt;\n\t\t\tcase 'powershell.exe':\n\t\t\tcase 'pwsh.exe':\n\t\t\t\treturn GeneralShellType.PowerShell;\n\t\t\tcase 'bash.exe':\n\t\t\tcase 'git-cmd.exe':\n\t\t\t\treturn WindowsShellType.GitBash;\n\t\t\tcase 'julia.exe':\n\t\t\t\treturn GeneralShellType.Julia;\n\t\t\tcase 'node.exe':\n\t\t\t\treturn GeneralShellType.Node;\n\t\t\tcase 'nu.exe':\n\t\t\t\treturn GeneralShellType.NuShell;\n\t\t\tcase 'wsl.exe':\n\t\t\tcase 'ubuntu.exe':\n\t\t\tcase 'ubuntu1804.exe':\n\t\t\tcase 'kali.exe':\n\t\t\tcase 'debian.exe':\n\t\t\tcase 'opensuse-42.exe':\n\t\t\tcase 'sles-12.exe':\n\t\t\t\treturn WindowsShellType.Wsl;\n\t\t\tdefault:\n\t\t\t\tif (executable.match(/python(\\d(\\.\\d{0,2})?)?\\.exe/)) {\n\t\t\t\t\treturn GeneralShellType.Python;\n\t\t\t\t}\n\t\t\t\treturn undefined;\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { memoize } from '../../../../base/common/decorators.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ICommandDetectionCapability, ITerminalCapabilityImplMap, ITerminalCapabilityStore, TerminalCapability, type AnyTerminalCapabilityChangeEvent, type ICwdDetectionCapability } from './capabilities.js';\n\nexport class TerminalCapabilityStore extends Disposable implements ITerminalCapabilityStore {\n\tprivate _map: Map<TerminalCapability, ITerminalCapabilityImplMap[TerminalCapability]> = new Map();\n\n\tprivate readonly _onDidAddCapability = this._register(new Emitter<AnyTerminalCapabilityChangeEvent>());\n\tget onDidAddCapability() { return this._onDidAddCapability.event; }\n\tprivate readonly _onDidRemoveCapability = this._register(new Emitter<AnyTerminalCapabilityChangeEvent>());\n\tget onDidRemoveCapability() { return this._onDidRemoveCapability.event; }\n\n\t@memoize\n\tget onDidChangeCapabilities() {\n\t\treturn Event.map(Event.any(\n\t\t\tthis._onDidAddCapability.event,\n\t\t\tthis._onDidRemoveCapability.event\n\t\t), () => void 0, this._store);\n\t}\n\t@memoize\n\tget onDidAddCommandDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === TerminalCapability.CommandDetection, this._store), e => e.capability as ICommandDetectionCapability, this._store);\n\t}\n\t@memoize\n\tget onDidRemoveCommandDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === TerminalCapability.CommandDetection, this._store), () => void 0, this._store);\n\t}\n\t@memoize\n\tget onDidAddCwdDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === TerminalCapability.CwdDetection, this._store), e => e.capability as ICwdDetectionCapability, this._store);\n\t}\n\t@memoize\n\tget onDidRemoveCwdDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === TerminalCapability.CwdDetection, this._store), () => void 0, this._store);\n\t}\n\n\tget items(): IterableIterator<TerminalCapability> {\n\t\treturn this._map.keys();\n\t}\n\n\tcreateOnDidRemoveCapabilityOfTypeEvent<T extends TerminalCapability>(type: T): Event<ITerminalCapabilityImplMap[T]> {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === type), e => e.capability as ITerminalCapabilityImplMap[T]);\n\t}\n\tcreateOnDidAddCapabilityOfTypeEvent<T extends TerminalCapability>(type: T): Event<ITerminalCapabilityImplMap[T]> {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === type), e => e.capability as ITerminalCapabilityImplMap[T]);\n\t}\n\n\tadd<T extends TerminalCapability>(capability: T, impl: ITerminalCapabilityImplMap[T]) {\n\t\tthis._map.set(capability, impl);\n\t\tthis._onDidAddCapability.fire(createCapabilityEvent(capability, impl));\n\t}\n\n\tget<T extends TerminalCapability>(capability: T): ITerminalCapabilityImplMap[T] | undefined {\n\t\t// HACK: This isn't totally safe since the Map key and value are not connected\n\t\treturn this._map.get(capability) as ITerminalCapabilityImplMap[T] | undefined;\n\t}\n\n\tremove(capability: TerminalCapability) {\n\t\tconst impl = this._map.get(capability);\n\t\tif (!impl) {\n\t\t\treturn;\n\t\t}\n\t\tthis._map.delete(capability);\n\t\tthis._onDidRemoveCapability.fire(createCapabilityEvent(capability, impl));\n\t}\n\n\thas(capability: TerminalCapability) {\n\t\treturn this._map.has(capability);\n\t}\n}\n\nexport class TerminalCapabilityStoreMultiplexer extends Disposable implements ITerminalCapabilityStore {\n\treadonly _stores: ITerminalCapabilityStore[] = [];\n\n\tprivate readonly _onDidAddCapability = this._register(new Emitter<AnyTerminalCapabilityChangeEvent>());\n\tget onDidAddCapability() { return this._onDidAddCapability.event; }\n\tprivate readonly _onDidRemoveCapability = this._register(new Emitter<AnyTerminalCapabilityChangeEvent>());\n\tget onDidRemoveCapability() { return this._onDidRemoveCapability.event; }\n\n\t@memoize\n\tget onDidChangeCapabilities() {\n\t\treturn Event.map(Event.any(\n\t\t\tthis._onDidAddCapability.event,\n\t\t\tthis._onDidRemoveCapability.event\n\t\t), () => void 0, this._store);\n\t}\n\t@memoize\n\tget onDidAddCommandDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === TerminalCapability.CommandDetection, this._store), e => e.capability as ICommandDetectionCapability, this._store);\n\t}\n\t@memoize\n\tget onDidRemoveCommandDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === TerminalCapability.CommandDetection, this._store), () => void 0, this._store);\n\t}\n\t@memoize\n\tget onDidAddCwdDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === TerminalCapability.CwdDetection, this._store), e => e.capability as ICwdDetectionCapability, this._store);\n\t}\n\t@memoize\n\tget onDidRemoveCwdDetectionCapability() {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === TerminalCapability.CwdDetection, this._store), () => void 0, this._store);\n\t}\n\n\tget items(): IterableIterator<TerminalCapability> {\n\t\treturn this._items();\n\t}\n\n\tcreateOnDidRemoveCapabilityOfTypeEvent<T extends TerminalCapability>(type: T): Event<ITerminalCapabilityImplMap[T]> {\n\t\treturn Event.map(Event.filter(this.onDidRemoveCapability, e => e.id === type), e => e.capability as ITerminalCapabilityImplMap[T]);\n\t}\n\tcreateOnDidAddCapabilityOfTypeEvent<T extends TerminalCapability>(type: T): Event<ITerminalCapabilityImplMap[T]> {\n\t\treturn Event.map(Event.filter(this.onDidAddCapability, e => e.id === type), e => e.capability as ITerminalCapabilityImplMap[T]);\n\t}\n\n\tprivate *_items(): IterableIterator<TerminalCapability> {\n\t\tfor (const store of this._stores) {\n\t\t\tfor (const c of store.items) {\n\t\t\t\tyield c;\n\t\t\t}\n\t\t}\n\t}\n\n\thas(capability: TerminalCapability): boolean {\n\t\tfor (const store of this._stores) {\n\t\t\tfor (const c of store.items) {\n\t\t\t\tif (c === capability) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tget<T extends TerminalCapability>(capability: T): ITerminalCapabilityImplMap[T] | undefined {\n\t\tfor (const store of this._stores) {\n\t\t\tconst c = store.get(capability);\n\t\t\tif (c) {\n\t\t\t\treturn c;\n\t\t\t}\n\t\t}\n\t\treturn undefined;\n\t}\n\n\tadd(store: ITerminalCapabilityStore) {\n\t\tthis._stores.push(store);\n\t\tfor (const capability of store.items) {\n\t\t\tthis._onDidAddCapability.fire(createCapabilityEvent(capability, store.get(capability)!));\n\t\t}\n\t\tthis._register(store.onDidAddCapability(e => this._onDidAddCapability.fire(e)));\n\t\tthis._register(store.onDidRemoveCapability(e => this._onDidRemoveCapability.fire(e)));\n\t}\n}\n\nfunction createCapabilityEvent<T extends TerminalCapability>(capability: T, impl: ITerminalCapabilityImplMap[T]): AnyTerminalCapabilityChangeEvent {\n\t// HACK: This cast is required to convert a generic type to a discriminated union, this is\n\t// necessary in order to enable type narrowing on the event consumer side.\n\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\treturn { id: capability, capability: impl } as AnyTerminalCapabilityChangeEvent;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IMarkProperties, ISerializedTerminalCommand, ITerminalCommand } from '../capabilities.js';\nimport { ITerminalOutputMatcher, ITerminalOutputMatch } from '../../terminal.js';\nimport type { IBuffer, IBufferLine, IMarker, Terminal } from '@xterm/headless';\nimport { generateUuid } from '../../../../../base/common/uuid.js';\nimport { isString } from '../../../../../base/common/types.js';\n\nexport interface ITerminalCommandProperties {\n\tcommand: string;\n\tcommandLineConfidence: 'low' | 'medium' | 'high';\n\tisTrusted: boolean;\n\ttimestamp: number;\n\tduration: number;\n\tid: string | undefined;\n\tmarker: IMarker | undefined;\n\tcwd: string | undefined;\n\texitCode: number | undefined;\n\tcommandStartLineContent: string | undefined;\n\tmarkProperties: IMarkProperties | undefined;\n\texecutedX: number | undefined;\n\tstartX: number | undefined;\n\n\tpromptStartMarker?: IMarker | undefined;\n\tendMarker?: IMarker | undefined;\n\texecutedMarker?: IMarker | undefined;\n\taliases?: string[][] | undefined;\n\twasReplayed?: boolean | undefined;\n}\n\nexport class TerminalCommand implements ITerminalCommand {\n\n\tget command() { return this._properties.command; }\n\tget commandLineConfidence() { return this._properties.commandLineConfidence; }\n\tget isTrusted() { return this._properties.isTrusted; }\n\tget timestamp() { return this._properties.timestamp; }\n\tget duration() { return this._properties.duration; }\n\tget promptStartMarker() { return this._properties.promptStartMarker; }\n\tget marker() { return this._properties.marker; }\n\tget endMarker() { return this._properties.endMarker; }\n\tset endMarker(value: IMarker | undefined) { this._properties.endMarker = value; }\n\tget executedMarker() { return this._properties.executedMarker; }\n\tget aliases() { return this._properties.aliases; }\n\tget wasReplayed() { return this._properties.wasReplayed; }\n\tget cwd() { return this._properties.cwd; }\n\tget exitCode() { return this._properties.exitCode; }\n\tget commandStartLineContent() { return this._properties.commandStartLineContent; }\n\tget markProperties() { return this._properties.markProperties; }\n\tget executedX() { return this._properties.executedX; }\n\tget startX() { return this._properties.startX; }\n\tget id() { return this._properties.id; }\n\n\tconstructor(\n\t\tprivate readonly _xterm: Terminal,\n\t\tprivate readonly _properties: ITerminalCommandProperties,\n\t) {\n\t}\n\n\tstatic deserialize(xterm: Terminal, serialized: ISerializedTerminalCommand & Required<Pick<ISerializedTerminalCommand, 'endLine'>>, isCommandStorageDisabled: boolean): TerminalCommand | undefined {\n\t\tconst buffer = xterm.buffer.normal;\n\t\tconst marker = serialized.startLine !== undefined ? xterm.registerMarker(serialized.startLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\n\t\t// Check for invalid command\n\t\tif (!marker) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst promptStartMarker = serialized.promptStartLine !== undefined ? xterm.registerMarker(serialized.promptStartLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\n\t\t// Valid full command\n\t\tconst endMarker = serialized.endLine !== undefined ? xterm.registerMarker(serialized.endLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\t\tconst executedMarker = serialized.executedLine !== undefined ? xterm.registerMarker(serialized.executedLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\t\tconst newCommand = new TerminalCommand(xterm, {\n\t\t\tcommand: isCommandStorageDisabled ? '' : serialized.command,\n\t\t\tcommandLineConfidence: serialized.commandLineConfidence ?? 'low',\n\t\t\tisTrusted: serialized.isTrusted,\n\t\t\tid: serialized.id,\n\t\t\tpromptStartMarker,\n\t\t\tmarker,\n\t\t\tstartX: serialized.startX,\n\t\t\tendMarker,\n\t\t\texecutedMarker,\n\t\t\texecutedX: serialized.executedX,\n\t\t\ttimestamp: serialized.timestamp,\n\t\t\tduration: serialized.duration,\n\t\t\tcwd: serialized.cwd,\n\t\t\tcommandStartLineContent: serialized.commandStartLineContent,\n\t\t\texitCode: serialized.exitCode,\n\t\t\tmarkProperties: serialized.markProperties,\n\t\t\taliases: undefined,\n\t\t\twasReplayed: true\n\t\t});\n\t\treturn newCommand;\n\t}\n\n\tserialize(isCommandStorageDisabled: boolean): ISerializedTerminalCommand {\n\t\treturn {\n\t\t\tpromptStartLine: this.promptStartMarker?.line,\n\t\t\tstartLine: this.marker?.line,\n\t\t\tstartX: undefined,\n\t\t\tendLine: this.endMarker?.line,\n\t\t\texecutedLine: this.executedMarker?.line,\n\t\t\texecutedX: this.executedX,\n\t\t\tcommand: isCommandStorageDisabled ? '' : this.command,\n\t\t\tcommandLineConfidence: isCommandStorageDisabled ? 'low' : this.commandLineConfidence,\n\t\t\tisTrusted: this.isTrusted,\n\t\t\tcwd: this.cwd,\n\t\t\texitCode: this.exitCode,\n\t\t\tcommandStartLineContent: this.commandStartLineContent,\n\t\t\ttimestamp: this.timestamp,\n\t\t\tduration: this.duration,\n\t\t\tmarkProperties: this.markProperties,\n\t\t\tid: this.id,\n\t\t};\n\t}\n\n\textractCommandLine(): string {\n\t\treturn extractCommandLine(this._xterm.buffer.active, this._xterm.cols, this.marker, this.startX, this.executedMarker, this.executedX);\n\t}\n\n\tgetOutput(): string | undefined {\n\t\tif (!this.executedMarker || !this.endMarker) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst startLine = this.executedMarker.line;\n\t\tconst endLine = this.endMarker.line;\n\n\t\tif (startLine === endLine) {\n\t\t\treturn undefined;\n\t\t}\n\t\tlet output = '';\n\t\tlet line: IBufferLine | undefined;\n\t\tfor (let i = startLine; i < endLine; i++) {\n\t\t\tline = this._xterm.buffer.active.getLine(i);\n\t\t\tif (!line) {\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\toutput += line.translateToString(!line.isWrapped) + (line.isWrapped ? '' : '\\n');\n\t\t}\n\t\treturn output === '' ? undefined : output;\n\t}\n\n\tgetOutputMatch(outputMatcher: ITerminalOutputMatcher): ITerminalOutputMatch | undefined {\n\t\t// TODO: Add back this check? this._ptyHeuristics.value instanceof WindowsPtyHeuristics && (executedMarker?.line === endMarker?.line) ? this._currentCommand.commandStartMarker : executedMarker\n\t\tif (!this.executedMarker || !this.endMarker) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst endLine = this.endMarker.line;\n\t\tif (endLine === -1) {\n\t\t\treturn undefined;\n\t\t}\n\t\tconst buffer = this._xterm.buffer.active;\n\t\tconst startLine = Math.max(this.executedMarker.line, 0);\n\t\tconst matcher = outputMatcher.lineMatcher;\n\t\tconst linesToCheck = isString(matcher) ? 1 : outputMatcher.length || countNewLines(matcher);\n\t\tconst lines: string[] = [];\n\t\tlet match: RegExpMatchArray | null | undefined;\n\t\tif (outputMatcher.anchor === 'bottom') {\n\t\t\tfor (let i = endLine - (outputMatcher.offset || 0); i >= startLine; i--) {\n\t\t\t\tlet wrappedLineStart = i;\n\t\t\t\tconst wrappedLineEnd = i;\n\t\t\t\twhile (wrappedLineStart >= startLine && buffer.getLine(wrappedLineStart)?.isWrapped) {\n\t\t\t\t\twrappedLineStart--;\n\t\t\t\t}\n\t\t\t\ti = wrappedLineStart;\n\t\t\t\tlines.unshift(getXtermLineContent(buffer, wrappedLineStart, wrappedLineEnd, this._xterm.cols));\n\t\t\t\tif (!match) {\n\t\t\t\t\tmatch = lines[0].match(matcher);\n\t\t\t\t}\n\t\t\t\tif (lines.length >= linesToCheck) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\tfor (let i = startLine + (outputMatcher.offset || 0); i < endLine; i++) {\n\t\t\t\tconst wrappedLineStart = i;\n\t\t\t\tlet wrappedLineEnd = i;\n\t\t\t\twhile (wrappedLineEnd + 1 < endLine && buffer.getLine(wrappedLineEnd + 1)?.isWrapped) {\n\t\t\t\t\twrappedLineEnd++;\n\t\t\t\t}\n\t\t\t\ti = wrappedLineEnd;\n\t\t\t\tlines.push(getXtermLineContent(buffer, wrappedLineStart, wrappedLineEnd, this._xterm.cols));\n\t\t\t\tif (!match) {\n\t\t\t\t\tmatch = lines[lines.length - 1].match(matcher);\n\t\t\t\t}\n\t\t\t\tif (lines.length >= linesToCheck) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\treturn match ? { regexMatch: match, outputLines: lines } : undefined;\n\t}\n\n\thasOutput(): boolean {\n\t\treturn (\n\t\t\t!this.executedMarker?.isDisposed &&\n\t\t\t!this.endMarker?.isDisposed &&\n\t\t\t!!(\n\t\t\t\tthis.executedMarker &&\n\t\t\t\tthis.endMarker &&\n\t\t\t\tthis.executedMarker.line < this.endMarker.line\n\t\t\t)\n\t\t);\n\t}\n\n\tgetPromptRowCount(): number {\n\t\treturn getPromptRowCount(this, this._xterm.buffer.active);\n\t}\n\n\tgetCommandRowCount(): number {\n\t\treturn getCommandRowCount(this);\n\t}\n}\n\nexport interface ICurrentPartialCommand {\n\tpromptStartMarker?: IMarker;\n\n\tcommandStartMarker?: IMarker;\n\tcommandStartX?: number;\n\tcommandStartLineContent?: string;\n\n\tcommandRightPromptStartX?: number;\n\tcommandRightPromptEndX?: number;\n\n\tcommandLines?: IMarker;\n\n\tcommandExecutedMarker?: IMarker;\n\tcommandExecutedX?: number;\n\n\tcommandFinishedMarker?: IMarker;\n\n\tcurrentContinuationMarker?: IMarker;\n\tcontinuations?: { marker: IMarker; end: number }[];\n\n\tcommand?: string;\n\n\t/**\n\t * Whether the command line is trusted via a nonce.\n\t */\n\tisTrusted?: boolean;\n\n\t/**\n\t * Something invalidated the command before it finished, this will prevent the onCommandFinished\n\t * event from firing.\n\t */\n\tisInvalid?: boolean;\n\n\tgetPromptRowCount(): number;\n\tgetCommandRowCount(): number;\n}\n\nexport class PartialTerminalCommand implements ICurrentPartialCommand {\n\tpromptStartMarker?: IMarker;\n\n\tcommandStartMarker?: IMarker;\n\tcommandStartX?: number;\n\tcommandStartLineContent?: string;\n\n\tcommandRightPromptStartX?: number;\n\tcommandRightPromptEndX?: number;\n\n\tcommandLines?: IMarker;\n\n\tcommandExecutedMarker?: IMarker;\n\tcommandExecutedX?: number;\n\n\tprivate commandExecutedTimestamp?: number;\n\tprivate commandDuration?: number;\n\n\tcommandFinishedMarker?: IMarker;\n\n\tcurrentContinuationMarker?: IMarker;\n\tcontinuations?: { marker: IMarker; end: number }[];\n\n\tcwd?: string;\n\tcommand?: string;\n\tcommandLineConfidence?: 'low' | 'medium' | 'high';\n\tid: string | undefined;\n\n\tisTrusted?: boolean;\n\tisInvalid?: boolean;\n\t/**\n\t * Track temporarily if the command was recently cleared, this can be used for marker\n\t * adjustments\n\t */\n\twasCleared?: boolean;\n\n\tconstructor(\n\t\tprivate readonly _xterm: Terminal,\n\t\tid?: string\n\t) {\n\t\tthis.id = id ?? generateUuid();\n\t}\n\n\tserialize(cwd: string | undefined): ISerializedTerminalCommand | undefined {\n\t\tif (!this.commandStartMarker) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn {\n\t\t\tpromptStartLine: this.promptStartMarker?.line,\n\t\t\tstartLine: this.commandStartMarker.line,\n\t\t\tstartX: this.commandStartX,\n\t\t\tendLine: undefined,\n\t\t\texecutedLine: undefined,\n\t\t\texecutedX: undefined,\n\t\t\tcommand: '',\n\t\t\tcommandLineConfidence: 'low',\n\t\t\tisTrusted: true,\n\t\t\tcwd,\n\t\t\texitCode: undefined,\n\t\t\tcommandStartLineContent: undefined,\n\t\t\ttimestamp: 0,\n\t\t\tduration: 0,\n\t\t\tmarkProperties: undefined,\n\t\t\tid: this.id\n\t\t};\n\t}\n\n\tpromoteToFullCommand(cwd: string | undefined, exitCode: number | undefined, ignoreCommandLine: boolean, markProperties: IMarkProperties | undefined): TerminalCommand | undefined {\n\t\t// When the command finishes and executed never fires the placeholder selector should be used.\n\t\tif (exitCode === undefined && this.command === undefined) {\n\t\t\tthis.command = '';\n\t\t}\n\n\t\tif ((this.command !== undefined && !this.command.startsWith('\\\\')) || ignoreCommandLine) {\n\t\t\treturn new TerminalCommand(this._xterm, {\n\t\t\t\tcommand: ignoreCommandLine ? '' : (this.command || ''),\n\t\t\t\tcommandLineConfidence: ignoreCommandLine ? 'low' : (this.commandLineConfidence || 'low'),\n\t\t\t\tisTrusted: !!this.isTrusted,\n\t\t\t\tid: this.id,\n\t\t\t\tpromptStartMarker: this.promptStartMarker,\n\t\t\t\tmarker: this.commandStartMarker,\n\t\t\t\tstartX: this.commandStartX,\n\t\t\t\tendMarker: this.commandFinishedMarker,\n\t\t\t\texecutedMarker: this.commandExecutedMarker,\n\t\t\t\texecutedX: this.commandExecutedX,\n\t\t\t\ttimestamp: Date.now(),\n\t\t\t\tduration: this.commandDuration || 0,\n\t\t\t\tcwd,\n\t\t\t\texitCode,\n\t\t\t\tcommandStartLineContent: this.commandStartLineContent,\n\t\t\t\tmarkProperties\n\t\t\t});\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tmarkExecutedTime() {\n\t\tif (this.commandExecutedTimestamp === undefined) {\n\t\t\tthis.commandExecutedTimestamp = Date.now();\n\t\t}\n\t}\n\n\tmarkFinishedTime() {\n\t\tif (this.commandDuration === undefined && this.commandExecutedTimestamp !== undefined) {\n\t\t\tthis.commandDuration = Date.now() - this.commandExecutedTimestamp;\n\t\t}\n\t}\n\n\textractCommandLine(): string {\n\t\treturn extractCommandLine(this._xterm.buffer.active, this._xterm.cols, this.commandStartMarker, this.commandStartX, this.commandExecutedMarker, this.commandExecutedX);\n\t}\n\n\tgetPromptRowCount(): number {\n\t\treturn getPromptRowCount(this, this._xterm.buffer.active);\n\t}\n\n\tgetCommandRowCount(): number {\n\t\treturn getCommandRowCount(this);\n\t}\n}\n\nfunction extractCommandLine(\n\tbuffer: IBuffer,\n\tcols: number,\n\tcommandStartMarker: IMarker | undefined,\n\tcommandStartX: number | undefined,\n\tcommandExecutedMarker: IMarker | undefined,\n\tcommandExecutedX: number | undefined\n): string {\n\tif (!commandStartMarker || !commandExecutedMarker || commandStartX === undefined || commandExecutedX === undefined) {\n\t\treturn '';\n\t}\n\tlet content = '';\n\tfor (let i = commandStartMarker.line; i <= commandExecutedMarker.line; i++) {\n\t\tconst line = buffer.getLine(i);\n\t\tif (line) {\n\t\t\tcontent += line.translateToString(true, i === commandStartMarker.line ? commandStartX : 0, i === commandExecutedMarker.line ? commandExecutedX : cols);\n\t\t}\n\t}\n\treturn content;\n}\n\nfunction getXtermLineContent(buffer: IBuffer, lineStart: number, lineEnd: number, cols: number): string {\n\t// Cap the maximum number of lines generated to prevent potential performance problems. This is\n\t// more of a sanity check as the wrapped line should already be trimmed down at this point.\n\tconst maxLineLength = Math.max(2048 / cols * 2);\n\tlineEnd = Math.min(lineEnd, lineStart + maxLineLength);\n\tlet content = '';\n\tfor (let i = lineStart; i <= lineEnd; i++) {\n\t\t// Make sure only 0 to cols are considered as resizing when windows mode is enabled will\n\t\t// retain buffer data outside of the terminal width as reflow is disabled.\n\t\tconst line = buffer.getLine(i);\n\t\tif (line) {\n\t\t\tcontent += line.translateToString(true, 0, cols);\n\t\t}\n\t}\n\treturn content;\n}\n\nfunction countNewLines(regex: RegExp): number {\n\tif (!regex.multiline) {\n\t\treturn 1;\n\t}\n\tconst source = regex.source;\n\tlet count = 1;\n\tlet i = source.indexOf('\\\\n');\n\twhile (i !== -1) {\n\t\tcount++;\n\t\ti = source.indexOf('\\\\n', i + 1);\n\t}\n\treturn count;\n}\n\nfunction getPromptRowCount(command: ITerminalCommand | ICurrentPartialCommand, buffer: IBuffer): number {\n\tconst marker = isFullTerminalCommand(command) ? command.marker : command.commandStartMarker;\n\tif (!marker || !command.promptStartMarker) {\n\t\treturn 1;\n\t}\n\tlet promptRowCount = 1;\n\tlet promptStartLine = command.promptStartMarker.line;\n\t// Trim any leading whitespace-only lines to retain vertical space\n\twhile (promptStartLine < marker.line && (buffer.getLine(promptStartLine)?.translateToString(true) ?? '').length === 0) {\n\t\tpromptStartLine++;\n\t}\n\tpromptRowCount = marker.line - promptStartLine + 1;\n\treturn promptRowCount;\n}\n\nfunction getCommandRowCount(command: ITerminalCommand | ICurrentPartialCommand): number {\n\tconst marker = isFullTerminalCommand(command) ? command.marker : command.commandStartMarker;\n\tconst executedMarker = isFullTerminalCommand(command) ? command.executedMarker : command.commandExecutedMarker;\n\tif (!marker || !executedMarker) {\n\t\treturn 1;\n\t}\n\tconst commandExecutedLine = Math.max(executedMarker.line, marker.line);\n\tlet commandRowCount = commandExecutedLine - marker.line + 1;\n\t// Trim the last line if the cursor X is in the left-most cell\n\tconst executedX = isFullTerminalCommand(command) ? command.executedX : command.commandExecutedX;\n\tif (executedX === 0) {\n\t\tcommandRowCount--;\n\t}\n\treturn commandRowCount;\n}\n\nexport function isFullTerminalCommand(command: ITerminalCommand | ICurrentPartialCommand): command is ITerminalCommand {\n\treturn !!(command as ITerminalCommand).hasOutput;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { IBuffer, IBufferCell, IBufferLine, IMarker, Terminal } from '@xterm/headless';\nimport { throttle } from '../../../../../base/common/decorators.js';\nimport { Emitter, Event } from '../../../../../base/common/event.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { ILogService, LogLevel } from '../../../../log/common/log.js';\nimport { PosixShellType, TerminalShellType } from '../../terminal.js';\nimport type { ITerminalCommand } from '../capabilities.js';\n\nexport const enum PromptInputState {\n\tUnknown = 0,\n\tInput = 1,\n\tExecute = 2,\n}\n\n/**\n * A model of the prompt input state using shell integration and analyzing the terminal buffer. This\n * may not be 100% accurate but provides a best guess.\n */\nexport interface IPromptInputModel extends IPromptInputModelState {\n\treadonly state: PromptInputState;\n\n\treadonly onDidStartInput: Event<IPromptInputModelState>;\n\treadonly onDidChangeInput: Event<IPromptInputModelState>;\n\treadonly onDidFinishInput: Event<IPromptInputModelState>;\n\t/**\n\t * Fires immediately before {@link onDidFinishInput} when a SIGINT/Ctrl+C/^C is detected.\n\t */\n\treadonly onDidInterrupt: Event<IPromptInputModelState>;\n\n\t/**\n\t * Gets the prompt input as a user-friendly string where `|` is the cursor position and `[` and\n\t * `]` wrap any ghost text.\n\t *\n\t * @param emptyStringWhenEmpty If true, an empty string is returned when the prompt input is\n\t * empty (as opposed to '|').\n\t */\n\tgetCombinedString(emptyStringWhenEmpty?: boolean): string;\n\n\tsetShellType(shellType?: TerminalShellType): void;\n}\n\nexport interface IPromptInputModelState {\n\t/**\n\t * The full prompt input include ghost text.\n\t */\n\treadonly value: string;\n\t/**\n\t * The prompt input up to the cursor index, this will always exclude the ghost text.\n\t */\n\treadonly prefix: string;\n\t/**\n\t * The prompt input from the cursor to the end, this _does not_ include ghost text.\n\t */\n\treadonly suffix: string;\n\t/**\n\t * The index of the cursor in {@link value}.\n\t */\n\treadonly cursorIndex: number;\n\t/**\n\t * The index of the start of ghost text in {@link value}. This is -1 when there is no ghost\n\t * text.\n\t */\n\treadonly ghostTextIndex: number;\n}\n\nexport interface ISerializedPromptInputModel {\n\treadonly modelState: IPromptInputModelState;\n\treadonly commandStartX: number;\n\treadonly lastPromptLine: string | undefined;\n\treadonly continuationPrompt: string | undefined;\n\treadonly lastUserInput: string;\n}\n\nexport class PromptInputModel extends Disposable implements IPromptInputModel {\n\tprivate _state: PromptInputState = PromptInputState.Unknown;\n\tget state() { return this._state; }\n\n\tprivate _commandStartMarker: IMarker | undefined;\n\tprivate _commandStartX: number = 0;\n\tprivate _lastPromptLine: string | undefined;\n\tprivate _continuationPrompt: string | undefined;\n\tprivate _shellType: TerminalShellType | undefined;\n\n\tprivate _lastUserInput: string = '';\n\n\tprivate _value: string = '';\n\tget value() { return this._value; }\n\tget prefix() { return this._value.substring(0, this._cursorIndex); }\n\tget suffix() { return this._value.substring(this._cursorIndex, this._ghostTextIndex === -1 ? undefined : this._ghostTextIndex); }\n\n\tprivate _cursorIndex: number = 0;\n\tget cursorIndex() { return this._cursorIndex; }\n\n\tprivate _ghostTextIndex: number = -1;\n\tget ghostTextIndex() { return this._ghostTextIndex; }\n\n\tprivate readonly _onDidStartInput = this._register(new Emitter<IPromptInputModelState>());\n\treadonly onDidStartInput = this._onDidStartInput.event;\n\tprivate readonly _onDidChangeInput = this._register(new Emitter<IPromptInputModelState>());\n\treadonly onDidChangeInput = this._onDidChangeInput.event;\n\tprivate readonly _onDidFinishInput = this._register(new Emitter<IPromptInputModelState>());\n\treadonly onDidFinishInput = this._onDidFinishInput.event;\n\tprivate readonly _onDidInterrupt = this._register(new Emitter<IPromptInputModelState>());\n\treadonly onDidInterrupt = this._onDidInterrupt.event;\n\n\tconstructor(\n\t\tprivate readonly _xterm: Terminal,\n\t\tonCommandStart: Event<ITerminalCommand>,\n\t\tonCommandStartChanged: Event<void>,\n\t\tonCommandExecuted: Event<ITerminalCommand>,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis._register(Event.any(\n\t\t\tthis._xterm.onCursorMove,\n\t\t\tthis._xterm.onData,\n\t\t\tthis._xterm.onWriteParsed,\n\t\t)(() => this._sync()));\n\t\tthis._register(this._xterm.onData(e => this._handleUserInput(e)));\n\n\t\tthis._register(onCommandStart(e => this._handleCommandStart(e as { marker: IMarker })));\n\t\tthis._register(onCommandStartChanged(() => this._handleCommandStartChanged()));\n\t\tthis._register(onCommandExecuted(() => this._handleCommandExecuted()));\n\n\t\tthis._register(this.onDidStartInput(() => this._logCombinedStringIfTrace('PromptInputModel#onDidStartInput')));\n\t\tthis._register(this.onDidChangeInput(() => this._logCombinedStringIfTrace('PromptInputModel#onDidChangeInput')));\n\t\tthis._register(this.onDidFinishInput(() => this._logCombinedStringIfTrace('PromptInputModel#onDidFinishInput')));\n\t\tthis._register(this.onDidInterrupt(() => this._logCombinedStringIfTrace('PromptInputModel#onDidInterrupt')));\n\t}\n\n\tprivate _logCombinedStringIfTrace(message: string) {\n\t\t// Only generate the combined string if trace\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis._logService.trace(message, this.getCombinedString());\n\t\t}\n\t}\n\n\tsetShellType(shellType: TerminalShellType): void {\n\t\tthis._shellType = shellType;\n\t}\n\n\tsetContinuationPrompt(value: string): void {\n\t\tthis._continuationPrompt = value;\n\t\tthis._sync();\n\t}\n\n\tsetLastPromptLine(value: string): void {\n\t\tthis._lastPromptLine = value;\n\t\tthis._sync();\n\t}\n\n\tsetConfidentCommandLine(value: string): void {\n\t\tif (this._value !== value) {\n\t\t\tthis._value = value;\n\t\t\tthis._cursorIndex = -1;\n\t\t\tthis._ghostTextIndex = -1;\n\t\t\tthis._onDidChangeInput.fire(this._createStateObject());\n\t\t}\n\t}\n\n\tgetCombinedString(emptyStringWhenEmpty?: boolean): string {\n\t\tconst value = this._value.replaceAll('\\n', '\\u23CE');\n\t\tif (this._cursorIndex === -1) {\n\t\t\treturn value;\n\t\t}\n\t\tlet result = `${value.substring(0, this.cursorIndex)}|`;\n\t\tif (this.ghostTextIndex !== -1) {\n\t\t\tresult += `${value.substring(this.cursorIndex, this.ghostTextIndex)}[`;\n\t\t\tresult += `${value.substring(this.ghostTextIndex)}]`;\n\t\t} else {\n\t\t\tresult += value.substring(this.cursorIndex);\n\t\t}\n\t\tif (result === '|' && emptyStringWhenEmpty) {\n\t\t\treturn '';\n\t\t}\n\t\treturn result;\n\t}\n\n\tserialize(): ISerializedPromptInputModel {\n\t\treturn {\n\t\t\tmodelState: this._createStateObject(),\n\t\t\tcommandStartX: this._commandStartX,\n\t\t\tlastPromptLine: this._lastPromptLine,\n\t\t\tcontinuationPrompt: this._continuationPrompt,\n\t\t\tlastUserInput: this._lastUserInput\n\t\t};\n\t}\n\n\tdeserialize(serialized: ISerializedPromptInputModel): void {\n\t\tthis._value = serialized.modelState.value;\n\t\tthis._cursorIndex = serialized.modelState.cursorIndex;\n\t\tthis._ghostTextIndex = serialized.modelState.ghostTextIndex;\n\t\tthis._commandStartX = serialized.commandStartX;\n\t\tthis._lastPromptLine = serialized.lastPromptLine;\n\t\tthis._continuationPrompt = serialized.continuationPrompt;\n\t\tthis._lastUserInput = serialized.lastUserInput;\n\t}\n\n\tprivate _handleCommandStart(command: { marker: IMarker }) {\n\t\tif (this._state === PromptInputState.Input) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._state = PromptInputState.Input;\n\t\tthis._commandStartMarker = command.marker;\n\t\tthis._commandStartX = this._xterm.buffer.active.cursorX;\n\t\tthis._value = '';\n\t\tthis._cursorIndex = 0;\n\t\tthis._onDidStartInput.fire(this._createStateObject());\n\t\tthis._onDidChangeInput.fire(this._createStateObject());\n\n\t\t// Trigger a sync if prompt terminator is set as that could adjust the command start X\n\t\tif (this._lastPromptLine) {\n\t\t\tif (this._commandStartX !== this._lastPromptLine.length) {\n\t\t\t\tconst line = this._xterm.buffer.active.getLine(this._commandStartMarker.line);\n\t\t\t\tif (line?.translateToString(true).startsWith(this._lastPromptLine)) {\n\t\t\t\t\tthis._commandStartX = this._lastPromptLine.length;\n\t\t\t\t\tthis._sync();\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _handleCommandStartChanged() {\n\t\tif (this._state !== PromptInputState.Input) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._commandStartX = this._xterm.buffer.active.cursorX;\n\t\tthis._onDidChangeInput.fire(this._createStateObject());\n\t\tthis._sync();\n\t}\n\n\tprivate _handleCommandExecuted() {\n\t\tif (this._state === PromptInputState.Execute) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._cursorIndex = -1;\n\n\t\t// Remove any ghost text from the input if it exists on execute\n\t\tif (this._ghostTextIndex !== -1) {\n\t\t\tthis._value = this._value.substring(0, this._ghostTextIndex);\n\t\t\tthis._ghostTextIndex = -1;\n\t\t}\n\n\t\tconst event = this._createStateObject();\n\t\tif (this._lastUserInput === '\\u0003') {\n\t\t\tthis._lastUserInput = '';\n\t\t\tthis._onDidInterrupt.fire(event);\n\t\t}\n\n\t\tthis._state = PromptInputState.Execute;\n\t\tthis._onDidFinishInput.fire(event);\n\t\tthis._onDidChangeInput.fire(event);\n\t}\n\n\t@throttle(0)\n\tprivate _sync() {\n\t\ttry {\n\t\t\tthis._doSync();\n\t\t} catch (e) {\n\t\t\tthis._logService.error('Error while syncing prompt input model', e);\n\t\t}\n\t}\n\n\tprivate _doSync() {\n\t\tif (this._state !== PromptInputState.Input) {\n\t\t\treturn;\n\t\t}\n\n\t\tlet commandStartY = this._commandStartMarker?.line;\n\t\tif (commandStartY === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tconst buffer = this._xterm.buffer.active;\n\t\tlet line = buffer.getLine(commandStartY);\n\t\tconst absoluteCursorY = buffer.baseY + buffer.cursorY;\n\t\tlet cursorIndex: number | undefined;\n\n\t\tlet commandLine = line?.translateToString(true, this._commandStartX);\n\t\tif (this._shellType === PosixShellType.Fish && (!line || !commandLine)) {\n\t\t\tcommandStartY += 1;\n\t\t\tline = buffer.getLine(commandStartY);\n\t\t\tif (line) {\n\t\t\t\tcommandLine = line.translateToString(true);\n\t\t\t\tcursorIndex = absoluteCursorY === commandStartY ? buffer.cursorX : commandLine?.trimEnd().length;\n\t\t\t}\n\t\t}\n\t\tif (line === undefined || commandLine === undefined) {\n\t\t\tthis._logService.trace(`PromptInputModel#_sync: no line`);\n\t\t\treturn;\n\t\t}\n\n\t\tlet value = commandLine;\n\t\tlet ghostTextIndex = -1;\n\t\tif (cursorIndex === undefined) {\n\t\t\tif (absoluteCursorY === commandStartY) {\n\t\t\t\tcursorIndex = Math.min(this._getRelativeCursorIndex(this._commandStartX, buffer, line), commandLine.length);\n\t\t\t} else {\n\t\t\t\tcursorIndex = commandLine.trimEnd().length;\n\t\t\t}\n\t\t}\n\n\t\t// From command start line to cursor line\n\t\tfor (let y = commandStartY + 1; y <= absoluteCursorY; y++) {\n\t\t\tconst nextLine = buffer.getLine(y);\n\t\t\tconst lineText = nextLine?.translateToString(true);\n\t\t\tif (lineText && nextLine) {\n\t\t\t\t// Check if the line wrapped without a new line (continuation) or\n\t\t\t\t// we're on the last line and the continuation prompt is not present, so we need to add the value\n\t\t\t\tif (nextLine.isWrapped || (absoluteCursorY === y && this._continuationPrompt && !this._lineContainsContinuationPrompt(lineText))) {\n\t\t\t\t\tvalue += `${lineText}`;\n\t\t\t\t\tconst relativeCursorIndex = this._getRelativeCursorIndex(0, buffer, nextLine);\n\t\t\t\t\tif (absoluteCursorY === y) {\n\t\t\t\t\t\tcursorIndex += relativeCursorIndex;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcursorIndex += lineText.length;\n\t\t\t\t\t}\n\t\t\t\t} else if (this._shellType === PosixShellType.Fish) {\n\t\t\t\t\tif (value.endsWith('\\\\')) {\n\t\t\t\t\t\t// Trim off the trailing backslash\n\t\t\t\t\t\tvalue = value.substring(0, value.length - 1);\n\t\t\t\t\t\tvalue += `${lineText.trim()}`;\n\t\t\t\t\t\tcursorIndex += lineText.trim().length - 1;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (/^ {6,}/.test(lineText)) {\n\t\t\t\t\t\t\t// Was likely a new line\n\t\t\t\t\t\t\tvalue += `\\n${lineText.trim()}`;\n\t\t\t\t\t\t\tcursorIndex += lineText.trim().length + 1;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvalue += lineText;\n\t\t\t\t\t\t\tcursorIndex += lineText.length;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// Verify continuation prompt if we have it, if this line doesn't have it then the\n\t\t\t\t// user likely just pressed enter.\n\t\t\t\telse if (this._continuationPrompt === undefined || this._lineContainsContinuationPrompt(lineText)) {\n\t\t\t\t\tconst trimmedLineText = this._trimContinuationPrompt(lineText);\n\t\t\t\t\tvalue += `\\n${trimmedLineText}`;\n\t\t\t\t\tif (absoluteCursorY === y) {\n\t\t\t\t\t\tconst continuationCellWidth = this._getContinuationPromptCellWidth(nextLine, lineText);\n\t\t\t\t\t\tconst relativeCursorIndex = this._getRelativeCursorIndex(continuationCellWidth, buffer, nextLine);\n\t\t\t\t\t\tcursorIndex += relativeCursorIndex + 1;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tcursorIndex += trimmedLineText.length + 1;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Below cursor line\n\t\tfor (let y = absoluteCursorY + 1; y < buffer.baseY + this._xterm.rows; y++) {\n\t\t\tconst belowCursorLine = buffer.getLine(y);\n\t\t\tconst lineText = belowCursorLine?.translateToString(true);\n\t\t\tif (lineText && belowCursorLine) {\n\t\t\t\tif (this._shellType === PosixShellType.Fish) {\n\t\t\t\t\tvalue += `${lineText}`;\n\t\t\t\t} else if (this._continuationPrompt === undefined || this._lineContainsContinuationPrompt(lineText)) {\n\t\t\t\t\tvalue += `\\n${this._trimContinuationPrompt(lineText)}`;\n\t\t\t\t} else {\n\t\t\t\t\tvalue += lineText;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (this._logService.getLevel() === LogLevel.Trace) {\n\t\t\tthis._logService.trace(`PromptInputModel#_sync: ${this.getCombinedString()}`);\n\t\t}\n\n\t\t// Adjust trailing whitespace\n\t\t{\n\t\t\tlet trailingWhitespace = this._value.length - this._value.trimEnd().length;\n\n\t\t\t// Handle backspace key\n\t\t\tif (this._lastUserInput === '\\x7F') {\n\t\t\t\tthis._lastUserInput = '';\n\t\t\t\tif (cursorIndex === this._cursorIndex - 1) {\n\t\t\t\t\t// If trailing whitespace is being increased by removing a non-whitespace character\n\t\t\t\t\tif (this._value.trimEnd().length > value.trimEnd().length && value.trimEnd().length <= cursorIndex) {\n\t\t\t\t\t\ttrailingWhitespace = Math.max((this._value.length - 1) - value.trimEnd().length, 0);\n\t\t\t\t\t}\n\t\t\t\t\t// Standard case; subtract from trailing whitespace\n\t\t\t\t\telse {\n\t\t\t\t\t\ttrailingWhitespace = Math.max(trailingWhitespace - 1, 0);\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Handle delete key\n\t\t\tif (this._lastUserInput === '\\x1b[3~') {\n\t\t\t\tthis._lastUserInput = '';\n\t\t\t\tif (cursorIndex === this._cursorIndex) {\n\t\t\t\t\ttrailingWhitespace = Math.max(trailingWhitespace - 1, 0);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst valueLines = value.split('\\n');\n\t\t\tconst isMultiLine = valueLines.length > 1;\n\t\t\tconst valueEndTrimmed = value.trimEnd();\n\t\t\tif (!isMultiLine) {\n\t\t\t\t// Adjust trimmed whitespace value based on cursor position\n\t\t\t\tif (valueEndTrimmed.length < value.length) {\n\t\t\t\t\t// Handle space key\n\t\t\t\t\tif (this._lastUserInput === ' ') {\n\t\t\t\t\t\tthis._lastUserInput = '';\n\t\t\t\t\t\tif (cursorIndex > valueEndTrimmed.length && cursorIndex > this._cursorIndex) {\n\t\t\t\t\t\t\ttrailingWhitespace++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\ttrailingWhitespace = Math.max(cursorIndex - valueEndTrimmed.length, trailingWhitespace, 0);\n\t\t\t\t}\n\n\t\t\t\t// Handle case where a non-space character is inserted in the middle of trailing whitespace\n\t\t\t\tconst charBeforeCursor = cursorIndex === 0 ? '' : value[cursorIndex - 1];\n\t\t\t\tif (trailingWhitespace > 0 && cursorIndex === this._cursorIndex + 1 && this._lastUserInput !== '' && charBeforeCursor !== ' ') {\n\t\t\t\t\ttrailingWhitespace = this._value.length - this._cursorIndex;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (isMultiLine) {\n\t\t\t\tvalueLines[valueLines.length - 1] = valueLines.at(-1)?.trimEnd() ?? '';\n\t\t\t\tconst continuationOffset = (valueLines.length - 1) * (this._continuationPrompt?.length ?? 0);\n\t\t\t\ttrailingWhitespace = Math.max(0, cursorIndex - value.length - continuationOffset);\n\t\t\t}\n\n\t\t\tvalue = valueLines.map(e => e.trimEnd()).join('\\n') + ' '.repeat(trailingWhitespace);\n\t\t}\n\n\t\tghostTextIndex = this._scanForGhostText(buffer, line, cursorIndex);\n\n\t\tif (this._value !== value || this._cursorIndex !== cursorIndex || this._ghostTextIndex !== ghostTextIndex) {\n\t\t\tthis._value = value;\n\t\t\tthis._cursorIndex = cursorIndex;\n\t\t\tthis._ghostTextIndex = ghostTextIndex;\n\t\t\tthis._onDidChangeInput.fire(this._createStateObject());\n\t\t}\n\t}\n\n\tprivate _handleUserInput(e: string) {\n\t\tthis._lastUserInput = e;\n\t}\n\n\t/**\n\t * Detect ghost text by looking for italic or dim text in or after the cursor and\n\t * non-italic/dim text in the first non-whitespace cell following command start and before the cursor.\n\t */\n\tprivate _scanForGhostText(buffer: IBuffer, line: IBufferLine, cursorIndex: number): number {\n\t\tif (!this.value.trim().length) {\n\t\t\treturn -1;\n\t\t}\n\t\t// Check last non-whitespace character has non-ghost text styles\n\t\tlet ghostTextIndex = -1;\n\t\tlet proceedWithGhostTextCheck = false;\n\t\tlet x = buffer.cursorX;\n\t\twhile (x > 0) {\n\t\t\tconst cell = line.getCell(--x);\n\t\t\tif (!cell) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (cell.getChars().trim().length > 0) {\n\t\t\t\tproceedWithGhostTextCheck = !this._isCellStyledLikeGhostText(cell);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\t// Check to the end of the line for possible ghost text. For example pwsh's ghost text\n\t\t// can look like this `Get-|Ch[ildItem]`\n\t\tif (proceedWithGhostTextCheck) {\n\t\t\tlet potentialGhostIndexOffset = 0;\n\t\t\tlet x = buffer.cursorX;\n\n\t\t\twhile (x < line.length) {\n\t\t\t\tconst cell = line.getCell(x++);\n\t\t\t\tif (!cell || cell.getCode() === 0) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tif (this._isCellStyledLikeGhostText(cell)) {\n\t\t\t\t\tghostTextIndex = cursorIndex + potentialGhostIndexOffset;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tpotentialGhostIndexOffset += cell.getChars().length;\n\t\t\t}\n\t\t}\n\n\t\t// Ghost text may not be italic or dimmed, but will have a different style than the\n\t\t// rest of the line that precedes it.\n\t\tif (ghostTextIndex === -1) {\n\t\t\tghostTextIndex = this._scanForGhostTextAdvanced(buffer, line, cursorIndex);\n\t\t}\n\n\t\tif (ghostTextIndex > -1 && this.value.substring(ghostTextIndex).endsWith(' ')) {\n\t\t\tthis._value = this.value.trim();\n\t\t\tif (!this.value.substring(ghostTextIndex)) {\n\t\t\t\tghostTextIndex = -1;\n\t\t\t}\n\t\t}\n\t\treturn ghostTextIndex;\n\t}\n\n\tprivate _scanForGhostTextAdvanced(buffer: IBuffer, line: IBufferLine, cursorIndex: number): number {\n\t\tlet ghostTextIndex = -1;\n\t\tlet currentPos = buffer.cursorX; // Start scanning from the cursor position\n\n\t\t// Map to store styles and their corresponding positions\n\t\tconst styleMap = new Map<string, number[]>();\n\n\t\t// Identify the last non-whitespace character in the line\n\t\tlet lastNonWhitespaceCell = line.getCell(currentPos);\n\t\tlet nextCell: IBufferCell | undefined = lastNonWhitespaceCell;\n\n\t\t// Scan from the cursor position to the end of the line\n\t\twhile (nextCell && currentPos < line.length) {\n\t\t\tconst styleKey = this._getCellStyleAsString(nextCell);\n\n\t\t\t// Track all occurrences of each unique style in the line\n\t\t\tstyleMap.set(styleKey, [...(styleMap.get(styleKey) ?? []), currentPos]);\n\n\t\t\t// Move to the next cell\n\t\t\tnextCell = line.getCell(++currentPos);\n\n\t\t\t// Update `lastNonWhitespaceCell` only if the new cell contains visible characters\n\t\t\tif (nextCell?.getChars().trim().length) {\n\t\t\t\tlastNonWhitespaceCell = nextCell;\n\t\t\t}\n\t\t}\n\n\t\t// If there's no valid last non-whitespace cell OR the first and last styles match (indicating no ghost text)\n\t\tif (!lastNonWhitespaceCell?.getChars().trim().length ||\n\t\t\tthis._cellStylesMatch(line.getCell(this._commandStartX), lastNonWhitespaceCell)) {\n\t\t\treturn -1;\n\t\t}\n\n\t\t// Retrieve the positions of all cells with the same style as `lastNonWhitespaceCell`\n\t\tconst positionsWithGhostStyle = styleMap.get(this._getCellStyleAsString(lastNonWhitespaceCell));\n\t\tif (positionsWithGhostStyle) {\n\t\t\t// Ghost text must start at the cursor or one char after (e.g. a space)\n\t\t\t// To account for cursor movement, we also ensure there are not 5+ spaces preceding the ghost text position\n\t\t\tif (positionsWithGhostStyle[0] > buffer.cursorX + 1 && this._isPositionRightPrompt(line, positionsWithGhostStyle[0])) {\n\t\t\t\treturn -1;\n\t\t\t}\n\t\t\t// Ensure these positions are contiguous\n\t\t\tfor (let i = 1; i < positionsWithGhostStyle.length; i++) {\n\t\t\t\tif (positionsWithGhostStyle[i] !== positionsWithGhostStyle[i - 1] + 1) {\n\t\t\t\t\t// Discontinuous styles, so may be syntax highlighting vs ghost text\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t}\n\t\t\t// Calculate the ghost text start index\n\t\t\tif (buffer.baseY + buffer.cursorY === this._commandStartMarker?.line) {\n\t\t\t\tghostTextIndex = positionsWithGhostStyle[0] - this._commandStartX;\n\t\t\t} else {\n\t\t\t\tghostTextIndex = positionsWithGhostStyle[0];\n\t\t\t}\n\t\t}\n\n\t\t// Ensure no earlier cells in the line match `lastNonWhitespaceCell`'s style,\n\t\t// which would indicate the text is not ghost text.\n\t\tif (ghostTextIndex !== -1) {\n\t\t\tfor (let checkPos = buffer.cursorX; checkPos >= this._commandStartX; checkPos--) {\n\t\t\t\tconst checkCell = line.getCell(checkPos);\n\t\t\t\tif (!checkCell?.getChars.length) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tif (checkCell && checkCell.getCode() !== 0 && this._cellStylesMatch(lastNonWhitespaceCell, checkCell)) {\n\t\t\t\t\treturn -1;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\treturn ghostTextIndex >= cursorIndex ? ghostTextIndex : -1;\n\t}\n\n\t/**\n\t * 5+ spaces preceding the position, following the command start,\n\t * indicates that we're likely in a right prompt at the current position\n\t */\n\tprivate _isPositionRightPrompt(line: IBufferLine, position: number): boolean {\n\t\tlet count = 0;\n\t\tfor (let i = position - 1; i >= this._commandStartX; i--) {\n\t\t\tconst cell = line.getCell(i);\n\t\t\t// treat missing cell or whitespace-only cell as empty; reset count on first non-empty\n\t\t\tif (!cell || cell.getChars().trim().length === 0) {\n\t\t\t\tcount++;\n\t\t\t\t// If we've already found 5 consecutive empties we can early-return\n\t\t\t\tif (count >= 5) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// consecutive sequence broken\n\t\t\t\tcount = 0;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _getCellStyleAsString(cell: IBufferCell): string {\n\t\treturn `${cell.getFgColor()}${cell.getBgColor()}${cell.isBold()}${cell.isItalic()}${cell.isDim()}${cell.isUnderline()}${cell.isBlink()}${cell.isInverse()}${cell.isInvisible()}${cell.isStrikethrough()}${cell.isOverline()}${cell.getFgColorMode()}${cell.getBgColorMode()}`;\n\t}\n\n\tprivate _cellStylesMatch(a: IBufferCell | undefined, b: IBufferCell | undefined): boolean {\n\t\tif (!a || !b) {\n\t\t\treturn false;\n\t\t}\n\t\treturn a.getFgColor() === b.getFgColor()\n\t\t\t&& a.getBgColor() === b.getBgColor()\n\t\t\t&& a.isBold() === b.isBold()\n\t\t\t&& a.isItalic() === b.isItalic()\n\t\t\t&& a.isDim() === b.isDim()\n\t\t\t&& a.isUnderline() === b.isUnderline()\n\t\t\t&& a.isBlink() === b.isBlink()\n\t\t\t&& a.isInverse() === b.isInverse()\n\t\t\t&& a.isInvisible() === b.isInvisible()\n\t\t\t&& a.isStrikethrough() === b.isStrikethrough()\n\t\t\t&& a.isOverline() === b.isOverline()\n\t\t\t&& a?.getBgColorMode() === b?.getBgColorMode()\n\t\t\t&& a?.getFgColorMode() === b?.getFgColorMode();\n\t}\n\n\tprivate _trimContinuationPrompt(lineText: string): string {\n\t\tif (this._lineContainsContinuationPrompt(lineText)) {\n\t\t\tlineText = lineText.substring(this._continuationPrompt!.length);\n\t\t}\n\t\treturn lineText;\n\t}\n\n\tprivate _lineContainsContinuationPrompt(lineText: string): boolean {\n\t\treturn !!(this._continuationPrompt && lineText.startsWith(this._continuationPrompt.trimEnd()));\n\t}\n\n\tprivate _getContinuationPromptCellWidth(line: IBufferLine, lineText: string): number {\n\t\tif (!this._continuationPrompt || !lineText.startsWith(this._continuationPrompt.trimEnd())) {\n\t\t\treturn 0;\n\t\t}\n\t\tlet buffer = '';\n\t\tlet x = 0;\n\t\tlet cell: IBufferCell | undefined;\n\t\twhile (buffer !== this._continuationPrompt) {\n\t\t\tcell = line.getCell(x++);\n\t\t\tif (!cell) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbuffer += cell.getChars();\n\t\t}\n\t\treturn x;\n\t}\n\n\tprivate _getRelativeCursorIndex(startCellX: number, buffer: IBuffer, line: IBufferLine): number {\n\t\treturn line?.translateToString(false, startCellX, buffer.cursorX).length ?? 0;\n\t}\n\n\tprivate _isCellStyledLikeGhostText(cell: IBufferCell): boolean {\n\t\treturn !!(cell.isItalic() || cell.isDim());\n\t}\n\n\tprivate _createStateObject(): IPromptInputModelState {\n\t\treturn Object.freeze({\n\t\t\tvalue: this._value,\n\t\t\tprefix: this.prefix,\n\t\t\tsuffix: this.suffix,\n\t\t\tcursorIndex: this._cursorIndex,\n\t\t\tghostTextIndex: this._ghostTextIndex\n\t\t});\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { RunOnceScheduler } from '../../../../base/common/async.js';\nimport { debounce } from '../../../../base/common/decorators.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { Disposable, MandatoryMutableDisposable, MutableDisposable } from '../../../../base/common/lifecycle.js';\nimport { ILogService } from '../../../log/common/log.js';\nimport { isString } from '../../../../base/common/types.js';\nimport { CommandInvalidationReason, ICommandDetectionCapability, ICommandInvalidationRequest, IHandleCommandOptions, ISerializedCommandDetectionCapability, ISerializedTerminalCommand, ITerminalCommand, TerminalCapability } from './capabilities.js';\nimport { ITerminalOutputMatcher } from '../terminal.js';\nimport { ICurrentPartialCommand, isFullTerminalCommand, PartialTerminalCommand, TerminalCommand } from './commandDetection/terminalCommand.js';\nimport { PromptInputModel, type IPromptInputModel } from './commandDetection/promptInputModel.js';\nimport type { IBuffer, IDisposable, IMarker, Terminal } from '@xterm/headless';\n\ninterface ITerminalDimensions {\n\tcols: number;\n\trows: number;\n}\n\nexport class CommandDetectionCapability extends Disposable implements ICommandDetectionCapability {\n\treadonly type = TerminalCapability.CommandDetection;\n\n\tprivate readonly _promptInputModel: PromptInputModel;\n\tget promptInputModel(): IPromptInputModel { return this._promptInputModel; }\n\n\tprotected _commands: TerminalCommand[] = [];\n\tprivate _cwd: string | undefined;\n\tprivate _promptTerminator: string | undefined;\n\tprivate _currentCommand: PartialTerminalCommand;\n\tprivate _commandMarkers: IMarker[] = [];\n\tprivate _dimensions: ITerminalDimensions;\n\tprivate __isCommandStorageDisabled: boolean = false;\n\tprivate _handleCommandStartOptions?: IHandleCommandOptions;\n\tprivate _hasRichCommandDetection: boolean = false;\n\tget hasRichCommandDetection() { return this._hasRichCommandDetection; }\n\tprivate _nextCommandId: { command: string; commandId: string | undefined } | undefined;\n\n\tprivate _ptyHeuristicsHooks: ICommandDetectionHeuristicsHooks;\n\tprivate readonly _ptyHeuristics: MandatoryMutableDisposable<IPtyHeuristics>;\n\n\tget commands(): readonly TerminalCommand[] { return this._commands; }\n\tget executingCommand(): string | undefined { return this._currentCommand.command; }\n\tget executingCommandObject(): ITerminalCommand | undefined {\n\t\tif (this._currentCommand.commandStartMarker) {\n\t\t\t// HACK: This does a lot more than the consumer of the API needs. It's also a little\n\t\t\t//       misleading since it's not promoting the current command yet.\n\t\t\treturn this._currentCommand.promoteToFullCommand(this._cwd, undefined, this._handleCommandStartOptions?.ignoreCommandLine ?? false, undefined);\n\t\t}\n\t\treturn undefined;\n\t}\n\tget executingCommandConfidence(): 'low' | 'medium' | 'high' | undefined {\n\t\tconst casted = this._currentCommand as PartialTerminalCommand | ITerminalCommand;\n\t\treturn isFullTerminalCommand(casted) ? casted.commandLineConfidence : undefined;\n\t}\n\tget currentCommand(): ICurrentPartialCommand {\n\t\treturn this._currentCommand;\n\t}\n\tget cwd(): string | undefined { return this._cwd; }\n\tget promptTerminator(): string | undefined { return this._promptTerminator; }\n\n\tprivate readonly _onCommandStarted = this._register(new Emitter<ITerminalCommand>());\n\treadonly onCommandStarted = this._onCommandStarted.event;\n\tprivate readonly _onCommandStartChanged = this._register(new Emitter<void>());\n\treadonly onCommandStartChanged = this._onCommandStartChanged.event;\n\tprivate readonly _onBeforeCommandFinished = this._register(new Emitter<ITerminalCommand>());\n\treadonly onBeforeCommandFinished = this._onBeforeCommandFinished.event;\n\tprivate readonly _onCommandFinished = this._register(new Emitter<ITerminalCommand>());\n\treadonly onCommandFinished = this._onCommandFinished.event;\n\tprivate readonly _onCommandExecuted = this._register(new Emitter<ITerminalCommand>());\n\treadonly onCommandExecuted = this._onCommandExecuted.event;\n\tprivate readonly _onCommandInvalidated = this._register(new Emitter<ITerminalCommand[]>());\n\treadonly onCommandInvalidated = this._onCommandInvalidated.event;\n\tprivate readonly _onCurrentCommandInvalidated = this._register(new Emitter<ICommandInvalidationRequest>());\n\treadonly onCurrentCommandInvalidated = this._onCurrentCommandInvalidated.event;\n\tprivate readonly _onSetRichCommandDetection = this._register(new Emitter<boolean>());\n\treadonly onSetRichCommandDetection = this._onSetRichCommandDetection.event;\n\n\tconstructor(\n\t\tprivate readonly _terminal: Terminal,\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t\tthis._currentCommand = new PartialTerminalCommand(this._terminal);\n\t\tthis._promptInputModel = this._register(new PromptInputModel(this._terminal, this.onCommandStarted, this.onCommandStartChanged, this.onCommandExecuted, this._logService));\n\n\t\t// Pull command line from the buffer if it was not set explicitly\n\t\tthis._register(this.onCommandExecuted(command => {\n\t\t\tif (command.commandLineConfidence !== 'high') {\n\t\t\t\t// HACK: onCommandExecuted actually fired with PartialTerminalCommand\n\t\t\t\tconst typedCommand = (command as ITerminalCommand | PartialTerminalCommand);\n\t\t\t\tcommand.command = typedCommand.extractCommandLine();\n\t\t\t\tcommand.commandLineConfidence = 'low';\n\n\t\t\t\t// ITerminalCommand\n\t\t\t\tif (isFullTerminalCommand(typedCommand)) {\n\t\t\t\t\tif (\n\t\t\t\t\t\t// Markers exist\n\t\t\t\t\t\ttypedCommand.promptStartMarker && typedCommand.marker && typedCommand.executedMarker &&\n\t\t\t\t\t\t// Single line command\n\t\t\t\t\t\tcommand.command.indexOf('\\n') === -1 &&\n\t\t\t\t\t\t// Start marker is not on the left-most column\n\t\t\t\t\t\ttypedCommand.startX !== undefined && typedCommand.startX > 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tcommand.commandLineConfidence = 'medium';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t// PartialTerminalCommand\n\t\t\t\telse {\n\t\t\t\t\tif (\n\t\t\t\t\t\t// Markers exist\n\t\t\t\t\t\ttypedCommand.promptStartMarker && typedCommand.commandStartMarker && typedCommand.commandExecutedMarker &&\n\t\t\t\t\t\t// Single line command\n\t\t\t\t\t\tcommand.command.indexOf('\\n') === -1 &&\n\t\t\t\t\t\t// Start marker is not on the left-most column\n\t\t\t\t\t\ttypedCommand.commandStartX !== undefined && typedCommand.commandStartX > 0\n\t\t\t\t\t) {\n\t\t\t\t\t\tcommand.commandLineConfidence = 'medium';\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(this._terminal.parser.registerCsiHandler({ final: 'J' }, params => {\n\t\t\tif (params.length >= 1 && params[0] === 2) {\n\t\t\t\tif (!this._terminal.options.scrollOnEraseInDisplay) {\n\t\t\t\t\tthis._clearCommandsInViewport();\n\t\t\t\t}\n\t\t\t\tthis._currentCommand.wasCleared = true;\n\t\t\t}\n\t\t\t// We don't want to override xterm.js' default behavior, just augment it\n\t\t\treturn false;\n\t\t}));\n\n\t\t// Set up platform-specific behaviors\n\t\tconst that = this;\n\t\tthis._ptyHeuristicsHooks = new class implements ICommandDetectionHeuristicsHooks {\n\t\t\tget onCurrentCommandInvalidatedEmitter() { return that._onCurrentCommandInvalidated; }\n\t\t\tget onCommandStartedEmitter() { return that._onCommandStarted; }\n\t\t\tget onCommandExecutedEmitter() { return that._onCommandExecuted; }\n\t\t\tget dimensions() { return that._dimensions; }\n\t\t\tget isCommandStorageDisabled() { return that.__isCommandStorageDisabled; }\n\t\t\tget commandMarkers() { return that._commandMarkers; }\n\t\t\tset commandMarkers(value) { that._commandMarkers = value; }\n\t\t\tget clearCommandsInViewport() { return that._clearCommandsInViewport.bind(that); }\n\t\t};\n\t\tthis._ptyHeuristics = this._register(new MandatoryMutableDisposable(new UnixPtyHeuristics(this._terminal, this, this._ptyHeuristicsHooks, this._logService)));\n\n\t\tthis._dimensions = {\n\t\t\tcols: this._terminal.cols,\n\t\t\trows: this._terminal.rows\n\t\t};\n\t\tthis._register(this._terminal.onResize(e => this._handleResize(e)));\n\t\tthis._register(this._terminal.onCursorMove(() => this._handleCursorMove()));\n\t}\n\n\tprivate _handleResize(e: { cols: number; rows: number }) {\n\t\tthis._ptyHeuristics.value.preHandleResize?.(e);\n\t\tthis._dimensions.cols = e.cols;\n\t\tthis._dimensions.rows = e.rows;\n\t}\n\n\t@debounce(500)\n\tprivate _handleCursorMove() {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\t// Early versions of conpty do not have real support for an alt buffer, in addition certain\n\t\t// commands such as tsc watch will write to the top of the normal buffer. The following\n\t\t// checks when the cursor has moved while the normal buffer is empty and if it is above the\n\t\t// current command, all decorations within the viewport will be invalidated.\n\t\t//\n\t\t// This function is debounced so that the cursor is only checked when it is stable so\n\t\t// conpty's screen reprinting will not trigger decoration clearing.\n\t\t//\n\t\t// This is mostly a workaround for Windows but applies to all OS' because of the tsc watch\n\t\t// case.\n\t\tif (this._terminal.buffer.active === this._terminal.buffer.normal && this._currentCommand.commandStartMarker) {\n\t\t\tif (this._terminal.buffer.active.baseY + this._terminal.buffer.active.cursorY < this._currentCommand.commandStartMarker.line) {\n\t\t\t\tthis._clearCommandsInViewport();\n\t\t\t\tthis._currentCommand.isInvalid = true;\n\t\t\t\tthis._onCurrentCommandInvalidated.fire({ reason: CommandInvalidationReason.Windows });\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _clearCommandsInViewport(): void {\n\t\t// Find the number of commands on the tail end of the array that are within the viewport\n\t\tlet count = 0;\n\t\tfor (let i = this._commands.length - 1; i >= 0; i--) {\n\t\t\tconst line = this._commands[i].marker?.line;\n\t\t\tif (line && line < this._terminal.buffer.active.baseY) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcount++;\n\t\t}\n\t\t// Remove them\n\t\tif (count > 0) {\n\t\t\tthis._onCommandInvalidated.fire(this._commands.splice(this._commands.length - count, count));\n\t\t}\n\t}\n\n\tsetContinuationPrompt(value: string): void {\n\t\tthis._promptInputModel.setContinuationPrompt(value);\n\t}\n\n\t// TODO: Simplify this, can everything work off the last line?\n\tsetPromptTerminator(promptTerminator: string, lastPromptLine: string) {\n\t\tthis._logService.debug('CommandDetectionCapability#setPromptTerminator', promptTerminator);\n\t\tthis._promptTerminator = promptTerminator;\n\t\tthis._promptInputModel.setLastPromptLine(lastPromptLine);\n\t}\n\n\tsetCwd(value: string) {\n\t\tthis._cwd = value;\n\t}\n\n\tsetIsWindowsPty(value: boolean) {\n\t\tif (value && !(this._ptyHeuristics.value instanceof WindowsPtyHeuristics)) {\n\t\t\tconst that = this;\n\t\t\tthis._ptyHeuristics.value = new WindowsPtyHeuristics(\n\t\t\t\tthis._terminal,\n\t\t\t\tthis,\n\t\t\t\tnew class {\n\t\t\t\t\tget onCurrentCommandInvalidatedEmitter() { return that._onCurrentCommandInvalidated; }\n\t\t\t\t\tget onCommandStartedEmitter() { return that._onCommandStarted; }\n\t\t\t\t\tget onCommandExecutedEmitter() { return that._onCommandExecuted; }\n\t\t\t\t\tget dimensions() { return that._dimensions; }\n\t\t\t\t\tget isCommandStorageDisabled() { return that.__isCommandStorageDisabled; }\n\t\t\t\t\tget commandMarkers() { return that._commandMarkers; }\n\t\t\t\t\tset commandMarkers(value) { that._commandMarkers = value; }\n\t\t\t\t\tget clearCommandsInViewport() { return that._clearCommandsInViewport.bind(that); }\n\t\t\t\t},\n\t\t\t\tthis._logService\n\t\t\t);\n\t\t} else if (!value && !(this._ptyHeuristics.value instanceof UnixPtyHeuristics)) {\n\t\t\tthis._ptyHeuristics.value = new UnixPtyHeuristics(this._terminal, this, this._ptyHeuristicsHooks, this._logService);\n\t\t}\n\t}\n\n\tsetHasRichCommandDetection(value: boolean): void {\n\t\tthis._hasRichCommandDetection = value;\n\t\tthis._onSetRichCommandDetection.fire(value);\n\t}\n\n\tsetIsCommandStorageDisabled(): void {\n\t\tthis.__isCommandStorageDisabled = true;\n\t}\n\n\tgetCommandForLine(line: number): ITerminalCommand | ICurrentPartialCommand | undefined {\n\t\t// Handle the current partial command first, anything below it's prompt is considered part\n\t\t// of the current command\n\t\tif (this._currentCommand.promptStartMarker && line >= this._currentCommand.promptStartMarker?.line) {\n\t\t\treturn this._currentCommand;\n\t\t}\n\n\t\t// No commands\n\t\tif (this._commands.length === 0) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// Line is before any registered commands\n\t\tif ((this._commands[0].promptStartMarker ?? this._commands[0].marker!).line > line) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\t// Iterate backwards through commands to find the right one\n\t\tfor (let i = this.commands.length - 1; i >= 0; i--) {\n\t\t\tif ((this.commands[i].promptStartMarker ?? this.commands[i].marker!).line <= line) {\n\t\t\t\treturn this.commands[i];\n\t\t\t}\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\tgetCwdForLine(line: number): string | undefined {\n\t\t// Handle the current partial command first, anything below it's prompt is considered part\n\t\t// of the current command\n\t\tif (this._currentCommand.promptStartMarker && line >= this._currentCommand.promptStartMarker?.line) {\n\t\t\treturn this._cwd;\n\t\t}\n\n\t\tconst command = this.getCommandForLine(line);\n\t\tif (command && isFullTerminalCommand(command)) {\n\t\t\treturn command.cwd;\n\t\t}\n\n\t\treturn undefined;\n\t}\n\n\thandlePromptStart(options?: IHandleCommandOptions): void {\n\t\t// Adjust the last command's finished marker when needed. The standard position for the\n\t\t// finished marker `D` to appear is at the same position as the following prompt started\n\t\t// `A`. Only do this when it would not extend past the current cursor position.\n\t\tconst lastCommand = this.commands.at(-1);\n\t\tif (\n\t\t\tlastCommand?.endMarker &&\n\t\t\tlastCommand?.executedMarker &&\n\t\t\tlastCommand.endMarker.line === lastCommand.executedMarker.line &&\n\t\t\tlastCommand.executedMarker.line < this._terminal.buffer.active.baseY + this._terminal.buffer.active.cursorY\n\t\t) {\n\t\t\tthis._logService.debug('CommandDetectionCapability#handlePromptStart adjusted commandFinished', `${lastCommand.endMarker.line} -> ${lastCommand.executedMarker.line + 1}`);\n\t\t\tlastCommand.endMarker = cloneMarker(this._terminal, lastCommand.executedMarker, 1);\n\t\t}\n\n\t\tthis._currentCommand.promptStartMarker = (\n\t\t\toptions?.marker ||\n\t\t\t// Generally the prompt start should happen at the exact place the endmarker happened.\n\t\t\t// However, after ctrl+l is used to clear the display, we want to ensure the actual\n\t\t\t// prompt start marker position is used. This is mostly a workaround for Windows but we\n\t\t\t// apply it generally.\n\t\t\t(!this._currentCommand.wasCleared && lastCommand?.endMarker\n\t\t\t\t? cloneMarker(this._terminal, lastCommand.endMarker)\n\t\t\t\t: this._terminal.registerMarker(0))\n\t\t);\n\t\tthis._currentCommand.wasCleared = false;\n\t}\n\n\thandleContinuationStart(): void {\n\t\tthis._currentCommand.currentContinuationMarker = this._terminal.registerMarker(0);\n\t\tthis._logService.debug('CommandDetectionCapability#handleContinuationStart', this._currentCommand.currentContinuationMarker);\n\t}\n\n\thandleContinuationEnd(): void {\n\t\tif (!this._currentCommand.currentContinuationMarker) {\n\t\t\tthis._logService.warn('CommandDetectionCapability#handleContinuationEnd Received continuation end without start');\n\t\t\treturn;\n\t\t}\n\t\tif (!this._currentCommand.continuations) {\n\t\t\tthis._currentCommand.continuations = [];\n\t\t}\n\t\tthis._currentCommand.continuations.push({\n\t\t\tmarker: this._currentCommand.currentContinuationMarker,\n\t\t\tend: this._terminal.buffer.active.cursorX\n\t\t});\n\t\tthis._currentCommand.currentContinuationMarker = undefined;\n\t\tthis._logService.debug('CommandDetectionCapability#handleContinuationEnd', this._currentCommand.continuations[this._currentCommand.continuations.length - 1]);\n\t}\n\n\thandleRightPromptStart(): void {\n\t\tthis._currentCommand.commandRightPromptStartX = this._terminal.buffer.active.cursorX;\n\t\tthis._logService.debug('CommandDetectionCapability#handleRightPromptStart', this._currentCommand.commandRightPromptStartX);\n\t}\n\n\thandleRightPromptEnd(): void {\n\t\tthis._currentCommand.commandRightPromptEndX = this._terminal.buffer.active.cursorX;\n\t\tthis._logService.debug('CommandDetectionCapability#handleRightPromptEnd', this._currentCommand.commandRightPromptEndX);\n\t}\n\n\thandleCommandStart(options?: IHandleCommandOptions): void {\n\t\tthis._handleCommandStartOptions = options;\n\t\tthis._currentCommand.cwd = this._cwd;\n\t\t// Only update the column if the line has already been set\n\t\tthis._currentCommand.commandStartMarker = options?.marker || this._currentCommand.commandStartMarker;\n\t\tif (this._currentCommand.commandStartMarker?.line === this._terminal.buffer.active.cursorY) {\n\t\t\tthis._currentCommand.commandStartX = this._terminal.buffer.active.cursorX;\n\t\t\tthis._onCommandStartChanged.fire();\n\t\t\tthis._logService.debug('CommandDetectionCapability#handleCommandStart', this._currentCommand.commandStartX, this._currentCommand.commandStartMarker?.line);\n\t\t\treturn;\n\t\t}\n\t\tthis._ptyHeuristics.value.handleCommandStart(options);\n\t}\n\n\t/**\n\t * Sets the command ID to use for the next command that starts.\n\t * This is useful when you want to pre-assign an ID before the shell sends the command start sequence.\n\t */\n\tsetNextCommandId(command: string, commandId: string): void {\n\t\tthis._nextCommandId = { command, commandId };\n\t}\n\n\thandleCommandExecuted(options?: IHandleCommandOptions): void {\n\t\tthis._ensureCurrentCommandId(this._currentCommand.command ?? this._currentCommand.extractCommandLine());\n\t\tthis._ptyHeuristics.value.handleCommandExecuted(options);\n\t\tthis._currentCommand.markExecutedTime();\n\t}\n\n\thandleCommandFinished(exitCode: number | undefined, options?: IHandleCommandOptions): void {\n\t\t// Command executed may not have happened yet, if not handle it now so the expected events\n\t\t// properly propagate. This may cause the output to show up in the computed command line,\n\t\t// but the command line confidence will be low in the extension host for example and\n\t\t// therefore cannot be trusted anyway.\n\t\tif (!this._currentCommand.commandExecutedMarker) {\n\t\t\tthis.handleCommandExecuted();\n\t\t}\n\t\tthis._currentCommand.markFinishedTime();\n\t\tthis._ptyHeuristics.value.preHandleCommandFinished?.();\n\n\t\tthis._logService.debug('CommandDetectionCapability#handleCommandFinished', this._terminal.buffer.active.cursorX, options?.marker?.line, this._currentCommand.command, this._currentCommand);\n\n\t\t// HACK: Handle a special case on some versions of bash where identical commands get merged\n\t\t// in the output of `history`, this detects that case and sets the exit code to the last\n\t\t// command's exit code. This covered the majority of cases but will fail if the same command\n\t\t// runs with a different exit code, that will need a more robust fix where we send the\n\t\t// command ID and exit code over to the capability to adjust there.\n\t\tif (exitCode === undefined) {\n\t\t\tconst lastCommand = this.commands.length > 0 ? this.commands[this.commands.length - 1] : undefined;\n\t\t\tif (this._currentCommand.command && this._currentCommand.command.length > 0 && lastCommand?.command === this._currentCommand.command) {\n\t\t\t\texitCode = lastCommand.exitCode;\n\t\t\t}\n\t\t}\n\n\t\tif (this._currentCommand.commandStartMarker === undefined || !this._terminal.buffer.active) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._currentCommand.commandFinishedMarker = options?.marker || this._terminal.registerMarker(0);\n\n\t\tthis._ptyHeuristics.value.postHandleCommandFinished?.();\n\n\t\tconst newCommand = this._currentCommand.promoteToFullCommand(this._cwd, exitCode, this._handleCommandStartOptions?.ignoreCommandLine ?? false, options?.markProperties);\n\n\t\tif (newCommand) {\n\t\t\tthis._commands.push(newCommand);\n\t\t\tthis._onBeforeCommandFinished.fire(newCommand);\n\t\t\t// NOTE: onCommandFinished used to not fire if the command was invalid, but this causes\n\t\t\t// problems especially with the associated execution event never firing in the extension\n\t\t\t// API. See https://github.com/microsoft/vscode/issues/252489\n\t\t\tthis._logService.debug('CommandDetectionCapability#onCommandFinished', newCommand);\n\t\t\tthis._onCommandFinished.fire(newCommand);\n\t\t}\n\t\t// Create new command for next execution\n\t\tthis._currentCommand = new PartialTerminalCommand(this._terminal);\n\t\tthis._handleCommandStartOptions = undefined;\n\t}\n\n\tprivate _ensureCurrentCommandId(_commandLine: string | undefined): void {\n\t\tif (this._nextCommandId?.commandId) {\n\t\t\t// Assign the pre-set command ID to the current command. The timing of setNextCommandId\n\t\t\t// (called right before runCommand) and _ensureCurrentCommandId (called on command\n\t\t\t// executed) ensures we're matching the right command without needing string comparison.\n\t\t\tif (this._currentCommand.id !== this._nextCommandId.commandId) {\n\t\t\t\tthis._currentCommand.id = this._nextCommandId.commandId;\n\t\t\t}\n\t\t\tthis._nextCommandId = undefined;\n\t\t}\n\t}\n\n\tsetCommandLine(commandLine: string, isTrusted: boolean) {\n\t\tthis._logService.debug('CommandDetectionCapability#setCommandLine', commandLine, isTrusted);\n\t\tthis._currentCommand.command = commandLine;\n\t\tthis._currentCommand.commandLineConfidence = 'high';\n\t\tthis._currentCommand.isTrusted = isTrusted;\n\n\t\tif (isTrusted) {\n\t\t\tthis._promptInputModel.setConfidentCommandLine(commandLine);\n\t\t}\n\t}\n\n\tserialize(): ISerializedCommandDetectionCapability {\n\t\tconst commands: ISerializedTerminalCommand[] = this.commands.map(e => e.serialize(this.__isCommandStorageDisabled));\n\t\tconst partialCommand = this._currentCommand.serialize(this._cwd);\n\t\tif (partialCommand) {\n\t\t\tcommands.push(partialCommand);\n\t\t}\n\t\treturn {\n\t\t\tisWindowsPty: this._ptyHeuristics.value instanceof WindowsPtyHeuristics,\n\t\t\thasRichCommandDetection: this._hasRichCommandDetection,\n\t\t\tcommands,\n\t\t\tpromptInputModel: this._promptInputModel.serialize(),\n\t\t};\n\t}\n\n\tdeserialize(serialized: ISerializedCommandDetectionCapability): void {\n\t\tif (serialized.isWindowsPty) {\n\t\t\tthis.setIsWindowsPty(serialized.isWindowsPty);\n\t\t}\n\t\tif (serialized.hasRichCommandDetection) {\n\t\t\tthis.setHasRichCommandDetection(serialized.hasRichCommandDetection);\n\t\t}\n\t\tconst buffer = this._terminal.buffer.normal;\n\t\tfor (const e of serialized.commands) {\n\t\t\t// Partial command\n\t\t\tif (!e.endLine) {\n\t\t\t\t// Check for invalid command\n\t\t\t\tconst marker = e.startLine !== undefined ? this._terminal.registerMarker(e.startLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\t\t\t\tif (!marker) {\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t\tthis._currentCommand.commandStartMarker = e.startLine !== undefined ? this._terminal.registerMarker(e.startLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\t\t\t\tthis._currentCommand.commandStartX = e.startX;\n\t\t\t\tthis._currentCommand.promptStartMarker = e.promptStartLine !== undefined ? this._terminal.registerMarker(e.promptStartLine - (buffer.baseY + buffer.cursorY)) : undefined;\n\t\t\t\tthis._cwd = e.cwd;\n\t\t\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\t\t\tthis._onCommandStarted.fire({ marker } as ITerminalCommand);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t// Full command\n\t\t\tconst newCommand = TerminalCommand.deserialize(this._terminal, e, this.__isCommandStorageDisabled);\n\t\t\tif (!newCommand) {\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tthis._commands.push(newCommand);\n\t\t\tthis._logService.debug('CommandDetectionCapability#onCommandFinished', newCommand);\n\t\t\tthis._onCommandFinished.fire(newCommand);\n\t\t}\n\t\tif (serialized.promptInputModel) {\n\t\t\tthis._promptInputModel.deserialize(serialized.promptInputModel);\n\t\t}\n\t}\n}\n\n/**\n * Additional hooks to private methods on {@link CommandDetectionCapability} that are needed by the\n * heuristics objects.\n */\ninterface ICommandDetectionHeuristicsHooks {\n\treadonly onCurrentCommandInvalidatedEmitter: Emitter<ICommandInvalidationRequest>;\n\treadonly onCommandStartedEmitter: Emitter<ITerminalCommand>;\n\treadonly onCommandExecutedEmitter: Emitter<ITerminalCommand>;\n\treadonly dimensions: ITerminalDimensions;\n\treadonly isCommandStorageDisabled: boolean;\n\n\tcommandMarkers: IMarker[];\n\n\tclearCommandsInViewport(): void;\n}\n\ntype IPtyHeuristics = (\n\t// All optional methods\n\tPartial<UnixPtyHeuristics> & Partial<WindowsPtyHeuristics> &\n\t// All common methods\n\t(UnixPtyHeuristics | WindowsPtyHeuristics) &\n\tIDisposable\n);\n\n/**\n * Non-Windows-specific behavior.\n */\nclass UnixPtyHeuristics extends Disposable {\n\tconstructor(\n\t\tprivate readonly _terminal: Terminal,\n\t\tprivate readonly _capability: CommandDetectionCapability,\n\t\tprivate readonly _hooks: ICommandDetectionHeuristicsHooks,\n\t\tprivate readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t}\n\n\thandleCommandStart(options?: IHandleCommandOptions) {\n\t\tconst currentCommand = this._capability.currentCommand;\n\t\tcurrentCommand.commandStartX = this._terminal.buffer.active.cursorX;\n\t\tcurrentCommand.commandStartMarker = options?.marker || this._terminal.registerMarker(0);\n\n\t\t// Clear executed as it must happen after command start\n\t\tcurrentCommand.commandExecutedMarker?.dispose();\n\t\tcurrentCommand.commandExecutedMarker = undefined;\n\t\tcurrentCommand.commandExecutedX = undefined;\n\t\tfor (const m of this._hooks.commandMarkers) {\n\t\t\tm.dispose();\n\t\t}\n\t\tthis._hooks.commandMarkers.length = 0;\n\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\tthis._hooks.onCommandStartedEmitter.fire({ marker: options?.marker || currentCommand.commandStartMarker, markProperties: options?.markProperties } as ITerminalCommand);\n\t\tthis._logService.debug('CommandDetectionCapability#handleCommandStart', currentCommand.commandStartX, currentCommand.commandStartMarker?.line);\n\t}\n\n\thandleCommandExecuted(options?: IHandleCommandOptions) {\n\t\tconst currentCommand = this._capability.currentCommand;\n\t\tcurrentCommand.commandExecutedMarker = options?.marker || this._terminal.registerMarker(0);\n\t\tcurrentCommand.commandExecutedX = this._terminal.buffer.active.cursorX;\n\t\tthis._logService.debug('CommandDetectionCapability#handleCommandExecuted', currentCommand.commandExecutedX, currentCommand.commandExecutedMarker?.line);\n\n\t\t// Sanity check optional props\n\t\tif (!currentCommand.commandStartMarker || !currentCommand.commandExecutedMarker || currentCommand.commandStartX === undefined) {\n\t\t\treturn;\n\t\t}\n\n\t\tcurrentCommand.command = this._capability.promptInputModel.ghostTextIndex > -1 ? this._capability.promptInputModel.value.substring(0, this._capability.promptInputModel.ghostTextIndex) : this._capability.promptInputModel.value;\n\t\tthis._hooks.onCommandExecutedEmitter.fire(currentCommand as ITerminalCommand);\n\t}\n}\n\nconst enum AdjustCommandStartMarkerConstants {\n\tMaxCheckLineCount = 10,\n\tInterval = 20,\n\tMaximumPollCount = 10,\n}\n\n/**\n * An object that integrated with and decorates the command detection capability to add heuristics\n * that adjust various markers to work better with Windows and ConPTY. This isn't depended upon the\n * frontend OS, or even the backend OS, but the `IsWindows` property which technically a non-Windows\n * client can emit (for example in tests).\n */\nclass WindowsPtyHeuristics extends Disposable {\n\n\tprivate readonly _onCursorMoveListener = this._register(new MutableDisposable());\n\n\tprivate _tryAdjustCommandStartMarkerScheduler?: RunOnceScheduler;\n\tprivate _tryAdjustCommandStartMarkerScannedLineCount: number = 0;\n\tprivate _tryAdjustCommandStartMarkerPollCount: number = 0;\n\n\tconstructor(\n\t\tprivate readonly _terminal: Terminal,\n\t\tprivate readonly _capability: CommandDetectionCapability,\n\t\tprivate readonly _hooks: ICommandDetectionHeuristicsHooks,\n\t\t@ILogService private readonly _logService: ILogService,\n\t) {\n\t\tsuper();\n\n\t\tthis._register(this._capability.onBeforeCommandFinished(command => {\n\t\t\t// For older Windows backends we cannot listen to CSI J, instead we assume running clear\n\t\t\t// or cls will clear all commands in the viewport. This is not perfect but it's right\n\t\t\t// most of the time.\n\t\t\tif (command.command.trim().toLowerCase() === 'clear' || command.command.trim().toLowerCase() === 'cls') {\n\t\t\t\tthis._tryAdjustCommandStartMarkerScheduler?.cancel();\n\t\t\t\tthis._tryAdjustCommandStartMarkerScheduler = undefined;\n\t\t\t\tthis._hooks.clearCommandsInViewport();\n\t\t\t\tthis._capability.currentCommand.isInvalid = true;\n\t\t\t\tthis._hooks.onCurrentCommandInvalidatedEmitter.fire({ reason: CommandInvalidationReason.Windows });\n\t\t\t}\n\t\t}));\n\t}\n\n\tpreHandleResize(e: { cols: number; rows: number }) {\n\t\t// Resize behavior is different under conpty; instead of bringing parts of the scrollback\n\t\t// back into the viewport, new lines are inserted at the bottom (ie. the same behavior as if\n\t\t// there was no scrollback).\n\t\t//\n\t\t// On resize this workaround will wait for a conpty reprint to occur by waiting for the\n\t\t// cursor to move, it will then calculate the number of lines that the commands within the\n\t\t// viewport _may have_ shifted. After verifying the content of the current line is\n\t\t// incorrect, the line after shifting is checked and if that matches delete events are fired\n\t\t// on the xterm.js buffer to move the markers.\n\t\t//\n\t\t// While a bit hacky, this approach is quite safe and seems to work great at least for pwsh.\n\t\tconst baseY = this._terminal.buffer.active.baseY;\n\t\tconst rowsDifference = e.rows - this._hooks.dimensions.rows;\n\t\t// Only do when rows increase, do in the next frame as this needs to happen after\n\t\t// conpty reprints the screen\n\t\tif (rowsDifference > 0) {\n\t\t\tthis._waitForCursorMove().then(() => {\n\t\t\t\t// Calculate the number of lines the content may have shifted, this will max out at\n\t\t\t\t// scrollback count since the standard behavior will be used then\n\t\t\t\tconst potentialShiftedLineCount = Math.min(rowsDifference, baseY);\n\t\t\t\t// For each command within the viewport, assume commands are in the correct order\n\t\t\t\tfor (let i = this._capability.commands.length - 1; i >= 0; i--) {\n\t\t\t\t\tconst command = this._capability.commands[i];\n\t\t\t\t\tif (!command.marker || command.marker.line < baseY || command.commandStartLineContent === undefined) {\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\tconst line = this._terminal.buffer.active.getLine(command.marker.line);\n\t\t\t\t\tif (!line || line.translateToString(true) === command.commandStartLineContent) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\tconst shiftedY = command.marker.line - potentialShiftedLineCount;\n\t\t\t\t\tconst shiftedLine = this._terminal.buffer.active.getLine(shiftedY);\n\t\t\t\t\tif (shiftedLine?.translateToString(true) !== command.commandStartLineContent) {\n\t\t\t\t\t\tcontinue;\n\t\t\t\t\t}\n\t\t\t\t\t// HACK: xterm.js doesn't expose this by design as it's an internal core\n\t\t\t\t\t// function an embedder could easily do damage with. Additionally, this\n\t\t\t\t\t// can't really be upstreamed since the event relies on shell integration to\n\t\t\t\t\t// verify the shifting is necessary.\n\t\t\t\t\tinterface IXtermWithCore extends Terminal {\n\t\t\t\t\t\t_core: {\n\t\t\t\t\t\t\t_bufferService: {\n\t\t\t\t\t\t\t\tbuffer: {\n\t\t\t\t\t\t\t\t\tlines: {\n\t\t\t\t\t\t\t\t\t\tonDeleteEmitter: {\n\t\t\t\t\t\t\t\t\t\t\tfire(data: { index: number; amount: number }): void;\n\t\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t\t};\n\t\t\t\t\t\t\t};\n\t\t\t\t\t\t};\n\t\t\t\t\t}\n\t\t\t\t\t(this._terminal as IXtermWithCore)._core._bufferService.buffer.lines.onDeleteEmitter.fire({\n\t\t\t\t\t\tindex: this._terminal.buffer.active.baseY,\n\t\t\t\t\t\tamount: potentialShiftedLineCount\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\t}\n\n\thandleCommandStart() {\n\t\tthis._capability.currentCommand.commandStartX = this._terminal.buffer.active.cursorX;\n\n\t\t// On Windows track all cursor movements after the command start sequence\n\t\tthis._hooks.commandMarkers.length = 0;\n\n\t\tconst initialCommandStartMarker = this._capability.currentCommand.commandStartMarker = (\n\t\t\tthis._capability.currentCommand.promptStartMarker\n\t\t\t\t? cloneMarker(this._terminal, this._capability.currentCommand.promptStartMarker)\n\t\t\t\t: this._terminal.registerMarker(0)\n\t\t)!;\n\t\tthis._capability.currentCommand.commandStartX = 0;\n\n\t\t// DEBUG: Add a decoration for the original unadjusted command start position\n\t\t// if ('registerDecoration' in this._terminal) {\n\t\t// \tconst d = (this._terminal as any).registerDecoration({\n\t\t// \t\tmarker: this._capability.currentCommand.commandStartMarker,\n\t\t// \t\tx: this._capability.currentCommand.commandStartX\n\t\t// \t});\n\t\t// \td?.onRender((e: HTMLElement) => {\n\t\t// \t\te.textContent = 'b';\n\t\t// \t\te.classList.add('xterm-sequence-decoration', 'top', 'right');\n\t\t// \t\te.title = 'Initial command start position';\n\t\t// \t});\n\t\t// }\n\n\t\t// The command started sequence may be printed before the actual prompt is, for example a\n\t\t// multi-line prompt will typically look like this where D, A and B signify the command\n\t\t// finished, prompt started and command started sequences respectively:\n\t\t//\n\t\t//     D/my/cwdB\n\t\t//     > C\n\t\t//\n\t\t// Due to this, it's likely that this will be called before the line has been parsed.\n\t\t// Unfortunately, it is also the case that the actual command start data may not be parsed\n\t\t// by the end of the task either, so a microtask cannot be used.\n\t\t//\n\t\t// The strategy used is to begin polling and scanning downwards for up to the next 5 lines.\n\t\t// If it looks like a prompt is found, the command started location is adjusted. If the\n\t\t// command executed sequences comes in before polling is done, polling is canceled and the\n\t\t// final polling task is executed synchronously.\n\t\tthis._tryAdjustCommandStartMarkerScannedLineCount = 0;\n\t\tthis._tryAdjustCommandStartMarkerPollCount = 0;\n\t\tthis._tryAdjustCommandStartMarkerScheduler = new RunOnceScheduler(() => this._tryAdjustCommandStartMarker(initialCommandStartMarker), AdjustCommandStartMarkerConstants.Interval);\n\t\tthis._tryAdjustCommandStartMarkerScheduler.schedule();\n\n\t\t// TODO: Cache details about polling for the future - eg. if it always fails, stop bothering\n\t}\n\n\tprivate _tryAdjustCommandStartMarker(start: IMarker) {\n\t\tif (this._store.isDisposed) {\n\t\t\treturn;\n\t\t}\n\t\tconst buffer = this._terminal.buffer.active;\n\t\tlet scannedLineCount = this._tryAdjustCommandStartMarkerScannedLineCount;\n\t\twhile (scannedLineCount < AdjustCommandStartMarkerConstants.MaxCheckLineCount && start.line + scannedLineCount < buffer.baseY + this._terminal.rows) {\n\t\t\tif (this._cursorOnNextLine()) {\n\t\t\t\tconst prompt = this._getWindowsPrompt(start.line + scannedLineCount);\n\t\t\t\tif (prompt) {\n\t\t\t\t\tconst adjustedPrompt = isString(prompt) ? prompt : prompt.prompt;\n\t\t\t\t\tthis._capability.currentCommand.commandStartMarker = this._terminal.registerMarker(0)!;\n\t\t\t\t\tif (!isString(prompt) && prompt.likelySingleLine) {\n\t\t\t\t\t\tthis._logService.debug('CommandDetectionCapability#_tryAdjustCommandStartMarker adjusted promptStart', `${this._capability.currentCommand.promptStartMarker?.line} -> ${this._capability.currentCommand.commandStartMarker.line}`);\n\t\t\t\t\t\tthis._capability.currentCommand.promptStartMarker?.dispose();\n\t\t\t\t\t\tthis._capability.currentCommand.promptStartMarker = cloneMarker(this._terminal, this._capability.currentCommand.commandStartMarker);\n\t\t\t\t\t\t// Adjust the last command if it's not in the same position as the following\n\t\t\t\t\t\t// prompt start marker\n\t\t\t\t\t\tconst lastCommand = this._capability.commands.at(-1);\n\t\t\t\t\t\tif (lastCommand && this._capability.currentCommand.commandStartMarker.line !== lastCommand.endMarker?.line) {\n\t\t\t\t\t\t\tlastCommand.endMarker?.dispose();\n\t\t\t\t\t\t\tlastCommand.endMarker = cloneMarker(this._terminal, this._capability.currentCommand.commandStartMarker);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t// use the regex to set the position as it's possible input has occurred\n\t\t\t\t\tthis._capability.currentCommand.commandStartX = adjustedPrompt.length;\n\t\t\t\t\tthis._logService.debug('CommandDetectionCapability#_tryAdjustCommandStartMarker adjusted commandStart', `${start.line} -> ${this._capability.currentCommand.commandStartMarker.line}:${this._capability.currentCommand.commandStartX}`);\n\t\t\t\t\tthis._flushPendingHandleCommandStartTask();\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tscannedLineCount++;\n\t\t}\n\t\tif (scannedLineCount < AdjustCommandStartMarkerConstants.MaxCheckLineCount) {\n\t\t\tthis._tryAdjustCommandStartMarkerScannedLineCount = scannedLineCount;\n\t\t\tif (++this._tryAdjustCommandStartMarkerPollCount < AdjustCommandStartMarkerConstants.MaximumPollCount) {\n\t\t\t\tthis._tryAdjustCommandStartMarkerScheduler?.schedule();\n\t\t\t} else {\n\t\t\t\tthis._flushPendingHandleCommandStartTask();\n\t\t\t}\n\t\t} else {\n\t\t\tthis._flushPendingHandleCommandStartTask();\n\t\t}\n\t}\n\n\tprivate _flushPendingHandleCommandStartTask() {\n\t\t// Perform final try adjust if necessary\n\t\tif (this._tryAdjustCommandStartMarkerScheduler) {\n\t\t\t// Max out poll count to ensure it's the last run\n\t\t\tthis._tryAdjustCommandStartMarkerPollCount = AdjustCommandStartMarkerConstants.MaximumPollCount;\n\t\t\tthis._tryAdjustCommandStartMarkerScheduler.flush();\n\t\t\tthis._tryAdjustCommandStartMarkerScheduler = undefined;\n\t\t}\n\n\t\tif (!this._capability.currentCommand.commandExecutedMarker) {\n\t\t\tthis._onCursorMoveListener.value = this._terminal.onCursorMove(() => {\n\t\t\t\tif (this._hooks.commandMarkers.length === 0 || this._hooks.commandMarkers[this._hooks.commandMarkers.length - 1].line !== this._terminal.buffer.active.cursorY) {\n\t\t\t\t\tconst marker = this._terminal.registerMarker(0);\n\t\t\t\t\tif (marker) {\n\t\t\t\t\t\tthis._hooks.commandMarkers.push(marker);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}\n\n\t\tif (this._capability.currentCommand.commandStartMarker) {\n\t\t\tconst line = this._terminal.buffer.active.getLine(this._capability.currentCommand.commandStartMarker.line);\n\t\t\tif (line) {\n\t\t\t\tthis._capability.currentCommand.commandStartLineContent = line.translateToString(true);\n\t\t\t}\n\t\t}\n\t\t// eslint-disable-next-line local/code-no-dangerous-type-assertions\n\t\tthis._hooks.onCommandStartedEmitter.fire({ marker: this._capability.currentCommand.commandStartMarker } as ITerminalCommand);\n\t\tthis._logService.debug('CommandDetectionCapability#_handleCommandStartWindows', this._capability.currentCommand.commandStartX, this._capability.currentCommand.commandStartMarker?.line);\n\t}\n\n\thandleCommandExecuted(options: IHandleCommandOptions | undefined) {\n\t\tif (this._tryAdjustCommandStartMarkerScheduler) {\n\t\t\tthis._flushPendingHandleCommandStartTask();\n\t\t}\n\t\t// Use the gathered cursor move markers to correct the command start and executed markers\n\t\tthis._onCursorMoveListener.clear();\n\t\tthis._evaluateCommandMarkers();\n\t\tthis._capability.currentCommand.commandExecutedX = this._terminal.buffer.active.cursorX;\n\t\tthis._hooks.onCommandExecutedEmitter.fire(this._capability.currentCommand as ITerminalCommand);\n\t\tthis._logService.debug('CommandDetectionCapability#handleCommandExecuted', this._capability.currentCommand.commandExecutedX, this._capability.currentCommand.commandExecutedMarker?.line);\n\t}\n\n\tpreHandleCommandFinished() {\n\t\tif (this._capability.currentCommand.commandExecutedMarker) {\n\t\t\treturn;\n\t\t}\n\t\t// This is done on command finished just in case command executed never happens (for example\n\t\t// PSReadLine tab completion)\n\t\tif (this._hooks.commandMarkers.length === 0) {\n\t\t\t// If the command start timeout doesn't happen before command finished, just use the\n\t\t\t// current marker.\n\t\t\tif (!this._capability.currentCommand.commandStartMarker) {\n\t\t\t\tthis._capability.currentCommand.commandStartMarker = this._terminal.registerMarker(0);\n\t\t\t}\n\t\t\tif (this._capability.currentCommand.commandStartMarker) {\n\t\t\t\tthis._hooks.commandMarkers.push(this._capability.currentCommand.commandStartMarker);\n\t\t\t}\n\t\t}\n\t\tthis._evaluateCommandMarkers();\n\t}\n\n\tpostHandleCommandFinished(): void {\n\t\tconst currentCommand = this._capability.currentCommand;\n\t\tconst commandText = currentCommand.command;\n\t\tconst commandLine = currentCommand.commandStartMarker?.line;\n\t\tconst executedLine = currentCommand.commandExecutedMarker?.line;\n\t\tif (\n\t\t\t!commandText || commandText.length === 0 ||\n\t\t\tcommandLine === undefined || commandLine === -1 ||\n\t\t\texecutedLine === undefined || executedLine === -1\n\t\t) {\n\t\t\treturn;\n\t\t}\n\n\t\t// Scan downwards from the command start line and search for every character in the actual\n\t\t// command line. This may end up matching the wrong characters, but it shouldn't matter at\n\t\t// least in the typical case as the entire command will still get matched.\n\t\tlet current = 0;\n\t\tlet found = false;\n\t\tfor (let i = commandLine; i <= executedLine; i++) {\n\t\t\tconst line = this._terminal.buffer.active.getLine(i);\n\t\t\tif (!line) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tconst text = line.translateToString(true);\n\t\t\tfor (let j = 0; j < text.length; j++) {\n\t\t\t\t// Skip whitespace in case it was not actually rendered or could be trimmed from the\n\t\t\t\t// end of the line\n\t\t\t\twhile (commandText.length < current && commandText[current] === ' ') {\n\t\t\t\t\tcurrent++;\n\t\t\t\t}\n\n\t\t\t\t// Character match\n\t\t\t\tif (text[j] === commandText[current]) {\n\t\t\t\t\tcurrent++;\n\t\t\t\t}\n\n\t\t\t\t// Full command match\n\t\t\t\tif (current === commandText.length) {\n\t\t\t\t\t// It's ambiguous whether the command executed marker should ideally appear at\n\t\t\t\t\t// the end of the line or at the beginning of the next line. Since it's more\n\t\t\t\t\t// useful for extracting the command at the end of the current line we go with\n\t\t\t\t\t// that.\n\t\t\t\t\tconst wrapsToNextLine = j >= this._terminal.cols - 1;\n\t\t\t\t\tcurrentCommand.commandExecutedMarker = this._terminal.registerMarker(i - (this._terminal.buffer.active.baseY + this._terminal.buffer.active.cursorY) + (wrapsToNextLine ? 1 : 0));\n\t\t\t\t\tcurrentCommand.commandExecutedX = wrapsToNextLine ? 0 : j + 1;\n\t\t\t\t\tfound = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (found) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _evaluateCommandMarkers(): void {\n\t\t// On Windows, use the gathered cursor move markers to correct the command start and\n\t\t// executed markers.\n\t\tif (this._hooks.commandMarkers.length === 0) {\n\t\t\treturn;\n\t\t}\n\t\tthis._hooks.commandMarkers = this._hooks.commandMarkers.sort((a, b) => a.line - b.line);\n\t\tthis._capability.currentCommand.commandStartMarker = this._hooks.commandMarkers[0];\n\t\tif (this._capability.currentCommand.commandStartMarker) {\n\t\t\tconst line = this._terminal.buffer.active.getLine(this._capability.currentCommand.commandStartMarker.line);\n\t\t\tif (line) {\n\t\t\t\tthis._capability.currentCommand.commandStartLineContent = line.translateToString(true);\n\t\t\t}\n\t\t}\n\t\tthis._capability.currentCommand.commandExecutedMarker = this._hooks.commandMarkers[this._hooks.commandMarkers.length - 1];\n\t\t// Fire this now to prevent issues like #197409\n\t\tthis._hooks.onCommandExecutedEmitter.fire(this._capability.currentCommand as ITerminalCommand);\n\t}\n\n\tprivate _cursorOnNextLine(): boolean {\n\t\tconst lastCommand = this._capability.commands.at(-1);\n\n\t\t// There is only a single command, so this check is unnecessary\n\t\tif (!lastCommand) {\n\t\t\treturn true;\n\t\t}\n\n\t\tconst cursorYAbsolute = this._terminal.buffer.active.baseY + this._terminal.buffer.active.cursorY;\n\t\t// If the cursor position is within the last command, we should poll.\n\t\tconst lastCommandYAbsolute = (lastCommand.endMarker ? lastCommand.endMarker.line : lastCommand.marker?.line) ?? -1;\n\t\treturn cursorYAbsolute > lastCommandYAbsolute;\n\t}\n\n\tprivate _waitForCursorMove(): Promise<void> {\n\t\tconst cursorX = this._terminal.buffer.active.cursorX;\n\t\tconst cursorY = this._terminal.buffer.active.cursorY;\n\t\tlet totalDelay = 0;\n\t\treturn new Promise<void>((resolve, reject) => {\n\t\t\tconst interval = setInterval(() => {\n\t\t\t\tif (cursorX !== this._terminal.buffer.active.cursorX || cursorY !== this._terminal.buffer.active.cursorY) {\n\t\t\t\t\tresolve();\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\ttotalDelay += 10;\n\t\t\t\tif (totalDelay > 1000) {\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\tresolve();\n\t\t\t\t}\n\t\t\t}, 10);\n\t\t});\n\t}\n\n\tprivate _getWindowsPrompt(y: number = this._terminal.buffer.active.baseY + this._terminal.buffer.active.cursorY): string | { prompt: string; likelySingleLine: true } | undefined {\n\t\tconst line = this._terminal.buffer.active.getLine(y);\n\t\tif (!line) {\n\t\t\treturn;\n\t\t}\n\t\tconst lineText = line.translateToString(true);\n\t\tif (!lineText) {\n\t\t\treturn;\n\t\t}\n\n\t\t// PowerShell\n\t\tconst pwshPrompt = lineText.match(/(?<prompt>(\\(.+\\)\\s)?(?:PS.+>\\s?))/)?.groups?.prompt;\n\t\tif (pwshPrompt) {\n\t\t\tconst adjustedPrompt = this._adjustPrompt(pwshPrompt, lineText, '>');\n\t\t\tif (adjustedPrompt) {\n\t\t\t\treturn {\n\t\t\t\t\tprompt: adjustedPrompt,\n\t\t\t\t\tlikelySingleLine: true\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\t// Custom prompts like starship end in the common \\u276f character\n\t\tconst customPrompt = lineText.match(/.*\\u276f(?=[^\\u276f]*$)/g)?.[0];\n\t\tif (customPrompt) {\n\t\t\tconst adjustedPrompt = this._adjustPrompt(customPrompt, lineText, '\\u276f');\n\t\t\tif (adjustedPrompt) {\n\t\t\t\treturn adjustedPrompt;\n\t\t\t}\n\t\t}\n\n\t\t// Bash Prompt\n\t\tconst bashPrompt = lineText.match(/^(?<prompt>\\$)/)?.groups?.prompt;\n\t\tif (bashPrompt) {\n\t\t\tconst adjustedPrompt = this._adjustPrompt(bashPrompt, lineText, '$');\n\t\t\tif (adjustedPrompt) {\n\t\t\t\treturn adjustedPrompt;\n\t\t\t}\n\t\t}\n\n\t\t// Python Prompt\n\t\tconst pythonPrompt = lineText.match(/^(?<prompt>>>> )/g)?.groups?.prompt;\n\t\tif (pythonPrompt) {\n\t\t\treturn {\n\t\t\t\tprompt: pythonPrompt,\n\t\t\t\tlikelySingleLine: true\n\t\t\t};\n\t\t}\n\n\t\t// Dynamic prompt detection\n\t\tif (this._capability.promptTerminator && (lineText === this._capability.promptTerminator || lineText.trim().endsWith(this._capability.promptTerminator))) {\n\t\t\tconst adjustedPrompt = this._adjustPrompt(lineText, lineText, this._capability.promptTerminator);\n\t\t\tif (adjustedPrompt) {\n\t\t\t\treturn adjustedPrompt;\n\t\t\t}\n\t\t}\n\n\t\t// Command Prompt\n\t\tconst cmdMatch = lineText.match(/^(?<prompt>(\\(.+\\)\\s)?(?:[A-Z]:\\\\.*>))/);\n\t\treturn cmdMatch?.groups?.prompt ? {\n\t\t\tprompt: cmdMatch.groups.prompt,\n\t\t\tlikelySingleLine: true\n\t\t} : undefined;\n\t}\n\n\tprivate _adjustPrompt(prompt: string | undefined, lineText: string, char: string): string | undefined {\n\t\tif (!prompt) {\n\t\t\treturn;\n\t\t}\n\t\t// Conpty may not 'render' the space at the end of the prompt\n\t\tif (lineText === prompt && prompt.endsWith(char)) {\n\t\t\tprompt += ' ';\n\t\t}\n\t\treturn prompt;\n\t}\n}\n\nexport function getLinesForCommand(buffer: IBuffer, command: ITerminalCommand, cols: number, outputMatcher?: ITerminalOutputMatcher): string[] | undefined {\n\tif (!outputMatcher) {\n\t\treturn undefined;\n\t}\n\tconst executedMarker = command.executedMarker;\n\tconst endMarker = command.endMarker;\n\tif (!executedMarker || !endMarker) {\n\t\treturn undefined;\n\t}\n\tconst startLine = executedMarker.line;\n\tconst endLine = endMarker.line;\n\n\tconst linesToCheck = outputMatcher.length;\n\tconst lines: string[] = [];\n\tif (outputMatcher.anchor === 'bottom') {\n\t\tfor (let i = endLine - (outputMatcher.offset || 0); i >= startLine; i--) {\n\t\t\tlet wrappedLineStart = i;\n\t\t\tconst wrappedLineEnd = i;\n\t\t\twhile (wrappedLineStart >= startLine && buffer.getLine(wrappedLineStart)?.isWrapped) {\n\t\t\t\twrappedLineStart--;\n\t\t\t}\n\t\t\ti = wrappedLineStart;\n\t\t\tlines.unshift(getXtermLineContent(buffer, wrappedLineStart, wrappedLineEnd, cols));\n\t\t\tif (lines.length > linesToCheck) {\n\t\t\t\tlines.pop();\n\t\t\t}\n\t\t}\n\t} else {\n\t\tfor (let i = startLine + (outputMatcher.offset || 0); i < endLine; i++) {\n\t\t\tconst wrappedLineStart = i;\n\t\t\tlet wrappedLineEnd = i;\n\t\t\twhile (wrappedLineEnd + 1 < endLine && buffer.getLine(wrappedLineEnd + 1)?.isWrapped) {\n\t\t\t\twrappedLineEnd++;\n\t\t\t}\n\t\t\ti = wrappedLineEnd;\n\t\t\tlines.push(getXtermLineContent(buffer, wrappedLineStart, wrappedLineEnd, cols));\n\t\t\tif (lines.length === linesToCheck) {\n\t\t\t\tlines.shift();\n\t\t\t}\n\t\t}\n\t}\n\treturn lines;\n}\n\nfunction getXtermLineContent(buffer: IBuffer, lineStart: number, lineEnd: number, cols: number): string {\n\t// Cap the maximum number of lines generated to prevent potential performance problems. This is\n\t// more of a sanity check as the wrapped line should already be trimmed down at this point.\n\tconst maxLineLength = Math.max(2048 / cols * 2);\n\tlineEnd = Math.min(lineEnd, lineStart + maxLineLength);\n\tlet content = '';\n\tfor (let i = lineStart; i <= lineEnd; i++) {\n\t\t// Make sure only 0 to cols are considered as resizing when windows mode is enabled will\n\t\t// retain buffer data outside of the terminal width as reflow is disabled.\n\t\tconst line = buffer.getLine(i);\n\t\tif (line) {\n\t\t\tcontent += line.translateToString(true, 0, cols);\n\t\t}\n\t}\n\treturn content;\n}\n\nfunction cloneMarker(xterm: Terminal, marker: IMarker, offset: number = 0): IMarker | undefined {\n\treturn xterm.registerMarker(marker.line - (xterm.buffer.active.baseY + xterm.buffer.active.cursorY) + offset);\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { ICwdDetectionCapability, TerminalCapability } from './capabilities.js';\n\nexport class CwdDetectionCapability extends Disposable implements ICwdDetectionCapability {\n\treadonly type = TerminalCapability.CwdDetection;\n\tprivate _cwd = '';\n\tprivate _cwds = new Map</*cwd*/string, /*frequency*/number>();\n\n\t/**\n\t * Gets the list of cwds seen in this session in order of last accessed.\n\t */\n\tget cwds(): string[] {\n\t\treturn Array.from(this._cwds.keys());\n\t}\n\n\tprivate readonly _onDidChangeCwd = this._register(new Emitter<string>());\n\treadonly onDidChangeCwd = this._onDidChangeCwd.event;\n\n\tgetCwd(): string {\n\t\treturn this._cwd;\n\t}\n\n\tupdateCwd(cwd: string): void {\n\t\tconst didChange = this._cwd !== cwd;\n\t\tthis._cwd = cwd;\n\t\tconst count = this._cwds.get(this._cwd) || 0;\n\t\tthis._cwds.delete(this._cwd); // Delete to put it at the bottom of the iterable\n\t\tthis._cwds.set(this._cwd, count + 1);\n\t\tif (didChange) {\n\t\t\tthis._onDidChangeCwd.fire(cwd);\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { DisposableStore } from '../../../../base/common/lifecycle.js';\nimport { IPartialCommandDetectionCapability, TerminalCapability } from './capabilities.js';\nimport type { IMarker, Terminal } from '@xterm/headless';\n\nconst enum Constants {\n\t/**\n\t * The minimum size of the prompt in which to assume the line is a command.\n\t */\n\tMinimumPromptLength = 2\n}\n\n/**\n * This capability guesses where commands are based on where the cursor was when enter was pressed.\n * It's very hit or miss but it's often correct and better than nothing.\n */\nexport class PartialCommandDetectionCapability extends DisposableStore implements IPartialCommandDetectionCapability {\n\treadonly type = TerminalCapability.PartialCommandDetection;\n\n\tprivate readonly _commands: IMarker[] = [];\n\n\tget commands(): readonly IMarker[] { return this._commands; }\n\n\tprivate readonly _onCommandFinished = this.add(new Emitter<IMarker>());\n\treadonly onCommandFinished = this._onCommandFinished.event;\n\n\tconstructor(\n\t\tprivate readonly _terminal: Terminal,\n\t\tprivate _onDidExecuteText: Event<void> | undefined\n\t) {\n\t\tsuper();\n\t\tthis.add(this._terminal.onData(e => this._onData(e)));\n\t\tthis.add(this._terminal.parser.registerCsiHandler({ final: 'J' }, params => {\n\t\t\tif (params.length >= 1 && (params[0] === 2 || params[0] === 3)) {\n\t\t\t\tthis._clearCommandsInViewport();\n\t\t\t}\n\t\t\t// We don't want to override xterm.js' default behavior, just augment it\n\t\t\treturn false;\n\t\t}));\n\t\tif (this._onDidExecuteText) {\n\t\t\tthis.add(this._onDidExecuteText(() => this._onEnter()));\n\t\t}\n\t}\n\n\tprivate _onData(data: string): void {\n\t\tif (data === '\\x0d') {\n\t\t\tthis._onEnter();\n\t\t}\n\t}\n\n\tprivate _onEnter(): void {\n\t\tif (!this._terminal) {\n\t\t\treturn;\n\t\t}\n\t\tif (this._terminal.buffer.active.cursorX >= Constants.MinimumPromptLength) {\n\t\t\tconst marker = this._terminal.registerMarker(0);\n\t\t\tif (marker) {\n\t\t\t\tthis._commands.push(marker);\n\t\t\t\tthis._onCommandFinished.fire(marker);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _clearCommandsInViewport(): void {\n\t\t// Find the number of commands on the tail end of the array that are within the viewport\n\t\tlet count = 0;\n\t\tfor (let i = this._commands.length - 1; i >= 0; i--) {\n\t\t\tif (this._commands[i].line < this._terminal.buffer.active.baseY) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tcount++;\n\t\t}\n\t\t// Remove them\n\t\tthis._commands.splice(this._commands.length - count, count);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IBufferMarkCapability, TerminalCapability, IMarkProperties } from './capabilities.js';\nimport type { IMarker, Terminal } from '@xterm/headless';\n\n/**\n * Manages \"marks\" in the buffer which are lines that are tracked when lines are added to or removed\n * from the buffer.\n */\nexport class BufferMarkCapability extends Disposable implements IBufferMarkCapability {\n\n\treadonly type = TerminalCapability.BufferMarkDetection;\n\n\tprivate _idToMarkerMap: Map<string, IMarker> = new Map();\n\tprivate _anonymousMarkers: Map<number, IMarker> = new Map();\n\n\tprivate readonly _onMarkAdded = this._register(new Emitter<IMarkProperties>());\n\treadonly onMarkAdded = this._onMarkAdded.event;\n\n\tconstructor(\n\t\tprivate readonly _terminal: Terminal\n\t) {\n\t\tsuper();\n\t}\n\n\t*markers(): IterableIterator<IMarker> {\n\t\tfor (const m of this._idToMarkerMap.values()) {\n\t\t\tyield m;\n\t\t}\n\t\tfor (const m of this._anonymousMarkers.values()) {\n\t\t\tyield m;\n\t\t}\n\t}\n\n\taddMark(properties?: IMarkProperties): void {\n\t\tconst marker = properties?.marker || this._terminal.registerMarker();\n\t\tconst id = properties?.id;\n\t\tif (!marker) {\n\t\t\treturn;\n\t\t}\n\t\tif (id) {\n\t\t\tthis._idToMarkerMap.set(id, marker);\n\t\t\tmarker.onDispose(() => this._idToMarkerMap.delete(id));\n\t\t} else {\n\t\t\tthis._anonymousMarkers.set(marker.id, marker);\n\t\t\tmarker.onDispose(() => this._anonymousMarkers.delete(marker.id));\n\t\t}\n\t\tthis._onMarkAdded.fire({ marker, id, hidden: properties?.hidden, hoverMessage: properties?.hoverMessage });\n\t}\n\n\tgetMark(id: string): IMarker | undefined {\n\t\treturn this._idToMarkerMap.get(id);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IShellEnvDetectionCapability, TerminalCapability, TerminalShellIntegrationEnvironment } from './capabilities.js';\nimport { Emitter } from '../../../../base/common/event.js';\nimport { equals } from '../../../../base/common/objects.js';\nimport { mapsStrictEqualIgnoreOrder } from '../../../../base/common/map.js';\n\nexport interface IShellEnv {\n\tvalue: Map<string, string>;\n\tisTrusted: boolean;\n}\n\nexport class ShellEnvDetectionCapability extends Disposable implements IShellEnvDetectionCapability {\n\treadonly type = TerminalCapability.ShellEnvDetection;\n\n\tprivate _pendingEnv: IShellEnv | undefined;\n\tprivate _env: IShellEnv = { value: new Map(), isTrusted: true };\n\n\tget env(): TerminalShellIntegrationEnvironment {\n\t\treturn this._createStateObject();\n\t}\n\n\tprivate readonly _onDidChangeEnv = this._register(new Emitter<TerminalShellIntegrationEnvironment>());\n\treadonly onDidChangeEnv = this._onDidChangeEnv.event;\n\n\tsetEnvironment(env: { [key: string]: string | undefined }, isTrusted: boolean): void {\n\t\tif (equals(this.env.value, env)) {\n\t\t\treturn;\n\t\t}\n\n\t\tthis._env.value.clear();\n\t\tfor (const [key, value] of Object.entries(env)) {\n\t\t\tif (value !== undefined) {\n\t\t\t\tthis._env.value.set(key, value);\n\t\t\t}\n\t\t}\n\t\tthis._env.isTrusted = isTrusted;\n\n\t\tthis._fireEnvChange();\n\t}\n\n\tstartEnvironmentSingleVar(clear: boolean, isTrusted: boolean): void {\n\t\tif (clear) {\n\t\t\tthis._pendingEnv = {\n\t\t\t\tvalue: new Map(),\n\t\t\t\tisTrusted\n\t\t\t};\n\t\t} else {\n\t\t\tthis._pendingEnv = {\n\t\t\t\tvalue: new Map(this._env.value),\n\t\t\t\tisTrusted: this._env.isTrusted && isTrusted\n\t\t\t};\n\t\t}\n\n\t}\n\n\tsetEnvironmentSingleVar(key: string, value: string | undefined, isTrusted: boolean): void {\n\t\tif (!this._pendingEnv) {\n\t\t\treturn;\n\t\t}\n\t\tif (key !== undefined && value !== undefined) {\n\t\t\tthis._pendingEnv.value.set(key, value);\n\t\t\tthis._pendingEnv.isTrusted &&= isTrusted;\n\t\t}\n\t}\n\n\tendEnvironmentSingleVar(isTrusted: boolean): void {\n\t\tif (!this._pendingEnv) {\n\t\t\treturn;\n\t\t}\n\t\tthis._pendingEnv.isTrusted &&= isTrusted;\n\t\tconst envDiffers = !mapsStrictEqualIgnoreOrder(this._env.value, this._pendingEnv.value);\n\t\tif (envDiffers) {\n\t\t\tthis._env = this._pendingEnv;\n\t\t\tthis._fireEnvChange();\n\t\t}\n\t\tthis._pendingEnv = undefined;\n\t}\n\n\tdeleteEnvironmentSingleVar(key: string, value: string | undefined, isTrusted: boolean): void {\n\t\tif (!this._pendingEnv) {\n\t\t\treturn;\n\t\t}\n\t\tif (key !== undefined && value !== undefined) {\n\t\t\tthis._pendingEnv.value.delete(key);\n\t\t\tthis._pendingEnv.isTrusted &&= isTrusted;\n\t\t}\n\t}\n\n\tprivate _fireEnvChange(): void {\n\t\tthis._onDidChangeEnv.fire(this._createStateObject());\n\t}\n\n\tprivate _createStateObject(): TerminalShellIntegrationEnvironment {\n\t\treturn {\n\t\t\tvalue: Object.fromEntries(this._env.value),\n\t\t\tisTrusted: this._env.isTrusted\n\t\t};\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { Emitter } from '../../../../base/common/event.js';\nimport { Disposable } from '../../../../base/common/lifecycle.js';\nimport { IPromptTypeDetectionCapability, TerminalCapability } from './capabilities.js';\n\nexport class PromptTypeDetectionCapability extends Disposable implements IPromptTypeDetectionCapability {\n\treadonly type = TerminalCapability.PromptTypeDetection;\n\n\tprivate _promptType: string | undefined;\n\tget promptType(): string | undefined { return this._promptType; }\n\n\tprivate readonly _onPromptTypeChanged = this._register(new Emitter<string | undefined>());\n\treadonly onPromptTypeChanged = this._onPromptTypeChanged.event;\n\n\tsetPromptType(value: string): void {\n\t\tthis._promptType = value;\n\t\tthis._onPromptTypeChanged.fire(value);\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { IShellIntegration, ShellIntegrationStatus } from '../terminal.js';\nimport { Disposable, dispose, IDisposable, toDisposable } from '../../../../base/common/lifecycle.js';\nimport { TerminalCapabilityStore } from '../capabilities/terminalCapabilityStore.js';\nimport { CommandDetectionCapability } from '../capabilities/commandDetectionCapability.js';\nimport { CwdDetectionCapability } from '../capabilities/cwdDetectionCapability.js';\nimport { IBufferMarkCapability, ICommandDetectionCapability, ICwdDetectionCapability, IPromptTypeDetectionCapability, ISerializedCommandDetectionCapability, IShellEnvDetectionCapability, TerminalCapability } from '../capabilities/capabilities.js';\nimport { PartialCommandDetectionCapability } from '../capabilities/partialCommandDetectionCapability.js';\nimport { ILogService } from '../../../log/common/log.js';\nimport { ITelemetryService } from '../../../telemetry/common/telemetry.js';\nimport { Emitter, Event } from '../../../../base/common/event.js';\nimport { BufferMarkCapability } from '../capabilities/bufferMarkCapability.js';\nimport type { ITerminalAddon, Terminal } from '@xterm/headless';\nimport { URI } from '../../../../base/common/uri.js';\nimport { sanitizeCwd } from '../terminalEnvironment.js';\nimport { removeAnsiEscapeCodesFromPrompt } from '../../../../base/common/strings.js';\nimport { ShellEnvDetectionCapability } from '../capabilities/shellEnvDetectionCapability.js';\nimport { PromptTypeDetectionCapability } from '../capabilities/promptTypeDetectionCapability.js';\n\n\n/**\n * Shell integration is a feature that enhances the terminal's understanding of what's happening\n * in the shell by injecting special sequences into the shell's prompt using the \"Set Text\n * Parameters\" sequence (`OSC Ps ; Pt ST`).\n *\n * Definitions:\n * - OSC: `\\x1b]`\n * - Ps:  A single (usually optional) numeric parameter, composed of one or more digits.\n * - Pt:  A text parameter composed of printable characters.\n * - ST: `\\x7`\n *\n * This is inspired by a feature of the same name in the FinalTerm, iTerm2 and kitty terminals.\n */\n\n/**\n * The identifier for the first numeric parameter (`Ps`) for OSC commands used by shell integration.\n */\nexport const enum ShellIntegrationOscPs {\n\t/**\n\t * Sequences pioneered by FinalTerm.\n\t */\n\tFinalTerm = 133,\n\t/**\n\t * Sequences pioneered by VS Code. The number is derived from the least significant digit of\n\t * \"VSC\" when encoded in hex (\"VSC\" = 0x56, 0x53, 0x43).\n\t */\n\tVSCode = 633,\n\t/**\n\t * Sequences pioneered by iTerm.\n\t */\n\tITerm = 1337,\n\tSetCwd = 7,\n\tSetWindowsFriendlyCwd = 9\n}\n\n/**\n * Sequences pioneered by FinalTerm.\n */\nconst enum FinalTermOscPt {\n\t/**\n\t * The start of the prompt, this is expected to always appear at the start of a line.\n\t *\n\t * Format: `OSC 133 ; A ST`\n\t */\n\tPromptStart = 'A',\n\n\t/**\n\t * The start of a command, ie. where the user inputs their command.\n\t *\n\t * Format: `OSC 133 ; B ST`\n\t */\n\tCommandStart = 'B',\n\n\t/**\n\t * Sent just before the command output begins.\n\t *\n\t * Format: `OSC 133 ; C ST`\n\t */\n\tCommandExecuted = 'C',\n\n\t/**\n\t * Sent just after a command has finished. The exit code is optional, when not specified it\n\t * means no command was run (ie. enter on empty prompt or ctrl+c).\n\t *\n\t * Format: `OSC 133 ; D [; <ExitCode>] ST`\n\t */\n\tCommandFinished = 'D',\n}\n\n/**\n * VS Code-specific shell integration sequences. Some of these are based on more common alternatives\n * like those pioneered in {@link FinalTermOscPt FinalTerm}. The decision to move to entirely custom\n * sequences was to try to improve reliability and prevent the possibility of applications confusing\n * the terminal. If multiple shell integration scripts run, VS Code will prioritize the VS\n * Code-specific ones.\n *\n * It's recommended that authors of shell integration scripts use the common sequences (`133`)\n * when building general purpose scripts and the VS Code-specific (`633`) when targeting only VS\n * Code or when there are no other alternatives (eg. {@link CommandLine `633 ; E`}). These sequences\n * support mix-and-matching.\n */\nconst enum VSCodeOscPt {\n\t/**\n\t * The start of the prompt, this is expected to always appear at the start of a line.\n\t *\n\t * Format: `OSC 633 ; A ST`\n\t *\n\t * Based on {@link FinalTermOscPt.PromptStart}.\n\t */\n\tPromptStart = 'A',\n\n\t/**\n\t * The start of a command, ie. where the user inputs their command.\n\t *\n\t * Format: `OSC 633 ; B ST`\n\t *\n\t * Based on  {@link FinalTermOscPt.CommandStart}.\n\t */\n\tCommandStart = 'B',\n\n\t/**\n\t * Sent just before the command output begins.\n\t *\n\t * Format: `OSC 633 ; C ST`\n\t *\n\t * Based on {@link FinalTermOscPt.CommandExecuted}.\n\t */\n\tCommandExecuted = 'C',\n\n\t/**\n\t * Sent just after a command has finished. This should generally be used on the new line\n\t * following the end of a command's output, just before {@link PromptStart}. The exit code is\n\t * optional, when not specified it means no command was run (ie. enter on empty prompt or\n\t * ctrl+c).\n\t *\n\t * Format: `OSC 633 ; D [; <ExitCode>] ST`\n\t *\n\t * Based on {@link FinalTermOscPt.CommandFinished}.\n\t */\n\tCommandFinished = 'D',\n\n\t/**\n\t * Explicitly set the command line. This helps workaround performance and reliability problems\n\t * with parsing out the command, such as conpty not guaranteeing the position of the sequence or\n\t * the shell not guaranteeing that the entire command is even visible. Ideally this is called\n\t * immediately before {@link CommandExecuted}, immediately before {@link CommandFinished} will\n\t * also work but that means terminal will only know the accurate command line when the command is\n\t * finished.\n\t *\n\t * The command line can escape ascii characters using the `\\xAB` format, where AB are the\n\t * hexadecimal representation of the character code (case insensitive), and escape the `\\`\n\t * character using `\\\\`. It's required to escape semi-colon (`0x3b`) and characters 0x20 and\n\t * below, this is particularly important for new line and semi-colon.\n\t *\n\t * Some examples:\n\t *\n\t * ```\n\t * \"\\\"  -> \"\\\\\"\n\t * \"\\n\" -> \"\\x0a\"\n\t * \";\"  -> \"\\x3b\"\n\t * ```\n\t *\n\t * An optional nonce can be provided which is may be required by the terminal in order enable\n\t * some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * Format: `OSC 633 ; E [; <CommandLine> [; <Nonce>]] ST`\n\t */\n\tCommandLine = 'E',\n\n\t/**\n\t * Similar to prompt start but for line continuations.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tContinuationStart = 'F',\n\n\t/**\n\t * Similar to command start but for line continuations.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tContinuationEnd = 'G',\n\n\t/**\n\t * The start of the right prompt.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tRightPromptStart = 'H',\n\n\t/**\n\t * The end of the right prompt.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tRightPromptEnd = 'I',\n\n\t/**\n\t * Set the value of an arbitrary property, only known properties will be handled by VS Code.\n\t *\n\t * Format: `OSC 633 ; P ; <Property>=<Value> ST`\n\t *\n\t * Known properties:\n\t *\n\t * - `Cwd` - Reports the current working directory to the terminal.\n\t * - `IsWindows` - Reports whether the shell is using a Windows backend like winpty or conpty.\n\t *   This may be used to enable additional heuristics as the positioning of the shell\n\t *   integration sequences are not guaranteed to be correct. Valid values: `True`, `False`.\n\t * - `ContinuationPrompt` - Reports the continuation prompt that is printed at the start of\n\t *   multi-line inputs.\n\t * - `HasRichCommandDetection` - Reports whether the shell has rich command line detection,\n\t *   meaning that sequences A, B, C, D and E are exactly where they're meant to be. In\n\t *   particular, {@link CommandLine} must happen immediately before {@link CommandExecuted} so\n\t *   VS Code knows the command line when the execution begins.\n\t *\n\t * WARNING: Any other properties may be changed and are not guaranteed to work in the future.\n\t */\n\tProperty = 'P',\n\n\t/**\n\t * Sets a mark/point-of-interest in the buffer.\n\t *\n\t * Format: `OSC 633 ; SetMark [; Id=<string>] [; Hidden]`\n\t *\n\t * `Id` - The identifier of the mark that can be used to reference it\n\t * `Hidden` - When set, the mark will be available to reference internally but will not visible\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tSetMark = 'SetMark',\n\n\t/**\n\t * Sends the shell's complete environment in JSON format.\n\t *\n\t * Format: `OSC 633 ; EnvJson ; <Environment> ; <Nonce>`\n\t *\n\t * - `Environment` - A stringified JSON object containing the shell's complete environment. The\n\t *    variables and values use the same encoding rules as the {@link CommandLine} sequence.\n\t * - `Nonce` - An _mandatory_ nonce can be provided which may be required by the terminal in order\n\t *   to enable some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tEnvJson = 'EnvJson',\n\n\t/**\n\t * Delete a single environment variable from cached environment.\n\t *\n\t * Format: `OSC 633 ; EnvSingleDelete ; <EnvironmentKey> ; <EnvironmentValue> [; <Nonce>]`\n\t *\n\t * - `Nonce` - An optional nonce can be provided which may be required by the terminal in order\n\t *   to enable some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tEnvSingleDelete = 'EnvSingleDelete',\n\n\t/**\n\t * The start of the collecting user's environment variables individually.\n\t *\n\t * Format: `OSC 633 ; EnvSingleStart ; <Clear> [; <Nonce>]`\n\t *\n\t * - `Clear` - An _mandatory_ flag indicating any cached environment variables will be cleared.\n\t * - `Nonce` - An optional nonce can be provided which may be required by the terminal in order\n\t *   to enable some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tEnvSingleStart = 'EnvSingleStart',\n\n\t/**\n\t * Sets an entry of single environment variable to transactional pending map of environment variables.\n\t *\n\t * Format: `OSC 633 ; EnvSingleEntry ; <EnvironmentKey> ; <EnvironmentValue> [; <Nonce>]`\n\t *\n\t * - `Nonce` - An optional nonce can be provided which may be required by the terminal in order\n\t *   to enable some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tEnvSingleEntry = 'EnvSingleEntry',\n\n\t/**\n\t * The end of the collecting user's environment variables individually.\n\t * Clears any pending environment variables and fires an event that contains user's environment.\n\t *\n\t * Format: `OSC 633 ; EnvSingleEnd [; <Nonce>]`\n\t *\n\t * - `Nonce` - An optional nonce can be provided which may be required by the terminal in order\n\t *   to enable some features. This helps ensure no malicious command injection has occurred.\n\t *\n\t * WARNING: This sequence is unfinalized, DO NOT use this in your shell integration script.\n\t */\n\tEnvSingleEnd = 'EnvSingleEnd'\n}\n\n/**\n * ITerm sequences\n */\nconst enum ITermOscPt {\n\t/**\n\t * Sets a mark/point-of-interest in the buffer.\n\t *\n\t * Format: `OSC 1337 ; SetMark`\n\t */\n\tSetMark = 'SetMark',\n\n\t/**\n\t * Reports current working directory (CWD).\n\t *\n\t * Format: `OSC 1337 ; CurrentDir=<Cwd> ST`\n\t */\n\tCurrentDir = 'CurrentDir'\n}\n\n/**\n * The shell integration addon extends xterm by reading shell integration sequences and creating\n * capabilities and passing along relevant sequences to the capabilities. This is meant to\n * encapsulate all handling/parsing of sequences so the capabilities don't need to.\n */\nexport class ShellIntegrationAddon extends Disposable implements IShellIntegration, ITerminalAddon {\n\tprivate _terminal?: Terminal;\n\treadonly capabilities = this._register(new TerminalCapabilityStore());\n\tprivate _hasUpdatedTelemetry: boolean = false;\n\tprivate _activationTimeout: Timeout | undefined;\n\tprivate _commonProtocolDisposables: IDisposable[] = [];\n\n\tprivate _seenSequences: Set<string> = new Set();\n\tget seenSequences(): ReadonlySet<string> { return this._seenSequences; }\n\n\tprivate _status: ShellIntegrationStatus = ShellIntegrationStatus.Off;\n\tget status(): ShellIntegrationStatus { return this._status; }\n\n\tprivate readonly _onDidChangeStatus = new Emitter<ShellIntegrationStatus>();\n\treadonly onDidChangeStatus = this._onDidChangeStatus.event;\n\tprivate readonly _onDidChangeSeenSequences = new Emitter<ReadonlySet<string>>();\n\treadonly onDidChangeSeenSequences = this._onDidChangeSeenSequences.event;\n\n\tconstructor(\n\t\tprivate _nonce: string,\n\t\tprivate readonly _disableTelemetry: boolean | undefined,\n\t\tprivate _onDidExecuteText: Event<void> | undefined,\n\t\tprivate readonly _telemetryService: ITelemetryService | undefined,\n\t\tprivate readonly _logService: ILogService\n\t) {\n\t\tsuper();\n\t\tthis._register(toDisposable(() => {\n\t\t\tthis._clearActivationTimeout();\n\t\t\tthis._disposeCommonProtocol();\n\t\t}));\n\t}\n\n\tprivate _disposeCommonProtocol(): void {\n\t\tdispose(this._commonProtocolDisposables);\n\t\tthis._commonProtocolDisposables.length = 0;\n\t}\n\n\tactivate(xterm: Terminal) {\n\t\tthis._terminal = xterm;\n\t\tthis.capabilities.add(TerminalCapability.PartialCommandDetection, this._register(new PartialCommandDetectionCapability(this._terminal, this._onDidExecuteText)));\n\t\tthis._register(xterm.parser.registerOscHandler(ShellIntegrationOscPs.VSCode, data => this._handleVSCodeSequence(data)));\n\t\tthis._register(xterm.parser.registerOscHandler(ShellIntegrationOscPs.ITerm, data => this._doHandleITermSequence(data)));\n\t\tthis._commonProtocolDisposables.push(\n\t\t\txterm.parser.registerOscHandler(ShellIntegrationOscPs.FinalTerm, data => this._handleFinalTermSequence(data))\n\t\t);\n\t\tthis._register(xterm.parser.registerOscHandler(ShellIntegrationOscPs.SetCwd, data => this._doHandleSetCwd(data)));\n\t\tthis._register(xterm.parser.registerOscHandler(ShellIntegrationOscPs.SetWindowsFriendlyCwd, data => this._doHandleSetWindowsFriendlyCwd(data)));\n\t\tthis._ensureCapabilitiesOrAddFailureTelemetry();\n\t}\n\n\tgetMarkerId(terminal: Terminal, vscodeMarkerId: string) {\n\t\tthis._createOrGetBufferMarkDetection(terminal).getMark(vscodeMarkerId);\n\t}\n\n\tsetNextCommandId(command: string, commandId: string): void {\n\t\tif (this._terminal) {\n\t\t\tthis._createOrGetCommandDetection(this._terminal).setNextCommandId(command, commandId);\n\t\t}\n\t}\n\n\tprivate _markSequenceSeen(sequence: string) {\n\t\tif (!this._seenSequences.has(sequence)) {\n\t\t\tthis._seenSequences.add(sequence);\n\t\t\tthis._onDidChangeSeenSequences.fire(this._seenSequences);\n\t\t}\n\t}\n\n\tprivate _handleFinalTermSequence(data: string): boolean {\n\t\tconst didHandle = this._doHandleFinalTermSequence(data);\n\t\tif (this._status === ShellIntegrationStatus.Off) {\n\t\t\tthis._status = ShellIntegrationStatus.FinalTerm;\n\t\t\tthis._onDidChangeStatus.fire(this._status);\n\t\t}\n\t\treturn didHandle;\n\t}\n\n\tprivate _doHandleFinalTermSequence(data: string): boolean {\n\t\tif (!this._terminal) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Pass the sequence along to the capability\n\t\t// It was considered to disable the common protocol in order to not confuse the VS Code\n\t\t// shell integration if both happen for some reason. This doesn't work for powerlevel10k\n\t\t// when instant prompt is enabled though. If this does end up being a problem we could pass\n\t\t// a type flag through the capability calls\n\t\tconst [command, ...args] = data.split(';');\n\t\tthis._markSequenceSeen(command);\n\t\tswitch (command) {\n\t\t\tcase FinalTermOscPt.PromptStart:\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handlePromptStart();\n\t\t\t\treturn true;\n\t\t\tcase FinalTermOscPt.CommandStart:\n\t\t\t\t// Ignore the command line for these sequences as it's unreliable for example in powerlevel10k\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandStart({ ignoreCommandLine: true });\n\t\t\t\treturn true;\n\t\t\tcase FinalTermOscPt.CommandExecuted:\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandExecuted();\n\t\t\t\treturn true;\n\t\t\tcase FinalTermOscPt.CommandFinished: {\n\t\t\t\tconst exitCode = args.length === 1 ? parseInt(args[0]) : undefined;\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandFinished(exitCode);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\tprivate _handleVSCodeSequence(data: string): boolean {\n\t\tconst didHandle = this._doHandleVSCodeSequence(data);\n\t\tif (!this._hasUpdatedTelemetry && didHandle) {\n\t\t\tthis._telemetryService?.publicLog2<{}, { owner: 'meganrogge'; comment: 'Indicates shell integration was activated' }>('terminal/shellIntegrationActivationSucceeded');\n\t\t\tthis._hasUpdatedTelemetry = true;\n\t\t\tthis._clearActivationTimeout();\n\t\t}\n\t\tif (this._status !== ShellIntegrationStatus.VSCode) {\n\t\t\tthis._status = ShellIntegrationStatus.VSCode;\n\t\t\tthis._onDidChangeStatus.fire(this._status);\n\t\t}\n\t\treturn didHandle;\n\t}\n\n\tprivate async _ensureCapabilitiesOrAddFailureTelemetry(): Promise<void> {\n\t\tif (!this._telemetryService || this._disableTelemetry) {\n\t\t\treturn;\n\t\t}\n\t\tthis._activationTimeout = setTimeout(() => {\n\t\t\tif (!this.capabilities.get(TerminalCapability.CommandDetection) && !this.capabilities.get(TerminalCapability.CwdDetection)) {\n\t\t\t\tthis._telemetryService?.publicLog2<{}, { owner: 'meganrogge'; comment: 'Indicates shell integration activation timeout' }>('terminal/shellIntegrationActivationTimeout');\n\t\t\t\tthis._logService.warn('Shell integration failed to add capabilities within 10 seconds');\n\t\t\t}\n\t\t\tthis._hasUpdatedTelemetry = true;\n\t\t}, 10000);\n\t}\n\n\tprivate _clearActivationTimeout(): void {\n\t\tif (this._activationTimeout !== undefined) {\n\t\t\tclearTimeout(this._activationTimeout);\n\t\t\tthis._activationTimeout = undefined;\n\t\t}\n\t}\n\n\tprivate _doHandleVSCodeSequence(data: string): boolean {\n\t\tif (!this._terminal) {\n\t\t\treturn false;\n\t\t}\n\n\t\t// Pass the sequence along to the capability\n\t\tconst argsIndex = data.indexOf(';');\n\t\tconst command = argsIndex === -1 ? data : data.substring(0, argsIndex);\n\t\tthis._markSequenceSeen(command);\n\t\t// Cast to strict checked index access\n\t\tconst args: (string | undefined)[] = argsIndex === -1 ? [] : data.substring(argsIndex + 1).split(';');\n\t\tswitch (command) {\n\t\t\tcase VSCodeOscPt.PromptStart:\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handlePromptStart();\n\t\t\t\treturn true;\n\t\t\tcase VSCodeOscPt.CommandStart:\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandStart();\n\t\t\t\treturn true;\n\t\t\tcase VSCodeOscPt.CommandExecuted:\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandExecuted();\n\t\t\t\treturn true;\n\t\t\tcase VSCodeOscPt.CommandFinished: {\n\t\t\t\tconst arg0 = args[0];\n\t\t\t\tconst exitCode = arg0 !== undefined ? parseInt(arg0) : undefined;\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleCommandFinished(exitCode);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.CommandLine: {\n\t\t\t\tconst arg0 = args[0];\n\t\t\t\tconst arg1 = args[1];\n\t\t\t\tlet commandLine: string;\n\t\t\t\tif (arg0 !== undefined) {\n\t\t\t\t\tcommandLine = deserializeVSCodeOscMessage(arg0);\n\t\t\t\t} else {\n\t\t\t\t\tcommandLine = '';\n\t\t\t\t}\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).setCommandLine(commandLine, arg1 === this._nonce);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.ContinuationStart: {\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleContinuationStart();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.ContinuationEnd: {\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleContinuationEnd();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.EnvJson: {\n\t\t\t\tconst arg0 = args[0];\n\t\t\t\tconst arg1 = args[1];\n\t\t\t\tif (arg0 !== undefined) {\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst env = JSON.parse(deserializeVSCodeOscMessage(arg0));\n\t\t\t\t\t\tthis._createOrGetShellEnvDetection().setEnvironment(env, arg1 === this._nonce);\n\t\t\t\t\t} catch (e) {\n\t\t\t\t\t\tthis._logService.warn('Failed to parse environment from shell integration sequence', arg0);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.EnvSingleStart: {\n\t\t\t\tthis._createOrGetShellEnvDetection().startEnvironmentSingleVar(args[0] === '1', args[1] === this._nonce);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.EnvSingleDelete: {\n\t\t\t\tconst arg0 = args[0];\n\n\t\t\t\tconst arg1 = args[1];\n\t\t\t\tconst arg2 = args[2];\n\t\t\t\tif (arg0 !== undefined && arg1 !== undefined) {\n\t\t\t\t\tconst env = deserializeVSCodeOscMessage(arg1);\n\t\t\t\t\tthis._createOrGetShellEnvDetection().deleteEnvironmentSingleVar(arg0, env, arg2 === this._nonce);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.EnvSingleEntry: {\n\t\t\t\tconst arg0 = args[0];\n\t\t\t\tconst arg1 = args[1];\n\t\t\t\tconst arg2 = args[2];\n\t\t\t\tif (arg0 !== undefined && arg1 !== undefined) {\n\t\t\t\t\tconst env = deserializeVSCodeOscMessage(arg1);\n\t\t\t\t\tthis._createOrGetShellEnvDetection().setEnvironmentSingleVar(arg0, env, arg2 === this._nonce);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.EnvSingleEnd: {\n\t\t\t\tthis._createOrGetShellEnvDetection().endEnvironmentSingleVar(args[0] === this._nonce);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.RightPromptStart: {\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleRightPromptStart();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.RightPromptEnd: {\n\t\t\t\tthis._createOrGetCommandDetection(this._terminal).handleRightPromptEnd();\n\t\t\t\treturn true;\n\t\t\t}\n\t\t\tcase VSCodeOscPt.Property: {\n\t\t\t\tconst arg0 = args[0];\n\t\t\t\tconst deserialized = arg0 !== undefined ? deserializeVSCodeOscMessage(arg0) : '';\n\t\t\t\tconst { key, value } = parseKeyValueAssignment(deserialized);\n\t\t\t\tif (value === undefined) {\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\tswitch (key) {\n\t\t\t\t\tcase 'ContinuationPrompt': {\n\t\t\t\t\t\tthis._updateContinuationPrompt(removeAnsiEscapeCodesFromPrompt(value));\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'Cwd': {\n\t\t\t\t\t\tthis._updateCwd(value);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'IsWindows': {\n\t\t\t\t\t\tthis._createOrGetCommandDetection(this._terminal).setIsWindowsPty(value === 'True' ? true : false);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'HasRichCommandDetection': {\n\t\t\t\t\t\tthis._createOrGetCommandDetection(this._terminal).setHasRichCommandDetection(value === 'True' ? true : false);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'Prompt': {\n\t\t\t\t\t\t// Remove escape sequences from the user's prompt\n\t\t\t\t\t\tconst sanitizedValue = value.replace(/\\x1b\\[[0-9;]*m/g, '');\n\t\t\t\t\t\tthis._updatePromptTerminator(sanitizedValue);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'PromptType': {\n\t\t\t\t\t\tthis._createOrGetPromptTypeDetection().setPromptType(value);\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t\tcase 'Task': {\n\t\t\t\t\t\tthis._createOrGetBufferMarkDetection(this._terminal);\n\t\t\t\t\t\tthis.capabilities.get(TerminalCapability.CommandDetection)?.setIsCommandStorageDisabled();\n\t\t\t\t\t\treturn true;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tcase VSCodeOscPt.SetMark: {\n\t\t\t\tthis._createOrGetBufferMarkDetection(this._terminal).addMark(parseMarkSequence(args));\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// Unrecognized sequence\n\t\treturn false;\n\t}\n\n\tprivate _updateContinuationPrompt(value: string) {\n\t\tif (!this._terminal) {\n\t\t\treturn;\n\t\t}\n\t\tthis._createOrGetCommandDetection(this._terminal).setContinuationPrompt(value);\n\t}\n\n\tprivate _updatePromptTerminator(prompt: string) {\n\t\tif (!this._terminal) {\n\t\t\treturn;\n\t\t}\n\t\tconst lastPromptLine = prompt.substring(prompt.lastIndexOf('\\n') + 1);\n\t\tconst lastPromptLineTrimmed = lastPromptLine.trim();\n\t\tconst promptTerminator = (\n\t\t\tlastPromptLineTrimmed.length === 1\n\t\t\t\t// The prompt line contains a single character, treat the full line as the\n\t\t\t\t// terminator for example \"\\u2b9e \"\n\t\t\t\t? lastPromptLine\n\t\t\t\t: lastPromptLine.substring(lastPromptLine.lastIndexOf(' '))\n\t\t);\n\t\tif (promptTerminator) {\n\t\t\tthis._createOrGetCommandDetection(this._terminal).setPromptTerminator(promptTerminator, lastPromptLine);\n\t\t}\n\t}\n\n\tprivate _updateCwd(value: string) {\n\t\tvalue = sanitizeCwd(value);\n\t\tthis._createOrGetCwdDetection().updateCwd(value);\n\t\tconst commandDetection = this.capabilities.get(TerminalCapability.CommandDetection);\n\t\tcommandDetection?.setCwd(value);\n\t}\n\n\tprivate _doHandleITermSequence(data: string): boolean {\n\t\tif (!this._terminal) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst [command] = data.split(';');\n\t\tthis._markSequenceSeen(`${ShellIntegrationOscPs.ITerm};${command}`);\n\t\tswitch (command) {\n\t\t\tcase ITermOscPt.SetMark: {\n\t\t\t\tthis._createOrGetBufferMarkDetection(this._terminal).addMark();\n\t\t\t}\n\t\t\tdefault: {\n\t\t\t\t// Checking for known `<key>=<value>` pairs.\n\t\t\t\t// Note that unlike `VSCodeOscPt.Property`, iTerm2 does not interpret backslash or hex-escape sequences.\n\t\t\t\t// See: https://github.com/gnachman/iTerm2/blob/bb0882332cec5196e4de4a4225978d746e935279/sources/VT100Terminal.m#L2089-L2105\n\t\t\t\tconst { key, value } = parseKeyValueAssignment(command);\n\n\t\t\t\tif (value === undefined) {\n\t\t\t\t\t// No '=' was found, so it's not a property assignment.\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\n\t\t\t\tswitch (key) {\n\t\t\t\t\tcase ITermOscPt.CurrentDir:\n\t\t\t\t\t\t// Encountered: `OSC 1337 ; CurrentDir=<Cwd> ST`\n\t\t\t\t\t\tthis._updateCwd(value);\n\t\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t// Unrecognized sequence\n\t\treturn false;\n\t}\n\n\tprivate _doHandleSetWindowsFriendlyCwd(data: string): boolean {\n\t\tif (!this._terminal) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst [command, ...args] = data.split(';');\n\t\tthis._markSequenceSeen(`${ShellIntegrationOscPs.SetWindowsFriendlyCwd};${command}`);\n\t\tswitch (command) {\n\t\t\tcase '9':\n\t\t\t\t// Encountered `OSC 9 ; 9 ; <cwd> ST`\n\t\t\t\tif (args.length) {\n\t\t\t\t\tthis._updateCwd(args[0]);\n\t\t\t\t}\n\t\t\t\treturn true;\n\t\t}\n\n\t\t// Unrecognized sequence\n\t\treturn false;\n\t}\n\n\t/**\n\t * Handles the sequence: `OSC 7 ; scheme://cwd ST`\n\t */\n\tprivate _doHandleSetCwd(data: string): boolean {\n\t\tif (!this._terminal) {\n\t\t\treturn false;\n\t\t}\n\n\t\tconst [command] = data.split(';');\n\t\tthis._markSequenceSeen(`${ShellIntegrationOscPs.SetCwd};${command}`);\n\n\t\tif (command.match(/^file:\\/\\/.*\\//)) {\n\t\t\tconst uri = URI.parse(command);\n\t\t\tif (uri.path && uri.path.length > 0) {\n\t\t\t\tthis._updateCwd(uri.path);\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\n\t\t// Unrecognized sequence\n\t\treturn false;\n\t}\n\n\tserialize(): ISerializedCommandDetectionCapability {\n\t\tif (!this._terminal || !this.capabilities.has(TerminalCapability.CommandDetection)) {\n\t\t\treturn {\n\t\t\t\tisWindowsPty: false,\n\t\t\t\thasRichCommandDetection: false,\n\t\t\t\tcommands: [],\n\t\t\t\tpromptInputModel: undefined,\n\t\t\t};\n\t\t}\n\t\tconst result = this._createOrGetCommandDetection(this._terminal).serialize();\n\t\treturn result;\n\t}\n\n\tdeserialize(serialized: ISerializedCommandDetectionCapability): void {\n\t\tif (!this._terminal) {\n\t\t\tthrow new Error('Cannot restore commands before addon is activated');\n\t\t}\n\t\tconst commandDetection = this._createOrGetCommandDetection(this._terminal);\n\t\tcommandDetection.deserialize(serialized);\n\t\tif (commandDetection.cwd) {\n\t\t\t// Cwd gets set when the command is deserialized, so we need to update it here\n\t\t\tthis._updateCwd(commandDetection.cwd);\n\t\t}\n\t}\n\n\tprotected _createOrGetCwdDetection(): ICwdDetectionCapability {\n\t\tlet cwdDetection = this.capabilities.get(TerminalCapability.CwdDetection);\n\t\tif (!cwdDetection) {\n\t\t\tcwdDetection = this._register(new CwdDetectionCapability());\n\t\t\tthis.capabilities.add(TerminalCapability.CwdDetection, cwdDetection);\n\t\t}\n\t\treturn cwdDetection;\n\t}\n\n\tprotected _createOrGetCommandDetection(terminal: Terminal): ICommandDetectionCapability {\n\t\tlet commandDetection = this.capabilities.get(TerminalCapability.CommandDetection);\n\t\tif (!commandDetection) {\n\t\t\tcommandDetection = this._register(new CommandDetectionCapability(terminal, this._logService));\n\t\t\tthis.capabilities.add(TerminalCapability.CommandDetection, commandDetection);\n\t\t}\n\t\treturn commandDetection;\n\t}\n\n\tprotected _createOrGetBufferMarkDetection(terminal: Terminal): IBufferMarkCapability {\n\t\tlet bufferMarkDetection = this.capabilities.get(TerminalCapability.BufferMarkDetection);\n\t\tif (!bufferMarkDetection) {\n\t\t\tbufferMarkDetection = this._register(new BufferMarkCapability(terminal));\n\t\t\tthis.capabilities.add(TerminalCapability.BufferMarkDetection, bufferMarkDetection);\n\t\t}\n\t\treturn bufferMarkDetection;\n\t}\n\n\tprotected _createOrGetShellEnvDetection(): IShellEnvDetectionCapability {\n\t\tlet shellEnvDetection = this.capabilities.get(TerminalCapability.ShellEnvDetection);\n\t\tif (!shellEnvDetection) {\n\t\t\tshellEnvDetection = this._register(new ShellEnvDetectionCapability());\n\t\t\tthis.capabilities.add(TerminalCapability.ShellEnvDetection, shellEnvDetection);\n\t\t}\n\t\treturn shellEnvDetection;\n\t}\n\n\tprotected _createOrGetPromptTypeDetection(): IPromptTypeDetectionCapability {\n\t\tlet promptTypeDetection = this.capabilities.get(TerminalCapability.PromptTypeDetection);\n\t\tif (!promptTypeDetection) {\n\t\t\tpromptTypeDetection = this._register(new PromptTypeDetectionCapability());\n\t\t\tthis.capabilities.add(TerminalCapability.PromptTypeDetection, promptTypeDetection);\n\t\t}\n\t\treturn promptTypeDetection;\n\t}\n}\n\nexport function deserializeVSCodeOscMessage(message: string): string {\n\treturn message.replaceAll(\n\t\t// Backslash ('\\') followed by an escape operator: either another '\\', or 'x' and two hex chars.\n\t\t/\\\\(\\\\|x([0-9a-f]{2}))/gi,\n\t\t// If it's a hex value, parse it to a character.\n\t\t// Otherwise the operator is '\\', which we return literally, now unescaped.\n\t\t(_match: string, op: string, hex?: string) => hex ? String.fromCharCode(parseInt(hex, 16)) : op);\n}\n\nexport function serializeVSCodeOscMessage(message: string): string {\n\treturn message.replace(\n\t\t// Match backslash ('\\'), semicolon (';'), or characters 0x20 and below\n\t\t/[\\\\;\\x00-\\x20]/g,\n\t\t(char: string) => {\n\t\t\t// Escape backslash as '\\\\'\n\t\t\tif (char === '\\\\') {\n\t\t\t\treturn '\\\\\\\\';\n\t\t\t}\n\t\t\t// Escape other characters as '\\xAB' where AB is the hex representation\n\t\t\tconst charCode = char.charCodeAt(0);\n\t\t\treturn `\\\\x${charCode.toString(16).padStart(2, '0')}`;\n\t\t}\n\t);\n}\n\nexport function parseKeyValueAssignment(message: string): { key: string; value: string | undefined } {\n\tconst separatorIndex = message.indexOf('=');\n\tif (separatorIndex === -1) {\n\t\treturn { key: message, value: undefined }; // No '=' was found.\n\t}\n\treturn {\n\t\tkey: message.substring(0, separatorIndex),\n\t\tvalue: message.substring(1 + separatorIndex)\n\t};\n}\n\n\nexport function parseMarkSequence(sequence: (string | undefined)[]): { id?: string; hidden?: boolean } {\n\tlet id = undefined;\n\tlet hidden = false;\n\tfor (const property of sequence) {\n\t\t// Sanity check, this shouldn't happen in practice\n\t\tif (property === undefined) {\n\t\t\tcontinue;\n\t\t}\n\t\tif (property === 'Hidden') {\n\t\t\thidden = true;\n\t\t}\n\t\tif (property.startsWith('Id=')) {\n\t\t\tid = property.substring(3);\n\t\t}\n\t}\n\treturn { id, hidden };\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nexport interface ITerminalFormatMessageOptions {\n\t/**\n\t * Whether to exclude the new line at the start of the message. Defaults to false.\n\t */\n\texcludeLeadingNewLine?: boolean;\n\t/**\n\t * Whether to use \"loud\" formatting, this is for more important messages where the it's\n\t * desirable to visually break the buffer up. Defaults to false.\n\t */\n\tloudFormatting?: boolean;\n}\n\n/**\n * Formats a message from the product to be written to the terminal.\n */\nexport function formatMessageForTerminal(message: string, options: ITerminalFormatMessageOptions = {}): string {\n\tlet result = '';\n\tif (!options.excludeLeadingNewLine) {\n\t\tresult += '\\r\\n';\n\t}\n\tresult += '\\x1b[0m\\x1b[7m * ';\n\tif (options.loudFormatting) {\n\t\tresult += '\\x1b[0;104m';\n\t} else {\n\t\tresult += '\\x1b[0m';\n\t}\n\tresult += ` ${message} \\x1b[0m\\n\\r`;\n\treturn result;\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport type { INodeProcess } from './platform.js';\n\nfunction _definePolyfillMarks(timeOrigin?: number) {\n\tconst _data: [string?, number?] = [];\n\tif (typeof timeOrigin === 'number') {\n\t\t_data.push('code/timeOrigin', timeOrigin);\n\t}\n\n\tfunction mark(name: string, markOptions?: { startTime?: number }) {\n\t\t_data.push(name, markOptions?.startTime ?? Date.now());\n\t}\n\tfunction getMarks() {\n\t\tconst result = [];\n\t\tfor (let i = 0; i < _data.length; i += 2) {\n\t\t\tresult.push({\n\t\t\t\tname: _data[i],\n\t\t\t\tstartTime: _data[i + 1],\n\t\t\t});\n\t\t}\n\t\treturn result;\n\t}\n\treturn { mark, getMarks };\n}\n\ndeclare const process: INodeProcess;\n\ninterface IPerformanceEntry {\n\treadonly name: string;\n\treadonly startTime: number;\n}\n\ninterface IPerformanceTiming {\n\treadonly navigationStart?: number;\n\treadonly redirectStart?: number;\n\treadonly fetchStart?: number;\n}\n\ninterface IPerformance {\n\tmark(name: string, markOptions?: { startTime?: number }): void;\n\tgetEntriesByType(type: string): IPerformanceEntry[];\n\treadonly timeOrigin: number;\n\treadonly timing: IPerformanceTiming;\n\treadonly nodeTiming?: any;\n}\n\ndeclare const performance: IPerformance;\n\nfunction _define() {\n\n\t// Identify browser environment when following property is not present\n\t// https://nodejs.org/dist/latest-v16.x/docs/api/perf_hooks.html#performancenodetiming\n\t// @ts-ignore\n\tif (typeof performance === 'object' && typeof performance.mark === 'function' && !performance.nodeTiming) {\n\t\t// in a browser context, reuse performance-util\n\n\t\tif (typeof performance.timeOrigin !== 'number' && !performance.timing) {\n\t\t\t// safari & webworker: because there is no timeOrigin and no workaround\n\t\t\t// we use the `Date.now`-based polyfill.\n\t\t\treturn _definePolyfillMarks();\n\n\t\t} else {\n\t\t\t// use \"native\" performance for mark and getMarks\n\t\t\treturn {\n\t\t\t\tmark(name: string, markOptions?: { startTime?: number }) {\n\t\t\t\t\tperformance.mark(name, markOptions);\n\t\t\t\t},\n\t\t\t\tgetMarks() {\n\t\t\t\t\tlet timeOrigin = performance.timeOrigin;\n\t\t\t\t\tif (typeof timeOrigin !== 'number') {\n\t\t\t\t\t\t// safari: there is no timerOrigin but in renderers there is the timing-property\n\t\t\t\t\t\t// see https://bugs.webkit.org/show_bug.cgi?id=174862\n\t\t\t\t\t\ttimeOrigin = (performance.timing.navigationStart || performance.timing.redirectStart || performance.timing.fetchStart) ?? 0;\n\t\t\t\t\t}\n\t\t\t\t\tconst result = [{ name: 'code/timeOrigin', startTime: Math.round(timeOrigin) }];\n\t\t\t\t\tfor (const entry of performance.getEntriesByType('mark')) {\n\t\t\t\t\t\tresult.push({\n\t\t\t\t\t\t\tname: entry.name,\n\t\t\t\t\t\t\tstartTime: Math.round(timeOrigin + entry.startTime)\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t\treturn result;\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\n\t} else if (typeof process === 'object') {\n\t\t// node.js: use the normal polyfill but add the timeOrigin\n\t\t// from the node perf_hooks API as very first mark\n\t\tconst timeOrigin = performance?.timeOrigin;\n\t\treturn _definePolyfillMarks(timeOrigin);\n\n\t} else {\n\t\t// unknown environment\n\t\tconsole.trace('perf-util loaded in UNKNOWN environment');\n\t\treturn _definePolyfillMarks();\n\t}\n}\n\nfunction _factory(sharedObj: any) {\n\tif (!sharedObj.MonacoPerformanceMarks) {\n\t\tsharedObj.MonacoPerformanceMarks = _define();\n\t}\n\treturn sharedObj.MonacoPerformanceMarks;\n}\n\nconst perf = _factory(globalThis);\n\nexport const mark: (name: string, markOptions?: { startTime?: number }) => void = perf.mark;\n\nexport interface PerformanceMark {\n\treadonly name: string;\n\treadonly startTime: number;\n}\n\n/**\n * Returns all marks, sorted by `startTime`.\n */\nexport const getMarks: () => PerformanceMark[] = perf.getMarks;\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { timeout } from '../../../../../base/common/async.js';\nimport { Disposable } from '../../../../../base/common/lifecycle.js';\nimport { isString } from '../../../../../base/common/types.js';\nimport { isWindows } from '../../../../../base/common/platform.js';\nimport { ILogService } from '../../../../log/common/log.js';\nimport { ITerminalChildProcess } from '../../../common/terminal.js';\n\n/**\n * Tracks a terminal process's data stream and responds immediately when a matching string is\n * received. This is done in a low overhead way and is ideally run on the same process as the\n * where the process is handled to minimize latency.\n */\nexport class TerminalAutoResponder extends Disposable {\n\tprivate _pointer = 0;\n\tprivate _paused = false;\n\n\t/**\n\t * Each reply is throttled by a second to avoid resource starvation and responding to screen\n\t * reprints on Winodws.\n\t */\n\tprivate _throttled = false;\n\n\tconstructor(\n\t\tproc: ITerminalChildProcess,\n\t\tmatchWord: string,\n\t\tresponse: string,\n\t\tlogService: ILogService\n\t) {\n\t\tsuper();\n\n\t\tthis._register(proc.onProcessData(e => {\n\t\t\tif (this._paused || this._throttled) {\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst data = isString(e) ? e : e.data;\n\t\t\tfor (let i = 0; i < data.length; i++) {\n\t\t\t\tif (data[i] === matchWord[this._pointer]) {\n\t\t\t\t\tthis._pointer++;\n\t\t\t\t} else {\n\t\t\t\t\tthis._reset();\n\t\t\t\t}\n\t\t\t\t// Auto reply and reset\n\t\t\t\tif (this._pointer === matchWord.length) {\n\t\t\t\t\tlogService.debug(`Auto reply match: \"${matchWord}\", response: \"${response}\"`);\n\t\t\t\t\tproc.input(response);\n\t\t\t\t\tthis._throttled = true;\n\t\t\t\t\ttimeout(1000).then(() => this._throttled = false);\n\t\t\t\t\tthis._reset();\n\t\t\t\t}\n\t\t\t}\n\t\t}));\n\t}\n\n\tprivate _reset() {\n\t\tthis._pointer = 0;\n\t}\n\n\t/**\n\t * No auto response will happen after a resize on Windows in case the resize is a result of\n\t * reprinting the screen.\n\t */\n\thandleResize() {\n\t\tif (isWindows) {\n\t\t\tthis._paused = true;\n\t\t}\n\t}\n\n\thandleInput() {\n\t\tthis._paused = false;\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { ILogService } from '../../../../log/common/log.js';\nimport type { IPtyServiceContribution, ITerminalChildProcess } from '../../../common/terminal.js';\nimport { TerminalAutoResponder } from './terminalAutoResponder.js';\n\nexport class AutoRepliesPtyServiceContribution implements IPtyServiceContribution {\n\tprivate readonly _autoReplies: Map<string, string> = new Map();\n\tprivate readonly _terminalProcesses: Map<number, ITerminalChildProcess> = new Map();\n\tprivate readonly _autoResponders: Map<number, Map<string, TerminalAutoResponder>> = new Map();\n\n\tconstructor(\n\t\t@ILogService private readonly _logService: ILogService\n\t) {\n\t}\n\n\tasync installAutoReply(match: string, reply: string) {\n\t\tthis._autoReplies.set(match, reply);\n\t\t// If the auto reply exists on any existing terminals it will be overridden\n\t\tfor (const persistentProcessId of this._autoResponders.keys()) {\n\t\t\tconst process = this._terminalProcesses.get(persistentProcessId);\n\t\t\tif (!process) {\n\t\t\t\tthis._logService.error('Could not find terminal process to install auto reply');\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\tthis._processInstallAutoReply(persistentProcessId, process, match, reply);\n\t\t}\n\t}\n\n\tasync uninstallAllAutoReplies() {\n\t\tfor (const match of this._autoReplies.keys()) {\n\t\t\tfor (const processAutoResponders of this._autoResponders.values()) {\n\t\t\t\tprocessAutoResponders.get(match)?.dispose();\n\t\t\t\tprocessAutoResponders.delete(match);\n\t\t\t}\n\t\t}\n\t}\n\n\thandleProcessReady(persistentProcessId: number, process: ITerminalChildProcess): void {\n\t\tthis._terminalProcesses.set(persistentProcessId, process);\n\t\tthis._autoResponders.set(persistentProcessId, new Map());\n\t\tfor (const [match, reply] of this._autoReplies.entries()) {\n\t\t\tthis._processInstallAutoReply(persistentProcessId, process, match, reply);\n\t\t}\n\t}\n\n\thandleProcessDispose(persistentProcessId: number): void {\n\t\tconst processAutoResponders = this._autoResponders.get(persistentProcessId);\n\t\tif (processAutoResponders) {\n\t\t\tfor (const e of processAutoResponders.values()) {\n\t\t\t\te.dispose();\n\t\t\t}\n\t\t\tprocessAutoResponders.clear();\n\t\t}\n\t}\n\n\thandleProcessInput(persistentProcessId: number, data: string) {\n\t\tconst processAutoResponders = this._autoResponders.get(persistentProcessId);\n\t\tif (processAutoResponders) {\n\t\t\tfor (const listener of processAutoResponders.values()) {\n\t\t\t\tlistener.handleInput();\n\t\t\t}\n\t\t}\n\t}\n\n\thandleProcessResize(persistentProcessId: number, cols: number, rows: number) {\n\t\tconst processAutoResponders = this._autoResponders.get(persistentProcessId);\n\t\tif (processAutoResponders) {\n\t\t\tfor (const listener of processAutoResponders.values()) {\n\t\t\t\tlistener.handleResize();\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate _processInstallAutoReply(persistentProcessId: number, terminalProcess: ITerminalChildProcess, match: string, reply: string) {\n\t\tconst processAutoResponders = this._autoResponders.get(persistentProcessId);\n\t\tif (processAutoResponders) {\n\t\t\tprocessAutoResponders.get(match)?.dispose();\n\t\t\tprocessAutoResponders.set(match, new TerminalAutoResponder(terminalProcess, match, reply, this._logService));\n\t\t}\n\t}\n}\n","/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { DefaultURITransformer } from '../../../base/common/uriIpc.js';\nimport { ProxyChannel } from '../../../base/parts/ipc/common/ipc.js';\nimport { Server as ChildProcessServer } from '../../../base/parts/ipc/node/ipc.cp.js';\nimport { Server as UtilityProcessServer } from '../../../base/parts/ipc/node/ipc.mp.js';\nimport { localize } from '../../../nls.js';\nimport { OPTIONS, parseArgs } from '../../environment/node/argv.js';\nimport { NativeEnvironmentService } from '../../environment/node/environmentService.js';\nimport { getLogLevel } from '../../log/common/log.js';\nimport { LoggerChannel } from '../../log/common/logIpc.js';\nimport { LogService } from '../../log/common/logService.js';\nimport { LoggerService } from '../../log/node/loggerService.js';\nimport product from '../../product/common/product.js';\nimport { IProductService } from '../../product/common/productService.js';\nimport { IReconnectConstants, TerminalIpcChannels } from '../common/terminal.js';\nimport { HeartbeatService } from './heartbeatService.js';\nimport { PtyService } from './ptyService.js';\nimport { isUtilityProcess } from '../../../base/parts/sandbox/node/electronTypes.js';\nimport { timeout } from '../../../base/common/async.js';\nimport { DisposableStore } from '../../../base/common/lifecycle.js';\n\nstartPtyHost();\n\nasync function startPtyHost() {\n\t// Parse environment variables\n\tconst startupDelay = parseInt(process.env.VSCODE_STARTUP_DELAY ?? '0');\n\tconst simulatedLatency = parseInt(process.env.VSCODE_LATENCY ?? '0');\n\tconst reconnectConstants: IReconnectConstants = {\n\t\tgraceTime: parseInt(process.env.VSCODE_RECONNECT_GRACE_TIME || '0'),\n\t\tshortGraceTime: parseInt(process.env.VSCODE_RECONNECT_SHORT_GRACE_TIME || '0'),\n\t\tscrollback: parseInt(process.env.VSCODE_RECONNECT_SCROLLBACK || '100')\n\t};\n\n\t// Sanitize environment\n\tdelete process.env.VSCODE_RECONNECT_GRACE_TIME;\n\tdelete process.env.VSCODE_RECONNECT_SHORT_GRACE_TIME;\n\tdelete process.env.VSCODE_RECONNECT_SCROLLBACK;\n\tdelete process.env.VSCODE_LATENCY;\n\tdelete process.env.VSCODE_STARTUP_DELAY;\n\n\t// Delay startup if needed, this must occur before RPC is setup to avoid the channel from timing\n\t// out.\n\tif (startupDelay) {\n\t\tawait timeout(startupDelay);\n\t}\n\n\t// Setup RPC\n\tconst _isUtilityProcess = isUtilityProcess(process);\n\tlet server: ChildProcessServer<string> | UtilityProcessServer;\n\tif (_isUtilityProcess) {\n\t\tserver = new UtilityProcessServer();\n\t} else {\n\t\tserver = new ChildProcessServer(TerminalIpcChannels.PtyHost);\n\t}\n\n\t// Services\n\tconst productService: IProductService = { _serviceBrand: undefined, ...product };\n\tconst environmentService = new NativeEnvironmentService(parseArgs(process.argv, OPTIONS), productService);\n\tconst loggerService = new LoggerService(getLogLevel(environmentService), environmentService.logsHome);\n\tserver.registerChannel(TerminalIpcChannels.Logger, new LoggerChannel(loggerService, () => DefaultURITransformer));\n\tconst logger = loggerService.createLogger('ptyhost', { name: localize('ptyHost', \"Pty Host\") });\n\tconst logService = new LogService(logger);\n\n\t// Log developer config\n\tif (startupDelay) {\n\t\tlogService.warn(`Pty Host startup is delayed ${startupDelay}ms`);\n\t}\n\tif (simulatedLatency) {\n\t\tlogService.warn(`Pty host is simulating ${simulatedLatency}ms latency`);\n\t}\n\n\tconst disposables = new DisposableStore();\n\n\t// Heartbeat responsiveness tracking\n\tconst heartbeatService = new HeartbeatService();\n\tserver.registerChannel(TerminalIpcChannels.Heartbeat, ProxyChannel.fromService(heartbeatService, disposables));\n\n\t// Init pty service\n\tconst ptyService = new PtyService(logService, productService, reconnectConstants, simulatedLatency);\n\tconst ptyServiceChannel = ProxyChannel.fromService(ptyService, disposables);\n\tserver.registerChannel(TerminalIpcChannels.PtyHost, ptyServiceChannel);\n\n\t// Register a channel for direct communication via Message Port\n\tif (_isUtilityProcess) {\n\t\tserver.registerChannel(TerminalIpcChannels.PtyHostWindow, ptyServiceChannel);\n\t}\n\n\t// Clean up\n\tprocess.once('exit', () => {\n\t\tlogService.trace('Pty host exiting');\n\t\tlogService.dispose();\n\t\theartbeatService.dispose();\n\t\tptyService.dispose();\n\t});\n}\n"],"mappings":"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","names":["require_minimist","__commonJS","exports","module","hasKey","obj","keys","o","key","isNumber","x","isConstructorOrProto","args","opts","flags","aliases","aliasIsBoolean","y","k","defaults","argv","argDefined","arg","setKey","value","i","lastKey","setArg","val","notFlags","next","m","letters","broken","j","LazyValueState","$Qf","d","err","$hb","e","$Cb","listener","newUnexpectedErrorHandler","$ib","$mb","$rb","$qb","error","$sb","$tb","_$tb","message","$wb","name","_$Cb","msg","result","$Db","_$Db","$Kb","array","predicate","startIdx","endIdxEx","$Ob","_$Ob","item","idx","$$b","$lc","_seed","rand","seed","temp","$tc","arr","CompareResult","isLessThan","isLessThanOrEqual","isGreaterThan","isNeitherLessOrGreaterThan","$wc","selector","comparator","a","b","$yc","$Dc","_$Dc","_callback","iterate","handler","cb","mapFn","first","$a","data","groupFn","element","target","$f","values","_a","entry","callbackfn","thisArg","ResourceMapEntry","uri","isEntries","$Oc","_$Oc","resource","toKey","clb","_","$Pc","entriesOrKey","_b","_value","Touch","$Qc","_c","touch","state","current","map","iterator","newSize","currentSize","previous","Cache","limit","ratio","$Rc","$Vc","fn","$Wc","$Eb","fnDidRunCallback","_this","didCall","ok","$2c","condition","messageOrError","$6c","str","$9c","$$c","$_c","$cd","$ed","$fd","type","$md","$rd","Iterable","is","thing","_empty","empty","single","wrap","iterableOrElement","from","iterable","reverse","isEmpty","some","every","find","filter","index","flatMap","concat","iterables","reduce","reducer","initialValue","length","count","slice","to","consume","atMost","consumed","asyncToArray","asyncToArrayFlat","TRACK_DISPOSABLES","disposableTracker","$td","_$td","child","parent","disposable","cache","cacheValue","rootParentCache","v","maxReported","preComputedLeaks","uncoveredLeakingObjs","leakingObjects","info","leakingObjsSet","getStackTracePath","leaking","removePrefix","linesToRemove","regexp","lines","p","stackTraceStarts","stackTracePath","l","stackTraceFormattedLines","line","prevStarts","continuations","cont","set","$ud","tracker","__is_disposable_tracked__","stack","$Ed","$vd","$wd","setParentOfDisposable","setParentOfDisposables","children","$yd","$zd","errors","$Bd","disposables","$Cd","FunctionDisposable","$Dd","_$Dd","$Fd","oldValue","$Gd","$Md","store","skipDisposeOnOverwrite","hasBuffer","indexOfTable","textEncoder","textDecoder","$8i","_$8i","byteLength","actual","source","options","len","buffers","totalLength","ret","offset","buffer","start","end","$_i","$aj","$bj","$cj","$dj","$ej","subarray","$9i","other","haystack","needle","needleLen","haystackLen","table","destination","hexChars","$qj","byte","$g","$h","isPseudo","_format","match","rest","localize","lookupMessage","fallback","$k","_isWindows","_isMacintosh","_isLinux","_isLinuxSnap","_isNative","_isWeb","_isElectron","_isIOS","_isCI","_isMobile","_locale","_language","_platformLocale","_translationsConfigFile","_userAgent","$globalThis","nodeProcess","isElectronProcess","isElectronRenderer","rawNlsConfig","nlsConfig","Platform","_platform","$m","$n","$o","$q","$s","$t","$u","$y","$z","$A","Language","isDefaultVariant","isDefault","$E","$F","pending","candidate","lastId","callback","myId","OperatingSystem","OS","$I","$J","$K","$L","$M","safeProcess","vscodeGlobal","sandboxProcess","$1","$2","$3","$4","CHAR_UPPERCASE_A","CHAR_LOWERCASE_A","CHAR_UPPERCASE_Z","CHAR_LOWERCASE_Z","CHAR_DOT","CHAR_FORWARD_SLASH","CHAR_BACKWARD_SLASH","CHAR_COLON","CHAR_QUESTION_MARK","ErrorInvalidArgType","expected","determiner","validateObject","pathObject","validateString","platformIsWin32","isPathSeparator","code","isPosixPathSeparator","isWindowsDeviceRoot","normalizeString","path","allowAboveRoot","separator","res","lastSegmentLength","lastSlash","dots","lastSlashIndex","formatExt","ext","sep","dir","base","$5","pathSegments","resolvedDevice","resolvedTail","resolvedAbsolute","rootEnd","device","isAbsolute","last","firstPart","tail","paths","joined","needsReplace","slashCount","firstLen","fromOrig","toOrig","fromSplit","toSplit","fromLen","toLen","fromStart","fromEnd","toStart","toEnd","lastCommonSep","fromCode","out","resolvedPath","matchedSlash","suffix","extIdx","firstNonSlashEnd","startDot","startPart","preDotState","posixCwd","cwd","$6","trailingSeparator","hasRoot","char","$7","$8","$9","$0","$$","$_","$ab","$bb","$cb","$db","$eb","$gb","_schemePattern","_singleSlashStart","_doubleSlashStart","_validateUri","_strict","_schemeFix","scheme","_referenceResolution","_slash","_regexp","URI","_URI","schemeOrData","authority","query","fragment","$Kc","change","Uri","percentDecode","components","strict","pathFragment","newPath","skipEncoding","_asFormatted","_pathSepMarker","encodeTable","encodeURIComponentFast","uriComponent","isPath","isAuthority","nativeEncodePos","pos","escaped","encodeURIComponentMinimal","keepDriveLetterCasing","encoder","userinfo","decodeURIComponentGraceful","_rEncodedAsHex","$Dx","Node","_Node","performanceNow","$qf","_$qf","highResolution","_enableDisposeWithListenerWarning","_enableSnapshotPotentialLeakWarning","Event","_addLeakageTraceLogic","origListenerDidAdd","Stacktrace","defer","event","flushOnListenerRemove","debounce","once","thisArgs","didFire","onceIf","snapshot","forEach","each","signal","any","events","addAndReturnDisposable","merge","initial","output","emitter","$wf","delay","leading","leakWarningThreshold","subscription","handle","numDebouncedCalls","doFire","cur","_output","accumulate","latch","equals","firstCall","shouldEmit","split","isT","flushAfterTimeout","_buffer","flush","chain","sythensize","cs","ChainableSynthesis","HaltChainable","step","fromNodeEventEmitter","eventName","id","onFirstListenerAdd","onLastListenerRemove","fromDOMEventEmitter","toPromise","cancelRef","promise","resolve","addToDisposables","disposeAndRemove","forward","runAndSubscribe","EmitterObserver","_observable","_change","fromObservable","obs","fromObservableLight","observable","didChange","observer","$sf","_$sf","listenerCount","elapsed","_globalLeakWarningThreshold","LeakageMonitor","_LeakageMonitor","threshold","topStack","topCount","$uf","_Stacktrace","$vf","UniqueContainer","compactionThreshold","forEachListener","listeners","tuple","contained","removeMonitor","EventDeliveryQueuePrivate","adjustDeliveryQueue","n","errorHandler","dq","$Cf","r","$Ff","shortcutEvent","context","CancellationToken","isCancellationToken","MutableToken","$If","cancel","$Mf","$Nf","arg1","arg2","$Tf","_formatRegexp","$Uf","group","$5f","ch","$fg","$gg","aStart","aEnd","bStart","bEnd","codeA","codeB","aLen","bLen","$hg","$ig","$kg","diff","$lg","$mg","$og","$sg","charCode","$tg","$ug","highSurrogate","lowSurrogate","CSI_SEQUENCE","OSC_SEQUENCE","ESC_SEQUENCE","CONTROL_SEQUENCES","$Kg","PROMPT_NON_PRINTABLE","$Lg","$Mg","GraphemeBreakType","GraphemeBreakTree","_GraphemeBreakTree","getGraphemeBreakRawData","codePoint","nodeCount","nodeIndex","CodePoint","$Xg","_$Xg","localesStr","locales","arrayToMap","mergeMaps","map1","map2","intersectMaps","filteredLocales","languageSpecificMap","locale","commonMap","f","$Yg","_$Yg","$2g","$3g","osPath","$4g","$5g","firstLetter","$0g","$9g","parentCandidate","ignoreCase","sepOffset","char0","$ah","pathNormalized","$bh","isWindowsOS","pathChars","windowsSafePathFirstChars","$fh","prefix","randomLength","pathCharsTouse","randomFileName","Schemas","$jh","RemoteAuthoritiesImpl","schema","delegate","product","serverBasePath","$lh","host","port","connectionToken","$kh","$qh","FileAccessImpl","_FileAccessImpl","resourcePath","uriOrModule","rootUriOrPath","modulePath","$rh","$sh","$th","COI","coiHeaders","coiSearchParamName","getHeadersFromQuery","url","params","addSearchParam","urlOrSearch","coop","coep","$uh","$vh","uri1","uri2","ignoreFragment","$Lh","$Dh","dirname","normalizedPath","relativePath","fromPath","toPath","newURI","a1","a2","fsp","$Mh","isRootSep","$wh","$xh","$yh","$zh","$Ah","$Bh","$Ch","$Eh","$Fh","$Gh","$Hh","$Ih","$Jh","$Kh","$Nh","$Oh","DataUri","parseMetaData","dataUri","metadata","property","mime","$rf","$Sh","thenable","isCancelled","reject","onfinally","$6h","c","$7h","autoOpenTimeMs","$8h","millis","token","$ai","maxDegreeOfParalellism","factory","iLimitedTask","$bi","$di","$si","queue","extUri","drainListenerId","drainListener","drainer","$hi","runner","$ii","$li","$mi","safeGlobal","_targetWindow","timeout","disposed","targetWindow","DeferredOutcome","_$si","deferred","Promises","settled","promises","firstError","withAsyncBody","bodyFn","AsyncIterableSourceState","$vi","_$vi","items","writer","executor","onReturn","filterFn","ProducerConsumer","$zi","_$zi","emitter1","emitter2","p1","p2","$Bi","createDecorator","_target","descriptor","fnKey","$Wm","memoizeKey","$Xm","initialValueProvider","timerKey","resultKey","$Ym","lastRunKey","pendingKey","nextTime","$2m","depth","RequestType","requestTypeToStr","ResponseType","responseTypeToStr","State","readIntVQL","reader","vqlZero","createOneByteBuffer","writeInt32VQL","v2","scratch","$3m","bytes","$4m","DataType","BufferPresets","$5m","el","$6m","$7m","h","channelName","channel","response","msgLength","header","body","request","cancellationTokenSource","pendingRequests","timer","requests","RequestInitiator","$8m","logger","that","command","cancellationToken","disposableWithRequestCancel","doRequest","uninitializedPromise","$9m","ctx","onDidClientConnect","ipcLogger","timeoutDelay","protocol","onDidClientDisconnect","onFirstMessage","channelServer","channelClient","connection","routerOrClientFilter","connectionPromise","channelPromise","$$m","clientFilter","eventMultiplexer","onDidAddConnection","onDidRemoveConnection","relay","ProxyChannel","fromService","service","disableMarshalling","mapEventNameToEvent","propertyIsEvent","eventImpl","propertyIsDynamicEvent","toService","propKey","methodArgs","$Dp","one","oneKeys","otherKeys","$Gp","lowercaseKey","equivalentKey","Source","TerminateResponseCode","fs","tmpdir","promisify","nfcCache","$Di","normalize","nfdCache","$Ei","nonAsciiCharactersPattern","form","normalizedCache","cached","$Fi","accentsRegex","noAccents","RimRafMode","rimraf","mode","moveToPath","rimrafUnlink","rimrafMove","readdir","doReaddir","handleDirectoryChildren","safeReaddirWithFileTypes","isFile","isDirectory","isSymbolicLink","lstat","readDirsInDir","dirPath","directories","SymlinkSupport","stat","lstats","existsFile","symbolicLink","existsDirectory","writeQueues","writeFile","ensuredOptions","ensureWriteOptions","doWriteFileAndFlush","canFlush","configureFlushOnWrite","enabled","openError","fd","writeError","syncError","closeError","rename","windowsRetryTimeout","renameWithRetry","copy","startTime","retryTimeout","attempt","abortRetry","doCopy","COPY_MODE_MASK","payload","doCopySymlink","doCopyDirectory","doCopyFile","files","file","linkTarget","realpath","normalizePath","position","bytesRead","bytesWritten","$Vw","env","fileExistsDefault","statValue","$Xw","fileExists","fullPath","envPath","pathEntry","pathExtsFound","withExtension","foundPromise","found","$vx","$dab","process","Protocol","$eab","_$eab","onCreateMessageChannel","import_minimist","__toESM","helpCategories","$gl","ignoringReporter","$hl","errorReporter","firstPossibleCommand","alias","stringOptions","booleanOptions","globalOptions","optionId","newArgs","reporter","subcommandOptions","parsedArgs","minimist","cleanedArgs","remainingArgs","deprecatedId","sanitized","homedir","minute","hour","day","week","month","year","$Qn","date","$Un","$Vn","vscodePortable","cliBuiltinExtensionsDir","cliExtensionsDownloadDir","cliExtensionsDir","vscodeExtensions","extensionDevelopmentPaths","extensionDevelopmentPath","kind","extensionTestsPath","disableExtensions","$Wn","matches","isBuilt","$Xn","debugArg","debugBrkArg","defaultBuildPort","debugId","environmentString","brk","join","$Fl","cliArgs","productName","userDataPath","doGetUserDataPath","pathsToResolve","portablePath","appDataPath","cliPath","userProfile","$Yn","productService","exceptionToErrorMessage","exception","verbose","detectSystemErrorMessage","stackToString","$Im","detail","$Dn","$En","hashVal","$Fn","arrayHash","objectHash","$Gn","booleanHash","initialHashVal","s","SHA1Constant","leftRotate","bits","totalBits","delta","mask","toHexString","bufferOrValue","bitsize","$In","_$In","strLen","buff","buffLen","leftoverHighSurrogate","nextCharCode","ml","bigBlock32","TokenType","hintDidYouMean","meant","hintDidYouForgetToOpenOrCloseQuote","hintDidYouForgetToEscapeSlash","$4n","_$4n","isTripleEq","additional","lexeme","errToken","keyword","inEscape","inCharacterClass","_util","getServiceDependencies","ctor","$Kj","$Lj","storeServiceDependency","serviceId","CONSTANT_VALUES","hasOwnProperty","ContextKeyExprType","defaultConfig","errorEmptyString","hintEmptyString","errorNoInAfterNot","errorClosingParenthesis","errorUnexpectedToken","hintUnexpectedToken","errorUnexpectedEOF","hintUnexpectedEOF","$6n","_$6n","input","expr","peek","additionalInfo","right","$7n","$0n","$$n","$eo","regexLexeme","closingSlashIndex","$jo","lexemeReconstruction","followingToken","parenBalance","serializedValue","regex","caseIgnoreFlag","$ho","$io","$fo","$go","got","$_n","$ao","$do","$bo","$co","$lo","$mo","serialized","cmp","_$0n","mapFnc","_$$n","_$_n","negated","constantValue","cmp1","_$ao","cmp2","trueValue","_$bo","valueKey","_$co","_$do","falseValue","_$eo","withFloatOrStr","_$fo","_$go","_$ho","_$io","_$jo","thisSource","otherSource","$ko","_$ko","eliminateConstantsInArray","newArr","newExpr","_$lo","_expr","extraRedundantCheck","exprArr","hasTrue","lastElement","secondToLastElement","isFinished","resultElement","_$mo","hasFalse","LEFT","RIGHT","all","left","getTerminals","$no","_$no","defaultValue","metaOrHide","$oo","key1","key2","value1","value2","node","$vo","$wo","$xo","LogLevel","$yo","$zo","loggerLevel","messageLevel","format","$Bo","level","$Co","$Go","$Ho","loggerResources","loggerResource","resourceOrId","idOrResource","logLevel","loggerEntry","visibility","existing","$Lo","environmentService","$Oo","$Mo","$Po","$ZA","uriTransformer","transformer","$JC","primaryLogger","otherLoggers","$in","_data","_hex","$Dj","aCode","thisCode","$Ej","justSeps","$Fj","g","UriIteratorState","$Gj","Undef","_Undef","TernarySearchTreeNode","tmp","Dir","$Hj","_$Hj","ignorePathCasing","ignoreQueryAndFragment","segments","iter","oldElement","bf","d1","d2","superStr","stack2","min","newChild","newChild2","allowValue","bucket","nodeIsBalanced","$tk","FileType","FilePermission","FileChangeFilter","FileSystemProviderCapabilities","FileSystemProviderErrorCode","FileOperation","FileChangeType","$Nk","_$Nk","changes","added","updated","deleted","types","hasTypesFilter","correlationId","FileOperationResult","FileKind","$3k","_$3k","size","SpdLogLevel","createSpdLogLogger","logfilePath","filesize","filecount","donotUseFormatters","_spdlog","log","setLogLevel","$ew","filepath","rotating","$fw","configuration","pkg","product_default","RegistryImpl","$gm","TerminalSettingPrefix","TerminalSettingId","PosixShellType","WindowsShellType","GeneralShellType","TitleEventSource","TerminalIpcChannels","ProcessPropertyType","$dx","HeartbeatConstants","TerminalLocation","TerminalLocationConfigValue","LocalReconnectConstants","FlowControlConstants","ProfileSource","ShellIntegrationStatus","ShellIntegrationInjectionFailureReason","TerminalExitReason","$ex","TerminalBackendRegistry","backend","remoteAuthority","$fx","$gx","$oRc","interval","execFile","exec","userInfo","os","IntRegex","PwshMsixRegex","PwshPreviewMsixRegex","Arch","processArch","osArch","PossiblePowerShellExe","exePath","displayName","getProgramFilesPath","useAlternateBitness","findPSCoreWindowsInstallation","findPreview","programFilesPath","powerShellInstallBaseDir","highestSeenVersion","pwshExePath","currentVersion","dashIndex","intPart","bitness","preview","findPSCoreMsix","msixAppDir","pwshMsixDirRegex","pwshMsixName","subdir","pwshMsixPath","findPSCoreDotnetGlobalTool","dotnetGlobalToolExePath","findPSCoreScoopInstallation","scoopAppsDir","scoopPwsh","findWinPS","winPSPath","enumerateDefaultPowerShellInstallations","pwshExe","$Tw","defaultPwsh","$Uw","pwsh","$Zw","getSystemShellWindows","getSystemShellUnixLike","_TERMINAL_DEFAULT_SHELL_UNIX_LIKE","unixLikeTerminal","_TERMINAL_DEFAULT_SHELL_WINDOWS","$2A","requestId","tokenSource","resolveRequest","$L5b","throttleBy","timeoutId","$N5","shellType","escapeConfig","bannedChars","$P5","EnvironmentVariableMutatorType","$aB","serializedCollection","$bB","serializableEnvironmentDescription","$dB","mutatorTypeToLabelMap","PYTHON_ACTIVATION_VARS_PATTERN","PYTHON_ENV_EXTENSION_ID","$eB","collections","collection","extensionIdentifier","it","mutator","extensionMutator","scope","variableResolver","lowerToActualVariableNames","variable","mutators","actualVariable","changed","removed","otherMutators","currentMutators","getMissingMutatorsFromArray","getChangedMutatorsFromArray","filteredMutators","filterScope","strictFilter","otherMutatorExtensions","otherMutator","chmod","realpathSync","mkdirSync","$fB","osVersion","os2","buildNumber","$gB","shellLaunchConfig","logService","skipStickyBit","originalArgs","shell","appRoot","envMixin","scopedDownShellEnvs","arePwshImpliedArgs","shellIntegrationArgs","ShellIntegrationExecutable","arePwshLoginArgs","areZshBashFishLoginArgs","addEnvMixinPathPrefix","username","realTmpDir","zdotdir","userZdotdir","filesToCopy","deserialized","prependToPath","pwshLoginArgs","shLoginArgs","shInteractiveArgs","pwshImpliedArgs","$Sn","totalmem","$Kx","$Lx","rootPid","rootItem","totalMemory","addToTree","pid","ppid","cmd","load","mem","findName","UTILITY_NETWORK_HINT","WINDOWS_CRASH_REPORTER","WINPTY","CONPTY","TYPE","cleanUNCPrefix","windowsProcessTree","processList","completeProcessList","processItems","commandLine","calculateLinuxCpuUsage","processes","pids","stdout","stderr","cpuUsage","processInfo","parsePsOutput","ps","PID_CMD","Constants","$mRc","$nRc","processItem","spaceIndex","SHELL_EXECUTABLES","SHELL_EXECUTABLE_REGEXES","$pRc","title","tree","favouriteChild","executable","spawn","ShutdownConstants","posixShellTypeMap","generalShellTypeMap","$qRc","cols","rows","L","M","N","O","useConpty","useConptyDll","DelayedResizer","dimensions","injection","fs2","injectionConfig","slc","envPaths","shellIntegrationInjection","ptyProcess","hasConptyOption","$qRc_1","sanitizedTitle","shellTypeValue","immediate","isBinary","newCwd","initialCwd","charCount","version","$aXb","capability","impl","createCapabilityEvent","$bXb","$ax","_$ax","xterm","isCommandStorageDisabled","marker","promptStartMarker","endMarker","executedMarker","extractCommandLine","startLine","endLine","outputMatcher","matcher","linesToCheck","countNewLines","wrappedLineStart","wrappedLineEnd","getXtermLineContent","getPromptRowCount","getCommandRowCount","$bx","exitCode","ignoreCommandLine","markProperties","commandStartMarker","commandStartX","commandExecutedMarker","commandExecutedX","content","lineStart","lineEnd","maxLineLength","$cx","promptRowCount","promptStartLine","commandRowCount","PromptInputState","$_w","C","onCommandStart","onCommandStartChanged","onCommandExecuted","F","emptyStringWhenEmpty","commandStartY","absoluteCursorY","cursorIndex","ghostTextIndex","nextLine","lineText","relativeCursorIndex","trimmedLineText","continuationCellWidth","belowCursorLine","trailingWhitespace","valueLines","isMultiLine","valueEndTrimmed","charBeforeCursor","continuationOffset","proceedWithGhostTextCheck","cell","potentialGhostIndexOffset","currentPos","styleMap","lastNonWhitespaceCell","nextCell","styleKey","positionsWithGhostStyle","checkPos","checkCell","startCellX","$cXb","casted","P","typedCommand","UnixPtyHeuristics","promptTerminator","lastPromptLine","WindowsPtyHeuristics","lastCommand","cloneMarker","commandId","newCommand","_commandLine","isTrusted","commands","partialCommand","currentCommand","AdjustCommandStartMarkerConstants","q","baseY","rowsDifference","potentialShiftedLineCount","shiftedY","initialCommandStartMarker","scannedLineCount","prompt","adjustedPrompt","commandText","executedLine","text","wrapsToNextLine","cursorYAbsolute","lastCommandYAbsolute","cursorX","cursorY","totalDelay","pwshPrompt","customPrompt","bashPrompt","pythonPrompt","cmdMatch","$eXb","$fXb","$gXb","properties","$hXb","clear","$iXb","ShellIntegrationOscPs","FinalTermOscPt","VSCodeOscPt","ITermOscPt","$jXb","t","terminal","vscodeMarkerId","sequence","didHandle","argsIndex","arg0","$kXb","$mXb","sanitizedValue","$nXb","commandDetection","cwdDetection","bufferMarkDetection","shellEnvDetection","promptTypeDetection","_match","op","hex","separatorIndex","hidden","$qtc","_definePolyfillMarks","timeOrigin","mark","markOptions","getMarks","_define","_factory","sharedObj","perf","$V","$W","$rRc","proc","matchWord","$sRc","reply","persistentProcessId","processAutoResponders","terminalProcess","XtermTerminal","$tRc","SerializeAddon","Unicode11Addon","$uRc","pty","names","workspaceId","instanceId","processDetails","processesForPort","capturePid","processId","ids","persistentProcess","dateTimeFormatLocale","restoreMessage","postRestoreMessage","lastReplayEvent","newId","oldId","unicodeVersion","executableEnv","shouldPersist","workspaceName","isReviving","rawReviveBuffer","processLaunchOptions","PersistentTerminalProcess","contrib","titleSource","userInitiated","icon","color","forcePersist","persistentProcesses","terminalProcessData","osOverride","original","direction","wslExecutable","useWSLexe","is32ProcessOn64Windows","systemRoot","layout","doneSet","tabs","tab","expandedBackground","filtered","term","hasLayout","ptyId","revivedPtyId","wasRevived","isOrphan","InteractionState","fixedDimensions","U","W","shouldPersistTerminal","reconnectConstants","X","reviveBuffer","Y","Z","MutationLogger","XtermSerializer","printTime","ev","dataLength","reqId","isError","serializedPayload","barrier","reason","scrollback","reviveBufferWithRestoreMessage","shellIntegrationNonce","normalBufferOnly","restoreToLastReviveBuffer","serialize","ms","_h","_m","_s","_ms","startPtyHost","startupDelay","simulatedLatency","_isUtilityProcess","server","loggerService","heartbeatService","ptyService","ptyServiceChannel"],"file":"ptyHostMain.js"}